!function(e,t){"function"==typeof define&&define.amd?define(["../../lib/ol/build/ol-debug"],t):"object"==typeof exports?module.exports=t(require("../../lib/ol/build/ol-debug")):e.ol=t(e.ol)}(this,function(e){Math.hypot=Math.hypot||function(){for(var e=0,t=arguments.length,r=0;r<t;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)};for(var t=0,r=["ms","moz","webkit","o"],n=0;n<r.length&&!window.requestAnimationFrame;++n){window.requestAnimationFrame=window[r[n]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[r[n]+"CancelAnimationFrame"]||window[r[n]+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(e,r){var n=(new Date).getTime(),a=Math.max(0,16-(n-t)),o=window.setTimeout(function(){e(n+a)},a);t=n+a;return o});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)});var a=TC.url.ol.substr(0,TC.url.ol.lastIndexOf("/"));a=a.substr(0,a.lastIndexOf("/")+1)+"css/ol.css";e.proj.get("EPSG:4258").metersPerUnit_=e.proj.EPSG4326.METERS_PER_UNIT;e.proj.get("urn:ogc:def:crs:EPSG::4258").metersPerUnit_=e.proj.EPSG4326.METERS_PER_UNIT;e.proj.get("http://www.opengis.net/gml/srs/epsg.xml#4258").metersPerUnit_=e.proj.EPSG4326.METERS_PER_UNIT;e.proj.oldGet=e.proj.get;e.proj.get=function(t){if("string"==typeof t){t=t.trim();TC.loadProjDef({crs:t,sync:!0})}return e.proj.oldGet.call(this,t)};e.format.GMLBase.prototype.readGeometryElement=function(t,r){var n=r[0];n.srsName=t.firstElementChild.getAttribute("srsName");if((this instanceof e.format.GML2CRS84||this instanceof e.format.GML3CRS84)&&("EPSG:4326"!==n.srsName||!n.srsName))throw new Error("Conflicto de CRS");n.srsName||(n.srsName=this.srsName);n.dataProjection=e.proj.get(n.srsName);var a=e.xml.pushParseAndPop(null,this.GEOMETRY_PARSERS_,t,r,this);return a?e.format.Feature.transformWithOptions(a,!1,n):void 0};e.format.GMLBase.prototype.readFeatureElement=function(t,r){var n,a,o=t.getAttribute("fid")||e.xml.getAttributeNS(t,e.format.GMLBase.GMLNS,"id"),i={};for(n=t.firstElementChild;n;n=n.nextElementSibling){var s=n.localName;if(0===n.childNodes.length||1===n.childNodes.length&&(3===n.firstChild.nodeType||4===n.firstChild.nodeType)){var l=e.xml.getAllTextContent(n,!1);e.format.GMLBase.ONLY_WHITESPACE_RE_.test(l)&&(l=void 0);i[s]=l}else{i[s]=this.readGeometryElement(n,r);"boundedBy"!==s&&"referencePoint"!==s&&(a=s)}}var p=new e.Feature(i);a&&p.setGeometryName(a);o&&p.setId(o);return p};e.format.GML3.prototype._writePosList_=e.format.GML3.prototype.writePosList_;e.format.GML3.prototype.writePosList_=function(e,t,r){this._writePosList_(e,t,r);const n=t.getCoordinates()[0];n&&n.length>2&&e.setAttribute("srsDimension",n.length)};e.format.GML3.prototype._getCoords_=e.format.GML3.prototype.getCoords_;e.format.GML3.prototype.getCoords_=function(e,t){var r=this._getCoords_(e,t);e.length>2&&(r+=" "+e[2]);return r};e.format.GML3.prototype._writePos_=e.format.GML3.prototype.writePos_;e.format.GML3.prototype.writePos_=function(t,r,n){this._writePos_(t,r,n);const a=r.getCoordinates();a.length>2&&e.format.XSD.writeStringTextNode(t," "+a[2])};var o="http://www.opengis.net/gml",i="http://www.opengis.net/gml/3.2";e.format.GMLBase.prototype.MULTIPOINT_PARSERS_[i]=e.format.GMLBase.prototype.MULTIPOINT_PARSERS_[o];e.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[i]=e.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[o];e.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[i]=e.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[o];e.format.GMLBase.prototype.POINTMEMBER_PARSERS_[i]=e.format.GMLBase.prototype.POINTMEMBER_PARSERS_[o];e.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[i]=e.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[o];e.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[i]=e.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[o];e.format.GMLBase.prototype.RING_PARSERS[i]=e.format.GMLBase.prototype.RING_PARSERS[o];e.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[i]=e.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[o];e.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[i]=e.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[o];e.format.GML3.prototype.GEOMETRY_PARSERS_[i]=e.format.GML3.prototype.GEOMETRY_PARSERS_[o];e.format.GML3.prototype.MULTICURVE_PARSERS_[i]=e.format.GML3.prototype.MULTICURVE_PARSERS_[o];e.format.GML3.prototype.MULTISURFACE_PARSERS_[i]=e.format.GML3.prototype.MULTISURFACE_PARSERS_[o];e.format.GML3.prototype.CURVEMEMBER_PARSERS_[i]=e.format.GML3.prototype.CURVEMEMBER_PARSERS_[o];e.format.GML3.prototype.SURFACEMEMBER_PARSERS_[i]=e.format.GML3.prototype.SURFACEMEMBER_PARSERS_[o];e.format.GML3.prototype.SURFACE_PARSERS_[i]=e.format.GML3.prototype.SURFACE_PARSERS_[o];e.format.GML3.prototype.CURVE_PARSERS_[i]=e.format.GML3.prototype.CURVE_PARSERS_[o];e.format.GML3.prototype.ENVELOPE_PARSERS_[i]=e.format.GML3.prototype.ENVELOPE_PARSERS_[o];e.format.GML3.prototype.PATCHES_PARSERS_[i]=e.format.GML3.prototype.PATCHES_PARSERS_[o];e.format.GML3.prototype.SEGMENTS_PARSERS_[i]=e.format.GML3.prototype.SEGMENTS_PARSERS_[o];e.format.KML._createStyleDefaults_=e.format.KML.createStyleDefaults_;e.format.KML.createStyleDefaults_=function(){e.format.KML._createStyleDefaults_();e.format.KML.DEFAULT_FILL_STYLE_.color_=h(TC.Cfg.styles.polygon.fillColor,TC.Cfg.styles.polygon.fillOpacity);e.format.KML.DEFAULT_TEXT_STYLE_.fill_=new e.style.Fill({color:e.format.KML.DEFAULT_COLOR_});e.format.KML.DEFAULT_STROKE_STYLE_.color_=h(TC.Cfg.styles.line.strokeColor,1);e.format.KML.DEFAULT_STROKE_STYLE_.width_=TC.Cfg.styles.line.strokeWidth;return e.format.KML.DEFAULT_STYLE_ARRAY_};e.format.KML.prototype._readDocumentOrFolder_=e.format.KML.prototype.readDocumentOrFolder_;e.format.KML.prototype.readDocumentOrFolder_=function(t,r){var n=e.format.KML.prototype._readDocumentOrFolder_.apply(this,arguments);if("Folder"==t.localName)for(var a=0;a<n.length;a++){var o=n[a];$.isArray(o._folders)||(o._folders=[]);var i=t.getElementsByTagName("name")[0];i&&TC.Util.fastUnshift(o._folders,i.innerHTML||i.textContent)}return n};e.format.KML.readText_=function(t,r){e.asserts.assert(t.nodeType==Node.ELEMENT_NODE);e.asserts.assert("text"==t.localName);return e.xml.getAllTextContent(t,!1).trim()};e.format.KML.BALLOON_STYLE_PARSERS_=e.xml.makeStructureNS(e.format.KML.NAMESPACE_URIS_,{text:e.xml.makeObjectPropertySetter(e.format.KML.readText_)});e.format.KML.BalloonStyleParser_=function(t,r){e.asserts.assert(t.nodeType==Node.ELEMENT_NODE);e.asserts.assert("BalloonStyle"==t.localName);var n=e.xml.pushParseAndPop({},e.format.KML.BALLOON_STYLE_PARSERS_,t,r);if(goog.isDef(n)){var a=r[r.length-1];e.asserts.assert(goog.isObject(a));var o=new e.style.Text({text:n.text});a.balloonStyle=o}};for(var s in e.format.KML.STYLE_PARSERS_){e.format.KML.STYLE_PARSERS_[s].BalloonStyle=e.format.KML.BalloonStyleParser_}e.format.KML.readStyle_=function(t,r){var n=e.xml.pushParseAndPop({},e.format.KML.STYLE_PARSERS_,t,r);if(!n)return null;var a="fillStyle"in n?n.fillStyle:e.format.KML.DEFAULT_FILL_STYLE_,o=n.fill;void 0===o||o||(a=null);var i="imageStyle"in n?n.imageStyle:e.format.KML.DEFAULT_IMAGE_STYLE_;i==e.format.KML.DEFAULT_NO_IMAGE_STYLE_&&(i=void 0);var s="textStyle"in n?n.textStyle:e.format.KML.DEFAULT_TEXT_STYLE_,l="strokeStyle"in n?n.strokeStyle:e.format.KML.DEFAULT_STROKE_STYLE_,p="balloonStyle"in n?n.balloonStyle:e.format.KML.DEFAULT_BALLOON_STYLE_,c=new e.style.Style({fill:a,image:i,stroke:l,text:s,zIndex:void 0});c._balloon=p;return[c]};e.format.KML._readURI_=e.format.KML.readURI_;e.format.KML.readURI_=function(t){var r=e.format.KML._readURI_(t);"https:"===location.protocol&&0===r.indexOf("http://")&&(r=r.substr(5));return r};for(var s in e.format.KML.ICON_PARSERS_)e.format.KML.ICON_PARSERS_[s].href=e.xml.makeObjectPropertySetter(e.format.KML.readURI_);e.format.KML.whenParser_=function(t,r){e.asserts.assert(t.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT");e.asserts.assert("when"==t.localName,"localName should be when");var n=r[r.length-1];e.asserts.assert(goog.isObject(n),"gxTrackObject should be an Object");n=n.whens;var a=e.xml.getAllTextContent(t,!1);if(a=/^\s*(\d{4})($|-(\d{2})($|-(\d{2})($|T(\d{2}):(\d{2}):(\d{2})(?:.?\d{3})?(Z|(?:([+\-])(\d{2})(?::(\d{2}))?)))))\s*$/.exec(a)){var o=parseInt(a[1],10),i=a[3]?parseInt(a[3],10)-1:0,s=a[5]?parseInt(a[5],10):1,l=a[7]?parseInt(a[7],10):0,p=a[8]?parseInt(a[8],10):0,c=a[9]?parseInt(a[9],10):0;o=Date.UTC(o,i,s,l,p,c);a[10]&&"Z"!=a[10]&&(o+=60*(i="-"==a[11]?-1:1)*parseInt(a[12],10),a[13]&&(o+=3600*i*parseInt(a[13],10)));n.push(o)}else n.push(0)};e.format.KML.GX_TRACK_PARSERS_=e.xml.makeStructureNS(e.format.KML.NAMESPACE_URIS_,{when:e.format.KML.whenParser_},e.xml.makeStructureNS(e.format.KML.GX_NAMESPACE_URIS_,{coord:e.format.KML.gxCoordParser_}));e.format.KML.prototype.readFeatures=function(t,r){if("string"==typeof t){var n=t.indexOf("<kml");if(n>=0){n+="<kml".length;t.indexOf(">",n);t.indexOf("xmlns:xsi=")<0&&(t=t.substr(0,n)+' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'+t.substr(n));t=function(t,r){var n=e.xml.parse(t).getElementsByTagName(r.toLowerCase());if(n&&n.length>0){var a=n[0].getAttribute("xmlns");if(a&&a.indexOf(" ")>-1&&g.indexOf(a)>-1)for(var o=a.split(" "),i=[],s=0;s<o.length;s++)i.push("xmlns:"+r.toLowerCase()+s+'="'+o[s].trim()+'"')}return t}(t,"KML")}}return e.format.XMLFeature.prototype.readFeatures.call(this,t,r)};e.format.XSD.readDateTime=function(t){t=e.xml.getAllTextContent(t,!1);if(t=/^\s*(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(Z|(?:([+\-])(\d{2})(?::(\d{2}))?))\s*$/.exec(t)){var r=parseInt(t[1],10),n=parseInt(t[2],10)-1,a=parseInt(t[3],10),o=parseInt(t[4],10),i=parseInt(t[5],10),s=parseInt(t[6],10);r=Date.UTC(r,n,a,o,i,s);"Z"!=t[7]&&(r+=60*(n="-"==t[8]?-1:1)*parseInt(t[9],10),void 0!==t[10]&&(r+=3600*n*parseInt(t[10],10)));return r}};e.format.GPX.RTEPT_PARSERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),time:e.xml.makeObjectPropertySetter(e.format.XSD.readDateTime)});e.format.GPX.TRKPT_PARSERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),time:e.xml.makeObjectPropertySetter(e.format.XSD.readDateTime)});e.format.GPX.WPT_PARSERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),time:e.xml.makeObjectPropertySetter(e.format.XSD.readDateTime),magvar:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),geoidheight:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),name:e.xml.makeObjectPropertySetter(e.format.XSD.readString),cmt:e.xml.makeObjectPropertySetter(e.format.XSD.readString),desc:e.xml.makeObjectPropertySetter(e.format.XSD.readString),src:e.xml.makeObjectPropertySetter(e.format.XSD.readString),link:e.format.GPX.parseLink_,sym:e.xml.makeObjectPropertySetter(e.format.XSD.readString),type:e.xml.makeObjectPropertySetter(e.format.XSD.readString),fix:e.xml.makeObjectPropertySetter(e.format.XSD.readString),sat:e.xml.makeObjectPropertySetter(e.format.XSD.readNonNegativeInteger),hdop:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),vdop:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),pdop:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),ageofdgpsdata:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),dgpsid:e.xml.makeObjectPropertySetter(e.format.XSD.readNonNegativeInteger),extensions:e.format.GPX.parseExtensions_});e.format.XSD.writeDateTimeTextNode=function(t,r){var n=new Date(r),a=n.getUTCFullYear()+"-"+e.string.padNumber(n.getUTCMonth()+1,2)+"-"+e.string.padNumber(n.getUTCDate(),2)+"T"+e.string.padNumber(n.getUTCHours(),2)+":"+e.string.padNumber(n.getUTCMinutes(),2)+":"+e.string.padNumber(n.getUTCSeconds(),2)+"Z";t.appendChild(e.xml.DOCUMENT.createTextNode(a))};e.format.GPX.WPT_TYPE_SERIALIZERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),time:e.xml.makeChildAppender(e.format.XSD.writeDateTimeTextNode),magvar:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),geoidheight:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),name:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),cmt:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),desc:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),src:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),link:e.xml.makeChildAppender(e.format.GPX.writeLink_),sym:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),type:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),fix:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),sat:e.xml.makeChildAppender(e.format.XSD.writeNonNegativeIntegerTextNode),hdop:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),vdop:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),pdop:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),ageofdgpsdata:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),dgpsid:e.xml.makeChildAppender(e.format.XSD.writeNonNegativeIntegerTextNode)});const l=TC.Util.detectMouse()?3:10;var p=function(e){for(var t=[],r=[],n=Math.pow(2,e.length),a=0;a<n;a++){r=[];for(var o=0;o<e.length;o++)a&Math.pow(2,o)&&-1==r.indexOf(e[o])&&r.push(e[o]);r.length>0&&-1==t.indexOf(r.join(" "))&&t.push(r.join(" "))}return t},c=function(e,t){if(e&&e.length>0)for(var r=0;r<t.length;r++){var n=e.indexOf(t[r]);n>-1&&e.splice(n,1)}},u=function(e,t){for(var r=0;r<e.length;r++)for(var n=e[r],a=0;a<t.length;a++){var o=t[a].split(" ")[0];n[t[a]]=n[o]}},f=[e.format.KML.DATA_PARSERS_,e.format.KML.EXTENDED_DATA_PARSERS_,e.format.KML.REGION_PARSERS_,e.format.KML.LAT_LON_ALT_BOX_PARSERS_,e.format.KML.LOD_PARSERS_,e.format.KML.EXTRUDE_AND_ALTITUDE_MODE_PARSERS_,e.format.KML.FLAT_LINEAR_RING_PARSERS_,e.format.KML.FLAT_LINEAR_RINGS_PARSERS_,e.format.KML.GX_TRACK_PARSERS_,e.format.KML.GEOMETRY_FLAT_COORDINATES_PARSERS_,e.format.KML.ICON_PARSERS_,e.format.KML.ICON_STYLE_PARSERS_,e.format.KML.INNER_BOUNDARY_IS_PARSERS_,e.format.KML.LABEL_STYLE_PARSERS_,e.format.KML.LINE_STYLE_PARSERS_,e.format.KML.MULTI_GEOMETRY_PARSERS_,e.format.KML.GX_MULTITRACK_GEOMETRY_PARSERS_,e.format.KML.NETWORK_LINK_PARSERS_,e.format.KML.LINK_PARSERS_,e.format.KML.OUTER_BOUNDARY_IS_PARSERS_,e.format.KML.PAIR_PARSERS_,e.format.KML.PLACEMARK_PARSERS_,e.format.KML.POLY_STYLE_PARSERS_,e.format.KML.SCHEMA_DATA_PARSERS_,e.format.KML.STYLE_PARSERS_,e.format.KML.STYLE_MAP_PARSERS_],g=p(e.format.KML.NAMESPACE_URIS_.slice().slice(1));c(g,e.format.KML.NAMESPACE_URIS_);e.format.KML.NAMESPACE_URIS_=e.format.KML.NAMESPACE_URIS_.concat(g);u(f,g);var m=[e.format.GPX.GPX_PARSERS_,e.format.GPX.LINK_PARSERS_,e.format.GPX.RTE_PARSERS_,e.format.GPX.RTEPT_PARSERS_,e.format.GPX.TRK_PARSERS_,e.format.GPX.TRKSEG_PARSERS_,e.format.GPX.TRKPT_PARSERS_,e.format.GPX.WPT_PARSERS_,e.format.GPX.LINK_SERIALIZERS_,e.format.GPX.RTE_SEQUENCE_,e.format.GPX.RTE_SERIALIZERS_,e.format.GPX.RTEPT_TYPE_SEQUENCE_,e.format.GPX.TRK_SEQUENCE_,e.format.GPX.TRK_SERIALIZERS_,e.format.GPX.TRKSEG_SERIALIZERS_,e.format.GPX.WPT_TYPE_SEQUENCE_,e.format.GPX.WPT_TYPE_SERIALIZERS_,e.format.GPX.GPX_SERIALIZERS_],y=p(e.format.GPX.NAMESPACE_URIS_.slice().slice(1));c(y,e.format.GPX.NAMESPACE_URIS_);e.format.GPX.NAMESPACE_URIS_=e.format.GPX.NAMESPACE_URIS_.concat(y);u(m,y);e.format.GML3Patched=function(t){var r=new e.format.GML(t);r.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.GMLNS].featureMember=e.xml.makeArrayPusher(e.format.GMLBase.prototype.readFeaturesInternal);return r};e.format.GMLBase.prototype.readFeaturesInternal=function(t,r){e.DEBUG&&console.assert(t.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT");var n=t.localName,a=null;if("FeatureCollection"==n){var o=this.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.GMLNS];o.member||(o.member=e.xml.makeArrayPusher(e.format.GMLBase.prototype.readFeaturesInternal));if("http://www.opengis.net/wfs"===t.namespaceURI)a=e.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,t,r,this);else{this.FEATURE_COLLECTION_PARSERS[t.namespaceURI]=this.FEATURE_COLLECTION_PARSERS[t.namespaceURI]||this.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.GMLNS];a=e.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,t,r,this)}}else if("featureMembers"==n||"featureMember"==n||"member"==n){var i,s=r[0],l=s.featureType,p=s.featureNS;if(t.childNodes){l=[],p={};for(w=0,i=t.childNodes.length;w<i;++w){var c=t.childNodes[w];if(1===c.nodeType){var u=c.nodeName.split(":").pop();if(-1===l.indexOf(u)){var f="",g=0,m=c.namespaceURI;for(var y in p){if(p[y]===m){f=y;break}++g}f||(p[f="p"+g]=m);l.push(f+":"+u)}}}if("featureMember"!=n&&"member"!=n){s.featureType=l;s.featureNS=p}}if("string"==typeof p){var d=p;(p={}).p0=d}var h={},C=Array.isArray(l)?l:[l];for(var T in p){var v={};for(w=0,i=C.length;w<i;++w){(-1===C[w].indexOf(":")?"p0":C[w].split(":")[0])===T&&(v[C[w].split(":").pop()]="featureMembers"==n?e.xml.makeArrayPusher(this.readFeatureElement,this):e.xml.makeReplacer(this.readFeatureElement,this))}h[p[T]]=v}a="featureMember"==n||"member"==n?e.xml.pushParseAndPop(void 0,h,t,r):e.xml.pushParseAndPop([],h,t,r)}null===a&&(a=[]);var S=function(e){var t=e.getGeometry();if(e.getProperties().hasOwnProperty(e.getGeometryName())&&(!t||!t.flatCoordinates.length))throw"Geometr\xeda no v\xe1lida. \xbfPosible versi\xf3n incorrecta de GML?"};if(a instanceof e.Feature)S(a);else for(var w=0,E=a.length;w<E;w++)S(a[w]);return a};e.format.GML3CRS84=function(){e.format.GML3.call(this,{srsName:"CRS:84"})};e.inherits(e.format.GML3CRS84,e.format.GML3);e.format.GML2CRS84=function(){e.format.GML2.call(this,{srsName:"CRS:84"})};e.inherits(e.format.GML2CRS84,e.format.GML2);e.View.prototype.getValueForResolutionFunction=function(e){var t=e||2,r=this.maxResolution_,n=this.minResolution_,a=Math.log(r/n)/Math.log(t);return function(e){var n=Math.log(r/e)/Math.log(t)/a;return n=Math.max(Math.min(1,n),0)}};e.control.OverviewMap.prototype._validateExtent_=e.control.OverviewMap.prototype.validateExtent_;e.control.OverviewMap.prototype.validateExtent_=function(){this._validateExtent_();this._wrap&&this._wrap.parent.options.alwaysCentered&&this.recenter_()};e.control.OverviewMap.prototype._resetExtent_=e.control.OverviewMap.prototype.resetExtent_;e.control.OverviewMap.prototype.resetExtent_=function(){this._resetExtent_.call(this);var t=this._wrap;if(t.is3D){var r=this.ovmap_.getView(),n=r.calculateExtent(),a=t.get3DCameraLayer().getSource().getFeatures()[0];if(a){coordinates=a.getGeometry().getCoordinates();var o=coordinates[0][0],i=coordinates[0][1];if(!e.extent.containsCoordinate(n,o)||!e.extent.containsCoordinate(n,i)){var s=Math.max(n[0]-o[0],n[1]-o[1],o[0]-n[2],o[1]-n[3],n[0]-i[0],n[1]-i[1],i[0]-n[2],i[1]-n[3]);r.fit(e.extent.buffer(n,s))}}}};const d=e.Image;e.Image=function(){7===arguments.length&&Array.prototype.splice.call(arguments,3,1);return d.apply(this,arguments)};TC.inherit(e.Image,d);TC.Util.detectMobile()||(e.Overlay.prototype.updateRenderedPosition=function(t,r){var n=this.element.style,a=this.getOffset(),o=this.getPositioning();this.setVisible(!0);var i=a[0],s=a[1];if(o==e.OverlayPositioning.BOTTOM_RIGHT||o==e.OverlayPositioning.CENTER_RIGHT||o==e.OverlayPositioning.TOP_RIGHT){""!==this.rendered.left_&&(this.rendered.left_=n.left="");var l=Math.round(r[0]-t[0]-i)/window.devicePixelRatio+"px";this.rendered.right_!=l&&(this.rendered.right_=n.right=l)}else{""!==this.rendered.right_&&(this.rendered.right_=n.right="");o!=e.OverlayPositioning.BOTTOM_CENTER&&o!=e.OverlayPositioning.CENTER_CENTER&&o!=e.OverlayPositioning.TOP_CENTER||(i-=this.element.offsetWidth/2);var p=Math.round(t[0]+i)/window.devicePixelRatio+"px";this.rendered.left_!=p&&(this.rendered.left_=n.left=p)}if(o==e.OverlayPositioning.BOTTOM_LEFT||o==e.OverlayPositioning.BOTTOM_CENTER||o==e.OverlayPositioning.BOTTOM_RIGHT){""!==this.rendered.top_&&(this.rendered.top_=n.top="");var c=Math.round(r[1]-t[1]-s)/window.devicePixelRatio+"px";this.rendered.bottom_!=c&&(this.rendered.bottom_=n.bottom=c)}else{""!==this.rendered.bottom_&&(this.rendered.bottom_=n.bottom="");o!=e.OverlayPositioning.CENTER_LEFT&&o!=e.OverlayPositioning.CENTER_CENTER&&o!=e.OverlayPositioning.CENTER_RIGHT||(s-=this.element.offsetHeight/2);var u=Math.round(t[1]+s)/window.devicePixelRatio+"px";this.rendered.top_!=u&&(this.rendered.top_=n.top=u)}});var h=function(t,r){var n;if(t){n=(n=e.color.asArray(t)).slice();void 0!==r&&(n[3]=r)}else n=[0,0,0,1];return n},C=function(e,t){var r=e.map.getView(),n=r.getResolution(),a={projection:r.getProjection(),center:r.getCenter(),resolution:n,enableRotation:!1};e.parent.maxExtent&&(a.extent=e.parent.maxExtent);var o=t;t.type===TC.Consts.layerType.VECTOR&&e.parent.getBaseLayer()&&(o=e.parent.getBaseLayer());var i,s,l=o.getResolutions?o.getResolutions():[];if(l&&l.length){i=o.maxResolution||l[0];s=o.minResolution||l[l.length-1];var p=l.indexOf(s),c=l.indexOf(i);a.resolutions=l.slice(c,p+1)}else{i=o.maxResolution;s=o.minResolution}if(s){a.minResolution=s;n<s&&(a.resolution=s)}if(i){a.maxResolution=i;n>i&&(a.resolution=i)}return a};TC.wrap.Map.prototype.setMap=function(){var t=this,r=[(t.parent.initialExtent[0]+t.parent.initialExtent[2])/2,(t.parent.initialExtent[1]+t.parent.initialExtent[3])/2],n=proj4(t.parent.crs);!function(){var r=t.parent.crs.substr(t.parent.crs.lastIndexOf(":")+1),a={units:n.oProj.units,global:!0},o=[];if("4326"!==r){a.code="EPSG:"+r;o.push(new e.proj.Projection(a));a.code="urn:ogc:def:crs:EPSG::"+r;o.push(new e.proj.Projection(a));e.proj.addEquivalentProjections(o)}var i=function(e,t,r,n){for(var a=[],o=n||2,i=0;i<t.length;i+=o){var s=Array.prototype.slice.call(e(t.slice(i,i+o)));3!==o&&4!==o||(s=s.slice(0,2).concat(t.slice(i+2,i+2+(o-2))));a=a.concat(s)}if($.isArray(r)){r.length=0;for(i=0;i<a.length;i++)r[i]=a[i];a=r}return a};e.proj.addEquivalentTransforms(e.proj.EPSG4326.PROJECTIONS,o,function(e,t,r){return i(n.forward,e,t,r)},function(e,t,r){return i(n.inverse,e,t,r)})}();var a={code:t.parent.crs,units:n.oProj.units};"EPSG:4326"===t.parent.crs&&(a.axisOrientation="neu");var o=new e.proj.Projection(a),i=e.interaction.defaults({constrainResolution:!0}),s={projection:o,center:r,enableRotation:!1};if(t.parent.maxExtent){var p=t.parent.maxExtent;s.extent=p;var c=t.parent.div.getBoundingClientRect(),u=(c.width,c.height,p[2]-p[0]),f=p[3]-p[1];c.width/c.height>u/f?s.resolution=u/c.width:s.resolution=f/c.height}else s.zoom=2;t.map=new e.Map({target:t.parent.div,renderer:e.renderer.Type.CANVAS,view:new e.View(s),controls:[],interactions:i,pixelRatio:1});TC.Util.detectMobile()||(t.map.getEventPixel=function(e){var t=this.viewport_.getBoundingClientRect(),r=e.changedTouches?e.changedTouches[0]:e;return[((r=r.clientX?r:r.pointerEvent?r.pointerEvent:r).clientX-t.left)*window.devicePixelRatio,(r.clientY-t.top)*window.devicePixelRatio]});t.map._wrap=t;t._promise=Promise.resolve(t.map);t.manageSize.call(t.map);var g=function(){t.map.updateSize()};t.parent.div.addEventListener(e.events.EventType.RESIZE,g);t.parent.one(TC.Consts.event.MAPLOAD,g);t.map.on(e.MapBrowserEventType.SINGLECLICK,function(e){if(t.parent.view!==TC.Consts.view.PRINTING){t.parent.workLayers.forEach(function(e){delete e._noFeatureClicked});var r=$.map(t.parent.workLayers,function(){return!1});t.map.forEachFeatureAtPixel(e.pixel,function(e,n){if(e._wrap&&e._wrap.parent.showsPopup){for(var a=0;a<t.parent.workLayers.length;a++){if(t.parent.workLayers[a].wrap.layer===n){r[a]=!0;break}}t.parent.trigger(TC.Consts.event.FEATURECLICK,{feature:e._wrap.parent});return e}},{hitTolerance:l});for(var n=0;n<r.length;n++)r[n]||t.parent.trigger(TC.Consts.event.NOFEATURECLICK,{layer:t.parent.workLayers[n]})}});const m=function(){t.map.on(e.MapEventType.MOVEEND,function(){t.parent.trigger(TC.Consts.event.ZOOM)})};t.map.getView().on("change:resolution",function(){t.map.hasListener(e.MapEventType.MOVEEND)||t.map.once(e.MapEventType.MOVEEND,function(){m()});t.parent.trigger(TC.Consts.event.BEFOREZOOM)},t.parent);const y=function(){if(!t.map.hasListener(e.MapEventType.MOVEEND)){t.map.un("change:view",y);m()}};t.map.on("change:view",y);var d=function(r){t.map.getView().getResolution(),t.map.getView().getZoom();var n=C(t,r),a=new e.View(n);t.map.setView(a);t.map.render()};t.parent.on(TC.Consts.event.BASELAYERCHANGE,function(e){t.parent.crs!==t.parent.options.crs||t.parent.on3DView||e.layer.type===TC.Consts.layerType.VECTOR||d(e.layer)});t.parent.on(TC.Consts.event.MAPLOAD,function(e){d(t.parent.getBaseLayer())});t.map.getViewport().addEventListener(TC.Consts.event.MOUSEMOVE,function(e){var r=t.map.getTarget(),n=!1;if(!t.parent.activeControl||!t.parent.activeControl.isExclusive()){if(t.parent.view===TC.Consts.view.PRINTING)return;var a=t.map.getEventPixel(e);n=t.map.forEachFeatureAtPixel(a,function(e,r){var n=!0;!e._wrap||e._wrap.parent.showsPopup||e._wrap.parent.options.selectable||(n=!1);n&&e._wrap&&t.parent.trigger(TC.Consts.event.FEATUREOVER,{feature:e._wrap.parent});return n},{hitTolerance:l})}r.style.cursor=n?"pointer":""})};var T=function(t,r){var n=t.getUnits();return n&&n!==e.proj.Units.DEGREES?e.proj.METERS_PER_UNIT[n]:TC.Util.getMetersPerDegree(r)};TC.wrap.Map.prototype.getMetersPerUnit=function(){return T(e.proj.get(this.parent.crs),this.getExtent())};var v=function(t){t=t||{};var r=this.parent.options.crs||TC.Cfg.crs,n=e.proj.get(r),a=e.proj.get(t.crs);return T(a,t.extentInDegrees)/T(n,t.extentInDegrees)},S=function(t){var r;(r=t.axisOrientation?new e.proj.Projection({code:t.crs,axisOrientation:t.axisOrientation}):e.proj.get(t.crs)).getUnits()||(r.units_=e.proj.Units.DEGREES);return r};TC.wrap.Map.prototype.setProjection=function(t){const r=this,n=(t=t||{}).baseLayer||r.parent.baseLayer;var a;a=t.extent?t.extent:e.proj.transformExtent(r.getExtent(),r.parent.crs,t.crs);const o=e.proj.transformExtent(a,t.crs,"EPSG:4326"),i=v.call(r,{crs:t.crs,extentInDegrees:o}),s=S(t),l=r.map.getView(),p={projection:s,enableRotation:!1},c=n.getResolutions();if(c&&c.length)p.resolutions=c;else{p.minZoom=l.getMinZoom();p.maxZoom=l.getMaxZoom();const e=n.wrap.layer.getMinResolution(),t=n.wrap.layer.getMaxResolution();var u=1;if(0===e||t===Number.POSITIVE_INFINITY){u=v.call(r,{crs:r.parent.crs,extentInDegrees:o})/i}p.minResolution=0===e?l.getMinResolution()*u:e;t===Number.POSITIVE_INFINITY?p.maxResolution=l.getMaxResolution()*u:p.maxResolution=t}p.center=e.proj.transform(r.getCenter(),r.parent.crs,t.crs);var f=new e.View(p);r.map.setView(f);r.parent.initialExtent=1!==i?e.proj.transformExtent(r.parent.initialExtent,r.parent.crs,t.crs):r.parent.options.initialExtent;r.parent.options.maxExtent&&(r.parent.options.maxExtent=r.parent.maxExtent=1!==i?e.proj.transformExtent(r.parent.maxExtent,r.parent.crs,t.crs):r.parent.options.maxExtent);f.fit(a,{nearest:!0})};TC.wrap.Map.prototype.insertLayer=function(t,r){for(var n=this,a=n.map.getLayers(),o=!1,i=0;i<a.getLength();i++)if(a.item(i)===t){o=!0;break}if(o){a.remove(t);a.insertAt(r,t)}else{r<0?a.push(t):a.insertAt(r,t);var s=n.map.getView();if(n.parent.crs===n.parent.options.crs){if(t instanceof e.layer.Tile){var l=t.getSource().getResolutions();s.maxResolution_=l[0];s.minResolution_=l[l.length-1]}}else if(t instanceof e.layer.Tile){t.setMaxResolution(s.getMaxResolution());t.setMinResolution(s.getMinResolution())}var p=t._wrap,c=0,u=function(e){p.parent.state=TC.Layer.state.LOADING;if(c<=0){c=0;n.parent.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:p.parent})}t._loadingTileCount=t._loadingTileCount+1};p.parent.state===TC.Layer.state.LOADING&&p.parent.isRaster()&&u();p.$events.on(TC.Consts.event.BEFORETILELOAD,u);p.$events.on(TC.Consts.event.TILELOAD,function(e){if((c-=1)<=0){c=0;p.parent.state=TC.Layer.state.IDLE;n.parent.trigger(TC.Consts.event.LAYERUPDATE,{layer:p.parent})}})}};TC.wrap.Map.prototype.removeLayer=function(e){this.map.removeLayer(e)};TC.wrap.Map.prototype.getLayerCount=function(){return this.map.getLayerGroup().getLayers().getLength()};TC.wrap.Map.prototype.indexOfFirstVector=function(){var t=-1;this.map.getLayerGroup().getLayers().forEach(function(r,n){r instanceof e.layer.Vector&&-1===t&&(t=n)});return t};TC.wrap.Map.prototype.getLayerIndex=function(e){var t=-1;this.map.getLayerGroup().getLayers().forEach(function(r,n){r===e&&(t=n)});return t};TC.wrap.Map.prototype.setLayerIndex=function(e,t){var r=this.map.getLayers().getArray().indexOf(e);if(r>-1&&r!=t){this.map.removeLayer(e);this.insertLayer(e,t)}};TC.wrap.Map.prototype.setBaseLayer=function(t){var r=this;return new Promise(function(n,a){var o=function(a){if(a=a||r.parent.getBaseLayer()){r.map.removeLayer(a.wrap.layer);if(t instanceof e.layer.Image){v.call(r,{crs:r.parent.crs,extent:r.parent.getExtent()});t._wrap.setProjection({crs:r.parent.crs})}if(t._wrap.parent.type===TC.Consts.layerType.WMTS){var o={crs:r.parent.crs,oldCrs:t.getSource().getProjection().getCode()};o.oldCrs!==o.crs&&t._wrap.parent.setProjection(o)}}r.insertLayer(t,0);n()},i=C(r,t._wrap.parent),s=r.map.getView(),l=s.getResolution();if(r.parent.crs===r.parent.options.crs&&i.resolutions){var p=i.resolutions.sort(function(e,t){return e-t}).reduce(function(e,t){return 0===e&&(t>l||Math.abs(1-l/t)<r.parent.options.maxResolutionError)?t:e},0);if(p!==l)if(r.parent.isLoaded)s.animate({resolution:p,duration:TC.Consts.ZOOM_ANIMATION_DURATION},o.bind(r,r.parent.getBaseLayer()));else{s.setResolution(p);o()}else o()}else o()})};TC.wrap.Map.prototype.setExtent=function(t,r){const n=this;r=r||{};const a=function(e,n,a,o){var i=e.getResolutionForExtent(t,n);if(e.constrainResolution){var s=e.constrainResolution(i,0,0);s<i&&s/i<TC.Consts.EXTENT_TOLERANCE&&(s=e.constrainResolution(s,-1,0));i=s}const l=[(t[0]+t[2])/2,(t[1]+t[3])/2];if(void 0===r.animate||r.animate)e.animate({resolution:i,center:l,duration:TC.Consts.ZOOM_ANIMATION_DURATION},a);else{e.setCenter(l);e.setResolution(i);a()}};Promise.resolve(n._setExtentPromise).finally(function(){!function(t,r){n._setExtentPromise=new Promise(function(r,o){clearTimeout(n._timeout);n._timeout=setTimeout(function(){var o=n.map.getSize(),i=n.map.getView();n.parent.baseLayer?n.parent.baseLayer.wrap.getLayer().then(function(s){if(s.getSource().getResolutions!=goog.abstractMethod){var l=i.getResolutionForExtent(t,o),p=n.map.getView().getResolutions();if(p&&p.length>0){var c=Math.min.apply(n,p);if(c>l){var u=.5*(c/l-1),f=e.extent.getWidth(t)*u,g=e.extent.getHeight(t)*u;(t=t.slice(0))[0]=t[0]-f;t[1]=t[1]-g;t[2]=t[2]+f;t[3]=t[3]+g}}}a(i,o,r)}):a(i,o,r)},50)})}(t)});return n._setExtentPromise};TC.wrap.Map.prototype.getExtent=function(){return this.map.getView().calculateExtent(this.map.getSize())};TC.wrap.Map.prototype.setCenter=function(e,t){const r=this;return new Promise(function(n,a){const o=function(){n()},i=t||{},s=r.map.getView();if(i.animate)s.animate({center:e,duration:TC.Consts.ZOOM_ANIMATION_DURATION},o);else{s.setCenter(e);n()}})};TC.wrap.Map.prototype.getCenter=function(){return this.map.getView().getCenter()};TC.wrap.Map.prototype.getResolution=function(){return this.map.getView().getResolution()};TC.wrap.Map.prototype.setResolution=function(e){this.getMap().then(function(t){t.getView().setResolution(e)})};TC.wrap.Map.prototype.setRotation=function(e){this.getMap().then(function(t){t.getView().setRotation(e)})};TC.wrap.Map.prototype.getRotation=function(){return this.map.getView().getRotation()};TC.wrap.Map.prototype.getResolutions=function(){return this.map.getView().getResolutions()||[]};TC.wrap.Map.prototype.getCoordinateFromPixel=function(e){return this.map.getCoordinateFromPixel(e)};TC.wrap.Map.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)};TC.wrap.Map.prototype.getViewport=function(e){const t=this;return(e||{}).synchronous?t.map.getViewport():new Promise(function(e,r){t.getMap().then(function(t){e(t.getViewport())})})};TC.wrap.Map.prototype.isNative=function(t){return t instanceof e.Map};TC.wrap.Map.prototype.isGeo=function(){var t=this.map.getView().getProjection().getUnits();return!t||t===e.proj.Units.DEGREES};TC.wrap.Map.prototype.addPopup=function(t){const r=this;return new Promise(function(n,a){var o=void 0===t.options.draggable||t.options.draggable;TC.loadJS(o&&!window.Draggabilly,[TC.apiLocation+"lib/draggabilly/draggabilly.pkgd.min.js"],function(){r.getMap().then(function(n){if(!t.popupDiv){const i=TC.Util.getDiv();t.popupDiv=i;t.$popupDiv=$(i);i.classList.add(TC.control.Popup.prototype.CLASS);t.contentDiv=TC.Util.getDiv();t.contentDiv.classList.add(TC.control.Popup.prototype.CLASS+"-content");t.popupDiv.appendChild(t.contentDiv);t.menuDiv=TC.Util.getDiv();t.menuDiv.classList.add(TC.control.Popup.prototype.CLASS+"-menu");t.popupDiv.appendChild(t.menuDiv);r.parent.div.appendChild(i);var a=new e.Overlay({element:i,positioning:e.OverlayPositioning.BOTTOM_LEFT});n.addOverlay(a);t.wrap.popup=a;const s=n.getViewport();if(o){const e=t.popupDiv.parentElement;t.popupDiv.classList.add(TC.Consts.classes.DRAGGABLE);e.addEventListener("touchmove",function(e){for(var t=e.target;t;)if((t=t.parentElement)&&t.matches(".tc-ctl-finfo-layer-content")){e.stopPropagation();break}});const r=new Draggabilly(e,{not:"th,td, td *,input,select,.tc-ctl-finfo-coords"});r.handleEvent=function(e){this.options.not&&e.target&&e.target.matches(this.options.not)||Draggabilly.prototype.handleEvent.call(this,e)};r.on("pointerDown",function(e,t){var n=e.target.getBoundingClientRect();if(n.left+e.target.clientWidth<t.pageX||n.top+e.target.clientHeight<t.pageY){r._pointerCancel(e,t);return!1}});r.on("dragStart",function(e,r){t.setDragging(!0);t._currentOffset=a.getOffset();if(t._previousContainerPosition){var o=n.getSize();a.setPosition(n.getCoordinateFromPixel([t._previousContainerPosition[0],o[1]-t._previousContainerPosition[1]]));t._currentOffset=[0,0];a.setOffset(t._currentOffset);delete t._previousContainerPosition}else t._currentOffset=a.getOffset()});r.on("dragEnd",function(r){t.setDragging(!1);var o=n.getCoordinateFromPixel([0,0]),i=n.getCoordinateFromPixel(a.getOffset()),s=[i[0]-o[0],i[1]-o[1]],l=a.getPosition();a.setPosition([l[0]+s[0],l[1]+s[1]]);a.setOffset([0,0]);t._currentOffset=[0,0];const p=e.getBoundingClientRect();t._previousContainerPosition=[p.left,p.bottom]});r.on("dragMove",function(e,t,r){})}const p=function(e){var t=n.getTarget(),a=!1;if(!r.parent.activeControl||!r.parent.activeControl.isExclusive()){var o=n.getEventPixel(e);a=n.forEachFeatureAtPixel(o,function(e,t){var r=!0;e._wrap&&!e._wrap.parent.showsPopup&&(r=!1);return r},{hitTolerance:l})}t.style.cursor=a?"pointer":""};s.removeEventListener("mousemove",p);s.addEventListener("mousemove",p)}});n()})})};TC.wrap.Map.prototype.hidePopup=function(e){this.parent.currentFeature=null;e.popupDiv&&e.popupDiv.classList.remove(TC.Consts.classes.VISIBLE)};TC.wrap.Map.prototype.manageSize=function(){const t=this,r=function(e){var t=window.devicePixelRatio||1,r=e.context.canvas.getBoundingClientRect(),n=t*r.width,a=t*r.height;n===r.width&&Number.isInteger(n)||(n=Math.round(n));a===r.height&&Number.isInteger(a)||(a=Math.round(a));if(n!==r.width||a!==r.height){var o=[n,a];e.target.setSize(o)}};TC.Util.detectMobile()||t.on(e.render.EventType.POSTCOMPOSE,r)};var w=function(t){switch(t){case TC.Consts.layerType.KML:case TC.Consts.mimeType.KML:return new e.format.KML({showPointNames:!1});case TC.Consts.layerType.GPX:case TC.Consts.mimeType.GPX:return new e.format.GPX;case TC.Consts.layerType.GEOJSON:case TC.Consts.mimeType.GEOJSON:case TC.Consts.mimeType.JSON:case TC.Consts.format.JSON:return new e.format.GeoJSON;case TC.Consts.format.GML2:return new e.format.GML2;case TC.Consts.format.GML3:return new e.format.GML3Patched;case TC.Consts.mimeType.GML:case TC.Consts.format.GML:return new e.format.GML;case TC.Consts.format.TOPOJSON:return new e.format.TopoJSON;case TC.Consts.format.WKT:return new e.format.WKT;default:return null}};TC.wrap.Map.prototype.exportFeatures=function(t,r){r=r||{};var n=A({styles:this.parent.options.styles}),a=t.map(function(e){var t=e.wrap.feature;t.getStyle()||t.setStyle(n);const r=q.call(t).getText();r&&(t=t.clone()).setProperties({name:r.getText()});return t}),o=w(r.format);if(o instanceof e.format.KML){const t=[];(a=a.map(function(t){const r=t.getGeometry();if(r instanceof e.geom.Point){var n=q.call(t);const a=n.getImage();if(a instanceof e.style.RegularShape){const o=a.getRadius(),i=a.getStroke(),s=(a.getFill(),2*o+i.getWidth()+1),l=s/2,p=document.createElement("canvas");p.width=s;p.height=s;const c=e.render.toContext(p.getContext("2d"),{size:[s,s]}),u=n.getText();(n=n.clone()).setText();c.setStyle(n);c.drawGeometry(new e.geom.Point([l,l]));const f=new e.Feature(r);f.setProperties(t.getProperties());f.setStyle(new e.style.Style({image:new e.style.Icon({src:p.toDataURL("image/png")}),text:u}));return f}}return t})).forEach(function(r){var n=q.call(r);const a=r.getGeometry(),o=n.getText();var i;if(o){switch(!0){case a instanceof e.geom.LineString:i=new e.geom.Point(a.getCoordinateAt(.5));break;case a instanceof e.geom.Polygon:i=a.getInteriorPoint();break;case a instanceof e.geom.MultiLineString:const t=a.getLineStrings();var s=-1;i=new e.geom.Point(t[t.map(function(e){return e.getLength()}).reduce(function(e,t,r){if(t>s){s=t;return r}return e},-1)].getCoordinateAt(.5));break;case a instanceof e.geom.MultiPolygon:const r=a.getPolygons();var l=-1;i=r[r.map(function(e){return e.getArea()}).reduce(function(e,t,r){if(t>l){l=t;return r}return e},-1)].getInteriorPoint()}if(i){const r=new e.Feature(i);r.setStyle(new e.style.Style({text:o.clone(),image:new e.style.Icon({crossOrigin:"anonymous",src:TC.apiLocation+"TC/css/img/transparent.gif"})}));t.push(r)}}});t.length&&(a=a.concat(t))}if(o instanceof e.format.GMLBase){(a=a.map(function(e){return e.clone()})).forEach(function(e){const t=e.values_,r=[];for(var n in t)n.indexOf(" ")>=0&&r.push(n);r.forEach(function(e){var r=e.replace(/ /g,"_");/^\d/.test(r)&&(r="_"+r);if(e!==r)for(;void 0!==t[r];)r+="_";t[r]=t[e];delete t[e]})});o.featureNS="sitna";o.featureType="feature";var i=o.writeFeaturesNode(a,{featureProjection:this.parent.crs}),s=e.xml.createElementNS("http://www.opengis.net/gml","FeatureCollection");e.xml.setAttributeNS(s,"http://www.w3.org/2001/XMLSchema-instance","xsi:schemaLocation",o.schemaLocation);i.removeAttribute("xmlns:xsi");i.removeAttribute("xsi:schemaLocation");s.appendChild(i)}o instanceof e.format.GPX&&(a=a.map(function(t){const r=t.getGeometry();r instanceof e.geom.LineString&&(t=t.clone()).setGeometry(new e.geom.MultiLineString([r.getCoordinates()]));return t}));var l=o.writeFeatures(a,{dataProjection:"EPSG:4326",featureProjection:this.parent.crs});o instanceof e.format.GPX&&(l=l.replace(/<ele>NaN<\/ele>/g,""));return l};var E=function(e){for(var t=0,r=e.dataTransfer.types.length;t<r;t++)if("Files"===e.dataTransfer.types[t])return!0;return!1},L=function(e){if(E(e)){this.getMap()._wrap.parent.div.classList.add(TC.Consts.classes.DROP);e.preventDefault();e.stopPropagation()}},P=function(e){if(E(e)){var t=this.getMap()._wrap.parent;e.target===this.target&&t.div.classList.remove(TC.Consts.classes.DROP)}};TC.wrap.Map.prototype.enableDragAndDrop=function(t){var r=this,n=t||{},a={formatConstructors:[e.format.KML,e.format.GPX,e.format.GML3CRS84,e.format.GML2CRS84,e.format.GML3Patched,e.format.GML2,e.format.GeoJSON,function(){return new e.format.WKT({splitCollection:!0})},e.format.TopoJSON]};n.dropTarget?a.target=TC.getDiv(n.dropTarget):a.target=r.parent.div;var o=new e.interaction.DragAndDrop(a);o.on(e.interaction.DragAndDrop.EventType_.ADD_FEATURES,function(e){var t=e.features?e.features.map(function(e){return TC.wrap.Feature.createFeature(e)}):[];Promise.all(t).then(function(t){var n=r.parent.getLoadingIndicator();n&&n.removeWait(r._featureImportWaitId);t.length&&!t.some(function(e){return!e.geometry})?r.parent.trigger(TC.Consts.event.FEATURESIMPORT,{features:t,fileName:e.file.name,dropTarget:e.target.target}):r.parent.trigger(TC.Consts.event.FEATURESIMPORTERROR,{file:e.file})})});if(n.once)o.map_=r.map;else{r.map.addInteraction(o);var i=o.target?o.target:r.map.getViewport(),s=function(e){if(E(e)){var t=r.parent;if(o.target===e.target){var n=t.getLoadingIndicator();n&&(r._featureImportWaitId=n.addWait());e.stopPropagation()}else e.preventDefault();t.div.classList.remove(TC.Consts.classes.DROP)}};o.dropListenKeys_.push(e.events.listen(i,e.events.EventType.DRAGENTER,L,o));o.dropListenKeys_.push(e.events.listen(document.body,e.events.EventType.DRAGENTER,L,o));o.dropListenKeys_.push(e.events.listen(i,e.events.EventType.DRAGOVER,L,o));o.dropListenKeys_.push(e.events.listen(document.body,e.events.EventType.DRAGOVER,L,o));o.dropListenKeys_.push(e.events.listen(i,e.events.EventType.DROP,s,o));o.dropListenKeys_.push(e.events.listen(document.body,e.events.EventType.DROP,s,o));o.dropListenKeys_.push(e.events.listen(document.body,"dragleave",P,o));o.dropListenKeys_.push(e.events.listen(document.body,"dragend",P,o));o.dropListenKeys_.push(e.events.listen(document.body,"dragexit",P,o));document.addEventListener("mouseenter",function(e){e.buttons||r.parent.div.classList.remove(TC.Consts.classes.DROP)},!1);r.ddEnabled=!0}return o};TC.wrap.Map.prototype.loadFiles=function(t,r){var n,a=this;a.ddEnabled?a.map.getInteractions().forEach(function(t){t instanceof e.interaction.DragAndDrop&&(n=t)}):n=a.enableDragAndDrop({once:!0});if(n&&r){var o=n.target;n.target=r.control;const e=function(t){n.target=o;a.parent.off(TC.Consts.event.FEATURESIMPORT,e)};a.parent.on(TC.Consts.event.FEATURESIMPORT,e)}var i=a.parent.getLoadingIndicator();i&&(a._featureImportWaitId=i.addWait());e.interaction.DragAndDrop.handleDrop_.call(n,{dataTransfer:{files:t}})};TC.wrap.Layer.prototype.getVisibility=function(e){var t=!1;this.layer&&(t=this.layer.getVisible());return t};TC.wrap.Layer.prototype.setVisibility=function(e){this.getLayer().then(function(t){t.setVisible(e)})};TC.wrap.Layer.prototype.isNative=function(t){return t instanceof e.layer.Layer};TC.wrap.Layer.prototype.setProjection=function(t){const r=this;t=t||{};const n=r.parent;if(n.map){const o=v.call(r,{crs:t.crs,extentInDegrees:e.proj.transformExtent(n.map.getExtent(),n.map.crs,"EPSG:4326")});var a=n.getResolutions();if(a&&a.length){a=a.map(function(e){return e/o});n.wrap.layer.setMaxResolution(a[0]);n.wrap.layer.setMinResolution(a[a.length-1])}else{if(n.minResolution){n.minResolution=n.minResolution/o;r.layer.setMinResolution(n.minResolution)}if(n.maxResolution){n.maxResolution=n.maxResolution/o;r.layer.setMaxResolution(n.maxResolution)}}}};TC.wrap.layer.Raster.prototype.WmsParser=e.format.WMSCapabilities;TC.wrap.layer.Raster.prototype.WmtsParser=e.format.WMTSCapabilities;TC.wrap.Layer.prototype.addCommonEvents=function(e){var t=this;e.on("change:visible",function(){t.parent.map&&t.parent.map.trigger(TC.Consts.event.LAYERVISIBILITY,{layer:t.parent})},t.parent.map)};TC.wrap.layer.Raster.prototype.getGetMapUrl=function(){var e=null;switch(this.getServiceType()){case TC.Consts.layerType.WMS:for(var t=this.parent.capabilities.Capability.Request.GetMap.DCPType,r=0;r<t.length;r++)if(t[r].HTTP&&t[r].HTTP.Get){e=t[r].HTTP.Get.OnlineResource;break}break;case TC.Consts.layerType.WMTS:e=this.parent.capabilities.OperationsMetadata.GetTile.DCP.HTTP.Get[0].href}const n=document.createDocumentFragment(),a=document.createElement("textarea");n.appendChild(a);a.innerHTML=e;return e=a.textContent};TC.wrap.layer.Raster.prototype.getInfoFormats=function(){var e=null,t=this.parent.capabilities;t.Capability&&t.Capability.Request.GetFeatureInfo&&(e=t.Capability.Request.GetFeatureInfo.Format);return e};TC.wrap.layer.Raster.infoFormatPreference=["application/json","application/vnd.ogc.gml/3.1.1","application/vnd.ogc.gml","application/vnd.esri.wms_featureinfo_xml","text/html","text/plain","text/xml"];TC.wrap.layer.Raster.prototype.getWMTSLayer=function(){var e=null,t=this.parent.capabilities;if(t&&t.Contents)for(var r=0;r<t.Contents.Layer.length;r++)for(var n=t.Contents.Layer[r],a=0;a<n.TileMatrixSetLink.length;a++)if(this.parent.options.matrixSet===n.TileMatrixSetLink[a].TileMatrixSet){e=n;break}return e};TC.wrap.layer.Raster.prototype.getTileMatrix=function(e){var t=null,r=this.parent.capabilities;if(r&&r.Contents&&r.Contents.TileMatrixSet)for(var n=0;n<r.Contents.TileMatrixSet.length;n++){var a=r.Contents.TileMatrixSet[n];if(a.Identifier===e){t=a.TileMatrix;break}}return t};TC.wrap.layer.Raster.prototype.getScaleDenominators=function(e){var t=[];e.ScaleDenominator?t=[e.ScaleDenominator,e.ScaleDenominator]:(e.MinScaleDenominator||e.MaxScaleDenominator)&&(t=[e.MaxScaleDenominator,e.MinScaleDenominator]);if(!t.length&&!this.getName(e)){for(var r=this.getLayerNodes(e),n=-1/0,a=1/0,o=0,i=r.length;o<i;o++){var s=this.getScaleDenominators(r[o]);s[0]>n&&(n=s[0]);s[1]<a&&(a=s[1])}n>-1/0&&a<1/0&&(t=[n,a])}return t};TC.wrap.layer.Raster.prototype.getAttribution=function(){const e={},t=TC.capabilities[this.parent.url];if(t)if(t.ServiceProvider){e.name=t.ServiceProvider.ProviderName.trim();e.site=t.ServiceProvider.ProviderSite;e.site.href&&e.site.href.trim().length>0&&(e.site=e.site.href)}else t.ServiceIdentification?e.name=t.ServiceIdentification.Title.trim():e.name=t.Service.Title.trim();return e};TC.wrap.layer.Raster.prototype.getInfo=function(e){var t=this,r={},n=t.parent.capabilities;if(n&&n.Capability)for(var a=t.getAllLayerNodes(),o=0;o<a.length;o++){var i=a[o];if(t.parent.compareNames(t.getName(i),e)){i.Title&&(r.title=i.Title);i.Abstract&&(r.abstract=i.Abstract);r.legend=[];var s=function(e,r){if(e.Layer&&e.Layer.length>0)for(var n in e.Layer)s(e.Layer[n],r);else r.apply(t,[e])};s(i,function(e){var t=this.getLegend(e);t.src&&r.legend.push({src:t.src,title:e.Title})});if(i.MetadataURL&&i.MetadataURL.length){r.metadata=[];for(var l=0;l<i.MetadataURL.length;l++){var p=i.MetadataURL[l];r.metadata.push({format:p.Format,type:p.type,url:p.OnlineResource})}}r.queryable=i.queryable;break}}return r};TC.wrap.layer.Raster.prototype.getServiceType=function(){var e=null,t=this.parent.capabilities;t.Capability&&t.Capability.Request&&t.Capability.Request.GetMap?e=TC.Consts.layerType.WMS:t.OperationsMetadata&&t.OperationsMetadata.GetTile&&(e=TC.Consts.layerType.WMTS);return e};TC.wrap.layer.Raster.prototype.getServiceTitle=function(){var e=null,t=this.parent.capabilities;t.Capability&&t.Service?e=t.Service.Title:t.ServiceIdentification&&(e=t.ServiceIdentification.Title);return e};TC.wrap.layer.Raster.prototype.getRootLayerNode=function(){var e;this.getServiceType()===TC.Consts.layerType.WMS&&(e=this.parent.capabilities.Capability.Layer);return e};TC.wrap.layer.Raster.prototype.getName=function(e,t){var r=e.Name;if(r&&t){var n=r.indexOf(":");n>=0&&(r=r.substr(n+1))}return r};TC.wrap.layer.Raster.prototype.getIdentifier=function(e){return e.Identifier};TC.wrap.layer.Raster.prototype.getLayerNodes=function(e){var t=e.Layer;$.isArray(t)||(t=t?[t]:[]);return t};TC.wrap.layer.Raster.prototype.getAllLayerNodes=function(){var e=this;if(!e._layerList)switch(e.getServiceType()){case TC.Consts.layerType.WMS:var t=e.getRootLayerNode();e._layerList=t?function t(r){for(var n=[r],a=e.getLayerNodes(r),o=0;o<a.length;o++)n=n.concat(t(a[o]));return n}(t):[];break;case TC.Consts.layerType.WMTS:e._layerList=e.parent.capabilities.Contents.Layer.slice();break;default:e._layerList=[]}return e._layerList};TC.wrap.layer.Raster.prototype.normalizeLayerNode=function(e){return e};TC.wrap.layer.Raster.prototype.normalizeCapabilities=function(e){return e};TC.wrap.layer.Raster.prototype.getLegend=function(e){var t={},r=e.Style;if(r&&r.length&&r.length&&r[0].LegendURL&&r[0].LegendURL.length){var n=r[0].LegendURL[0];const e=document.createDocumentFragment(),a=document.createElement("textarea");e.appendChild(a);a.innerHTML=n.OnlineResource;t.src=a.textContent}return t};TC.wrap.layer.Raster.prototype.isCompatible=function(e){var t=this,r=!0,n=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(n.capabilities&&n.capabilities.Capability&&n.capabilities.Capability.Layer&&n.names.length>0)for(var a=n.names.slice(0),o=function r(a,o,i){var s=!1;if(a)for(var l=0;l<a.length;l++){var p=a[l];const u=p.CRS||p.SRS,f=Array.isArray(u)?u:[u];var c=i||$.inArray(e,f)>=0;if(n.compareNames(t.getName(p),o)){c&&(s=!0);break}if(r(p.Layer,o,c)){s=!0;break}}return s};a.length>0;)if(!o([n.capabilities.Capability.Layer],a.pop())){r=!1;break}break;case TC.Consts.layerType.WMTS:r=!1;if(n.capabilities&&n.capabilities.Contents&&n.capabilities.Contents.TileMatrixSet)for(var i=n.capabilities.Contents.TileMatrixSet,s=0;s<i.length;s++)if(i[s].Identifier===n.options.matrixSet){r=TC.Util.CRSCodesEqual(e,i[s].SupportedCRS);break}}return r};TC.wrap.layer.Raster.prototype.getCompatibleCRS=function(){var e=[],t=this.parent;switch(this.getServiceType()){case TC.Consts.layerType.WMS:if(t.capabilities&&t.capabilities.Capability&&t.capabilities.Capability.Layer&&t.names.length>0){const r=t.names.map(function(e){return t.getNodePath(e).map(function(e){const t=e.CRS||e.SRS||[],r=Array.isArray(t)?t:[t];return $.isArray(r)?r:[r]}).reduce(function(e,t){if(0===e.length)return t;t.forEach(function(t){e.indexOf(t)<0&&(e[e.length-1]=t)});return e},[])});if(1===r.length)e=r[0];else{const t=r.slice(1);e=r[0].filter(function(e){return t.every(function(t){return t.indexOf(e)>=0})})}}break;case TC.Consts.layerType.WMTS:t.capabilities&&t.capabilities.Contents&&t.capabilities.Contents.Layer.filter(function(e){return e.Identifier===t.layerNames}).forEach(function(r){const n=r.TileMatrixSetLink.map(function(e){return e.TileMatrixSet});e=t.capabilities.Contents.TileMatrixSet.filter(function(e){return n.indexOf(e.Identifier)>=0}).map(function(e){return e.SupportedCRS})})}return e};TC.wrap.layer.Raster.prototype.getCompatibleLayers=function(e){var t=[],r=this.parent;switch(this.getServiceType()){case TC.Consts.layerType.WMS:if(r.capabilities&&r.capabilities.Capability&&r.capabilities.Capability.Layer){var n=function(e,r,a){var o=e.CRS||e.SRS,i=Array.isArray(o)?o:[o],s=a||$.inArray(r,i)>=0;s&&e.Name&&(t[t.length]=e.Name);if(e.Layer)for(var l=0;l<e.Layer.length;l++)n(e.Layer[l],r,s)};n(r.capabilities.Capability.Layer,e)}break;case TC.Consts.layerType.WMTS:if(r.capabilities&&r.capabilities.Contents&&r.capabilities.Contents.TileMatrixSet)for(var a=r.capabilities.Contents.TileMatrixSet,o=0,i=a.length;o<i;o++){var s=a[o];if(TC.Util.CRSCodesEqual(e,s.SupportedCRS))for(var l=s.Identifier,p=r.capabilities.Contents.Layer,c=0,u=p.length;c<u;c++)for(var f=p[c].TileMatrixSetLink,g=0,m=f.length;g<m;g++)if(f[g].TileMatrixSet===l){t[t.length]=p[c].Identifier;break}}}return t};TC.wrap.layer.Raster.prototype.getCompatibleMatrixSets=function(e){var t=[];S({crs:e});var r=this.parent;if(this.getServiceType()===TC.Consts.layerType.WMTS)for(var n=r.capabilities.Contents.Layer,a=r.capabilities.Contents.TileMatrixSet,o=0,i=n.length;o<i;o++)if(r.layerNames===n[o].Identifier)for(var s=n[o].TileMatrixSetLink,l=0,p=s.length;l<p;l++)for(var c=s[l],u=0,f=a.length;u<f;u++){var g=a[u];if(g.Identifier===c.TileMatrixSet){TC.Util.CRSCodesEqual(e,g.SupportedCRS)&&(t[t.length]=g.Identifier);break}}return t};TC.wrap.layer.Raster.prototype.setWMTSUrl=function(){var e=this;e.getLayer().then(function(t){e.parent.options=e.parent.options||{};var r=t.getSource().getUrls();e.parent.options.urlPattern=r[r.length-1]})};TC.wrap.layer.Raster.prototype.createWMSLayer=function(t,r,n){const a=this;var o=null,i=new e.source.ImageWMS({url:t,crossOrigin:n.map?n.map.options.crossOrigin:void 0,params:r,extent:TC.Cfg.initialExtent,ratio:TC.Cfg.imageRatio,imageLoadFunction:$.proxy(a.parent.getImageLoad,a.parent)});i.on(e.source.Image.EventType_.IMAGELOADSTART,function(e){a.trigger(TC.Consts.event.BEFORETILELOAD,{tile:e.image.getImage()})});i.on(e.source.Image.EventType_.IMAGELOADEND,function(e){a.trigger(TC.Consts.event.TILELOAD,{tile:e.image.getImage()})});i.on(e.source.Image.EventType_.IMAGELOADERROR,function(e){a.trigger(TC.Consts.event.TILELOAD,{tile:e.image.getImage()})});var s={visible:!!r.LAYERS.length||n&&n.method&&"POST"===n.method,source:i};n.minResolution&&(s.minResolution=n.minResolution);n.maxResolution&&(s.maxResolution=n.maxResolution);(o=new e.layer.Image(s))._wrap=a;a.addCommonEvents(o);return o};var M=function(t){var r=this,n=null,a=e.source.WMTS.optionsFromCapabilities(r.parent.capabilities,{layer:t.layerNames,matrixSet:t.matrixSet,crossOrigin:t.map?t.map.options.crossOrigin:void 0,requestEncoding:t.encoding,format:t.format});if(a){"https:"===location.protocol&&(a.urls=a.urls.map(function(e){return e.replace("http:","https:")}));a.crossOrigin=t.map?t.map.options.crossOrigin:void 0;(n=new e.source.WMTS(a)).setTileLoadFunction($.proxy(r.parent.getImageLoad,r.parent));n.on(e.source.TileEventType.TILELOADSTART,function(e){r.trigger(TC.Consts.event.BEFORETILELOAD,{tile:e.tile.getImage()})});n.on(e.source.TileEventType.TILELOADEND,function(e){r.trigger(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()})});n.on(e.source.TileEventType.TILELOADERROR,function(e){r.trigger(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()})});var o=$.proxy(n.getResolutions,n);n.getResolutions=function(){var e=o(),t=r.parent.getLimitedMatrixSet();if(t&&t.length){var n=t[0].matrixIndex;e=e.slice(n,t.length+n)}return e}}return n};TC.wrap.layer.Raster.prototype.createWMTSLayer=function(t){const r=this;var n=null,a=M.call(r,t);if(a){var o={source:a};t.minResolution&&(o.minResolution=t.minResolution);t.maxResolution&&(o.maxResolution=t.maxResolution);(n=new e.layer.Tile(o))._wrap=r;r.addCommonEvents(n);var i=a.getResolutions();n.setMaxResolution(i[0]+1);n.setMinResolution(i[i.length-1])}return n};TC.wrap.layer.Raster.prototype.getParams=function(){return this.layer.getSource().getParams()};TC.wrap.layer.Raster.prototype.setParams=function(e){this.layer.getSource().updateParams(e)};TC.wrap.layer.Raster.prototype.setMatrixSet=function(e){const t=this;t.layer.getSource().getResolutions();if(t.parent.type===TC.Consts.layerType.WMTS){const r=M.call(t,$.extend({},t.parent.options,{matrixSet:e})),n=r.getResolutions(),a=n[0],o=n[n.length-1];t.layer.setMaxResolution(a);t.layer.setMinResolution(o);t.parent.minResolution&&(t.parent.minResolution=o);t.parent.maxResolution&&(t.parent.maxResolution=a);t.layer.setSource(r)}};TC.wrap.layer.Raster.prototype.getResolutions=function(){if(this.layer.getSource){var e=this.layer.getSource();return e.getResolutions&&e.getResolutions!=goog.abstractMethod?e.getResolutions():[]}return[]};TC.wrap.Geometry={getNearest:function(t,r){return new e.geom.LineString(r).getClosestPoint(t)}};var R=function(e,t,r){if(e){var n=function(n){var a=(r&&r._wrap?r._wrap.parent.options.width:null)||t;if(a<n){var o=a/n;e.setScale(o)}},a=e.getSize();if(a)n(a[0]);else{var o=e.getImage();if(o.naturalWidth)n(o.naturalWidth);else{const t=document.createDocumentFragment(),r=document.createElement("img");r.src=e.getSrc();r.addEventListener("load",function(){n(this.naturalWidth)});t.appendChild(r)}}}},_=function(e,t){var r=e,n=t&&t.wrap&&t.wrap.feature;if("string"==typeof e){var a=e.match(/^\$\{(.+)\}$/);if(a&&n){for(var o=a[1].split("."),i=n.getProperties(),s=0;s<o.length&&void 0!==i;s++)i=i[o[s]];if(void 0===i){i=t.data;for(s=0;s<o.length&&void 0!==i;s++)i=i[o[s]]}r=i}}else $.isFunction(e)&&(r=e(t));return r},x=function(e){var t=e.getStyle();$.isFunction(t)&&(t=t.call(e));$.isArray(t)&&(t=t[0]);return t},A=function(t,r){var n,a,o,i,s,l={};if(r){switch(r.getGeometry().getType()){case"Point":case"MultiPoint":a=!0;break;case"LineString":case"MultiLineString":o=!0;break;case"Polygon":case"MultiPolygon":i=!0}n=r._wrap?r._wrap.parent:{id:TC.wrap.Feature.prototype.getId.call({feature:r}),features:r.get("features"),getData:function(){return TC.wrap.Feature.prototype.getData.call({feature:r})}}}var p={};if((s=n&&$.isArray(n.features)&&n.features.length>1&&t.cluster?$.extend(!0,{},TC.Cfg.styles.cluster,t.cluster.styles):t.styles||TC.Cfg.styles).line&&(o||!r)){p=s.line;l.stroke=new e.style.Stroke({color:_(s.line.strokeColor,n),width:_(s.line.strokeWidth,n),lineDash:s.line.lineDash})}if(s.polygon&&(i||!r)){p=s.polygon;l.fill=new e.style.Fill({color:h(_(s.polygon.fillColor,n),_(s.polygon.fillOpacity,n))});l.stroke=new e.style.Stroke({color:_(s.polygon.strokeColor,n),width:_(s.polygon.strokeWidth,n),lineDash:s.polygon.lineDash})}if(s.point&&(a||!r)){p=s.point;var c={radius:_(p.radius,n)||(_(p.height,n)+_(p.width,n))/4};p.fillColor&&(c.fill=new e.style.Fill({color:h(_(p.fillColor,n),_(p.fillOpacity,n))}));p.strokeColor&&(c.stroke=new e.style.Stroke({color:_(p.strokeColor,n),width:_(p.strokeWidth,n),lineDash:p.lineDash}));isNaN(c.radius)||(l.image=new e.style.Circle(c))}p.label&&(l.text=I(p,n));if(s.marker&&(a||!r)){if((p=s.marker).url){l.image=new e.style.Icon({crossOrigin:"anonymous",anchor:p.anchor,anchorXUnits:p.anchorXUnits||"fraction",anchorYUnits:p.anchorYUnits||"fraction",src:p.url});l.text=I(p,n)}}return[new e.style.Style(l)]};const I=function(t,r){if(!t||!t.label)return;const n={text:""+_(t.label,r)};t.fontSize&&(n.font=_(t.fontSize,r)+"pt sans-serif");t.angle&&(n.rotation=-Math.PI*_(t.angle,r)/180);t.fontColor&&(n.fill=new e.style.Fill({color:h(_(t.fontColor,r),1)}));t.labelOutlineColor&&(n.stroke=new e.style.Stroke({color:h(_(t.labelOutlineColor,r),1),width:_(t.labelOutlineWidth,r)}));if(t.labelOffset){n.offsetX=t.labelOffset[0];n.offsetY=t.labelOffset[1]}return new e.style.Text(n)};var O=function(e){var t=e.toString(16);1===t.length&&(t="0"+t);return t},F=function(e){return"#"+O(e[0])+O(e[1])+O(e[2])},G=function(t,r){var n={};$.isFunction(t)&&r&&(t=t(r));$.isArray(t)&&(t=t[0]);if(!$.isFunction(t)){var a,o,i,s=t.getImage();if(s)if(s instanceof e.style.RegularShape){o=s.getStroke();a=e.color.asArray(o.getColor());n.strokeColor=F(a);n.strokeWidth=o.getWidth();if(i=s.getFill()){a=e.color.asArray(i.getColor());n.fillColor=F(a);n.fillOpacity=a[3]}}else{n.url=s.getSrc();var l=s.getSize();if(l){n.width=l[0];n.height=l[1];n.anchor=s.getAnchor();if(n.anchor){n.anchor[0]=n.anchor[0]/n.width;n.anchor[1]=n.anchor[1]/n.height}}}else{if(o=t.getStroke()){a=e.color.asArray(o.getColor());n.strokeColor=F(a);n.strokeWidth=o.getWidth();n.lineDash=o.getLineDash()}if(i=t.getFill()){a=e.color.asArray(i.getColor());n.fillColor=F(a);n.fillOpacity=a[3]}}}return n};TC.wrap.layer.Vector.prototype.getStyle=function(){return G(this.layer.getStyle())};TC.wrap.layer.Vector.prototype.reloadSource=function(){const t=this;return new Promise(function(r,n){const a=t.createVectorSource(t.parent,t.createStyles(t.parent));if(t.parent.type===TC.Consts.layerType.WFS)var o=a.source.on("change",function(t){if("ready"==a.source.getState()){e.Observable.unByKey(o);r()}});var i=t.layer.getSource().getFeatures();t.layer.setSource(a.source);a.style&&t.layer.setStyle(a.style);if(t.parent.type!=TC.Consts.layerType.WFS){a.source.addFeatures(i);r()}})};TC.wrap.layer.Vector.prototype.import=function(e){var t=$.extend({},e);t.type=e.format;var r=this.layer.getSource().getFeatures(),n=this.createVectorSource(t,this.createStyles(this.parent));this.layer.setSource(n.source);n.style&&this.layer.setStyle(n.style);n.source.addFeatures(r)};const N=function(t){t._wrapPromise||(t._wrapPromise=new Promise(function(r,n){var a,o=t.getGeometry();const i=t.getStyle();i&&(a=G(i,t));const s=function(e){e?TC.loadJS(!TC.feature||!TC.feature[e],TC.apiLocation+"TC/feature/"+e,function(){r(new TC.feature[e](t,a))}):r(new TC.Feature(t,a))};o instanceof e.geom.Point?!function(t){var r=null,n=x(t);if(n){var a=n.getImage();a instanceof e.style.Icon&&(r=a.getSrc())}return r}(t)?s("Point"):s("Marker"):o instanceof e.geom.LineString?s("Polyline"):o instanceof e.geom.Polygon?s("Polygon"):o instanceof e.geom.MultiLineString?s("MultiPolyline"):o instanceof e.geom.MultiPolygon?s("MultiPolygon"):s()}));return t._wrapPromise};TC.wrap.layer.Vector.prototype.createVectorSource=function(t,r){var n,a,o,i,s,l=this,p=!1;if($.isArray(t.url)||t.urls){var c=t.urls||t.url;a={url:c=$.map(c,function(e,t){return TC.proxify(e)}),format:new e.format.KML({showPointNames:!1}),projection:t.crs}}else if(t.url&&t.type!==TC.Consts.layerType.WFS){(a={url:TC.proxify(t.url),projection:t.crs}).format=w(t.format)||w(function(e){var t=e.indexOf("?");t>=0?e=e.substr(0,t):(t=e.indexOf("#"))>=0&&(e=e.substr(0,t));switch(e.substr(e.lastIndexOf(".")+1).toLowerCase()){case"kml":return TC.Consts.mimeType.KML;case"json":case"geojson":return TC.Consts.mimeType.GEOJSON;case"gml":return TC.Consts.mimeType.GML;case"gpx":return TC.Consts.mimeType.GPX;default:return null}}(t.url))||w(t.type);a.loader=(o=a.url,i=a.format,s=e.featureloader.xhr(o,i),function(e,t,r){l.parent.state=TC.Layer.state.LOADING;l.parent.map&&l.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:l.parent});s.call(this,e,t,r)});p=!0}else if(t.data)(a={projection:t.crs,loader:function(e,r,n){l.parent.state=TC.Layer.state.LOADING;l.parent.map&&l.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:l.parent});var a=this.getFormat();try{var o=a.readFeatures(t.data,{featureProjection:n});this.addFeatures(o);l.parent.state=TC.Layer.state.IDLE;l.parent.map&&l.parent.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:l.parent,newData:data})}catch(e){l.parent.state=TC.Layer.state.IDLE;l.parent.map&&l.parent.map.trigger(TC.Consts.event.LAYERERROR,{layer:l.parent,reason:e.message})}}}).format=w(t.format)||w(t.type);else if(t.type==TC.Consts.layerType.WFS){var u,f;switch(t.outputFormat){case TC.Consts.format.JSON:u=new e.format.GeoJSON({geometryName:t.geometryName});f="json";break;case TC.Consts.format.GML3:u=new e.format.GML3Patched;f=TC.Consts.mimeType.GML;break;default:u=new e.format.GML2;f=TC.Consts.mimeType.GML}a={format:u,loader:function(e,r,n){var a=this,o=t.url;if(o){l.parent.state=TC.Layer.state.LOADING;l.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:l.parent});var i={},s=n.getCode(),p=t.version||"1.1.0",c=o,g=$.isArray(t.featureType)?t.featureType:[t.featureType];if(!t.properties||t.properties instanceof Array&&!t.properties.length||!Object.keys(t.properties).length){c=c+"?service=WFS&version="+p+"&request=GetFeature&typename="+g.join(",")+"&outputFormat="+f+"&srsname="+s;e[0]!==-1/0&&e[1]!==-1/0&&e[2]!==1/0&&e[3]!==1/0&&(c=c+"&bbox="+e.join(",")+","+s);t.maxFeatures&&(c=c+"maxFeatures="+t.maxFeatures)}else{i.method="POST";switch(f){case"json":i.responseType=TC.Consts.mimeType.JSON;break;default:i.responseType=TC.Consts.mimeType.XML}var m=[];m[m.length]='<wfs:GetFeature xmlns:wfs="http://www.opengis.net/wfs" service="WFS" version="';m[m.length]=p;m[m.length]='" outputFormat="';m[m.length]=t.outputFormat;if(t.maxFeatures){m[m.length]='" maxFeatures="';m[m.length]=t.maxFeatures}m[m.length]='" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/';m[m.length]=p;m[m.length]='/wfs.xsd">';for(var y=0;y<g.length;y++){m[m.length]='<wfs:Query typeName="feature:';m[m.length]=g[y];m[m.length]='" srsName="';m[m.length]=s;m[m.length]='">';if(t.propertynames){var d="1.1.0"===p?"wfs":"ogc",h="string"==typeof t.propertynames?t.propertynames.split(","):t.propertynames;t.geometryName&&h.push(t.geometryName);for(;y<h.length;y++)m[m.length]="<"+d+":PropertyName>"+h[y].trim()+"</"+d+":PropertyName>"}m[m.length]=t.properties.getText();m[m.length]="</wfs:Query>"}m[m.length]="</wfs:GetFeature>";i.data=m.join("");i.contentType=TC.Consts.mimeType.XML}i.url=c;l._requestUrl=c;TC.ajax(i).then(function(e){const t=u.readFeatures(e),r=function(){l.parent.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:l.parent,newData:e})},n=function(e){if(e.layer===l.parent){l.parent.map.off(TC.Consts.event.FEATURESADD,n);r()}};if(t.length){a.addFeatures(t);l.parent.map.on(TC.Consts.event.FEATURESADD,n)}else r();l.parent.state=TC.Layer.state.IDLE})}},projection:t.crs}}n=new e.source.Vector(a);p&&n.on(e.events.EventType.CHANGE,function(e){l.parent.map&&l.parent.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:l.parent})});n._tcLayer=l.parent;var g=t.style&&t.style.marker?t.style.marker:TC.Cfg.styles.marker;t.style&&t.style.marker||(g=$.extend({},g,{anchor:TC.Cfg.styles.point.anchor}));if(t.cluster){n=new e.source.Cluster({projection:t.crs,distance:t.cluster.distance,source:n});if(t.cluster.animate){var m=function(t,r){var n=Date.now(),a=t.getGeometry().getCoordinates(),o=r.getGeometry().getCoordinates();r.setGeometry(new e.geom.Point(a));requestAnimationFrame(function i(){var s=function(e,t,r,n){var a=Math.min((Date.now()-n)/r,1),o=(t[0]-e[0])*a,i=(t[1]-e[1])*a;return[e[0]+o,e[1]+i]}(a,o,TC.Consts.CLUSTER_ANIMATION_DURATION,n);r.setGeometry(new e.geom.Point(s));s[0]!==o[0]&&s[1]!==o[1]?requestAnimationFrame(i):y.splice($.inArray(t,y),1)})},y=[];n.addEventListener(e.source.VectorEventType.REMOVEFEATURE,function(e){var t=e.feature.get("features");t&&t.length>1&&y.push(e.feature)});n.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){var t=e.feature.get("features");if(t){var r=t[0].getGeometry().getCoordinates();if(t.length>1){var n=$.grep(y,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]});n.length&&y.splice($.inArray(n[0],y),1)}var a=$.grep(y,function(e){var t=e.get("features");if(t&&t.length>0){return $.grep(t,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]}).length>0}});a.length&&m(a[a.length-1],e.feature)}})}}var d=n;do{d.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){var t=e.feature,r=x(t);r&&R(r.getImage(),g.width,t)});d=$.isFunction(d.getSource)?d.getSource():null}while(d);n.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){const t=e.feature,r=function(e){var r;switch(!0){case TC.feature.Point&&e instanceof TC.feature.Point:r=l.parent.addPoint;break;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:r=l.parent.addPolyline;break;case TC.feature.Polygon&&e instanceof TC.feature.Polygon:r=l.parent.addPolygon;break;case TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon:r=l.parent.addMultiPolygon;break;case TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline:r=l.parent.addMultiPolyline;break;default:r=l.parent.addFeature}if(r){var n;r.call(l.parent,t).then(function(r){var a=t.get("features");$.isArray(a)&&(r.features=$.map(a,function(t){return new e.constructor(t)}));clearTimeout(n);n=setTimeout(function(){l.parent.map.trigger(TC.Consts.event.FEATURESADD,{layer:l.parent,features:[r]})},50)})}};t._wrap&&t._wrap.parent.layer||N(t).then(r)});n.addEventListener(e.source.VectorEventType.REMOVEFEATURE,function(e){var t=e.feature;if(t._wrap){var r=$.inArray(t._wrap.parent,l.parent.features);if(r>-1){l.parent.features.splice(r,1);l.parent.map.trigger(TC.Consts.event.FEATUREREMOVE,{layer:l.parent,feature:t._wrap.parent})}}});n.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){l.parent.map&&l.parent.map.trigger(TC.Consts.event.VECTORUPDATE,{layer:l.parent})});n.addEventListener(e.source.VectorEventType.REMOVEFEATURE,function(){l.parent.map&&l.parent.map.trigger(TC.Consts.event.VECTORUPDATE,{layer:l.parent})});n.addEventListener(e.source.VectorEventType.CLEAR,function(){l.parent.map&&l.parent.map.trigger(TC.Consts.event.FEATURESCLEAR,{layer:l.parent})});var h={source:n};t.minResolution&&(h.minResolution=t.minResolution);t.maxResolution&&(h.maxResolution=t.maxResolution);a&&a.format instanceof e.format.KML&&!t.cluster||(h.style=r||t.styles);return h};TC.wrap.layer.Vector.prototype.createStyles=function(e){var t=this,r=!1;if($.isFunction(e)){r=!0;t.styleFunction=function(t){return A(e(t))}}else{(e=$.extend({},e)).crs=e.crs||TC.Cfg.crs;e.styles=e.styles||TC.Cfg.styles;r=!(!e.cluster||!e.cluster.styles)||function e(t){for(var r in t){var n=t[r];switch(typeof n){case"string":if(/^\$\{(.+)\}$/.test(n))return!0;break;case"object":if(e(n))return!0;break;case"function":return!0}}return!1}(e.styles);t.styleFunction=function(e){return A(t.parent.options,e)}}return r?t.styleFunction:t.styleFunction()};TC.wrap.layer.Vector.prototype.setStyles=function(e){const t=this;t.getLayer().then(function(r){r.setStyle(t.createStyles(e))})};TC.wrap.layer.Vector.prototype.createVectorLayer=function(){var t=null,r=this.parent.options,n=this.createVectorSource(r,this.createStyles(r));n.declutter=this.parent.options.declutter||!1;(t=new e.layer.Vector(n))._wrap=this;this.addCommonEvents(t);return t};TC.wrap.layer.Vector.prototype.addFeatures=function(e){const t=this,r=function(t){for(var r=t;$.isFunction(r.getSource);)r=r.getSource();r.addFeatures(e)};t.layer?r(t.layer):t.getLayer().then(r)};TC.wrap.layer.Vector.prototype.getFeatures=function(){var t=this.getLayer();return t instanceof e.layer.Layer?t.getSource().getFeatures():[]};TC.wrap.layer.Vector.prototype.getFeatureById=function(t){var r=this.layer;return r instanceof e.layer.Layer?r.getSource().getFeatureById(t):null};TC.wrap.layer.Vector.prototype.removeFeature=function(e){const t=this,r=function(t){if(e.wrap.feature){t.getSource().removeFeature(e.wrap.feature)}};t.layer?r(t.layer):t.getLayer().then(r)};TC.wrap.layer.Vector.prototype.clearFeatures=function(){const e=this,t=function(e){var t=e.getSource();t.clearFeatures?t.clearFeatures():t.clear()};e.layer?t(e.layer):e.getLayer().then(t)};TC.wrap.layer.Vector.prototype.setFeatureVisibility=function(t,r){var n=this,a={color:"rgba(0, 0, 0, 0)"},o={color:"rgba(0, 0, 0, 0)"},i=new e.style.Style({image:new e.style.Circle({radius:0,fill:new e.style.Fill(a),stroke:new e.style.Stroke(o)}),fill:new e.style.Fill(a),stroke:new e.style.Stroke(o)});if($.inArray(t,n.parent.features)>=0){var s=t.wrap.feature;n.getLayer().then(function(e){if(r&&s._originalStyle)s.setStyle(s._originalStyle);else{s._originalStyle=s.getStyle()||e.getStyle();s.setStyle(i)}n.parent.map.trigger(TC.Consts.event.VECTORUPDATE,{layer:n.parent})})}};TC.wrap.layer.Vector.prototype.getRGBA=function(e,t){return h(e,t)};TC.wrap.layer.Vector.prototype.findFeature=function(e){};TC.wrap.layer.Vector.prototype.getGetFeatureUrl=function(){return this._requestUrl};TC.wrap.layer.Vector.prototype.getDescribeFeatureTypeUrl=function(){var e=this.parent,t=e.options.version||"1.1.0",r=e.url;return r=r+"?service=WFS&version="+t+"&request=DescribeFeatureType&typename="+($.isArray(e.options.featureType)?e.options.featureType:[e.options.featureType]).join(",")+"&outputFormat=XMLSCHEMA"};TC.wrap.layer.Vector.prototype.sendTransaction=function(t,r,n){const a=this,o=function(e){return e.wrap.feature};return new Promise(function(i,s){const l=t.map(o),p=r.map(o),c=n.map(o);t.length||r.length||n.length?a.getLayer().then(function(t){t.getSource();var r=new e.format.WFS,n=a.parent.options,o=r.writeTransaction(l,p,c,{featurePrefix:n.featurePrefix,featureNS:n.featureNS,featureType:n.featureType[0]}),u={url:a.parent.url,method:"POST",responseType:TC.Consts.mimeType.XML,data:o.outerHTML};TC.ajax(u).then(function(e){var t=e.getElementsByTagName("ExceptionReport")[0],n={reason:""};if(t){var a=t.getElementsByTagName("Exception")[0];if(a){n.code=a.getAttribute("exceptionCode");for(var o=a.getElementsByTagName("ExceptionText"),l=0,p=o.length;l<p;l++)n.reason+="\n"+o[l].innerHTML}s(n)}else{var c=r.readTransactionResponse(e);i(c)}}).catch(function(){s({code:"",reason:"unknown"})})}):i(a.parent)})};TC.wrap.layer.Vector.prototype.setDraggable=function(t,r,n){var a=this;Promise.all([a.parent.map.wrap.getMap(),a.getLayer()]).then(function(o){const i=o[0],s=o[1];if(t){var p={layers:[s],features:new e.Collection(s.getSource().getFeatures())};a.interaction=new e.interaction.Translate(p);$.isFunction(r)&&a.interaction.on(e.interaction.TranslateEventType.TRANSLATEEND,function(e){e.features.getLength()&&r(e.features.item(0)._wrap.parent)});$.isFunction(n)&&a.interaction.on(e.interaction.TranslateEventType.TRANSLATESTART,function(e){e.features.getLength()&&n(e.features.item(0)._wrap.parent)});i.addInteraction(a.interaction);if(TC.Util.detectIE()){a._handlerDraggablePointerMove=function(e){if(!e.dragging){var t=i.getEventPixel(e);i.hasFeatureAtPixel(t)?i.forEachFeatureAtPixel(t,function(e,t){t._wrap&&t._wrap.parent&&t._wrap.parent.id===a.parent.id&&e?i.getTarget().style.cursor="move":i.getTarget().style.cursor=""},{hitTolerance:l}):i.getTarget().style.cursor=""}};i.on("pointermove",a._handlerDraggablePointerMove)}}else if(a.interaction){i.removeInteraction(a.interaction);if(TC.Util.detectIE()&&a._handlerDraggablePointerMove&&$.isFunction(a._handlerDraggablePointerMove)){i.un("pointermove",a._handlerDraggablePointerMove);delete a._handlerDraggablePointerMove}}})};TC.wrap.layer.Vector.prototype.getFeaturesInExtent=function(t,r){var n=this.layer.getSource().getFeatures(),a=[];if(r){var o=this.parent.map.getPixelFromCoordinate([t[0],t[1]]),i=this.parent.map.getPixelFromCoordinate([t[2],t[3]]);o[0]-=r[0]/2;o[1]+=r[1];i[0]+=r[0]/2;t=this.parent.map.getCoordinateFromPixel(o).concat(this.parent.map.getCoordinateFromPixel(i))}for(var s=0;s<n.length;s++){var l=n[s],p=l.getGeometry().getCoordinates();e.extent.containsCoordinate(t,p)&&a.push(l._wrap.parent)}return a};TC.wrap.layer.Vector.prototype.getAttribution=function(){return null};TC.wrap.control.Click.prototype.register=function(e){var t=this;t._trigger=function(r){if(e.view!==TC.Consts.view.PRINTING){var n=0;e.wrap.map.forEachFeatureAtPixel(r.pixel,function(e,t){e._wrap&&e._wrap.parent.showsPopup&&n++},{hitTolerance:l});if(!n){t.parent.map.trigger(TC.Consts.event.CLICK,{coordinate:r.coordinate,pixel:r.pixel});t.parent.callback(r.coordinate,r.pixel)}return 0===n}}};TC.wrap.control.Click.prototype.activate=function(){var t=this;t.parent.map.wrap.getMap().then(function(r){r.on(e.MapBrowserEventType.SINGLECLICK,t._trigger)})};TC.wrap.control.Click.prototype.deactivate=function(){var t=this;t.parent.map.wrap.getMap().then(function(r){r.un(e.MapBrowserEventType.SINGLECLICK,t._trigger)})};TC.wrap.control.ScaleBar.prototype.render=function(){this.ctl?this.ctl.updateElement_():this.ctl=new e.control.ScaleLine({target:this.parent.div})};TC.wrap.control.ScaleBar.prototype.getText=function(){if(this.ctl)return this.ctl.renderedHTML_};TC.wrap.control.NavBar.prototype.register=function(t){var r=this;t.wrap.getMap().then(function(n){const a=r.parent.div;r.zCtl=new e.control.Zoom({target:a});r.zsCtl=new e.control.ZoomSlider({render:function(t){if(!t.frameState||!t.frameState.viewState||n.getView().getMinResolution()<=t.frameState.viewState.resolution){var a=function(){if(this.element.offsetWidth>this.element.offsetHeight){r.requestSliderSize||(r.requestSliderSize=window.requestAnimationFrame(a.bind(this)));window.requestAnimationFrame(a.bind(this))}else if(this.element.offsetWidth<this.element.offsetHeight){if(r.requestSliderSize){window.cancelAnimationFrame(r.requestSliderSize);delete r.requestSliderSize}e.control.ZoomSlider.render.call(this,t)}};a.call(this)}}});r.zsCtl.setTarget(a);n.addControl(r.zsCtl);n.addControl(r.zCtl);a.querySelectorAll("button").forEach(function(e){e.classList.add("tc-ctl-btn");e.classList.add(r.parent.CLASS+"-btn");e.style.display="block";e.innerHTML="";if(e.matches(".ol-zoom-in")){e.classList.add(r.parent.CLASS+"-btn-zoomin");e.setAttribute("title",r.parent.getLocaleString("zoomIn"))}if(e.matches(".ol-zoom-out")){e.classList.add(r.parent.CLASS+"-btn-zoomout");e.setAttribute("title",r.parent.getLocaleString("zoomOut"))}});const o=a.querySelector(".ol-zoomslider");o.classList.add(r.parent.CLASS+"-bar");o.querySelector(".ol-zoomslider-thumb").classList.add(r.parent.CLASS+"-slider");t.on(TC.Consts.event.BASELAYERCHANGE,$.proxy(r.refresh,r))})};TC.wrap.control.NavBar.prototype.refresh=function(){var t=this,r=t.parent.map.wrap.map;t.parent.renderPromise().then(function(){if(t.zsCtl.sliderInitialized_){var n=r.getView().getResolution();t.zsCtl.setThumbPosition_(n)}else r.once(e.MapEventType.POSTRENDER,function(e){t.zsCtl.render(e)})})};TC.wrap.control.NavBarHome.prototype.register=function(t){var r=this;t.wrap.getMap().then(function(n){const a=r.parent.div;r.z2eCtl=new e.control.ZoomToExtent({target:a,extent:t.initialExtent,tipLabel:""});n.addControl(r.z2eCtl);a.querySelectorAll("button").forEach(function(e){e.style.display="block";e.innerHTML=""});const o=a.querySelector(".ol-zoom-extent button");o.classList.add("tc-ctl-btn");o.classList.add(r.parent.CLASS+"-btn");o.setAttribute("title",r.parent.getLocaleString("zoomToInitialExtent"))})};TC.wrap.control.NavBarHome.prototype.setInitialExtent=function(e){this.z2eCtl.extent=e};TC.wrap.control.Coordinates.prototype.register=function(t){const r=this;r.map=t;return new Promise(function(n,a){r._coordsTrigger=function(e){r.parent.coordsToClick(e)};t.wrap.getMap().then(function(t){r.olMap=t;if(r.parent.map.on3DView){r.parent.crs=r.parent.map.view3D.crs;r.parent.units=TC.Consts.units.DEGREES}else{var a=t.getView().getProjection();r.parent.crs=a.getCode();r.parent.units=a.getUnits()}r.parent.isGeo=r.parent.units===e.proj.Units.DEGREES;n()})})};TC.wrap.control.Coordinates.prototype.onMouseMove=function(e){if(this.map.wrap.map){var t=this.map.wrap.map.getEventCoordinate(e);if(t){this.parent.isGeo?this.parent.latLon=t.reverse():this.parent.xy=t;this.parent.update.apply(this.parent,arguments)}}};TC.wrap.control.Geolocation.prototype.register=function(e){var t=this;t.map=e;t._snapTrigger=function(e){e.dragging||t.initSnap(t.olMap.getEventCoordinate(e),e.pixel)};t._postcomposeTrigger=function(e){t.duringTrackSnap(e)};e.wrap.getMap().then(function(e){t.olMap=e})};var b=function(){return this.parent.layerTracking.features.filter(function(e){return e instanceof TC.feature.Polyline})[0]};TC.wrap.control.Geolocation.prototype.hasCoordinates=function(){return this.parent.layerTracking.features.length>0&&this.parent.layerTracking.features[0].geometry.length>=1};TC.wrap.control.Geolocation.prototype.showElevationMarker=function(e){TC.wrap.control.ResultsPanel.prototype.showElevationMarker.call(this,{data:e,layer:this.parent.layerTrack,coords:this.parent.chart.coordinates})};TC.wrap.control.Geolocation.prototype.hideElevationMarker=function(){TC.wrap.control.ResultsPanel.prototype.hideElevationMarker.call(this)};TC.wrap.control.Geolocation.prototype.addWaypoint=function(t,r){var n=new e.Feature({geometry:new e.geom.Point([t[0],t[1],r.ele,r.time],"XYZM")});n.setProperties(r);this.parent.layerTracking.wrap.layer.getSource().addFeature(n)};TC.wrap.control.Geolocation.prototype.addPosition=function(e,t,r,n,a,o,i){var s=Math.round(e[0]),l=Math.round(e[1]),p=b.call(this);if(this.parent.layerTracking.features&&p){var c=p.geometry.length>0&&p.geometry[p.geometry.length-1];if(c&&0==c.length){this.parent.layerTracking.features[0].geometry.push([s,l,i,r]);p.wrap.feature.getGeometry().appendCoordinate([s,l,i,r])}else{var u=Math.round(c[0]),f=Math.round(c[1]);if(s!=u||l!=f){this.parent.layerTracking.features[0].geometry.push([s,l,i,r]);p.wrap.feature.getGeometry().appendCoordinate([s,l,i,r])}}TC.Util.storage.setSessionLocalValue(this.parent.Const.LocalStorageKey.TRACKINGTEMP,this.formattedToStorage(this.parent.layerTracking).features)}this.parent.trigger(this.parent.Const.Event.STATEUPDATED,{moving:void 0!=t&&void 0!=n&&n>0&&t>0})};TC.wrap.control.Geolocation.prototype.positionChangehandler=function(e){const t=this;var r,n,a,o,i;b.call(this)||t.setTracking(!1);return new Promise(function(s,l){if(e&&e.coords){t.parent.layerGPS.clearFeatures();r=e.coords.accuracy/t.parent.map.getMetersPerUnit()||0;n=e.coords.heading||e[2]||0;a=e.coords.speed?3.6*e.coords.speed:0;o=e.coords.altitude||0;i=e.coords.altitudeAccuracy||0;if(t.parent.layerTracking){var p=[e.coords&&e.coords.longitude||e[0],e.coords&&e.coords.latitude||e[1]],c=TC.Util.reproject(p,"EPSG:4326",t.parent.map.crs);t.addPosition(c,n,(new Date).getTime(),a,r,i,o);var u=b.call(t).geometry,f=u.length;f>=2&&(t.parent.deltaMean=(u[f-1][3]-u[0][3])/(f-1));t.parent.trigger(t.parent.Const.Event.POSITIONCHANGE,{pd:{position:c,altitude:o,accuracy:r,heading:TC.Util.radToDeg(n),speed:a}});Promise.all([t.parent.layerGPS.addPoint(c,{radius:4,fillColor:"#00CED1",fillOpacity:1,strokeColor:"#ffffff",strokeWidth:2,showsPopup:!1}),t.parent.layerGPS.addCircle([c,r],{strokeColor:"#00CED1",strokeWidth:.4,fillColor:"#ffffff",fillOpacity:.2,showsPopup:!1})]).then(function(e){const r=e[0],n=e[1];t.parent.geopositionTracking=!0;if(0==t.parent.firstPosition){t.parent.firstPosition=!0;if(!t.parent.trackCenterButton){t.parent.trackCenterButton=t.parent.div.querySelector("."+t.parent.CLASS+"-track-center");t.parent.trackCenterButton.querySelector("button").addEventListener("click",function(){t.parent.layerGPS.map.zoomToFeatures(t.parent.layerGPS.features);t.parent.track.infoPanel.isVisible()||t.parent.track.infoPanel.doVisible();t.parent.track.infoPanel.isMinimized()&&t.parent.track.infoPanel.maximize()});var a=t.parent.map.getControlsByClass("TC.control.ControlContainer")[0];a?t.parent.trackCenterButton=a.addElement({side:a.SIDE.LEFT,htmlElement:t.parent.trackCenterButton}):t.parent.map.div.appendChild(t.parent.trackCenterButton)}t.parent.trackCenterButton.classList.remove(TC.Consts.classes.HIDDEN);t.parent.layerGPS.map.zoomToFeatures(t.parent.layerGPS.features)}s({marker:r,accuracy:n})})}else s(null)}else s(null)})};TC.wrap.control.Geolocation.prototype.setTracking=function(t){var r=this;if(t){r.parent.firstPosition=!1;var n,a=[];if(r.parent.sessionTracking){var o=(new TC.wrap.parser.JSON).parser.readFeatures(r.parent.sessionTracking);o&&r.parent.storageCRS!==r.parent.map.crs&&(o=o.map(function(e){var t=e.clone();t.getGeometry().transform(r.parent.storageCRS,r.parent.map.crs);return t}));var i=o.filter(function(e){var t=e.getGeometry().getType().toLowerCase();"point"===t&&a.push(e);return"linestring"===t||"multilinestring"===t})[0].getGeometry().getCoordinates();n=new e.Feature({geometry:new e.geom.LineString(i,"XYZM"),tracking:!0})}else n=new e.Feature({geometry:new e.geom.LineString([],"XYZM"),tracking:!0});n&&TC.wrap.Feature.createFeature(n).then(function(e){r.parent.layerTracking.addFeature(e);e.geometry.length>1&&r.parent.map.zoomToFeatures(r.parent.layerTracking.features);a.length>0&&Promise.all(a.map(function(e){return TC.wrap.Feature.createFeature(e)})).then(function(e){e&&e.forEach(function(e){r.parent.layerTracking.addFeature(e)})});r.parent.currentPositionWaiting=r.parent.getLoadingIndicator().addWait();r.currentPositionTrk||(r.currentPositionTrk=[]);var t,n=0,o=0,i=!1,s={enableHighAccuracy:!0,timeout:6e5};t=setInterval(function e(a){var l=n++;navigator.geolocation.getCurrentPosition(function(e){clearInterval(t);r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting);r.positionChangehandler(e).then(function(e){1==r.parent.geopositionTracking&&e&&e.marker&&e.accuracy&&r.currentPositionTrk.push(navigator.geolocation.watchPosition(r.positionChangehandler.bind(r),r.parent.onGeolocateError.bind(r.parent),s))})},a||function(n){switch(n.code){case n.TIMEOUT:if(o>10){clearInterval(t);r.parent.onGeolocateError.call(r.parent,n)}else{o++;e(function(){clearInterval(t);if(!i){i=!0;r.parent.onGeolocateError.call(r.parent,n)}})}break;default:clearInterval(t);r.parent.onGeolocateError.call(r.parent,n)}},{timeout:5e3+l,maximumAge:10,enableHighAccuracy:!0})},1e3);setTimeout(function(){if(r.parent.layerTracking&&r.parent.layerTracking.features&&r.parent.layerTracking.features.length>0&&0==r.parent.layerTracking.features[0].geometry.length){clearInterval(t);r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting);r.map.toast(r.parent.getLocaleString("geo.error.permission_denied"),{type:TC.Consts.msgType.WARNING});r.parent.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);r.parent.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN)}},s.timeout+1e3)})}else{r.parent.firstPosition=!1;if(r.currentPositionTrk){r.currentPositionTrk=r.currentPositionTrk instanceof Array?r.currentPositionTrk:[r.currentPositionTrk];r.currentPositionTrk.forEach(function(e){navigator.geolocation.clearWatch(e)});r.currentPositionTrk=[]}r.parent.trackCenterButton&&r.parent.trackCenterButton.classList.add(TC.Consts.classes.HIDDEN)}};TC.wrap.control.Geolocation.prototype.activateSnapping=function(){if(!TC.Util.detectMobile()){this.olMap.on([e.MapBrowserEventType.POINTERMOVE,e.MapBrowserEventType.SINGLECLICK],this._snapTrigger);this.olMap.on(e.render.EventType.POSTCOMPOSE,this._postcomposeTrigger)}};TC.wrap.control.Geolocation.prototype.deactivateSnapping=function(){var t=this;t.parent.map.wrap.getMap().then(function(r){if(!TC.Util.detectMobile()){r.un([e.MapBrowserEventType.POINTERMOVE,e.MapBrowserEventType.SINGLECLICK],t._snapTrigger);r.un(e.render.EventType.POSTCOMPOSE,t._postcomposeTrigger)}t.snapInfo&&r.removeOverlay(t.snapInfo);t.snapInfoElement&&(t.snapInfoElement.style.display="none");if(t.snapLine){delete t.snapLine;r.render()}})};TC.wrap.control.Geolocation.prototype.clear=function(e){e&&e.clearFeatures();attachedDTD=!1;this.deactivateSnapping.call(this)};TC.wrap.control.Geolocation.prototype.duringTrackSnap=function(t){var r=t.vectorContext;if(r&&this.snapLine){"function"==typeof r.setFillStrokeStyle&&r.setFillStrokeStyle(null,new e.style.Stroke({color:"rgba(197, 39, 55, 1)",width:1}));"function"==typeof r.drawGeometry&&r.drawGeometry(this.snapLine.wrap.feature.getGeometry())}};TC.wrap.control.Geolocation.prototype.endSnap=function(){var e=this;e.parent.map.wrap.getMap().then(function(t){e.snapInfo&&t.removeOverlay(e.snapInfo);e.snapInfoElement&&(e.snapInfoElement.style.display="none");e.snapLine&&delete e.snapLine})};TC.wrap.control.Geolocation.prototype.initSnap=function(t,r){var n=this;if(n.parent.layerTrack){var a=n.parent.layerTrack.wrap.layer.getSource().getClosestFeatureToCoordinate(t);if(null!==a){var o=a.getGeometry().getClosestPoint(t);const u=n.parent.map.getPixelFromCoordinate(o);if(Math.sqrt(Math.pow(r[0]-u[0],2)+Math.pow(r[1]-u[1],2))>n.parent.snappingTolerance)n.endSnap();else{var i=[t,[o[0],o[1]]];n.snapLine?n.snapLine.wrap.feature.getGeometry().setCoordinates(i):n.snapLine=new TC.feature.Polyline(i);n.snapInfoElement||(n.snapInfoElement=document.getElementsByClassName("tc-ctl-geolocation-track-snap-info")[0]);n.snapInfoElement.style.display="block";if(!n.snapInfo){n.snapInfo=new e.Overlay({element:n.snapInfoElement,offset:[5,18]});n.olMap.addOverlay(n.snapInfo)}void 0==n.snapInfo.getMap()&&n.snapInfo.setMap(n.olMap);n.snapInfo.setPosition(t);var s={};"LineString"!=a.getGeometry().getType()&&a.getKeys().indexOf("name")>-1&&(s.n=a.get("name"));var l=n.parent.map.options.locale&&n.parent.map.options.locale.replace("_","-")||void 0;s.x=n.map.wrap.isGeo()?o[0].toLocaleString(l,{minimumFractionDigits:5}):Math.round(o[0]).toLocaleString(l);s.y=n.map.wrap.isGeo()?o[1].toLocaleString(l,{minimumFractionDigits:5}):Math.round(o[1]).toLocaleString(l);n.map.wrap.isGeo()&&(s.isGeo=!0);var p=function(e){return o[e]?(Math.round(100*o[e])/100).toLocaleString(l):void 0},c=function(e){return o[e]>0?new Date(o[e]).toLocaleString(l):void 0};if(a.getGeometry().getLayout()===e.geom.GeometryLayout.XYZM){s.z=p(2);s.m=c(3)}else a.getGeometry().getLayout()===e.geom.GeometryLayout.XYZ?s.z=p(2):a.getGeometry().getLayout()===e.geom.GeometryLayout.XYM&&(s.m=c(2));s&&n.parent.getRenderedHtml(n.parent.CLASS+"-track-snapping-node",s,function(e){n.snapInfoElement.innerHTML=e})}}}n.olMap.render()};TC.wrap.control.Geolocation.prototype.drawTrackingData=function(e){const t=this;return new Promise(function(r,n){const a=[],o=(new TC.wrap.parser.JSON).parser.readFeatures(e.data);o.filter(function(e){return"linestring"===e.getGeometry().getType().toLowerCase()||"multilinestring"===e.getGeometry().getType().toLowerCase()}).forEach(function(t){t.getGeometry().setCoordinates(t.getGeometry().getCoordinates(),e.layout)});t.activateSnapping.call(t);for(var i=0,s=o.length;i<s;i++)a.push(TC.wrap.Feature.createFeature(o[i]));Promise.all(a).then(function(e){e.forEach(function(e){e&&t.parent.layerTrack.addFeature(e)});t.parent.map.zoomToFeatures(t.parent.layerTrack.features);r()})})};TC.wrap.control.Geolocation.prototype.formattedFromStorage=function(t){const r=this;if(r.parent.storageCRS!==r.parent.map.crs){var n=(new e.format.GeoJSON).readFeatures(t);if(n){n=n.map(function(e){var t=e.clone();t.getGeometry().transform(r.parent.storageCRS,r.parent.map.crs);return t});return(new e.format.GeoJSON).writeFeatures(n)}}return t};TC.wrap.control.Geolocation.prototype.formattedToStorage=function(t,r,n){var a=this,o=new TC.wrap.parser.JSON;o=o.parser;var i,s=t.wrap.layer.getSource().getFeatures();s=s.map(function(t){t.getGeometry()instanceof e.geom.LineString&&(i=t.getGeometry().getLayout());r&&t.getProperties().tracking&&t.unset("tracking");if(!n&&a.parent.map.crs!==a.parent.storageCRS){var o=t.clone();o.getGeometry().transform(a.parent.map.crs,a.parent.storageCRS);return o}return t}).sort(function(t,r){return t.getGeometry()instanceof e.geom.Point&&!(r.getGeometry()instanceof e.geom.Point)?-1:r.getGeometry()instanceof e.geom.Point&&!(t.getGeometry()instanceof e.geom.Point)?2:t.getProperties().name<r.getProperties().name?-1:t.getProperties().name>r.getProperties().name?1:0});return{features:o.writeFeatures(s),layout:i}};TC.wrap.control.Geolocation.prototype.export=function(t,r){const n=this;return new Promise(function(a,o){var i=[];n.parent.getTrackingData(r).then(function(o){if(o){var s=(new e.format.GeoJSON).readFeatures(o.data);if(0===s.length){var l=n.parent.getTrackingData(r);s=(new e.format.GeoJSON).readFeatures(l)}i=s.map(function(t){var r=t.clone();r.getGeometry().transform(n.parent.map.crs,"EPSG:4326");return r.getGeometry()instanceof e.geom.LineString?new e.Feature({geometry:new e.geom.MultiLineString([r.getGeometry().getCoordinates()],"XYZM")}):r})}switch(t){case"GPX":a(i?(new e.format.GPX).writeFeatures(i):null);break;case"KML":a(i?(new e.format.KML).writeFeatures(i):null)}})})};var k,D,U=function(e){var t=[],r=[];if(e.length>1){4==e[0].length&&(e=e.sort(function(e,t){return e[0][3]==t[0][3]?0:e[0][3]<t[0][3]?-1:1}));for(var n=0;n<e.length;n++){for(var a=e[n],o=-1,i=1/0,s=a.getLastCoordinate(),l=n+1;l<e.length;l++){var p=e[l].getFirstCoordinate(),c=Math.hypot(s[0]-p[0],s[1]-p[1]);if(c<i){o=l;i=c}}if(t.length<e.length){if(-1==t.indexOf(n)){t.push(n);r=r.concat(a.getCoordinates())}if(-1==t.indexOf(o)){t.push(o);r=r.concat(e[o].getCoordinates())}}}return r}return e[0].getCoordinates()};TC.wrap.control.Geolocation.prototype.processImportedFeatures=function(t){for(var r=this,n=r.parent.layerTrack.wrap.layer.getSource(),a=r.parent.importedFileName,o=[],i=[],s=[],l=[],p=n.getFeatures(),c=[],u=[],f=function(e){e.getProperties().hasOwnProperty("name")&&e.getProperties().name.trim().length>0?o.push(e.getProperties().name):o.push(a)},g=0;g<p.length;g++){var m=p[g];m instanceof TC.Feature&&(m=p[g].wrap.feature);if(m.getGeometry()instanceof e.geom.Point){u.push(m.getGeometry().getCoordinates());l.push(m)}else if(m.getGeometry()instanceof e.geom.LineString){f(m);i.push(new e.Feature({geometry:new e.geom.LineString(m.getGeometry().getCoordinates(),m.getGeometry().getLayout())}));s.push(m)}else if(m.getGeometry()instanceof e.geom.MultiLineString){var y=m.clone();f(y);var d=y.getGeometry().getLineStrings(),h=U(d);i.push(new e.Feature({geometry:new e.geom.LineString(h,m.getGeometry().getLayout())}));s.push(m)}}if(c.length>0){h=U(c);i.push(new e.Feature({geometry:new e.geom.LineString(h)}))}u.length>0&&l.length==p.length&&i.push(new e.Feature({geometry:new e.geom.LineString(u)}));if(s.length>0)for(var C=0;C<s.length;C++)n.removeFeature(s[C]);if(i.length>0){var T,v=0;(function(){const e=i.map(function(e,s){return new Promise(function(e,l){T&&n.removeFeature(T);if(o.length>s){var p=o[s];(function(e,t){for(var r=[],n=e.indexOf(t);-1!=n;){r.push(n);n=e.indexOf(t,n+1);if(r.length>1)return!0}return r.length>1})(o,p)&&(p="["+(s+1)+"] "+p)}r.parent.importedFileName=p||a;T=i[s];n.addFeature(T);r.parent.saveTrack({message:r.parent.getLocaleString("geo.trk.upload.ok",{trackName:p||a}),importedFileName:p||a,notReproject:t.notReproject}).then(function(t){0==s&&(v=t);e()})})});return Promise.all(e)})().then(function(){r.parent.layerTrack.setVisibility(!1);r.parent.layerTrack.clearFeatures();r.parent.trigger(r.parent.Const.Event.IMPORTEDTRACK,{index:v});delete r.parent.importedFileName;r.parent.getLoadingIndicator().removeWait(t.wait)})}else{if(r.parent.layerTrack){r.parent.map.removeLayer(r.parent.layerTrack);r.parent.layerTrack=void 0}delete r.parent.importedFileName;r.parent.getLoadingIndicator().removeWait(t.wait);TC.alert(r.parent.getLocaleString("geo.trk.upload.error4"))}};TC.wrap.control.Geolocation.prototype.import=function(t,r,n){var a,o,i=this;if(r&&r.text){var s=i.parent.layerTrack.wrap.createVectorSource({data:r.text,type:n});a=s.source;o=a.on("change",function(r){if("ready"==a.getState()){e.Observable.unByKey(o);i.processImportedFeatures(t)}});i.parent.layerTrack.wrap.layer.setSource(a)}else{if(i.parent.layerTrack){i.parent.map.removeLayer(i.parent.layerTrack);i.parent.layerTrack=void 0}delete i.parent.importedFileName;i.parent.getLoadingIndicator().removeWait(t);TC.alert(i.parent.getLocaleString("geo.trk.upload.error4"))}};TC.wrap.control.Geolocation.prototype.simulateTrackEnd=function(){this.parent.chartProgressClear();if(this.simulateMarker){window.cancelAnimationFrame(k);this.simulateMarker.layer.wrap.layer.getSource().getFeatures().length>0&&this.simulateMarker.layer.removeFeature(this.simulateMarker);delete this.simulateMarker}};TC.wrap.control.Geolocation.prototype.simulateTrack=function(){for(var t,r=this,n=r.parent.layerTrack.wrap.layer.getSource().getFeatures(),a=0;a<n.length;a++)if(n[a].getGeometry()instanceof e.geom.LineString){t=n[a].getGeometry().getCoordinates();break}if(t&&t.length>0){var o=t[0];new Promise(function(e,t){if(r.simulateMarker){r.simulateMarker.setCoords(o.slice(0,2));e(r.simulateMarker)}else r.parent.layerTrack.addPoint(o.slice(0,2),{radius:7,fillColor:"#ff0000",fillOpacity:.5,strokeColor:"#ffffff",strokeWidth:2}).then(function(t){e(t)})}).then(function(n){r.simulateMarker=n;var a=function(){t.length;var n,a=!1;const o=function(e){return r.parent.map.crs!==r.parent.map.options.utmCrs?TC.Util.reproject(e,r.parent.map.crs,r.parent.map.options.utmCrs):e};var i=t;if(4==i[0].length&&i[0][3]>0){n=i[0][3];i[i.length-1][3];a=!0}else{i[0][3]=Date.now();for(var s=1;s<i.length;s++){i[s][3]=0;u=s+1<i.length?new e.geom.LineString(o(i.slice(s-1,s+1))).getLength():new e.geom.LineString(o(i.slice(s-1))).getLength();i[s][3]=i[s-1][3]+36e5*u/r.parent.walkingSpeed}n=i[0][3];i[i.length-1][3]}var l=new e.geom.LineString(i),p=n,c=0;c=r.parent.map.crs!==r.parent.map.options.utmCrs?new e.geom.LineString(o(JSON.parse(JSON.stringify(i)))).getLength():l.getLength();var u=0,f=function(){if(!r.parent.simulate_paused){var t=l.getCoordinateAtM(p),n=function(t){for(var r=0;r<i.length;r++)if(i[r][3]>t)return{d:new e.geom.LineString(o(i.slice(0,r))).getLength(),p:i[r-1].slice(0,2)}}(p);if(!t||!n){r.simulateTrackEnd();var s=r.parent.getSelectedTrack();s&&r.parent.uiSimulate(!1,s);r.parent.hasElevation&&r.parent.chartProgressClear();return}r.parent.hasElevation&&r.parent.chartSetProgress(n,t,c,!!a&&r.parent._getTime(i[0][3],t[3]));if(r.simulateMarker){var u=r.simulateMarker.getCoords(),g=t;Math.atan2(g[1]-u[1],g[0]-u[0]),Math.PI;r.simulateMarker.setCoords(t)}1!==r.parent.simulate_speed?p+=r.parent.delta*r.parent.simulate_speed:p+=r.parent.delta}k=requestAnimationFrame(f)};k=requestAnimationFrame(f)};new Promise(function(e,t){window.d3?e():TC.loadJS(!window.d3,[TC.Consts.url.D3C3],function(){e()})}).then(function(){k=requestAnimationFrame(a)})})}};TC.wrap.control.Geolocation.prototype.headingChangehandler=function(e){var t=this;if(!t.parent.track.infoOnMap){t.parent.track.infoOnMap=document.createElement("div");const e=t.parent.track.infoOnMap.style;e.overFlowY="scroll";e.height="200px";e.width="200px";e.top="0";e.left="100px";e.backgroundColor="fuchsia";e.position="absolute";t.parent.map.div.appendChild(t.parent.track.infoOnMap)}t.parent.track.infoOnMap.style.display="";t.heading=e.target.getHeading();t.parent.track.infoOnMap.innerHTML=t.parent.track.infoOnMap.innerHTML+"<br> <p> salta headingChangehandler </p> <br> <p> evt.target.getHeading(): "+t.heading+" </p>";t.map.wrap.getMap().then(function(e){e.getView().setRotation(-t.heading)});t.parent.trigger(t.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0})};TC.wrap.control.Geolocation.prototype.orientationChangehandler=function(e){var t=this.map.wrap.map.getView(),r=t.getCenter(),n=t.getResolution(),a=e.target.getBeta()||0,o=e.target.getGamma()||0;r[0]-=n*o*25;r[1]+=n*a*25;t.setCenter(t.constrainCenter(r));this.parent.trigger(this.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0})};TC.wrap.control.Geolocation.prototype.pulsate=function(t){this.pulsated=!0;var r,n=t.wrap.feature.getGeometry().getRadius(),a=(new Date).getTime();r=this.olMap.on(e.render.EventType.POSTCOMPOSE,function(o){var i=o.vectorContext,s=o.frameState,l=s.time-a,p=t.wrap.feature.getGeometry().clone(),c=function(e){switch(!0){case e<=50:return n;case e>50&&e<=100:return 1.02*n;case e>100&&e<=150:return 1.05*n;case e>150&&e<=200:return 1.02*n;case e>200&&e<=300:return n;case e>300&&e<=350:return 1.02*n;case e>350&&e<=400:return 1.05*n;case e>400&&e<=450:return 1.02*n;case e>450&&e<=500:return 1*n;default:return n}}(l);p.setRadius(c);i.setFillStrokeStyle(new e.style.Fill({color:"rgba(0, 0, 0, 0.1)"}),new e.style.Stroke({color:"rgba(255, 0, 0, .8)",width:1}));i.drawCircleGeometry(p);l>500?e.Observable.unByKey(r):s.animate=!0})};TC.wrap.control.ResultsPanel.prototype.register=function(e){const t=this;t.map=e;e.wrap.getMap().then(function(e){t.olMap=e})};TC.wrap.control.ResultsPanel.prototype.showElevationMarker=function(t){const r=this,n=(t=t||{}).data,a=t.layer,o=t.coords;if(!r.elevationMarker){const t=document.createElement("div");t.style.display="none";t.classList.add("tc-ctl-geolocation-trackMarker");t.classList.add("elevation");r.elevationMarker=new e.Overlay({element:t,offset:[0,-11],positioning:e.OverlayPositioning.CENTER_CENTER,stopEvent:!1})}if(a.getVisibility()&&a.getOpacity()>0){r.elevationMarker.getElement().style.display="";r.olMap.addOverlay(r.elevationMarker);r.elevationMarker.setPosition(o[n[0].index])}};TC.wrap.control.ResultsPanel.prototype.hideElevationMarker=function(){this.elevationMarker&&(this.elevationMarker.getElement().style.display="none")};TC.wrap.control.Coordinates.prototype.coordsActivate=function(){this.olMap.on(e.MapBrowserEventType.SINGLECLICK,this._coordsTrigger)};TC.wrap.control.Coordinates.prototype.coordsDeactivate=function(){this.olMap.un(e.MapBrowserEventType.SINGLECLICK,this._coordsTrigger)};TC.wrap.Parser=function(){};TC.wrap.Parser.prototype.read=function(e){var t=[];if(this.parser){TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");t=$.map(this.parser.readFeatures(e),function(e){return new TC.Feature(null,{id:e.getId(),data:e.getProperties()})})}return t};TC.wrap.parser={WFS:function(t){this.parser=new e.format.WFS(t)},JSON:function(t){this.parser=new e.format.GeoJSON(t)}};TC.inherit(TC.wrap.parser.WFS,TC.wrap.Parser);TC.inherit(TC.wrap.parser.JSON,TC.wrap.Parser);TC.wrap.control.OverviewMap.prototype.register=function(t){var r=this;r.parent.layer.wrap.getLayer().then(function(n){r.ovMap=new e.control.OverviewMap({target:r.parent.div,collapsed:!1,collapsible:!1,className:r.parent.CLASS+" ol-overviewmap",layers:[n]});r.ovMap._wrap=r;r.ovMap.getOverviewMap().pixelRatio_=1;r.ovMap.ovmap_.removeOverlay(r.ovMap.boxOverlay_);var a=document.createElement("DIV");a.className="ol-overviewmap-box";a.style.boxSizing="border-box";r.ovMap.boxOverlay_=new e.Overlay({position:[0,0],positioning:e.OverlayPositioning.BOTTOM_LEFT,element:a});r.ovMap.ovmap_.addOverlay(r.ovMap.boxOverlay_);r.manageSize.call(r.ovMap.ovmap_);r._boxElm=r.ovMap.boxOverlay_.getElement();TC.loadJS(!window.Draggabilly,[TC.apiLocation+"lib/draggabilly/draggabilly.pkgd.min.js"],function(){var e=r.ovMap.ovmap_;const n=new Draggabilly(r._boxElm);n.positionDrag=function(){const e=this.element.style,t="translate3d( "+this.dragPoint.x+"px, "+this.dragPoint.y+"px, 0)";if(e.transform.length){const r=e.transform.indexOf("translate3d");if(r>=0){const n=e.transform.indexOf(")",r);e.transform=e.transform.replace(e.transform.substring(r,n+1),t)}else e.transform=t+" "+e.transform}else e.transform=t};n.on("pointerDown",function(a){n.dragged=r._boxElm.cloneNode();n.dragged.classList.add(TC.Consts.classes.ACTIVE);n.dragged.style.position="absolute";r._boxElm.insertAdjacentElement("beforebegin",n.dragged);if(t.maxExtent){var o=e.getPixelFromCoordinate([t.maxExtent[0],t.maxExtent[1]]),i=e.getPixelFromCoordinate([t.maxExtent[2],t.maxExtent[3]]),s=e.getSize();const r=document.createElement("div");r.style.position="absolute";r.style.bottom=Math.round(s[1]-o[1])+"px";r.style.left=Math.round(o[0])+"px";r.style.top=Math.round(i[1])+"px";r.style.right=Math.round(s[0]-i[0])+"px";const a=e.getViewport();a.insertBefore(r,a.firstElementChild);n.options.containment=r}});n.on("pointerUp",function(r){n.dragged.parentElement.removeChild(n.dragged);if(t.maxExtent){e.getViewport().removeChild(n.options.containment);n.options.containment=null}});n.on("dragMove",function(e,t,r){n._delta=r});n.on("dragEnd",function(a,o){var i=r.ovMap.getMap().getView(),s=e.getPixelFromCoordinate(i.getCenter()),l=e.getCoordinateFromPixel([s[0]+n._delta.x,s[1]+n._delta.y]),p=t.getExtent(),c=(p[2]-p[0])/2,u=(p[3]-p[1])/2;l[0]+c>t.maxExtent[2]?l[0]=t.maxExtent[2]-c:l[0]-c<t.maxExtent[0]&&(l[0]=t.maxExtent[0]+c);l[1]+u>t.maxExtent[3]?l[1]=t.maxExtent[3]-u:l[1]-u<t.maxExtent[1]&&(l[1]=t.maxExtent[1]+u);n.setPosition(0,0);delete n._delta;t.setCenter(l,{animate:!0})})});t.wrap.getMap().then(function(e){r.reset();const t=r.parent.div.querySelector("."+r.parent.CLASS+"-load");n._wrap.$events.on(TC.Consts.event.BEFORETILELOAD,function(){t.classList.remove(TC.Consts.classes.HIDDEN);t.classList.add(TC.Consts.classes.VISIBLE)});n._wrap.$events.on(TC.Consts.event.TILELOAD,function(){t.classList.remove(TC.Consts.classes.VISIBLE);t.classList.add(TC.Consts.classes.HIDDEN)});e.addControl(r.ovMap);r.parent.isLoaded=!0;r.parent.trigger(TC.Consts.event.MAPLOAD)})})};TC.wrap.control.OverviewMap.prototype.reset=function(t){const r=this;return new Promise(function(n,a){const o=function(t,a){if(t.type===TC.Consts.layerType.WMTS){var o={crs:a||r.parent.map.crs,oldCrs:t.wrap.layer.getSource().getProjection().getCode()};o.oldCrs!==o.crs&&t.setProjection(o)}t.wrap.getLayer().then(function(a){var o=new e.View(C(r.parent.map.wrap,a._wrap.parent));if(o.getResolutions()){o.setResolution(o.getResolutions().filter(function(e){return e>o.getResolutionForExtent(r.parent.map.getExtent(),s.getSize())}).reverse()[0]);s.setView(o)}else o.getProjection().getCode()!==s.getView().getProjection().getCode()&&s.setView(o);a._wrap.$events.one(TC.Consts.event.TILELOAD,function(){s.getLayers().getArray()[0].getSource().refresh()});if(t!==r.parent.layer||-1===s.getLayers().getArray().indexOf(t)){r.parent.map.trigger(TC.Consts.event.OVERVIEWBASELAYERCHANGE,{oldLayer:t!==r.parent.layer?r.parent.layer:null,newLayer:t});s.getLayers().forEach(function(t){(t instanceof e.layer.Image||t instanceof e.layer.Tile)&&s.removeLayer(t)});const n=r.parent.div.querySelector("."+r.parent.CLASS+"-load");a._wrap.$events.on(TC.Consts.event.BEFORETILELOAD,function(){n.classList.remove(TC.Consts.classes.HIDDEN);n.classList.add(TC.Consts.classes.VISIBLE)});a._wrap.$events.on(TC.Consts.event.TILELOAD,function(){n.classList.remove(TC.Consts.classes.VISIBLE);n.classList.add(TC.Consts.classes.HIDDEN)});s.getLayers().insertAt(0,a)}n(t)})};var i=(t=t||{}).layer||r.parent.layer;if(r.parent.map&&i&&r.ovMap){var s=r.ovMap.ovmap_;i.getCapabilitiesPromise().then(function(){var e=i;i.isCompatible(r.parent.map.crs)||0!==i.wrap.getCompatibleMatrixSets(r.parent.map.crs).length?o(i):(i=i.getFallbackLayer()||r.parent.defaultLayer).getCapabilitiesPromise().then(function(){r.parent.map.on3DView&&!i.isCompatible(r.parent.map.crs)?r.parent.map.loadProjections({crsList:e.getCompatibleCRS(),orderBy:"name"}).then(function(t){o(e,t[0].code)}):i.isCompatible(r.parent.map.crs)&&o(i)})})}})};TC.wrap.control.OverviewMap.prototype.get3DCameraLayer=function(){var t=null;if(this.ovMap){(r=this.ovMap.getOverviewMap()).getLayers().forEach(function(e){"3DCamera"===e.get("id")&&(t=e)});if(!t){var r=this.ovMap.getOverviewMap(),n=A({});n[0].getFill().setColor([0,0,0,0]);t=new e.layer.Vector({id:"3DCamera",source:new e.source.Vector,style:n});r.addLayer(t)}}return t};TC.wrap.control.OverviewMap.prototype.draw3DCamera=function(t){if(this.parent.map.isLoaded){this.is3D=!!t;var r=this.get3DCameraLayer();if(r){var n,a=(t=t||{}).fov,o=r.getSource();if(a&&a.length){var i=o.getFeatures();if(i.length)n=i[0];else{n=new e.Feature;o.addFeature(n)}n.setGeometry(new e.geom.Polygon([a]))}else o.clear();var s="number"==typeof t.heading?t.heading:0;this._boxElm.style.transform="rotate("+s+"rad)"}}};TC.wrap.control.OverviewMap.prototype.enable=function(){if(this.parent.layer&&this.parent.layer.setVisibility){this.parent.layer.setVisibility(!0);this.parent.wrap.ovMap.ovmap_.updateSize();const e=document.createEvent("HTMLEvents");e.initEvent("resize",!1,!1);this.parent.map.div.dispatchEvent(e)}};TC.wrap.control.OverviewMap.prototype.disable=function(){this.parent.layer&&this.parent.layer.setVisibility&&this.parent.layer.setVisibility(!1)};TC.wrap.control.OverviewMap.prototype.manageSize=function(){TC.wrap.Map.prototype.manageSize.call(this)};TC.wrap.control.FeatureInfo.prototype.register=function(e){var t=this;e.wrap.getMap().then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);var n=t._trigger;t._trigger=function(r){var a=n.call(t,r);a?t.parent.beforeRequest({xy:r.pixel}):e.trigger(TC.Consts.event.NOFEATUREINFO,{control:t.parent});return a}})};var V=function(e){var t=e.innerHTML||e.textContent;(D=D||document.createElement("textarea")).innerHTML=t;return D.value},B={readFeatures:function(t){var r=[],n=(new DOMParser).parseFromString(t,"text/xml");if("FeatureInfoResponse"===n.documentElement.tagName)for(var a=n.documentElement.getElementsByTagName("FeatureInfoCollection"),o=0,i=a.length;o<i;o++)for(var s=a[o],l=s.getAttribute("layername"),p=s.getElementsByTagName("FeatureInfo"),c=0,u=p.length;c<u;c++){for(var f=p[c].getElementsByTagName("Field"),g={},m=0,y=f.length;m<y;m++){var d=f[m];g[V(d.getElementsByTagName("FieldName")[0])]=V(d.getElementsByTagName("FieldValue")[0])}var h=new e.Feature(g);h.setId(l+"."+TC.getUID());r[r.length]=h}return r}},j=function(e,t,r){var n=t.getPath(r);e.layers.push({name:r,title:n[n.length-1],path:n.slice(1),features:[]})};TC.wrap.control.FeatureInfo.prototype.getFeatureInfo=function(t,r,n){var a=this,o=n||{},i=a.parent.map;i.wrap.getMap().then(function(n){var s={},l={};const p=[],c=[];var u=[],f=[];v=(v=n.getLayers().getArray()).filter(function(t){return t instanceof e.layer.Image&&t.getVisible()});for(var g=0;g<v.length;g++){var m=v[g],y=m._wrap.parent;if((w=m.getSource()).getGetFeatureInfoUrl&&$.inArray(y,i.workLayers)>=0&&y.names.length>0&&(!o.serviceUrl||o.serviceUrl===y.url)){if(s[y.url]){S=s[y.url];l[y.url].source.updateParams(e.obj.assign(l[y.url].source.getParams(),w.getParams()))}else{S={layers:[],mapLayers:[],title:y.title,request:null};s[y.url]=S;l[y.url]={source:jQuery.extend(!0,{},w),layers:[]}}S.mapLayers.push(y);var d=y.getDisgregatedLayerNames();if(o.layerName){if(d.indexOf(o.layerName)>=0&&m._wrap.getInfo(o.layerName).queryable){j(S,y,o.layerName);l[y.url].layers.push(o.layerName)}}else{for(var h=0;h<d.length;h++){var C=d[h];if(m._wrap.getInfo(C).queryable)j(S,y,C);else{TC.Util.consoleRegister('Capa "'+d[h]+'" no queryable, la eliminamos de la petici\xf3n GFI');d.splice(h,1);h-=1}}d.length>0&&(l[y.url].layers=l[y.url].layers.concat(d))}}}for(var T in s){f.push(s[T]);var v,S=s[T],w=l[T].source;if(!(v=l[T].layers)||v&&0===v.length)continue;var E=w.getParams();w.params_.LAYERS=v.join(",");var L=w.getGetFeatureInfoUrl(t,r,i.crs,{QUERY_LAYERS:v.join(","),INFO_FORMAT:E.INFO_FORMAT,FEATURE_COUNT:1e3,radius:i.options.pixelTolerance,buffer:i.options.pixelTolerance}),P=L=L.replace(/sld_body=[a-zA-Z%0-9._]*/);const e={serviceUrl:T,requestedFormat:E.INFO_FORMAT,expandUrl:P};c.push(e);p.push(new Promise(function(t,r){const n=S.mapLayers[0];n.toolProxification.fetch(L).then(function(r){n.toolProxification.cacheHost.getAction(e.expandUrl).then(function(a){e.originalUrl=a.action.call(n.toolProxification,e.expandUrl);t($.extend({},r,e))})}).catch(function(e){r(Error(e))})}));TC.Util.consoleRegister("Lanzamos GFI")}if(p.length>0)Promise.all(p).then(function(n){for(var l=!1,p=0,f=[],g=0;g<n.length;g++){var m,y=n[g],d=s[c[g].serviceUrl];l=!0;d.text=y.responseText;var h=y.contentType;h&&h.indexOf(";")>-1&&(h=h.substr(0,h.indexOf(";")).trim());h||(h=y.requestedFormat);if(h===y.requestedFormat){switch(h){case"application/json":m=new e.format.GeoJSON;break;case"application/vnd.ogc.gml":m=y.responseText.indexOf("FeatureCollection")>-1?new e.format.WFS({gmlFormat:new e.format.GML2({srsName:i.crs})}):new e.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":m=new e.format.GML3Patched({srsName:i.crs});break;case"application/vnd.esri.wms_featureinfo_xml":m=B;break;default:m=null}if(m){var C=m.readFeatures(y.responseText,{featureProjection:e.proj.get(i.crs)});p+=C.length;for(var T=function(e,t,r){var n=!1;if(t===r)n=!0;else{var a=e.getNodePath(t),o=e.getNodePath(r);if(a.length>0&&o.length>=a.length){n=!0;for(var i=0;i<a.length;i++)if(e.wrap.getName(a[i])!==e.wrap.getName(o[i])){n=!1;break}}}return n},v={},S=0;S<C.length;S++){var w=C[S];if(w instanceof e.Feature){for(var E=w.getId()||TC.getUID(),L=!1,P=E.substr(0,E.lastIndexOf(".")),M=0;M<d.layers.length;M++){var R=d.layers[M],_=R.name.substr(R.name.indexOf(":")+1);if(d.mapLayers.some(function(e){return T(e,_,P)})){L=!0;if(!o.featureId||w.getId()===o.featureId){u.push(TC.wrap.Feature.createFeature(w,{showsPopup:!1}));f.push(R.features)}break}}if(!L){var x;if(v[P])x=v[P];else{x={name:P,title:P,path:[P],features:[]};v[P]=x;d.layers.push(x)}if(!o.featureId||w.getId()===o.featureId){u.push(TC.wrap.Feature.createFeature(w,{showsPopup:!1}));f.push(x.features)}}}}}else{var A={name:"layer"+TC.getUID(),title:"Datos en el punto",features:[]};d.layers[d.layers.length]=A;A.features[0]={rawUrl:y.originalUrl,expandUrl:y.expandUrl,rawContent:y.responseText,rawFormat:h};p+=1}}else{TC.Util.consoleRegister("Respuesta GFI: lo m\xe1s probable es que el servidor est\xe9 devolviendo una excepci\xf3n");TC.Util.consoleRegister("Lanzamos los eventos que corresponde y mostramos tostada");a.parent.responseError({message:y.responseText,status:y.status});i.toast(a.parent.getLocaleString("featureInfo.error"),{type:TC.Consts.msgType.ERROR})}}if(l){var I=u;u.length&&(I=I.concat(new Promise(function(e,t){TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry",function(){e()})})));Promise.all(I).then(function(e){var n;e.forEach(function(e,r){if(e){e.attributes=[];for(var o in e.data){var i=e.data[o];"object"!=typeof i&&e.attributes.push({name:o,value:"number"==typeof i?i.toLocaleString(TC.Util.getMapLocale(a.parent.map)):i})}!n&&TC.Geometry.isInside(t,e.geometry)&&(n=e);f[r].push(e)}});var o=[];for(var i in s)s.hasOwnProperty(i)&&o.push(s[i]);a.parent.responseCallback({coords:t,resolution:r,services:o,featureCount:p,defaultFeature:n})})}},function(e,n,o){if(f&&0==f.length)for(var l in s)f.push(s[l]);a.parent.responseCallback({coords:t,resolution:r,services:f,featureCount:0});i.toast(a.parent.getLocaleString("featureInfo.error"),{type:TC.Consts.msgType.ERROR})});else{i.workLayers.filter(function(e){return e instanceof TC.layer.Raster}).length>0&&i.toast(a.parent.getLocaleString("featureInfo.notQueryableLayers"),{type:TC.Consts.msgType.INFO});if(f&&0==f.length)for(var T in s)f.push(s[T]);i.on(TC.Consts.event.BEFOREFEATUREINFO,function(){a.parent.responseCallback({coords:t,resolution:r,services:f,featureCount:0})});a.parent.responseCallback({coords:t,resolution:r,services:f,featureCount:0})}})};TC.wrap.control.GeometryFeatureInfo.prototype.register=function(t){var r=this;t.wrap.getMap().then(function(n){TC.wrap.control.Click.prototype.register.call(r,t);var a=r._trigger;r._trigger=function(t){r.hasEligibleLayers().then(function(n){n&&(r.parent._isSearching||t.type!=e.MapBrowserEventType.SINGLECLICK||r.parent._isDrawing||r.parent._isSearching||a.call(r,t))})}})};TC.wrap.control.GeometryFeatureInfo.prototype.hasEligibleLayers=function(){const e=this;return new Promise(function(t,r){const n=e.parent.map;var a=!1;n.wrap.getMap().then(function(e){e.getLayers().forEach(function(e){var t=e._wrap.parent;if(e.getSource().getGetFeatureInfoUrl&&$.inArray(t,n.workLayers)>=0){a=!0;return!1}});t(a)})})};TC.wrap.control.GeometryFeatureInfo.prototype.beginDraw=function(t){var r=this,n=(t=t||{}).xy,a=t.layer,o=t.callback,i=t.geometryType,s=!1;if(r.drawCtrl){r.drawCtrl.setActive(!0);r.drawCtrl.startDrawing_({coordinate:n})}else a.wrap.getLayer().then(function(t){var a;switch(i){case TC.Consts.geom.POLYLINE:a=e.geom.GeometryType.LINE_STRING;break;default:a=e.geom.GeometryType.POLYGON}r.drawCtrl=new e.interaction.Draw({source:t.getSource(),type:a,style:t.getStyle()});var l=function(e){e.parent.showsPopup=!1};t.getSource().on(e.source.VectorEventType.ADDFEATURE,function(e){e.feature._wrap?l(e.feature._wrap):e.feature._wrapPromise.then(l)});r.drawCtrl.handleEvent=function(t){if(t.type==e.MapBrowserEventType.SINGLECLICK){var r=a===e.geom.GeometryType.POLYGON?this.sketchCoords_[0]:this.sketchCoords_;s&&2==r.length&&null!==this.sketchFeature_?this.addToDrawing_(t):s=!0}return e.interaction.Draw.handleEvent.call(this,t)};const p=r.parent.map.wrap.map;p.addInteraction(r.drawCtrl);r.drawCtrl.on(e.interaction.DrawEventType.DRAWSTART,function(t){r.parent._isDrawing=!0;p.getInteractions().forEach(function(t,r){t instanceof e.interaction.DoubleClickZoom&&t.setActive(!1)})});r.drawCtrl.startDrawing_({coordinate:n});r.drawCtrl.on(e.interaction.DrawEventType.DRAWEND,function(n){r.parent._isDrawing=!1;p.getInteractions().forEach(function(t,r){t instanceof e.interaction.DoubleClickZoom&&t.setActive(!1)});p.removeInteraction(r.drawCtrl);this.setActive(!1);r.drawCtrl=null;t.getSource().clear();r.parent._drawToken=!0;setTimeout(function(){r.parent._drawToken=!1},500);o&&TC.wrap.Feature.createFeature(n.feature).then(function(e){o(e)})})})};TC.wrap.control.GeometryFeatureInfo.prototype.cancelDraw=function(e,t,r){if(this.drawCtrl&&this.parent._isDrawing){this.parent._isDrawing=!1;this.drawCtrl.setActive(!1);this.drawCtrl.source_.clear()}};var W=function(e,t,r,n){const a=[];var o={};const i=function(e){const t=e.mapLayers[0];return e.title||e.mapLayers.reduce(function(e,t){return e||t.title},"")||t.tree&&t.tree.title||t.capabilities.Service.Title};e.wrap.map.getLayers().forEach(function(s){var l=s._wrap.parent;if(s.getVisible()&&!($.inArray(l,e.workLayers)<0)&&l.type===TC.Consts.layerType.WMS){var p=l.getDisgregatedLayerNames()||l.availableNames,c=o[l.url.toLowerCase()];c||(c=o[l.url.toLowerCase()]={layers:[],mapLayers:[l],layerNames:[]});for(var u=0;u<p.length;u++){var f=p[u];if((l.isVisibleByScale(f)||n)&&l.wrap.getInfo(f).queryable){c.layerNames.push(f);var g=l.getPath(f);c.layers.push({name:f,title:g[g.length-1],path:g.slice(1),features:[]})}}if(0!=c.layerNames.length&&void 0===c.request){c.request=c.request||l.getWFSCapabilitiesPromise();a.push(new Promise(function(e,a){c.request.then(function(s){var l=null,p=[];for(var u in o)o[u].request&&o[u].request==c.request&&(l=o[u]);var f=null,g=l.layerNames;if(g instanceof Array&&g.length)if(void 0!==s.Operations.GetFeature){for(var m=[],y=0;y<g.length;y++){for(var d=g[y].substring(g[y].indexOf(":")+1);"_"===d[d.length-1];)d=d.substring(0,d.lastIndexOf("_"));if(s.FeatureTypes.hasOwnProperty(d))m.indexOf(d)<0&&m.push(d);else{var h=l.mapLayers[0].getPath(d);p.push({key:TC.Consts.WFSErrors.LayersNotAvailable,params:{serviceTitle:i(l),layerName:h[h.length-1]}})}}if(0!=m.length){s.Operations.GetFeature.CountDefault&&(f=s.Operations.GetFeature.CountDefault.DefaultValue);if("1.0.0"===s.version&&!s.Operations.GetFeature.Operations.hasOwnProperty("Query")||("2.0.0"===s.version||"1.1.0"===s.version)&&s.Operations.QueryExpressions.AllowedValues.Value.indexOf("wfs:Query")<0){p.push({key:TC.Consts.WFSErrors.QueryNotAvailable,params:{serviceTitle:i(l)}});e({errors:p})}else{u=s.Operations.GetFeature.DCPType?s.Operations.GetFeature.DCPType[1].HTTP.Post.onlineResource:s.Operations.GetFeature.DCP.HTTP.Post["xlink:href"];l.mapLayers[0].getFeatureUrl(u).then(function(o){f?jQuery.ajax({url:o,data:TC.Util.WFSQueryBuilder(m,t,s,r,!0),cache:!1,contentType:"application/xml",type:"POST"}).then(function(){if(arguments[0]instanceof XMLDocument){var a=xml2json(arguments[0]);if(a.Exception){e({errors:[{key:TC.Consts.WFSErrors.Indeterminate,params:{err:a.Exception.exceptionCode,errorThrown:a.Exception.ExceptionText,serviceTitle:l.mapLayers.reduce(function(e,t){return e||t.title},"")}}]});return}}var o=parseInt(a.numberMatched||a.numberOfFeatures,10);isNaN(o)||o>parseInt(f,10)?e({errors:[{key:TC.Consts.WFSErrors.NumMaxFeatures,params:{limit:f,serviceTitle:i(l)}}]}):0===o?e({errors:[{key:TC.Consts.WFSErrors.NoFeatures,params:{serviceTitle:i(l)}}]}):n&&e({url:u,data:TC.Util.WFSQueryBuilder(m,t,s,r,!1),service:l,numFeatures:o,errors:p})},function(t,r,n){e({errors:[{key:TC.Consts.WFSErrors.Indeterminate,params:{err:r,errorThrown:n,serviceTitle:i(l)}}]})}):n||e({url:o,data:TC.Util.WFSQueryBuilder(m,t,s,r,!1),service:l,errors:p});n&&!f&&e({url:u,data:TC.Util.WFSQueryBuilder(m,t,s,r,!1),service:l,errors:p});n||jQuery.ajax({url:o,data:TC.Util.WFSQueryBuilder(m,t,s,r,!1),cache:!1,contentType:"application/xml",type:"POST"}).then(function(){if("success"==arguments[1]){if(arguments[0]instanceof XMLDocument){var t=xml2json(arguments[0]);if(t.Exception){e({errors:[{key:TC.Consts.WFSErrors.Indeterminate,params:{err:t.Exception.exceptionCode,errorThrown:t.Exception.ExceptionText,serviceTitle:l.mapLayers.reduce(function(e,t){return e||t.title},"")}}]});return}}e({service:l,response:arguments,errors:p})}else a(arguments)},function(t,r,n){e({errors:[{key:TC.Consts.WFSErrors.Indeterminate,params:{err:r,errorThrown:n,serviceTitle:i(l)}}]})})})}}else{p.push({key:TC.Consts.WFSErrors.NoValidLayers,params:{serviceTitle:i(l)}});e({errors:p})}}else{p.push({key:TC.Consts.WFSErrors.GetFeatureNotAvailable,params:{serviceTitle:i(l)}});e({errors:p})}},function(t,r,n){var a=null;for(var s in o)o[s].request&&o[s].request===c.request&&(a=o[s]);e({errors:[{key:TC.Consts.WFSErrors.GetCapabilities,params:{err:n,serviceTitle:i(a)}}]})})}))}}});return a};TC.WFSGetFeatureBuilder=W;var K=function(t,r,n){var a,o=n.getResponseHeader("Content-type");o&&o.indexOf(";")>-1&&(o=o.substr(0,o.indexOf(";")).trim());o||(o=r.requestedFormat);switch(o){case"application/json":a=new e.format.GeoJSON;break;case"application/vnd.ogc.gml":a=r.responseText.indexOf("FeatureCollection")>-1?new e.format.WFS({gmlFormat:new e.format.GML2({srsName:t.crs})}):new e.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":a=new e.format.GML3Patched({srsName:t.crs});break;case"text/xml":case"application/xml":(n=xml2json(r)).ServiceException&&TC.error(n.ServiceException);a=null;break;default:a=null}return a?a.readFeatures(n.responseText,{featureProjection:e.proj.get(t.crs)}):null},X=function(t,r){for(var n=[],a=[],o=function(e,t,r){var n=!1;if(t===r||0===t.indexOf(r))n=!0;else{var a=e.getPath(t),o=e.getPath(r);if(a.length>0&&o.length>=a.length){n=!0;for(var i=0;i<a.length;i++)if(a[i]!==o[i]){n=!1;break}}}return n},i=0;i<t.length;i++){var s=t[i];if(s instanceof e.Feature){for(var l=s.getId()||TC.getUID(),p=!1,c=l.substr(0,l.lastIndexOf(".")),u=0;u<r.layers.length;u++){var f=r.layers[u],g=f.name.substr(f.name.indexOf(":")+1);if(r.mapLayers.some(function(e){return o(e,g,c)})){p=!0;n.push(TC.wrap.Feature.createFeature(s));a[s.id_]=f.features;break}}if(!p){var m;if(fakeLayers[c])m=fakeLayers[c];else{m={name:c,title:c,features:[]};fakeLayers[c]=m;r.layers.push(m)}if(!opts.featureId||s.getId()===opts.featureId){n.push(TC.wrap.Feature.createFeature(s));a.push(m.features)}}}}return new Promise(function(e,t){Promise.all(n).then(function(t){t.forEach(function(e){e.attributes=[];for(var t in e.data){var r=e.data[t];"object"!=typeof r&&e.attributes.push({name:t,value:r})}a[e.id].push(e)});e({service:r})})})};TC.wrap.control.GeometryFeatureInfo.prototype.getFeaturesByGeometry=function(t,r){var n=this,a=n.parent.map;n.parent.filterFeature=t;t.layer=n.parent.filterLayer;a.wrap.getMap().then(function(o){var i=t.wrap.feature.getGeometry(),s=i.stride,l=i.getFlatCoordinates();if(!r){for(var p=null,c=1,u=l.length;c<u;c+=s)(!p||p[1]<l[c])&&(p=[l[c-1],l[c]]);r=o.getPixelFromCoordinate(new e.geom.Point(p).getCoordinates())}n.parent.beforeRequest({xy:r});var f=W(a,new TC.filter.intersects(t,a.crs!==a.options.crs?a.crs:void 0),"JSON");const g=[];Promise.all(f).then(function(e){for(var t=[],o=0,i=0;i<e.length;i++){const r=e[i];if(r){g[g.length]=new Promise(function(e,t){if(r.errors&&r.errors.length){for(var o=0;o<r.errors.length;o++){var i,s=TC.Consts.msgType.WARNING;!0;var l=r.errors[o];switch(l.key){case TC.Consts.WFSErrors.NumMaxFeatures:i=n.parent.getLocaleString("wfs.tooManyFeatures",l.params);break;case TC.Consts.WFSErrors.GetCapabilities:i=n.parent.getLocaleString("wfsGFI.inValidService",l.params);break;case TC.Consts.WFSErrors.NoFeatures:!1;continue;case TC.Consts.WFSErrors.Indeterminate:i=n.parent.getLocaleString("wfs.IndeterminateError");TC.error("Error:{error} \r\n Descripcion:{descripcion} \r\n Servicio:{serviceName}".format({error:l.params.err,descripcion:l.params.errorThrown,serviceName:l.params.serviceTitle}),TC.Consts.msgErrorMode.CONSOLE);s=TC.Consts.msgType.ERROR;break;default:i=n.parent.getLocaleString("wfsGFI."+l.key,l.params)}a.toast(i,{type:s})}r.response||e()}});var s=e[i].response?K(a,e[i].response[0],e[i].response[2]):[];g[g.length-1]=X(s,e[i].service);t.push(e[i].service);o+=s.length}}Promise.all(g).then(function(){n.parent.responseCallback({xy:r||null,services:t,featureCount:o})})},function(e){n.parent.responseCallback({})})})};TC.wrap.control.Popup.prototype=function(){this.popup=null};TC.Consts.event.PANANIMATIONSTART="pananimationstart.tc";TC.Consts.event.PANANIMATIONEND="pananimationend.tc";TC.wrap.control.Popup.prototype.fitToView=function(){var t=this,r=t.parent.map,n=t.parent.map.wrap.map,a=t.parent.popupDiv.getBoundingClientRect(),o=r.div.getBoundingClientRect(),i=n.getCoordinateFromPixel([a.left-o.left,a.top-o.top]),s=n.getCoordinateFromPixel([a.right-o.left,a.bottom-o.top]),l=i[0],p=i[1],c=s[0],u=[l,s[1],c,p],f=r.getExtent();if(!e.extent.containsExtent(f,u)){var g={left:Math.max(f[0]-u[0],0),bottom:Math.max(f[1]-u[1],0),right:Math.max(u[2]-f[2],0),top:Math.max(u[3]-f[3],0)};if(t.parent.dragged){var m=t.popup.getPosition();g.right?m[0]=m[0]-g.right:g.left&&(m[0]=m[0]+g.left);g.top?m[1]=m[1]-g.top:g.bottom&&(m[1]=m[1]+g.bottom);var y=n.getPixelFromCoordinate(m);y[1]=n.getSize()[1]-y[1];t.parent._previousContainerPosition=y;t.popup._oldUpdatePixelPosition(m)}else if(t.parent.isVisible()){var d=n.getView(),h=d.getCenter().slice();g.top?h[1]+=g.top:g.bottom&&(h[1]-=g.bottom);g.right?h[0]+=g.right:g.left&&(h[0]-=g.left);d.animate({center:h,easing:function(e){0===e&&t.parent.map.trigger(TC.Consts.event.PANANIMATIONSTART);1===e&&t.parent.map.trigger(TC.Consts.event.PANANIMATIONEND);return e}})}}};TC.wrap.control.Popup.prototype.setDragged=function(t){var r=this.popup;if(t){if(!r._oldUpdatePixelPosition){r._oldUpdatePixelPosition=r.updatePixelPosition;r.updatePixelPosition=function(){}}if(!r._newHandleOffsetChanged){r._newHandleOffsetChanged=function(){this._oldUpdatePixelPosition()};e.events.unlisten(r,e.Object.getChangeEventType(e.Overlay.Property.OFFSET),r.handleOffsetChanged,r);e.events.listen(r,e.Object.getChangeEventType(e.Overlay.Property.OFFSET),r._newHandleOffsetChanged,r)}}else{const t=r.getElement().parentElement.style;t.setProperty("top",r.rendered.top_);t.setProperty("bottom",r.rendered.bottom_);t.setProperty("left",r.rendered.left_);t.setProperty("right",r.rendered.right_);delete this.parent._previousContainerPosition;if(r._oldUpdatePixelPosition){r.updatePixelPosition=r._oldUpdatePixelPosition;delete r._oldUpdatePixelPosition}if(r._newHandleOffsetChanged){e.events.unlisten(r,e.Object.getChangeEventType(e.Overlay.Property.OFFSET),r._newHandleOffsetChanged,r);e.events.listen(r,e.Object.getChangeEventType(e.Overlay.Property.OFFSET),r.handleOffsetChanged,r);delete r._newHandleOffsetChanged}}};TC.wrap.Feature.prototype.getLegend=function(){var t={},r=x(this.feature);if(r){var n=r.getImage();if(n){if(n instanceof e.style.Icon){t.src=n.getSrc();var a=n.getScale();if(a){t.scale=a;var o=n.getImage();if(o.width){t.width=o.width*a;t.height=o.height*a}}}else n instanceof e.style.Circle&&(t.src=n.canvas_.toDataURL());if(this.parent.options.radius)t.height=t.width=2*this.parent.options.radius;else{t.width=t.width||this.parent.options.width;t.height=t.height||this.parent.options.height}}else{var i=r.getStroke(),s=r.getFill();if(i){var l=i.getColor();l&&(t.strokeColor=e.color.asString(l));var p=i.getWidth();p&&(t.strokeWidth=p)}if(s){var c=s.getColor();c&&(t.fillColor=e.color.asString(c))}}}return t};var H=function(t,r,n){var a,o={};o[n||"geometry"]=new r(t);a=new e.Feature(o);n&&a.setGeometryName(n);return a};TC.wrap.Feature.prototype.createPoint=function(t,r){if($.isArray(t))this.feature=H(t,e.geom.Point,r.geometryName);else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;this.feature.setStyle(A({styles:{point:r}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createMarker=function(t,r){var n=TC.Util.getPointIconUrl(r);if(n){r.url=n;if($.isArray(t))this.feature=H(t,e.geom.Point,r.geometryName);else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;this.feature.setStyle(A({styles:{marker:r}},this.feature));this.setData(this.parent.data)}else this.createPoint(t,r)};TC.wrap.Feature.prototype.createPolyline=function(t,r){if($.isArray(t))this.feature=H(t,e.geom.LineString,r.geometryName);else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;r&&this.feature.setStyle(A({styles:{line:r}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createPolygon=function(t,r){if($.isArray(t)){if(t.length){var n=t[0];if($.isArray(n)&&n.length){var a=n[0];$.isArray(a)||(t=[t]);for(var o=0;o<t.length;o++){var i=(n=t[o])[0],s=n[n.length-1];i[0]===s[0]&&i[1]===s[1]||(n[n.length]=i);this.parent.geometry=t;this.feature=H(t,e.geom.MultiLineString,r.geometryName)}this.parent.geometry=t;this.feature=H(t,e.geom.Polygon,r.geometryName)}}}else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;var l=r||{};(l.strokeColor||l.strokeWidth||l.fillColor||l.fillOpacity)&&this.feature.setStyle(A({styles:{polygon:l}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createMultiPolyline=function(t,r){if($.isArray(t)){if(t.length){var n=t[0];if($.isArray(n)&&n.length){var a=n[0];$.isArray(a)||(t=[t]);this.parent.geometry=t;this.feature=H(t,e.geom.MultiLineString,r.geometryName)}}}else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;r&&this.feature.setStyle(A({styles:{line:r}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createMultiPolygon=function(t,r){if($.isArray(t)){if(t.length){var n=t[0];if($.isArray(n)&&n.length){var a=n[0];if($.isArray(a)&&a.length){var o=a[0];$.isArray(o)||(t=[t])}else t=[[t]];for(var i=0,s=t.length;i<s;i++)for(var l=0,p=(n=t[i]).length;l<p;l++){var c=(a=n[l])[0],u=a[a.length-1];c[0]===u[0]&&c[1]===u[1]||(a[a.length]=c)}this.parent.geometry=t;this.feature=H(t,e.geom.MultiPolygon,r.geometryName)}}}else if(this.isNative(t)){this.feature=t;this.parent.geometry=t.getGeometry().getCoordinates()}this.feature._wrap=this;var f=r||{};(f.strokeColor||f.strokeWidth||f.fillColor||f.fillOpacity)&&this.feature.setStyle(A({styles:{polygon:f}},this.feature));this.setData(this.parent.data)};TC.wrap.Feature.prototype.createCircle=function(t,r){if($.isArray(t)&&$.isArray(t[0])&&"number"==typeof t[0][0]&&"number"==typeof t[0][1]&&"number"==typeof t[1]){var n={};n[r.geometryName||"geometry"]=new e.geom.Circle(t[0],t[1]);this.feature=new e.Feature(n);r.geometryName&&this.feature.setGeometryName(r.geometryName)}else if(this.isNative(t)){this.feature=t;var a=t.getGeometry();this.parent.geometry=[a.getCenter(),a.getRadius()]}this.feature._wrap=this;r&&this.feature.setStyle(new e.style.Style({stroke:new e.style.Stroke({color:r.strokeColor,width:r.strokeWidth,lineDash:r.lineDash}),fill:new e.style.Fill({color:h(r.fillColor,r.fillOpacity)})}));this.setData(this.parent.data)};TC.wrap.Feature.createFeature=function(t,r){return new Promise(function(n,a){var o,i=t.getGeometry();(r=r||{}).id=t.getId();switch(!0){case i instanceof e.geom.Point:var s=t.getStyle();$.isFunction(s)&&(s=s.call(t));for(var l=s?$.isArray(s)?s:[s]:[],p=0,c=l.length;p<c;p++)if((s=l[p]).getImage()instanceof e.style.Icon){o="Marker";break}o=o||"Point";break;case i instanceof e.geom.LineString:o="Polyline";break;case i instanceof e.geom.Polygon:o="Polygon";break;case i instanceof e.geom.MultiLineString:o="MultiPolyline";break;case i instanceof e.geom.MultiPolygon:o="MultiPolygon"}o?TC.loadJS(!TC.feature||TC.feature&&!TC.feature[o],[TC.apiLocation+"TC/feature/"+o],function(){var e=new TC.feature[o](t,r);e.data=e.wrap.getData();n(e)}):TC.loadJS(!TC.Feature,[TC.apiLocation+"TC/Feature"],function(){var e=new TC.Feature(t,r);e.data=e.wrap.getData();n(e)})})};TC.wrap.Feature.prototype.cloneFeature=function(){return this.feature.clone()};TC.wrap.Feature.prototype.getStyle=function(){var t={},r=this.feature.getStyle();$.isFunction(r)&&(r=r.call(this.feature));var n=r?$.isArray(r)?r:[r]:[];const a=function(e,t){if(e){const r=e.getFill();if(r){t.fillColor=r.getColor();$.isArray(t.fillColor)&&(t.fillOpacity=t.fillColor[3])}}},o=function(e,t){if(e){const r=e.getStroke();if(r){t.strokeColor=r.getColor();t.strokeWidth=r.getWidth()}}};for(var i=0,s=n.length;i<s;i++){a(r=n[i],t);o(r,t);const s=r.getImage();if(s instanceof e.style.Icon){t.url=s.getSrc();const e=s.getSize(),r=s.getScale()||1;if(e){t.width=e[0]*r;t.height=e[1]*r}var l=s.getAnchor();if(l){t.anchor=[l[0]*r,l[1]*r];if(e){t.anchor[0]=t.anchor[0]/t.width;t.anchor[1]=t.anchor[1]/t.height}}}else{a(s,t);o(s,t)}var p=r.getText();if(p){t.label=p.getText();var c=p.getFont();c&&(t.fontSize=parseInt(c.match(/\d+pt/))||.75*parseInt(c.match(/\d+px/)));var u=p.getRotation();u&&(t.angle=-180*u/Math.PI);t.labelOffset=[p.getOffsetX(),p.getOffsetY()];fill=p.getFill();fill&&(t.fontColor=fill.getColor());stroke=p.getStroke();if(stroke){t.labelOutlineColor=stroke.getColor();t.labelOutlineWidth=stroke.getWidth()}}}$.extend(this.parent.options,t);return t};TC.wrap.Feature.prototype.getGeometry=function(){var t;if(this.feature&&this.feature.getGeometry){var r=this.feature.getGeometry();r&&(r.getCoordinates?t=r.getCoordinates():r instanceof e.geom.Circle&&(t=[r.getCenter(),r.getRadius()]))}return t};TC.wrap.Feature.prototype.setGeometry=function(t){var r=!1;if(this.feature&&this.feature.getGeometry){var n,a,o,i,s,l,p,c=this.feature.getGeometry();switch(!0){case c instanceof e.geom.MultiPolygon:s=!0;i=t;$.isArray(i)&&(o=t[0]);case c instanceof e.geom.Polygon||c instanceof e.geom.MultiLineString:l=!0;o=s?o:t;$.isArray(o)&&(a=o[0]);case c instanceof e.geom.LineString:p=!0;a=l?a:t;$.isArray(a)&&(n=a[0]);case c instanceof e.geom.Point:n=p?n:t;if($.isArray(n)&&"number"==typeof n[0]&&"number"==typeof n[1]){var u;switch(n.length){case 3:u=e.geom.GeometryLayout.XYZ;break;case 4:u=e.geom.GeometryLayout.XYZM;break;default:u=e.geom.GeometryLayout.XY}c.setCoordinates(t,u);r=!0}break;case c instanceof e.geom.Circle:if($.isArray(t)&&$.isArray(t[0])&&"number"==typeof t[0][0]&&"number"==typeof t[0][1]&&"number"==typeof t[1]){c.setCenterAndRadius(t[0],t[1]);r=!0}}}return r};TC.wrap.Feature.prototype.getId=function(){var e;this.feature&&(e=this.feature.getId());return e};TC.wrap.Feature.prototype.setId=function(e){this.feature&&this.feature.setId(e)};const Y=function(t,r){const n=this;var a=0;t.getLinearRings().forEach(function(t){coordinates=t.getCoordinates();r.crs&&(coordinates=TC.Util.reproject(coordinates,n.parent.layer.map.crs,r.crs));const o=new e.geom.Polygon([coordinates]).getLinearRing(0);a+=e.geom.flat.length.linearRing(o.flatCoordinates,0,o.flatCoordinates.length,o.stride)});return a},z=function(t,r){const n=this;coordinates=t.getCoordinates();r.crs&&(coordinates=TC.Util.reproject(coordinates,n.parent.layer.map.crs,r.crs));return new e.geom.LineString(coordinates).getLength()};TC.wrap.Feature.prototype.getLength=function(t){const r=this;t=t||{};var n=0;const a=r.feature.getGeometry();switch(!0){case a instanceof e.geom.Polygon:n=Y.call(r,a,t);break;case a instanceof e.geom.LineString:n=z.call(r,a,t);break;case a instanceof e.geom.MultiPolygon:a.getPolygons().forEach(function(e){n+=Y.call(r,e,t)});break;case a instanceof e.geom.MultiPolygon:a.getLineStrings().forEach(function(e){n+=z.call(r,e,t)})}return n};TC.wrap.Feature.prototype.getArea=function(t){const r=this;t=t||{};const n=r.feature.getGeometry();var a;if(n instanceof e.geom.Polygon){a=n.getLinearRing(0).getCoordinates();t.crs&&(a=TC.Util.reproject(a,r.parent.layer.map.crs,t.crs));return new e.geom.Polygon([a]).getArea()}};const q=function(t){var r=this.getStyle();$.isFunction(r)&&(r=r.call(this));$.isArray(r)&&(r=r[r.length-1]);if(!r&&!t){r=new e.style.Style;this.setStyle(r)}return r};TC.wrap.Feature.prototype.setStyle=function(t){const r=this.feature;if(null===t){r.setStyle(null);return}const n=this.parent,a=r.getGeometry();var o,i=q.call(r);n.layer&&(o=function(t){var r=this.getStyle();$.isFunction(r)&&(r=r(t));$.isArray(r)&&(r=r[r.length-1]);r||(r=new e.style.Style);return r}.call(n.layer.wrap.layer,n.wrap.feature));if(a instanceof e.geom.Point||a instanceof e.geom.MultiPoint){var s;if(t.anchor||t.url||t.cssClass){const r={};if((s=i.getImage())instanceof e.style.Icon){r.src=t.url||TC.Util.getBackgroundUrlFromCss(t.cssClass)||s.getSrc();t.width&&t.height?r.size=[_(t.width,n),_(t.height,n)]:r.size=s.getSize();r.anchor=_(t.anchor,n)||s.getAnchor().map(function(e,t){return e/r.size[t]})}else{r.src=TC.Util.getPointIconUrl(t);r.anchor=_(t.anchor,n);r.size=[_(t.width,n),_(t.height,n)]}t.angle&&(r.angle=t.angle);s=new e.style.Icon(r)}else if(!i.getImage()&&i.getText())if(void 0!==t.label){i=q.call(r);t.label.length?i.setText(I(t,n)):i.setText()}else i.setText();else{(s=i.getImage())||(s=new e.style.Circle);const r={radius:_(t.radius,n)||(_(t.height,n)+_(t.width,n))/4};isNaN(r.radius)&&(r.radius=s.getRadius());t.fillColor?r.fill=new e.style.Fill({color:h(_(t.fillColor,n),_(t.fillOpacity,n))}):r.fill=s.getFill();r.stroke=s.getStroke();const a=o&&o.getStroke();if(t.strokeColor||t.strokeWidth){r.stroke||(r.stroke=new e.style.Stroke);if(t.strokeColor)r.stroke.setColor(_(t.strokeColor,n));else{const e=r.stroke.getColor()||a&&a.getColor()||TC.Cfg.styles.point.strokeColor;r.stroke.setColor(_(e,n))}if(t.strokeWidth)r.stroke.setWidth(_(t.strokeWidth,n));else{const e=r.stroke.getWidth()||a&&a.getWidth()||TC.Cfg.styles.point.strokeWidth;r.stroke.setWidth(_(e,n))}}s=new e.style.Circle(r)}i.setImage(s)}else{var l=i.getStroke(),p=!1;l||(l=new e.style.Stroke);if(t.strokeColor){l.setColor(_(t.strokeColor,n));p=!0}if(t.strokeWidth){l.setWidth(_(t.strokeWidth,n));p=!0;i.setStroke(l)}if(t.lineDash){l.setLineDash(t.lineDash);p=!0;i.setStroke(l)}p&&i.setStroke(l);if((a instanceof e.geom.Polygon||a instanceof e.geom.MultiPolygon)&&(t.fillColor||t.fillOpacity)){var c=i.getFill()||new e.style.Fill;c.setColor(h(_(t.fillColor,n),_(t.fillOpacity,n)));i.setFill(c)}}if(void 0!==t.label){i=q.call(r);t.label.length?i.setText(I(t,n)):i.setText()}r.changed()};TC.wrap.Feature.prototype.toggleSelectedStyle=function(e){const t=this.feature;(void 0===e?!t._originalStyle:e)?ee(t):te(t)};TC.wrap.Feature.prototype.getInnerPoint=function(t){var r,n=t||{},a=this.feature.getGeometry(),o=function e(t){if(n.clipBox&&$.isArray(t))if($.isArray(t[0]))for(var r=0,a=t.length;r<a;r++)e(t[r]);else!function(e){var t=n.clipBox;e[0]=Math.min(Math.max(e[0],t[0]),t[2]);e[1]=Math.min(Math.max(e[1],t[1]),t[3])}(t)};r=a.getFirstCoordinate();switch(a.getType()){case e.geom.GeometryType.MULTI_POLYGON:var i=0;a=a.getPolygons().reduce(function(e,t){const r=t.getArea(),n=r>i?t:e;i=r;return n});case e.geom.GeometryType.POLYGON:var s=function(e,t){for(var r=!1,n=0,a=t.length-1;n<t.length;a=n++){var o=t[n][0],i=t[n][1],s=t[a][0],l=t[a][1];i>e[1]!=l>e[1]&&e[0]<(s-o)*(e[1]-i)/(l-i)+o&&(r=!r)}return r};o(u=a.getCoordinates());r=(a=new e.geom.Polygon(u)).getInteriorPoint().getCoordinates();for(var l=a.getLinearRings(),p=1;p<l.length;p++)if(s(r,l[p].getCoordinates())){r=a.getClosestPoint(r);break}break;case e.geom.GeometryType.MULTI_LINE_STRING:var c=0;a=a.getLineStrings().reduce(function(e,t){const r=t.getLength(),n=r>c?t:e;c=r;return n});case e.geom.GeometryType.LINE_STRING:var u,f=[0,0];o(u=a.getCoordinates());a=new e.geom.LineString(u);for(p=0;p<u.length;p++){f[0]+=u[p][0];f[1]+=u[p][1]}f[0]/=u.length;f[1]/=u.length;r=a.getClosestPoint(f)}return r};TC.wrap.Feature.prototype.showPopup=function(t){var r=t.map;if(r){var n=this.feature;if(n){r.currentFeature=this.parent;var a=r.getExtent();this._innerCentroid=this.getInnerPoint({clipBox:a});t.contentDiv.innerHTML=this.parent.getInfo({locale:r.options.locale});t.menuDiv.innerHTML="";if(t.options.closeButton||void 0===t.options.closeButton){const e=document.createElement("div");e.classList.add(t.CLASS+"-close");e.setAttribute("title",t.getLocaleString("close"));t.menuDiv.appendChild(e);e.addEventListener(TC.Consts.event.CLICK,function(){t.hide()});t.contentDiv.classList.add(t.CLASS+"-has-btn");const r=t.contentDiv.querySelector(".tc-ctl-finfo");if(r){r.width="auto";r.height="auto"}}var o,i=this.parent.options;if(TC.Util.isEmptyObject(i)&&this.parent.layer&&this.parent.layer.options&&this.parent.layer.options.styles)switch(this.parent.CLASSNAME){case"TC.feature.Point":(i=this.parent.layer.options.styles.point)&&!TC.Util.isEmptyObject(i)||(i=this.parent.layer.options.styles.marker);break;case"TC.feature.Marker":i=this.parent.layer.options.styles.marker;break;case"TC.feature.Circle":i=this.parent.layer.options.styles.circle;break;case"TC.feature.MultiPolygon":case"TC.feature.Polygon":i=this.parent.layer.options.styles.polygon;break;case"TC.feature.MultiPolyline":case"TC.feature.Polyline":i=this.parent.layer.options.styles.line}if(i.anchor)o=i.anchor;else{for(var s,l=n._wrap.parent,p=0;p<r.workLayers.length;p++){var c=r.workLayers[p];if(!c.isRaster()&&$.inArray(l,c.features)>=0){s=c.wrap.styleFunction(n);break}}if($.isArray(s)){const t=s[0].getImage();o=!t||t instanceof e.style.Icon?[.5,0]:[.5,.5]}}const f=[0,0];if(o)if(i.height)f[1]=-i.height*o[1];else{var u=q.call(n,!0);if(u){const t=u.getImage();t instanceof e.style.Icon&&(f[1]=t.getImageSize()[1]*-t.getScale())}}t.wrap.setDragged(!1);t.wrap.popup.setOffset(f);t.wrap.popup.setPosition(this._innerCentroid);t.popupDiv.classList.add(TC.Consts.classes.VISIBLE)}else r.wrap.hidePopup(t)}};TC.wrap.Feature.prototype.isNative=function(t){return t instanceof e.Feature};TC.wrap.Feature.prototype.getPath=function(){var e=[];this.feature&&this.feature._folders&&(e=this.feature._folders);return e};TC.wrap.Feature.prototype.getBounds=function(){var e=null;this.feature&&(e=this.feature.getGeometry().getExtent());return e};TC.wrap.Feature.prototype.getTemplate=function(){var e=null,t=this.feature.getStyle();"function"==typeof t&&(t=t.call(this.feature));if($.isArray(t))for(var r=0;r<t.length;r++)if(t[r]._balloon){if(t[r]._balloon.getText()){t=t[r]._balloon;break}}t&&!$.isArray(t)&&t.getText&&(e=t.getText());return e};TC.wrap.Feature.prototype.getData=function(){var e=this.feature.getProperties();$.isArray(e.features)&&(e=1===e.features.length?e.features[0].getProperties():e.features.length+" elementos");var t=this.feature.getGeometryName();e[t]&&delete e[t];return e};TC.wrap.Feature.prototype.setData=function(e){this.feature.setProperties(e)};TC.wrap.Feature.prototype.clearData=function(){const e=this.feature,t=e.getGeometryName();e.getKeys().forEach(function(r){r!==t&&e.unset(r)})};TC.wrap.control.Draw.prototype.mouseMoveHandler=function(e){const t=this;t.sketch&&t.parent.trigger(TC.Consts.event.MEASUREPARTIAL,t.getMeasureData())};TC.wrap.control.Draw.prototype.mouseOverHandler=function(e){const t=this;if(t.sketch&&t.hoverCoordinate){t.pushCoordinate(t.hoverCoordinate);t.hoverCoordinate=null}};TC.wrap.control.Draw.prototype.clickHandler=function(e){const t=this;if(t.parent.map.view!==TC.Consts.view.PRINTING){if(t._mdPx){const r=t._mdPx[0]-e.clientX,n=t._mdPx[1]-e.clientY;if(r*r+n*n>t.interaction.squaredClickTolerance_)return}if(t.sketch){var r=t.sketch.getGeometry().getCoordinates();t.parent.trigger(TC.Consts.event.POINT,{point:r[r.length-1]})}}};TC.wrap.control.Draw.prototype.mousedownHandler=function(e){this._mdPx=[e.clientX,e.clientY]};TC.wrap.control.Draw.prototype.getMeasureData=function(){var t=this,r={units:e.proj.Units.METERS};if(this.sketch){var n=this.sketch.getGeometry();n instanceof e.geom.Polygon?function(r,n){r=new e.geom.Polygon([TC.Util.reproject(r.getLinearRing(0).getCoordinates(),t.parent.map.crs,t.parent.map.options.utmCrs)]);n.area=r.getArea();var a=r.getLinearRing(0);n.perimeter=e.geom.flat.length.linearRing(a.flatCoordinates,0,a.flatCoordinates.length,a.stride)}(n,r):n instanceof e.geom.LineString&&function(r,n){r=new e.geom.LineString(TC.Util.reproject(r.getCoordinates(),t.parent.map.crs,t.parent.map.options.utmCrs));n.length=r.getLength()}(n,r)}return r};TC.wrap.control.Draw.prototype.activate=function(t){var r,n=this;switch(t){case TC.Consts.geom.POLYGON:r=e.geom.GeometryType.POLYGON;break;case TC.Consts.geom.POINT:r=e.geom.GeometryType.POINT;break;default:r=e.geom.GeometryType.LINE_STRING}n.parent.map&&Promise.all([n.parent.map.wrap.getMap(),n.parent.getLayer()]).then(function(a){const o=a[0],i=a[1];i&&i.wrap.getLayer().then(function(a){n.viewport||(n.viewport=o.getViewport());if(n.interaction){o.removeInteraction(n.interaction);if(n._mousedownHandler){n.viewport.removeEventListener("mousedown",n._mousedownHandler);n._mousedownHandler=null}if(n._clickHandler){n.viewport.removeEventListener(TC.Consts.event.CLICK,n._clickHandler);n._clickHandler=null}if(n._mouseMoveHandler&&n._mouseOverHandler){n.viewport.removeEventListener("mousemove",n._mouseMoveHandler);n.viewport.removeEventListener("mouseover",n._mouseOverHandler)}}n.snapInteraction&&o.removeInteraction(n.snapInteraction);if(t){n._mousedownHandler=$.proxy(n.mousedownHandler,n);n._clickHandler=$.proxy(n.clickHandler,n);n.viewport.addEventListener("mousedown",n._mousedownHandler);n.viewport.addEventListener(TC.Consts.event.CLICK,n._clickHandler);if(n.parent.measure){n._mouseMoveHandler=n.mouseMoveHandler.bind(n);n._mouseOverHandler=n.mouseOverHandler.bind(n);n.viewport.addEventListener("mousemove",n._mouseMoveHandler);n.viewport.addEventListener("mouseover",n._mouseOverHandler)}var i={type:r,snapTolerance:0,condition:function(){e.events.condition.shiftKeyOnly(arguments[0])&&(hole=o.forEachFeatureAtPixel(o.getPixelFromCoordinate(arguments[0].coordinate),function(t){return e.geom.GeometryType.POLYGON==t.getGeometry().getType()||e.geom.GeometryType.MULTI_POLYGON==t.getGeometry().getType()?t:null},{hitTolerance:l}));return n.parent.map.view!==TC.Consts.view.PRINTING||null}};a&&(i.source=a.getSource());switch(t){case TC.Consts.geom.RECTANGLE:i.style=A({styles:{line:n.parent.styles.line}});i.type=e.geom.GeometryType.LINE_STRING;i.maxPoints=2;i.geometryFunction=function(t,r){r||(r=new e.geom.Polygon(null));var n=t[0],a=t[1];r.setCoordinates([[n,[n[0],a[1]],a,[a[0],n[1]],n]]);return r};break;case TC.Consts.geom.POLYGON:i.style=A({styles:{polygon:n.parent.styles.polygon}});break;case TC.Consts.geom.POINT:i.style=A({styles:{point:n.parent.styles.point}});break;default:i.style=A({styles:{line:n.parent.styles.line}})}n.interaction=new e.interaction.Draw(i);n.interaction.on(e.interaction.DrawEventType.DRAWSTART,function(e){n.sketch=e.feature;n.parent.trigger(TC.Consts.event.DRAWSTART)},this);n.interaction.on(e.interaction.DrawEventType.DRAWEND,function(e){e.feature.setStyle(e.target.overlay_.getStyle().map(function(e){return e.clone()}));n.parent.measure&&n.parent.trigger(TC.Consts.event.MEASURE,n.getMeasureData());N(n.sketch).then(function(e){n.parent.trigger(TC.Consts.event.DRAWEND,{feature:e});n.sketch=null})},this);n._projectionChangeHandler=function(t){!function(t,r){if(t.sketch){const a=r.oldValue.getProjection(),o=r.target.get(r.key).getProjection();if(a.getCode()!==o.getCode()){const r=t.sketch.getGeometry();r.transform(a,o);t.interaction.sketchPoint_.getGeometry().transform(a,o);const i=[];var n;n=t.interaction.mode_===e.interaction.Draw.Mode_.POLYGON?t.interaction.sketchCoords_[0]:t.interaction.sketchCoords_;e.geom.flat.deflate.coordinates(i,0,n,r.stride);e.proj.getTransform(a,o)(i,i,r.stride);n=e.geom.flat.inflate.coordinates(i,0,i.length,r.stride);t.interaction.mode_===e.interaction.Draw.Mode_.POLYGON?t.interaction.sketchCoords_=[n]:t.interaction.sketchCoords_=n}}}(n,t)};o.on("change:view",n._projectionChangeHandler);o.addInteraction(n.interaction);if(n.parent.snapping){var s={};a?s.source=a.getSource():n.parent.snapping instanceof TC.Layer&&(s.source=n.parent.snapping.wrap.layer.getSource());n.snapInteraction=new e.interaction.Snap(s);o.addInteraction(n.snapInteraction)}}n.redoStack=[]})})};TC.wrap.control.Draw.prototype.deactivate=function(){var e=this;e.parent.map&&Promise.all([e.parent.map.wrap.getMap(),e.parent.getLayer()]).then(function(t){const r=t[0],n=t[1];if(e.viewport){if(e._mousedownHandler){e.viewport.removeEventListener("mousedown",e._mousedownHandler);e._mousedownHandler=null}if(e._clickHandler){e.viewport.removeEventListener(TC.Consts.event.CLICK,e._clickHandler);e._clickHandler=null}}n&&!e.parent.persistent&&n.clearFeatures();if(e.interaction){r.removeInteraction(e.interaction);e.interaction=null}r.un("change:view",e._projectionChangeHandler)})};TC.wrap.control.Draw.prototype.popCoordinate=function(){var t=null;if(this.interaction){var r=this.interaction.sketchFeature_;if(r){var n,a=r.getGeometry();a instanceof e.geom.Polygon?n=a.getCoordinates()[0]:a instanceof e.geom.LineString&&(n=a.getCoordinates());if(n.length>1){var o;a instanceof e.geom.Polygon?o=this.interaction.sketchCoords_[0]:a instanceof e.geom.LineString&&(o=this.interaction.sketchCoords_);var i,s=!1;if(this.interaction.sketchPoint_)for(var l=this.interaction.sketchPoint_.getGeometry().getCoordinates(),p=0;p<n.length;p++)if(n[p][0]==l[0]&&n[p][1]==l[1]){s=!0;break}t=o[i=s?o.length-2:o.length-1];o.splice(i,1);if(a instanceof e.geom.Polygon){a.setCoordinates([o]);this.interaction.sketchLine_.getGeometry().setCoordinates(o)}else a.setCoordinates(o);r.setGeometry(a)}}}return t};TC.wrap.control.Draw.prototype.pushCoordinate=function(t){var r=!1;if(this.interaction){var n=this.interaction.sketchFeature_;if(n){var a,o=n.getGeometry();o instanceof e.geom.Polygon?a=o.getCoordinates()[0]:o instanceof e.geom.LineString&&(a=o.getCoordinates());var i;o instanceof e.geom.Polygon?i=this.interaction.sketchCoords_[0]:o instanceof e.geom.LineString&&(i=this.interaction.sketchCoords_);var s=!1;if(this.interaction.sketchPoint_)for(var l=this.interaction.sketchPoint_.getGeometry().getCoordinates(),p=0;p<a.length;p++)if(a[p][0]==l[0]&&a[p][1]==l[1]){s=!0;break}index=s?i.length-1:i.length;i.splice(index,0,t);if(o instanceof e.geom.LineString)o.setCoordinates(i,e.geom.GeometryLayout.XY);else{o.setCoordinates([i],e.geom.GeometryLayout.XY);this.interaction.sketchLine_.getGeometry().setCoordinates(i)}r=!0}}return r};TC.wrap.control.Draw.prototype.undo=function(){var e=!1,t=this.popCoordinate();if(t){this.redoStack.push(t);e=!0}this.parent.trigger(TC.Consts.event.MEASUREPARTIAL,this.getMeasureData());return e};TC.wrap.control.Draw.prototype.redo=function(){var e=!1;if(this.redoStack.length>0){this.pushCoordinate(this.redoStack.pop());e=!0}this.parent.trigger(TC.Consts.event.MEASUREPARTIAL,this.getMeasureData());return e};TC.wrap.control.Draw.prototype.end=function(){this.interaction&&this.interaction.sketchFeature_&&this.interaction.finishDrawing()};TC.wrap.control.Draw.prototype.setStyle=function(e){const t=this;t.interaction&&t.interaction.overlay_.setStyle(A({styles:e}))};TC.wrap.control.CacheBuilder.prototype.getRequestSchemas=function(e){for(var t=e.extent,r=e.layers,n=new Array(r.length),a=0,o=n.length;a<o;a++){var i=r[a],s={layerId:i.id},l=i.wrap.layer.getSource();l.getUrls&&(s.url=l.getUrls()[0]);if(l.getTileGrid){for(var p=l.getTileGrid(),c=p.getResolutions(),u=p.getMatrixIds(),f=i.getLayerNodeByName(i.layerNames),g=null,m=0,y=f.TileMatrixSetLink.length;m<y;m++){var d=f.TileMatrixSetLink[m];if(d.TileMatrixSet===i.matrixSet){g=d.TileMatrixSetLimits;break}}s.tileMatrixLimits=[];m=0;for(var h=c.length;m<h;m++){var C=p.getOrigin(m),T=p.getTileSize(m),v=c[m],S=T*v,w={mId:u[m],res:v,origin:C,tSize:T,cl:Math.floor((t[0]-C[0])/S),cr:Math.floor((t[2]-C[0])/S),rt:Math.floor((C[1]-t[3])/S),rb:Math.floor((C[1]-t[1])/S)};if(g){var E=g[m];if(E){w.cl=Math.max(w.cl,E.MinTileCol);w.cr=Math.min(w.cr,E.MaxTileCol);w.rt=Math.max(w.rt,E.MinTileRow);w.rb=Math.min(w.rb,E.MaxTileRow)}}w.cl<=w.cr&&w.rt<=w.rb&&s.tileMatrixLimits.push(w)}}n[a]=s}return n};TC.wrap.control.CacheBuilder.prototype.getGetTilePattern=function(e){var t="",r=e.wrap.layer.getSource();r.getUrls&&(t=r.getUrls()[0]);if(e.options.encoding!==TC.Consts.WMTSEncoding.RESTFUL){t.indexOf("?")<0&&(t+="?");t.indexOf("?")===t.length-1&&(t=t+"layer="+e.layerNames+"&style=default&tilematrixset="+encodeURIComponent(e.matrixSet)+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+encodeURIComponent(e.format)+"&TileMatrix={TileMatrix}&TileCol={TileCol}&TileRow={TileRow}")}return t};const J=function(t){return new e.style.Stroke({color:"#ffffff",width:t+4})},Z=function(t){return new e.style.Stroke({color:"#000000",width:t+6})},Q=function(t){void 0===t&&(t=[]);t instanceof e.style.Style&&(t=[t]);const r=(t=t.slice())[0];if(r){const a=r.getImage();var n;if(a instanceof e.style.RegularShape){n=a.getStroke().getWidth();const o=a.getRadius(),i=r.clone();i.setImage(new e.style.Circle({radius:o,stroke:J(n)}));t.unshift(i);const s=r.clone();s.setImage(new e.style.Circle({radius:o,stroke:Z(n)}));t.unshift(s)}else{n=r.getStroke().getWidth();t.unshift(new e.style.Style({stroke:J(n)}));t.unshift(new e.style.Style({stroke:Z(n)}))}return t}return null},ee=function(t){re.call(t);t.changed();e.events.listen(t,e.events.EventType.CHANGE,re,t)},te=function(t){e.events.unlisten(t,e.events.EventType.CHANGE,re,t);if(t._originalStyle){t.setStyle(null);t.setStyle(t._originalStyle)}t._originalStyle=null},re=function(){this.style_=function(e){e._originalStyle=e._originalStyle||e.getStyle();return $.isFunction(e._originalStyle)?function(t,r){return Q(e._originalStyle(t,r))}:Q(e._originalStyle)}(this);this.styleFunction_=this.style_?e.Feature.createStyleFunction(this.style_):void 0};TC.wrap.control.Modify.prototype.activate=function(){const t=this;t.parent.map&&Promise.all([t.parent.map.wrap.getMap(),t.parent.layer.wrap.getLayer()]).then(function(r){const n=r[0],a=r[1];t.selectInteraction&&n.removeInteraction(t.selectInteraction);var o=new e.interaction.Select({layers:[a],hitTolerance:l});t.selectInteraction=o;n.addInteraction(o);var i=function(e){return e._wrap.parent};o.on("select",function(e){e.selected.length>0&&t.parent.trigger(TC.Consts.event.FEATURESSELECT,{ctrl:t,features:e.selected.map(i)});e.deselected.length>0&&0==e.selected.length&&t.parent.trigger(TC.Consts.event.FEATURESUNSELECT,{ctrl:t.parent,features:e.deselected.map(i)})});t.modifyInteraction&&n.removeInteraction(t.modifyInteraction);var s=new e.interaction.Modify({features:o.getFeatures()});s.on(e.interaction.ModifyEventType.MODIFYEND,function(e){e.features.forEach(function(e){e._wrap.parent.geometry=e._wrap.getGeometry();t.parent.trigger(TC.Consts.event.FEATUREMODIFY,{feature:e._wrap.parent,layer:t.parent.layer})})});t.modifyInteraction=s;n.addInteraction(s);t.snapInteraction&&n.removeInteraction(t.snapInteraction);if(t.parent.snapping){t.snapInteraction=new e.interaction.Snap({source:a.getSource()});n.addInteraction(t.snapInteraction)}t._onMouseMove||(t._onMouseMove=function(e){const r=n.getTarget();var a,o=n.getEventPixel(e);a=n.forEachFeatureAtPixel(o,function(e,r){return r===t.parent.layer.wrap.layer},{hitTolerance:l});r.style.cursor=a?"pointer":""});n.getViewport().addEventListener("mousemove",t._onMouseMove)})};TC.wrap.control.Modify.prototype.deactivate=function(){const e=this;if(e.modifyInteraction){e.modifyInteraction.setActive(!1);e.selectInteraction.setActive(!1);e.parent.map.wrap.getMap().then(function(t){t.getViewport().removeEventListener("mousemove",e._onMouseMove);t.removeInteraction(e.modifyInteraction);t.removeInteraction(e.selectInteraction);e.modifyInteraction=null;e.selectInteraction=null})}};TC.wrap.control.Modify.prototype.getSelectedFeatures=function(){var e=[];this.selectInteraction&&this.selectInteraction.getFeatures().forEach(function(t){e[e.length]=t._wrap.parent});return e};TC.wrap.control.Modify.prototype.setSelectedFeatures=function(e){if(this.selectInteraction){var t=this.selectInteraction.featureOverlay_.getSource();t.clear();t.addFeatures(e.map(function(e){return e.wrap.feature}))}};TC.wrap.control.Modify.prototype.unselectFeatures=function(e){e=e||[];const t=this,r=t.selectInteraction?t.selectInteraction.getFeatures():null;if(r){const n=[];r.getArray().slice().forEach(function(t){if(!e.length||e.indexOf(t)>=0){r.remove(t);n[n.length]=t._wrap.parent}});n.length&&t.parent.trigger(TC.Consts.event.FEATURESUNSELECT,{features:n})}};TC.wrap.control.Edit.prototype.activate=function(e){this.cancel(!0);e===TC.Consts.editMode.SELECT&&TC.wrap.control.Modify.prototype.activate.call(this)};TC.wrap.control.Edit.prototype.deactivate=function(){var e=this;TC.wrap.control.Modify.prototype.deactivate.call(e);if(e.drawInteraction){e.drawInteraction.abortDrawing_();e.drawInteraction.setActive(!1);e.parent.map.wrap.getMap().then(function(t){t.removeInteraction(e.drawInteraction);e.drawInteraction=null})}e.parent.trigger(TC.Consts.event.CONTROLDEACTIVATE,{ctrl:e})};TC.wrap.control.Edit.prototype.cancel=function(e,t){this.points=[];this.histPoints=[];this.control&&this.control.layer||this.modifyInteraction&&this.modifyInteraction.layer;if(this.selectInteraction){var r=this.selectInteraction.getFeatures();this.parent.trigger(TC.Consts.event.FEATURESUNSELECT,{ctrl:this.parent,feature:r.get(0)});r.clear();this.selectInteraction.setActive(!1)}};TC.wrap.control.Edit.prototype.getSelectedFeatures=function(){return TC.wrap.control.Modify.prototype.getSelectedFeatures.call(this)};TC.wrap.control.Edit.prototype.setSelectedFeatures=function(e){TC.wrap.control.Modify.prototype.setSelectedFeatures.call(this,e)};TC.wrap.control.Edit.prototype.deleteFeatures=function(e){var t=this;if($.isArray(e)){var r=e.map(function(e){return e.wrap.feature});t.parent.layer.wrap.getLayer().then(function(e){for(var n=t.selectInteraction?t.selectInteraction.getFeatures():null,a=0,o=r.length;a<o;a++){var i=r[a];if(n){n.remove(i);t.parent.trigger(TC.Consts.event.FEATURESUNSELECT,{feature:i._wrap.parent})}e.getSource().removeFeature(i);t.parent.trigger(TC.Consts.event.FEATUREREMOVE,{feature:i._wrap.parent})}})}};TC.wrap.Feature.prototype.toGML=function(t,r){var n=(new e.format.GML).writeGeometryNode(this.feature.getGeometry(),{dataProjection:r});return(new XMLSerializer).serializeToString(n.firstChild).replace(/\<\/?\w/gm,function(e){var t=e.indexOf("/")>0?e.indexOf("/")+1:1;return e.substring(0,t)+"gml:"+e.substring(t)})};TC.wrap.Feature.prototype.toGeoJSON=function(){return(new e.format.GeoJSON).writeGeometry(this.feature.getGeometry())};TC.wrap.Geometry.write=function(t){var r;(t=t||{}).format;t.parser=new e.format.GeoJSON;switch(t.type){case TC.Consts.geom.POLYLINE:r=new e.geom.LineString(t.coordinates);break;case TC.Consts.geom.POLYGON:r=new e.geom.Polygon(t.coordinates);break;case TC.Consts.geom.MULTIPOINT:r=new e.geom.MultiPoint(t.coordinates);break;case TC.Consts.geom.MULTIPOLYLINE:r=new e.geom.MultiLineString(t.coordinates);break;case TC.Consts.geom.MULTIPOLYGON:r=new e.geom.MultiPolygon(t.coordinates);break;case TC.Consts.geom.POINT:default:r=new e.geom.Point(t.coordinates)}return t.parser.writeGeometry(r)};TC.wrap.Geometry.toGeoJSON=function(e){return TC.wrap.Geometry.write(e)};return e});
//# sourceMappingURL=../maps/ol/ol.min.js.map
