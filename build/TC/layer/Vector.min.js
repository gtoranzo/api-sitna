TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");TC.layer.Vector=function(){TC.Layer.apply(this,arguments);this.type=this.options.type||TC.Consts.layerType.VECTOR;this.features=[];this.selectedFeatures=[];const t=function(t){var e=(t=t||"").indexOf("?");e>=0?t=t.substr(0,e):(e=t.indexOf("#"))>=0&&(t=t.substr(0,e));return t.substr(t.lastIndexOf(".")).toLowerCase()}(this.url),e=function(t){switch(t){case TC.Consts.mimeType.KML:return TC.Consts.format.KML;case TC.Consts.mimeType.GPX:return TC.Consts.format.GPX;case TC.Consts.mimeType.JSON:case TC.Consts.mimeType.GEOJSON:return TC.Consts.format.GEOJSON;case TC.Consts.mimeType.GML:return TC.Consts.format.GML;default:return null}}(this.options.format)||function(t){switch(t){case".kml":return TC.Consts.format.KML;case".gpx":return TC.Consts.format.GPX;case".json":case".geojson":return TC.Consts.format.GEOJSON;case".gml":return TC.Consts.format.GML;case".wkt":return TC.Consts.format.WKT;case".topojson":return TC.Consts.format.TOPOJSON;default:return null}}(t);if(e||this.type===TC.Consts.layerType.KML){e===TC.Consts.format.KML&&(this.type=TC.Consts.layerType.KML);this.title=this.options.title||function(e){for(var s=e=e||"",n=new RegExp("([^/]+"+t+")","i"),r=0;r<3;r++){e=decodeURIComponent(e);var i=n.exec(e);if(i.length>1){s=i[1];break}}return s}(this.url)}this.wrap=new TC.wrap.layer.Vector(this);var s=this.wrap.createVectorLayer();this.wrap.setLayer(s);this.wrap._promise=Promise.resolve(s)};TC.inherit(TC.layer.Vector,TC.Layer);!function(){var t=TC.layer.Vector.prototype;t.getTree=function(){var t=null;if(!this.options.stealth){(t={}).children=[];for(var e=0;e<this.features.length;e++){var s=this.features[e].getPath();if(s.length){var n=TC.Util.addArrayToTree(s,t);n&&(n.legend=this.features[e].getLegend())}}t.name=this.name||t.name;t.customLegend=this.options.customLegend;t.title=this.title||t.title;t.uid=this.id}return t};var e=function(t,e,s,n){return new Promise(function(r,i){e.call(t,[s],n).then(function(e){r(e[0]);t.map&&t.map.trigger(TC.Consts.event.FEATUREADD,{layer:t,feature:e[0]})})})},s=function(t,e,s,n,r){var i=t.options.styles&&t.options.styles[n]||TC.Cfg.styles[n],o=TC.Util.extend(!0,{},i,r);return new Promise(function(n,r){var i;const a=function(){i=i||TC.feature[s];for(var r=new Array(e.length),a=[],l=0,u=e.length;l<u;l++){var C,c=e[l];const n=TC.wrap.Feature.prototype.isNative(c);if(c instanceof i||"TC.feature."+s===c.CLASSNAME)C=c;else{o.layer=t;n&&(C=c._wrap&&c._wrap.parent);C||(C=new i(c,o))}C.layer=t;r[l]=C;t.features[t.features.length]=C;n||(a[a.length]=C.wrap.feature);C.options.showPopup&&C.showPopup()}a.length&&t.wrap.addFeatures(a);n(r)};if(s)TC.loadJS(!TC.feature||TC.feature&&!TC.feature[s],[TC.apiLocation+"TC/feature/"+s],a);else{i=TC.Feature;a()}})};t.addPoint=function(t,s){return e(this,this.addPoints,t,s)};t.addPoints=function(t,e){return s(this,t,"Point",TC.Consts.geom.POINT,e)};t.addMarker=function(t,s){return e(this,this.addMarkers,t,s)};t.addMarkers=function(t,e){return s(this,t,"Marker","marker",e)};t.addPolyline=function(t,s){return e(this,this.addPolylines,t,s)};t.addPolylines=function(t,e){return s(this,t,"Polyline",TC.Consts.geom.POLYLINE,e)};t.addMultiPolyline=function(t,s){return e(this,this.addMultiPolylines,t,s)};t.addMultiPolylines=function(t,e){return s(this,t,"MultiPolyline",TC.Consts.geom.POLYLINE,e)};t.addPolygon=function(t,s){return e(this,this.addPolygons,t,s)};t.addPolygons=function(t,e){return s(this,t,"Polygon",TC.Consts.geom.POLYGON,e)};t.addMultiPolygon=function(t,s){return e(this,this.addMultiPolygons,t,s)};t.addMultiPolygons=function(t,e){return s(this,t,"MultiPolygon",TC.Consts.geom.POLYGON,e)};t.addCircle=function(t,s){return e(this,this.addCircles,t,s)};t.addCircles=function(t,e){return s(this,t,"Circle",TC.Consts.geom.POLYGON,e)};t.addFeature=function(t){const e=this;var n;TC.feature&&(n=TC.feature.Point&&t instanceof TC.feature.Point||"TC.feature.Point"===t.CLASSNAME?e.addPoint(t):TC.feature.Polyline&&t instanceof TC.feature.Polyline||"TC.feature.Polyline"===t.CLASSNAME?e.addPolyline(t):TC.feature.Polygon&&t instanceof TC.feature.Polygon||"TC.feature.Polygon"===t.CLASSNAME?e.addPolygon(t):TC.feature.MultiPolygon&&t instanceof TC.feature.MultiPolygon||"TC.feature.MultiPolygon"===t.CLASSNAME?e.addMultiPolygon(t):TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline||"TC.feature.MultiPolyline"===t.CLASSNAME?e.addMultiPolyline(t):TC.feature.Circle&&t instanceof TC.feature.Circle||"TC.feature.Circle"===t.CLASSNAME?e.addCircle(t):s(e,[t]));return n};t.removeFeature=function(t){const e=this;if(t.layer&&e.features.indexOf(t)>=0){if(e.map){e.map.getControlsByClass("TC.control.Popup").forEach(function(e){e.isVisible()&&e.currentFeature===t&&e.hide()});e.map.getControlsByClass("TC.control.ResultsPanel").forEach(function(e){e.isVisible()&&e.currentFeature===t&&e.close()})}e.wrap.removeFeature(t);t.layer=null}};t.getFeatureById=function(t){var e=null,s=this.wrap.getFeatureById(t);s&&(e=s._wrap.parent);return e};t.clearFeatures=function(){var t=this;if(t.features&&t.wrap){if(t.map){t.map.getControlsByClass("TC.control.Popup").forEach(function(e){e.isVisible()&&t.features.indexOf(e.currentFeature)>=0&&e.hide()})}t.features.length=0;t.wrap.clearFeatures()}};t.describeFeatureType=function(t,e){const s=this;new Promise(function(t,e){TC.ajax({url:s.wrap.getDescribeFeatureTypeUrl(),method:"GET",responseType:TC.Consts.mimeType.XML}).then(function(s){const n=s.data;var r="http://www.w3.org/2001/XMLSchema",i=n.getElementsByTagNameNS(r,"complexType")[0];if(i){for(var o=i.getElementsByTagNameNS(r,"element"),a=new Array(o.length),l=0,u=o.length;l<u;l++){var C=o[l];a[l]={name:C.getAttribute("name"),type:C.getAttribute("type"),nillable:"true"===C.getAttribute("nillable"),minOccurs:parseInt(C.getAttribute("minOccurs")),maxOccurs:parseInt(C.getAttribute("maxOccurs"))}}t(a)}else{var c=n.getElementsByTagName("Exception")[0];c&&e(c.getElementsByTagName("ExceptionText")[0].innerHTML)}}).catch(function(t,s,n){e(Error(n))})}).then(function(e){TC.Util.isFunction(t)&&t(e)},function(t){TC.Util.isFunction(e)&&e(t)})};t.import=function(t){this.wrap.import(t)};t.setNodeVisibility=function(t,e){this.state=TC.Layer.state.LOADING;this.map.trigger(TC.Consts.event.BEFOREUPDATE);this.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:this});this.tree||(this.tree=this.getTree());if(this.findNode(t,this.tree)===this.tree)this.setVisibility(e);else{this._cache.visibilityStates[t]=e?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;var s,n,r=!1;for(s=0;s<this.features.length;s++)if((n=this.features[s]).id==t){r=!0;n.setVisibility(e);break}if(!r)for(s=0;s<this.features.length;s++){void 0===(n=this.features[s])._path&&(n._path="/"+n.getPath().join("/"));n._path===t&&n.setVisibility(e)}}this.state=TC.Layer.state.IDLE;this.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:this});this.map.trigger(TC.Consts.event.UPDATE)};t.getNodeVisibility=function(t){var e=TC.Layer.prototype.getNodeVisibility.call(this,t);this.tree||(this.tree=this.getTree());if(this.findNode(t,this.tree)===this.tree)e=this.getVisibility()?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;else{var s=this._cache.visibilityStates[t];void 0!==s&&(e=s)}return e};t.setModifiable=function(t){this.wrap.setModifiable(t)};t.applyEdits=function(t,e,s){return this.wrap.sendTransaction(t,e,s)};t.refresh=function(){return this.wrap.reloadSource()};t.getFeaturesInCurrentExtent=function(t){var e=this.map.getExtent();return this.getFeaturesInExtent(e,t)};t.getFeaturesInExtent=function(t,e){return this.wrap.getFeaturesInExtent(t,e)};t.setProjection=function(t){const e=this;e.wrap.setProjection(t);if(t.crs&&t.oldCrs){e.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:e});e.features.forEach(function(e){e.wrap.setGeometry(TC.Util.reproject(e.geometry,t.oldCrs,t.crs));e.geometry=e.wrap.getGeometry()});e.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:e})}};t.exportState=function(t){const e=this;t=t||{};const s={id:e.id};e.map&&e.map.crs!==e.map.options.crs&&(s.crs=e.map.crs);var n=Math.pow(10,(e.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)+1);const r=t.features||e.features;s.features=r.map(function(s){const r={};var i;switch(!0){case TC.feature.Marker&&s instanceof TC.feature.Marker:r.type=TC.Consts.geom.POINT;i=e.options.styles&&e.options.styles.marker;break;case TC.feature.Point&&s instanceof TC.feature.Point:r.type=TC.Consts.geom.POINT;i=e.options.styles&&e.options.styles.point;break;case TC.feature.Polyline&&s instanceof TC.feature.Polyline:r.type=TC.Consts.geom.POLYLINE;i=e.options.styles&&e.options.styles.line;break;case TC.feature.MultiPolyline&&s instanceof TC.feature.MultiPolyline:r.type=TC.Consts.geom.MULTIPOLYLINE;i=e.options.styles&&e.options.styles.line;break;case TC.feature.Polygon&&s instanceof TC.feature.Polygon:r.type=TC.Consts.geom.POLYGON;i=e.options.styles&&e.options.styles.polygon;break;case TC.feature.MultiPolygon&&s instanceof TC.feature.MultiPolygon:r.type=TC.Consts.geom.MULTIPOLYGON;i=e.options.styles&&e.options.styles.polygon;break;case TC.feature.Circle&&s instanceof TC.feature.Circle:r.type=TC.Consts.geom.CIRCLE;i=e.options.styles&&e.options.styles.polygon}r.id=s.id;r.geom=TC.Util.compactGeometry(s.geometry,n);r.data=s.getData();r.showsPopup=s.showsPopup;if(void 0===t.exportStyles||t.exportStyles){i=TC.Util.extend({},i);for(var o in i){var a=i[o];TC.Util.isFunction(a)&&(i[o]=a(s))}r.style=TC.Util.extend(i,s.getStyle())}return r});return s};t.importState=function(t){const e=this;return new Promise(function(s,n){const r=new Array(t.features.length);t.features.forEach(function(s,n){const i=TC.Util.extend(s.style,{data:s.data,id:s.id,showsPopup:s.showsPopup});var o;switch(s.type){case TC.Consts.geom.POLYGON:o=e.addPolygon;break;case TC.Consts.geom.MULTIPOLYGON:o=e.addMultiPolygon;break;case TC.Consts.geom.POLYLINE:o=e.addPolyline;break;case TC.Consts.geom.MULTIPOLYLINE:o=e.addMultiPolyline;break;case TC.Consts.geom.CIRCLE:o=e.addCircle;break;case TC.Consts.geom.POINT:o=s.style&&(s.style.url||s.style.className)?e.addMarker:e.addPoint}if(o){var a=TC.Util.explodeGeometry(s.geom);t.crs&&e.map.crs!==t.crs?r[n]=new Promise(function(t,s){e.map.one(TC.Consts.event.PROJECTIONCHANGE,function(n){o.call(e,a,i).then(function(){t()},function(){s()})})}):r[n]=o.call(e,a,i)}});Promise.all(r).then(function(){s()},function(t){n(t instanceof Error?t:Error(t))})})}}();
//# sourceMappingURL=../maps/layer/Vector.min.js.map