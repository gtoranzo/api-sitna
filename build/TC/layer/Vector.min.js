TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");TC.layer.Vector=function(){TC.Layer.apply(this,arguments);this.type=this.options.type||TC.Consts.layerType.VECTOR;this.features=[];this.selectedFeatures=[];const e=function(e){var t=(e=e||"").indexOf("?");t>=0?e=e.substr(0,t):(t=e.indexOf("#"))>=0&&(e=e.substr(0,t));return e.substr(e.lastIndexOf(".")).toLowerCase()}(this.url),t=function(e){switch(e){case TC.Consts.mimeType.KML:return TC.Consts.format.KML;case TC.Consts.mimeType.GPX:return TC.Consts.format.GPX;case TC.Consts.mimeType.JSON:case TC.Consts.mimeType.GEOJSON:return TC.Consts.format.GEOJSON;case TC.Consts.mimeType.GML:return TC.Consts.format.GML;default:return null}}(this.options.format)||function(e){switch(e){case".kml":return TC.Consts.format.KML;case".gpx":return TC.Consts.format.GPX;case".json":case".geojson":return TC.Consts.format.GEOJSON;case".gml":return TC.Consts.format.GML;case".wkt":return TC.Consts.format.WKT;case".topojson":return TC.Consts.format.TOPOJSON;default:return null}}(e);if(t||this.type===TC.Consts.layerType.KML){t===TC.Consts.format.KML&&(this.type=TC.Consts.layerType.KML);this.title=this.options.title||function(t){for(var s=t=t||"",n=new RegExp("([^/]+"+e+")","i"),r=0;r<3;r++){t=decodeURIComponent(t);var o=n.exec(t);if(o.length>1){s=o[1];break}}return s}(this.url)}this.wrap=new TC.wrap.layer.Vector(this);var s=this.wrap.createVectorLayer();this.wrap.setLayer(s);this.wrap._promise=Promise.resolve(s)};TC.inherit(TC.layer.Vector,TC.Layer);!function(){var e=TC.layer.Vector.prototype;e.getTree=function(){var e=null;if(!this.options.stealth){(e={}).children=[];for(var t=0;t<this.features.length;t++){var s=this.features[t].getPath();if(s.length){var n=TC.Util.addArrayToTree(s,e);n&&(n.legend=this.features[t].getLegend())}}e.name=this.name||e.name;e.customLegend=this.options.customLegend;e.title=this.title||e.title;e.uid=this.id}return e};var t=function(e,t,s,n){return new Promise(function(r,o){t.call(e,[s],n).then(function(t){r(t[0]);e.map&&e.map.trigger(TC.Consts.event.FEATUREADD,{layer:e,feature:t[0]})})})},s=function(e,t,s,n,r){var o=e.options.styles&&e.options.styles[n]||TC.Cfg.styles[n],i=$.extend(!0,{},o,r);return new Promise(function(n,r){var o;const a=function(){o=o||TC.feature[s];for(var r=new Array(t.length),a=[],l=0,u=t.length;l<u;l++){var C,c=t[l];const n=TC.wrap.Feature.prototype.isNative(c);if(c instanceof o||"TC.feature."+s===c.CLASSNAME)C=c;else{i.layer=e;n&&(C=c._wrap&&c._wrap.parent);C||(C=new o(c,i))}C.layer=e;r[l]=C;e.features[e.features.length]=C;n||(a[a.length]=C.wrap.feature);C.options.showPopup&&C.showPopup()}a.length&&e.wrap.addFeatures(a);n(r)};if(s)TC.loadJS(!TC.feature||TC.feature&&!TC.feature[s],[TC.apiLocation+"TC/feature/"+s],a);else{o=TC.Feature;a()}})};e.addPoint=function(e,s){return t(this,this.addPoints,e,s)};e.addPoints=function(e,t){return s(this,e,"Point",TC.Consts.geom.POINT,t)};e.addMarker=function(e,s){return t(this,this.addMarkers,e,s)};e.addMarkers=function(e,t){return s(this,e,"Marker","marker",t)};e.addPolyline=function(e,s){return t(this,this.addPolylines,e,s)};e.addPolylines=function(e,t){return s(this,e,"Polyline",TC.Consts.geom.POLYLINE,t)};e.addMultiPolyline=function(e,s){return t(this,this.addMultiPolylines,e,s)};e.addMultiPolylines=function(e,t){return s(this,e,"MultiPolyline",TC.Consts.geom.POLYLINE,t)};e.addPolygon=function(e,s){return t(this,this.addPolygons,e,s)};e.addPolygons=function(e,t){return s(this,e,"Polygon",TC.Consts.geom.POLYGON,t)};e.addMultiPolygon=function(e,s){return t(this,this.addMultiPolygons,e,s)};e.addMultiPolygons=function(e,t){return s(this,e,"MultiPolygon",TC.Consts.geom.POLYGON,t)};e.addCircle=function(e,s){return t(this,this.addCircles,e,s)};e.addCircles=function(e,t){return s(this,e,"Circle",TC.Consts.geom.POLYGON,t)};e.addFeature=function(e){const t=this;var n;TC.feature&&(n=TC.feature.Point&&e instanceof TC.feature.Point||"TC.feature.Point"===e.CLASSNAME?t.addPoint(e):TC.feature.Polyline&&e instanceof TC.feature.Polyline||"TC.feature.Polyline"===e.CLASSNAME?t.addPolyline(e):TC.feature.Polygon&&e instanceof TC.feature.Polygon||"TC.feature.Polygon"===e.CLASSNAME?t.addPolygon(e):TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon||"TC.feature.MultiPolygon"===e.CLASSNAME?t.addMultiPolygon(e):TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline||"TC.feature.MultiPolyline"===e.CLASSNAME?t.addMultiPolyline(e):TC.feature.Circle&&e instanceof TC.feature.Circle||"TC.feature.Circle"===e.CLASSNAME?t.addCircle(e):s(t,[e]));return n};e.removeFeature=function(e){const t=this;if(e.layer&&t.features.indexOf(e)>=0){if(t.map){t.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&t.currentFeature===e&&t.hide()});t.map.getControlsByClass("TC.control.ResultsPanel").forEach(function(t){t.isVisible()&&t.currentFeature===e&&t.close()})}t.wrap.removeFeature(e);e.layer=null}};e.getFeatureById=function(e){var t=null,s=this.wrap.getFeatureById(e);s&&(t=s._wrap.parent);return t};e.clearFeatures=function(){var e=this;if(e.features&&e.wrap){if(e.map){e.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&e.features.indexOf(t.currentFeature)>=0&&t.hide()})}e.features.length=0;e.wrap.clearFeatures()}};e.describeFeatureType=function(e,t){const s=this;new Promise(function(e,t){TC.ajax({url:s.wrap.getDescribeFeatureTypeUrl(),method:"GET",responseType:TC.Consts.mimeType.XML}).then(function(s){var n="http://www.w3.org/2001/XMLSchema",r=s.getElementsByTagNameNS(n,"complexType")[0];if(r){for(var o=r.getElementsByTagNameNS(n,"element"),i=new Array(o.length),a=0,l=o.length;a<l;a++){var u=o[a];i[a]={name:u.getAttribute("name"),type:u.getAttribute("type"),nillable:"true"===u.getAttribute("nillable"),minOccurs:parseInt(u.getAttribute("minOccurs")),maxOccurs:parseInt(u.getAttribute("maxOccurs"))}}e(i)}else{var C=s.getElementsByTagName("Exception")[0];C&&t(C.getElementsByTagName("ExceptionText")[0].innerHTML)}}).catch(function(e,s,n){t(Error(n))})}).then(function(t){$.isFunction(e)&&e(t)},function(e){$.isFunction(t)&&t(e)})};e.import=function(e){this.wrap.import(e)};e.setNodeVisibility=function(e,t){this.state=TC.Layer.state.LOADING;this.map.trigger(TC.Consts.event.BEFOREUPDATE);this.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:this});this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)this.setVisibility(t);else{this._cache.visibilityStates[e]=t?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;var s,n,r=!1;for(s=0;s<this.features.length;s++)if((n=this.features[s]).id==e){r=!0;n.setVisibility(t);break}if(!r)for(s=0;s<this.features.length;s++){void 0===(n=this.features[s])._path&&(n._path="/"+n.getPath().join("/"));n._path===e&&n.setVisibility(t)}}this.state=TC.Layer.state.IDLE;this.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:this});this.map.trigger(TC.Consts.event.UPDATE)};e.getNodeVisibility=function(e){var t=TC.Layer.prototype.getNodeVisibility.call(this,e);this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)t=this.getVisibility()?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;else{var s=this._cache.visibilityStates[e];void 0!==s&&(t=s)}return t};e.setModifiable=function(e){this.wrap.setModifiable(e)};e.applyEdits=function(e,t,s){return this.wrap.sendTransaction(e,t,s)};e.refresh=function(){return this.wrap.reloadSource()};e.getFeaturesInCurrentExtent=function(e){var t=this.map.getExtent();return this.getFeaturesInExtent(t,e)};e.getFeaturesInExtent=function(e,t){return this.wrap.getFeaturesInExtent(e,t)};e.setProjection=function(e){const t=this;t.wrap.setProjection(e);if(e.crs&&e.oldCrs){t.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:t});t.features.forEach(function(t){t.wrap.setGeometry(TC.Util.reproject(t.geometry,e.oldCrs,e.crs));t.geometry=t.wrap.getGeometry()});t.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:t})}};e.exportState=function(e){const t=this;e=e||{};const s={id:t.id};t.map&&t.map.crs!==t.map.options.crs&&(s.crs=t.map.crs);var n=Math.pow(10,(t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)+1);const r=e.features||t.features;s.features=r.map(function(s){const r={};var o;switch(!0){case TC.feature.Marker&&s instanceof TC.feature.Marker:r.type=TC.Consts.geom.POINT;o=t.options.styles&&t.options.styles.marker;break;case TC.feature.Point&&s instanceof TC.feature.Point:r.type=TC.Consts.geom.POINT;o=t.options.styles&&t.options.styles.point;break;case TC.feature.Polyline&&s instanceof TC.feature.Polyline:r.type=TC.Consts.geom.POLYLINE;o=t.options.styles&&t.options.styles.line;break;case TC.feature.MultiPolyline&&s instanceof TC.feature.MultiPolyline:r.type=TC.Consts.geom.MULTIPOLYLINE;o=t.options.styles&&t.options.styles.line;break;case TC.feature.Polygon&&s instanceof TC.feature.Polygon:r.type=TC.Consts.geom.POLYGON;o=t.options.styles&&t.options.styles.polygon;break;case TC.feature.MultiPolygon&&s instanceof TC.feature.MultiPolygon:r.type=TC.Consts.geom.MULTIPOLYGON;o=t.options.styles&&t.options.styles.polygon;break;case TC.feature.Circle&&s instanceof TC.feature.Circle:r.type=TC.Consts.geom.CIRCLE;o=t.options.styles&&t.options.styles.polygon}r.id=s.id;r.geom=TC.Util.compactGeometry(s.geometry,n);r.data=s.getData();r.showsPopup=s.showsPopup;if(void 0===e.exportStyles||e.exportStyles){o=$.extend({},o);for(var i in o){var a=o[i];$.isFunction(a)&&(o[i]=a(s))}r.style=$.extend(o,s.getStyle())}return r});return s};e.importState=function(e){const t=this;return new Promise(function(s,n){const r=new Array(e.features.length);e.features.forEach(function(s,n){const o=$.extend(s.style,{data:s.data,id:s.id,showsPopup:s.showsPopup});var i;switch(s.type){case TC.Consts.geom.POLYGON:i=t.addPolygon;break;case TC.Consts.geom.MULTIPOLYGON:i=t.addMultiPolygon;break;case TC.Consts.geom.POLYLINE:i=t.addPolyline;break;case TC.Consts.geom.MULTIPOLYLINE:i=t.addMultiPolyline;break;case TC.Consts.geom.CIRCLE:i=t.addCircle;break;case TC.Consts.geom.POINT:i=s.style&&(s.style.url||s.style.className)?t.addMarker:t.addPoint}if(i){var a=TC.Util.explodeGeometry(s.geom);e.crs&&t.map.crs!==e.crs?r[n]=new Promise(function(e,s){t.map.one(TC.Consts.event.PROJECTIONCHANGE,function(n){i.call(t,a,o).then(function(){e()},function(){s()})})}):r[n]=i.call(t,a,o)}});Promise.all(r).then(function(){s()},function(e){n(e instanceof Error?e:Error(e))})})}}();
//# sourceMappingURL=../maps/layer/Vector.min.js.map
