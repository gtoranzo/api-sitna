TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");TC.Consts.BLANK_IMAGE="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7";!function(){var e={};const t=window.hasOwnProperty("Worker"),r=new Promise(function(e,r){if(t){var i=TC.apiLocation+"TC/workers/tc-caps-web-worker.js";TC.Util.isSameOrigin(TC.apiLocation)?e(i):TC.ajax({url:i,method:"GET",responseType:"text"}).then(function(t){const r=t.data;var i=new Blob([r],{type:"text/javascript"}),a=window.URL.createObjectURL(i);e(a)},function(e){r(Error(e))})}}),i=function(e,t){return"No se pudo obtener el documento de capacidades del servicio "+e.url+": ["+t+"]"},a=function(e){return new Promise(function(a,s){const o=e.getGetCapabilitiesUrl();e.toolProxification.fetch(o,{retryAttempts:2}).then(function(o){(function(e,i){var a;if(i.documentElement){const t=i.getElementsByTagName("ServiceException")[0];if(t)a={error:t.textContent};else{var s=e.type===TC.Consts.layerType.WMTS?new e.wrap.WmtsParser:new e.wrap.WmsParser;a=s.read(i);if(e.type===TC.Consts.layerType.WMTS&&a.Contents&&a.Contents.Layer){const e=i.getElementsByTagName("Layer");for(var o=0,l=e.length;o<l;o++){const t=e[o];var c=TC.Util.getElementByNodeName(t,"ows:Identifier")[0].firstChild.data,f=a.Contents.Layer.filter(function(e){return e.Identifier==c});if(f.length){f=f[0];for(var p=0;p<f.TileMatrixSetLink.length;p++){var u,g=f.TileMatrixSetLink[p];matrixId=g.TileMatrixSet;const e=t.getElementsByTagName("TileMatrixSetLink");for(var m=0,T=e.length;m<T;m++){const t=e[m];if(t.querySelector("TileMatrixSet:first").textContent==matrixId){u=t;break}}if(u){g.TileMatrixSetLimits=[];const e=u.getElementsByTagName("TileMatrixLimits");for(m=0,T=e.length;m<T;m++){const t=e[m];g.TileMatrixSetLimits.push({TileMatrix:t.getElementsByTagName("TileMatrix")[0].textContent,MinTileRow:parseInt(t.getElementsByTagName("MinTileRow")[0].textContent),MinTileCol:parseInt(t.getElementsByTagName("MinTileCol")[0].textContent),MaxTileRow:parseInt(t.getElementsByTagName("MaxTileRow")[0].textContent),MaxTileCol:parseInt(t.getElementsByTagName("MaxTileCol")[0].textContent)})}}}}}}}n(e,a);return Promise.resolve(a)}return new Promise(function(s,o){t&&"string"==typeof i?r.then(function(t){var r=new Worker(t);r.onmessage=function(t){if("success"===t.data.state){a=t.data.capabilities;n(e,a)}else o((a={error:"Web worker error"}).error);s(a);r.terminate()};r.postMessage({type:e.type,text:i})}):s(a=i)})})(e,o.responseText).then(function(t){t.error?s(Error(i(e,t.error))):a(t)}).catch(function(e){s(Error(e))})}).catch(function(t){s(Error(i(e,t)))})})},n=function(e,t){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var r=e.CAPABILITIES_STORE_KEY_PREFIX+e.options.url,i=function(){t.hasOwnProperty("error")||e.getCapabilitiesPromise().then(function(){localforage.setItem(r,t).then(function(){}).catch(function(e){console.log(e)})})};e.map?e.map.loaded(i):i()})},s=function e(t,r){var i=t.availableNames.indexOf(r.name);if(-1===i)for(var a=0,n=r.children.length;a<n&&-1===(i=e(t,r.children[a]));a++);return i},o=function e(t,r,i){var a=!1;i.count=i.count+1;if(t.name===r)a=!0;else for(var n=t.children.length-1;n>=0;n--)if(e(t.children[n],r,i)){a=!0;break}return a};TC.layer.Raster=function(){var t=this;TC.tool&&TC.tool.Proxification||TC.syncLoadJS(TC.apiLocation+"TC/tool/Proxification");this.toolProxification=new TC.tool.Proxification(TC.proxify);this._capabilitiesPromise=null;TC.Layer.apply(t,arguments);t.wrap=new TC.wrap.layer.Raster(t);t.transparent=!1!==t.options.transparent;t.url=t.options.url;t.capabilities=TC.capabilities[t.url];t.params=t.options.params;if("string"==typeof t.options.layerNames)t.names=t.availableNames=t.options.layerNames.split(",");else{t.names=[];t.availableNames=[];if(Array.isArray(t.options.layerNames))for(var r=0;r<t.options.layerNames.length;r++){if("string"==typeof(l=t.options.layerNames[r])){t.names.push(l);t.availableNames.push(l)}else if(l.hasOwnProperty("name")){t.availableNames.push(l.name);(void 0===l.isVisible||l.isVisible)&&t.names.push(l.name)}}else{var i=t.options.params?t.options.params.sld_body:null;if(i){const e=new DOMParser;var n;try{n=e.parseFromString(i,"text/xml")}catch(e){TC.error(e.message);n=null}if(n){var s=TC.Util.getElementByNodeName(n,"sld:NamedLayer");if(s&&s.length>0){var o=TC.Util.getElementByNodeName(s[0],"sld:Name");if(o&&o.length>0){var l=o[0].textContent;t.names.push(l);t.availableNames.push(l)}}}}}}t.ignorePrefixes=void 0===t.options.ignorePrefixes||t.options.ignorePrefixes;t._capabilitiesNodes={};t.wrap._promise=new Promise(function(r,i){var n=function(){var e,a;if(!t.wrap.layer){switch(t.type){case TC.Consts.layerType.GROUP:break;case TC.Consts.layerType.WMTS:e=(a=t).wrap.createWMTSLayer(a.options);break;default:e=function(e){var t=Array.isArray(e.names)?e.names.join(","):e.names,r=e.options.format,i=e.options,a={LAYERS:t,FORMAT:r,TRANSPARENT:e.transparent,VERSION:e.capabilities.version||"1.3.0"};e.params&&TC.Util.extend(a,e.params);e.queryParams&&TC.Util.extend(a,e.queryParams);var n=e.getPreferredInfoFormat();null!==n&&(a.INFO_FORMAT=n);return e.wrap.createWMSLayer(e.getGetMapUrl(),a,i)}(t)}t.wrap.setLayer(e);e?r(e):i(Error('Could not create native layer for "'+t.id+'"'))}};const s=function(e){t.capabilities=t.capabilities||e;var r=t.getGetMapUrl();TC.capabilities[t.options.url]=TC.capabilities[t.options.url]||e;TC.capabilities[r]=TC.capabilities[r]||e;n()};if(t.capabilities){s(t.capabilities);t._capabilitiesPromise=Promise.resolve(t.capabilities);return}const o=e[t.url];e[t.url]=t._capabilitiesPromise=o||new Promise(function(e,r){const i=a(t),n=(s=t,new Promise(function(e,t){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(s.CAPABILITIES_STORE_KEY_PREFIX+s.url).then(function(r){r?e(r):t(Error("Capabilities not in storage: "+s.url))}).catch(function(){t(Error("Undefined storage error"))})})}));var s;i.then(function(t){e(t)}).catch(function(e){n.catch(function(){r(e)})});n.then(function(t){e(t)}).catch(function(){i.catch(function(e){r(e)})})});t.getCapabilitiesPromise().then(function(e){s(e)}).catch(function(e){t.map&&t.map.trigger(TC.Consts.event.LAYERERROR,{layer:t,reason:"couldNotGetCapabilities"});i(e)})});t._disgregatedLayerNames=null;TC.Consts.layerType.WMTS==t.type&&t.wrap.setWMTSUrl()};TC.inherit(TC.layer.Raster,TC.Layer);var l=TC.layer.Raster.prototype;l.PROTOCOL_REGEX=/^(f|ht)tp?:\/\//i;l.capabilitiesState_={PENDING:0,DONE:1};l.CAPABILITIES_STORE_KEY_PREFIX="TC.capabilities.";l.getByProxy_=function(e){return TC.proxify(e)};l.getBySSL_=function(e){return e.replace(this.PROTOCOL_REGEX,"https://")};l.getByUrl_=function(e){return e};l.setVisibility=function(e){this.tree=null;this._cache.visibilityStates={};TC.Layer.prototype.setVisibility.call(this,e)};var c=function e(t,r,i){var a=!1,n=t.wrap.getLayerNodes(i);if(n.length){for(var s=0,o=n.length;s<o;s++)e(t,r,n[s])&&(a=!0);var l,c,f=n.map(function(e){return t.wrap.getName(e)}).reverse(),p=!1;c=l=r.indexOf(f[0]);if(l<0)p=!0;else for(s=1,o=f.length;s<o;s++)if(f[s]!=r[++l]){p=!0;break}if(!p){var u=t.wrap.getName(i);if(u&&f.length>1){r.splice(c,f.length,u);a=!0}}}return a},f=function(e,t){for(var r=[],i=t.slice(),a=e.wrap.getRootLayerNode(),n=0,s=i.length;n<s;n++)r=r.concat(p(e,i[n],a));return r},p=function e(t,r,i,a){for(var n=[],s=t.wrap.getName(i),o=t.compareNames(r,s),l=!1,c=t.wrap.getLayerNodes(i),f=0;f<c.length;f++){var p=e(t,r,c[f],a||o);p.length?n=n.concat(p):l=!0}c.length&&!l||(a||o)&&(n=[s]);return n},u=function(e){return TC.Util.extend({aggregate:!0,lazy:!1},e)},g=function(e,t,r){var i,a,n=[];i=t||[];a=r||[];for(var s=(e||[]).concat(i),o=0;o<s.length;o++)s.indexOf(s[o])===o&&-1===a.indexOf(s[o])&&(n[n.length]=s[o]);return n},m=function(e,t){var r="string"==typeof t?t.split(","):t;if(e.capabilities){var i=e.getTree();r.sort(function(e,t){var r={count:0},a={count:0};o(i,e,r);o(i,t,a);return r.count-a.count})}return r},T=function(e,t,r,i){return r.filter(function(r){return e.compareNames(t,r,i)}).length>0};l.getLimitedMatrixSet=function(){return function(e){var t=e.layerNames,r=e.matrixSet,i=e.capabilities,a=[],n=i.Contents.TileMatrixSet.filter(function(e){return e.Identifier==r});if(n.length){n=n[0];var s=i.Contents.Layer.filter(function(e){return e.Identifier==t})[0];if(s.TileMatrixSetLink&&s.TileMatrixSetLink.length&&s.TileMatrixSetLink[0].TileMatrixSetLimits){for(var o,l=s.TileMatrixSetLink[0].TileMatrixSetLimits,c=0;c<l.length;c++){o=l[c];var f=n.TileMatrix.filter(function(e){return e.Identifier==o.TileMatrix});if(f.length){var p=TC.Util.extend({matrixIndex:n.TileMatrix.indexOf(f[0])},f[0],o);a.push(p)}}return a}return n.TileMatrix}return null}(this)};l.setLayerNames=function(e,t){var r=this;return new Promise(function(i,a){r.wrap.getLayer().then(function(){var a=Array.isArray(e)?e:e.split(",");r.names=a;var n=u(t);n.aggregate&&(a=function(e,t){if(e.type!==TC.Consts.layerType.WMS)return t;var r=t.slice();c(e,r,e.wrap.getRootLayerNode());return r}(r,a));r._disgregatedLayerNames=null;var s={LAYERS:a.join(","),TRANSPARENT:!0};if(n.lazy){var o=r._newParams||r.wrap.getParams();r._newParams=TC.Util.extend(o,s)}else{r.map&&r.map.trigger(TC.Consts.event.BEFOREUPDATEPARAMS,{layer:r});r.tree=null;r._cache.visibilityStates={};r.wrap.setParams(s);!n.reset&&r.map||(r.availableNames=r.names);r.map&&r.map.trigger(TC.Consts.event.UPDATEPARAMS,{layer:r})}i(r.names)})})};l.addLayerNames=function(e,t){const r=this;return new Promise(function(i,a){r.wrap.getLayer().then(function(){var a=u(t),n=Array.isArray(e)?e:e.split(","),s=r.wrap.getParams().LAYERS;if(a.aggregate){n=f(r,n);s=r.getDisgregatedLayerNames()}r.setLayerNames(m(r,g(s,n,null)),t).then(function(e){i(e)})})})};l.removeLayerNames=function(e,t){const r=this;return new Promise(function(i,a){r.wrap.getLayer().then(function(){var a=u(t),n=Array.isArray(e)?e:e.split(","),s=r.wrap.getParams().LAYERS;if(a.aggregate){n=f(r,n);s=r.getDisgregatedLayerNames()}r.setLayerNames(m(r,g(s,null,n)),t).then(function(e){i(e)})})})};l.toggleLayerNames=function(e,t){const r=this;return new Promise(function(i,a){r.wrap.getLayer().then(function(){var a=u(t),n=Array.isArray(e)?e:e.split(","),s=r.wrap.getParams().LAYERS;if(a.aggregate){n=f(r,n);s=r.getDisgregatedLayerNames()}for(var o=[],l=[],c=0;c<n.length;c++){var p=n[c];s.indexOf(p)<0?o[o.length]=p:l[l.length]=p}var g=[];o.length>0&&g.push(r.addLayerNames(o,a));l.length>0&&g.push(r.removeLayerNames(l,a));Promise.all(g).then(function(e){const t=e[0],r=e[1];i(t?r?t.concat(r):t:[])})})})};l.getDisgregatedLayerNames=function(){var e=this.wrap.layer;if(this.wrap.isNative(e)&&this.type===TC.Consts.layerType.WMS){if(!this._disgregatedLayerNames){var t=this.wrap.getParams().LAYERS;t=Array.isArray(t)?t:t.split(",");this._disgregatedLayerNames=f(this,t)}}else this._disgregatedLayerNames=this.names;return this._disgregatedLayerNames.slice()};l.isValidFromNames=function(){for(var e=!0,t=0,r=this.names.length;t<r;t++)if(!this.getLayerNodeByName(this.names[t])){e=!1;break}return e};l.isCompatible=function(e){var t=!1;switch(this.type){case TC.Consts.layerType.WMTS:t=this.wrap.isCompatible(e)||this.wrap.getCompatibleMatrixSets(e).length>0;break;case TC.Consts.layerType.WMS:t=this.wrap.isCompatible(e)}return t};l.getCompatibleCRS=function(e){const t=this;e=e||{};var r=t.wrap.getCompatibleCRS();if(e.includeFallback&&t.fallbackLayer){const e=t.getFallbackLayer();e instanceof TC.Layer&&(r=r.concat(e.wrap.getCompatibleCRS()))}e.normalized&&(r=r.map(function(e){return TC.Util.getCRSCode(e)}).filter(function(e){return null!==e}).reduce(function(e,t){e.indexOf(t)<0&&(e[e.length]=t);return e},[]).map(function(e){return"EPSG:"+e}));return r};l.getProjection=function(){switch(this.type){case TC.Consts.layerType.WMTS:return this.wrap.layer.getSource().getProjection().getCode();case TC.Consts.layerType.WMS:return this.map.crs}};l.setProjection=function(e){if((e=e||{}).crs)switch(this.type){case TC.Consts.layerType.WMTS:var t=this.wrap.getCompatibleMatrixSets(e.crs)[0];if(t){this.matrixSet=t;this.wrap.setMatrixSet(t)}else this.wrap.setProjection(e);this.mustReproject=!t;break;case TC.Consts.layerType.WMS:this.wrap.setProjection(e);this.mustReproject=!this.isCompatible(e.crs)}};l.isVisibleByScale=function(e,t){var r,i,a,n=this,s=function(){return n.map.wrap.getResolution()*n.map.getMetersPerUnit()/28e-5};switch(n.type){case TC.Consts.layerType.WMTS:r=!1;var o=n.wrap.getTileMatrix(n.options.matrixSet);if(o){i=s();for(a=0;a<o.length;a++){if((p=n.wrap.getScaleDenominators(o[a]))[0]===i){r=!0;break}}}break;case TC.Consts.layerType.WMS:r=!0;var l=n.wrap.getAllLayerNodes();if(l.length>0){i=s();var c;if(parseInt(e).toString()===e)c=n._capabilitiesNodes[e];else for(a=0;a<l.length;a++){var f=l[a];if(n.compareNames(n.wrap.getName(f),e,t)){c=f;break}}if(c){var p=n.wrap.getScaleDenominators(c);if(!(r=!(parseFloat(p[1])>i||parseFloat(p[0])<i))&&c.Layer&&c.Layer.length>0)return c.Layer.some(function(e){var t=n.wrap.getScaleDenominators(e);return!(parseFloat(t[1])>i||parseFloat(t[0])<i)})}}break;default:r=!0}return r};l.isVisibleByName=function(e,t){var r=this,i=!1;switch(r.type){case TC.Consts.layerType.WMTS:if(r.wrap.getWMTSLayer()){i=!0;break}break;case TC.Consts.layerType.WMS:var a=function e(i,a){var n=null,s=r.wrap.getName(a);if(r.compareNames(s,i,t))n=[s];else for(var o=r.wrap.getLayerNodes(a),l=0;l<o.length;l++){var c=e(i,o[l]);if(c){TC.Util.fastUnshift(c,s);n=c;break}}return n},n=function(e){return a(e,r.wrap.getRootLayerNode())}(e);if(n)for(var s=0;s<n.length;s++)if(T(r,n[s],r.names)){i=!0;break}break;default:i=!0}return i};l.getTree=function(){var e=this,t=e.tree;if(!t){var r,i=function t(i,a,n){var s;for(var o in e._capabilitiesNodes)if(e._capabilitiesNodes[o]===i){s=o;break}if(!s){s=TC.getUID();e._capabilitiesNodes[s]=i}var l,c,f={name:e.wrap.getName(i),title:i.title||i.Title,uid:s,children:[]};n&&(r=f);T(e,f.name,e.availableNames)&&(a=!0);if(e.options.isBase){f.name=e.names.join(",");f.title=e.title||f.title;f.isBase=e.isDefault;e.options.thumbnail&&(f.legend={src:e.options.thumbnail})}else{f.isVisible=f===r?e.getVisibility():e.isVisibleByName(f.name);var p,u=e.wrap.getLayerNodes(i);for(p=0;p<u.length;p++){var g=t(u[p],a);g&&(l=f,c=g,e.options.inverseTree?TC.Util.fastUnshift(l.children,c):l.children[l.children.length]=c)}f.legend=e.wrap.getLegend(i);if(!a&&!n){r.children=r.children.concat(f.children);f=null}}return f};switch(e.type){case TC.Consts.layerType.WMTS:t=i(e.wrap.getWMTSLayer(),!e.options.hideTree,!0);break;case TC.Consts.layerType.WMS:if(e.capabilities){t=i(e.wrap.getRootLayerNode(),!e.options.hideTree,!0);var a=e._cache.visibilityStates;!function e(t){var r=TC.Consts.visibility.NOT_VISIBLE;if(t){if(void 0!==a[t.uid])r=a[t.uid];else{if(t.children)for(var i=!1,n=!1,s=0,o=t.children.length;s<o;s++){switch(e(t.children[s])){case TC.Consts.visibility.VISIBLE:i=!0;break;case TC.Consts.visibility.NOT_VISIBLE:n=!0;break;case TC.Consts.visibility.HAS_VISIBLE:i=!0;n=!0}i&&(r=n?TC.Consts.visibility.HAS_VISIBLE:TC.Consts.visibility.VISIBLE)}t.isVisible&&(r=TC.Consts.visibility.VISIBLE);a[t.uid]=r}t.visibilityState=r}return r}(t);e.options.hideTree&&function e(t,r){r.children.sort(function(e,r){return s(t,r)-s(t,e)});for(var i=0,a=r.children.length;i<a;i++)e(t,r.children[i])}(e,t)}}t||(t={name:e.name,title:e.title});t.title=e.title||t.title;t.customLegend=e.customLegend||t.customLegend;e.tree=t}return t};l.setNodeVisibility=function(e,t){var r=this;r.tree||(r.tree=r.getTree());var i=r.findNode(e,r.tree);if(i===r.tree)t&&0===r.names.length?r.addLayerNames(r.availableNames).then(function(){r.setVisibility(!0)}):r.setVisibility(t);else{var a=function e(t){var r=[];if(t.name)r[0]=t.name;else for(var i=0;i<t.children.length;i++)r=r.concat(e(t.children[i]));return r}(i);t?r.addLayerNames(a):r.removeLayerNames(a)}};l.getNodeVisibility=function(e){this.tree||(this.tree=this.getTree());return this._cache.visibilityStates[e]};l.getNodePath=function(e,t){var r=this,i=[];if(r.type===TC.Consts.layerType.WMS&&r.capabilities){e=e||r.names[0];i=function i(a){var n=[],s=r.wrap.getName(a);if(r.compareNames(s,e,t))n.push(a);else for(var o=r.wrap.getLayerNodes(a),l=0;l<o.length;l++){var c=i(o[l]);if(c.length){n=c;TC.Util.fastUnshift(n,a);break}}return n}(r.wrap.getRootLayerNode())}return i};l.getPath=function(e,t){return this.getNodePath(e,t).map(function(e){return e.title||e.Title})};l.getLayerNodeByName=function(e){for(var t=null,r=this.wrap.getServiceType()===TC.Consts.layerType.WMTS?this.wrap.getIdentifier:this.wrap.getName,i=this.wrap.getAllLayerNodes(),a=0,n=i.length;a<n;a++)if(this.compareNames(r(i[a]),e)){t=i[a];break}return t};l.getChildrenLayers=function(e){var t=[],r=function(e,t){if(e&&e.Layer&&e.Layer.length)for(var i=0;i<e.Layer.length;i++){t[t.length]=e.Layer[i];r(e.Layer[i],t)}};r(e,t);return t};l.compareNames=function(e,t,r){var i=e===t,a=void 0!==r?r:this.ignorePrefixes;if(!i&&a&&e&&t){var n=e.indexOf(":"),s=t.indexOf(":");n>=0&&s<0?i=e.substr(n+1)===t:s>=0&&n<0&&(i=e===t.substr(s+1))}return i};l.getCapabilitiesPromise=function(){return this._capabilitiesPromise};l.getResolutions=function(){return this.wrap.getResolutions()};l.setResolutions=function(e){this.wrap.setResolutions(e)};l.searchSubLayers=function(e){this.patternFn||(this.patternFn=function(e){return e=(e=(e=(e=(e=(e=(e=e.replace(/[^a-z\d\xe1\xe9\xed\xf3\xfa\xfc\xf1]/gi,"\\$&")).replace(/(a|\xe1)/gi,"(a|\xe1)")).replace(/(e|\xe9)/gi,"(e|\xe9)")).replace(/(i|\xed)/gi,"(i|\xed)")).replace(/(o|\xf3)/gi,"(o|\xf3)")).replace(/(u|\xfa|\xfc)/gi,"(u|\xfa|\xfc)")).replace(/n/gi,"(n|\xf1)")});if(e&&e.length&&e.length>=3){var t=this,r=null;if(this.lastPattern&&e.indexOf(this.lastPattern)>=0)r=this.lastMatches;else if(t.availableNames&&t.availableNames.length>0){r=[];for(var i=0;i<t.availableNames.length;i++){var a=t.getLayerNodeByName(t.availableNames[i]);if(a){r[r.length]=a;r=r.concat(t.getChildrenLayers(a))}}}else r=t.wrap.getAllLayerNodes();var n=this.patternFn(e),s=new RegExp(n,"i"),o=r.map(function(e,r){delete e.tcScore;e.tcPosition=r;t.wrap.normalizeLayerNode(e);var i=e.Title.trim(),a=s.exec(i),n=a?a.index:-1,o=-1;if(e.Abstract){var l=e.Abstract.trim(),c=s.exec(l);o=c?c.index:-1}a&&i==a[0]?e.tcScore=20:0==n?e.tcScore=15:n>-1?e.tcScore=10:0==o?e.tcScore=5:o>-1&&(e.tcScore=1);return e.tcScore?e:null}).filter(function(e){return null!=e}).sort(function(e,t){if(t.tcScore===e.tcScore){var r=TC.Util.replaceAccent(e.Title),i=TC.Util.replaceAccent(t.Title);return r<i?-1:r>i?1:0}return t.tcScore-e.tcScore});this.lastPattern=e;this.lastMatches=o;return o}return[]};l.getGetCapabilitiesUrl=function(){const e=this;var t;const r=e.url,i={};if(e.type===TC.Consts.layerType.WMTS)if(e.options.encoding===TC.Consts.WMTSEncoding.RESTFUL){var a="/1.0.0/WMTSCapabilities.xml";const e=r.indexOf(a);if(e<0||e<r.length-a.length){"/"===r[r.length-1]&&(a=a.substr(1));t=r+a}else t=r}else{t=r;i.SERVICE="WMTS";i.VERSION="1.0.0";i.REQUEST="GetCapabilities"}else{t=r;i.SERVICE="WMS";i.VERSION="1.3.0";i.REQUEST="GetCapabilities"}return t=t+"?"+TC.Util.getParamString(TC.Util.extend(i,e.queryParams))};l.getGetMapUrl=function(){return function(e){var t=e;if(e){var r=e.match(/\??SERVICE=\w+&/i);r&&(t=t.replace(r[0],""))}return t}(this.wrap.getGetMapUrl())};l.getPreferredInfoFormat=function(){var e=null;const t=this.wrap.getInfoFormats();if(t)for(var r=0;r<TC.wrap.layer.Raster.infoFormatPreference.length;r++){var i=TC.wrap.layer.Raster.infoFormatPreference[r];if(t.indexOf(i)>=0){e=i;break}}return e};l.getLegendGraphicImage=function(){const e=this;return new Promise(function(t,r){if(e.options.params.base64LegendSrc)return t(e.options.params.base64LegendSrc);if("function"==typeof window.btoa){for(var i=e.names[0],a=e.wrap.getInfo(i),n=new XMLHttpRequest,s=a.legend[0].src.split("?"),o=s[1].split("&"),l=e.options.params.sld_body?"sld_body="+e.options.params.sld_body:"",c=0;c<o.length;c++){var f=o[c].split("=");f&&f.length>1&&f[1]&&(l+="&"+o[c])}e.options.params.env&&(l+="&"+e.options.params.env);n.open("POST",s[0],!0);n.setRequestHeader("Content-Type","application/x-www-form-urlencoded");n.responseType="arraybuffer";n.onload=function(r){if(200===this.status){for(var i=new Uint8Array(this.response),a=i.length,s=new Array(a);a--;)s[a]=String.fromCharCode(i[a]);var o=s.join(""),l=n.getResponseHeader("content-type");if(0===l.indexOf("image")){var c;c="data:"+l+";base64,"+window.btoa(o);e.options.params.base64LegendSrc=c;t(c)}}};n.send(l)}else r(Error("Funci\xf3n window.btoa no soportada por el navegador"))})};l.getUrl=function(e){return e};l.getWebGLUrl=function(e,t){const r=this;return new Promise(function(t,i){var a=!TC.Util.isSecureURL(e)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(r.url))?r.getBySSL_(e):e;if(r.ignoreProxification)t(a);else{const e={exportable:!0,ignoreProxification:r.ignoreProxification};r.toolProxification.fetchImage(a,e).then(function(){r.toolProxification.cacheHost.getAction(a,e).then(function(e){e&&e.action&&t(e.action.call(r.toolProxification,a))})}).catch(function(e){i(Error(e))})}})};l.getFeatureUrl=function(e){var t=this;return t.toolProxification.fetch(e).then(function(){return t.toolProxification.cacheHost.getAction(e).then(function(r){return r.action.call(t.toolProxification,e)}).catch(function(e){return Promise.reject(e)})}).catch(function(e){return Promise.reject(e)})};l.getSiblingLoadedLayer=function(e){var t=this;if(t.map){return t.map.baseLayers.slice(0).concat(t.map.workLayers.slice(0)).filter(function(r){return(r.type===TC.Consts.layerType.WMS||r.type===TC.Consts.layerType.WMTS)&&(r.capabilities===t.capabilities||r.url===t.url)&&(!TC.Util.isFunction(e)||e(r))})[0]||null}return null};l.getImageLoad=function(e,t,r){const i=this,a=function(t){var r=e.getImage();TC.Util.isSameOrigin(t.src)||(!i.map||i.map&&i.map.mustBeExportable)&&(r.crossOrigin=null!==t.crossOrigin?t.crossOrigin:"anonymous");r.setAttribute("src",t.src);y.call(i).trigger(TC.Consts.event.TILELOAD,{tile:e})};if(i.names&&i.names.length>0){const r=function(t){y.call(i).trigger(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:t.status,text:t.statusText}});a({src:TC.Consts.BLANK_IMAGE})};if(i.type===TC.Consts.layerType.WMTS){var n,s,o;if("KVP"!=i.encoding){var l=t.replace("."+i.format.split("/")[1],"");n=(c=l.split("/").slice(l.split("/").length-3).map(function(e){return parseInt(e)}))[0];s=c[1];o=c[2]}else{var c;if((c=/.*TileMatrix=(\d*)&TileCol=(\d*)&TileRow=(\d*)/i.exec(t))&&4==c.length){n=(c=c.slice(1).map(function(e){return parseInt(e)}))[0];s=c[2];o=c[1]}}if(n&&s&&o){var f=i.wrap.getWMTSLayer();if(f){var p=f.TileMatrixSetLink.filter(function(e){return e.TileMatrixSet===i.matrixSet});if(p.length>0&&p[0].TileMatrixSetLimits.length>0){var u=p[0].TileMatrixSetLimits.sort(function(e,t){return parseInt(e.TileMatrix)>parseInt(t.TileMatrix)?1:parseInt(e.TileMatrix)<parseInt(t.TileMatrix)?-1:0})[n];if(u&&i.map&&i.map.on3DView&&!(u.MinTileRow<=s&&u.MaxTileRow>=s&&u.MinTileCol<=o&&u.MaxTileCol>=o)){console.log("Prevenimos petici\xf3n fuera de matrix set, cargamos imagen en blanco");a({src:TC.Consts.BLANK_IMAGE});return}}}}}y.call(i).trigger(TC.Consts.event.BEFORETILELOAD,{tile:e});var g="";if("POST"===i.options.method){var m=t.split("?");g=m[1].split("&").filter(function(e){const t=e.split("=");return t.length>1&&t[1].trim().length>0&&"layers"!==t[0].trim().toLowerCase()}).join("&");i.toolProxification.fetchImageAsBlob(m[0],{type:"POST",data:g,contentType:"application/x-www-form-urlencoded"}).then(function(t){const r=URL.createObjectURL(t);e.getImage().onload=function(e){URL.revokeObjectURL(r)};a({src:r})}).catch(r)}else if(i.ignoreProxification){a({src:t});var T=e.getImage();TC.Util.isSameOrigin(t)||(!i.map||i.map&&i.map.mustBeExportable)&&(T.crossOrigin="anonymous");T.onload=function(){y.call(i).trigger(TC.Consts.event.TILELOAD,{tile:e})};T.onerror=function(t){T.src=TC.Consts.BLANK_IMAGE;y.call(i).trigger(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:t.status,text:t.statusText}})};T.src=i.names.length?t:TC.Consts.BLANK_IMAGE}else i.toolProxification.fetchImage(t,{exportable:!i.map||i.map&&i.map.mustBeExportable}).then(function(e){a(e)}).catch(r)}else{a({src:TC.Consts.BLANK_IMAGE});y.call(i).trigger(TC.Consts.event.TILELOAD,{tile:e})}};var y=function(){const e=this;return e.wrap&&e.wrap.$events?e.wrap.$events:null};l.getWFSCapabilitiesPromise=function(){const e=this;"undefined"==typeof WFSCapabilities&&TC.syncLoadJS(TC.apiLocation+"TC/layer/WFSCapabilitiesParser");const t=this.options.url.replace(/wms/gi,"wfs"),r=!TC.Util.isSecureURL(t)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(t))?e.getBySSL_(t):t,i=t.substring(t.indexOf("://")<0?0:t.indexOf("://")+3);if(TC.WFScapabilities[i])return TC.WFScapabilities[i]instanceof Promise?TC.WFScapabilities[i]:new Promise(function(e,t){setTimeout(function(){e(TC.WFScapabilities[i])},100)});TC.WFScapabilities[i]=new Promise(function(t,a){var n={SERVICE:"WFS",VERSION:"2.0.0",REQUEST:"GetCapabilities"},s=e.getUrl(r+"?"+TC.Util.getParamString(n));e.toolProxification.fetch(s,{retryAttempts:2}).then(function(e){var r,n;const s=e.responseText&&(e.responseText.ownerDocument||e.responseText).documentElement;var o=(n=!!s&&"HTML"!==s.nodeName?e.responseText:(new DOMParser).parseFromString(e.responseText,"text/xml")).getElementsByTagName("ServiceException")[0];o||(o=n.getElementsByTagName("ExceptionText")[0]);if(o)a(Error(o.innerHTML));else{try{r=WFSCapabilities.Parse(n)}catch(e){a(e instanceof Error?e:Error(e));return}if(r.Operations){var l=r.Operations.GetCapabilities.DCP&&r.Operations.GetCapabilities.DCP.HTTP.Get["xlink:href"]||r.Operations.GetCapabilities.DCPType[0].HTTP.Get.onlineResource;TC.WFScapabilities[l]=r;TC.WFScapabilities[i]=r;t(r)}else a(null)}}).catch(function(e){a(e instanceof Error?e:Error(e))})});return TC.WFScapabilities[i]};l.getFallbackLayer=function(){const e=this;if(e.fallbackLayer instanceof TC.Layer)return e.fallbackLayer;if(e.options.fallbackLayer){var t=e.options.fallbackLayer;if("string"==typeof t){(e.map?e.map.options.availableBaseLayers:TC.Cfg.availableBaseLayers).forEach(function(t){if(e.options.fallbackLayer===t.id){e.fallbackLayer=new TC.layer.Raster(TC.Util.extend({},t,{isBase:!0,stealth:!0,map:e.map}));e.fallbackLayer.firstOption=e}})}else if(t instanceof TC.Layer){e.fallbackLayer=t;e.fallbackLayer.firstOption=e}else{e.fallbackLayer=new TC.layer.Raster(TC.Util.extend({},t,{id:TC.getUID(),isBase:!0,stealth:!0,title:layer.title,map:e.map}));e.fallbackLayer.firstOption=e}return e.fallbackLayer}return null}}();var esriParser={parse:function(e){var t=[],r=(new DOMParser).parseFromString(e,"text/xml");if("FeatureInfoResponse"===r.documentElement.tagName)for(var i=r.documentElement.getElementsByTagName("FeatureInfoCollection"),a=0,n=i.length;a<n;a++)for(var s=i[a],o=s.getAttribute("layername"),l=s.getElementsByTagName("FeatureInfo"),c=0,f=l.length;c<f;c++){for(var p=l[c].getElementsByTagName("Field"),u={},g=0,m=p.length;g<m;g++){var T=p[g];u[getElementText(T.getElementsByTagName("FieldName")[0])]=getElementText(T.getElementsByTagName("FieldValue")[0])}var y=new ol.Feature(u);y.setId(o+"."+TC.getUID());t[t.length]=y}return t}};
//# sourceMappingURL=../maps/layer/Raster.min.js.map