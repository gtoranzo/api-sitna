{"version":3,"sources":["ol/ol.js"],"names":["root","factory","define","amd","exports","module","require","ol","this","Math","hypot","y","length","arguments","i","Infinity","sqrt","lastTime","vendors","x","window","requestAnimationFrame","cancelAnimationFrame","callback","element","currTime","Date","getTime","timeToCall","max","id","setTimeout","clearTimeout","cssUrl","TC","url","substr","lastIndexOf","proj","get","metersPerUnit_","EPSG4326","METERS_PER_UNIT","oldGet","projectionLike","trim","loadProjDef","crs","sync","call","format","GMLBase","prototype","readGeometryElement","node","objectStack","context","firstElementChild","getAttribute","GML2CRS84","GML3CRS84","srsName","Error","dataProjection","geometry","xml","pushParseAndPop","GEOMETRY_PARSERS_","Feature","transformWithOptions","readFeatureElement","n","geometryName","fid","getAttributeNS","GMLNS","values","nextElementSibling","localName","childNodes","firstChild","nodeType","value","getAllTextContent","ONLY_WHITESPACE_RE_","test","undefined","feature","setGeometryName","setId","GML3","_writePosList_","writePosList_","point","getCoordinates","setAttribute","_getCoords_","getCoords_","opt_srsName","result","_writePos_","writePos_","XSD","writeStringTextNode","gmlNamespace","gml32Namespace","MULTIPOINT_PARSERS_","MULTILINESTRING_PARSERS_","MULTIPOLYGON_PARSERS_","POINTMEMBER_PARSERS_","LINESTRINGMEMBER_PARSERS_","POLYGONMEMBER_PARSERS_","RING_PARSERS","GEOMETRY_FLAT_COORDINATES_PARSERS_","FLAT_LINEAR_RINGS_PARSERS_","MULTICURVE_PARSERS_","MULTISURFACE_PARSERS_","CURVEMEMBER_PARSERS_","SURFACEMEMBER_PARSERS_","SURFACE_PARSERS_","CURVE_PARSERS_","ENVELOPE_PARSERS_","PATCHES_PARSERS_","SEGMENTS_PARSERS_","KML","_createStyleDefaults_","createStyleDefaults_","DEFAULT_FILL_STYLE_","color_","getRGBA","Cfg","styles","polygon","fillColor","fillOpacity","DEFAULT_TEXT_STYLE_","fill_","style","Fill","color","DEFAULT_COLOR_","DEFAULT_STROKE_STYLE_","line","strokeColor","width_","strokeWidth","DEFAULT_STYLE_ARRAY_","_readDocumentOrFolder_","readDocumentOrFolder_","apply","$","isArray","_folders","nameElm","getElementsByTagName","Util","fastUnshift","innerHTML","textContent","readText_","asserts","assert","Node","ELEMENT_NODE","BALLOON_STYLE_PARSERS_","makeStructureNS","NAMESPACE_URIS_","text","makeObjectPropertySetter","BalloonStyleParser_","object","goog","isDef","styleObject","isObject","textStyle","Text","key","STYLE_PARSERS_","readStyle_","fillStyle","fill","imageStyle","DEFAULT_IMAGE_STYLE_","DEFAULT_NO_IMAGE_STYLE_","strokeStyle","balloonStyle","DEFAULT_BALLOON_STYLE_","Style","image","stroke","zIndex","_balloon","_readURI_","readURI_","location","protocol","indexOf","ICON_PARSERS_","href","whenParser_","a","b","c","whens","d","exec","e","parseInt","f","g","h","k","l","UTC","push","GX_TRACK_PARSERS_","when","GX_NAMESPACE_URIS_","coord","gxCoordParser_","readFeatures","source","opt_options","startIdx","tag","parse","toLowerCase","customKMLNameSpaceURIS","split","namespaces","namespaceURISmanage","XMLFeature","readDateTime","GPX","RTEPT_PARSERS_","ele","readDecimal","time","TRKPT_PARSERS_","WPT_PARSERS_","magvar","geoidheight","name","readString","cmt","desc","src","link","parseLink_","sym","type","fix","sat","readNonNegativeInteger","hdop","vdop","pdop","ageofdgpsdata","dgpsid","extensions","parseExtensions_","writeDateTimeTextNode","dateTime","date","string","getUTCFullYear","padNumber","getUTCMonth","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","appendChild","DOCUMENT","createTextNode","WPT_TYPE_SERIALIZERS_","makeChildAppender","writeDecimalTextNode","writeLink_","writeNonNegativeIntegerTextNode","hitTolerance","detectMouse","getAllCombinations","array","combi","temp","len","pow","j","join","cleanCombinationsByFormat","customURIS","formatURIS","index","splice","setNewParsersByFormat","parsers","parser","analogFormat","KML_PARSERS","DATA_PARSERS_","EXTENDED_DATA_PARSERS_","REGION_PARSERS_","LAT_LON_ALT_BOX_PARSERS_","LOD_PARSERS_","EXTRUDE_AND_ALTITUDE_MODE_PARSERS_","FLAT_LINEAR_RING_PARSERS_","ICON_STYLE_PARSERS_","INNER_BOUNDARY_IS_PARSERS_","LABEL_STYLE_PARSERS_","LINE_STYLE_PARSERS_","MULTI_GEOMETRY_PARSERS_","GX_MULTITRACK_GEOMETRY_PARSERS_","NETWORK_LINK_PARSERS_","LINK_PARSERS_","OUTER_BOUNDARY_IS_PARSERS_","PAIR_PARSERS_","PLACEMARK_PARSERS_","POLY_STYLE_PARSERS_","SCHEMA_DATA_PARSERS_","STYLE_MAP_PARSERS_","slice","concat","GPX_PARSERS","GPX_PARSERS_","RTE_PARSERS_","TRK_PARSERS_","TRKSEG_PARSERS_","LINK_SERIALIZERS_","RTE_SEQUENCE_","RTE_SERIALIZERS_","RTEPT_TYPE_SEQUENCE_","TRK_SEQUENCE_","TRK_SERIALIZERS_","TRKSEG_SERIALIZERS_","WPT_TYPE_SEQUENCE_","GPX_SERIALIZERS_","customGPXNameSpaceURIS","GML3Patched","options","GML","FEATURE_COLLECTION_PARSERS","makeArrayPusher","readFeaturesInternal","DEBUG","console","features","gmlnsCollectionParser","namespaceURI","ii","featureType","featureNS","child","ft","nodeName","pop","count","uri","candidate","ns","parsersNS","featureTypes","Array","p","makeReplacer","checkFeatureGeometry","feat","geom","getGeometry","getProperties","hasOwnProperty","getGeometryName","flatCoordinates","inherits","GML2","View","getValueForResolutionFunction","opt_power","power","maxResolution","maxResolution_","minResolution","minResolution_","log","resolution","min","control","OverviewMap","_validateExtent_","validateExtent_","_wrap","parent","alwaysCentered","recenter_","_resetExtent_","resetExtent_","wrap","is3D","ovview","ovmap_","getView","extent","calculateExtent","get3DCameraLayer","getSource","getFeatures","coordinates","coord1","coord2","containsCoordinate","buffer","fit","oldImage","Image","inherit","detectMobile","Overlay","updateRenderedPosition","pixel","mapSize","offset","getOffset","positioning","getPositioning","setVisible","offsetX","offsetY","OverlayPositioning","BOTTOM_RIGHT","CENTER_RIGHT","TOP_RIGHT","rendered","left_","left","right","round","devicePixelRatio","right_","BOTTOM_CENTER","CENTER_CENTER","TOP_CENTER","offsetWidth","BOTTOM_LEFT","top_","top","bottom","bottom_","CENTER_LEFT","offsetHeight","opacity","asArray","getResolutionOptions","mapWrap","layer","view","map","prevRes","getResolution","pms","projection","getProjection","center","getCenter","enableRotation","maxExtent","layerForResolutions","Consts","layerType","VECTOR","getBaseLayer","maxRes","minRes","res","getResolutions","minResIx","maxResIx","resolutions","Map","setMap","self","initialExtent","proj4Obj","proj4","crsCode","projOptions","units","oProj","global","equivalentProjections","code","Projection","addEquivalentProjections","doTransform","fn","input","opt_output","opt_dimension","dimension","transformed","addEquivalentTransforms","PROJECTIONS","forward","inverse","axisOrientation","interactions","interaction","defaults","constrainResolution","viewOptions","rect","div","getBoundingClientRect","dx","width","height","dy","zoom","target","renderer","Type","CANVAS","controls","pixelRatio","getEventPixel","event","viewportPosition","viewport_","eventPosition","changedTouches","clientX","pointerEvent","clientY","_promise","Promise","resolve","manageSize","updateSize","addEventListener","events","EventType","RESIZE","one","MAPLOAD","on","MapBrowserEventType","SINGLECLICK","PRINTING","workLayers","forEach","wl","_noFeatureClicked","featuresInLayers","forEachFeatureAtPixel","showsPopup","trigger","FEATURECLICK","NOFEATURECLICK","addMoveEndListener","MapEventType","MOVEEND","ZOOM","hasListener","once","BEFOREZOOM","onChangeView","un","limitZoomLevels","getZoom","setView","render","BASELAYERCHANGE","on3DView","getViewport","MOUSEMOVE","mapTarget","getTarget","hit","activeControl","isExclusive","selectable","FEATUREOVER","cursor","getMetersPerUnit","extentInDegrees","getUnits","Units","DEGREES","getMetersPerDegree","getExtent","getUnitRatio","defaultCrs","defaultProj","newProj","normalizeProjection","units_","setProjection","baseLayer","transformExtent","unitRatio","oldView","minZoom","getMinZoom","maxZoom","getMaxZoom","getMinResolution","getMaxResolution","transformFactor","Number","POSITIVE_INFINITY","transform","newView","nearest","insertLayer","olLayer","idx","layers","getLayers","alreadyExists","getLength","item","remove","insertAt","Tile","setMaxResolution","setMinResolution","loadingTileCount","beforeTileLoadHandler","state","Layer","LOADING","BEFORELAYERUPDATE","_loadingTileCount","isRaster","$events","BEFORETILELOAD","TILELOAD","IDLE","LAYERUPDATE","removeLayer","getLayerCount","getLayerGroup","indexOfFirstVector","Vector","getLayerIndex","elm","setLayerIndex","ix","getArray","setBaseLayer","reject","setLayer","curBl","WMTS","layerProjectionOptions","oldCrs","getCode","currentResolution","newRes","sort","reduce","prev","abs","maxResolutionError","isLoaded","animate","duration","ZOOM_ANIMATION_DURATION","bind","setResolution","setExtent","applyExtent","getResolutionForExtent","constrainedResolution","EXTENT_TOLERANCE","setCenter","_setExtentPromise","finally","_timeout","getSize","getLayer","then","abstractMethod","factor","getWidth","getHeight","setPromise","coords","opts","getMap","olMap","setRotation","rotation","getRotation","getCoordinateFromPixel","xy","getPixelFromCoordinate","synchronous","isNative","isGeo","addPopup","popupCtl","draggable","loadJS","Draggabilly","apiLocation","popupDiv","getDiv","$popupDiv","classList","add","Popup","CLASS","contentDiv","menuDiv","popup","addOverlay","olMapViewport","container","parentElement","classes","DRAGGABLE","matches","stopPropagation","drag","not","handleEvent","pointer","bcr","clientWidth","pageX","clientHeight","pageY","_pointerCancel","setDragging","_currentOffset","_previousContainerPosition","setPosition","setOffset","coordDelta","position","getPosition","containerRect","moveVector","mouseMoveHandler","removeEventListener","hidePopup","currentFeature","VISIBLE","bounding","canvas","idealWidth","idealHeight","isInteger","newSize","setSize","POSTCOMPOSE","getFormatFromName","mimeType","showPointNames","GEOJSON","JSON","GeoJSON","TOPOJSON","TopoJSON","WKT","exportFeatures","nativeStyle","createNativeStyle","olFeatures","getStyle","setStyle","getFeatureStyle","getText","clone","setProperties","pointsToAdd","Point","shape","getImage","RegularShape","radius","getRadius","getStroke","diameter","getFill","document","createElement","vectorContext","toContext","getContext","size","setText","drawGeometry","newFeature","Icon","toDataURL","LineString","getCoordinateAt","Polygon","getInteriorPoint","MultiLineString","lineStrings","getLineStrings","maxLength","cur","MultiPolygon","polygons","getPolygons","maxArea","getArea","crossOrigin","values_","keysToChange","newKey","replace","featuresNode","writeFeaturesNode","featureProjection","featureCollectionNode","createElementNS","setAttributeNS","schemaLocation","removeAttribute","setGeometry","writeFeatures","isFileDrag","dataTransfer","types","handleDragEnter","DROP","preventDefault","handleDragExit","enableDragAndDrop","ddOptions","formatConstructors","splitCollection","dropTarget","ddInteraction","DragAndDrop","EventType_","ADD_FEATURES","featurePromises","createFeature","all","li","getLoadingIndicator","removeWait","_featureImportWaitId","some","FEATURESIMPORT","fileName","file","FEATURESIMPORTERROR","map_","addInteraction","dropArea","handleDrop","addWait","dropListenKeys_","listen","DRAGENTER","body","DRAGOVER","buttons","ddEnabled","loadFiles","files","getInteractions","currentTarget","undoTarget","off","handleDrop_","getVisibility","visible","getVisible","setVisibility","r","Raster","WmsParser","WMSCapabilities","WmtsParser","WMTSCapabilities","addCommonEvents","LAYERVISIBILITY","getGetMapUrl","getServiceType","WMS","dcpType","capabilities","Capability","Request","GetMap","DCPType","HTTP","Get","OnlineResource","OperationsMetadata","GetTile","DCP","fragment","createDocumentFragment","textarea","getInfoFormats","GetFeatureInfo","Format","infoFormatPreference","getWMTSLayer","Contents","TileMatrixSetLink","matrixSet","TileMatrixSet","getTileMatrix","tms","Identifier","TileMatrix","getScaleDenominators","ScaleDenominator","MinScaleDenominator","MaxScaleDenominator","getName","children","getLayerNodes","childDenominators","getAttribution","ServiceProvider","ProviderName","site","ProviderSite","ServiceIdentification","Title","Service","getInfo","layerNodes","getAllLayerNodes","compareNames","title","Abstract","legend","_traverse","o","func","getLegend","MetadataURL","metadata","md","queryable","getServiceTitle","getRootLayerNode","ignorePrefix","Name","getIdentifier","_layerList","getNodeArray","normalizeLayerNode","normalizeCapabilities","LegendURL","isCompatible","names","_isCompatible","nodes","inCrs","itemCRS","CRS","SRS","crsList","isIn","inArray","CRSCodesEqual","SupportedCRS","getCompatibleCRS","crsLists","getNodePath","otherCrsLists","filter","every","layerNames","tileMatrixSets","tmsl","getCompatibleLayers","_fnrecursive","crsToCheck","tmsList","tmsIdentifier","layerList","jj","tmsLinkList","kk","getCompatibleMatrixSets","tmsLink","setWMTSUrl","urls","getUrls","urlPattern","createWMSLayer","params","ImageWMS","ratio","imageRatio","imageLoadFunction","proxy","getImageLoad","IMAGELOADSTART","tile","IMAGELOADEND","IMAGELOADERROR","layerOptions","LAYERS","method","createWmtsSource","sourceOptions","optionsFromCapabilities","requestEncoding","encoding","setTileLoadFunction","TileEventType","TILELOADSTART","TILELOADEND","TILELOADERROR","prevFn","matrix","getLimitedMatrixSet","matrixIndex","createWMTSLayer","getParams","setParams","updateParams","setMatrixSet","newSource","extend","newResolutions","newMaxResolution","newMinResolution","setSource","ts","Geometry","getNearest","candidates","getClosestPoint","setScaleFunction","iconWidth","olFeat","setScaleForWidth","imgWidth","markerWidth","setScale","imageSize","img","naturalWidth","getSrc","getStyleValue","property","match","m","data","isFunction","getNativeStyle","isPoint","isLine","isPolygon","nativeStyleOptions","getType","getId","getData","styleOptions","cluster","Stroke","lineDash","circleOptions","isNaN","Circle","label","createNativeTextStyle","marker","anchor","anchorXUnits","anchorYUnits","styleObj","textOptions","fontSize","font","angle","PI","fontColor","labelOutlineColor","labelOutlineWidth","labelOffset","toHexString","number","toString","getHexColorFromArray","colorArray","getStyleFromNative","olStyle","getColor","getAnchor","getLineDash","reloadSource","createVectorSource","createStyles","WFS","listenerKey","getState","Observable","unByKey","addFeatures","import","oldFeatures","createFeatureFromNative","_wrapPromise","resolveFn","ctorName","getIcon","vectorOptions","internalLoader","usesGenericLoader","proxify","getMimeTypeFromUrl","loader","featureloader","xhr","getFormat","fs","newData","LAYERERROR","reason","message","outputFormat","sOrigin","serviceUrl","ajaxOptions","version","properties","Object","keys","maxFeatures","responseType","XML","gml","propertynames","pPrefix","_arrProperties","contentType","_requestUrl","ajax","feats","triggerLayerUpdate","onFeaturesAdd","FEATURESADD","CHANGE","_tcLayer","markerStyle","Cluster","distance","start","now","pCoords","cCoords","step","fromCoords","toCoords","fraction","getCurrentCoordinates","CLUSTER_ANIMATION_DURATION","clusterCache","VectorEventType","REMOVEFEATURE","ADDFEATURE","grep","elmCoords","cElm","s","addFeatureToLayer","addFn","addPoint","Polyline","addPolyline","addPolygon","addMultiPolygon","MultiPolyline","addMultiPolyline","addFeature","constructor","FEATUREREMOVE","VECTORUPDATE","CLEAR","FEATURESCLEAR","dynamicStyle","styleFunction","isDynamicStyle","obj","prop","setStyles","createVectorLayer","declutter","commit","getFeatureById","removeFeature","clearFeatures","clear","setFeatureVisibility","fillOptions","strokeOptions","displayNoneStyle","_originalStyle","findFeature","getGetFeatureUrl","getDescribeFeatureTypeUrl","sendTransaction","inserts","updates","deletes","getNativeFeature","olInserts","olUpdates","olDeletes","transaction","writeTransaction","featurePrefix","outerHTML","er","errorObj","texts","response","readTransactionResponse","catch","setDraggable","onend","onstart","olObjects","interactionOptions","Collection","Translate","TranslateEventType","TRANSLATEEND","TRANSLATESTART","detectIE","_handlerDraggablePointerMove","dragging","hasFeatureAtPixel","removeInteraction","getFeaturesInExtent","tolerance","featuresInExtent","leftCorner","rightCorner","coordinate","Click","register","_trigger","featureCount","CLICK","activate","deactivate","ScaleBar","ctl","updateElement_","ScaleLine","renderedHTML_","NavBar","zCtl","Zoom","zsCtl","ZoomSlider","frameState","viewState","requestSliderSize","setTarget","addControl","querySelectorAll","button","display","getLocaleString","zoomSlider","querySelector","refresh","renderPromise","sliderInitialized_","setThumbPosition_","POSTRENDER","NavBarHome","z2eCtl","ZoomToExtent","tipLabel","homeBtn","setInitialExtent","Coordinates","_coordsTrigger","coordsToClick","view3D","onMouseMove","getEventCoordinate","latLon","reverse","update","Geolocation","_snapTrigger","initSnap","_postcomposeTrigger","duringTrackSnap","getTrackingLine","layerTracking","hasCoordinates","showElevationMarker","ResultsPanel","layerTrack","chart","hideElevationMarker","addWaypoint","waypoint","addPosition","heading","speed","accuracy","altitudeAccuracy","altitude","last","appendCoordinate","lx","ly","storage","setSessionLocalValue","Const","LocalStorageKey","TRACKINGTEMP","formattedToStorage","Event","STATEUPDATED","moving","positionChangehandler","geoposition","setTracking","layerGPS","position_","longitude","latitude","projectedPosition","reproject","deltaMean","POSITIONCHANGE","pd","radToDeg","addCircle","accuracyCircle","geopositionTracking","firstPosition","trackCenterButton","zoomToFeatures","track","infoPanel","isVisible","doVisible","isMinimized","maximize","controlContainer","getControlsByClass","addElement","side","SIDE","LEFT","htmlElement","HIDDEN","tracking","nativeTrackingFeature","sessionwaypoint","sessionTracking","storageCRS","tcFeature","currentPositionWaiting","currentPositionTrk","getCurrentPositionInterval","getCurrentPositionRequest","errorTimeout","toast","enableHighAccuracy","timeout","setInterval","getCurrentPosition","errorCallback","navigator","geolocation","clearInterval","watchPosition","onGeolocateError","error","TIMEOUT","maximumAge","msgType","WARNING","activateButton","deactivateButton","watch","clearWatch","activateSnapping","POINTERMOVE","deactivateSnapping","snapInfo","removeOverlay","snapInfoElement","snapLine","attachedDTD","setFillStrokeStyle","endSnap","eventPixel","closestFeature","getClosestFeatureToCoordinate","closestPoint","snappingTolerance","setCoordinates","getElementsByClassName","getKeys","locale","toLocaleString","minimumFractionDigits","getZ","getM","getLayout","GeometryLayout","XYZM","z","XYZ","XYM","getRenderedHtml","html","drawTrackingData","layout","formattedFromStorage","storageData","removeTrackingProperty","notReproject","unset","export","getTrackingData","geoJSON","idRequestAnimationFrame","bufferElm","segmentsUnion","mergedIndex","ls","lineString","nextLineIndex","getLastCoordinate","nls","first","getFirstCoordinate","processImportedFeatures","importedFileName","toAdd","toRemove","maybeRemove","segments","featureToAdd","promises","ta","indices","sameName","saveTrack","trackName","importedIndex","processAdd","IMPORTEDTRACK","wait","alert","vectorSource","simulateTrackEnd","chartProgressClear","simulateMarker","simulateTrack","setCoords","animationFrameFraction","hasTime","toLength","utmCrs","arCoordinates","done","walkingSpeed","trackFilm","timestamp","stringify","loopAtFraction","simulate_paused","getCoordinateAtM","getDoneAtM","getSelectedTrack","uiSimulate","hasElevation","chartSetProgress","_getTime","from","getCoords","to","atan2","simulate_speed","delta","d3","D3C3","headingChangehandler","evt","infoOnMap","iomStyle","overFlowY","backgroundColor","getHeading","orientationChangehandler","beta","getBeta","gamma","getGamma","constrainCenter","pulsate","circle","pulsated","elapsed","setRadius","drawCircleGeometry","elevationMarker","stopEvent","getOpacity","getElement","coordsActivate","coordsDeactivate","Parser","read","syncLoadJS","ovMap","collapsed","collapsible","className","getOverviewMap","pixelRatio_","boxOverlay_","box","boxSizing","_boxElm","ovmMap","positionDrag","newTransform","dragPoint","idxStart","idxEnd","substring","dragged","cloneNode","ACTIVE","insertAdjacentElement","bottomLeft","topRight","viewport","insertBefore","containment","removeChild","_delta","centerPixel","newCenter","halfWidth","halfHeight","reset","load","olView","OVERVIEWBASELAYERCHANGE","oldLayer","newLayer","getCapabilitiesPromise","originalLayer","getFallbackLayer","defaultLayer","loadProjections","orderBy","projList","fovStyle","setColor","addLayer","draw3DCamera","camLayer","fov","enable","resizeEvent","createEvent","initEvent","dispatchEvent","disable","FeatureInfo","_clickTrigger","beforeRequest","NOFEATUREINFO","getElementText","esriXmlParser","dom","DOMParser","parseFromString","documentElement","tagName","fiCollections","fic","layerName","fInfos","lenj","fields","attributes","lenk","field","getUID","addLayerToService","service","path","getPath","getFeatureInfo","targetServices","auxInfo","requestPromises","requestDataArray","services","elem","getGetFeatureInfoUrl","targetService","assign","mapLayers","request","jQuery","disgregatedNames","getDisgregatedLayerNames","consoleRegister","params_","gfiURL","QUERY_LAYERS","INFO_FORMAT","FEATURE_COUNT","pixelTolerance","expUrl","requestData","requestedFormat","expandUrl","mapLayer","toolProxification","fetch","cacheHost","getAction","cache","originalUrl","action","responses","someSuccess","featureInsertionPoints","featureInfo","responseText","iFormat","gmlFormat","WMSGetFeatureInfo","isParentOrSame","na","nb","pa","pb","fakeLayers","found","lName","featureId","fakeLayer","compoundLayer","rawUrl","rawContent","rawFormat","responseError","status","ERROR","finfoPromises","defaultFeature","getMapLocale","isInside","responseCallback","INFO","BEFOREFEATUREINFO","GeometryFeatureInfo","hasEligibleLayers","hasLayers","_isSearching","_isDrawing","ret","beginDraw","geometryType","semaforo","drawCtrl","setActive","startDrawing_","olGeometryType","POLYLINE","GeometryType","LINE_STRING","POLYGON","Draw","setShowsPopup","points","sketchCoords_","sketchFeature_","addToDrawing_","DrawEventType","DRAWSTART","DRAWEND","_drawToken","cancelDraw","source_","WFSGetFeatureBuilder","download","arrPromises","_getServiceTitle","tree","availableLayers","availableNames","serviceObj","isVisibleByScale","getWFSCapabilitiesPromise","errors","_numMaxFeatures","Operations","FeatureTypes","titles","WFSErrors","LayersNotAvailable","serviceTitle","GetFeature","CountDefault","DefaultValue","QueryExpressions","AllowedValues","Value","QueryNotAvailable","Post","onlineResource","getFeatureUrl","url2","WFSQueryBuilder","XMLDocument","responseAsJSON","xml2json","Exception","Indeterminate","err","exceptionCode","errorThrown","ExceptionText","featFounds","numberMatched","numberOfFeatures","NumMaxFeatures","limit","NoFeatures","numFeatures","textStatus","NoValidLayers","GetFeatureNotAvailable","jqXHR","GetCapabilities","readFeaturesFromResponse","getResponseHeader","ServiceException","featureToServiceDistributor","id_","getFeaturesByGeometry","filterFeature","filterLayer","olGeometry","stride","getFlatCoordinates","bestPoint","arrRequests","intersects","responseObj","errorMsg","errorType","descripcion","serviceName","msgErrorMode","CONSOLE","featuresFound","PANANIMATIONSTART","PANANIMATIONEND","fitToView","popupBoundingRect","mapBoundingRect","topLeft","bottomRight","west","north","east","popupExt","mapExt","containsExtent","overflows","newPos","newPixelPos","_oldUpdatePixelPosition","ct","easing","percent","setDragged","updatePixelPosition","_newHandleOffsetChanged","unlisten","getChangeEventType","Property","OFFSET","handleOffsetChanged","containerStyle","setProperty","scale","getScale","canvas_","asString","createNativeFeature","geometryConstructor","featureOptions","createPoint","setData","createMarker","iconUrl","getPointIconUrl","createPolyline","createPolygon","ringCoords","pointCoord","startPoint","endPoint","createMultiPolyline","plnCoords","createMultiPolygon","pgnCoords","createCircle","nativeGeometry","geomStr","olStyles","cloneFeature","getFont","getOffsetX","getOffsetY","ringsOrPolylines","isMultiPolygon","isPolygonOrLineString","isLineString","XY","setCenterAndRadius","getPolygonLength","getLinearRings","ring","newRing","getLinearRing","flat","linearRing","getLineStringLength","readonly","layerStyle","MultiPoint","cssClass","iconOptions","getBackgroundUrlFromCss","layerStroke","setWidth","setImage","strokeChanged","setStroke","setLineDash","setFill","changed","toggleSelectedStyle","condition","setSelectedStyle","removeSelectedStyle","getInnerPoint","clipGeometry","clipBox","clipCoord","MULTI_POLYGON","area","curArea","isInsideRing","xi","yi","xj","yj","rings","MULTI_LINE_STRING","curLength","centroid","showPopup","currentExtent","_innerCentroid","closeButton","btn","hide","finfo","isEmptyObject","CLASSNAME","fStyle","getImageSize","getBounds","getTemplate","clearData","sketch","MEASUREPARTIAL","getMeasureData","mouseOverHandler","hoverCoordinate","pushCoordinate","clickHandler","_mdPx","squaredClickTolerance_","POINT","mousedownHandler","METERS","perimeter","formatArea","formatLength","mode","objects","_mousedownHandler","_clickHandler","_mouseMoveHandler","_mouseOverHandler","snapInteraction","measure","drawOptions","snapTolerance","shiftKeyOnly","hole","RECTANGLE","maxPoints","geometryFunction","end","overlay_","MEASURE","_projectionChangeHandler","oldProj","oldValue","sketchPoint_","sketchCoords","mode_","Mode_","deflate","getTransform","transformFn","inflate","drawProjectionChangeHandler","snapping","snapOptions","Snap","redoStack","persistent","popCoordinate","puntos","flyingPointContained","flyingPoint","sketchLine_","undo","redo","finishDrawing","CacheBuilder","getRequestSchemas","schema","layerId","olSource","getTileGrid","tileGrid","matrixIds","getMatrixIds","getLayerNodeByName","tmsLimits","llen","TileMatrixSetLimits","tileMatrixLimits","rlen","origin","getOrigin","tileSize","getTileSize","unitsPerTile","tml","mId","tSize","cl","floor","cr","rt","rb","tmsLimit","MinTileCol","MaxTileCol","MinTileRow","MaxTileRow","getGetTilePattern","WMTSEncoding","RESTFUL","encodeURIComponent","createHaloStroke1","createHaloStroke2","addHaloToStyle","mainStyle","haloPart1","unshift","haloPart2","updateSelectedStyle","style_","createSelectedStyle","styleFunction_","createStyleFunction","Modify","selectInteraction","select","Select","getWrapperFeature","selected","FEATURESSELECT","ctrl","deselected","FEATURESUNSELECT","modifyInteraction","modify","ModifyEventType","MODIFYEND","FEATUREMODIFY","_onMouseMove","getSelectedFeatures","setSelectedFeatures","featureOverlay_","unselectFeatures","selectedFeatures","unselectedFeatures","olFeature","Edit","cancel","editMode","SELECT","drawInteraction","abortDrawing_","CONTROLDEACTIVATE","cancelTxt","histPoints","deleteFeatures","toGML","writeGeometryNode","XMLSerializer","serializeToString","str","pos","toGeoJSON","writeGeometry","write","MULTIPOINT","MULTIPOLYLINE","MULTIPOLYGON"],"mappings":"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","sourcesContent":["; (function (root, factory) {\r\n\r\n    if (typeof define === 'function' && define.amd) {\r\n        define(['../../lib/ol/build/ol-debug'], factory);\r\n    } else if (typeof exports === 'object') {\r\n        module.exports = factory(require('../../lib/ol/build/ol-debug'));\r\n    } else {\r\n        root.ol = factory(root.ol);\r\n    }\r\n\r\n})(this, function (ol) {\r\n    Math.hypot = Math.hypot || function () {\r\n        var y = 0;\r\n        var length = arguments.length;\r\n\r\n        for (var i = 0; i < length; i++) {\r\n            if (arguments[i] === Infinity || arguments[i] === -Infinity) {\r\n                return Infinity;\r\n            }\r\n            y += arguments[i] * arguments[i];\r\n        }\r\n        return Math.sqrt(y);\r\n    };\r\n\r\n    // requestAnimationFrame polyfill\r\n    var lastTime = 0;\r\n    var vendors = ['ms', 'moz', 'webkit', 'o'];\r\n    for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {\r\n        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];\r\n        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']\r\n            || window[vendors[x] + 'CancelRequestAnimationFrame'];\r\n    }\r\n\r\n    if (!window.requestAnimationFrame)\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            var currTime = new Date().getTime();\r\n            var timeToCall = Math.max(0, 16 - (currTime - lastTime));\r\n            var id = window.setTimeout(function () { callback(currTime + timeToCall); },\r\n                timeToCall);\r\n            lastTime = currTime + timeToCall;\r\n            return id;\r\n        };\r\n\r\n    if (!window.cancelAnimationFrame)\r\n        window.cancelAnimationFrame = function (id) {\r\n            clearTimeout(id);\r\n        };\r\n\r\n    // ol patches\r\n    var MOUSEMOVE = 'mousemove';\r\n    var MOUSEOUT = 'mouseout';\r\n    var MOUSEOVER = 'mouseover';\r\n    var MOUSEENTER = 'mouseenter';\r\n\r\n    var cssUrl = TC.url.ol.substr(0, TC.url.ol.lastIndexOf('/'));\r\n    cssUrl = cssUrl.substr(0, cssUrl.lastIndexOf('/') + 1) + 'css/ol.css';\r\n    //TC.loadCSS(cssUrl);\r\n\r\n    // OpenLayers usa para las proyecciones geográficas un valor ol.proj.METERS_PER_UNIT[ol.proj.Units.DEGREES], calculado con una esfera, salvo\r\n    // EPSG:4326, en la que usa ol.proj.EPSG4326.METERS_PER_UNIT, calculado con el geoide. Esto hace que las proyecciones en EPSG:4258 salgan desplazadas,\r\n    // pese a que para todos los efectos son iguales a las EPSG:4326. Para evitar eso, introducimos en las 4258 el valor ol.proj.EPSG4326.METERS_PER_UNIT.\r\n    ol.proj.get('EPSG:4258').metersPerUnit_ = ol.proj.EPSG4326.METERS_PER_UNIT;\r\n    ol.proj.get('urn:ogc:def:crs:EPSG::4258').metersPerUnit_ = ol.proj.EPSG4326.METERS_PER_UNIT;\r\n    ol.proj.get('http://www.opengis.net/gml/srs/epsg.xml#4258').metersPerUnit_ = ol.proj.EPSG4326.METERS_PER_UNIT;\r\n\r\n    // Reescribimos la obtención de proyección para que soporte códigos tipo EPSG:X, urn:ogc:def:crs:EPSG::X y http://www.opengis.net/gml/srs/epsg.xml#X\r\n    ol.proj.oldGet = ol.proj.get;\r\n    ol.proj.get = function (projectionLike) {\r\n        if (typeof projectionLike === 'string') {\r\n            projectionLike = projectionLike.trim();\r\n            TC.loadProjDef({ crs: projectionLike, sync: true });\r\n        }\r\n        return ol.proj.oldGet.call(this, projectionLike);\r\n    };\r\n\r\n    // Reescritura de código para transformar las geometrías de getFeatureInfo que están en un CRS distinto\r\n    ol.format.GMLBase.prototype.readGeometryElement = function (node, objectStack) {\r\n        var context = /** @type {Object} */ (objectStack[0]);\r\n        context['srsName'] = node.firstElementChild.getAttribute('srsName');\r\n        /** @type {ol.geom.Geometry} */\r\n\r\n        // Parche para poder leer coordenadas en EPSG:4326 con orden incorrecto (las crea QGIS, por ejemplo)\r\n        if (this instanceof ol.format.GML2CRS84 || this instanceof ol.format.GML3CRS84) {\r\n            if (context.srsName !== 'EPSG:4326' || !context.srsName) {\r\n                throw new Error(\"Conflicto de CRS\");\r\n            }\r\n        }\r\n        if (!context.srsName) {\r\n            context.srsName = this.srsName;\r\n        }\r\n        context.dataProjection = ol.proj.get(context.srsName);\r\n        var geometry = ol.xml.pushParseAndPop(null,\r\n            this.GEOMETRY_PARSERS_, node, objectStack, this);\r\n        if (geometry) {\r\n            return /** @type {ol.geom.Geometry} */ (\r\n                ol.format.Feature.transformWithOptions(geometry, false, context));\r\n        } else {\r\n            return undefined;\r\n        }\r\n    };\r\n\r\n    // Reescritura de código para hacerlo compatible con GML generado por inspire:\r\n    // No se puede considerar geometría cualquier cosa que tenga elementos anidados.\r\n    ol.format.GMLBase.prototype.readFeatureElement = function (node, objectStack) {\r\n        var n;\r\n        var fid = node.getAttribute('fid') ||\r\n            ol.xml.getAttributeNS(node, ol.format.GMLBase.GMLNS, 'id');\r\n        var values = {}, geometryName;\r\n        for (n = node.firstElementChild; n; n = n.nextElementSibling) {\r\n            var localName = n.localName;\r\n            // Assume attribute elements have one child node and that the child\r\n            // is a text or CDATA node (to be treated as text).\r\n            // Otherwise assume it is a geometry node.\r\n            if (n.childNodes.length === 0 ||\r\n                (n.childNodes.length === 1 &&\r\n                    (n.firstChild.nodeType === 3 || n.firstChild.nodeType === 4))) {\r\n                var value = ol.xml.getAllTextContent(n, false);\r\n                if (ol.format.GMLBase.ONLY_WHITESPACE_RE_.test(value)) {\r\n                    value = undefined;\r\n                }\r\n                values[localName] = value;\r\n            } else {\r\n                values[localName] = this.readGeometryElement(n, objectStack);\r\n                // boundedBy is an extent and must not be considered as a geometry\r\n                // Tampoco referencePoint\r\n                if (localName !== 'boundedBy' && localName !== 'referencePoint') {\r\n                    geometryName = localName;\r\n                }\r\n            }\r\n        }\r\n        var feature = new ol.Feature(values);\r\n        if (geometryName) {\r\n            feature.setGeometryName(geometryName);\r\n        }\r\n        if (fid) {\r\n            feature.setId(fid);\r\n        }\r\n        return feature;\r\n    };\r\n\r\n    // Añadimos el atributo srsDimension para soportar 3D\r\n    ol.format.GML3.prototype._writePosList_ = ol.format.GML3.prototype.writePosList_;\r\n    ol.format.GML3.prototype.writePosList_ = function (node, value, objectStack) {\r\n        this._writePosList_(node, value, objectStack);\r\n        const point = value.getCoordinates()[0];\r\n        if (point && point.length > 2) {\r\n            node.setAttribute('srsDimension', point.length);\r\n        }\r\n    };\r\n\r\n    // Cambiamos getCoords_ para que soporte 3D\r\n    ol.format.GML3.prototype._getCoords_ = ol.format.GML3.prototype.getCoords_;\r\n    ol.format.GML3.prototype.getCoords_ = function (point, opt_srsName) {\r\n        var result = this._getCoords_(point, opt_srsName);\r\n        if (point.length > 2) {\r\n            result += ' ' + point[2];\r\n        }\r\n        return result;\r\n    };\r\n\r\n    // Cambiamos writePos_ para que soporte 3D\r\n    ol.format.GML3.prototype._writePos_ = ol.format.GML3.prototype.writePos_;\r\n    ol.format.GML3.prototype.writePos_ = function (node, value, objectStack) {\r\n        this._writePos_(node, value, objectStack);\r\n        const point = value.getCoordinates();\r\n        if (point.length > 2) {\r\n            ol.format.XSD.writeStringTextNode(node, ' ' + point[2]);\r\n        }\r\n    };\r\n\r\n\r\n\r\n    // Añadido el espacio de nombres de GML 3.2 al parser\r\n    var gmlNamespace = 'http://www.opengis.net/gml';\r\n    var gml32Namespace = 'http://www.opengis.net/gml/3.2';\r\n    ol.format.GMLBase.prototype.MULTIPOINT_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.MULTIPOINT_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.POINTMEMBER_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.POINTMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[gml32Namespace] = ol.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GMLBase.prototype.RING_PARSERS[gml32Namespace] = ol.format.GMLBase.prototype.RING_PARSERS[gmlNamespace];\r\n    ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.GEOMETRY_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.GEOMETRY_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.MULTICURVE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.MULTICURVE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.MULTISURFACE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.MULTISURFACE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.CURVEMEMBER_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.CURVEMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.SURFACEMEMBER_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.SURFACEMEMBER_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.SURFACE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.SURFACE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.CURVE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.CURVE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.ENVELOPE_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.ENVELOPE_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.PATCHES_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.PATCHES_PARSERS_[gmlNamespace];\r\n    ol.format.GML3.prototype.SEGMENTS_PARSERS_[gml32Namespace] = ol.format.GML3.prototype.SEGMENTS_PARSERS_[gmlNamespace];\r\n\r\n    // Rehacemos los estilos por defecto de KML para que se adecúen al de la API\r\n    ol.format.KML._createStyleDefaults_ = ol.format.KML.createStyleDefaults_;\r\n    ol.format.KML.createStyleDefaults_ = function () {\r\n        ol.format.KML._createStyleDefaults_();\r\n\r\n        ol.format.KML.DEFAULT_FILL_STYLE_.color_ = getRGBA(TC.Cfg.styles.polygon.fillColor, TC.Cfg.styles.polygon.fillOpacity);\r\n        ol.format.KML.DEFAULT_TEXT_STYLE_.fill_ = new ol.style.Fill({\r\n            color: ol.format.KML.DEFAULT_COLOR_\r\n        });\r\n        ol.format.KML.DEFAULT_STROKE_STYLE_.color_ = getRGBA(TC.Cfg.styles.line.strokeColor, 1);\r\n        ol.format.KML.DEFAULT_STROKE_STYLE_.width_ = TC.Cfg.styles.line.strokeWidth;\r\n\r\n        return ol.format.KML.DEFAULT_STYLE_ARRAY_;\r\n    };\r\n\r\n\r\n    // Reescritura de código para leer las carpetas del KML\r\n    ol.format.KML.prototype._readDocumentOrFolder_ = ol.format.KML.prototype.readDocumentOrFolder_;\r\n    ol.format.KML.prototype.readDocumentOrFolder_ = function (node, objectStack) {\r\n        var result = ol.format.KML.prototype._readDocumentOrFolder_.apply(this, arguments);\r\n        if (node.localName == \"Folder\") {\r\n            for (var i = 0; i < result.length; i++) {\r\n                var feature = result[i];\r\n                if (!$.isArray(feature._folders)) {\r\n                    feature._folders = [];\r\n                }\r\n                var nameElm = node.getElementsByTagName('name')[0];\r\n                if (nameElm) {\r\n                    //feature._folders.unshift(nameElm.innerHTML || nameElm.textContent);\r\n                    // Versión rápida de unshift\r\n                    TC.Util.fastUnshift(feature._folders, nameElm.innerHTML || nameElm.textContent);\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    // Creamos un parser para interpretar la plantilla de los bocadillos\r\n    ol.format.KML.readText_ = function (node, objectStack) {\r\n        ol.asserts.assert(node.nodeType == Node.ELEMENT_NODE);\r\n        ol.asserts.assert(node.localName == 'text');\r\n        var s = ol.xml.getAllTextContent(node, false);\r\n        return s.trim();\r\n    };\r\n\r\n    //ol.format.KML.DEFAULT_BALLOON_STYLE_ = new ol.style.Text();\r\n\r\n    ol.format.KML.BALLOON_STYLE_PARSERS_ = ol.xml.makeStructureNS(\r\n        ol.format.KML.NAMESPACE_URIS_, {\r\n            'text': ol.xml.makeObjectPropertySetter(ol.format.KML.readText_),\r\n        });\r\n\r\n    ol.format.KML.BalloonStyleParser_ = function (node, objectStack) {\r\n        ol.asserts.assert(node.nodeType == Node.ELEMENT_NODE);\r\n        ol.asserts.assert(node.localName == 'BalloonStyle');\r\n        // FIXME colorMode\r\n        var object = ol.xml.pushParseAndPop(\r\n            {}, ol.format.KML.BALLOON_STYLE_PARSERS_, node, objectStack);\r\n        if (!goog.isDef(object)) {\r\n            return;\r\n        }\r\n        var styleObject = objectStack[objectStack.length - 1];\r\n        ol.asserts.assert(goog.isObject(styleObject));\r\n        var textStyle = new ol.style.Text({\r\n            text: (object['text'])\r\n        });\r\n        styleObject['balloonStyle'] = textStyle;\r\n    };\r\n\r\n    for (var key in ol.format.KML.STYLE_PARSERS_) {\r\n        var parser = ol.format.KML.STYLE_PARSERS_[key];\r\n        parser['BalloonStyle'] = ol.format.KML.BalloonStyleParser_;\r\n    }\r\n\r\n    // Parche a esta función para meter la lectura de balloonStyle\r\n    ol.format.KML.readStyle_ = function (node, objectStack) {\r\n        var styleObject = ol.xml.pushParseAndPop(\r\n            {}, ol.format.KML.STYLE_PARSERS_, node, objectStack);\r\n        if (!styleObject) {\r\n            return null;\r\n        }\r\n        var fillStyle = /** @type {ol.style.Fill} */\r\n            ('fillStyle' in styleObject ?\r\n                styleObject['fillStyle'] : ol.format.KML.DEFAULT_FILL_STYLE_);\r\n        var fill = /** @type {boolean|undefined} */ (styleObject['fill']);\r\n        if (fill !== undefined && !fill) {\r\n            fillStyle = null;\r\n        }\r\n        var imageStyle = /** @type {ol.style.Image} */\r\n            ('imageStyle' in styleObject ?\r\n                styleObject['imageStyle'] : ol.format.KML.DEFAULT_IMAGE_STYLE_);\r\n        if (imageStyle == ol.format.KML.DEFAULT_NO_IMAGE_STYLE_) {\r\n            imageStyle = undefined;\r\n        }\r\n        var textStyle = /** @type {ol.style.Text} */\r\n            ('textStyle' in styleObject ?\r\n                styleObject['textStyle'] : ol.format.KML.DEFAULT_TEXT_STYLE_);\r\n        var strokeStyle = /** @type {ol.style.Stroke} */\r\n            ('strokeStyle' in styleObject ?\r\n                styleObject['strokeStyle'] : ol.format.KML.DEFAULT_STROKE_STYLE_);\r\n        var balloonStyle =\r\n            ('balloonStyle' in styleObject ?\r\n                styleObject['balloonStyle'] : ol.format.KML.DEFAULT_BALLOON_STYLE_);\r\n\r\n        // GLS: Comento el machaque del estilo de línea por que no haya outline, según la documentación (https://developers.google.com/kml/documentation/kmlreference#style) \r\n        // es opcional indicar outline\r\n        // Corregimos el bug 25306 No se carga el estilo de VV-del-Irati.kml\r\n        //var outline = /** @type {boolean|undefined} */\r\n        //    (styleObject['outline']);\r\n        //if (outline !== undefined && !outline) {\r\n        //    strokeStyle = null;\r\n        //}\r\n\r\n        var style = new ol.style.Style({\r\n            fill: fillStyle,\r\n            image: imageStyle,\r\n            stroke: strokeStyle,\r\n            text: textStyle,\r\n            zIndex: undefined // FIXME\r\n        });\r\n        style._balloon = balloonStyle;\r\n        return [style];\r\n    };\r\n\r\n    // flacunza: Parche para evitar peticiones HTTP desde una página HTTPS\r\n    ol.format.KML._readURI_ = ol.format.KML.readURI_;\r\n    ol.format.KML.readURI_ = function (node) {\r\n        var result = ol.format.KML._readURI_(node);\r\n        if (location.protocol === 'https:' && result.indexOf('http://') === 0) {\r\n            result = result.substr(5);\r\n        }\r\n        return result;\r\n    };\r\n    for (var key in ol.format.KML.ICON_PARSERS_) {\r\n        ol.format.KML.ICON_PARSERS_[key].href = ol.xml.makeObjectPropertySetter(ol.format.KML.readURI_);\r\n    }\r\n\r\n    // GLS: La expresión regular que valida el formato de fecha ISO no contempla que la fecha contenga fracción de segundo, según https://www.w3.org/TR/NOTE-datetime \r\n    ol.format.KML.whenParser_ = function (a, b) {\r\n        ol.asserts.assert(a.nodeType == Node.ELEMENT_NODE, \"node.nodeType should be ELEMENT\");\r\n        ol.asserts.assert(\"when\" == a.localName, \"localName should be when\");\r\n        var c = b[b.length - 1];\r\n        ol.asserts.assert(goog.isObject(c), \"gxTrackObject should be an Object\");\r\n        var c = c.whens\r\n            , d = ol.xml.getAllTextContent(a, !1);\r\n        if (d = /^\\s*(\\d{4})($|-(\\d{2})($|-(\\d{2})($|T(\\d{2}):(\\d{2}):(\\d{2})(?:.?\\d{3})?(Z|(?:([+\\-])(\\d{2})(?::(\\d{2}))?)))))\\s*$/.exec(d)) {\r\n            var e = parseInt(d[1], 10)\r\n                , f = d[3] ? parseInt(d[3],\r\n                    10) - 1 : 0\r\n                , g = d[5] ? parseInt(d[5], 10) : 1\r\n                , h = d[7] ? parseInt(d[7], 10) : 0\r\n                , k = d[8] ? parseInt(d[8], 10) : 0\r\n                , l = d[9] ? parseInt(d[9], 10) : 0\r\n                , e = Date.UTC(e, f, g, h, k, l);\r\n            d[10] && \"Z\" != d[10] && (f = \"-\" == d[11] ? -1 : 1,\r\n                e += 60 * f * parseInt(d[12], 10),\r\n                d[13] && (e += 3600 * f * parseInt(d[13], 10)));\r\n            c.push(e)\r\n        } else\r\n            c.push(0)\r\n    };\r\n\r\n    ol.format.KML.GX_TRACK_PARSERS_ = ol.xml.makeStructureNS(ol.format.KML.NAMESPACE_URIS_, {\r\n        when: ol.format.KML.whenParser_\r\n    }, ol.xml.makeStructureNS(ol.format.KML.GX_NAMESPACE_URIS_, {\r\n        coord: ol.format.KML.gxCoordParser_\r\n    }));\r\n\r\n    var namespaceURISmanage = function (source, format) {\r\n        var xml = ol.xml.parse(source);\r\n        var tag = xml.getElementsByTagName(format.toLowerCase());\r\n        if (tag && tag.length > 0) {\r\n            var value = tag[0].getAttribute('xmlns');\r\n            if (value && value.indexOf(' ') > -1 && customKMLNameSpaceURIS.indexOf(value) > -1) {\r\n                var values = value.split(' ');\r\n                var namespaces = [];\r\n                for (var i = 0; i < values.length; i++) {\r\n                    namespaces.push(('xmlns:' + format.toLowerCase() + i) + \"=\\\"\" + values[i].trim() + \"\\\"\");\r\n                }\r\n            }\r\n        }\r\n\r\n        return source;\r\n    };\r\n\r\n    // flacunza: Parcheo para poder leer KMLs generados por Google Earth. En ellos falta el atributo xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n    // que se utiliza luego en xsi:schemaLocation, haciendo que el DOMParser no lea el elemento Placemark.\r\n    ol.format.KML.prototype.readFeatures = function (source, opt_options) {\r\n        if (typeof source === 'string') {\r\n            var kmlTag = '<kml';\r\n            var startIdx = source.indexOf(kmlTag);\r\n            if (startIdx >= 0) {\r\n                startIdx += kmlTag.length;\r\n                var endIdx = source.indexOf('>', startIdx);\r\n                if (source.indexOf('xmlns:xsi=') < 0) {\r\n                    source = source.substr(0, startIdx) + ' xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"' + source.substr(startIdx);\r\n                }\r\n\r\n                source = namespaceURISmanage(source, 'KML');\r\n            }\r\n        }\r\n        return ol.format.XMLFeature.prototype.readFeatures.call(this, source, opt_options);\r\n    };\r\n\r\n    // GLS: La expresión regular que valida el formato de fecha ISO no contempla que la fecha contenga fracción de segundo, según https://www.w3.org/TR/NOTE-datetime \r\n    ol.format.XSD.readDateTime = function (a) {\r\n        a = ol.xml.getAllTextContent(a, !1);\r\n        if (a = /^\\s*(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})(Z|(?:([+\\-])(\\d{2})(?::(\\d{2}))?))\\s*$/.exec(a)) {\r\n            var b = parseInt(a[1], 10)\r\n                , c = parseInt(a[2], 10) - 1\r\n                , d = parseInt(a[3], 10)\r\n                , e = parseInt(a[4], 10)\r\n                , f = parseInt(a[5], 10)\r\n                , g = parseInt(a[6], 10)\r\n                , b = Date.UTC(b, c, d, e, f, g); // GLS quito el paso a segundos / 1E3\r\n            \"Z\" != a[7] && (c = \"-\" == a[8] ? -1 : 1,\r\n                b += 60 * c * parseInt(a[9], 10),\r\n                void 0 !== a[10] && (b += 3600 * c * parseInt(a[10], 10)));\r\n            return b\r\n        };\r\n    };\r\n\r\n    ol.format.GPX.RTEPT_PARSERS_ = ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_, {\r\n        ele: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),\r\n        time: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDateTime)\r\n    });\r\n    ol.format.GPX.TRKPT_PARSERS_ = ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_, {\r\n        ele: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),\r\n        time: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDateTime)\r\n    });\r\n    ol.format.GPX.WPT_PARSERS_ = ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_, {\r\n        ele: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),\r\n        time: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDateTime),\r\n        magvar: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),\r\n        geoidheight: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),\r\n        name: ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),\r\n        cmt: ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),\r\n        desc: ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),\r\n        src: ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),\r\n        link: ol.format.GPX.parseLink_,\r\n        sym: ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),\r\n        type: ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),\r\n        fix: ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),\r\n        sat: ol.xml.makeObjectPropertySetter(ol.format.XSD.readNonNegativeInteger),\r\n        hdop: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),\r\n        vdop: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),\r\n        pdop: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),\r\n        ageofdgpsdata: ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),\r\n        dgpsid: ol.xml.makeObjectPropertySetter(ol.format.XSD.readNonNegativeInteger),\r\n        extensions: ol.format.GPX.parseExtensions_\r\n    });\r\n\r\n    ol.format.XSD.writeDateTimeTextNode = function (node, dateTime) {\r\n        var date = new Date(dateTime);\r\n        var string = date.getUTCFullYear() + '-' +\r\n            ol.string.padNumber(date.getUTCMonth() + 1, 2) + '-' +\r\n            ol.string.padNumber(date.getUTCDate(), 2) + 'T' +\r\n            ol.string.padNumber(date.getUTCHours(), 2) + ':' +\r\n            ol.string.padNumber(date.getUTCMinutes(), 2) + ':' +\r\n            ol.string.padNumber(date.getUTCSeconds(), 2) + 'Z';\r\n        node.appendChild(ol.xml.DOCUMENT.createTextNode(string));\r\n    };\r\n\r\n    ol.format.GPX.WPT_TYPE_SERIALIZERS_ = ol.xml.makeStructureNS(\r\n        ol.format.GPX.NAMESPACE_URIS_, {\r\n            'ele': ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),\r\n            'time': ol.xml.makeChildAppender(ol.format.XSD.writeDateTimeTextNode),\r\n            'magvar': ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),\r\n            'geoidheight': ol.xml.makeChildAppender(\r\n                ol.format.XSD.writeDecimalTextNode),\r\n            'name': ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),\r\n            'cmt': ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),\r\n            'desc': ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),\r\n            'src': ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),\r\n            'link': ol.xml.makeChildAppender(ol.format.GPX.writeLink_),\r\n            'sym': ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),\r\n            'type': ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),\r\n            'fix': ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),\r\n            'sat': ol.xml.makeChildAppender(\r\n                ol.format.XSD.writeNonNegativeIntegerTextNode),\r\n            'hdop': ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),\r\n            'vdop': ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),\r\n            'pdop': ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),\r\n            'ageofdgpsdata': ol.xml.makeChildAppender(\r\n                ol.format.XSD.writeDecimalTextNode),\r\n            'dgpsid': ol.xml.makeChildAppender(\r\n                ol.format.XSD.writeNonNegativeIntegerTextNode)\r\n        });\r\n\r\n    const hitTolerance = TC.Util.detectMouse() ? 3 : 10;\r\n\r\n    // GLS: Obtenemos las combinaciones posibles\r\n    var getAllCombinations = function (array) {\r\n        var combi = [];\r\n        var temp = [];\r\n\r\n        var len = Math.pow(2, array.length);\r\n\r\n        for (var i = 0; i < len; i++) {\r\n            temp = [];\r\n            for (var j = 0; j < array.length; j++) {\r\n                if ((i & Math.pow(2, j))) {\r\n                    if (temp.indexOf(array[j]) == -1)\r\n                        temp.push(array[j]);\r\n                }\r\n            }\r\n            if (temp.length > 0) {\r\n                if (combi.indexOf(temp.join(' ')) == -1)\r\n                    combi.push(temp.join(' '));\r\n            }\r\n        }\r\n\r\n        return combi;\r\n    }\r\n\r\n    // GLS: Limpiamos de los nuevos los URIS ya disponibles en el formato\r\n    var cleanCombinationsByFormat = function (customURIS, formatURIS) {\r\n        if (customURIS && customURIS.length > 0) {\r\n            for (var i = 0; i < formatURIS.length; i++) {\r\n                var index = customURIS.indexOf(formatURIS[i]);\r\n                if (index > -1)\r\n                    customURIS.splice(index, 1);\r\n            }\r\n        }\r\n    };\r\n\r\n    // GLS: Establecemos los parser por formato para los nuevos URIS\r\n    var setNewParsersByFormat = function (parsers, customURIS) {\r\n        for (var i = 0; i < parsers.length; i++) {\r\n            var parser = parsers[i];\r\n            for (var j = 0; j < customURIS.length; j++) {\r\n                var analogFormat = customURIS[j].split(' ')[0];\r\n                parser[customURIS[j]] = parser[analogFormat];\r\n            }\r\n        }\r\n    };\r\n\r\n    var KML_PARSERS = [\r\n        ol.format.KML.DATA_PARSERS_,\r\n        ol.format.KML.EXTENDED_DATA_PARSERS_,\r\n        ol.format.KML.REGION_PARSERS_,\r\n        ol.format.KML.LAT_LON_ALT_BOX_PARSERS_,\r\n        ol.format.KML.LOD_PARSERS_,\r\n        ol.format.KML.EXTRUDE_AND_ALTITUDE_MODE_PARSERS_,\r\n        ol.format.KML.FLAT_LINEAR_RING_PARSERS_,\r\n        ol.format.KML.FLAT_LINEAR_RINGS_PARSERS_,\r\n        ol.format.KML.GX_TRACK_PARSERS_,\r\n        ol.format.KML.GEOMETRY_FLAT_COORDINATES_PARSERS_,\r\n        ol.format.KML.ICON_PARSERS_,\r\n        ol.format.KML.ICON_STYLE_PARSERS_,\r\n        ol.format.KML.INNER_BOUNDARY_IS_PARSERS_,\r\n        ol.format.KML.LABEL_STYLE_PARSERS_,\r\n        ol.format.KML.LINE_STYLE_PARSERS_,\r\n        ol.format.KML.MULTI_GEOMETRY_PARSERS_,\r\n        ol.format.KML.GX_MULTITRACK_GEOMETRY_PARSERS_,\r\n        ol.format.KML.NETWORK_LINK_PARSERS_,\r\n        ol.format.KML.LINK_PARSERS_,\r\n        ol.format.KML.OUTER_BOUNDARY_IS_PARSERS_,\r\n        ol.format.KML.PAIR_PARSERS_,\r\n        ol.format.KML.PLACEMARK_PARSERS_,\r\n        ol.format.KML.POLY_STYLE_PARSERS_,\r\n        ol.format.KML.SCHEMA_DATA_PARSERS_,\r\n        ol.format.KML.STYLE_PARSERS_,\r\n        ol.format.KML.STYLE_MAP_PARSERS_\r\n    ];\r\n\r\n    // GLS: Obtenemos los nuevos URIS para KML\r\n    var customKMLNameSpaceURIS = getAllCombinations(ol.format.KML.NAMESPACE_URIS_.slice().slice(1));\r\n    // GLS: Nos quedamos con las combinaciones nuevas\r\n    cleanCombinationsByFormat(customKMLNameSpaceURIS, ol.format.KML.NAMESPACE_URIS_);\r\n    // GLS: Añadimos los nuevos URIS al KML\r\n    ol.format.KML.NAMESPACE_URIS_ = ol.format.KML.NAMESPACE_URIS_.concat(customKMLNameSpaceURIS);\r\n    // GLS: Establecemos los parsers del KML para los nuevos URIS\r\n    setNewParsersByFormat(KML_PARSERS, customKMLNameSpaceURIS);\r\n\r\n\r\n    var GPX_PARSERS = [\r\n        ol.format.GPX.GPX_PARSERS_,\r\n        ol.format.GPX.LINK_PARSERS_,\r\n        ol.format.GPX.RTE_PARSERS_,\r\n        ol.format.GPX.RTEPT_PARSERS_,\r\n        ol.format.GPX.TRK_PARSERS_,\r\n        ol.format.GPX.TRKSEG_PARSERS_,\r\n        ol.format.GPX.TRKPT_PARSERS_,\r\n        ol.format.GPX.WPT_PARSERS_,\r\n        ol.format.GPX.LINK_SERIALIZERS_,\r\n        ol.format.GPX.RTE_SEQUENCE_,\r\n        ol.format.GPX.RTE_SERIALIZERS_,\r\n        ol.format.GPX.RTEPT_TYPE_SEQUENCE_,\r\n        ol.format.GPX.TRK_SEQUENCE_,\r\n        ol.format.GPX.TRK_SERIALIZERS_,\r\n        ol.format.GPX.TRKSEG_SERIALIZERS_,\r\n        ol.format.GPX.WPT_TYPE_SEQUENCE_,\r\n        ol.format.GPX.WPT_TYPE_SERIALIZERS_,\r\n        ol.format.GPX.GPX_SERIALIZERS_\r\n    ];\r\n\r\n    // GLS: Obtenemos los nuevos URIS para GPX\r\n    var customGPXNameSpaceURIS = getAllCombinations(ol.format.GPX.NAMESPACE_URIS_.slice().slice(1));\r\n    // GLS: Nos quedamos con las combinaciones nuevas\r\n    cleanCombinationsByFormat(customGPXNameSpaceURIS, ol.format.GPX.NAMESPACE_URIS_);\r\n    // GLS: Añadimos los nuevos URIS al GPX\r\n    ol.format.GPX.NAMESPACE_URIS_ = ol.format.GPX.NAMESPACE_URIS_.concat(customGPXNameSpaceURIS);\r\n    // GLS: Establecemos los parsers del GPX para los nuevos URIS\r\n    setNewParsersByFormat(GPX_PARSERS, customGPXNameSpaceURIS);\r\n\r\n    // Bug de OpenLayers hasta 4.1.0 como mínimo:\r\n    // ol.format.GMLBase no lee varias features dentro de featureCollection, se queda solo con la última.\r\n    // Esto es porque utiliza ol.xml.makeReplacer en vez de ol.xml.makeArrayPusher para leerlas.\r\n    // Curiosamente en ol.format.GML2 está corregido, pero no en ol.format.GML3.\r\n    // El siguiente constructor parchea ese bug\r\n    ol.format.GML3Patched = function (options) {\r\n        var result = new ol.format.GML(options);\r\n        result.FEATURE_COLLECTION_PARSERS[ol.format.GMLBase.GMLNS][\r\n            'featureMember'] =\r\n            ol.xml.makeArrayPusher(ol.format.GMLBase.prototype.readFeaturesInternal);\r\n        return result;\r\n    };\r\n\r\n    // Bug de OpenLayers hasta 3.5.0 como mínimo:\r\n    // El parser de GML2 no lee las siguientes features del GML si tienen un featureType distinto del primero.\r\n    // Esto pasa porque genera el objeto de featureTypes con la primera y en las siguientes iteraciones si el objeto existe no se regenera.\r\n    // Entre comentarios /* */ se elimina lo que sobra.\r\n    //\r\n    // Más: se añade para FeatureCollection un parser por cada namespaceURI del nodo. \r\n    // Esto es porque QGIS genera GML cuyo nodo FeatureCollection tiene namespace = http://ogr.maptools.org/.\r\n    ol.format.GMLBase.prototype.readFeaturesInternal = function (node, objectStack) {\r\n        ol.DEBUG && console.assert(node.nodeType == Node.ELEMENT_NODE,\r\n            'node.nodeType should be ELEMENT');\r\n        var localName = node.localName;\r\n        var features = null;\r\n        if (localName == 'FeatureCollection') {\r\n            // Ñapa para leer GML de https://catastro.navarra.es/ref_catastral/gml.ashx?C=217&PO=5&PA=626\r\n            // y demás GMLs obtenidos de un WFS de GeoServer.\r\n            var gmlnsCollectionParser = this.FEATURE_COLLECTION_PARSERS[ol.format.GMLBase.GMLNS];\r\n            if (!gmlnsCollectionParser['member']) {\r\n                gmlnsCollectionParser['member'] = ol.xml.makeArrayPusher(\r\n                    ol.format.GMLBase.prototype.readFeaturesInternal);\r\n            };\r\n            //////\r\n            if (node.namespaceURI === 'http://www.opengis.net/wfs') {\r\n                features = ol.xml.pushParseAndPop([],\r\n                    this.FEATURE_COLLECTION_PARSERS, node,\r\n                    objectStack, this);\r\n            } else {\r\n                this.FEATURE_COLLECTION_PARSERS[node.namespaceURI] =\r\n                    this.FEATURE_COLLECTION_PARSERS[node.namespaceURI] || this.FEATURE_COLLECTION_PARSERS[ol.format.GMLBase.GMLNS];\r\n                features = ol.xml.pushParseAndPop(/*null*/[], // Cambiado null por [] porque si no, no crea el array de features\r\n                    this.FEATURE_COLLECTION_PARSERS, node,\r\n                    objectStack, this);\r\n            }\r\n        } else if (localName == 'featureMembers' || localName == 'featureMember' || localName == 'member') {\r\n            var context = objectStack[0];\r\n            var featureType = context['featureType'];\r\n            var featureNS = context['featureNS'];\r\n            var i, ii, prefix = 'p', defaultPrefix = 'p0';\r\n            if (/*!featureType && */node.childNodes) {\r\n                featureType = [], featureNS = {};\r\n                for (i = 0, ii = node.childNodes.length; i < ii; ++i) {\r\n                    var child = node.childNodes[i];\r\n                    if (child.nodeType === 1) {\r\n                        var ft = child.nodeName.split(':').pop();\r\n                        if (featureType.indexOf(ft) === -1) {\r\n                            var key = '';\r\n                            var count = 0;\r\n                            var uri = child.namespaceURI;\r\n                            for (var candidate in featureNS) {\r\n                                if (featureNS[candidate] === uri) {\r\n                                    key = candidate;\r\n                                    break;\r\n                                }\r\n                                ++count;\r\n                            }\r\n                            if (!key) {\r\n                                key = prefix + count;\r\n                                featureNS[key] = uri;\r\n                            }\r\n                            featureType.push(key + ':' + ft);\r\n                        }\r\n                    }\r\n                }\r\n                if (localName != 'featureMember' && localName != 'member') {\r\n                    // recheck featureType for each featureMember\r\n                    context['featureType'] = featureType;\r\n                    context['featureNS'] = featureNS;\r\n                }\r\n            }\r\n            if (typeof featureNS === 'string') {\r\n                var ns = featureNS;\r\n                featureNS = {};\r\n                featureNS[defaultPrefix] = ns;\r\n            }\r\n            var parsersNS = {};\r\n            var featureTypes = Array.isArray(featureType) ? featureType : [featureType];\r\n            for (var p in featureNS) {\r\n                var parsers = {};\r\n                for (i = 0, ii = featureTypes.length; i < ii; ++i) {\r\n                    var featurePrefix = featureTypes[i].indexOf(':') === -1 ?\r\n                        defaultPrefix : featureTypes[i].split(':')[0];\r\n                    if (featurePrefix === p) {\r\n                        parsers[featureTypes[i].split(':').pop()] =\r\n                            (localName == 'featureMembers') ?\r\n                                ol.xml.makeArrayPusher(this.readFeatureElement, this) :\r\n                                ol.xml.makeReplacer(this.readFeatureElement, this);\r\n                    }\r\n                }\r\n                parsersNS[featureNS[p]] = parsers;\r\n            }\r\n            if (localName == 'featureMember' || localName == 'member') { // Elemento solo\r\n                features = ol.xml.pushParseAndPop(undefined, parsersNS, node, objectStack);\r\n            } else { // Colección de elementos\r\n                features = ol.xml.pushParseAndPop([], parsersNS, node, objectStack);\r\n            }\r\n        }\r\n        if (features === null) {\r\n            features = [];\r\n        }\r\n        // Revisamos que todas las features tienen geometría válida o no tienen geometría definida. Evitamos así que cuele un GML 2 parseado con el parser GML 3.\r\n        var checkFeatureGeometry = function (feat) {\r\n            var geom = feat.getGeometry();\r\n            if (feat.getProperties().hasOwnProperty(feat.getGeometryName()) && (!geom || !geom.flatCoordinates.length)) {\r\n                throw 'Geometría no válida. ¿Posible versión incorrecta de GML?';\r\n            }\r\n        };\r\n        if (features instanceof ol.Feature) {\r\n            checkFeatureGeometry(features);\r\n        }\r\n        else {\r\n            for (var i = 0, len = features.length; i < len; i++) {\r\n                checkFeatureGeometry(features[i]);\r\n            }\r\n        }\r\n        return features;\r\n    };\r\n\r\n    ol.format.GML3CRS84 = function () {\r\n        ol.format.GML3.call(this, {\r\n            srsName: 'CRS:84'\r\n        });\r\n    };\r\n    ol.inherits(ol.format.GML3CRS84, ol.format.GML3);\r\n\r\n    ol.format.GML2CRS84 = function () {\r\n        ol.format.GML2.call(this, {\r\n            srsName: 'CRS:84'\r\n        });\r\n    };\r\n    ol.inherits(ol.format.GML2CRS84, ol.format.GML2);\r\n\r\n    // Parche para evitar el error AssertionError: Assertion failed: calculated value (1.020636810790192) ouside allowed range (0-1)\r\n    ol.View.prototype.getValueForResolutionFunction = function (opt_power) {\r\n        var power = opt_power || 2;\r\n        var maxResolution = this.maxResolution_;\r\n        var minResolution = this.minResolution_;\r\n        var max = Math.log(maxResolution / minResolution) / Math.log(power);\r\n        return (\r\n            /**\r\n                 * @param {number} resolution Resolution.\r\n                 * @return {number} Value.\r\n             */\r\n            function (resolution) {\r\n                var value =\r\n                    (Math.log(maxResolution / resolution) / Math.log(power)) / max;\r\n                value = Math.max(Math.min(1, value), 0);\r\n                return value;\r\n            });\r\n    };\r\n\r\n    // Modificación para cambiar el comportamiento de ol.control.OverviewMap:\r\n    // Mantener la caja del extent siempre centrada.\r\n    ol.control.OverviewMap.prototype._validateExtent_ = ol.control.OverviewMap.prototype.validateExtent_;\r\n    ol.control.OverviewMap.prototype.validateExtent_ = function () {\r\n        var self = this;\r\n        self._validateExtent_();\r\n        if (self._wrap && self._wrap.parent.options.alwaysCentered) {\r\n            self.recenter_();\r\n        }\r\n    };\r\n\r\n    // En modo 3D, cambiar la lógica de la escala para que siempre muestre área de visión.\r\n    ol.control.OverviewMap.prototype._resetExtent_ = ol.control.OverviewMap.prototype.resetExtent_;\r\n    ol.control.OverviewMap.prototype.resetExtent_ = function () {\r\n        var self = this;\r\n        self._resetExtent_.call(self);\r\n        var wrap = self._wrap;\r\n        if (wrap.is3D) {\r\n            var ovmap = self.ovmap_;\r\n            var ovview = ovmap.getView();\r\n            var extent = ovview.calculateExtent();\r\n            var feature = wrap.get3DCameraLayer().getSource().getFeatures()[0];\r\n            if (feature) {\r\n                coordinates = feature.getGeometry().getCoordinates();\r\n                var coord1 = coordinates[0][0];\r\n                var coord2 = coordinates[0][1];\r\n                if (!ol.extent.containsCoordinate(extent, coord1) || !ol.extent.containsCoordinate(extent, coord2)) {\r\n                    var buffer = Math.max(\r\n                        extent[0] - coord1[0],\r\n                        extent[1] - coord1[1],\r\n                        coord1[0] - extent[2],\r\n                        coord1[1] - extent[3],\r\n                        extent[0] - coord2[0],\r\n                        extent[1] - coord2[1],\r\n                        coord2[0] - extent[2],\r\n                        coord2[1] - extent[3]\r\n                    );\r\n                    ovview.fit(ol.extent.buffer(extent, buffer));\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    // Parche a mantener hasta que se actualize cartoteca\r\n    const oldImage = ol.Image;\r\n    ol.Image = function () {\r\n        if (arguments.length === 7) {\r\n            Array.prototype.splice.call(arguments, 3, 1);\r\n        }\r\n        return oldImage.apply(this, arguments);\r\n    }\r\n    TC.inherit(ol.Image, oldImage);\r\n\r\n    if (!TC.Util.detectMobile()) {\r\n        // Parche para situar el ancla del popup cuando tenemos zoom in/out de navegador o pantalla\r\n        ol.Overlay.prototype.updateRenderedPosition = function (pixel, mapSize) {\r\n            var style = this.element.style;\r\n            var offset = this.getOffset();\r\n\r\n            var positioning = this.getPositioning();\r\n\r\n            this.setVisible(true);\r\n\r\n            var offsetX = offset[0];\r\n            var offsetY = offset[1];\r\n            if (positioning == ol.OverlayPositioning.BOTTOM_RIGHT ||\r\n                positioning == ol.OverlayPositioning.CENTER_RIGHT ||\r\n                positioning == ol.OverlayPositioning.TOP_RIGHT) {\r\n                if (this.rendered.left_ !== '') {\r\n                    this.rendered.left_ = style.left = '';\r\n                }\r\n                var right = Math.round(mapSize[0] - pixel[0] - offsetX) / window.devicePixelRatio + 'px';\r\n                if (this.rendered.right_ != right) {\r\n                    this.rendered.right_ = style.right = right;\r\n                }\r\n            } else {\r\n                if (this.rendered.right_ !== '') {\r\n                    this.rendered.right_ = style.right = '';\r\n                }\r\n                if (positioning == ol.OverlayPositioning.BOTTOM_CENTER ||\r\n                    positioning == ol.OverlayPositioning.CENTER_CENTER ||\r\n                    positioning == ol.OverlayPositioning.TOP_CENTER) {\r\n                    offsetX -= this.element.offsetWidth / 2;\r\n                }\r\n                var left = Math.round(pixel[0] + offsetX) / window.devicePixelRatio + 'px';\r\n                if (this.rendered.left_ != left) {\r\n                    this.rendered.left_ = style.left = left;\r\n                }\r\n            }\r\n            if (positioning == ol.OverlayPositioning.BOTTOM_LEFT ||\r\n                positioning == ol.OverlayPositioning.BOTTOM_CENTER ||\r\n                positioning == ol.OverlayPositioning.BOTTOM_RIGHT) {\r\n                if (this.rendered.top_ !== '') {\r\n                    this.rendered.top_ = style.top = '';\r\n                }\r\n                var bottom = Math.round(mapSize[1] - pixel[1] - offsetY) / window.devicePixelRatio + 'px';\r\n                if (this.rendered.bottom_ != bottom) {\r\n                    this.rendered.bottom_ = style.bottom = bottom;\r\n                }\r\n            } else {\r\n                if (this.rendered.bottom_ !== '') {\r\n                    this.rendered.bottom_ = style.bottom = '';\r\n                }\r\n                if (positioning == ol.OverlayPositioning.CENTER_LEFT ||\r\n                    positioning == ol.OverlayPositioning.CENTER_CENTER ||\r\n                    positioning == ol.OverlayPositioning.CENTER_RIGHT) {\r\n                    offsetY -= this.element.offsetHeight / 2;\r\n                }\r\n                var top = Math.round(pixel[1] + offsetY) / window.devicePixelRatio + 'px';\r\n                if (this.rendered.top_ != top) {\r\n                    this.rendered.top_ = style.top = top;\r\n                }\r\n            }\r\n        };\r\n    }\r\n\r\n    /////////////////////////////////////////////////////\r\n\r\n    var getRGBA = function (color, opacity) {\r\n        var result;\r\n        if (color) {\r\n            result = ol.color.asArray(color);\r\n            result = result.slice();\r\n            if (opacity !== undefined) {\r\n                result[3] = opacity;\r\n            }\r\n        }\r\n        else {\r\n            result = [0, 0, 0, 1];\r\n        }\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Obtiene el objeto de opciones de una vista que restringe los niveles de zoom activos sobre el mapa dependiendo de las opciones definidas sobre\r\n     * el mapa base activo.\r\n     */\r\n    var getResolutionOptions = function (mapWrap, layer) {\r\n        var view = mapWrap.map.getView();\r\n        var prevRes = view.getResolution();\r\n\r\n        var pms = {\r\n            projection: view.getProjection(),\r\n            center: view.getCenter(),\r\n            resolution: prevRes,\r\n            enableRotation: false\r\n        };\r\n\r\n        if (mapWrap.parent.maxExtent) {\r\n            pms.extent = mapWrap.parent.maxExtent;\r\n        }\r\n\r\n        // GLS 06/03/2019 Corregimos bug 24832, si el mapa de fondo es el mapa en blanco, asignamos las resoluciones del mapa de fondo actual\r\n        var layerForResolutions = layer;\r\n        if (layer.type === TC.Consts.layerType.VECTOR && mapWrap.parent.getBaseLayer()) {\r\n            layerForResolutions = mapWrap.parent.getBaseLayer();\r\n        }\r\n\r\n        var res = layerForResolutions.getResolutions ? layerForResolutions.getResolutions() : [];\r\n        var maxRes;\r\n        var minRes;\r\n\r\n        if (res && res.length) {\r\n            maxRes = layerForResolutions.maxResolution || res[0];\r\n            minRes = layerForResolutions.minResolution || res[res.length - 1];\r\n\r\n            var minResIx = res.indexOf(minRes);\r\n            var maxResIx = res.indexOf(maxRes);\r\n\r\n            pms.resolutions = res.slice(maxResIx, minResIx + 1);\r\n        }\r\n        else {\r\n            maxRes = layerForResolutions.maxResolution;\r\n            minRes = layerForResolutions.minResolution;\r\n        }\r\n        if (minRes) {\r\n            pms.minResolution = minRes;\r\n            if (prevRes < minRes) {\r\n                pms.resolution = minRes;\r\n            }\r\n        }\r\n        if (maxRes) {\r\n            pms.maxResolution = maxRes;\r\n            if (prevRes > maxRes) {\r\n                pms.resolution = maxRes;\r\n            }\r\n        }\r\n\r\n        return pms;\r\n    };\r\n\r\n\r\n    TC.wrap.Map.prototype.setMap = function () {\r\n        var self = this;\r\n        var center = [\r\n            (self.parent.initialExtent[0] + self.parent.initialExtent[2]) / 2,\r\n            (self.parent.initialExtent[1] + self.parent.initialExtent[3]) / 2\r\n        ];\r\n\r\n        var proj4Obj = proj4(self.parent.crs);\r\n        var addEquivalentProjections = function () {\r\n            // Añadimos proyecciones equivalentes y transformaciones necesarias.\r\n            var crsCode = self.parent.crs.substr(self.parent.crs.lastIndexOf(':') + 1);\r\n\r\n            var projOptions = {\r\n                units: proj4Obj.oProj.units,\r\n                global: true\r\n            };\r\n\r\n            var equivalentProjections = [];\r\n            if (crsCode !== '4326') { // Este código ya está metido, no lo machacamos\r\n                projOptions.code = 'EPSG:' + crsCode;\r\n                equivalentProjections.push(new ol.proj.Projection(projOptions));\r\n                projOptions.code = 'urn:ogc:def:crs:EPSG::' + crsCode;\r\n                equivalentProjections.push(new ol.proj.Projection(projOptions));\r\n\r\n                ol.proj.addEquivalentProjections(equivalentProjections);\r\n            }\r\n            var doTransform = function (fn, input, opt_output, opt_dimension) {\r\n                var result = [];\r\n                var dimension = opt_dimension || 2;\r\n                for (var i = 0; i < input.length; i += dimension) {\r\n                    var transformed = Array.prototype.slice.call(fn(input.slice(i, i + dimension)));\r\n                    if (dimension === 3 || dimension === 4) {\r\n                        transformed = transformed.slice(0, 2).concat(input.slice(i + 2, (i + 2) + (dimension - 2)));\r\n                    }\r\n\r\n                    result = result.concat(transformed);\r\n                }\r\n                if ($.isArray(opt_output)) {\r\n                    opt_output.length = 0;\r\n                    for (var i = 0; i < result.length; i++) {\r\n                        opt_output[i] = result[i];\r\n                    }\r\n                    result = opt_output;\r\n                }\r\n                return result;\r\n            };\r\n            var fromEPSG4326 = function (input, opt_output, opt_dimension) {\r\n                return doTransform(proj4Obj.forward, input, opt_output, opt_dimension);\r\n            };\r\n            var toEPSG4326 = function (input, opt_output, opt_dimension) {\r\n                return doTransform(proj4Obj.inverse, input, opt_output, opt_dimension);\r\n            };\r\n\r\n            ol.proj.addEquivalentTransforms(\r\n                ol.proj.EPSG4326.PROJECTIONS,\r\n                equivalentProjections,\r\n                fromEPSG4326,\r\n                toEPSG4326);\r\n        };\r\n\r\n        addEquivalentProjections();\r\n\r\n        var projOptions = {\r\n            code: self.parent.crs,\r\n            units: proj4Obj.oProj.units\r\n        };\r\n        if (self.parent.crs === 'EPSG:4326') {\r\n            projOptions.axisOrientation = 'neu';\r\n        }\r\n        var projection = new ol.proj.Projection(projOptions);\r\n\r\n        var interactions = ol.interaction.defaults({ constrainResolution: true });\r\n\r\n        var viewOptions = {\r\n            projection: projection,\r\n            center: center,\r\n            enableRotation: false\r\n        };\r\n        if (self.parent.maxExtent) {\r\n            var maxExtent = self.parent.maxExtent;\r\n            viewOptions.extent = maxExtent;\r\n            var rect = self.parent.div.getBoundingClientRect();\r\n            var ratio = rect.width / rect.height;\r\n            var dx = maxExtent[2] - maxExtent[0];\r\n            var dy = maxExtent[3] - maxExtent[1];\r\n            if (rect.width / rect.height > dx / dy) {\r\n                viewOptions.resolution = dx / rect.width;\r\n            }\r\n            else {\r\n                viewOptions.resolution = dy / rect.height;\r\n            }\r\n        }\r\n        else {\r\n            viewOptions.zoom = 2;\r\n        }\r\n\r\n        self.map = new ol.Map({\r\n            target: self.parent.div,\r\n            renderer: ol.renderer.Type.CANVAS,\r\n            view: new ol.View(viewOptions),\r\n            controls: [],\r\n            interactions: interactions,\r\n            pixelRatio: 1 /* 08/02/2019 GLS: \r\n            Establecemos el pixelRatio siempre a uno, porque OL sólo atiende al valor al principio, \r\n            si después se hace zoom in/out del navegador, OL no atiende el cambio lo que provoca que el mapa se vea borroso,\r\n            click se sitúa mal, popup se sitúa entre otros efectos.\r\n            Lo gestionamos nosotros hasta que lo soporten del todo. Relacionado con las tareas/bugs:\r\n                Bug 25976:Mapa situación en blanco\r\n                Bug 25954:Canvas en blanco con zoom mayor al 100%\r\n                Bug 23855:Mapa de situación se muestra en blanco\r\n            */\r\n        });\r\n\r\n        if (!TC.Util.detectMobile()) {\r\n            // Parche para corregir https://github.com/openlayers/openlayers/issues/2904\r\n            // saben que tienen un bug cuando se trabaja sobre un mapa con zoom\r\n            self.map.getEventPixel = function (event) {\r\n                var viewportPosition = this.viewport_.getBoundingClientRect();\r\n                var eventPosition = event.changedTouches ? event.changedTouches[0] : event;\r\n                eventPosition = eventPosition.clientX ? eventPosition : (eventPosition.pointerEvent ? eventPosition.pointerEvent : eventPosition);\r\n                return [\r\n                    (eventPosition.clientX - viewportPosition.left) * window.devicePixelRatio,\r\n                    (eventPosition.clientY - viewportPosition.top) * window.devicePixelRatio\r\n                ];\r\n            };\r\n        }\r\n\r\n        self.map._wrap = self;\r\n        self._promise = Promise.resolve(self.map);\r\n\r\n        // mantenemos el ancho y alto del canvas en números enteros\r\n        self.manageSize.call(self.map);\r\n\r\n        // Para evitar estiramientos en canvas\r\n        var updateSize = function () {\r\n            self.map.updateSize();\r\n        };\r\n        self.parent.div.addEventListener(ol.events.EventType.RESIZE, updateSize);\r\n        self.parent.one(TC.Consts.event.MAPLOAD, updateSize);\r\n\r\n        self.map.on(ol.MapBrowserEventType.SINGLECLICK, function (e) {\r\n\r\n            if (self.parent.view === TC.Consts.view.PRINTING) {\r\n                return;\r\n            }\r\n\r\n            self.parent.workLayers.forEach(function (wl) {\r\n                delete wl._noFeatureClicked;\r\n            });\r\n            var featuresInLayers = $.map(self.parent.workLayers, function () {\r\n                return false;\r\n            });\r\n            self.map.forEachFeatureAtPixel(e.pixel,\r\n                function (feature, layer) {\r\n                    if (feature._wrap && feature._wrap.parent.showsPopup) {\r\n                        for (var i = 0; i < self.parent.workLayers.length; i++) {\r\n                            var wl = self.parent.workLayers[i];\r\n                            if (wl.wrap.layer === layer) {\r\n                                featuresInLayers[i] = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                        self.parent.trigger(TC.Consts.event.FEATURECLICK, { feature: feature._wrap.parent });\r\n                        return feature;\r\n                    }\r\n                },\r\n                {\r\n                    hitTolerance: hitTolerance\r\n                });\r\n            for (var i = 0; i < featuresInLayers.length; i++) {\r\n                if (!featuresInLayers[i]) {\r\n                    self.parent.trigger(TC.Consts.event.NOFEATURECLICK, { layer: self.parent.workLayers[i] });\r\n                }\r\n            }\r\n        });\r\n\r\n\r\n        // GLS: 13/02/2019 cambiamos el orden de las suscripciones a eventos de cambio de resolución y moveend\r\n        // para gestionar el borrado del estado inicial. Si no lo hacemos el cambio al extent inicial se registra como evento de usuario\r\n        // porque la carga inicial del mapa con promesas nativas es más rápido que antes.\r\n        // Bug:26001 Borrar estado inicial al entrar\r\n        const addMoveEndListener = function () {\r\n            self.map.on(ol.MapEventType.MOVEEND, function () {\r\n                self.parent.trigger(TC.Consts.event.ZOOM);\r\n            });\r\n        };\r\n        var olView = self.map.getView();\r\n        olView.on('change:resolution', function () {\r\n            if (!self.map.hasListener(ol.MapEventType.MOVEEND)) {\r\n                self.map.once(ol.MapEventType.MOVEEND, function () {\r\n                    addMoveEndListener();\r\n                });\r\n            }\r\n\r\n            self.parent.trigger(TC.Consts.event.BEFOREZOOM);\r\n        }, self.parent);\r\n\r\n        const onChangeView = function () {\r\n            if (!self.map.hasListener(ol.MapEventType.MOVEEND)) {\r\n                self.map.un('change:view', onChangeView);\r\n                addMoveEndListener();\r\n            }\r\n        };\r\n        self.map.on('change:view', onChangeView);\r\n\r\n        /**\r\n         * Restringe los niveles de zoom activos sobre el mapa dependiendo de las opciones definidas sobre\r\n         * el mapa base activo.\r\n         */\r\n        var limitZoomLevels = function (layer) {\r\n            var prevRes = self.map.getView().getResolution();\r\n            var prevZoom = self.map.getView().getZoom();\r\n\r\n            var pms = getResolutionOptions(self, layer);\r\n\r\n            var view = new ol.View(pms);\r\n            self.map.setView(view);\r\n            self.map.render();\r\n        };\r\n\r\n        self.parent.on(TC.Consts.event.BASELAYERCHANGE, function (e) {\r\n            // Solo se limitan las resoluciones cuando estamos en un CRS por defecto, donde no se repixelan teselas\r\n            if (self.parent.crs === self.parent.options.crs && !self.parent.on3DView && e.layer.type !== TC.Consts.layerType.VECTOR) {\r\n                limitZoomLevels(e.layer);\r\n            }\r\n        });\r\n        self.parent.on(TC.Consts.event.MAPLOAD, function (e) {\r\n            limitZoomLevels(self.parent.getBaseLayer());\r\n        });\r\n\r\n        const olMapViewport = self.map.getViewport();\r\n\r\n        olMapViewport.addEventListener(TC.Consts.event.MOUSEMOVE, function (e) {\r\n            var mapTarget = self.map.getTarget();\r\n            var hit = false;\r\n            var feature;\r\n\r\n            if (!self.parent.activeControl || !self.parent.activeControl.isExclusive()) {\r\n\r\n                if (self.parent.view === TC.Consts.view.PRINTING) {\r\n                    return;\r\n                }\r\n\r\n                var pixel = self.map.getEventPixel(e);\r\n                hit = self.map.forEachFeatureAtPixel(pixel, function (feature, layer) {\r\n                    var result = true;\r\n                    if (feature._wrap && !feature._wrap.parent.showsPopup && !feature._wrap.parent.options.selectable) {\r\n                        result = false;\r\n                    }\r\n\r\n                    if (result && feature._wrap) {\r\n                        self.parent.trigger(TC.Consts.event.FEATUREOVER, {\r\n                            feature: feature._wrap.parent\r\n                        });\r\n                    }\r\n\r\n                    return result;\r\n                }, { hitTolerance: hitTolerance });\r\n            }\r\n\r\n            if (hit) {\r\n                mapTarget.style.cursor = 'pointer';\r\n            } else {\r\n                mapTarget.style.cursor = '';\r\n                //self.parent.trigger(TC.Consts.event.FEATUREOUT);\r\n            }\r\n        });\r\n    };\r\n\r\n    var getMetersPerUnit = function (proj, extentInDegrees) {\r\n        var units = proj.getUnits();\r\n        if (!units || units === ol.proj.Units.DEGREES) {\r\n            return TC.Util.getMetersPerDegree(extentInDegrees);\r\n        }\r\n        return ol.proj.METERS_PER_UNIT[units];\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getMetersPerUnit = function () {\r\n        var self = this;\r\n        return getMetersPerUnit(ol.proj.get(self.parent.crs), self.getExtent());\r\n    };\r\n\r\n    var getUnitRatio = function (options) {\r\n        var self = this;\r\n        options = options || {};\r\n        var defaultCrs = self.parent.options.crs || TC.Cfg.crs;\r\n        var defaultProj = ol.proj.get(defaultCrs);\r\n        var newProj = ol.proj.get(options.crs);\r\n        return getMetersPerUnit(newProj, options.extentInDegrees) / getMetersPerUnit(defaultProj, options.extentInDegrees);\r\n    };\r\n\r\n    var normalizeProjection = function (options) {\r\n        var result;\r\n        if (options.axisOrientation) {\r\n            result = new ol.proj.Projection({\r\n                code: options.crs,\r\n                axisOrientation: options.axisOrientation\r\n            });\r\n        }\r\n        else {\r\n            result = ol.proj.get(options.crs);\r\n        }\r\n        if (!result.getUnits()) {\r\n            result.units_ = ol.proj.Units.DEGREES;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setProjection = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        const baseLayer = options.baseLayer || self.parent.baseLayer;\r\n        var extent;\r\n        if (options.extent) {\r\n            extent = options.extent;\r\n        }\r\n        else {\r\n            extent = ol.proj.transformExtent(self.getExtent(), self.parent.crs, options.crs);\r\n        }\r\n        const extentInDegrees = ol.proj.transformExtent(extent, options.crs, 'EPSG:4326');\r\n        const unitRatio = getUnitRatio.call(self, {\r\n            crs: options.crs,\r\n            extentInDegrees: extentInDegrees\r\n        });\r\n        const projection = normalizeProjection(options);\r\n        const oldView = self.map.getView();\r\n        const viewOptions = {\r\n            projection: projection,\r\n            enableRotation: false\r\n        };\r\n        const resolutions = baseLayer.getResolutions();\r\n\r\n        if (resolutions && resolutions.length) {\r\n            viewOptions.resolutions = resolutions;\r\n        }\r\n        else {\r\n            viewOptions.minZoom = oldView.getMinZoom();\r\n            viewOptions.maxZoom = oldView.getMaxZoom();\r\n            const minResolution = baseLayer.wrap.layer.getMinResolution();\r\n            const maxResolution = baseLayer.wrap.layer.getMaxResolution();\r\n            var transformFactor = 1;\r\n            if (minResolution === 0 || maxResolution === Number.POSITIVE_INFINITY) {\r\n                const oldUnitRatio = getUnitRatio.call(self, {\r\n                    crs: self.parent.crs,\r\n                    extentInDegrees: extentInDegrees\r\n                });\r\n                transformFactor = oldUnitRatio / unitRatio;\r\n            }\r\n            if (minResolution === 0) {\r\n                viewOptions.minResolution = oldView.getMinResolution() * transformFactor;\r\n            }\r\n            else {\r\n                viewOptions.minResolution = minResolution;\r\n            }\r\n            if (maxResolution === Number.POSITIVE_INFINITY) {\r\n                viewOptions.maxResolution = oldView.getMaxResolution() * transformFactor;\r\n            }\r\n            else {\r\n                viewOptions.maxResolution = maxResolution;\r\n            }\r\n        }\r\n\r\n        // GLS: transformamos también el centro     \r\n        viewOptions.center = ol.proj.transform(self.getCenter(), self.parent.crs, options.crs);\r\n\r\n        var newView = new ol.View(viewOptions);\r\n        self.map.setView(newView);\r\n        self.parent.initialExtent = unitRatio !== 1 ? ol.proj.transformExtent(self.parent.initialExtent, self.parent.crs, options.crs) : self.parent.options.initialExtent;        \r\n        if (self.parent.options.maxExtent) {            \r\n            self.parent.options.maxExtent = self.parent.maxExtent = unitRatio !== 1 ? ol.proj.transformExtent(self.parent.maxExtent, self.parent.crs, options.crs) : self.parent.options.maxExtent;\r\n        }\r\n        newView.fit(extent, { nearest: true });\r\n    };\r\n\r\n    /*\r\n     *  insertLayer: inserts OpenLayers layer at index\r\n     *  Parameters: OpenLayers.Layer, number\r\n     */\r\n    TC.wrap.Map.prototype.insertLayer = function (olLayer, idx) {\r\n        var self = this;\r\n        var layers = self.map.getLayers();\r\n        var alreadyExists = false;\r\n        for (var i = 0; i < layers.getLength(); i++) {\r\n            if (layers.item(i) === olLayer) {\r\n                alreadyExists = true;\r\n                break;\r\n            }\r\n        }\r\n        if (alreadyExists) {\r\n            layers.remove(olLayer);\r\n            layers.insertAt(idx, olLayer);\r\n        }\r\n        else {\r\n            if (idx < 0) {\r\n                layers.push(olLayer);\r\n            }\r\n            else {\r\n                layers.insertAt(idx, olLayer);\r\n            }\r\n            // Solo se limitan las resoluciones cuando estamos en un CRS por defecto, donde no se repixelan teselas\r\n            var view = self.map.getView();\r\n            if (self.parent.crs === self.parent.options.crs) {\r\n                if (olLayer instanceof ol.layer.Tile) {\r\n                    var resolutions = olLayer.getSource().getResolutions();\r\n                    view.maxResolution_ = resolutions[0];\r\n                    view.minResolution_ = resolutions[resolutions.length - 1];\r\n                }\r\n            }\r\n            else {\r\n                // Cambiamos los límites de resolución de la capa a los de la vista. Esto lo hacemos porque su resolución está en otro CRS.\r\n                if (olLayer instanceof ol.layer.Tile) {\r\n                    olLayer.setMaxResolution(view.getMaxResolution());\r\n                    olLayer.setMinResolution(view.getMinResolution());\r\n                }\r\n            }\r\n\r\n            var wrap = olLayer._wrap;\r\n            var loadingTileCount = 0;\r\n\r\n            var beforeTileLoadHandler = function (e) {\r\n                wrap.parent.state = TC.Layer.state.LOADING;\r\n                if (loadingTileCount <= 0) {\r\n                    loadingTileCount = 0;\r\n                    self.parent.trigger(TC.Consts.event.BEFORELAYERUPDATE, { layer: wrap.parent });\r\n                }\r\n                olLayer._loadingTileCount = olLayer._loadingTileCount + 1;\r\n            };\r\n            if (wrap.parent.state === TC.Layer.state.LOADING && wrap.parent.isRaster()) {\r\n                beforeTileLoadHandler();\r\n            }\r\n            wrap.$events.on(TC.Consts.event.BEFORETILELOAD, beforeTileLoadHandler);\r\n\r\n            wrap.$events.on(TC.Consts.event.TILELOAD, function (e) {\r\n                loadingTileCount = loadingTileCount - 1;\r\n                if (loadingTileCount <= 0) {\r\n                    loadingTileCount = 0;\r\n                    wrap.parent.state = TC.Layer.state.IDLE;\r\n                    self.parent.trigger(TC.Consts.event.LAYERUPDATE, { layer: wrap.parent });\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.Map.prototype.removeLayer = function (olLayer) {\r\n        this.map.removeLayer(olLayer);\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getLayerCount = function () {\r\n        return this.map.getLayerGroup().getLayers().getLength();\r\n    };\r\n\r\n    TC.wrap.Map.prototype.indexOfFirstVector = function () {\r\n        var result = -1;\r\n        this.map.getLayerGroup().getLayers().forEach(function (l, i) {\r\n            if (l instanceof ol.layer.Vector && result === -1) {\r\n                result = i;\r\n            }\r\n        });\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getLayerIndex = function (olLayer) {\r\n        var result = -1;\r\n        this.map.getLayerGroup().getLayers().forEach(function (elm, idx) {\r\n            if (elm === olLayer) {\r\n                result = idx;\r\n            }\r\n        });\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setLayerIndex = function (olLayer, index) {\r\n        var layers = this.map.getLayers();\r\n        var list = layers.getArray();\r\n        var ix = list.indexOf(olLayer);\r\n\r\n        if (ix > -1 && ix != index) {\r\n            this.map.removeLayer(olLayer);\r\n            this.insertLayer(olLayer, index);\r\n            //layers.setAt(index, olLayer);\r\n        }\r\n        else {\r\n            //no está el layer, así que no hago nada\r\n        }\r\n\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setBaseLayer = function (olLayer) {\r\n        var self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var setLayer = function (curBl) {\r\n                // GLS: si se llega después de una animación el valor de self.parent.getBaseLayer() ya es el definitivo y no el actual lo que provoca efectos indeseados. \r\n                // ir a línea 1313: paso como parámetro el baseLayer actual en el caso de animación.\r\n                var curBl = curBl || self.parent.getBaseLayer();\r\n                if (curBl) {\r\n                    self.map.removeLayer(curBl.wrap.layer);\r\n                    if (olLayer instanceof ol.layer.Image) { // Si es imagen no teselada\r\n                        var unitRatio = getUnitRatio.call(self, {\r\n                            crs: self.parent.crs,\r\n                            extent: self.parent.getExtent()\r\n                        });\r\n                        olLayer._wrap.setProjection({\r\n                            crs: self.parent.crs\r\n                        });\r\n                    }\r\n\r\n                    if (olLayer._wrap.parent.type === TC.Consts.layerType.WMTS) {\r\n                        var layerProjectionOptions = { crs: self.parent.crs, oldCrs: olLayer.getSource().getProjection().getCode() };\r\n\r\n                        if (layerProjectionOptions.oldCrs !== layerProjectionOptions.crs) {\r\n                            olLayer._wrap.parent.setProjection(layerProjectionOptions);\r\n                        }\r\n                    }\r\n\r\n                    //if (olLayer instanceof ol.layer.Tile) { // Si es imagen teselada\r\n                    //    const view = self.map.getView();\r\n                    //    const resolutions = olLayer.getSource().getResolutions();\r\n                    //    if (resolutions) {\r\n                    //        view.options_.resolutions = resolutions;\r\n                    //        view.applyOptions_(view.options_);\r\n                    //    }\r\n                    //}\r\n                }\r\n                self.insertLayer(olLayer, 0);\r\n                resolve();\r\n            };\r\n\r\n            // Toda esta lógica antes de llamar a setLayer() es para hacer un zoom a la nueva resolución\r\n            // cuando la nueva capa no llega a la resolución actual\r\n            var viewOptions = getResolutionOptions(self, olLayer._wrap.parent);\r\n            var view = self.map.getView();\r\n            var currentResolution = view.getResolution();\r\n            // Solo se limitan las resoluciones cuando estamos en un CRS por defecto, donde no se repixelan teselas\r\n            if (self.parent.crs === self.parent.options.crs && viewOptions.resolutions) {\r\n                //buscamos la nueva resolución: o una que sea similar a la actual dentro de los márgenes admitidos, o la inmediata superior\r\n                var newRes = viewOptions.resolutions\r\n                    .sort(function (a, b) { return a - b })\r\n                    .reduce(function (prev, elm) {\r\n                        if (prev === 0 &&\r\n                            (elm > currentResolution || Math.abs(1 - (currentResolution / elm)) < self.parent.options.maxResolutionError)) {\r\n                            return elm;\r\n                        }\r\n                        return prev;\r\n                    }, 0);\r\n                if (newRes !== currentResolution) {\r\n                    if (self.parent.isLoaded) {\r\n                        view.animate({ resolution: newRes, duration: TC.Consts.ZOOM_ANIMATION_DURATION }, setLayer.bind(self, self.parent.getBaseLayer()));\r\n                    }\r\n                    else { // Primera carga, no animamos\r\n                        view.setResolution(newRes);\r\n                        setLayer();\r\n                    }\r\n                }\r\n                else {\r\n                    setLayer();\r\n                }\r\n            }\r\n            else {\r\n                setLayer();\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setExtent = function (extent, options) {\r\n        const self = this;\r\n        options = options || {};\r\n\r\n        const applyExtent = function (view, mapSize, resolve, reject) {\r\n            var res = view.getResolutionForExtent(extent, mapSize);\r\n            // URI: Esta logica está fusilada de la función fit de un objeto view de OL3\r\n            if (view.constrainResolution) {\r\n                var constrainedResolution = view.constrainResolution(res, 0, 0);\r\n                if (constrainedResolution < res) {\r\n                    if (constrainedResolution / res < TC.Consts.EXTENT_TOLERANCE) {\r\n                        constrainedResolution = view.constrainResolution(\r\n                            constrainedResolution, -1, 0);\r\n                    }\r\n                }\r\n                res = constrainedResolution;\r\n            }\r\n\r\n            // flacunza: No animamos si la duración va a ser 0, porque a veces el zoom no se completa\r\n            // GLS: antes de resolver la promesa validamos si existe animación\r\n            // URI: si la animacion no existe ponemos duracion 0\r\n            // flacunza: en caso de que animate=undefined, se anima\r\n            const center = [((extent[0] + extent[2]) / 2), ((extent[1] + extent[3]) / 2)];\r\n            if (options.animate === void (0) || options.animate) {\r\n                view.animate({\r\n                    resolution: res,\r\n                    center: center,\r\n                    duration: TC.Consts.ZOOM_ANIMATION_DURATION\r\n                }, resolve);\r\n            }\r\n            else {\r\n                view.setCenter(center);\r\n                view.setResolution(res);\r\n                resolve();\r\n            }\r\n        };\r\n\r\n        const setPromise = function (extent, options) {\r\n            self._setExtentPromise = new Promise(function (resolve, reject) {\r\n                // Timeout porque OL3 no tiene evento featuresadded, por tanto cuando se activa map.options.zoomToMarkers\r\n                // se lanza un setExtent por marcador. El timeout evita ejecuciones a lo tonto.\r\n                clearTimeout(self._timeout);\r\n                self._timeout = setTimeout(function () {\r\n                    var mapSize = self.map.getSize();\r\n                    var view = self.map.getView();\r\n\r\n                    if (self.parent.baseLayer) {\r\n                        self.parent.baseLayer.wrap.getLayer().then(function (olLayer) {\r\n                            // Todo esto para evitar que haga más zoom que el admisible por la capa base\r\n                            var olSource = olLayer.getSource();\r\n                            if (olSource.getResolutions != goog.abstractMethod) {\r\n                                var res = view.getResolutionForExtent(extent, mapSize);\r\n                                var resolutions = self.map.getView().getResolutions();\r\n\r\n                                if (resolutions && resolutions.length > 0) {\r\n                                    var minRes = Math.min.apply(self, resolutions);\r\n                                    if (minRes > res) {\r\n                                        var factor = 0.5 * (minRes / res - 1);\r\n                                        var dx = ol.extent.getWidth(extent) * factor;\r\n                                        var dy = ol.extent.getHeight(extent) * factor;\r\n                                        extent = extent.slice(0);\r\n                                        extent[0] = extent[0] - dx;\r\n                                        extent[1] = extent[1] - dy;\r\n                                        extent[2] = extent[2] + dx;\r\n                                        extent[3] = extent[3] + dy;\r\n                                    }\r\n                                }\r\n                            }\r\n\r\n                            applyExtent(view, mapSize, resolve, reject);\r\n\r\n                        });\r\n                    }\r\n                    else {\r\n                        applyExtent(view, mapSize, resolve, reject);\r\n                    }\r\n                }, 50);\r\n            });\r\n        };\r\n        Promise.resolve(self._setExtentPromise).finally(function () {\r\n            setPromise(extent, options);\r\n        });\r\n\r\n        return self._setExtentPromise;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getExtent = function () {\r\n        return this.map.getView().calculateExtent(this.map.getSize());\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setCenter = function (coords, options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const callback = function () {\r\n                resolve();\r\n            };\r\n\r\n            const opts = options || {};\r\n            const view = self.map.getView();\r\n\r\n            if (opts.animate) {\r\n                view.animate({\r\n                    center: coords, duration: TC.Consts.ZOOM_ANIMATION_DURATION\r\n                }, callback);\r\n            }\r\n            else {\r\n                view.setCenter(coords);\r\n                resolve();\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getCenter = function () {\r\n        return this.map.getView().getCenter();\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getResolution = function () {\r\n        return this.map.getView().getResolution();\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setResolution = function (resolution) {\r\n        this.getMap().then(function (olMap) {\r\n            olMap.getView().setResolution(resolution);\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.setRotation = function (rotation) {\r\n        this.getMap().then(function (olMap) {\r\n            olMap.getView().setRotation(rotation);\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getRotation = function () {\r\n        return this.map.getView().getRotation();\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getResolutions = function () {\r\n        return this.map.getView().getResolutions() || [];\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getCoordinateFromPixel = function (xy) {\r\n        return this.map.getCoordinateFromPixel(xy);\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getPixelFromCoordinate = function (coord) {\r\n        return this.map.getPixelFromCoordinate(coord);\r\n    };\r\n\r\n    TC.wrap.Map.prototype.getViewport = function (options) {\r\n        const self = this;\r\n        var result;\r\n        var opts = options || {\r\n        };\r\n        if (opts.synchronous) {\r\n            result = self.map.getViewport();\r\n        }\r\n        else {\r\n            result = new Promise(function (resolve, reject) {\r\n                self.getMap().then(function (olMap) {\r\n                    resolve(olMap.getViewport());\r\n                });\r\n            });\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.isNative = function (map) {\r\n        return map instanceof ol.Map;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.isGeo = function () {\r\n        var units = this.map.getView().getProjection().getUnits();\r\n        return !units || units === ol.proj.Units.DEGREES;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.addPopup = function (popupCtl) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var draggable = popupCtl.options.draggable === undefined || popupCtl.options.draggable;\r\n            TC.loadJS(\r\n                draggable && !window.Draggabilly,\r\n                [TC.apiLocation + 'lib/draggabilly/draggabilly.pkgd.min.js'],\r\n                function () {\r\n                    self.getMap().then(function (olMap) {\r\n                        if (!popupCtl.popupDiv) {\r\n                            // No popups yet\r\n                            const popupDiv = TC.Util.getDiv();\r\n                            popupCtl.popupDiv = popupDiv;\r\n                            popupCtl.$popupDiv = $(popupDiv);\r\n                            popupDiv.classList.add(TC.control.Popup.prototype.CLASS);\r\n                            popupCtl.contentDiv = TC.Util.getDiv();\r\n                            popupCtl.contentDiv.classList.add(TC.control.Popup.prototype.CLASS + '-content');\r\n                            popupCtl.popupDiv.appendChild(popupCtl.contentDiv);\r\n                            popupCtl.menuDiv = TC.Util.getDiv();\r\n                            popupCtl.menuDiv.classList.add(TC.control.Popup.prototype.CLASS + '-menu');\r\n                            popupCtl.popupDiv.appendChild(popupCtl.menuDiv);\r\n                            self.parent.div.appendChild(popupDiv);\r\n\r\n                            var popup = new ol.Overlay({\r\n                                element: popupDiv,\r\n                                positioning: ol.OverlayPositioning.BOTTOM_LEFT\r\n                            });\r\n                            olMap.addOverlay(popup);\r\n                            popupCtl.wrap.popup = popup;\r\n\r\n                            //popupCtl._firstRender.resolve();\r\n                            //popupCtl.trigger(TC.Consts.event.CONTROLRENDER);\r\n                            const olMapViewport = olMap.getViewport();\r\n\r\n                            if (draggable) {\r\n                                const container = popupCtl.popupDiv.parentElement;\r\n                                popupCtl.popupDiv.classList.add(TC.Consts.classes.DRAGGABLE);\r\n\r\n\r\n                                container.addEventListener('touchmove', function (e) {\r\n                                    var parent = e.target;\r\n                                    while (parent) {\r\n                                        parent = parent.parentElement;\r\n                                        if (parent  && parent.matches('.tc-ctl-finfo-layer-content')) {\r\n                                            e.stopPropagation();\r\n                                            break;\r\n                                        }\r\n                                    }\r\n                                });\r\n\r\n                                // Tuneamos Draggabilly para que acepte excepciones a los asideros del elemento.\r\n                                const drag = new Draggabilly(container, {\r\n                                    not: 'th,td, td *,input,select,.tc-ctl-finfo-coords'\r\n                                });\r\n                                drag.handleEvent = function (event) {\r\n                                    if (this.options.not && event.target && event.target.matches(this.options.not)) {\r\n                                        return;\r\n                                    }\r\n                                    Draggabilly.prototype.handleEvent.call(this, event);\r\n                                };\r\n                                drag.on('pointerDown', function (e, pointer) {\r\n                                    var bcr = e.target.getBoundingClientRect();\r\n                                    // Si estamos pulsando sobre una barra de scroll abortamos drag\r\n                                    if (bcr.left + e.target.clientWidth < pointer.pageX || bcr.top + e.target.clientHeight < pointer.pageY) {\r\n                                        drag._pointerCancel(e, pointer);\r\n                                        return false;\r\n                                    }\r\n                                });\r\n                                drag.on('dragStart', function (e, pointer) {\r\n                                    popupCtl.setDragging(true);\r\n                                    popupCtl._currentOffset = popup.getOffset();\r\n                                    if (popupCtl._previousContainerPosition) {\r\n                                        var mapSize = olMap.getSize();\r\n                                        popup.setPosition(olMap.getCoordinateFromPixel([popupCtl._previousContainerPosition[0], mapSize[1] - popupCtl._previousContainerPosition[1]]));\r\n                                        popupCtl._currentOffset = [0, 0];\r\n                                        popup.setOffset(popupCtl._currentOffset);\r\n                                        delete popupCtl._previousContainerPosition;\r\n                                    }\r\n                                    else {\r\n                                        popupCtl._currentOffset = popup.getOffset();\r\n                                    }\r\n                                });\r\n                                drag.on('dragEnd', function (e) {\r\n                                    popupCtl.setDragging(false);\r\n                                    var coord1 = olMap.getCoordinateFromPixel([0, 0]);\r\n                                    var coord2 = olMap.getCoordinateFromPixel(popup.getOffset());\r\n                                    var coordDelta = [coord2[0] - coord1[0], coord2[1] - coord1[1]];\r\n                                    var position = popup.getPosition();\r\n                                    popup.setPosition([position[0] + coordDelta[0], position[1] + coordDelta[1]]);\r\n                                    popup.setOffset([0, 0]);\r\n                                    popupCtl._currentOffset = [0, 0];\r\n\r\n                                    const containerRect = container.getBoundingClientRect();\r\n                                    popupCtl._previousContainerPosition = [containerRect.left, containerRect.bottom];\r\n                                });\r\n                                drag.on('dragMove', function (e, pointer, moveVector) {\r\n                                    //popup.setOffset([popupCtl._currentOffset[0] + moveVector.x, popupCtl._currentOffset[1] + moveVector.y]);\r\n                                });\r\n                                //.drag(function (ev, dd) {\r\n                                //    if (!ev.buttons && !Modernizr.touch) { // Evitamos que se mantenga el drag si no hay botón pulsado (p.e. en IE pulsando una scrollbar)\r\n                                //        return false;\r\n                                //    }\r\n                                //    popup.setOffset([popupCtl._currentOffset[0] + dd.deltaX, popupCtl._currentOffset[1] + dd.deltaY]);\r\n                                //}, {\r\n                                //    not: 'th,td, td *,input,select,.tc-ctl-finfo-coords'\r\n                                //    })                                \r\n                            }\r\n\r\n                            const mouseMoveHandler = function (e) {\r\n                                var mapTarget = olMap.getTarget();\r\n                                var hit = false;\r\n                                if (!self.parent.activeControl || !self.parent.activeControl.isExclusive()) {\r\n                                    var pixel = olMap.getEventPixel(e);\r\n                                    hit = olMap.forEachFeatureAtPixel(pixel, function (feature, layer) {\r\n                                        var result = true;\r\n                                        if (feature._wrap && !feature._wrap.parent.showsPopup) {\r\n                                            result = false;\r\n                                        }\r\n                                        return result;\r\n                                    },\r\n                                    {\r\n                                        hitTolerance: hitTolerance\r\n                                    });\r\n                                }\r\n                                if (hit) {\r\n                                    mapTarget.style.cursor = 'pointer';\r\n                                } else {\r\n                                    mapTarget.style.cursor = '';\r\n                                }\r\n                            };\r\n\r\n                            // change mouse cursor when over marker\r\n                            olMapViewport.removeEventListener(MOUSEMOVE, mouseMoveHandler);\r\n                            olMapViewport.addEventListener(MOUSEMOVE, mouseMoveHandler);\r\n                        }\r\n                    });\r\n                    resolve();\r\n                }\r\n            );\r\n        });\r\n    };\r\n\r\n    TC.wrap.Map.prototype.hidePopup = function (popupCtl) {\r\n        var self = this;\r\n        self.parent.currentFeature = null;\r\n        if (popupCtl.popupDiv) {\r\n            popupCtl.popupDiv.classList.remove(TC.Consts.classes.VISIBLE);\r\n        }\r\n    };\r\n\r\n    TC.wrap.Map.prototype.manageSize = function () {\r\n        const self = this;\r\n\r\n        // Para controlar que el mapa no se vea borroso porque no encajan el width y height con los width y height de CSS\r\n        const manageSize = function (event) {\r\n            var pixelRatio = window.devicePixelRatio || 1;\r\n            var canvas = event.context.canvas;\r\n            var bounding = canvas.getBoundingClientRect();\r\n\r\n            var idealWidth = pixelRatio * bounding.width;\r\n            var idealHeight = pixelRatio * bounding.height;\r\n\r\n            if (idealWidth !== bounding.width || !Number.isInteger(idealWidth)) {\r\n                idealWidth = Math.round(idealWidth);\r\n            }\r\n\r\n            if (idealHeight !== bounding.height || !Number.isInteger(idealHeight)) {\r\n                idealHeight = Math.round(idealHeight);\r\n            }\r\n\r\n            if (idealWidth !== bounding.width || idealHeight !== bounding.height) {\r\n                var newSize = [idealWidth, idealHeight];\r\n                event.target.setSize(newSize);\r\n            }\r\n        };\r\n\r\n        if (!TC.Util.detectMobile()) {\r\n            self.on(ol.render.EventType.POSTCOMPOSE, manageSize);\r\n        }\r\n    };\r\n\r\n    var getFormatFromName = function (name) {\r\n        switch (name) {\r\n            case TC.Consts.layerType.KML:\r\n            case TC.Consts.mimeType.KML:\r\n                return new ol.format.KML({\r\n                    showPointNames: false\r\n                });\r\n            case TC.Consts.layerType.GPX:\r\n            case TC.Consts.mimeType.GPX:\r\n                return new ol.format.GPX();\r\n            case TC.Consts.layerType.GEOJSON:\r\n            case TC.Consts.mimeType.GEOJSON:\r\n            case TC.Consts.mimeType.JSON:\r\n            case TC.Consts.format.JSON:\r\n                return new ol.format.GeoJSON();\r\n            case TC.Consts.format.GML2:\r\n                return new ol.format.GML2();\r\n            case TC.Consts.format.GML3:\r\n                return new ol.format.GML3Patched();\r\n            case TC.Consts.mimeType.GML:\r\n            case TC.Consts.format.GML:\r\n                return new ol.format.GML();\r\n            case TC.Consts.format.TOPOJSON:\r\n                return new ol.format.TopoJSON();\r\n            case TC.Consts.format.WKT:\r\n                return new ol.format.WKT();\r\n            default:\r\n                return null;\r\n        }\r\n    };\r\n\r\n    TC.wrap.Map.prototype.exportFeatures = function (features, options) {\r\n        var self = this;\r\n        options = options || {};\r\n        var nativeStyle = createNativeStyle({\r\n            styles: self.parent.options.styles\r\n        });\r\n        var olFeatures = features.map(function (elm) {\r\n            var result = elm.wrap.feature;\r\n            // Si la feature no tiene estilo propio le ponemos el definido por la API\r\n            if (!result.getStyle()) {\r\n                result.setStyle(nativeStyle);\r\n            }\r\n            // Miramos si tiene texto, en cuyo caso la features se clona para no contaminar la feature orignal \r\n            // y al clon se le añade el texto como atributo (necesario para exportar etiquetas en KML y GPX)\r\n            const text = getFeatureStyle.call(result).getText();\r\n            if (text) {\r\n                result = result.clone();\r\n                result.setProperties({\r\n                    name: text.getText()\r\n                });\r\n            }\r\n            return result;\r\n        });\r\n        var format = getFormatFromName(options.format);\r\n\r\n        if (format instanceof ol.format.KML) {\r\n            // KML no tiene estilo para puntos aparte del de icono. Para puntos sin icono creamos uno en SVG.\r\n            olFeatures = olFeatures\r\n                .map(function (feature) {\r\n                    const geom = feature.getGeometry();\r\n                    if (geom instanceof ol.geom.Point) {\r\n                        // Si el punto no tiene icono, creamos uno nuevo con un icono generado como data URI a partir del estilo\r\n                        var style = getFeatureStyle.call(feature);\r\n                        const shape = style.getImage();\r\n                        if (shape instanceof ol.style.RegularShape) {\r\n                            const radius = shape.getRadius();\r\n                            const stroke = shape.getStroke();\r\n                            const fill = shape.getFill();\r\n                            const strokeWidth = stroke.getWidth();\r\n                            const diameter = (2 * radius) + strokeWidth + 1;\r\n                            const position = diameter / 2;\r\n                            const canvas = document.createElement('canvas');\r\n                            canvas.width = diameter;\r\n                            canvas.height = diameter;\r\n                            const vectorContext = ol.render.toContext(canvas.getContext('2d'), {\r\n                                size: [diameter, diameter]\r\n                            });\r\n                            const text = style.getText();\r\n                            style = style.clone();\r\n                            style.setText(); // Quitamos el texto para que no salga en el canvas\r\n                            vectorContext.setStyle(style);\r\n                            vectorContext.drawGeometry(new ol.geom.Point([position, position]));\r\n                            const newFeature = new ol.Feature(geom);\r\n                            newFeature.setProperties(feature.getProperties());\r\n                            newFeature.setStyle(new ol.style.Style({\r\n                                image: new ol.style.Icon({\r\n                                    src: canvas.toDataURL('image/png')\r\n                                }),\r\n                                text: text\r\n                            }));\r\n                            return newFeature;\r\n                        }\r\n                    }\r\n                    return feature;\r\n                });\r\n            // KML no pone etiquetas a líneas y polígonos. En esos casos ponemos un punto con la etiqueta.\r\n            const pointsToAdd = [];\r\n            olFeatures.forEach(function (feature) {\r\n                var style = getFeatureStyle.call(feature);\r\n                const geometry = feature.getGeometry();\r\n                const text = style.getText();\r\n                var point;\r\n                if (text) {\r\n                    switch (true) {\r\n                        case geometry instanceof ol.geom.LineString:\r\n                            point = new ol.geom.Point(geometry.getCoordinateAt(0.5));\r\n                            break;\r\n                        case geometry instanceof ol.geom.Polygon:\r\n                            point = geometry.getInteriorPoint();\r\n                            break;\r\n                        case geometry instanceof ol.geom.MultiLineString:\r\n                            // Seleccionamos la línea más larga\r\n                            const lineStrings = geometry.getLineStrings();\r\n                            var maxLength = -1;\r\n                            point = new ol.geom.Point(lineStrings[lineStrings\r\n                                .map(function (line) {\r\n                                    return line.getLength();\r\n                                })\r\n                                .reduce(function (prev, cur, idx) {\r\n                                    if (cur > maxLength) {\r\n                                        maxLength = cur;\r\n                                        return idx;\r\n                                    }\r\n                                    return prev;\r\n                                }, -1)].getCoordinateAt(0.5));\r\n                            break;\r\n                        case geometry instanceof ol.geom.MultiPolygon:\r\n                            // Seleccionamos el polígono más grande\r\n                            const polygons = geometry.getPolygons();\r\n                            var maxArea = -1;\r\n                            point = polygons[polygons\r\n                                .map(function (polygon) {\r\n                                    return polygon.getArea();\r\n                                })\r\n                                .reduce(function (prev, cur, idx) {\r\n                                    if (cur > maxArea) {\r\n                                        maxArea = cur;\r\n                                        return idx;\r\n                                    }\r\n                                    return prev;\r\n                                }, -1)].getInteriorPoint();\r\n                            break;\r\n                        default:\r\n                            break;\r\n                    }\r\n                    if (point) {\r\n                        const newFeature = new ol.Feature(point);\r\n                        newFeature.setStyle(new ol.style.Style({\r\n                            text: text.clone(),\r\n                            image: new ol.style.Icon({\r\n                                crossOrigin: 'anonymous',\r\n                                src: TC.apiLocation + 'TC/css/img/transparent.gif'\r\n                            })\r\n                        }));\r\n                        pointsToAdd.push(newFeature);\r\n                    }\r\n                }\r\n            });\r\n            if (pointsToAdd.length) {\r\n                olFeatures = olFeatures.concat(pointsToAdd);\r\n            }\r\n        }\r\n\r\n        if (format instanceof ol.format.GMLBase) {\r\n\r\n            // Quitamos los espacios en blanco de los nombres de atributo en las features: no son válidos en GML.\r\n            olFeatures = olFeatures.map(function (f) {\r\n                return f.clone();\r\n            });\r\n            olFeatures.forEach(function (f) {\r\n                const values = f.values_\r\n                const keysToChange = [];\r\n                for (var key in values) {\r\n                    if (key.indexOf(' ') >= 0) {\r\n                        keysToChange.push(key);\r\n                    }\r\n                }\r\n                keysToChange.forEach(function (key) {\r\n                    // Quitamos espacios en blanco y evitamos que empiece por un número\r\n                    var newKey = key.replace(/ /g, '_');\r\n                    if (/^\\d/.test(newKey)) {\r\n                        newKey = '_' + newKey;\r\n                    }\r\n                    if (key !== newKey) {\r\n                        while (values[newKey] !== undefined) {\r\n                            newKey += '_';\r\n                        }\r\n                    }\r\n                    values[newKey] = values[key];\r\n                    delete values[key];\r\n                });\r\n            });\r\n\r\n            //Apañamos para que el GML sea válido. Si no lo hacemos, con IE, en ol-debug.js:36514 da un error porque node.localName no existe.\r\n            format.featureNS = \"sitna\";\r\n            format.featureType = \"feature\";\r\n            var featuresNode = format.writeFeaturesNode(olFeatures, {\r\n                featureProjection: self.parent.crs\r\n            });\r\n\r\n            var featureCollectionNode = ol.xml.createElementNS('http://www.opengis.net/gml',\r\n                'FeatureCollection');\r\n            ol.xml.setAttributeNS(featureCollectionNode, 'http://www.w3.org/2001/XMLSchema-instance',\r\n                'xsi:schemaLocation', format.schemaLocation);\r\n            featuresNode.removeAttribute('xmlns:xsi');\r\n            featuresNode.removeAttribute('xsi:schemaLocation');\r\n            featureCollectionNode.appendChild(featuresNode);\r\n            //ol.xml.setAttributeNS(node, 'http://www.w3.org/2001/XMLSchema-instance',\r\n            //    'xsi:schemaLocation', this.schemaLocation);\r\n            //return featureCollectionNode.outerHTML;\r\n        }\r\n\r\n        if (format instanceof ol.format.GPX) {\r\n            // Queremos exportar tracks en vez de routes. OpenLayers exporta LineStrings como routes y MultiLineStrings como tracks.\r\n            olFeatures = olFeatures.map(function (f) {\r\n                const geom = f.getGeometry();\r\n                if (geom instanceof ol.geom.LineString) {\r\n                    f = f.clone();\r\n                    f.setGeometry(new ol.geom.MultiLineString([geom.getCoordinates()]));\r\n                }\r\n                return f;\r\n            });\r\n        }\r\n\r\n        var result = format.writeFeatures(olFeatures, {\r\n            dataProjection: 'EPSG:4326',\r\n            featureProjection: self.parent.crs\r\n        });\r\n        if (format instanceof ol.format.GPX) {\r\n            // Este formato no procesa bien las elevaciones cuando son nulas. Hemos hecho un preproceso para transformarlas en NaN y ahora hay que eliminarlas.\r\n            result = result.replace(/<ele>NaN<\\/ele>/g, '');\r\n        }\r\n        return result;\r\n    };\r\n\r\n    var isFileDrag = function (e) {\r\n        for (var i = 0, len = e.dataTransfer.types.length; i < len; i++) {\r\n            if (e.dataTransfer.types[i] === 'Files') {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    };\r\n\r\n    var handleDragEnter = function (e) {\r\n        var self = this;\r\n        if (isFileDrag(e)) { // Solo hay gestión si lo que se arrastra es un archivo\r\n            self.getMap()._wrap.parent.div.classList.add(TC.Consts.classes.DROP);\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n        }\r\n    };\r\n\r\n    var handleDragExit = function (e) {\r\n        var self = this;\r\n        if (isFileDrag(e)) { // Solo hay gestión si lo que se arrastra es un archivo\r\n            var map = self.getMap()._wrap.parent;\r\n            if (e.target === self.target) {\r\n                map.div.classList.remove(TC.Consts.classes.DROP);\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.Map.prototype.enableDragAndDrop = function (options) {\r\n        var self = this;\r\n        var opts = options || {};\r\n        var ddOptions = {\r\n            formatConstructors: [\r\n                ol.format.KML,\r\n                ol.format.GPX,\r\n                ol.format.GML3CRS84,\r\n                ol.format.GML2CRS84,\r\n                ol.format.GML3Patched,\r\n                ol.format.GML2,\r\n                ol.format.GeoJSON,\r\n                function () {\r\n                    return new ol.format.WKT({\r\n                        splitCollection: true\r\n                    });\r\n                },\r\n                ol.format.TopoJSON\r\n            ]\r\n        };\r\n        if (opts.dropTarget) {\r\n            ddOptions.target = TC.getDiv(opts.dropTarget);\r\n        }\r\n        else {\r\n            ddOptions.target = self.parent.div;\r\n        }\r\n        var ddInteraction = new ol.interaction.DragAndDrop(ddOptions);\r\n        ddInteraction.on(ol.interaction.DragAndDrop.EventType_.ADD_FEATURES, function (e) {\r\n            var featurePromises = e.features ? e.features.map(function (elm) {\r\n                return TC.wrap.Feature.createFeature(elm);\r\n            }) : [];\r\n            Promise.all(featurePromises).then(function (features) {\r\n                var li = self.parent.getLoadingIndicator();\r\n                if (li) {\r\n                    li.removeWait(self._featureImportWaitId);\r\n                }\r\n                if (features.length && !(features.some(function (feature) {\r\n                    return !feature.geometry\r\n                }))) {\r\n                    self.parent.trigger(TC.Consts.event.FEATURESIMPORT, {\r\n                        features: features, fileName: e.file.name, dropTarget: e.target.target\r\n                    });\r\n                }\r\n                else {\r\n                    self.parent.trigger(TC.Consts.event.FEATURESIMPORTERROR, {\r\n                        file: e.file\r\n                    });\r\n                }\r\n            });\r\n        });\r\n        if (opts.once) {\r\n            ddInteraction.map_ = self.map;\r\n        }\r\n        else {\r\n            self.map.addInteraction(ddInteraction);\r\n            var dropArea = ddInteraction.target ? ddInteraction.target : self.map.getViewport();\r\n            // Añadidos gestores de eventos para mostrar el indicador visual de drop.\r\n            var handleDrop = function (e) {\r\n                if (isFileDrag(e)) { // Solo hay gestión si lo que se arrastra es un archivo\r\n                    var map = self.parent;\r\n                    if (ddInteraction.target === e.target) {\r\n                        var li = map.getLoadingIndicator();\r\n                        if (li) {\r\n                            self._featureImportWaitId = li.addWait();\r\n                        }\r\n                        e.stopPropagation();\r\n                    }\r\n                    else {\r\n                        e.preventDefault();\r\n                    }\r\n                    map.div.classList.remove(TC.Consts.classes.DROP);\r\n                }\r\n            };\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(dropArea, ol.events.EventType.DRAGENTER,\r\n                    handleDragEnter, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, ol.events.EventType.DRAGENTER,\r\n                    handleDragEnter, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(dropArea, ol.events.EventType.DRAGOVER,\r\n                    handleDragEnter, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, ol.events.EventType.DRAGOVER,\r\n                    handleDragEnter, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(dropArea, ol.events.EventType.DROP,\r\n                    handleDrop, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, ol.events.EventType.DROP,\r\n                    handleDrop, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, 'dragleave',\r\n                    handleDragExit, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, 'dragend',\r\n                    handleDragExit, ddInteraction)\r\n            );\r\n            ddInteraction.dropListenKeys_.push(\r\n                ol.events.listen(document.body, 'dragexit',\r\n                    handleDragExit, ddInteraction)\r\n            );\r\n            document.addEventListener('mouseenter', function (e) {\r\n                if (!e.buttons) {\r\n                    self.parent.div.classList.remove(TC.Consts.classes.DROP);\r\n                }\r\n            }, false);\r\n            self.ddEnabled = true;\r\n        }\r\n        return ddInteraction;\r\n    };\r\n\r\n    TC.wrap.Map.prototype.loadFiles = function (files, options) {\r\n        var self = this;\r\n        var ddInteraction;\r\n        if (self.ddEnabled) {\r\n            self.map.getInteractions().forEach(function (elm) {\r\n                if (elm instanceof ol.interaction.DragAndDrop) {\r\n                    ddInteraction = elm;\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            ddInteraction = self.enableDragAndDrop({\r\n                once: true\r\n            });\r\n        }\r\n\r\n        if (ddInteraction && options) {\r\n            var currentTarget = ddInteraction.target;\r\n            ddInteraction.target = options.control;\r\n            const undoTarget = function (e) {\r\n                ddInteraction.target = currentTarget;\r\n\r\n                self.parent.off(TC.Consts.event.FEATURESIMPORT, undoTarget);\r\n            };\r\n            self.parent.on(TC.Consts.event.FEATURESIMPORT, undoTarget);\r\n        }\r\n\r\n        var li = self.parent.getLoadingIndicator();\r\n        if (li) {\r\n            self._featureImportWaitId = li.addWait();\r\n        }\r\n        ol.interaction.DragAndDrop.handleDrop_.call(ddInteraction, {\r\n            dataTransfer: {\r\n                files: files\r\n            }\r\n        });\r\n    };\r\n\r\n    /*\r\n     *  getVisibility: gets the OpenLayers layer visibility\r\n     *  Result: boolean\r\n     */\r\n    TC.wrap.Layer.prototype.getVisibility = function (visible) {\r\n        var self = this;\r\n        var result = false;\r\n        if (self.layer) {\r\n            result = self.layer.getVisible();\r\n        }\r\n        return result;\r\n    };\r\n\r\n    /*\r\n     *  setVisibility: Sets the OpenLayers layer visibility\r\n     *  Parameter: boolean\r\n     */\r\n    TC.wrap.Layer.prototype.setVisibility = function (visible) {\r\n        var self = this;\r\n        self.getLayer().then(function (layer) {\r\n            layer.setVisible(visible);\r\n        });\r\n    };\r\n\r\n    TC.wrap.Layer.prototype.isNative = function (layer) {\r\n        return layer instanceof ol.layer.Layer;\r\n    };\r\n\r\n    TC.wrap.Layer.prototype.setProjection = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        const layer = self.parent;\r\n        if (layer.map) {\r\n            const unitRatio = getUnitRatio.call(self, {\r\n                crs: options.crs,\r\n                extentInDegrees: ol.proj.transformExtent(layer.map.getExtent(), layer.map.crs, 'EPSG:4326')\r\n            });\r\n\r\n            var resolutions = layer.getResolutions();\r\n            if (resolutions && resolutions.length) {\r\n                resolutions = resolutions.map(function (r) {\r\n                    return r / unitRatio;\r\n                });\r\n                layer.wrap.layer.setMaxResolution(resolutions[0]);\r\n                layer.wrap.layer.setMinResolution(resolutions[resolutions.length - 1]);\r\n            }\r\n            else {\r\n                if (layer.minResolution) {\r\n                    layer.minResolution = layer.minResolution / unitRatio;\r\n                    self.layer.setMinResolution(layer.minResolution);\r\n                }\r\n                if (layer.maxResolution) {\r\n                    layer.maxResolution = layer.maxResolution / unitRatio;\r\n                    self.layer.setMaxResolution(layer.maxResolution);\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.WmsParser = ol.format.WMSCapabilities;\r\n\r\n    TC.wrap.layer.Raster.prototype.WmtsParser = ol.format.WMTSCapabilities;\r\n\r\n    TC.wrap.Layer.prototype.addCommonEvents = function (layer) {\r\n        var self = this;\r\n        layer.on('change:visible', function () {\r\n            if (self.parent.map) {\r\n                self.parent.map.trigger(TC.Consts.event.LAYERVISIBILITY, {\r\n                    layer: self.parent\r\n                });\r\n            }\r\n        }, self.parent.map);\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getGetMapUrl = function () {\r\n        var result = null;\r\n        var self = this;\r\n        switch (self.getServiceType()) {\r\n            case TC.Consts.layerType.WMS:\r\n                var dcpType = self.parent.capabilities.Capability.Request.GetMap.DCPType;\r\n                for (var i = 0; i < dcpType.length; i++) {\r\n                    if (dcpType[i].HTTP && dcpType[i].HTTP.Get) {\r\n                        result = dcpType[i].HTTP.Get.OnlineResource;\r\n                        break;\r\n                    }\r\n                }\r\n                break;\r\n            case TC.Consts.layerType.WMTS:\r\n                result = self.parent.capabilities.OperationsMetadata.GetTile.DCP.HTTP.Get[0].href;\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        const fragment = document.createDocumentFragment();\r\n        const textarea = document.createElement('textarea');\r\n        fragment.appendChild(textarea);\r\n        textarea.innerHTML = result;\r\n        result = textarea.textContent;\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getInfoFormats = function () {\r\n        var result = null;\r\n        var c = this.parent.capabilities;\r\n        if (c.Capability && c.Capability.Request.GetFeatureInfo) {\r\n            result = c.Capability.Request.GetFeatureInfo.Format;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.infoFormatPreference = [\r\n        'application/json',\r\n        'application/vnd.ogc.gml/3.1.1',\r\n        'application/vnd.ogc.gml',\r\n        'application/vnd.esri.wms_featureinfo_xml',\r\n        'text/html',\r\n        'text/plain',\r\n        'text/xml'\r\n    ];\r\n\r\n    TC.wrap.layer.Raster.prototype.getWMTSLayer = function () {\r\n        var result = null;\r\n        var self = this;\r\n        var capabilities = self.parent.capabilities;\r\n        if (capabilities && capabilities.Contents) {\r\n            for (var i = 0; i < capabilities.Contents.Layer.length; i++) {\r\n                var layer = capabilities.Contents.Layer[i];\r\n                for (var j = 0; j < layer.TileMatrixSetLink.length; j++) {\r\n                    if (self.parent.options.matrixSet === layer.TileMatrixSetLink[j].TileMatrixSet) {\r\n                        result = layer;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getTileMatrix = function (matrixSet) {\r\n        var result = null;\r\n        var self = this;\r\n        var capabilities = self.parent.capabilities;\r\n        if (capabilities && capabilities.Contents && capabilities.Contents.TileMatrixSet) {\r\n            for (var i = 0; i < capabilities.Contents.TileMatrixSet.length; i++) {\r\n                var tms = capabilities.Contents.TileMatrixSet[i];\r\n                if (tms.Identifier === matrixSet) {\r\n                    result = tms.TileMatrix;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getScaleDenominators = function (node) {\r\n        var result = [];\r\n        var self = this;\r\n        if (node.ScaleDenominator) {\r\n            result = [node.ScaleDenominator, node.ScaleDenominator];\r\n        }\r\n        else {\r\n            if (node.MinScaleDenominator || node.MaxScaleDenominator) {\r\n                result = [node.MaxScaleDenominator, node.MinScaleDenominator];\r\n            }\r\n        }\r\n        // Contemplamos el caso de una capa sin nombre: sus escalas válidas serán las de sus hijas.\r\n        if (!result.length && !self.getName(node)) {\r\n            var children = self.getLayerNodes(node);\r\n            var max = -Infinity, min = Infinity;\r\n            for (var i = 0, len = children.length; i < len; i++) {\r\n                var childDenominators = self.getScaleDenominators(children[i]);\r\n                if (childDenominators[0] > max) {\r\n                    max = childDenominators[0];\r\n                }\r\n                if (childDenominators[1] < min) {\r\n                    min = childDenominators[1];\r\n                }\r\n            }\r\n            if (max > -Infinity && min < Infinity) {\r\n                result = [max, min];\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getAttribution = function () {\r\n        const self = this;\r\n        const result = {};\r\n        const capabilities = TC.capabilities[self.parent.url];\r\n\r\n        if (capabilities) {\r\n            if (capabilities.ServiceProvider) {\r\n                result.name = capabilities.ServiceProvider.ProviderName.trim();\r\n                result.site = capabilities.ServiceProvider.ProviderSite;\r\n                if (result.site.href && result.site.href.trim().length > 0) {\r\n                    result.site = result.site.href;\r\n                }\r\n            }\r\n            else if (capabilities.ServiceIdentification) {\r\n                result.name = capabilities.ServiceIdentification.Title.trim();\r\n            }\r\n            else {\r\n                result.name = capabilities.Service.Title.trim();\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getInfo = function (name) {\r\n        var self = this;\r\n        var result = {};\r\n        var capabilities = self.parent.capabilities;\r\n        if (capabilities && capabilities.Capability) {\r\n            var layerNodes = self.getAllLayerNodes();\r\n            for (var i = 0; i < layerNodes.length; i++) {\r\n                var l = layerNodes[i];\r\n                if (self.parent.compareNames(self.getName(l), name)) {\r\n                    if (l.Title) {\r\n                        result.title = l.Title;\r\n                    }\r\n                    if (l.Abstract) {\r\n                        result['abstract'] = l.Abstract;\r\n                    }\r\n                    result.legend = [];\r\n\r\n                    var _process = function (value) {\r\n                        var legend = this.getLegend(value);\r\n\r\n                        if (legend.src)\r\n                            result.legend.push({\r\n                                src: legend.src, title: value.Title\r\n                            });\r\n                    };\r\n\r\n                    var _traverse = function (o, func) {\r\n                        if (o.Layer && o.Layer.length > 0) {\r\n                            for (var i in o.Layer) {\r\n                                //bajar un nivel en el árbol\r\n                                _traverse(o.Layer[i], func);\r\n                            }\r\n                        } else {\r\n                            func.apply(self, [o]);\r\n                        }\r\n                    };\r\n\r\n                    //Obtenemos todas las leyendas de la capa o grupo de capas\r\n                    _traverse(l, _process);\r\n\r\n                    if (l.MetadataURL && l.MetadataURL.length) {\r\n                        result.metadata = [];\r\n                        for (var j = 0; j < l.MetadataURL.length; j++) {\r\n                            var md = l.MetadataURL[j];\r\n                            result.metadata.push({\r\n                                format: md.Format, type: md.type, url: md.OnlineResource\r\n                            });\r\n                        }\r\n                    }\r\n                    result.queryable = l.queryable;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getServiceType = function () {\r\n        var result = null;\r\n        var capabilities = this.parent.capabilities;\r\n        if (capabilities.Capability && capabilities.Capability.Request && capabilities.Capability.Request.GetMap) {\r\n            result = TC.Consts.layerType.WMS;\r\n        }\r\n        else if (capabilities.OperationsMetadata && capabilities.OperationsMetadata.GetTile) {\r\n            result = TC.Consts.layerType.WMTS;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getServiceTitle = function () {\r\n        var result = null;\r\n        var capabilities = this.parent.capabilities;\r\n        if (capabilities.Capability && capabilities.Service) {\r\n            result = capabilities.Service.Title;\r\n        }\r\n        else if (capabilities.ServiceIdentification) {\r\n            result = capabilities.ServiceIdentification.Title;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getRootLayerNode = function () {\r\n        var self = this;\r\n        var result;\r\n        if (self.getServiceType() === TC.Consts.layerType.WMS) {\r\n            result = self.parent.capabilities.Capability.Layer;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getName = function (node, ignorePrefix) {\r\n        var result = node.Name;\r\n        if (result && ignorePrefix) {\r\n            var idx = result.indexOf(':');\r\n            if (idx >= 0) {\r\n                result = result.substr(idx + 1);\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getIdentifier = function (node) {\r\n        return node.Identifier;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getLayerNodes = function (node) {\r\n        var result = node.Layer;\r\n        if (!$.isArray(result)) {\r\n            if (result) {\r\n                result = [result];\r\n            }\r\n            else {\r\n                result = [];\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getAllLayerNodes = function () {\r\n        var self = this;\r\n        if (!self._layerList) {\r\n            switch (self.getServiceType()) {\r\n                case TC.Consts.layerType.WMS:\r\n                    var getNodeArray = function getNodeArray(node) {\r\n                        var r = [node];\r\n                        var children = self.getLayerNodes(node);\r\n                        for (var i = 0; i < children.length; i++) {\r\n                            r = r.concat(getNodeArray(children[i]));\r\n                        }\r\n                        return r;\r\n                    };\r\n                    var root = self.getRootLayerNode();\r\n                    self._layerList = root ? getNodeArray(root) : [];\r\n                    break;\r\n                case TC.Consts.layerType.WMTS:\r\n                    self._layerList = self.parent.capabilities.Contents.Layer.slice();\r\n                    break;\r\n                default:\r\n                    self._layerList = [];\r\n                    break;\r\n            }\r\n        }\r\n        return self._layerList;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.normalizeLayerNode = function (node) {\r\n        return node;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.normalizeCapabilities = function (capabilities) {\r\n        return capabilities;\r\n    };\r\n\r\n\r\n    TC.wrap.layer.Raster.prototype.getLegend = function (node) {\r\n        var result = {};\r\n        var styles = node.Style;\r\n        if (styles && styles.length) {\r\n            if (styles.length && styles[0].LegendURL && styles[0].LegendURL.length) {\r\n                var legend = styles[0].LegendURL[0];\r\n\r\n                const fragment = document.createDocumentFragment();\r\n                const textarea = document.createElement('textarea');\r\n                fragment.appendChild(textarea);\r\n                textarea.innerHTML = legend.OnlineResource;\r\n                result.src = textarea.textContent;\r\n                // Eliminado porque GeoServer miente con el tamaño de sus imágenes de la leyenda\r\n                //if (legend.size) {\r\n                //    result.width = legend.size[0];\r\n                //    result.height = legend.size[1];\r\n                //}\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.isCompatible = function (crs) {\r\n        var self = this;\r\n        var result = true;\r\n        var layer = self.parent;\r\n        switch (self.getServiceType()) {\r\n            case TC.Consts.layerType.WMS:\r\n                if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                    if (layer.names.length > 0) {\r\n                        var names = layer.names.slice(0);\r\n                        var _isCompatible = function _isCompatible(nodes, name, inCrs) {\r\n                            var r = false;\r\n                            if (nodes) {\r\n                                for (var i = 0; i < nodes.length; i++) {\r\n                                    var n = nodes[i];\r\n                                    const itemCRS = n.CRS || n.SRS;\r\n                                    const crsList = Array.isArray(itemCRS) ? itemCRS : [itemCRS];\r\n                                    var isIn = inCrs || $.inArray(crs, crsList) >= 0;\r\n                                    if (layer.compareNames(self.getName(n), name)) {\r\n                                        if (isIn) {\r\n                                            r = true;\r\n                                        }\r\n                                        break;\r\n                                    }\r\n                                    else if (_isCompatible(n.Layer, name, isIn)) {\r\n                                        r = true;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                            }\r\n                            return r;\r\n                        };\r\n                        while (names.length > 0) {\r\n                            if (!_isCompatible([layer.capabilities.Capability.Layer], names.pop())) {\r\n                                result = false;\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            case TC.Consts.layerType.WMTS:\r\n                result = false;\r\n                if (layer.capabilities && layer.capabilities.Contents && layer.capabilities.Contents.TileMatrixSet) {\r\n                    var tms = layer.capabilities.Contents.TileMatrixSet;\r\n                    for (var i = 0; i < tms.length; i++) {\r\n                        if (tms[i].Identifier === layer.options.matrixSet) {\r\n                            result = TC.Util.CRSCodesEqual(crs, tms[i].SupportedCRS);\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getCompatibleCRS = function () {\r\n        var self = this;\r\n        var result = [];\r\n        var layer = self.parent;\r\n        switch (self.getServiceType()) {\r\n            case TC.Consts.layerType.WMS:\r\n                if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                    if (layer.names.length > 0) {\r\n                        const crsLists = layer.names\r\n                            .map(function (name) {\r\n                                return layer\r\n                                    .getNodePath(name) // array de nodos\r\n                                    .map(function (node) {\r\n                                        const itemCRS = node.CRS || node.SRS || [];\r\n                                        const crsList = Array.isArray(itemCRS) ? itemCRS : [itemCRS];\r\n                                        return $.isArray(crsList) ? crsList : [crsList];\r\n                                    }) // array de arrays de crs\r\n                                    .reduce(function (prev, cur) {\r\n                                        if (prev.length === 0) {\r\n                                            return cur;\r\n                                        }\r\n                                        cur.forEach(function (elm) {\r\n                                            if (prev.indexOf(elm) < 0) {\r\n                                                prev[prev.length - 1] = elm;\r\n                                            }\r\n                                        });// array con todos los crs\r\n                                        return prev;\r\n                                    }, []);\r\n                            });\r\n\r\n                        if (crsLists.length === 1) {\r\n                            result = crsLists[0];\r\n                        } else {\r\n                            const otherCrsLists = crsLists.slice(1);\r\n                            result = crsLists[0].filter(function (elm) {\r\n                                return otherCrsLists.every(function (crsList) {\r\n                                    return crsList.indexOf(elm) >= 0;\r\n                                });\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            case TC.Consts.layerType.WMTS:\r\n                if (layer.capabilities && layer.capabilities.Contents) {\r\n                    layer.capabilities.Contents.Layer\r\n                        .filter(function (l) {\r\n                            return l.Identifier === layer.layerNames;\r\n                        })  // La capa de interés\r\n                        .forEach(function (l) {\r\n                            const tileMatrixSets = l.TileMatrixSetLink\r\n                                .map(function (tmsl) {\r\n                                    return tmsl.TileMatrixSet;\r\n                                });\r\n                            result = layer.capabilities.Contents.TileMatrixSet\r\n                                .filter(function (tms) {\r\n                                    return tileMatrixSets.indexOf(tms.Identifier) >= 0;\r\n                                }) // TileMatrixSets asociados a la capa de interés\r\n                                .map(function (tms) {\r\n                                    return tms.SupportedCRS;\r\n                                });\r\n                        });\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getCompatibleLayers = function (crs) {\r\n        var self = this;\r\n        var result = [];\r\n        var layer = self.parent;\r\n        switch (self.getServiceType()) {\r\n            case TC.Consts.layerType.WMS:\r\n                if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                    var _fnrecursive = function (item, crs, inCrs) {\r\n                        var crsToCheck = item.CRS || item.SRS;\r\n                        var itemCRS = Array.isArray(crsToCheck) ? crsToCheck : [crsToCheck];\r\n                        var isIn = inCrs || $.inArray(crs, itemCRS) >= 0;\r\n                        if (isIn && item.Name) result[result.length] = item.Name;\r\n                        if (item.Layer) {\r\n                            for (var i = 0; i < item.Layer.length; i++) {\r\n                                _fnrecursive(item.Layer[i], crs, isIn);\r\n                            }\r\n                        }\r\n                    }\r\n                    _fnrecursive(layer.capabilities.Capability.Layer, crs);\r\n                }\r\n                break;\r\n            case TC.Consts.layerType.WMTS:\r\n                if (layer.capabilities && layer.capabilities.Contents && layer.capabilities.Contents.TileMatrixSet) {\r\n                    var tmsList = layer.capabilities.Contents.TileMatrixSet;\r\n                    for (var i = 0, ii = tmsList.length; i < ii; i++) {\r\n                        var tms = tmsList[i];\r\n                        if (TC.Util.CRSCodesEqual(crs, tms.SupportedCRS)) {\r\n                            var tmsIdentifier = tms.Identifier;\r\n                            var layerList = layer.capabilities.Contents.Layer;\r\n                            for (var j = 0, jj = layerList.length; j < jj; j++) {\r\n                                var tmsLinkList = layerList[j].TileMatrixSetLink;\r\n                                for (var k = 0, kk = tmsLinkList.length; k < kk; k++) {\r\n                                    if (tmsLinkList[k].TileMatrixSet === tmsIdentifier) {\r\n                                        result[result.length] = layerList[j].Identifier;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getCompatibleMatrixSets = function (crs) {\r\n        var self = this;\r\n        var result = [];\r\n        normalizeProjection({\r\n            crs: crs\r\n        });\r\n        var layer = self.parent;\r\n        if (self.getServiceType() === TC.Consts.layerType.WMTS) {\r\n            var layerList = layer.capabilities.Contents.Layer;\r\n            var tmsList = layer.capabilities.Contents.TileMatrixSet;\r\n            for (var i = 0, ii = layerList.length; i < ii; i++) {\r\n                if (layer.layerNames === layerList[i].Identifier) {\r\n                    var tmsLinkList = layerList[i].TileMatrixSetLink;\r\n                    for (var j = 0, jj = tmsLinkList.length; j < jj; j++) {\r\n                        var tmsLink = tmsLinkList[j];\r\n                        for (var k = 0, kk = tmsList.length; k < kk; k++) {\r\n                            var tms = tmsList[k];\r\n                            if (tms.Identifier === tmsLink.TileMatrixSet) {\r\n                                if (TC.Util.CRSCodesEqual(crs, tms.SupportedCRS)) {\r\n                                    result[result.length] = tms.Identifier;\r\n                                }\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.setWMTSUrl = function () {\r\n        var self = this;\r\n\r\n        self.getLayer().then(function (l) {\r\n            self.parent.options = self.parent.options || {};\r\n            var urls = l.getSource().getUrls();\r\n            self.parent.options.urlPattern = urls[urls.length - 1];\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.createWMSLayer = function (url, params, options) {\r\n        const self = this;\r\n        var result = null;\r\n\r\n        var source = new ol.source.ImageWMS({\r\n            url: url,\r\n            crossOrigin: options.map ? options.map.options.crossOrigin : undefined,\r\n            params: params,\r\n            extent: TC.Cfg.initialExtent,\r\n            ratio: TC.Cfg.imageRatio,\r\n            imageLoadFunction: $.proxy(self.parent.getImageLoad, self.parent)\r\n        });\r\n\r\n        source.on(ol.source.Image.EventType_.IMAGELOADSTART, function (e) {\r\n            self.trigger(TC.Consts.event.BEFORETILELOAD, {\r\n                tile: e.image.getImage()\r\n            });\r\n        });\r\n        source.on(ol.source.Image.EventType_.IMAGELOADEND, function (e) {\r\n            self.trigger(TC.Consts.event.TILELOAD, {\r\n                tile: e.image.getImage()\r\n            });\r\n        });\r\n        source.on(ol.source.Image.EventType_.IMAGELOADERROR, function (e) {\r\n            self.trigger(TC.Consts.event.TILELOAD, {\r\n                tile: e.image.getImage()\r\n            });\r\n        });\r\n\r\n\r\n        var layerOptions = {\r\n            visible: !!params.LAYERS.length || (options && options.method && options.method === 'POST'), //Las capas de temáticos cargadas por POST no tienen el atributo LAYERS\r\n            source: source\r\n        };\r\n\r\n        if (options.minResolution) {\r\n            layerOptions.minResolution = options.minResolution;\r\n        }\r\n        if (options.maxResolution) {\r\n            layerOptions.maxResolution = options.maxResolution;\r\n        }\r\n        result = new ol.layer.Image(layerOptions);\r\n\r\n        result._wrap = self;\r\n\r\n        self.addCommonEvents(result);\r\n\r\n        return result;\r\n    };\r\n\r\n    var createWmtsSource = function (options) {\r\n        var self = this;\r\n        var result = null;\r\n        var sourceOptions = ol.source.WMTS.optionsFromCapabilities(self.parent.capabilities, {\r\n            layer: options.layerNames,\r\n            matrixSet: options.matrixSet,\r\n            crossOrigin: options.map ? options.map.options.crossOrigin : undefined,\r\n            requestEncoding: options.encoding,\r\n            format: options.format,\r\n        });\r\n        var https = 'https:';\r\n\r\n        if (sourceOptions) {\r\n            if (location.protocol === https) {\r\n                sourceOptions.urls = sourceOptions.urls.map(function (elm) {\r\n                    return elm.replace('http:', https);\r\n                });\r\n            }\r\n\r\n            sourceOptions.crossOrigin = options.map ? options.map.options.crossOrigin : undefined;\r\n\r\n            result = new ol.source.WMTS(sourceOptions);\r\n            result.setTileLoadFunction($.proxy(self.parent.getImageLoad, self.parent));\r\n\r\n            result.on(ol.source.TileEventType.TILELOADSTART, function (e) {\r\n                self.trigger(TC.Consts.event.BEFORETILELOAD, {\r\n                    tile: e.tile.getImage()\r\n                });\r\n            });\r\n            result.on(ol.source.TileEventType.TILELOADEND, function (e) {\r\n                self.trigger(TC.Consts.event.TILELOAD, {\r\n                    tile: e.tile.getImage()\r\n                });\r\n            });\r\n            result.on(ol.source.TileEventType.TILELOADERROR, function (e) {\r\n                self.trigger(TC.Consts.event.TILELOAD, {\r\n                    tile: e.tile.getImage()\r\n                });\r\n            });\r\n\r\n            var prevFn = $.proxy(result.getResolutions, result);\r\n            result.getResolutions = function () {\r\n                var resolutions = prevFn();\r\n                var matrix = self.parent.getLimitedMatrixSet();\r\n                //esto está mal, porque matrix podría empezar más abajo (tener recortado por ambos lados)\r\n                if (matrix && matrix.length) {\r\n                    var ix = matrix[0].matrixIndex;\r\n                    resolutions = resolutions.slice(ix, matrix.length + ix);\r\n                }\r\n\r\n                return resolutions;\r\n            };\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.createWMTSLayer = function (options) {\r\n        const self = this;\r\n        var result = null;\r\n\r\n        var source = createWmtsSource.call(self, options);\r\n\r\n        if (source) {\r\n            var layerOptions = {\r\n                source: source\r\n            };\r\n            if (options.minResolution) {\r\n                layerOptions.minResolution = options.minResolution;\r\n            }\r\n            if (options.maxResolution) {\r\n                layerOptions.maxResolution = options.maxResolution;\r\n            }\r\n            result = new ol.layer.Tile(layerOptions);\r\n            result._wrap = self;\r\n\r\n            self.addCommonEvents(result);\r\n\r\n            var resolutions = source.getResolutions();\r\n            //Este +1 tan chungo es porque, en el caso en que la resolución del mapa es igual a la máxima del layer, openLayers lo oculta\r\n            result.setMaxResolution(resolutions[0] + 1);\r\n            result.setMinResolution(resolutions[resolutions.length - 1]);\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n\r\n    /*\r\n     *  getParams: Gets the WMS layer getmap parameters\r\n     *  Returns: object\r\n     */\r\n    TC.wrap.layer.Raster.prototype.getParams = function () {\r\n        return this.layer.getSource().getParams();\r\n    };\r\n\r\n    /*\r\n     *  setParams: Sets the WMS layer getmap parameters\r\n     *  Parameter: object\r\n     */\r\n    TC.wrap.layer.Raster.prototype.setParams = function (params) {\r\n        this.layer.getSource().updateParams(params);\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.setMatrixSet = function (matrixSet) {\r\n        const self = this;\r\n        const oldResolutions = self.layer.getSource().getResolutions();\r\n        if (self.parent.type === TC.Consts.layerType.WMTS) {\r\n            const newSource = createWmtsSource.call(self, $.extend({}, self.parent.options, { matrixSet: matrixSet }));\r\n            const newResolutions = newSource.getResolutions();\r\n            const newMaxResolution = newResolutions[0]\r\n            const newMinResolution = newResolutions[newResolutions.length - 1];\r\n            self.layer.setMaxResolution(newMaxResolution);\r\n            self.layer.setMinResolution(newMinResolution);\r\n            if (self.parent.minResolution) {\r\n                self.parent.minResolution = newMinResolution;\r\n            }\r\n            if (self.parent.maxResolution) {\r\n                self.parent.maxResolution = newMaxResolution;\r\n            }\r\n            self.layer.setSource(newSource);\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Raster.prototype.getResolutions = function () {\r\n        if (this.layer.getSource) {\r\n            var ts = this.layer.getSource();\r\n            if (ts.getResolutions && ts.getResolutions != goog.abstractMethod) return ts.getResolutions();\r\n            else return [];\r\n        }\r\n        else {\r\n            return [];\r\n        }\r\n    };\r\n\r\n    TC.wrap.Geometry = {\r\n        getNearest: function (point, candidates) {\r\n            var pline = new ol.geom.LineString(candidates);\r\n            return pline.getClosestPoint(point);\r\n        }\r\n    };\r\n\r\n    // En OL3 la imagen tiene el tamaño original. Escalamos si hace falta.\r\n    var setScaleFunction = function (imageStyle, iconWidth, olFeat) {\r\n        if (imageStyle) {\r\n            var setScaleForWidth = function (imgWidth) {\r\n                var markerWidth = (olFeat && olFeat._wrap ? olFeat._wrap.parent.options.width : null) || iconWidth;\r\n                if (markerWidth < imgWidth) {\r\n                    var factor = markerWidth / imgWidth;\r\n                    imageStyle.setScale(factor);\r\n                }\r\n            };\r\n            var imageSize = imageStyle.getSize();\r\n            if (imageSize) {\r\n                setScaleForWidth(imageSize[0]);\r\n            }\r\n            else {\r\n                var img = imageStyle.getImage();\r\n                if (img.naturalWidth) {\r\n                    setScaleForWidth(img.naturalWidth);\r\n                }\r\n                else {\r\n                    const fragment = document.createDocumentFragment();\r\n                    const img = document.createElement('img');\r\n                    img.src = imageStyle.getSrc();\r\n                    img.addEventListener('load', function () {\r\n                        setScaleForWidth(this.naturalWidth);\r\n                    });\r\n                    fragment.appendChild(img);\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    var getStyleValue = function (property, feature) {\r\n        var result = property;\r\n        var olFeat = feature && feature.wrap && feature.wrap.feature;\r\n        if (typeof property === 'string') {\r\n            var match = property.match(/^\\$\\{(.+)\\}$/);\r\n            if (match && olFeat) {\r\n                // Permitimos el formato ${prop.subprop.subsubprop}\r\n                var m = match[1].split('.');\r\n                var r = olFeat.getProperties();\r\n                for (var i = 0; i < m.length && r !== undefined; i++) {\r\n                    r = r[m[i]];\r\n                }\r\n                if (r === undefined) {\r\n                    r = feature.data;\r\n                    for (var i = 0; i < m.length && r !== undefined; i++) {\r\n                        r = r[m[i]];\r\n                    }\r\n                }\r\n                result = r;\r\n            }\r\n        }\r\n        else if ($.isFunction(property)) {\r\n            result = property(feature);\r\n        }\r\n        return result;\r\n    };\r\n\r\n    var getNativeStyle = function (olFeat) {\r\n        var result = olFeat.getStyle();\r\n        if ($.isFunction(result)) {\r\n            result = result.call(olFeat);\r\n        }\r\n        if ($.isArray(result)) {\r\n            result = result[0];\r\n        }\r\n        return result;\r\n    };\r\n\r\n    // Transformación de opciones de estilo en un estilo nativo OL3.\r\n    var createNativeStyle = function (options, olFeat) {\r\n        var nativeStyleOptions = {\r\n        };\r\n\r\n        var feature;\r\n        var isPoint, isLine, isPolygon;\r\n        if (olFeat) {\r\n            switch (olFeat.getGeometry().getType()) {\r\n                case 'Point':\r\n                case 'MultiPoint':\r\n                    isPoint = true;\r\n                    break;\r\n                case 'LineString':\r\n                case 'MultiLineString':\r\n                    isLine = true;\r\n                    break;\r\n                case 'Polygon':\r\n                case 'MultiPolygon':\r\n                    isPolygon = true;\r\n                    break;\r\n            }\r\n            if (olFeat._wrap) {\r\n                feature = olFeat._wrap.parent;\r\n            }\r\n            else {\r\n                // Si la API SITNA no ha completado su feature, creamos un mock-up para que no fallen las funciones de estilo\r\n                feature = {\r\n                    id: TC.wrap.Feature.prototype.getId.call({\r\n                        feature: olFeat\r\n                    }), // GLS añado el id de la feature para poder filtrar por la capa a la cual pertenece                    \r\n                    features: olFeat.get('features'),\r\n                    getData: function () {\r\n                        return TC.wrap.Feature.prototype.getData.call({\r\n                            feature: olFeat\r\n                        });\r\n                    }\r\n                };\r\n\r\n\r\n            }\r\n        }\r\n        var isCluster = feature && $.isArray(feature.features) && feature.features.length > 1 && options.cluster;\r\n        var styles;\r\n        if (isCluster) {\r\n            styles = $.extend(true, {}, TC.Cfg.styles.cluster, options.cluster.styles);\r\n        }\r\n        else {\r\n            styles = options.styles || TC.Cfg.styles;\r\n        }\r\n\r\n        var styleOptions = {};\r\n        if (styles.line && (isLine || !olFeat)) {\r\n            styleOptions = styles.line;\r\n            nativeStyleOptions.stroke = new ol.style.Stroke({\r\n                color: getStyleValue(styles.line.strokeColor, feature),\r\n                width: getStyleValue(styles.line.strokeWidth, feature),\r\n                lineDash: styles.line.lineDash\r\n            });\r\n        }\r\n\r\n        if (styles.polygon && (isPolygon || !olFeat)) {\r\n            styleOptions = styles.polygon;\r\n            nativeStyleOptions.fill = new ol.style.Fill({\r\n                color: getRGBA(getStyleValue(styles.polygon.fillColor, feature), getStyleValue(styles.polygon.fillOpacity, feature))\r\n            });\r\n            nativeStyleOptions.stroke = new ol.style.Stroke({\r\n                color: getStyleValue(styles.polygon.strokeColor, feature),\r\n                width: getStyleValue(styles.polygon.strokeWidth, feature),\r\n                lineDash: styles.polygon.lineDash\r\n            });\r\n        }\r\n\r\n        if (styles.point && (isPoint || !olFeat)) {\r\n            styleOptions = styles.point;\r\n            var circleOptions = {\r\n                radius: getStyleValue(styleOptions.radius, feature) ||\r\n                (getStyleValue(styleOptions.height, feature) + getStyleValue(styleOptions.width, feature)) / 4\r\n            };\r\n            if (styleOptions.fillColor) {\r\n                circleOptions.fill = new ol.style.Fill({\r\n                    color: getRGBA(getStyleValue(styleOptions.fillColor, feature), getStyleValue(styleOptions.fillOpacity, feature))\r\n                });\r\n            }\r\n            if (styleOptions.strokeColor) {\r\n                circleOptions.stroke = new ol.style.Stroke({\r\n                    color: getStyleValue(styleOptions.strokeColor, feature),\r\n                    width: getStyleValue(styleOptions.strokeWidth, feature),\r\n                    lineDash: styleOptions.lineDash\r\n                });\r\n            }\r\n\r\n            if (!isNaN(circleOptions.radius))\r\n                nativeStyleOptions.image = new ol.style.Circle(circleOptions);\r\n        }\r\n\r\n        if (styleOptions.label) {\r\n            nativeStyleOptions.text = createNativeTextStyle(styleOptions, feature);\r\n        }\r\n\r\n        if (styles.marker && (isPoint || !olFeat)) {\r\n            styleOptions = styles.marker;\r\n            var ANCHOR_DEFAULT_UNITS = 'fraction';\r\n            if (styleOptions.url) {\r\n                nativeStyleOptions.image = new ol.style.Icon({\r\n                    crossOrigin: 'anonymous',\r\n                    anchor: styleOptions.anchor,\r\n                    anchorXUnits: styleOptions.anchorXUnits || ANCHOR_DEFAULT_UNITS,\r\n                    anchorYUnits: styleOptions.anchorYUnits || ANCHOR_DEFAULT_UNITS,\r\n                    src: styleOptions.url\r\n                });\r\n                nativeStyleOptions.text = createNativeTextStyle(styleOptions, feature);\r\n            }\r\n        }\r\n\r\n        return [new ol.style.Style(nativeStyleOptions)];\r\n    };\r\n\r\n    const createNativeTextStyle = function (styleObj, feature) {\r\n        if (!styleObj || !styleObj.label) {\r\n            return;\r\n        }\r\n\r\n        const textOptions = {\r\n            text: '' + getStyleValue(styleObj.label, feature),\r\n        };\r\n        //const olGeom = feature.wrap.feature.getGeometry();\r\n        //if (olGeom instanceof ol.geom.LineString || olGeom instanceof ol.geom.MultiLineString) {\r\n        //    textOptions.placement = ol.style.TextPlacement.LINE;\r\n        //}\r\n        if (styleObj.fontSize) {\r\n            textOptions.font = getStyleValue(styleObj.fontSize, feature) + 'pt sans-serif';\r\n        }\r\n        if (styleObj.angle) {\r\n            textOptions.rotation = -Math.PI * getStyleValue(styleObj.angle, feature) / 180;\r\n        }\r\n        if (styleObj.fontColor) {\r\n            textOptions.fill = new ol.style.Fill({\r\n                color: getRGBA(getStyleValue(styleObj.fontColor, feature), 1)\r\n            });\r\n        }\r\n        if (styleObj.labelOutlineColor) {\r\n            textOptions.stroke = new ol.style.Stroke({\r\n                color: getRGBA(getStyleValue(styleObj.labelOutlineColor, feature), 1),\r\n                width: getStyleValue(styleObj.labelOutlineWidth, feature)\r\n            });\r\n        }\r\n        if (styleObj.labelOffset) {\r\n            textOptions.offsetX = styleObj.labelOffset[0];\r\n            textOptions.offsetY = styleObj.labelOffset[1];\r\n        }\r\n        return new ol.style.Text(textOptions);\r\n    };\r\n\r\n    var toHexString = function (number) {\r\n        var result = number.toString(16);\r\n        if (result.length === 1) {\r\n            result = '0' + result;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    var getHexColorFromArray = function (colorArray) {\r\n        return '#' + toHexString(colorArray[0]) + toHexString(colorArray[1]) + toHexString(colorArray[2])\r\n    };\r\n\r\n    var getStyleFromNative = function (olStyle, olFeat) {\r\n        var result = {\r\n        };\r\n        if ($.isFunction(olStyle)) {\r\n            if (olFeat) {\r\n                olStyle = olStyle(olFeat);\r\n            }\r\n        }\r\n        if ($.isArray(olStyle)) {\r\n            olStyle = olStyle[0];\r\n        }\r\n        if (!$.isFunction(olStyle)) {\r\n            var color;\r\n            var stroke;\r\n            var fill;\r\n            var image = olStyle.getImage();\r\n            if (image) {\r\n                if (image instanceof ol.style.RegularShape) {\r\n                    stroke = image.getStroke();\r\n                    color = ol.color.asArray(stroke.getColor());\r\n                    result.strokeColor = getHexColorFromArray(color);\r\n                    result.strokeWidth = stroke.getWidth();\r\n                    fill = image.getFill();\r\n                    if (fill) {\r\n                        color = ol.color.asArray(fill.getColor());\r\n                        result.fillColor = getHexColorFromArray(color);\r\n                        result.fillOpacity = color[3];\r\n                    }\r\n                }\r\n                else {\r\n                    result.url = image.getSrc();\r\n                    var size = image.getSize();\r\n                    if (size) {\r\n                        result.width = size[0];\r\n                        result.height = size[1];\r\n                        result.anchor = image.getAnchor();\r\n                        if (result.anchor) {\r\n                            result.anchor[0] = result.anchor[0] / result.width;\r\n                            result.anchor[1] = result.anchor[1] / result.height;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                stroke = olStyle.getStroke();\r\n                if (stroke) {\r\n                    color = ol.color.asArray(stroke.getColor());\r\n                    result.strokeColor = getHexColorFromArray(color);\r\n                    result.strokeWidth = stroke.getWidth();\r\n                    result.lineDash = stroke.getLineDash();\r\n                }\r\n                fill = olStyle.getFill();\r\n                if (fill) {\r\n                    color = ol.color.asArray(fill.getColor());\r\n                    result.fillColor = getHexColorFromArray(color);\r\n                    result.fillOpacity = color[3];\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getStyle = function () {\r\n        return getStyleFromNative(this.layer.getStyle());\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.reloadSource = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const layerOptions = self.createVectorSource(self.parent, self.createStyles(self.parent));\r\n\r\n            if (self.parent.type === TC.Consts.layerType.WFS) {\r\n                var listenerKey = layerOptions.source.on('change', function (e) {\r\n                    if (layerOptions.source.getState() == 'ready') {\r\n                        ol.Observable.unByKey(listenerKey);\r\n\r\n                        resolve();\r\n                    }\r\n                });\r\n            }\r\n\r\n            var features = self.layer.getSource().getFeatures();\r\n            self.layer.setSource(layerOptions.source);\r\n\r\n            if (layerOptions.style)\r\n                self.layer.setStyle(layerOptions.style);\r\n\r\n            if (self.parent.type != TC.Consts.layerType.WFS) {\r\n                layerOptions.source.addFeatures(features);\r\n                resolve();\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.import = function (options) {\r\n        var self = this;\r\n        var opts = $.extend({\r\n        }, options);\r\n        opts.type = options.format;\r\n\r\n        var oldFeatures = self.layer.getSource().getFeatures();\r\n        var layerOptions = self.createVectorSource(opts, self.createStyles(self.parent));\r\n        self.layer.setSource(layerOptions.source);\r\n        if (layerOptions.style) {\r\n            self.layer.setStyle(layerOptions.style);\r\n        }\r\n\r\n        layerOptions.source.addFeatures(oldFeatures);\r\n    };\r\n\r\n    const getIcon = function (olFeat) {\r\n        var result = null;\r\n        var style = getNativeStyle(olFeat);\r\n        if (style) {\r\n            var img = style.getImage();\r\n            if (img instanceof ol.style.Icon) {\r\n                result = img.getSrc();\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    const createFeatureFromNative = function (olFeat) {\r\n        if (!olFeat._wrapPromise) { // Si no se ha llamado antes a esta función para esta feature\r\n            olFeat._wrapPromise = new Promise(function (resolve, reject) {\r\n                var options;\r\n                var geom = olFeat.getGeometry();\r\n                const olStyle = olFeat.getStyle();\r\n                if (olStyle) {\r\n                    options = getStyleFromNative(olStyle, olFeat);\r\n                }\r\n\r\n                const resolveFn = function (ctorName) {\r\n                    if (ctorName) {\r\n                        TC.loadJS(\r\n                            !TC.feature || !TC.feature[ctorName],\r\n                            TC.apiLocation + 'TC/feature/' + ctorName,\r\n                            function () {\r\n                                resolve(new TC.feature[ctorName](olFeat, options));\r\n                            }\r\n                        );\r\n                    }\r\n                    else {\r\n                        resolve(new TC.Feature(olFeat, options));\r\n                    }\r\n                };\r\n\r\n                if (geom instanceof ol.geom.Point) {\r\n                    if (getIcon(olFeat)) {\r\n                        resolveFn('Marker');\r\n                    }\r\n                    else {\r\n                        resolveFn('Point');\r\n                    }\r\n                }\r\n                else if (geom instanceof ol.geom.LineString) {\r\n                    resolveFn('Polyline');\r\n                }\r\n                else if (geom instanceof ol.geom.Polygon) {\r\n                    resolveFn('Polygon');\r\n                }\r\n                else if (geom instanceof ol.geom.MultiLineString) {\r\n                    resolveFn('MultiPolyline');\r\n                }\r\n                else if (geom instanceof ol.geom.MultiPolygon) {\r\n                    resolveFn('MultiPolygon');\r\n                }\r\n                else {\r\n                    resolveFn();\r\n                }\r\n            });\r\n        }\r\n        return olFeat._wrapPromise;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.createVectorSource = function (options, nativeStyle) {\r\n        var self = this;\r\n\r\n        var createGenericLoader = function (url, format) {\r\n            var internalLoader = ol.featureloader.xhr(url, format);\r\n            return function (extent, resolution, projection) {\r\n                self.parent.state = TC.Layer.state.LOADING;\r\n                if (self.parent.map) {\r\n                    self.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE, {\r\n                        layer: self.parent\r\n                    });\r\n                }\r\n                internalLoader.call(this, extent, resolution, projection);\r\n            };\r\n        };\r\n        var usesGenericLoader = false;\r\n\r\n        var source;\r\n        var vectorOptions;\r\n\r\n        var getMimeTypeFromUrl = function (url) {\r\n            var idx = url.indexOf('?');\r\n            if (idx >= 0) {\r\n                url = url.substr(0, idx);\r\n            }\r\n            else {\r\n                idx = url.indexOf('#');\r\n                if (idx >= 0) {\r\n                    url = url.substr(0, idx);\r\n                }\r\n            }\r\n            switch (url.substr(url.lastIndexOf('.') + 1).toLowerCase()) {\r\n                case 'kml':\r\n                    return TC.Consts.mimeType.KML;\r\n                case 'json':\r\n                case 'geojson':\r\n                    return TC.Consts.mimeType.GEOJSON;\r\n                case 'gml':\r\n                    return TC.Consts.mimeType.GML;\r\n                case 'gpx':\r\n                    return TC.Consts.mimeType.GPX;\r\n                default:\r\n                    return null;\r\n            }\r\n        };\r\n\r\n        if ($.isArray(options.url) || options.urls) {\r\n            var urls = options.urls || options.url;\r\n            urls = $.map(urls, function (elm, idx) {\r\n                return TC.proxify(elm);\r\n            });\r\n            vectorOptions = {\r\n                url: urls,\r\n                format: new ol.format.KML({\r\n                    showPointNames: false\r\n                }),\r\n                projection: options.crs\r\n            };\r\n        }\r\n        else if (options.url && options.type !== TC.Consts.layerType.WFS) {\r\n            vectorOptions = {\r\n                url: TC.proxify(options.url),\r\n                projection: options.crs\r\n            };\r\n            vectorOptions.format = getFormatFromName(options.format) || getFormatFromName(getMimeTypeFromUrl(options.url)) || getFormatFromName(options.type);\r\n            vectorOptions.loader = createGenericLoader(vectorOptions.url, vectorOptions.format);\r\n            usesGenericLoader = true;\r\n        }\r\n        else if (options.data) {\r\n            vectorOptions = {\r\n                projection: options.crs,\r\n                loader: function (extent, resolution, projection) {\r\n                    self.parent.state = TC.Layer.state.LOADING;\r\n                    if (self.parent.map) {\r\n                        self.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE, {\r\n                            layer: self.parent\r\n                        });\r\n                    }\r\n                    var format = this.getFormat();\r\n                    try {\r\n                        var fs = format.readFeatures(options.data, {\r\n                            featureProjection: projection\r\n                        });\r\n                        this.addFeatures(fs);\r\n                        self.parent.state = TC.Layer.state.IDLE;\r\n                        if (self.parent.map) {\r\n                            self.parent.map.trigger(TC.Consts.event.LAYERUPDATE, {\r\n                                layer: self.parent, newData: data\r\n                            });\r\n                        }\r\n                    }\r\n                    catch (e) {\r\n                        self.parent.state = TC.Layer.state.IDLE;\r\n                        if (self.parent.map) {\r\n                            self.parent.map.trigger(TC.Consts.event.LAYERERROR, {\r\n                                layer: self.parent, reason: e.message\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            };\r\n            vectorOptions.format = getFormatFromName(options.format) || getFormatFromName(options.type);\r\n        }\r\n        else if (options.type == TC.Consts.layerType.WFS) {\r\n            var outputFormat;\r\n            var mimeType;\r\n            switch (options.outputFormat) {\r\n                case TC.Consts.format.JSON:\r\n                    outputFormat = new ol.format.GeoJSON({\r\n                        geometryName: options.geometryName\r\n                    });\r\n                    mimeType = 'json';\r\n                    break;\r\n                case TC.Consts.format.GML3:\r\n                    outputFormat = new ol.format.GML3Patched();\r\n                    mimeType = TC.Consts.mimeType.GML;\r\n                    break;\r\n                default:\r\n                    outputFormat = new ol.format.GML2();\r\n                    mimeType = TC.Consts.mimeType.GML;\r\n                    break;\r\n            }\r\n            vectorOptions = {\r\n                format: outputFormat,\r\n                loader: function (extent, resolution, projection) {\r\n                    var sOrigin = this;\r\n                    var serviceUrl = options.url;\r\n                    if (serviceUrl) {\r\n                        self.parent.state = TC.Layer.state.LOADING;\r\n                        self.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE, {\r\n                            layer: self.parent\r\n                        });\r\n                        var ajaxOptions = {};\r\n                        var crs = projection.getCode();\r\n                        var version = options.version || '1.1.0';\r\n                        var url = serviceUrl;\r\n                        var featureType = $.isArray(options.featureType) ? options.featureType : [options.featureType];\r\n                        if (!options.properties || (options.properties instanceof Array && !options.properties.length) || !(Object.keys(options.properties).length)) {\r\n                            url = url + '?service=WFS&' +\r\n                                'version=' + version + '&request=GetFeature&typename=' + featureType.join(',') + '&' +\r\n                                'outputFormat=' + mimeType + '&srsname=' + crs;\r\n                            if (extent[0] !== -Infinity && extent[1] !== -Infinity && extent[2] !== Infinity && extent[3] !== Infinity) {\r\n                                url = url + '&bbox=' + extent.join(',') + ',' + crs;\r\n                            }\r\n\r\n                            if (options.maxFeatures)\r\n                                url = url + \"maxFeatures=\" + options.maxFeatures;\r\n                        }\r\n                        else {\r\n                            ajaxOptions.method = 'POST';\r\n                            switch (mimeType) {\r\n                                case 'json':\r\n                                    ajaxOptions.responseType = TC.Consts.mimeType.JSON;\r\n                                    break;\r\n                                default:\r\n                                    ajaxOptions.responseType = TC.Consts.mimeType.XML;\r\n                                    break;\r\n\r\n                            }\r\n                            //ajaxOptions.contentType = TC.Consts.mimeType.XML;\r\n                            //ajaxOptions.processData = false;\r\n                            //var formatter = new ol.format.WFS();\r\n                            //var doc = formatter.writeGetFeature({\r\n                            //    featureNS: 'wfs',\r\n                            //    featurePrefix: 'feature',\r\n                            //    featureTypes: featureType,\r\n                            //    srsName: crs\r\n                            //});\r\n                            //var filter = [];\r\n                            //filter[0] = '<ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\">';\r\n                            //if (options.properties.length > 1) {\r\n                            //    filter[filter.length] = '<ogc:And>';\r\n                            //}\r\n                            //for (var j = 0; j < options.properties.length; j++) {\r\n                            //    var prop = options.properties[j];\r\n                            //    filter[filter.length] = '<ogc:PropertyIsEqualTo matchCase=\"true\"><ogc:PropertyName>';\r\n                            //    filter[filter.length] = prop.name;\r\n                            //    filter[filter.length] = '</ogc:PropertyName><ogc:Literal>';\r\n                            //    filter[filter.length] = prop.value;\r\n                            //    filter[filter.length] = '</ogc:Literal></ogc:PropertyIsEqualTo>';\r\n                            //}\r\n                            //if (options.properties.length > 1) {\r\n                            //    filter[filter.length] = '</ogc:And>';\r\n                            //}\r\n                            //filter[filter.length] = '</ogc:Filter>';\r\n                            //filter = filter.join('');\r\n                            //var $doc = $(doc);\r\n                            //$doc.find('Query').each(function (idx, query) {\r\n                            //    $(query).html(filter);\r\n                            //});\r\n                            //ajaxOptions.data = $('<div>').append($doc).html();\r\n                            var gml = [];\r\n                            gml[gml.length] = '<wfs:GetFeature xmlns:wfs=\"http://www.opengis.net/wfs\" service=\"WFS\" version=\"';\r\n                            gml[gml.length] = version;\r\n                            gml[gml.length] = '\" outputFormat=\"';\r\n                            gml[gml.length] = options.outputFormat;\r\n                            if (options.maxFeatures) {\r\n                                gml[gml.length] = '\" maxFeatures=\"';\r\n                                gml[gml.length] = options.maxFeatures;\r\n                            }\r\n                            gml[gml.length] = '\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/';\r\n                            gml[gml.length] = version;\r\n                            gml[gml.length] = '/wfs.xsd\">';\r\n                            for (var i = 0; i < featureType.length; i++) {\r\n                                gml[gml.length] = '<wfs:Query typeName=\"feature:';\r\n                                gml[gml.length] = featureType[i];\r\n                                gml[gml.length] = '\" srsName=\"';\r\n                                gml[gml.length] = crs;\r\n                                gml[gml.length] = '\">';\r\n                                if (options.propertynames) {\r\n                                    var pPrefix = version === '1.1.0' ? 'wfs' : 'ogc';\r\n                                    var _arrProperties = typeof (options.propertynames) === \"string\" ? options.propertynames.split(\",\") : options.propertynames\r\n                                    if (options.geometryName)\r\n                                        _arrProperties.push(options.geometryName)\r\n                                    for (var i; i < _arrProperties.length; i++) {\r\n                                        gml[gml.length] = '<' + pPrefix + ':PropertyName>' + _arrProperties[i].trim() + '</' + pPrefix + ':PropertyName>';\r\n                                    }\r\n                                }\r\n                                gml[gml.length] = options.properties.getText();\r\n                                gml[gml.length] = '</wfs:Query>';\r\n                            }\r\n                            gml[gml.length] = '</wfs:GetFeature>';\r\n\r\n                            ajaxOptions.data = gml.join('');\r\n                            ajaxOptions.contentType = TC.Consts.mimeType.XML;\r\n                        }\r\n                        ajaxOptions.url = url;\r\n                        self._requestUrl = url;\r\n                        TC.ajax(ajaxOptions).then(function (data) {\r\n                            const feats = outputFormat.readFeatures(data);\r\n                            const triggerLayerUpdate = function () {\r\n                                self.parent.map.trigger(TC.Consts.event.LAYERUPDATE, {\r\n                                    layer: self.parent, newData: data\r\n                                });\r\n                            };\r\n                            const onFeaturesAdd = function (e) {\r\n                                if (e.layer === self.parent) {\r\n                                    self.parent.map.off(TC.Consts.event.FEATURESADD, onFeaturesAdd);\r\n                                    triggerLayerUpdate();\r\n                                }\r\n                            };\r\n                            if (feats.length) {\r\n                                sOrigin.addFeatures(feats);\r\n                                self.parent.map.on(TC.Consts.event.FEATURESADD, onFeaturesAdd);\r\n                            }\r\n                            else {\r\n                                triggerLayerUpdate();\r\n                            }\r\n                            self.parent.state = TC.Layer.state.IDLE;\r\n                        });\r\n                    }\r\n                },\r\n                //strategy: ol.loadingstrategy.all(),\r\n                projection: options.crs\r\n            };\r\n        }\r\n\r\n        source = new ol.source.Vector(vectorOptions);\r\n\r\n        if (usesGenericLoader) {\r\n            source.on(ol.events.EventType.CHANGE, function (e) {\r\n                if (self.parent.map) {\r\n                    self.parent.map.trigger(TC.Consts.event.LAYERUPDATE, {\r\n                        layer: self.parent\r\n                    });\r\n                }\r\n            });\r\n        }\r\n\r\n        source._tcLayer = self.parent;\r\n\r\n        var markerStyle = options.style && options.style.marker ? options.style.marker : TC.Cfg.styles.marker;\r\n        if (!options.style || !options.style.marker) {\r\n            markerStyle = $.extend({}, markerStyle, {\r\n                anchor: TC.Cfg.styles.point.anchor\r\n            });\r\n        }\r\n\r\n        // Si habilitamos el clustering la fuente es especial\r\n        if (options.cluster) {\r\n            source = new ol.source.Cluster({\r\n                projection: options.crs,\r\n                distance: options.cluster.distance,\r\n                source: source\r\n            });\r\n\r\n            // Animación\r\n            if (options.cluster.animate) {\r\n                var getCurrentCoordinates = function (fromCoords, toCoords, duration, start) {\r\n                    var fraction = Math.min((Date.now() - start) / duration, 1);\r\n                    var dx = (toCoords[0] - fromCoords[0]) * fraction;\r\n                    var dy = (toCoords[1] - fromCoords[1]) * fraction;\r\n                    return [fromCoords[0] + dx, fromCoords[1] + dy];\r\n                };\r\n                var animate = function (parent, child) {\r\n                    var start = Date.now();\r\n                    var pCoords = parent.getGeometry().getCoordinates();\r\n                    var cCoords = child.getGeometry().getCoordinates();\r\n                    child.setGeometry(new ol.geom.Point(pCoords));\r\n                    var step = function step() {\r\n                        var coords = getCurrentCoordinates(pCoords, cCoords, TC.Consts.CLUSTER_ANIMATION_DURATION, start);\r\n                        child.setGeometry(new ol.geom.Point(coords));\r\n                        if (coords[0] !== cCoords[0] && coords[1] !== cCoords[1]) {\r\n                            requestAnimationFrame(step);\r\n                        }\r\n                        else {\r\n                            clusterCache.splice($.inArray(parent, clusterCache), 1);\r\n                        }\r\n                    };\r\n                    requestAnimationFrame(step);\r\n                };\r\n                var clusterCache = [];\r\n                source.addEventListener(ol.source.VectorEventType.REMOVEFEATURE, function (e) {\r\n                    var features = e.feature.get('features');\r\n                    if (features && features.length > 1) {\r\n                        clusterCache.push(e.feature);\r\n                    }\r\n                });\r\n                source.addEventListener(ol.source.VectorEventType.ADDFEATURE, function (e) {\r\n                    var features = e.feature.get('features');\r\n                    if (features) {\r\n                        var coords = features[0].getGeometry().getCoordinates();\r\n                        if (features.length > 1) {\r\n                            var match = $.grep(clusterCache, function (elm) {\r\n                                var elmCoords = elm.getGeometry().getCoordinates();\r\n                                return elmCoords[0] === coords[0] && elmCoords[1] === coords[1];\r\n                            });\r\n                            if (match.length) {\r\n                                clusterCache.splice($.inArray(match[0], clusterCache), 1);\r\n                            }\r\n                        }\r\n                        var parent = $.grep(clusterCache, function (elm) {\r\n                            var children = elm.get('features');\r\n                            if (children && children.length > 0) {\r\n                                var child = $.grep(children, function (cElm) {\r\n                                    var cCoords = cElm.getGeometry().getCoordinates();\r\n                                    return cCoords[0] === coords[0] && cCoords[1] === coords[1];\r\n                                });\r\n                                return child.length > 0;\r\n                            }\r\n                        });\r\n                        if (parent.length) {\r\n                            animate(parent[parent.length - 1], e.feature);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        }\r\n\r\n        var s = source;\r\n        do {\r\n            s.addEventListener(ol.source.VectorEventType.ADDFEATURE, function (e) {\r\n                var olFeat = e.feature;\r\n                // OL3 dibuja el tamaño original del icono del marcador, lo escalamos si es necesario:\r\n                var style = getNativeStyle(olFeat);\r\n                if (style) {\r\n                    setScaleFunction(style.getImage(), markerStyle.width, olFeat);\r\n                }\r\n            });\r\n            if ($.isFunction(s.getSource)) {\r\n                s = s.getSource();\r\n            }\r\n            else {\r\n                s = null;\r\n            }\r\n        }\r\n        while (s);\r\n\r\n        source.addEventListener(ol.source.VectorEventType.ADDFEATURE, function (e) {\r\n            const olFeat = e.feature;\r\n\r\n            const addFeatureToLayer = function (feat) {\r\n                var addFn;\r\n                switch (true) {\r\n                    case TC.feature.Point && feat instanceof TC.feature.Point:\r\n                        addFn = self.parent.addPoint;\r\n                        break;\r\n                    case TC.feature.Polyline && feat instanceof TC.feature.Polyline:\r\n                        addFn = self.parent.addPolyline;\r\n                        break;\r\n                    case TC.feature.Polygon && feat instanceof TC.feature.Polygon:\r\n                        addFn = self.parent.addPolygon;\r\n                        break;\r\n                    case TC.feature.MultiPolygon && feat instanceof TC.feature.MultiPolygon:\r\n                        addFn = self.parent.addMultiPolygon;\r\n                        break;\r\n                    case TC.feature.MultiPolyline && feat instanceof TC.feature.MultiPolyline:\r\n                        addFn = self.parent.addMultiPolyline;\r\n                        break;\r\n                    default:\r\n                        addFn = self.parent.addFeature;\r\n                        break;\r\n                }\r\n                if (addFn) {\r\n                    var _timeout;\r\n                    addFn.call(self.parent, olFeat).then(function (f) {\r\n                        var features = olFeat.get('features');\r\n                        if ($.isArray(features)) {\r\n                            // Es una feature de fuente ol.source.Cluster\r\n                            f.features = $.map(features, function (elm) {\r\n                                return new feat.constructor(elm);\r\n                            });\r\n                        }\r\n\r\n                        // Timeout porque OL3 no tiene evento featuresadded. El timeout evita ejecuciones a lo tonto.\r\n                        clearTimeout(_timeout);\r\n                        _timeout = setTimeout(function () {\r\n                            self.parent.map.trigger(TC.Consts.event.FEATURESADD, {\r\n                                layer: self.parent, features: [f]\r\n                            });\r\n                        }, 50);\r\n                    });\r\n                }\r\n            };\r\n\r\n            if (!olFeat._wrap || !olFeat._wrap.parent.layer) { // Solo actuar si no es una feature añadida desde la API\r\n                createFeatureFromNative(olFeat).then(addFeatureToLayer);\r\n            }\r\n        });\r\n\r\n        source.addEventListener(ol.source.VectorEventType.REMOVEFEATURE, function (e) {\r\n            var olFeat = e.feature;\r\n            if (olFeat._wrap) {\r\n                var idx = $.inArray(olFeat._wrap.parent, self.parent.features);\r\n                if (idx > -1) {\r\n                    self.parent.features.splice(idx, 1);\r\n                    self.parent.map.trigger(TC.Consts.event.FEATUREREMOVE, {\r\n                        layer: self.parent, feature: olFeat._wrap.parent\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n        source.addEventListener(ol.source.VectorEventType.ADDFEATURE, function (e) {\r\n            if (self.parent.map) {\r\n                self.parent.map.trigger(TC.Consts.event.VECTORUPDATE, {\r\n                    layer: self.parent\r\n                });\r\n            }\r\n        });\r\n\r\n        source.addEventListener(ol.source.VectorEventType.REMOVEFEATURE, function () {\r\n            if (self.parent.map) {\r\n                self.parent.map.trigger(TC.Consts.event.VECTORUPDATE, {\r\n                    layer: self.parent\r\n                });\r\n            }\r\n        });\r\n\r\n        source.addEventListener(ol.source.VectorEventType.CLEAR, function () {\r\n            if (self.parent.map) {\r\n                self.parent.map.trigger(TC.Consts.event.FEATURESCLEAR, {\r\n                    layer: self.parent\r\n                });\r\n            }\r\n        });\r\n\r\n        var layerOptions = {\r\n            source: source\r\n        };\r\n\r\n        if (options.minResolution) {\r\n            layerOptions.minResolution = options.minResolution;\r\n        }\r\n        if (options.maxResolution) {\r\n            layerOptions.maxResolution = options.maxResolution;\r\n        }\r\n\r\n        // En KML conservamos el estilo que viene con el archivo, así que no entramos aquí.\r\n        // A no ser que tenga clusters, porque OL no soporta por defecto la combinación de estilo KML con clusters.\r\n        if (!(vectorOptions && vectorOptions.format instanceof ol.format.KML) || options.cluster) {\r\n            layerOptions.style = nativeStyle || options.styles;\r\n        }\r\n\r\n        return layerOptions;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.createStyles = function (options) {\r\n        var self = this;\r\n\r\n        var dynamicStyle = false;\r\n\r\n        if ($.isFunction(options)) {\r\n            dynamicStyle = true;\r\n            self.styleFunction = function (olFeat) {\r\n                return createNativeStyle(options(olFeat));\r\n            }\r\n        }\r\n        else {\r\n            options = $.extend({}, options);\r\n            options.crs = options.crs || TC.Cfg.crs;\r\n            options.styles = options.styles || TC.Cfg.styles;\r\n            var isDynamicStyle = function isDynamicStyle(obj) {\r\n                for (var key in obj) {\r\n                    var prop = obj[key];\r\n                    switch (typeof prop) {\r\n                        case 'string':\r\n                            if (/^\\$\\{(.+)\\}$/.test(prop)) {\r\n                                return true;\r\n                            }\r\n                            break;\r\n                        case 'object':\r\n                            if (isDynamicStyle(prop)) {\r\n                                return true;\r\n                            }\r\n                            break;\r\n                        case 'function':\r\n                            return true;\r\n                            break;\r\n                        default:\r\n                            break;\r\n                    }\r\n                }\r\n                return false;\r\n            };\r\n\r\n            dynamicStyle = !!(options.cluster && options.cluster.styles) || isDynamicStyle(options.styles);\r\n            self.styleFunction = function (olFeat) {\r\n                return createNativeStyle(self.parent.options, olFeat);\r\n            };\r\n        }\r\n\r\n        var nativeStyle = dynamicStyle ? self.styleFunction : self.styleFunction();\r\n\r\n        return nativeStyle;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.setStyles = function (options) {\r\n        const self = this;\r\n        self.getLayer().then(function (olLayer) {\r\n            olLayer.setStyle(self.createStyles(options));\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.createVectorLayer = function () {\r\n        const self = this;\r\n        var result = null;\r\n\r\n        var options = self.parent.options;\r\n\r\n        var layerOptions = self.createVectorSource(options, self.createStyles(options));\r\n        layerOptions.declutter = self.parent.options.declutter || false;\r\n        result = new ol.layer.Vector(layerOptions);\r\n        result._wrap = self;\r\n\r\n        self.addCommonEvents(result);\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.addFeatures = function (features) {\r\n        const self = this;\r\n        const commit = function (l) {\r\n            var source = l;\r\n            while ($.isFunction(source.getSource)) {\r\n                source = source.getSource();\r\n            }\r\n            source.addFeatures(features);\r\n        };\r\n        if (self.layer) {\r\n            commit(self.layer);\r\n        }\r\n        else {\r\n            self.getLayer().then(commit);\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getFeatures = function () {\r\n        var olLayer = this.getLayer();\r\n        if (olLayer instanceof ol.layer.Layer) {\r\n            return olLayer.getSource().getFeatures();\r\n        }\r\n        else {\r\n            return [];\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getFeatureById = function (id) {\r\n        var olLayer = this.layer;\r\n        if (olLayer instanceof ol.layer.Layer) {\r\n            return olLayer.getSource().getFeatureById(id);\r\n        }\r\n        else {\r\n            return null;\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.removeFeature = function (feature) {\r\n        const self = this;\r\n        const commit = function (l) {\r\n            if (feature.wrap.feature) {\r\n                var source = l.getSource();\r\n                source.removeFeature(feature.wrap.feature);\r\n            }\r\n        };\r\n        if (self.layer) {\r\n            commit(self.layer);\r\n        }\r\n        else {\r\n            self.getLayer().then(commit);\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.clearFeatures = function () {\r\n        const self = this;\r\n        const commit = function (l) {\r\n            var source = l.getSource();\r\n            if (source.clearFeatures) {\r\n                source.clearFeatures();\r\n            }\r\n            else {\r\n                source.clear();\r\n            }\r\n        };\r\n        if (self.layer) {\r\n            commit(self.layer);\r\n        }\r\n        else {\r\n            self.getLayer().then(commit);\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.setFeatureVisibility = function (feature, visible) {\r\n        var self = this;\r\n\r\n        var fillOptions = {\r\n            color: 'rgba(0, 0, 0, 0)'\r\n        };\r\n        var strokeOptions = {\r\n            color: 'rgba(0, 0, 0, 0)'\r\n        };\r\n        var displayNoneStyle = new ol.style.Style({\r\n            image: new ol.style.Circle({\r\n                radius: 0,\r\n                fill: new ol.style.Fill(fillOptions),\r\n                stroke: new ol.style.Stroke(strokeOptions)\r\n            }),\r\n            fill: new ol.style.Fill(fillOptions),\r\n            stroke: new ol.style.Stroke(strokeOptions)\r\n        });\r\n        var idx = $.inArray(feature, self.parent.features);\r\n        if (idx >= 0) {\r\n            var olFeat = feature.wrap.feature;\r\n            self.getLayer().then(function (olLayer) {\r\n                if (visible && olFeat._originalStyle) {\r\n                    olFeat.setStyle(olFeat._originalStyle);\r\n                }\r\n                else {\r\n                    olFeat._originalStyle = olFeat.getStyle() || olLayer.getStyle();\r\n                    olFeat.setStyle(displayNoneStyle);\r\n                }\r\n                self.parent.map.trigger(TC.Consts.event.VECTORUPDATE, {\r\n                    layer: self.parent\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getRGBA = function (color, opacity) {\r\n        return getRGBA(color, opacity);\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.findFeature = function (values) {\r\n        // TODO: añadir ol.animation.zoom\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getGetFeatureUrl = function () {\r\n        return this._requestUrl;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getDescribeFeatureTypeUrl = function () {\r\n        var self = this;\r\n        var layer = self.parent;\r\n        var version = layer.options.version || '1.1.0';\r\n        var url = layer.url;\r\n        var featureType = $.isArray(layer.options.featureType) ? layer.options.featureType : [layer.options.featureType];\r\n        url = url + '?service=WFS&' + 'version=' + version + '&request=DescribeFeatureType&typename=' + featureType.join(',') + '&outputFormat=XMLSCHEMA';\r\n        return url;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.sendTransaction = function (inserts, updates, deletes) {\r\n        const self = this;\r\n        const getNativeFeature = function (feat) {\r\n            return feat.wrap.feature;\r\n        };\r\n        return new Promise(function (resolve, reject) {\r\n            const olInserts = inserts.map(getNativeFeature);\r\n            const olUpdates = updates.map(getNativeFeature);\r\n            const olDeletes = deletes.map(getNativeFeature);\r\n            if (inserts.length || updates.length || deletes.length) {\r\n                self.getLayer().then(function (olLayer) {\r\n                    var source = olLayer.getSource();\r\n                    var format = new ol.format.WFS();\r\n                    var options = self.parent.options;\r\n                    var transaction = format.writeTransaction(olInserts, olUpdates, olDeletes, {\r\n                        featurePrefix: options.featurePrefix,\r\n                        featureNS: options.featureNS,\r\n                        featureType: options.featureType[0]\r\n                    });\r\n                    var ajaxOptions = {\r\n                        url: self.parent.url,\r\n                        method: 'POST',\r\n                        responseType: TC.Consts.mimeType.XML,\r\n                        data: transaction.outerHTML\r\n                    };\r\n                    TC.ajax(ajaxOptions)\r\n                        .then(function (data) {\r\n                            var er = data.getElementsByTagName('ExceptionReport')[0];\r\n                            var errorObj = {\r\n                                reason: ''\r\n                            };\r\n                            if (er) {\r\n                                var e = er.getElementsByTagName('Exception')[0];\r\n                                if (e) {\r\n                                    errorObj.code = e.getAttribute('exceptionCode');\r\n                                    var texts = e.getElementsByTagName('ExceptionText');\r\n                                    for (var i = 0, len = texts.length; i < len; i++) {\r\n                                        errorObj.reason += '\\n' + texts[i].innerHTML;\r\n                                    }\r\n                                }\r\n                                reject(errorObj);\r\n                            }\r\n                            else {\r\n                                var response = format.readTransactionResponse(data);\r\n                                resolve(response);\r\n                            }\r\n                        })\r\n                        .catch(function () {\r\n                            reject({\r\n                                code: '', reason: 'unknown'\r\n                            });\r\n                        });\r\n                });\r\n            }\r\n            else {\r\n                resolve(self.parent);\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.setDraggable = function (draggable, onend, onstart) {\r\n        var self = this;\r\n\r\n        //tiene que estar a nivel de control para poder retirarla después\r\n        //var interaction;\r\n        Promise.all([self.parent.map.wrap.getMap(), self.getLayer()]).then(function (olObjects) {\r\n            const olMap = olObjects[0];\r\n            const olLayer = olObjects[1];\r\n            if (draggable) {\r\n                var interactionOptions = {\r\n                    layers: [olLayer],\r\n                    features: new ol.Collection(olLayer.getSource().getFeatures())\r\n                };\r\n                self.interaction = new ol.interaction.Translate(interactionOptions);\r\n                if ($.isFunction(onend)) {\r\n                    self.interaction.on(ol.interaction.TranslateEventType.TRANSLATEEND, function (e) {\r\n                        if (e.features.getLength()) {\r\n                            onend(e.features.item(0)._wrap.parent);\r\n                        }\r\n                    });\r\n                }\r\n                if ($.isFunction(onstart)) {\r\n                    self.interaction.on(ol.interaction.TranslateEventType.TRANSLATESTART, function (e) {\r\n                        if (e.features.getLength()) {\r\n                            onstart(e.features.item(0)._wrap.parent);\r\n                        }\r\n                    });\r\n                }\r\n                olMap.addInteraction(self.interaction);\r\n\r\n                // GLS: En IE no muestra la manita en el over sobre marcadores trasladables.\r\n                if (TC.Util.detectIE()) {\r\n                    self._handlerDraggablePointerMove = function (e) {\r\n                        if (e.dragging) {\r\n                            return;\r\n                        }\r\n\r\n                        var pixel = olMap.getEventPixel(e);\r\n                        var hit = olMap.hasFeatureAtPixel(pixel);\r\n                        if (hit) {\r\n                            olMap.forEachFeatureAtPixel(pixel, function (feature, layer) {\r\n                                if (layer._wrap && layer._wrap.parent && layer._wrap.parent.id === self.parent.id && feature) {\r\n                                    olMap.getTarget().style.cursor = 'move';\r\n                                } else {\r\n                                    olMap.getTarget().style.cursor = '';\r\n                                }\r\n                            },\r\n                                {\r\n                                    hitTolerance: hitTolerance\r\n                                });\r\n                        } else {\r\n                            olMap.getTarget().style.cursor = '';\r\n                        }\r\n                    };\r\n\r\n                    olMap.on('pointermove', self._handlerDraggablePointerMove);\r\n                }\r\n            }\r\n            else if (self.interaction) {\r\n                olMap.removeInteraction(self.interaction);\r\n\r\n                // GLS: En IE no muestra la manita en el over sobre marcadores trasladables.\r\n                if (TC.Util.detectIE() && self._handlerDraggablePointerMove && $.isFunction(self._handlerDraggablePointerMove)) {\r\n                    olMap.un('pointermove', self._handlerDraggablePointerMove);\r\n                    delete self._handlerDraggablePointerMove;\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getFeaturesInExtent = function (extent, tolerance) {\r\n        var self = this;\r\n        var features = this.layer.getSource().getFeatures();\r\n        var featuresInExtent = [];\r\n\r\n        if (tolerance) {\r\n            var leftCorner = self.parent.map.getPixelFromCoordinate([extent[0], extent[1]]);\r\n            var rightCorner = self.parent.map.getPixelFromCoordinate([extent[2], extent[3]]);\r\n            leftCorner[0] -= tolerance[0] / 2;\r\n            leftCorner[1] += tolerance[1];\r\n            rightCorner[0] += tolerance[0] / 2;\r\n            extent = self.parent.map.getCoordinateFromPixel(leftCorner).concat(self.parent.map.getCoordinateFromPixel(rightCorner));\r\n        }\r\n\r\n        for (var i = 0; i < features.length; i++) {\r\n            var feat = features[i];\r\n\r\n            var geometry = feat.getGeometry();\r\n            var coordinate = geometry.getCoordinates();\r\n\r\n            if (ol.extent.containsCoordinate(extent, coordinate)) {\r\n                featuresInExtent.push(feat._wrap.parent);\r\n            }\r\n        }\r\n\r\n        return featuresInExtent;\r\n    };\r\n\r\n    TC.wrap.layer.Vector.prototype.getAttribution = function () {\r\n        return null;\r\n    };\r\n\r\n    TC.wrap.control.Click.prototype.register = function (map) {\r\n        var self = this;\r\n\r\n        self._trigger = function (e) {\r\n            if (map.view === TC.Consts.view.PRINTING) {\r\n                return;\r\n            }\r\n            var featureCount = 0;\r\n            map.wrap.map.forEachFeatureAtPixel(e.pixel,\r\n                function (feature, layer) {\r\n                    if (feature._wrap && feature._wrap.parent.showsPopup) {\r\n                        featureCount++;\r\n                    }\r\n                },\r\n                {\r\n                    hitTolerance: hitTolerance\r\n                });\r\n            if (!featureCount) {\r\n                // GLS: lanzo el evento click, para que los controles que no pueden heredar de click y definir un callback pueda suscribirse al evento\r\n                self.parent.map.trigger(TC.Consts.event.CLICK, {\r\n                    coordinate: e.coordinate, pixel: e.pixel\r\n                });\r\n                self.parent.callback(e.coordinate, e.pixel);\r\n            }\r\n            // Seguimos adelante si no se han pinchado featuers\r\n            return featureCount === 0;\r\n        };\r\n    };\r\n\r\n    TC.wrap.control.Click.prototype.activate = function () {\r\n        var self = this;\r\n\r\n        self.parent.map.wrap.getMap().then(function (olMap) {\r\n            olMap.on(ol.MapBrowserEventType.SINGLECLICK, self._trigger);\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Click.prototype.deactivate = function () {\r\n        var self = this;\r\n\r\n        self.parent.map.wrap.getMap().then(function (olMap) {\r\n            olMap.un(ol.MapBrowserEventType.SINGLECLICK, self._trigger);\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.ScaleBar.prototype.render = function () {\r\n        var self = this;\r\n        if (!self.ctl) {\r\n            self.ctl = new ol.control.ScaleLine({\r\n                target: self.parent.div\r\n            });\r\n        }\r\n        else {\r\n            self.ctl.updateElement_();\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.ScaleBar.prototype.getText = function () {\r\n        var self = this;\r\n        if (self.ctl) {\r\n            return self.ctl.renderedHTML_;\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.NavBar.prototype.register = function (map) {\r\n        var self = this;\r\n        map.wrap.getMap().then(function (olMap) {\r\n            const div = self.parent.div;\r\n            self.zCtl = new ol.control.Zoom({\r\n                target: div\r\n            });\r\n            // Ponemos para render una función modificada, para evitar que en los pinch zoom haya errores de este tipo:\r\n            // AssertionError: Assertion failed: calculated value (1.002067782531452) ouside allowed range (0-1)\r\n\r\n            self.zsCtl = new ol.control.ZoomSlider({\r\n                render: function (e) {\r\n                    if (!e.frameState || !e.frameState.viewState || olMap.getView().getMinResolution() <= e.frameState.viewState.resolution) {\r\n                        // GLS: para evitar que el slider se configure en horizontal\r\n                        var render = function () {\r\n                            if (this.element.offsetWidth > this.element.offsetHeight) {\r\n                                if (!self.requestSliderSize) {\r\n                                    self.requestSliderSize = window.requestAnimationFrame(render.bind(this));\r\n                                }\r\n\r\n                                window.requestAnimationFrame(render.bind(this));\r\n                            } else if (this.element.offsetWidth < this.element.offsetHeight) {\r\n                                if (self.requestSliderSize) {\r\n                                    window.cancelAnimationFrame(self.requestSliderSize);\r\n                                    delete self.requestSliderSize;\r\n                                }\r\n                                ol.control.ZoomSlider.render.call(this, e);\r\n                            }\r\n                        };\r\n                        render.call(this);\r\n                    }\r\n                }\r\n            });\r\n            self.zsCtl.setTarget(div);\r\n\r\n            olMap.addControl(self.zsCtl);\r\n            olMap.addControl(self.zCtl);\r\n\r\n            div.querySelectorAll('button').forEach(function (button) {\r\n                button.classList.add('tc-ctl-btn');\r\n                button.classList.add(self.parent.CLASS + '-btn');\r\n                button.style.display = 'block';\r\n                button.innerHTML = '';\r\n                if (button.matches('.ol-zoom-in')) {\r\n                    button.classList.add(self.parent.CLASS + '-btn-zoomin');\r\n                    button.setAttribute('title', self.parent.getLocaleString('zoomIn'));\r\n                }\r\n                if (button.matches('.ol-zoom-out')) {\r\n                    button.classList.add(self.parent.CLASS + '-btn-zoomout');\r\n                    button.setAttribute('title', self.parent.getLocaleString('zoomOut'));\r\n                }\r\n            });\r\n\r\n            const zoomSlider = div.querySelector('.ol-zoomslider');\r\n            zoomSlider.classList.add(self.parent.CLASS + '-bar');\r\n            zoomSlider.querySelector('.ol-zoomslider-thumb').classList.add(self.parent.CLASS + '-slider');\r\n\r\n            map.on(TC.Consts.event.BASELAYERCHANGE, $.proxy(self.refresh, self));\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.NavBar.prototype.refresh = function () {\r\n        /*\r\n        var map = this.parent.map;\r\n        var olMap = map.wrap.map;\r\n\r\n        olMap.removeControl(self.zsCtl);\r\n        var res = map.getResolutions();\r\n        self.zsCtl = new ol.control.ZoomSlider(\r\n            {\r\n                target: this.parent.div,\r\n                \"maxResolution\": res[0],\r\n                \"minResolution\": res[res.length - 1]\r\n            });\r\n\r\n        olMap.addControl(self.zsCtl);\r\n        $(map.div).find('.ol-zoomslider').addClass(self.parent.CLASS + '-bar').find('.ol-zoomslider-thumb').addClass(self.parent.CLASS + '-slider');\r\n        */\r\n        var self = this;\r\n        var map = self.parent.map.wrap.map;\r\n        // Puede ser que se llame a refresh antes de que esté inicializado ol.control.ZoomSlider. En ese caso llamamos a render que lo inicializa.\r\n        // Como render necesita un ol.MapEvent, esperamos al evento POSTRENDER.\r\n\r\n        self.parent.renderPromise().then(function () {\r\n            if (self.zsCtl.sliderInitialized_) {\r\n                var res = map.getView().getResolution();\r\n                self.zsCtl.setThumbPosition_(res);\r\n            }\r\n            else {\r\n                map.once(ol.MapEventType.POSTRENDER, function (e) {\r\n                    self.zsCtl.render(e);\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.NavBarHome.prototype.register = function (map) {\r\n        var self = this;\r\n        map.wrap.getMap().then(function (olMap) {\r\n            const div = self.parent.div;\r\n\r\n            self.z2eCtl = new ol.control.ZoomToExtent({\r\n                target: div, extent: map.initialExtent, tipLabel: ''\r\n            });\r\n\r\n            olMap.addControl(self.z2eCtl);\r\n\r\n            div.querySelectorAll('button').forEach(function(button) {\r\n                button.style.display = 'block';\r\n                button.innerHTML = '';\r\n            });\r\n            const homeBtn = div.querySelector('.ol-zoom-extent button');\r\n            homeBtn.classList.add('tc-ctl-btn');\r\n            homeBtn.classList.add(self.parent.CLASS + '-btn');\r\n            homeBtn.setAttribute('title', self.parent.getLocaleString('zoomToInitialExtent'));\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.NavBarHome.prototype.setInitialExtent = function (extent) {\r\n        this.z2eCtl.extent = extent;\r\n    };\r\n\r\n    TC.wrap.control.Coordinates.prototype.register = function (map) {\r\n        const self = this;\r\n        self.map = map;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            self._coordsTrigger = function (e) {\r\n                self.parent.coordsToClick(e);\r\n            };\r\n\r\n            map.wrap.getMap().then(function (olMap) {\r\n                self.olMap = olMap;\r\n\r\n                if (!self.parent.map.on3DView) {\r\n                    var projection = olMap.getView().getProjection();\r\n                    self.parent.crs = projection.getCode();\r\n                    self.parent.units = projection.getUnits();\r\n                } else {\r\n                    self.parent.crs = self.parent.map.view3D.crs;\r\n                    self.parent.units = TC.Consts.units.DEGREES;\r\n                }\r\n\r\n                self.parent.isGeo = self.parent.units === ol.proj.Units.DEGREES;\r\n\r\n                //$(olMap.getViewport()).add(self.parent.div);\r\n                resolve();\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Coordinates.prototype.onMouseMove = function (e) {\r\n        var self = this;\r\n        if (self.map.wrap.map) {\r\n            var coords = self.map.wrap.map.getEventCoordinate(e);\r\n            if (coords) {\r\n                if (self.parent.isGeo) {\r\n                    self.parent.latLon = coords.reverse();\r\n                } else {\r\n                    self.parent.xy = coords;\r\n                }\r\n\r\n                self.parent.update.apply(self.parent, arguments);\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.register = function (map) {\r\n        var self = this;\r\n        self.map = map;\r\n\r\n        self._snapTrigger = function (e) {\r\n            if (e.dragging)\r\n                return;\r\n\r\n            self.initSnap(self.olMap.getEventCoordinate(e), e.pixel);\r\n        };\r\n\r\n        self._postcomposeTrigger = function (e) {\r\n            self.duringTrackSnap(e);\r\n        };\r\n\r\n        map.wrap.getMap().then(function (olMap) {\r\n            self.olMap = olMap;\r\n        });\r\n    };\r\n\r\n    var getTrackingLine = function () {\r\n        var self = this;\r\n\r\n        return self.parent.layerTracking.features.filter(function (f) {\r\n            return f instanceof TC.feature.Polyline;\r\n        })[0];\r\n    }\r\n\r\n    TC.wrap.control.Geolocation.prototype.hasCoordinates = function () {\r\n        var self = this;\r\n\r\n        return self.parent.layerTracking.features.length > 0 && self.parent.layerTracking.features[0].geometry.length >= 1;\r\n    };\r\n\r\n    var getTime = function (timeFrom, timeTo) {\r\n        var diff = timeTo - timeFrom;\r\n        var d = {\r\n            s: Math.floor((diff / 1000) % 60),\r\n            m: Math.floor(((diff / (1000 * 60)) % 60)),\r\n            h: Math.floor(((diff / (1000 * 60 * 60)) % 24))\r\n        };\r\n\r\n        return $.extend({}, d, { toString: (\"00000\" + d.h).slice(-2) + ':' + (\"00000\" + d.m).slice(-2) + ':' + (\"00000\" + d.s).slice(-2) });\r\n    };\r\n    TC.wrap.control.Geolocation.prototype.showElevationMarker = function (d) {\r\n        var self = this;\r\n\r\n        TC.wrap.control.ResultsPanel.prototype.showElevationMarker.call(self, {\r\n            data: d,\r\n            layer: self.parent.layerTrack,\r\n            coords: self.parent.chart.coordinates\r\n        })\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.hideElevationMarker = function () {\r\n        TC.wrap.control.ResultsPanel.prototype.hideElevationMarker.call(this);\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.addWaypoint = function (position, properties) {\r\n        var self = this;\r\n\r\n        var waypoint = new ol.Feature({\r\n            geometry: new ol.geom.Point([position[0], position[1], properties.ele, properties.time], ('XYZM'))\r\n        });\r\n        waypoint.setProperties(properties);\r\n\r\n        self.parent.layerTracking.wrap.layer.getSource().addFeature(waypoint);\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.addPosition = function (position, heading, m, speed, accuracy, altitudeAccuracy, altitude) {\r\n        var self = this;\r\n\r\n        var x = Math.round(position[0]);\r\n        var y = Math.round(position[1]);\r\n\r\n        var line = getTrackingLine.call(this);\r\n        if (self.parent.layerTracking.features && line) {\r\n            var last = line.geometry.length > 0 && line.geometry[line.geometry.length - 1];\r\n            if (last && last.length == 0) {\r\n                self.parent.layerTracking.features[0].geometry.push([x, y, altitude, m]);\r\n                line.wrap.feature.getGeometry().appendCoordinate([x, y, altitude, m]);\r\n            }\r\n            else {\r\n                var lx = Math.round(last[0]);\r\n                var ly = Math.round(last[1]);\r\n\r\n                if (x != lx || y != ly) {\r\n                    self.parent.layerTracking.features[0].geometry.push([x, y, altitude, m]);\r\n                    line.wrap.feature.getGeometry().appendCoordinate([x, y, altitude, m]);\r\n                }\r\n            }\r\n\r\n            TC.Util.storage.setSessionLocalValue(self.parent.Const.LocalStorageKey.TRACKINGTEMP, self.formattedToStorage(self.parent.layerTracking).features);\r\n        }\r\n\r\n        self.parent.trigger(self.parent.Const.Event.STATEUPDATED, {\r\n            moving: (heading != undefined && speed != undefined && speed > 0 && heading > 0)\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.positionChangehandler = function (geoposition) {\r\n        const self = this;\r\n        var accuracy, heading, speed, altitude, altitudeAccuracy;\r\n\r\n        if (!getTrackingLine.call(this)) {\r\n            self.setTracking(false);\r\n        }\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            if (geoposition && geoposition.coords) {\r\n                self.parent.layerGPS.clearFeatures();\r\n\r\n                accuracy = (geoposition.coords.accuracy / self.parent.map.getMetersPerUnit()) || 0;\r\n                heading = geoposition.coords.heading || geoposition[2] || 0;\r\n                speed = geoposition.coords.speed ? geoposition.coords.speed * 3.6 : 0;\r\n                altitude = geoposition.coords.altitude || 0;\r\n                altitudeAccuracy = geoposition.coords.altitudeAccuracy || 0;\r\n\r\n                if (self.parent.layerTracking) {\r\n                    var position_ = [geoposition.coords && geoposition.coords.longitude || geoposition[0], geoposition.coords && geoposition.coords.latitude || geoposition[1]];\r\n                    var projectedPosition = TC.Util.reproject(position_, 'EPSG:4326', self.parent.map.crs);\r\n\r\n                    self.addPosition(projectedPosition, heading, new Date().getTime(), speed, accuracy, altitudeAccuracy, altitude);\r\n\r\n                    var coords = getTrackingLine.call(self).geometry;\r\n                    var len = coords.length;\r\n                    if (len >= 2) {\r\n                        self.parent.deltaMean = (coords[len - 1][3] - coords[0][3]) / (len - 1);\r\n                    }\r\n\r\n                    self.parent.trigger(self.parent.Const.Event.POSITIONCHANGE, {\r\n                        pd: {\r\n                            \"position\": projectedPosition,\r\n                            \"altitude\": altitude,\r\n                            \"accuracy\": accuracy,\r\n                            \"heading\": TC.Util.radToDeg(heading),\r\n                            \"speed\": speed\r\n                        }\r\n                    });\r\n\r\n                    Promise.all([self.parent.layerGPS.addPoint(projectedPosition, {\r\n                        radius: 4,\r\n                        fillColor: '#00CED1',\r\n                        fillOpacity: 1,\r\n                        strokeColor: '#ffffff',\r\n                        strokeWidth: 2,\r\n                        showsPopup: false\r\n                    }), self.parent.layerGPS.addCircle([projectedPosition, accuracy], {\r\n                        strokeColor: '#00CED1',\r\n                        strokeWidth: 0.4,\r\n                        fillColor: '#ffffff',\r\n                        fillOpacity: 0.2,\r\n                        showsPopup: false\r\n                    })]).then(function (features) {\r\n                        const marker = features[0];\r\n                        const accuracyCircle = features[1];\r\n                        self.parent.geopositionTracking = true;\r\n\r\n                        if (self.parent.firstPosition == false) {\r\n                            self.parent.firstPosition = true;\r\n\r\n                            if (!self.parent.trackCenterButton) {\r\n                                self.parent.trackCenterButton = self.parent.div.querySelector('.' + self.parent.CLASS + '-track-center');\r\n                                self.parent.trackCenterButton.querySelector('button').addEventListener('click', function () {\r\n                                    self.parent.layerGPS.map.zoomToFeatures(self.parent.layerGPS.features);\r\n\r\n                                    if (!self.parent.track.infoPanel.isVisible()) {\r\n                                        self.parent.track.infoPanel.doVisible();\r\n                                    }\r\n\r\n                                    if (self.parent.track.infoPanel.isMinimized()) {\r\n                                        self.parent.track.infoPanel.maximize();\r\n                                    }\r\n                                });\r\n\r\n                                var controlContainer = self.parent.map.getControlsByClass('TC.control.ControlContainer')[0];\r\n                                if (controlContainer) {\r\n                                    self.parent.trackCenterButton = controlContainer.addElement({ side: controlContainer.SIDE.LEFT, htmlElement: self.parent.trackCenterButton });\r\n                                } else {\r\n                                    self.parent.map.div.appendChild(self.parent.trackCenterButton);\r\n                                }\r\n\r\n                            }\r\n                            self.parent.trackCenterButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                            self.parent.layerGPS.map.zoomToFeatures(self.parent.layerGPS.features);\r\n                        }\r\n\r\n                        resolve({\r\n                            marker: marker, accuracy: accuracyCircle\r\n                        });\r\n                    });\r\n\r\n                } else { resolve(null); }\r\n            } else {\r\n                resolve(null);\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.setTracking = function (tracking) {\r\n        var self = this;\r\n\r\n        if (tracking) {\r\n            self.parent.firstPosition = false;\r\n            var sessionwaypoint = [];\r\n\r\n            var nativeTrackingFeature;\r\n\r\n            if (self.parent.sessionTracking) {\r\n\r\n                var JSONParser = new TC.wrap.parser.JSON();\r\n                var features = JSONParser.parser.readFeatures(self.parent.sessionTracking);\r\n                if (features && self.parent.storageCRS !== self.parent.map.crs) {\r\n                    features = features.map(function (feature) {\r\n                        var clone = feature.clone();\r\n                        clone.getGeometry().transform(self.parent.storageCRS, self.parent.map.crs);\r\n                        return clone;\r\n                    });\r\n                }\r\n\r\n                var coordinates = features.filter(function (feature) {\r\n                    var type = feature.getGeometry().getType().toLowerCase();\r\n                    if (type === 'point') { sessionwaypoint.push(feature); }\r\n                    return type === 'linestring' || type === 'multilinestring';\r\n                })[0].getGeometry().getCoordinates();\r\n\r\n                nativeTrackingFeature = new ol.Feature({\r\n                    geometry: new ol.geom.LineString(coordinates, ('XYZM')),\r\n                    tracking: true\r\n                });\r\n\r\n            } else {\r\n                nativeTrackingFeature = new ol.Feature({\r\n                    geometry: new ol.geom.LineString([], ('XYZM')),\r\n                    tracking: true\r\n                });\r\n            }\r\n\r\n            if (nativeTrackingFeature) {\r\n\r\n                TC.wrap.Feature.createFeature(nativeTrackingFeature).then(function (tcFeature) {\r\n                    self.parent.layerTracking.addFeature(tcFeature);\r\n\r\n                    if (tcFeature.geometry.length > 1) {\r\n                        self.parent.map.zoomToFeatures(self.parent.layerTracking.features);\r\n                    }\r\n\r\n                    if (sessionwaypoint.length > 0) {\r\n                        Promise.all(sessionwaypoint.map(function (waypoint) {\r\n                            return TC.wrap.Feature.createFeature(waypoint);\r\n                        })).then(function (features) {\r\n                            if (features) {\r\n                                features.forEach(function (feature) {\r\n                                    self.parent.layerTracking.addFeature(feature);\r\n                                });\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    self.parent.currentPositionWaiting = self.parent.getLoadingIndicator().addWait();\r\n\r\n                    if (!self.currentPositionTrk) {\r\n                        self.currentPositionTrk = [];\r\n                    }\r\n\r\n                    var getCurrentPositionInterval;\r\n                    var getCurrentPositionRequest = 0;\r\n                    var errorTimeout = 0;\r\n                    var toast = false;\r\n                    var options = {\r\n                        enableHighAccuracy: true, timeout: 600000\r\n                    };\r\n\r\n                    function getCurrentPosition(errorCallback) {\r\n                        var id = getCurrentPositionRequest++;\r\n                        navigator.geolocation.getCurrentPosition(\r\n                            function (data) {\r\n                                clearInterval(getCurrentPositionInterval);\r\n                                self.parent.getLoadingIndicator().removeWait(self.parent.currentPositionWaiting);\r\n                                self.positionChangehandler(data).then(function (obj) {\r\n                                    if (self.parent.geopositionTracking == true && obj && obj.marker && obj.accuracy) {\r\n                                        self.currentPositionTrk.push(navigator.geolocation.watchPosition(self.positionChangehandler.bind(self), self.parent.onGeolocateError.bind(self.parent), options));\r\n                                    }\r\n                                });\r\n                            },\r\n                            errorCallback ? errorCallback :\r\n                                function (error) {\r\n                                    switch (error.code) {\r\n                                        case error.TIMEOUT:\r\n                                            if (errorTimeout > 10) {\r\n                                                clearInterval(getCurrentPositionInterval);\r\n                                                self.parent.onGeolocateError.call(self.parent, error);\r\n                                            } else {\r\n                                                errorTimeout++;\r\n                                                getCurrentPosition(function () {\r\n                                                    clearInterval(getCurrentPositionInterval);\r\n                                                    if (!toast) {\r\n                                                        toast = true;\r\n                                                        self.parent.onGeolocateError.call(self.parent, error);\r\n                                                    }\r\n                                                });\r\n                                            }\r\n                                            break;\r\n                                        default:\r\n                                            clearInterval(getCurrentPositionInterval);\r\n                                            self.parent.onGeolocateError.call(self.parent, error);\r\n                                    }\r\n                                }, {\r\n                                timeout: 5000 + id,\r\n                                maximumAge: 10,\r\n                                enableHighAccuracy: true\r\n                            }\r\n                        );\r\n                    }\r\n                    getCurrentPositionInterval = setInterval(getCurrentPosition, 1000);\r\n\r\n                    setTimeout(function () {\r\n                        if (self.parent.layerTracking && self.parent.layerTracking.features && self.parent.layerTracking.features.length > 0 && self.parent.layerTracking.features[0].geometry.length == 0) {\r\n                            clearInterval(getCurrentPositionInterval);\r\n\r\n                            self.parent.getLoadingIndicator().removeWait(self.parent.currentPositionWaiting);\r\n                            self.map.toast(self.parent.getLocaleString(\"geo.error.permission_denied\"), {\r\n                                type: TC.Consts.msgType.WARNING\r\n                            });\r\n                            self.parent.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n                            self.parent.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n                        }\r\n                    }, options.timeout + 1000); // Wait extra second\r\n\r\n                });\r\n            }\r\n        } else {\r\n            self.parent.firstPosition = false;\r\n\r\n            if (self.currentPositionTrk) {\r\n                self.currentPositionTrk = self.currentPositionTrk instanceof Array ? self.currentPositionTrk : [self.currentPositionTrk];\r\n\r\n                self.currentPositionTrk.forEach(function (watch) {\r\n                    navigator.geolocation.clearWatch(watch);\r\n                });\r\n\r\n                self.currentPositionTrk = [];\r\n            }\r\n\r\n            if (self.parent.trackCenterButton)\r\n                self.parent.trackCenterButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.activateSnapping = function () {\r\n        var self = this;\r\n\r\n        if (!TC.Util.detectMobile()) {\r\n            self.olMap.on([ol.MapBrowserEventType.POINTERMOVE, ol.MapBrowserEventType.SINGLECLICK], self._snapTrigger);\r\n            self.olMap.on(ol.render.EventType.POSTCOMPOSE, self._postcomposeTrigger);\r\n        }\r\n    };\r\n    TC.wrap.control.Geolocation.prototype.deactivateSnapping = function () {\r\n        var self = this;\r\n\r\n        self.parent.map.wrap.getMap().then(function (olMap) {\r\n            if (!TC.Util.detectMobile()) {\r\n                olMap.un([ol.MapBrowserEventType.POINTERMOVE, ol.MapBrowserEventType.SINGLECLICK], self._snapTrigger);\r\n                olMap.un(ol.render.EventType.POSTCOMPOSE, self._postcomposeTrigger);\r\n            }\r\n\r\n            if (self.snapInfo) {\r\n                olMap.removeOverlay(self.snapInfo);\r\n            }\r\n\r\n            if (self.snapInfoElement) {\r\n                self.snapInfoElement.style.display = 'none';\r\n            }\r\n\r\n            if (self.snapLine) {\r\n                delete self.snapLine;\r\n                olMap.render();\r\n            }\r\n        });\r\n    };\r\n    TC.wrap.control.Geolocation.prototype.clear = function (layer) {\r\n        var self = this;\r\n\r\n        if (layer) {\r\n            layer.clearFeatures();\r\n        }\r\n\r\n        attachedDTD = false;\r\n\r\n        self.deactivateSnapping.call(self);\r\n    };\r\n    var vectorCtx;\r\n    TC.wrap.control.Geolocation.prototype.duringTrackSnap = function (e) {\r\n        var self = this;\r\n\r\n        var vectorContext = vectorCtx = e.vectorContext;\r\n\r\n        if (vectorContext && self.snapLine) {\r\n            if (typeof (vectorContext.setFillStrokeStyle) === 'function')\r\n                vectorContext.setFillStrokeStyle(null, new ol.style.Stroke({\r\n                    color: 'rgba(197, 39, 55, 1)',\r\n                    width: 1\r\n                }));\r\n\r\n            if (typeof (vectorContext.drawGeometry) === 'function')\r\n                vectorContext.drawGeometry(self.snapLine.wrap.feature.getGeometry());\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.endSnap = function () {\r\n        var self = this;\r\n\r\n        self.parent.map.wrap.getMap().then(function (olMap) {\r\n            /* cartel */\r\n            if (self.snapInfo) {\r\n                olMap.removeOverlay(self.snapInfo);\r\n            }\r\n            if (self.snapInfoElement) {\r\n                self.snapInfoElement.style.display = 'none';\r\n            }\r\n            /* línea */\r\n            if (self.snapLine) {\r\n                delete self.snapLine;\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.initSnap = function (coordinate, eventPixel) {\r\n        var self = this;\r\n\r\n        if (self.parent.layerTrack) {\r\n            var vectorSource = self.parent.layerTrack.wrap.layer.getSource();\r\n            var closestFeature = vectorSource.getClosestFeatureToCoordinate(coordinate);\r\n\r\n            if (closestFeature !== null) {\r\n                var geometry = closestFeature.getGeometry();\r\n                var closestPoint = geometry.getClosestPoint(coordinate);\r\n\r\n                const pixel = self.parent.map.getPixelFromCoordinate(closestPoint);\r\n                const distance = Math.sqrt(\r\n                    Math.pow(eventPixel[0] - pixel[0], 2) +\r\n                    Math.pow(eventPixel[1] - pixel[1], 2));\r\n\r\n                if (distance > self.parent.snappingTolerance) {\r\n                    self.endSnap();\r\n                } else {\r\n                    var coordinates = [coordinate, [closestPoint[0], closestPoint[1]]];\r\n\r\n                    if (!self.snapLine) self.snapLine = new TC.feature.Polyline(coordinates);\r\n                    else self.snapLine.wrap.feature.getGeometry().setCoordinates(coordinates);\r\n\r\n                    // información del punto\r\n                    if (!self.snapInfoElement)\r\n                        self.snapInfoElement = document.getElementsByClassName('tc-ctl-geolocation-track-snap-info')[0];\r\n\r\n                    self.snapInfoElement.style.display = 'block';\r\n\r\n                    if (!self.snapInfo) {\r\n                        self.snapInfo = new ol.Overlay({\r\n                            element: self.snapInfoElement,\r\n                            offset: [5, 18]\r\n                        });\r\n\r\n                        self.olMap.addOverlay(self.snapInfo);\r\n                    }\r\n\r\n                    if (self.snapInfo.getMap() == undefined)\r\n                        self.snapInfo.setMap(self.olMap);\r\n\r\n                    self.snapInfo.setPosition(coordinate);\r\n\r\n                    var data = {};\r\n                    if (closestFeature.getGeometry().getType() != \"LineString\") {\r\n                        if (closestFeature.getKeys().indexOf('name') > -1)\r\n                            data.n = closestFeature.get('name');\r\n                    }\r\n\r\n                    var locale = self.parent.map.options.locale && self.parent.map.options.locale.replace('_', '-') || undefined;\r\n                    data.x = self.map.wrap.isGeo() ? closestPoint[0].toLocaleString(locale, { minimumFractionDigits: 5 }) : Math.round(closestPoint[0]).toLocaleString(locale);\r\n                    data.y = self.map.wrap.isGeo() ? closestPoint[1].toLocaleString(locale, { minimumFractionDigits: 5 }) : Math.round(closestPoint[1]).toLocaleString(locale);\r\n\r\n                    if (self.map.wrap.isGeo()) {\r\n                        data.isGeo = true;\r\n                    }\r\n\r\n                    var getZ = function (position) {\r\n                        return closestPoint[position] ? (Math.round(closestPoint[position] * 100) / 100).toLocaleString(locale) : undefined;\r\n                    };\r\n                    var getM = function (position) {\r\n                        return closestPoint[position] > 0 ? new Date(closestPoint[position]).toLocaleString(locale) : undefined;\r\n                    };\r\n\r\n                    if (closestFeature.getGeometry().getLayout() === ol.geom.GeometryLayout.XYZM) {\r\n                        data.z = getZ(2);\r\n                        data.m = getM(3);\r\n                    } else if (closestFeature.getGeometry().getLayout() === ol.geom.GeometryLayout.XYZ) {\r\n                        data.z = getZ(2);\r\n                    } else if (closestFeature.getGeometry().getLayout() === ol.geom.GeometryLayout.XYM) {\r\n                        data.m = getM(2);\r\n                    }\r\n\r\n                    if (data) {\r\n                        self.parent.getRenderedHtml(self.parent.CLASS + '-track-snapping-node', data, function (html) {\r\n                            self.snapInfoElement.innerHTML = html;\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        self.olMap.render();\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.drawTrackingData = function (track) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            const featurePromises = [];\r\n\r\n            const JSONParser = new TC.wrap.parser.JSON();\r\n            const features = JSONParser.parser.readFeatures(track.data);\r\n\r\n            features.filter(function (feature) {\r\n                return feature.getGeometry().getType().toLowerCase() === 'linestring' || feature.getGeometry().getType().toLowerCase() === 'multilinestring';\r\n            }).forEach(function (feature) {\r\n                feature.getGeometry().setCoordinates(feature.getGeometry().getCoordinates(), track.layout);\r\n            });\r\n\r\n            self.activateSnapping.call(self);\r\n\r\n            for (var i = 0, len = features.length; i < len; i++) {\r\n                featurePromises.push(TC.wrap.Feature.createFeature(features[i]));\r\n            }\r\n\r\n            Promise.all(featurePromises).then(function (feats) {\r\n                feats.forEach(function (feat) {\r\n                    if (feat) {\r\n                        self.parent.layerTrack.addFeature(feat);\r\n                    }\r\n                });\r\n                self.parent.map.zoomToFeatures(self.parent.layerTrack.features);\r\n\r\n                resolve();\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.formattedFromStorage = function (storageData) {\r\n        const self = this;\r\n\r\n        if (self.parent.storageCRS !== self.parent.map.crs) {\r\n            var features = new ol.format.GeoJSON().readFeatures(storageData);\r\n            if (features) {\r\n                features = features.map(function (feature) {\r\n                    var clone = feature.clone();\r\n                    clone.getGeometry().transform(self.parent.storageCRS, self.parent.map.crs);\r\n                    return clone;\r\n                });\r\n\r\n                return new ol.format.GeoJSON().writeFeatures(features);\r\n            }\r\n        }\r\n\r\n        return storageData;\r\n    };\r\n    TC.wrap.control.Geolocation.prototype.formattedToStorage = function (layer, removeTrackingProperty, notReproject) {\r\n        var self = this;\r\n\r\n        var parser = new TC.wrap.parser.JSON();\r\n        parser = parser.parser;\r\n\r\n        var features = layer.wrap.layer.getSource().getFeatures();\r\n        var layout;\r\n\r\n        features = features.map(function (feature) {\r\n            if (feature.getGeometry() instanceof ol.geom.LineString) {\r\n                layout = feature.getGeometry().getLayout();\r\n            }\r\n\r\n            if (removeTrackingProperty && feature.getProperties().tracking) {\r\n                feature.unset(\"tracking\");\r\n            }\r\n\r\n            if (!notReproject && self.parent.map.crs !== self.parent.storageCRS) {\r\n                var clone = feature.clone();\r\n                clone.getGeometry().transform(self.parent.map.crs, self.parent.storageCRS);\r\n\r\n                return clone;\r\n            }\r\n\r\n            return feature;\r\n        }).sort(function (a, b) {\r\n\r\n            if (a.getGeometry() instanceof ol.geom.Point &&\r\n                !(b.getGeometry() instanceof ol.geom.Point)) {\r\n                return -1;\r\n            }\r\n\r\n            if (b.getGeometry() instanceof ol.geom.Point &&\r\n                !(a.getGeometry() instanceof ol.geom.Point)) {\r\n                return 2;\r\n            }\r\n\r\n            if (a.getProperties().name < b.getProperties().name) { return -1; }\r\n            if (a.getProperties().name > b.getProperties().name) { return 1; }\r\n\r\n            return 0;\r\n        });\r\n\r\n        return {\r\n            features: parser.writeFeatures(features), layout: layout\r\n        };\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.export = function (type, li) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var features = [];\r\n\r\n            self.parent.getTrackingData(li).then(function (data) {\r\n                if (data) {\r\n\r\n                    var olFeatures = new ol.format.GeoJSON().readFeatures(data.data);\r\n\r\n                    if (olFeatures.length === 0) {\r\n                        var geoJSON = self.parent.getTrackingData(li);\r\n                        olFeatures = new ol.format.GeoJSON().readFeatures(geoJSON);\r\n                    }\r\n\r\n                    features = olFeatures.map(function (feature) {\r\n                        var clone = feature.clone();\r\n                        clone.getGeometry().transform(self.parent.map.crs, 'EPSG:4326');\r\n\r\n                        if (!(clone.getGeometry() instanceof ol.geom.LineString)) {\r\n                            return clone;\r\n                        } else {\r\n                            return new ol.Feature({\r\n                                geometry: new ol.geom.MultiLineString([clone.getGeometry().getCoordinates()], ('XYZM'))\r\n                            });\r\n                        }\r\n                    });\r\n                }\r\n\r\n                switch (type) {\r\n                    case 'GPX':\r\n                        resolve(features ? new ol.format.GPX().writeFeatures(features) : null);\r\n                        break;\r\n                    case 'KML':\r\n                        resolve(features ? new ol.format.KML().writeFeatures(features) : null);\r\n                        break;\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    var segmentsUnion = function (lineStrings) {\r\n        var mergedIndex = [];\r\n        var coords = [];\r\n        if (lineStrings.length > 1) {\r\n\r\n            if (lineStrings[0].length == 4) {\r\n                lineStrings = lineStrings.sort(function (a, b) {\r\n                    if (a[0][3] == b[0][3])\r\n                        return 0;\r\n                    else if (a[0][3] < b[0][3])\r\n                        return -1;\r\n                    else return 1;\r\n                });\r\n            }\r\n\r\n            for (var ls = 0; ls < lineStrings.length; ls++) {\r\n                var lineString = lineStrings[ls];\r\n                var nextLineIndex = -1;\r\n                var distance = Infinity;\r\n\r\n                var last = lineString.getLastCoordinate();\r\n                for (var nls = ls + 1; nls < lineStrings.length; nls++) {\r\n                    var first = lineStrings[nls].getFirstCoordinate();\r\n                    var d = Math.hypot(last[0] - first[0], last[1] - first[1]);\r\n                    if (d < distance) {\r\n                        nextLineIndex = nls;\r\n                        distance = d;\r\n                    }\r\n                }\r\n\r\n                if (mergedIndex.length < lineStrings.length) {\r\n                    if (mergedIndex.indexOf(ls) == -1) {\r\n                        mergedIndex.push(ls);\r\n                        coords = coords.concat(lineString.getCoordinates());\r\n                    }\r\n                    if (mergedIndex.indexOf(nextLineIndex) == -1) {\r\n                        mergedIndex.push(nextLineIndex);\r\n                        coords = coords.concat(lineStrings[nextLineIndex].getCoordinates());\r\n                    }\r\n                }\r\n            }\r\n\r\n            //self.map.toast(self.parent.getLocaleString(\"geo.trk.simulateWarning\"), { type: TC.Consts.msgType.WARNING });\r\n\r\n            return coords;\r\n        }\r\n\r\n        return lineStrings[0].getCoordinates();\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.processImportedFeatures = function (options) {\r\n        var self = this;\r\n\r\n        var source = self.parent.layerTrack.wrap.layer.getSource();\r\n        var fileName = self.parent.importedFileName;\r\n        var names = [];\r\n        var toAdd = [];\r\n        var toRemove = [];\r\n        var maybeRemove = [];\r\n        var features = source.getFeatures();\r\n\r\n        var segments = [];\r\n        var coord = [];\r\n\r\n        var getName = function (feature) {\r\n            if (feature.getProperties().hasOwnProperty(\"name\")) {\r\n                if (feature.getProperties().name.trim().length > 0)\r\n                    names.push(feature.getProperties().name);\r\n                else names.push(fileName);\r\n            }\r\n            else names.push(fileName);\r\n        };\r\n\r\n        for (var f = 0; f < features.length; f++) {\r\n            var feature = features[f];\r\n\r\n            if (feature instanceof TC.Feature)\r\n                feature = features[f].wrap.feature;\r\n\r\n            if (feature.getGeometry() instanceof ol.geom.Point) {\r\n                coord.push(feature.getGeometry().getCoordinates());\r\n                maybeRemove.push(feature);\r\n            }\r\n            else if (feature.getGeometry() instanceof ol.geom.LineString) {\r\n                // GLS: 31/01/2018 Routes (<rte>) are converted into LineString geometries, and tracks (<trk>) into MultiLineString, por tanto, las líneas las cargamos como N Rutas, no las unimos como hasta ahora: // segments.push(feature.getGeometry());                \r\n                getName(feature);\r\n                toAdd.push(new ol.Feature({\r\n                    geometry: new ol.geom.LineString(feature.getGeometry().getCoordinates(), feature.getGeometry().getLayout())\r\n                }));\r\n                toRemove.push(feature);\r\n            }\r\n            else if (feature.getGeometry() instanceof ol.geom.MultiLineString) {\r\n                var clone = feature.clone();\r\n                getName(clone);\r\n\r\n                var ls = clone.getGeometry().getLineStrings();\r\n\r\n                var coords = segmentsUnion(ls);\r\n                toAdd.push(new ol.Feature({\r\n                    geometry: new ol.geom.LineString(coords, feature.getGeometry().getLayout())\r\n                }));\r\n                toRemove.push(feature);\r\n            }\r\n        }\r\n\r\n        if (segments.length > 0) {\r\n            var coords = segmentsUnion(segments);\r\n            toAdd.push(new ol.Feature({\r\n                geometry: new ol.geom.LineString(coords)\r\n            }));\r\n        }\r\n\r\n        if (coord.length > 0 && maybeRemove.length == features.length) {\r\n            toAdd.push(new ol.Feature({\r\n                geometry: new ol.geom.LineString(coord)\r\n            }));\r\n        }\r\n\r\n        if (toRemove.length > 0)\r\n            for (var i = 0; i < toRemove.length; i++)\r\n                source.removeFeature(toRemove[i]);\r\n\r\n        if (toAdd.length > 0) {\r\n            var sameName = function (array, element) {\r\n                var indices = [];\r\n                var idx = array.indexOf(element);\r\n                while (idx != -1) {\r\n                    indices.push(idx);\r\n                    idx = array.indexOf(element, idx + 1);\r\n\r\n                    if (indices.length > 1)\r\n                        return true;\r\n                }\r\n\r\n                return indices.length > 1 ? true : false;\r\n            };\r\n\r\n            var featureToAdd;\r\n            var index = 0;\r\n            var processAdd = function () {\r\n                const promises = toAdd.map(function (ta, idx) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        if (featureToAdd) {\r\n                            source.removeFeature(featureToAdd);\r\n                        }\r\n\r\n                        var name;\r\n                        if (names.length > idx) {\r\n                            var name = names[idx];\r\n                            if (sameName(names, name))\r\n                                name = '[' + (idx + 1) + ']' + ' ' + name;\r\n                        }\r\n\r\n                        self.parent.importedFileName = name ? name : fileName;\r\n\r\n                        featureToAdd = toAdd[idx];\r\n                        source.addFeature(featureToAdd);\r\n\r\n                        self.parent.saveTrack({\r\n                            message: self.parent.getLocaleString('geo.trk.upload.ok', { trackName: name ? name : fileName }),\r\n                            importedFileName: name ? name : fileName,\r\n                            notReproject: options.notReproject\r\n                        }).then(function (importedIndex) {\r\n                            if (idx == 0) {\r\n                                index = importedIndex;\r\n                            }\r\n                            resolve();\r\n                        });\r\n                    });\r\n                });\r\n                return Promise.all(promises);\r\n            };\r\n            processAdd().then(function () {\r\n\r\n                self.parent.layerTrack.setVisibility(false);\r\n                self.parent.layerTrack.clearFeatures();\r\n\r\n                self.parent.trigger(self.parent.Const.Event.IMPORTEDTRACK, { index: index });\r\n\r\n                delete self.parent.importedFileName;\r\n                self.parent.getLoadingIndicator().removeWait(options.wait);\r\n            });\r\n        } else {\r\n\r\n            if (self.parent.layerTrack) {\r\n                self.parent.map.removeLayer(self.parent.layerTrack);\r\n                self.parent.layerTrack = undefined;\r\n            }\r\n\r\n            delete self.parent.importedFileName;\r\n            self.parent.getLoadingIndicator().removeWait(options.wait);\r\n            TC.alert(self.parent.getLocaleString(\"geo.trk.upload.error4\"));\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.import = function (wait, data, type) {\r\n        var self = this;\r\n        var vectorSource;\r\n        var listenerKey;\r\n\r\n        if (data && data.text) {\r\n\r\n            var layerOptions = self.parent.layerTrack.wrap.createVectorSource({\r\n                data: data.text,\r\n                type: type\r\n            });\r\n            vectorSource = layerOptions.source;\r\n\r\n            listenerKey = vectorSource.on('change', function (e) {\r\n                if (vectorSource.getState() == 'ready') {\r\n                    ol.Observable.unByKey(listenerKey);\r\n                    self.processImportedFeatures(wait);\r\n                }\r\n            });\r\n\r\n            var olLayer = self.parent.layerTrack.wrap.layer;\r\n            olLayer.setSource(vectorSource);\r\n\r\n        } else {\r\n\r\n            if (self.parent.layerTrack) {\r\n                self.parent.map.removeLayer(self.parent.layerTrack);\r\n                self.parent.layerTrack = undefined;\r\n            }\r\n\r\n            delete self.parent.importedFileName;\r\n            self.parent.getLoadingIndicator().removeWait(wait);\r\n            TC.alert(self.parent.getLocaleString(\"geo.trk.upload.error4\"));\r\n        }\r\n    };\r\n\r\n    var idRequestAnimationFrame;\r\n    TC.wrap.control.Geolocation.prototype.simulateTrackEnd = function () {\r\n        var self = this;\r\n\r\n        self.parent.chartProgressClear();\r\n\r\n        if (self.simulateMarker) {\r\n            window.cancelAnimationFrame(idRequestAnimationFrame);\r\n            if (self.simulateMarker.layer.wrap.layer.getSource().getFeatures().length > 0)\r\n                self.simulateMarker.layer.removeFeature(self.simulateMarker);\r\n\r\n            delete self.simulateMarker;\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.simulateTrack = function () {\r\n        var self = this;\r\n\r\n        var coordinates;\r\n        var features = self.parent.layerTrack.wrap.layer.getSource().getFeatures();\r\n        for (var ls = 0; ls < features.length; ls++) {\r\n            if (features[ls].getGeometry() instanceof ol.geom.LineString) {\r\n                coordinates = features[ls].getGeometry().getCoordinates();\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (coordinates && coordinates.length > 0) {\r\n            var first = coordinates[0];\r\n\r\n            var setSimulateMarker = function () {\r\n                return new Promise(function (resolve, reject) {\r\n                    if (!self.simulateMarker) {\r\n                        self.parent.layerTrack.addPoint(first.slice(0, 2), {\r\n                            radius: 7,\r\n                            fillColor: '#ff0000',\r\n                            fillOpacity: 0.5,\r\n                            strokeColor: '#ffffff',\r\n                            strokeWidth: 2\r\n                        }).then(function (f) {\r\n                            resolve(f);\r\n                        });\r\n                    } else {\r\n                        self.simulateMarker.setCoords(first.slice(0, 2));\r\n                        resolve(self.simulateMarker);\r\n                    }\r\n                });\r\n            };\r\n            setSimulateMarker().then(function (f) {\r\n                self.simulateMarker = f;\r\n\r\n                var animationFrameFraction = function () {\r\n                    var trackLength = coordinates.length;\r\n                    var start, finish;\r\n                    var duration;\r\n                    var fraction;\r\n                    var hasTime = false;\r\n\r\n                    const toLength = function (coords) {\r\n                        if (self.parent.map.crs !== self.parent.map.options.utmCrs) {\r\n                            return TC.Util.reproject(coords, self.parent.map.crs, self.parent.map.options.utmCrs);\r\n                        }\r\n\r\n                        return coords;\r\n                    };\r\n\r\n                    var arCoordinates = coordinates;\r\n                    if (arCoordinates[0].length == 4 && arCoordinates[0][3] > 0) {\r\n                        start = arCoordinates[0][3];\r\n                        finish = arCoordinates[arCoordinates.length - 1][3];\r\n                        hasTime = true;\r\n                    } else {\r\n                        arCoordinates[0][3] = Date.now();\r\n\r\n                        for (var i = 1; i < arCoordinates.length; i++) {\r\n                            var done;\r\n                            arCoordinates[i][3] = 0;\r\n\r\n                            if (i + 1 < arCoordinates.length) {\r\n                                done = new ol.geom.LineString(toLength(arCoordinates.slice(i - 1, i + 1))).getLength();\r\n                            } else {\r\n                                done = new ol.geom.LineString(toLength(arCoordinates.slice(i - 1))).getLength();\r\n                            }\r\n\r\n                            arCoordinates[i][3] = arCoordinates[i - 1][3] + (3600000 * done / self.parent.walkingSpeed);\r\n                        }\r\n\r\n                        start = arCoordinates[0][3];\r\n                        finish = arCoordinates[arCoordinates.length - 1][3];\r\n                    }\r\n\r\n                    var trackFilm = new ol.geom.LineString(arCoordinates);\r\n                    var timestamp = start;\r\n                    var distance = 0;\r\n\r\n                    if (self.parent.map.crs !== self.parent.map.options.utmCrs) {\r\n                        distance = new ol.geom.LineString(toLength(JSON.parse(JSON.stringify(arCoordinates)))).getLength();\r\n                    } else {\r\n                        distance = trackFilm.getLength();\r\n                    }\r\n\r\n                    var done = 0;\r\n                    var getDoneAtM = function (m) {\r\n                        for (var i = 0; i < arCoordinates.length; i++) {\r\n                            if (arCoordinates[i][3] > m)\r\n                                return {\r\n                                    d: new ol.geom.LineString(toLength(arCoordinates.slice(0, i))).getLength(),\r\n                                    p: arCoordinates[i - 1].slice(0, 2)\r\n                                };\r\n                        }\r\n                    };\r\n\r\n                    var loopAtFraction = function () {\r\n\r\n                        if (!self.parent.simulate_paused) {\r\n                            var position = trackFilm.getCoordinateAtM(timestamp);\r\n                            var d = getDoneAtM(timestamp);\r\n\r\n                            if (fraction >= 1 || !position || !d) {\r\n                                self.simulateTrackEnd();\r\n                                var li = self.parent.getSelectedTrack();\r\n                                if (li)\r\n                                    self.parent.uiSimulate(false, li);\r\n\r\n                                if (self.parent.hasElevation) {\r\n                                    self.parent.chartProgressClear();\r\n                                }\r\n\r\n                                return;\r\n                            } else {\r\n\r\n                                if (self.parent.hasElevation) {\r\n                                    self.parent.chartSetProgress(d, position, distance, (hasTime ? self.parent._getTime(arCoordinates[0][3], position[3]) : false));\r\n                                }\r\n\r\n                                if (self.simulateMarker) {\r\n                                    var from = self.simulateMarker.getCoords();\r\n                                    var to = position;\r\n                                    var rotation = Math.atan2(to[1] - from[1], to[0] - from[0]) * 180 / Math.PI;\r\n\r\n                                    self.simulateMarker.setCoords(position);\r\n                                    //self.simulateMarker.setStyle({ angle: rotation });\r\n                                }\r\n\r\n                                if (self.parent.simulate_speed !== 1)\r\n                                    timestamp = timestamp + (self.parent.delta * self.parent.simulate_speed);\r\n                                else\r\n                                    timestamp = timestamp + self.parent.delta;\r\n                            }\r\n                        }\r\n\r\n                        idRequestAnimationFrame = requestAnimationFrame(loopAtFraction);\r\n                    };\r\n                    idRequestAnimationFrame = requestAnimationFrame(loopAtFraction);\r\n\r\n                };\r\n\r\n                const hasD3 = new Promise(function (resolve, reject) {\r\n                    if (window.d3) {\r\n                        resolve();\r\n                    }\r\n                    else {\r\n                        TC.loadJS(!window.d3, [TC.Consts.url.D3C3], function () {\r\n                            resolve();\r\n                        });\r\n                    }\r\n                });\r\n                hasD3.then(function () {\r\n                    idRequestAnimationFrame = requestAnimationFrame(animationFrameFraction);\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.headingChangehandler = function (evt) {\r\n        var self = this;\r\n        if (!self.parent.track.infoOnMap) {\r\n            self.parent.track.infoOnMap = document.createElement('div');\r\n            const iomStyle = self.parent.track.infoOnMap.style;\r\n            iomStyle.overFlowY = 'scroll';\r\n            iomStyle.height = '200px';\r\n            iomStyle.width = '200px';\r\n            iomStyle.top = '0';\r\n            iomStyle.left = '100px';\r\n            iomStyle.backgroundColor = 'fuchsia';\r\n            iomStyle.position = 'absolute';\r\n            self.parent.map.div.appendChild(self.parent.track.infoOnMap);\r\n        }\r\n\r\n        self.parent.track.infoOnMap.style.display = '';\r\n\r\n        self.heading = evt.target.getHeading();\r\n\r\n        self.parent.track.infoOnMap.innerHTML = self.parent.track.infoOnMap.innerHTML +\r\n            '<br> <p> salta headingChangehandler </p> <br> <p> evt.target.getHeading(): ' + self.heading + ' </p>';\r\n\r\n        \r\n\r\n        self.map.wrap.getMap().then(function (map) {\r\n            map.getView().setRotation(-self.heading);\r\n        });\r\n\r\n        self.parent.trigger(self.parent.Const.Event.STATEUPDATED, {\r\n            moving: (heading != undefined && heading > 0)\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.orientationChangehandler = function (event) {\r\n        var self = this;\r\n\r\n        var view = self.map.wrap.map.getView();\r\n        var center = view.getCenter();\r\n        var resolution = view.getResolution();\r\n        var beta = event.target.getBeta() || 0;\r\n        var gamma = event.target.getGamma() || 0;\r\n\r\n        center[0] -= resolution * gamma * 25;\r\n        center[1] += resolution * beta * 25;\r\n\r\n        view.setCenter(view.constrainCenter(center));\r\n\r\n        self.parent.trigger(self.parent.Const.Event.STATEUPDATED, {\r\n            moving: (heading != undefined && heading > 0)\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Geolocation.prototype.pulsate = function (circle) {\r\n        var self = this;\r\n\r\n        self.pulsated = true;\r\n\r\n        var radius = circle.wrap.feature.getGeometry().getRadius();\r\n        var start = new Date().getTime();\r\n\r\n        var duration = 500;\r\n        var listenerKey;\r\n\r\n        var getRadius = function (elapsed) {\r\n            switch (true) {\r\n                case elapsed <= 50:\r\n                    return radius;\r\n                case elapsed > 50 && elapsed <= 100:\r\n                    return radius * 1.02;\r\n                case elapsed > 100 && elapsed <= 150:\r\n                    return radius * 1.05;\r\n                case elapsed > 150 && elapsed <= 200:\r\n                    return radius * 1.02;\r\n                case elapsed > 200 && elapsed <= 300:\r\n                    return radius;\r\n                case elapsed > 300 && elapsed <= 350:\r\n                    return radius * 1.02;\r\n                case elapsed > 350 && elapsed <= 400:\r\n                    return radius * 1.05;\r\n                case elapsed > 400 && elapsed <= 450:\r\n                    return radius * 1.02;\r\n                case elapsed > 450 && elapsed <= 500:\r\n                    return radius * 1;\r\n                default:\r\n                    return radius;\r\n            }\r\n        };\r\n        listenerKey = self.olMap.on(ol.render.EventType.POSTCOMPOSE, function (event) {\r\n            var vectorContext = event.vectorContext;\r\n            var frameState = event.frameState;\r\n\r\n            var elapsed = frameState.time - start;\r\n\r\n            var f = circle.wrap.feature.getGeometry().clone();\r\n            var r = getRadius(elapsed);\r\n            f.setRadius(r);\r\n\r\n            vectorContext.setFillStrokeStyle(\r\n                new ol.style.Fill({\r\n                    color: 'rgba(0, 0, 0, 0.1)'\r\n                }),\r\n                new ol.style.Stroke({\r\n                    color: 'rgba(255, 0, 0, .8)', width: 1\r\n                })\r\n            );\r\n            vectorContext.drawCircleGeometry(f);\r\n\r\n            if (elapsed > duration) {\r\n                ol.Observable.unByKey(listenerKey);\r\n                return;\r\n            }\r\n\r\n            frameState.animate = true;\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.ResultsPanel.prototype.register = function (map) {\r\n        const self = this;\r\n        self.map = map;\r\n\r\n        map.wrap.getMap().then(function (olMap) {\r\n            self.olMap = olMap;\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.ResultsPanel.prototype.showElevationMarker = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        const data = options.data;\r\n        const layer = options.layer;\r\n        const coords = options.coords;\r\n\r\n        if (!self.elevationMarker) {\r\n            const elm = document.createElement('div');\r\n            elm.style.display = 'none';\r\n            elm.classList.add('tc-ctl-geolocation-trackMarker');\r\n            elm.classList.add('elevation');\r\n            self.elevationMarker = new ol.Overlay({\r\n                element: elm,\r\n                offset: [0, -11],\r\n                positioning: ol.OverlayPositioning.CENTER_CENTER,\r\n                stopEvent: false\r\n            });\r\n        }\r\n\r\n        // GLS: si la capa del track está visible mostramos marcamos punto del gráfico en el mapa\r\n        if (layer.getVisibility() && layer.getOpacity() > 0) {\r\n            self.elevationMarker.getElement().style.display = '';\r\n            self.olMap.addOverlay(self.elevationMarker);\r\n            self.elevationMarker.setPosition(coords[data[0].index]);\r\n        }\r\n\r\n        // No centrar en el marker\r\n        //var extent = self.map.getExtent();\r\n        //var p = coords[data[0].index];\r\n        //if (p[0] >= extent[0] && p[0] <= extent[2] && p[1] >= extent[1] && p[1] <= extent[3]) { }\r\n        //else {\r\n        //    self.map.setCenter(p.slice(0, 2), { animate: true });\r\n        //}\r\n    };\r\n\r\n    TC.wrap.control.ResultsPanel.prototype.hideElevationMarker = function () {\r\n        if (this.elevationMarker) {\r\n            this.elevationMarker.getElement().style.display = 'none';\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Coordinates.prototype.coordsActivate = function () {\r\n        var self = this;\r\n\r\n        self.olMap.on(ol.MapBrowserEventType.SINGLECLICK, self._coordsTrigger);\r\n    };\r\n\r\n    TC.wrap.control.Coordinates.prototype.coordsDeactivate = function () {\r\n        var self = this;\r\n\r\n        self.olMap.un(ol.MapBrowserEventType.SINGLECLICK, self._coordsTrigger);\r\n    };\r\n\r\n    TC.wrap.Parser = function () {\r\n    };\r\n\r\n    TC.wrap.Parser.prototype.read = function (data) {\r\n        var result = [];\r\n        var self = this;\r\n        if (self.parser) {\r\n            if (!TC.Feature) {\r\n                TC.syncLoadJS(TC.apiLocation + 'TC/Feature');\r\n            }\r\n            result = $.map(self.parser.readFeatures(data), function (feat) {\r\n                return new TC.Feature(null, {\r\n                    id: feat.getId(), data: feat.getProperties()\r\n                });\r\n            });\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.parser = {\r\n        WFS: function (options) {\r\n            this.parser = new ol.format.WFS(options);\r\n        },\r\n        JSON: function (options) {\r\n            this.parser = new ol.format.GeoJSON(options);\r\n        }\r\n    };\r\n    TC.inherit(TC.wrap.parser.WFS, TC.wrap.Parser);\r\n    TC.inherit(TC.wrap.parser.JSON, TC.wrap.Parser);\r\n\r\n    TC.wrap.control.OverviewMap.prototype.register = function (map) {\r\n        var self = this;\r\n\r\n        self.parent.layer.wrap.getLayer().then(function (olLayer) {\r\n            self.ovMap = new ol.control.OverviewMap({\r\n                target: self.parent.div,\r\n                collapsed: false,\r\n                collapsible: false,\r\n                className: self.parent.CLASS + ' ol-overviewmap',\r\n                layers: [olLayer]\r\n            });\r\n            self.ovMap._wrap = self;\r\n\r\n            /* 08/02/2019 GLS: \r\n                Establecemos el pixelRatio siempre a uno (aunque el control instancie un olMap internamente no admite el paso de la opción pixelRatio,\r\n                imposible de entender, por eso lo hago directamente), porque OL sólo atiende al valor al principio,\r\n                si después se hace zoom in/out del navegador, OL no atiende el cambio lo que provoca que el mapa se vea borroso, click se sitúa mal,\r\n                popup se sitúa entre otros efectos.\r\n                Lo gestionamos nosotros hasta que lo soporten del todo. Relacionado con las tareas/bugs:\r\n                    Bug 25976:Mapa situación en blanco\r\n                    Bug 25954:Canvas en blanco con zoom mayor al 100%\r\n                    Bug 23855:Mapa de situación se muestra en blanco\r\n            */\r\n            self.ovMap.getOverviewMap().pixelRatio_ = 1;\r\n\r\n            // Quitamos el drag&drop añadido en OL 4.1.0 machacando el overlay\r\n            self.ovMap.ovmap_.removeOverlay(self.ovMap.boxOverlay_);\r\n            var box = document.createElement('DIV');\r\n            box.className = 'ol-overviewmap-box';\r\n            box.style.boxSizing = 'border-box';\r\n            self.ovMap.boxOverlay_ = new ol.Overlay({\r\n                position: [0, 0],\r\n                positioning: ol.OverlayPositioning.BOTTOM_LEFT,\r\n                element: box\r\n            });\r\n            self.ovMap.ovmap_.addOverlay(self.ovMap.boxOverlay_);\r\n\r\n            // mantenemos el ancho y alto del canvas en números enteros\r\n            self.manageSize.call(self.ovMap.ovmap_);\r\n\r\n            self._boxElm = self.ovMap.boxOverlay_.getElement();\r\n\r\n            TC.loadJS(\r\n                !window.Draggabilly,\r\n                [TC.apiLocation + 'lib/draggabilly/draggabilly.pkgd.min.js'],\r\n                function () {\r\n                    var ovmMap = self.ovMap.ovmap_;\r\n                    const drag = new Draggabilly(self._boxElm);\r\n                    // Parcheamos Draggabilly para que respete las otras transformaciones, por ejemplo rotación.\r\n                    drag.positionDrag = function () {\r\n                        const style = this.element.style;\r\n                        const newTransform = 'translate3d( ' + this.dragPoint.x +\r\n                            'px, ' + this.dragPoint.y + 'px, 0)';\r\n                        if (style.transform.length) {\r\n                            const idxStart = style.transform.indexOf('translate3d');\r\n                            if (idxStart >= 0) {\r\n                                const idxEnd = style.transform.indexOf(')', idxStart);\r\n                                style.transform = style.transform.replace(style.transform.substring(idxStart, idxEnd + 1), newTransform);\r\n                            }\r\n                            else {\r\n                                style.transform = newTransform + ' ' + style.transform;\r\n                            }\r\n                        }\r\n                        else {\r\n                            style.transform = newTransform;\r\n                        }\r\n                    };\r\n                    drag.on('pointerDown', function (e) {\r\n                        drag.dragged = self._boxElm.cloneNode();\r\n                        drag.dragged.classList.add(TC.Consts.classes.ACTIVE);\r\n                        drag.dragged.style.position = 'absolute';\r\n                        self._boxElm.insertAdjacentElement('beforebegin', drag.dragged);\r\n                        if (map.maxExtent) {\r\n                            var bottomLeft = ovmMap.getPixelFromCoordinate([map.maxExtent[0], map.maxExtent[1]]);\r\n                            var topRight = ovmMap.getPixelFromCoordinate([map.maxExtent[2], map.maxExtent[3]]);\r\n                            var mapSize = ovmMap.getSize();\r\n                            const container = document.createElement('div');\r\n                            container.style.position = 'absolute';\r\n                            container.style.bottom = Math.round(mapSize[1] - bottomLeft[1]) + 'px';\r\n                            container.style.left = Math.round(bottomLeft[0]) + 'px';\r\n                            container.style.top = Math.round(topRight[1]) + 'px';\r\n                            container.style.right = Math.round(mapSize[0] - topRight[0]) + 'px';\r\n                            const viewport = ovmMap.getViewport();\r\n                            viewport.insertBefore(container, viewport.firstElementChild);\r\n                            drag.options.containment = container;\r\n                        }\r\n                    });\r\n                    drag.on('pointerUp', function (e) {\r\n                        drag.dragged.parentElement.removeChild(drag.dragged);\r\n                        if (map.maxExtent) {\r\n                            ovmMap.getViewport().removeChild(drag.options.containment);\r\n                            drag.options.containment = null;\r\n                        }\r\n                    });\r\n                    drag.on('dragMove', function (e, pointer, moveVector) {\r\n                        drag._delta = moveVector;\r\n                    });\r\n                    drag.on('dragEnd', function (e, pointer) {\r\n                        var olMap = self.ovMap.getMap();\r\n                        var view = olMap.getView();\r\n                        var centerPixel = ovmMap.getPixelFromCoordinate(view.getCenter());\r\n                        var newCenter = ovmMap.getCoordinateFromPixel([centerPixel[0] + drag._delta.x, centerPixel[1] + drag._delta.y]);\r\n                        var extent = map.getExtent();\r\n                        var halfWidth = (extent[2] - extent[0]) / 2;\r\n                        var halfHeight = (extent[3] - extent[1]) / 2;\r\n\r\n                        if (newCenter[0] + halfWidth > map.maxExtent[2]) {\r\n                            newCenter[0] = map.maxExtent[2] - halfWidth;\r\n                        }\r\n                        else if (newCenter[0] - halfWidth < map.maxExtent[0]) {\r\n                            newCenter[0] = map.maxExtent[0] + halfWidth;\r\n                        }\r\n                        if (newCenter[1] + halfHeight > map.maxExtent[3]) {\r\n                            newCenter[1] = map.maxExtent[3] - halfHeight;\r\n                        }\r\n                        else if (newCenter[1] - halfHeight < map.maxExtent[1]) {\r\n                            newCenter[1] = map.maxExtent[1] + halfHeight;\r\n                        }\r\n\r\n                        drag.setPosition(0, 0);\r\n                        delete drag._delta;\r\n                        map.setCenter(newCenter, { animate: true });\r\n                    });\r\n                });\r\n\r\n            map.wrap.getMap().then(function (olMap) {\r\n\r\n                // Modificamos mapa para que tenga la proyección correcta\r\n                self.reset();\r\n\r\n                const load = self.parent.div.querySelector('.' + self.parent.CLASS + '-load');\r\n                olLayer._wrap.$events.on(TC.Consts.event.BEFORETILELOAD, function () {\r\n                    load.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    load.classList.add(TC.Consts.classes.VISIBLE);\r\n                });\r\n                olLayer._wrap.$events.on(TC.Consts.event.TILELOAD, function () {\r\n                    load.classList.remove(TC.Consts.classes.VISIBLE);\r\n                    load.classList.add(TC.Consts.classes.HIDDEN);\r\n                });\r\n\r\n                olMap.addControl(self.ovMap);\r\n\r\n                self.parent.isLoaded = true;\r\n                self.parent.trigger(TC.Consts.event.MAPLOAD);\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.reset = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const setLayer = function (layer, crs) {\r\n                if (layer.type === TC.Consts.layerType.WMTS) {\r\n                    var layerProjectionOptions = { crs: crs || self.parent.map.crs, oldCrs: layer.wrap.layer.getSource().getProjection().getCode() }; // , allowFallbackLayer: true\r\n\r\n                    if (layerProjectionOptions.oldCrs !== layerProjectionOptions.crs) {\r\n                        layer.setProjection(layerProjectionOptions);\r\n                    }\r\n                }\r\n\r\n                layer.wrap.getLayer().then(function (olLayer) {\r\n\r\n                    var olView = new ol.View(getResolutionOptions(self.parent.map.wrap, olLayer._wrap.parent));\r\n\r\n                    if (olView.getResolutions()) {\r\n                        olView.setResolution(olView.getResolutions().filter(function (res) {\r\n                            return res > olView.getResolutionForExtent(self.parent.map.getExtent(), olMap.getSize())\r\n                        }).reverse()[0]);\r\n\r\n                        olMap.setView(olView);\r\n                    } else if (olView.getProjection().getCode() !== olMap.getView().getProjection().getCode()) {\r\n                        olMap.setView(olView);\r\n                    }\r\n\r\n                    // para controlar el mapa en blanco en IE en la carga inicial\r\n                    olLayer._wrap.$events.one(TC.Consts.event.TILELOAD, function () {\r\n                        olMap.getLayers().getArray()[0].getSource().refresh();\r\n                    });\r\n\r\n                    if (layer !== self.parent.layer || olMap.getLayers().getArray().indexOf(layer) === -1) {\r\n\r\n                        self.parent.map.trigger(TC.Consts.event.OVERVIEWBASELAYERCHANGE, { oldLayer: layer !== self.parent.layer ? self.parent.layer : null, newLayer: layer });\r\n                        olMap.getLayers().forEach(function (l) {\r\n                            if (l instanceof ol.layer.Image || l instanceof ol.layer.Tile) {\r\n                                olMap.removeLayer(l);\r\n                            }\r\n                        });\r\n\r\n                        const load = self.parent.div.querySelector('.' + self.parent.CLASS + '-load');\r\n                        olLayer._wrap.$events.on(TC.Consts.event.BEFORETILELOAD, function () {\r\n                            load.classList.remove(TC.Consts.classes.HIDDEN);\r\n                            load.classList.add(TC.Consts.classes.VISIBLE);\r\n                        });\r\n                        olLayer._wrap.$events.on(TC.Consts.event.TILELOAD, function () {\r\n                            load.classList.remove(TC.Consts.classes.VISIBLE);\r\n                            load.classList.add(TC.Consts.classes.HIDDEN);\r\n                        });\r\n\r\n                        olMap.getLayers().insertAt(0, olLayer); // GLS: no usamos .addLayer(olLayer) para asegurar que la capa a añadir quede como fondo.\r\n                    }\r\n\r\n                    resolve(layer);\r\n                });\r\n            };\r\n\r\n            options = options || {};\r\n            var layer = options.layer || self.parent.layer;\r\n            if (self.parent.map && layer && self.ovMap) {\r\n                var olMap = self.ovMap.ovmap_;\r\n\r\n                layer.getCapabilitiesPromise().then(function () {\r\n\r\n                    var originalLayer = layer;\r\n\r\n                    if (!layer.isCompatible(self.parent.map.crs) && layer.wrap.getCompatibleMatrixSets(self.parent.map.crs).length === 0) {\r\n                        layer = layer.getFallbackLayer() || self.parent.defaultLayer;\r\n\r\n                        layer.getCapabilitiesPromise().then(function () {\r\n                            if (self.parent.map.on3DView && !layer.isCompatible(self.parent.map.crs)) {\r\n                                self.parent.map.loadProjections({\r\n                                    crsList: originalLayer.getCompatibleCRS(),\r\n                                    orderBy: 'name'\r\n                                }).then(function (projList) {\r\n                                    setLayer(originalLayer, projList[0].code);\r\n                                });\r\n                            } else if (layer.isCompatible(self.parent.map.crs)) {\r\n                                setLayer(layer);\r\n                            }\r\n                        });\r\n                    } else {\r\n                        setLayer(layer);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.get3DCameraLayer = function () {\r\n        var self = this;\r\n        var result = null;\r\n        var camLayerId = '3DCamera';\r\n        var ovMap;\r\n\r\n        if (self.ovMap) {\r\n            ovMap = self.ovMap.getOverviewMap();\r\n            ovMap.getLayers().forEach(function (elm) {\r\n                if (elm.get('id') === camLayerId) {\r\n                    result = elm;\r\n                }\r\n            });\r\n\r\n            if (!result) {\r\n                var ovMap = self.ovMap.getOverviewMap();\r\n                var fovStyle = createNativeStyle({});\r\n                // Ponemos los cuadriláteros de fov sin relleno (por legibilidad)\r\n                fovStyle[0].getFill().setColor([0, 0, 0, 0]);\r\n                result = new ol.layer.Vector({\r\n                    id: camLayerId,\r\n                    source: new ol.source.Vector(),\r\n                    style: fovStyle\r\n                });\r\n                ovMap.addLayer(result);\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.draw3DCamera = function (options) {\r\n        var self = this;\r\n\r\n        if (this.parent.map.isLoaded) {\r\n            self.is3D = !!options;\r\n            var camLayer = self.get3DCameraLayer();\r\n            if (camLayer) {\r\n                var feature;\r\n                options = options || {\r\n                };\r\n                var fov = options.fov;\r\n                var source = camLayer.getSource();\r\n                if (!fov || !fov.length) { // no vemos terreno o no estamos en vista 3D\r\n                    source.clear();\r\n                }\r\n                else {\r\n                    var features = source.getFeatures();\r\n                    if (!features.length) {\r\n                        feature = new ol.Feature();\r\n                        source.addFeature(feature);\r\n                    }\r\n                    else {\r\n                        feature = features[0];\r\n                    }\r\n                    feature.setGeometry(new ol.geom.Polygon([fov]));\r\n                }\r\n                var heading = (typeof options.heading === 'number') ? options.heading : 0;\r\n                self._boxElm.style.transform = 'rotate(' + heading + 'rad)';\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.enable = function () {\r\n        var self = this;\r\n        if (self.parent.layer && self.parent.layer.setVisibility) {\r\n            self.parent.layer.setVisibility(true);\r\n\r\n            /* GLS: bug 23855: mapa de situación se muestra en blanco\r\n                En el resize se valida el alto y el ancho y como el div padre (id = \"ovmap\") tiene display: none, \r\n                el ancho y el alto devuelven cero y por ello se muestra en blanco. \r\n                No vale con lanzar .trigger('resize') porque no utiliza los valores actuales del div, \r\n                sino los almacenados, por eso llamamos a updateSize que actualiza dichos valores.\r\n                https://tfsapp.tracasa.es:8088/tfs/web/wi.aspx?pcguid=4819cc6e-400e-4f70-ba7c-c18a830405aa&id=23855                \r\n            */\r\n            self.parent.wrap.ovMap.ovmap_.updateSize();\r\n\r\n            // Lo siguiente es para actualizar mapa de situación\r\n            const resizeEvent = document.createEvent('HTMLEvents');\r\n            resizeEvent.initEvent('resize', false, false);\r\n            self.parent.map.div.dispatchEvent(resizeEvent);\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.disable = function () {\r\n        var self = this;\r\n        if (self.parent.layer && self.parent.layer.setVisibility) {\r\n            self.parent.layer.setVisibility(false);\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.OverviewMap.prototype.manageSize = function () {\r\n        const self = this;\r\n\r\n        TC.wrap.Map.prototype.manageSize.call(self);\r\n    };\r\n\r\n    TC.wrap.control.FeatureInfo.prototype.register = function (map) {\r\n        var self = this;\r\n        map.wrap.getMap().then(function (olMap) {\r\n            TC.wrap.control.Click.prototype.register.call(self, map);\r\n            var _clickTrigger = self._trigger;\r\n            self._trigger = function (e) {\r\n                var result = _clickTrigger.call(self, e);\r\n                if (result) {\r\n                    self.parent.beforeRequest({ xy: e.pixel });\r\n                }\r\n                else {\r\n                    map.trigger(TC.Consts.event.NOFEATUREINFO, { control: self.parent });\r\n                }\r\n                return result;\r\n            }\r\n        });\r\n    };\r\n\r\n    var bufferElm;\r\n    var getElementText = function (elm) {\r\n        var text = elm.innerHTML || elm.textContent;\r\n        bufferElm = bufferElm || document.createElement(\"textarea\");\r\n        bufferElm.innerHTML = text;\r\n        return bufferElm.value;\r\n    };\r\n\r\n    var esriXmlParser = {\r\n        readFeatures: function (text) {\r\n            var result = [];\r\n            var dom = (new DOMParser()).parseFromString(text, 'text/xml');\r\n            if (dom.documentElement.tagName === 'FeatureInfoResponse') {\r\n                var fiCollections = dom.documentElement.getElementsByTagName('FeatureInfoCollection');\r\n                for (var i = 0, len = fiCollections.length; i < len; i++) {\r\n                    var fic = fiCollections[i];\r\n                    var layerName = fic.getAttribute('layername');\r\n                    var fInfos = fic.getElementsByTagName('FeatureInfo');\r\n                    for (var j = 0, lenj = fInfos.length; j < lenj; j++) {\r\n                        var fields = fInfos[j].getElementsByTagName('Field');\r\n                        var attributes = {\r\n                        };\r\n                        for (var k = 0, lenk = fields.length; k < lenk; k++) {\r\n                            var field = fields[k];\r\n                            attributes[getElementText(field.getElementsByTagName('FieldName')[0])] = getElementText(field.getElementsByTagName('FieldValue')[0]);\r\n                        }\r\n                        var feature = new ol.Feature(attributes);\r\n                        feature.setId(layerName + '.' + TC.getUID());\r\n                        result[result.length] = feature;\r\n                    }\r\n                }\r\n            }\r\n            return result;\r\n        }\r\n    };\r\n\r\n    var addLayerToService = function (service, layer, name) {\r\n        var path = layer.getPath(name);\r\n        service.layers.push({\r\n            name: name,\r\n            title: path[path.length - 1],\r\n            path: path.slice(1),\r\n            features: []\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.FeatureInfo.prototype.getFeatureInfo = function (coords, resolution, options) {\r\n        var self = this;\r\n        var opts = options || {};\r\n        var map = self.parent.map;\r\n        map.wrap.getMap().then(function (olMap) {\r\n            var targetServices = {};\r\n            var auxInfo = {};\r\n            const requestPromises = [];\r\n            const requestDataArray = [];\r\n            var featurePromises = [];\r\n            var services = [];\r\n\r\n            //var infoFormats = [];\r\n            var layers = olMap.getLayers().getArray();\r\n\r\n            // GLS: filtro el array de capas para quedarnos con las capas que son raster y visibles.\r\n            layers = layers.filter(function (elem) { return elem instanceof ol.layer.Image && elem.getVisible(); });\r\n\r\n            for (var j = 0; j < layers.length; j++) {\r\n                var olLayer = layers[j];\r\n                var layer = olLayer._wrap.parent;\r\n                var source = olLayer.getSource();\r\n\r\n                //console.log(\"Source: \" + layer.layerNames.join(\",\"));\r\n                //Por qué en workLayers están el vectorial de medición, y cosas así?\r\n                if (source.getGetFeatureInfoUrl && $.inArray(layer, map.workLayers) >= 0 && layer.names.length > 0\r\n                    && (!opts.serviceUrl || opts.serviceUrl === layer.url)) { // Mirar si en las opciones pone que solo busque en un servicio\r\n\r\n                    //\r\n                    var targetService;\r\n                    if (!targetServices[layer.url]) {\r\n                        targetService = {\r\n                            layers: [],\r\n                            mapLayers: [],\r\n                            title: layer.title,\r\n                            request: null\r\n                        };\r\n                        targetServices[layer.url] = targetService;\r\n                        auxInfo[layer.url] = {\r\n                            \"source\": jQuery.extend(true, {}, source),\r\n                            \"layers\": []\r\n                        };\r\n                    }\r\n                    else {\r\n                        targetService = targetServices[layer.url];\r\n                        auxInfo[layer.url].source.updateParams(ol.obj.assign(auxInfo[layer.url].source.getParams(), source.getParams()));\r\n                    }\r\n                    targetService.mapLayers.push(layer);\r\n\r\n                    //var targetService = {\r\n                    //    layers: [], mapLayers: [layer]\r\n                    //};\r\n                    var disgregatedNames = layer.getDisgregatedLayerNames();\r\n                    if (opts.layerName) { // Mirar si en las opciones pone que solo busque en una capa\r\n                        if (disgregatedNames.indexOf(opts.layerName) >= 0 && olLayer._wrap.getInfo(opts.layerName).queryable) {\r\n                            addLayerToService(targetService, layer, opts.layerName);\r\n                            auxInfo[layer.url].layers.push(opts.layerName);\r\n                        }\r\n                    }\r\n                    else {\r\n                        for (var i = 0; i < disgregatedNames.length; i++) {\r\n                            var name = disgregatedNames[i];\r\n                            if (olLayer._wrap.getInfo(name).queryable) {\r\n                                addLayerToService(targetService, layer, name);\r\n                            }\r\n                            else {\r\n                                TC.Util.consoleRegister('Capa \"' + disgregatedNames[i] + '\" no queryable, la eliminamos de la petición GFI');\r\n                                disgregatedNames.splice(i, 1);\r\n                                i = i - 1;\r\n                            }\r\n                        }\r\n\r\n                        // GLS: validamos si nos queda alguna capa a la cual consultar\r\n                        if (disgregatedNames.length > 0) {\r\n                            auxInfo[layer.url].layers = auxInfo[layer.url].layers.concat(disgregatedNames);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            for (var serviceUrl in targetServices) {\r\n                services.push(targetServices[serviceUrl]);\r\n                var targetService = targetServices[serviceUrl];\r\n                var source = auxInfo[serviceUrl].source;\r\n                var layers = auxInfo[serviceUrl].layers;\r\n\r\n                // GLS: validamos si hay capas a las cuales consultar, si no hay continuamos con el siguiente servicio\r\n                if (!layers || (layers && layers.length === 0)) {\r\n                    continue;\r\n                }\r\n\r\n                var params = source.getParams();\r\n                source.params_.LAYERS = layers.join(',');\r\n                var gfiURL = source.getGetFeatureInfoUrl(coords, resolution, map.crs, {\r\n                    'QUERY_LAYERS': layers.join(','),\r\n                    'INFO_FORMAT': params.INFO_FORMAT,\r\n                    'FEATURE_COUNT': 1000,\r\n                    'radius': map.options.pixelTolerance,\r\n                    'buffer': map.options.pixelTolerance\r\n                });\r\n\r\n                gfiURL = gfiURL.replace(/sld_body=[a-zA-Z%0-9._]*/); // Quitamos el parámetro sld_body\r\n\r\n\r\n                var expUrl = gfiURL;\r\n                const requestData = {\r\n                    serviceUrl: serviceUrl,\r\n                    requestedFormat: params.INFO_FORMAT,\r\n                    expandUrl: expUrl\r\n                };\r\n                requestDataArray.push(requestData);\r\n                requestPromises.push(new Promise(function (resolve, reject) {\r\n                    const mapLayer = targetService.mapLayers[0];\r\n                    mapLayer.toolProxification.fetch(gfiURL)\r\n                        .then(function (data) {\r\n                            mapLayer.toolProxification.cacheHost.getAction(requestData.expandUrl).then(function (cache) {\r\n                                requestData.originalUrl = cache.action.call(mapLayer.toolProxification, requestData.expandUrl);\r\n                                resolve($.extend({}, data, requestData));\r\n                            });\r\n                        })\r\n                        .catch(function (error) {\r\n                            reject(Error(error));\r\n                        });\r\n                }));\r\n                TC.Util.consoleRegister(\"Lanzamos GFI\");\r\n            }\r\n\r\n            if (requestPromises.length > 0) {\r\n                Promise.all(requestPromises).then(function (responses) {\r\n                    var someSuccess = false;\r\n                    var featureCount = 0;\r\n                    var featureInsertionPoints = [];\r\n                    for (var i = 0; i < responses.length; i++) {\r\n                        var featureInfo = responses[i];\r\n                        var service = targetServices[requestDataArray[i].serviceUrl];\r\n                        someSuccess = true;\r\n                        service.text = featureInfo.responseText;\r\n                        var format;\r\n                        var iFormat = featureInfo.contentType;\r\n                        if (iFormat && iFormat.indexOf(\";\") > -1)\r\n                            iFormat = iFormat.substr(0, iFormat.indexOf(\";\")).trim();\r\n\r\n                        if (!iFormat) iFormat = featureInfo.requestedFormat;\r\n\r\n                        if (iFormat === featureInfo.requestedFormat) {\r\n                            switch (iFormat) {\r\n                                case 'application/json':\r\n                                    format = new ol.format.GeoJSON();\r\n                                    break;\r\n                                case 'application/vnd.ogc.gml':\r\n                                    if (featureInfo.responseText.indexOf(\"FeatureCollection\") > -1) {\r\n                                        format = new ol.format.WFS({\r\n                                            gmlFormat: new ol.format.GML2({\r\n                                                srsName: map.crs\r\n                                            })\r\n                                        });\r\n                                    }\r\n                                    else {\r\n                                        format = new ol.format.WMSGetFeatureInfo();\r\n                                    }\r\n                                    break;\r\n                                case 'application/vnd.ogc.gml/3.1.1':\r\n                                    format = new ol.format.GML3Patched({\r\n                                        srsName: map.crs\r\n                                    });\r\n                                    break;\r\n                                case 'application/vnd.esri.wms_featureinfo_xml':\r\n                                    format = esriXmlParser;\r\n                                    break;\r\n                                default:\r\n                                    format = null;\r\n                                    break;\r\n                            }\r\n\r\n                            if (format) {\r\n                                var features = format.readFeatures(featureInfo.responseText, {\r\n                                    featureProjection: ol.proj.get(map.crs)\r\n                                });\r\n                                featureCount = featureCount + features.length;\r\n                                var isParentOrSame = function (layer, na, nb) {\r\n                                    var result = false;\r\n                                    if (na === nb) {\r\n                                        result = true;\r\n                                    }\r\n                                    else {\r\n                                        var pa = layer.getNodePath(na);\r\n                                        var pb = layer.getNodePath(nb);\r\n                                        if (pa.length > 0 && pb.length >= pa.length) {\r\n                                            result = true;\r\n                                            for (var i = 0; i < pa.length; i++) {\r\n                                                if (layer.wrap.getName(pa[i]) !== layer.wrap.getName(pb[i])) {\r\n                                                    result = false;\r\n                                                    break;\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                    return result;\r\n                                };\r\n\r\n                                var fakeLayers = {\r\n                                };\r\n\r\n                                for (var j = 0; j < features.length; j++) {\r\n                                    var feature = features[j];\r\n                                    if (feature instanceof ol.Feature) {\r\n                                        var fid = feature.getId() || TC.getUID();\r\n                                        var found = false;\r\n                                        var layerName = fid.substr(0, fid.lastIndexOf('.'));\r\n                                        for (var k = 0; k < service.layers.length; k++) {\r\n                                            var l = service.layers[k];\r\n                                            var lName = l.name.substr(l.name.indexOf(':') + 1);\r\n                                            if (service.mapLayers.some(function (mapLayer) { return isParentOrSame(mapLayer, lName, layerName) })) {\r\n                                                found = true;\r\n                                                if (!opts.featureId || feature.getId() === opts.featureId) { // Mirar si en las opciones pone que solo busque una feature\r\n                                                    featurePromises.push(TC.wrap.Feature.createFeature(feature, { showsPopup: false }));\r\n                                                    featureInsertionPoints.push(l.features);\r\n                                                }\r\n                                                break;\r\n                                            }\r\n                                        }\r\n\r\n                                        //si llegamos aquí y no he encontrado su layer, es que no cuadraba el prefijo del fid con el id del layer\r\n                                        //esto pasa, p.ej, en cartociudad\r\n                                        if (!found) {\r\n                                            //así que creo un layer de palo para la respuesta del featInfo\r\n                                            var fakeLayer;\r\n                                            if (fakeLayers[layerName]) fakeLayer = fakeLayers[layerName];\r\n                                            else {\r\n                                                fakeLayer = {\r\n                                                    name: layerName, title: layerName, path: [layerName], features: []\r\n                                                };\r\n                                                fakeLayers[layerName] = fakeLayer;\r\n                                                service.layers.push(fakeLayer);\r\n                                            }\r\n\r\n                                            if (!opts.featureId || feature.getId() === opts.featureId) { // Mirar si en las opciones pone que solo busque una feature\r\n                                                featurePromises.push(TC.wrap.Feature.createFeature(feature, { showsPopup: false }));\r\n                                                featureInsertionPoints.push(fakeLayer.features);\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }//iteración sobre las features de esta respuesta\r\n\r\n\r\n                            }\r\n                            else {\r\n                                //si no hay formato reconocido y parseable, metemos un iframe con la respuesta\r\n                                //y prau\r\n                                //para eso, creo una falsa entrada de tipo feature, con un campo especial rawUrl o rawContent\r\n\r\n                                var compoundLayer = {\r\n                                    name: 'layer' + TC.getUID(), title: 'Datos en el punto', features: []\r\n                                };\r\n\r\n                                service.layers[service.layers.length] = compoundLayer;\r\n                                compoundLayer.features[0] = {\r\n                                    rawUrl: featureInfo.originalUrl, expandUrl: featureInfo.expandUrl, rawContent: featureInfo.responseText, rawFormat: iFormat\r\n                                };\r\n                                featureCount = featureCount + 1;\r\n                            }\r\n                        }\r\n                        else { // iFormat !== featureInfo.requestedFormat\r\n\r\n                            // GLS:\r\n                            TC.Util.consoleRegister(\"Respuesta GFI: lo más probable es que el servidor esté devolviendo una excepción\");\r\n                            TC.Util.consoleRegister(\"Lanzamos los eventos que corresponde y mostramos tostada\");\r\n\r\n                            // En este caso lo más probable es que el servidor esté devolviendo una excepción\r\n                            self.parent.responseError({\r\n                                message: featureInfo.responseText,\r\n                                status: featureInfo.status\r\n                            });\r\n                            // GLS: misma gestión de error que en ol.js - > function (a, b, c) { // error...\r\n                            map.toast(self.parent.getLocaleString('featureInfo.error'), {\r\n                                type: TC.Consts.msgType.ERROR\r\n                            });\r\n                        }\r\n\r\n                    }\r\n                    if (someSuccess) {\r\n                        var finfoPromises = featurePromises;\r\n                        if (featurePromises.length) {\r\n                            finfoPromises = finfoPromises.concat(new Promise(function (resolve, reject) {\r\n                                // Si hay features cargamos el módulo de geometria para encontrar una que se interseque con el punto\r\n                                TC.loadJS(\r\n                                    !TC.Geometry,\r\n                                    TC.apiLocation + 'TC/Geometry',\r\n                                    function () {\r\n                                        resolve();\r\n                                    }\r\n                                );\r\n                            }));\r\n                        }\r\n                        Promise.all(finfoPromises).then(function (features) {\r\n                            var defaultFeature;\r\n                            features.forEach(function (feat, idx) {\r\n                                if (feat) {\r\n                                    feat.attributes = [];\r\n                                    for (var key in feat.data) {\r\n                                        var value = feat.data[key];\r\n                                        if (typeof value !== 'object') {\r\n                                            feat.attributes.push({\r\n                                                name: key,\r\n                                                value: typeof (value) == \"number\" ? value.toLocaleString(TC.Util.getMapLocale(self.parent.map)) : value\r\n                                            });\r\n                                        }\r\n                                    }\r\n                                    if (!defaultFeature && TC.Geometry.isInside(coords, feat.geometry)) {\r\n                                        defaultFeature = feat;\r\n                                    }\r\n                                    featureInsertionPoints[idx].push(feat);\r\n                                }\r\n                            });\r\n\r\n                            var services = [];\r\n                            for (var serviceUrl in targetServices) {\r\n                                if (targetServices.hasOwnProperty(serviceUrl)) {\r\n                                    services.push(targetServices[serviceUrl]);\r\n                                }\r\n                            }\r\n\r\n                            self.parent.responseCallback({\r\n                                coords: coords,\r\n                                resolution: resolution,\r\n                                services: services,\r\n                                featureCount: featureCount,\r\n                                defaultFeature: defaultFeature\r\n                            });\r\n                        });\r\n                    }\r\n                },\r\n                    function (a, b, c) { // error\r\n                        if (services && services.length == 0) {\r\n                            for (var serviceUrl in targetServices) {\r\n                                services.push(targetServices[serviceUrl]);\r\n                            }\r\n                        }\r\n\r\n                        self.parent.responseCallback({\r\n                            coords: coords, resolution: resolution, services: services, featureCount: 0\r\n                        });\r\n                        map.toast(self.parent.getLocaleString('featureInfo.error'), {\r\n                            type: TC.Consts.msgType.ERROR\r\n                        });\r\n                    });\r\n            }\r\n            else {\r\n\r\n                if (map.workLayers.filter(function (layer) {\r\n                    return layer instanceof TC.layer.Raster;\r\n                }).length > 0) {\r\n                    map.toast(self.parent.getLocaleString('featureInfo.notQueryableLayers'), {\r\n                        type: TC.Consts.msgType.INFO\r\n                    });\r\n                }\r\n\r\n                if (services && services.length == 0) {\r\n                    for (var serviceUrl in targetServices) {\r\n                        services.push(targetServices[serviceUrl]);\r\n                    }\r\n                }\r\n\r\n                // GLS: nos suscribimos TC.Consts.event.BEFOREFEATUREINFO y lanzamos el mismo evento de zero resultados ya que puede darse que la resolución se lance antes del before.\r\n                map.on(TC.Consts.event.BEFOREFEATUREINFO, function () {\r\n                    self.parent.responseCallback({\r\n                        coords: coords, resolution: resolution, services: services, featureCount: 0\r\n                    });\r\n                });\r\n\r\n                self.parent.responseCallback({\r\n                    coords: coords, resolution: resolution, services: services, featureCount: 0\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.register = function (map) {\r\n        var self = this;\r\n        map.wrap.getMap().then(function (olMap) {\r\n            TC.wrap.control.Click.prototype.register.call(self, map);\r\n            var _clickTrigger = self._trigger;\r\n            self._trigger = function (e) {\r\n                self.hasEligibleLayers().then(function (hasLayers) {\r\n                    if (hasLayers) {\r\n                        if (!self.parent._isSearching) {\r\n                            if (e.type == ol.MapBrowserEventType.SINGLECLICK && !self.parent._isDrawing && !self.parent._isSearching) {\r\n                                _clickTrigger.call(self, e);\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.hasEligibleLayers = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const map = self.parent.map;\r\n            var ret = false;\r\n            map.wrap.getMap().then(function (olMap) {\r\n                olMap.getLayers().forEach(function (olLayer) {\r\n                    var layer = olLayer._wrap.parent;\r\n                    var source = olLayer.getSource();\r\n                    //Por qué en workLayers están el vectorial de medición, y cosas así?\r\n                    if (source.getGetFeatureInfoUrl && $.inArray(layer, map.workLayers) >= 0) {\r\n                        ret = true;\r\n                        return false;   //break del foreach\r\n                    }\r\n                });\r\n                resolve(ret);\r\n            });\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.beginDraw = function (options) {\r\n        var self = this;\r\n        options = options || {};\r\n        var xy = options.xy;\r\n        var layer = options.layer;\r\n        var callback = options.callback;\r\n        var geometryType = options.geometryType;\r\n        var semaforo = false;\r\n        if (!self.drawCtrl) {\r\n            layer.wrap.getLayer().then(function (olLayer) {\r\n                var olGeometryType;\r\n                switch (geometryType) {\r\n                    case TC.Consts.geom.POLYLINE:\r\n                        olGeometryType = ol.geom.GeometryType.LINE_STRING;\r\n                        break;\r\n                    default:\r\n                        olGeometryType = ol.geom.GeometryType.POLYGON;\r\n                        break;\r\n                }\r\n                self.drawCtrl = new ol.interaction.Draw({\r\n                    source: olLayer.getSource(),\r\n                    type: olGeometryType\r\n                    , style: olLayer.getStyle()\r\n                });\r\n                var setShowsPopup = function (wrap) {\r\n                    wrap.parent.showsPopup = false;\r\n                };\r\n                olLayer.getSource().on(ol.source.VectorEventType.ADDFEATURE, function (event) {\r\n                    if (event.feature._wrap) {\r\n                        setShowsPopup(event.feature._wrap);\r\n                    }\r\n                    else {\r\n                        event.feature._wrapPromise.then(setShowsPopup);\r\n                    }\r\n                });\r\n                self.drawCtrl.handleEvent = function (event) {\r\n                    //esta ñapa para solucionar cuando haces un primer punto y acontinuación otro muy rápido\r\n                    if (event.type == ol.MapBrowserEventType.SINGLECLICK) {\r\n                        var points = olGeometryType === ol.geom.GeometryType.POLYGON ? this.sketchCoords_[0] : this.sketchCoords_;\r\n                        if (semaforo && points.length == 2 && this.sketchFeature_ !== null) {// GLS: Añado la misma validación (this.sketchFeature_ !== null) que tiene el código de OL antes de invocar addToDrawing_ \r\n                            this.addToDrawing_(event);\r\n                        }\r\n                        else {\r\n                            semaforo = true;\r\n                        }\r\n                    }\r\n                    return ol.interaction.Draw.handleEvent.call(this, event)\r\n                }\r\n                const map = self.parent.map;\r\n                const olMap = map.wrap.map;\r\n                olMap.addInteraction(self.drawCtrl);\r\n                self.drawCtrl.on(ol.interaction.DrawEventType.DRAWSTART, function (event) {\r\n                    self.parent._isDrawing = true;\r\n                    olMap.getInteractions().forEach(function (item, i) {\r\n                        if (item instanceof (ol.interaction.DoubleClickZoom))\r\n                            item.setActive(false);\r\n                    });\r\n                });\r\n                self.drawCtrl.startDrawing_({\r\n                    coordinate: xy\r\n                });\r\n                self.drawCtrl.on(ol.interaction.DrawEventType.DRAWEND, function (event) {\r\n                    self.parent._isDrawing = false;\r\n                    olMap.getInteractions().forEach(function (item, i) {\r\n                        if (item instanceof (ol.interaction.DoubleClickZoom))\r\n                            item.setActive(false);\r\n                    });\r\n                    olMap.removeInteraction(self.drawCtrl);\r\n                    this.setActive(false);\r\n                    self.drawCtrl = null;\r\n                    olLayer.getSource().clear();\r\n                    self.parent._drawToken = true;\r\n                    setTimeout(function () {\r\n                        self.parent._drawToken = false;\r\n                    }, 500);\r\n                    if (callback) {\r\n                        TC.wrap.Feature.createFeature(event.feature).then(function (feat) {\r\n                            callback(feat);\r\n                        });\r\n                    }\r\n                });\r\n            });\r\n\r\n        }\r\n        else {\r\n            self.drawCtrl.setActive(true);\r\n            self.drawCtrl.startDrawing_({\r\n                coordinate: xy\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.cancelDraw = function (xy, layer, callback) {\r\n        var self = this;\r\n        if (self.drawCtrl && self.parent._isDrawing) {\r\n            self.parent._isDrawing = false;\r\n            self.drawCtrl.setActive(false);\r\n            self.drawCtrl.source_.clear();\r\n\r\n        }\r\n    };\r\n\r\n\r\n    var WFSGetFeatureBuilder = function (map, filter, outputFormat, download) {\r\n        const arrPromises = [];\r\n        var services = {};\r\n        const _getServiceTitle = function (service) {\r\n            const mapLayer = service.mapLayers[0];\r\n            return service.title || service.mapLayers.reduce(function (prev, cur) {\r\n                return prev || cur.title;\r\n            }, '') || (mapLayer.tree && mapLayer.tree.title) || mapLayer.capabilities.Service.Title;\r\n        };\r\n        const olMap = map.wrap.map;\r\n        olMap.getLayers().forEach(function (olLayer) {\r\n            var layer = olLayer._wrap.parent;\r\n            if (!olLayer.getVisible() || $.inArray(layer, map.workLayers) < 0 || layer.type !== TC.Consts.layerType.WMS)\r\n                return;\r\n            var availableLayers = layer.getDisgregatedLayerNames() || layer.availableNames;\r\n            var serviceObj = services[layer.url.toLowerCase()];\r\n            if (!serviceObj) {\r\n                serviceObj = services[layer.url.toLowerCase()] = {\r\n                    layers: [], mapLayers: [layer], layerNames: []\r\n                };\r\n            }\r\n            for (var i = 0; i < availableLayers.length; i++) {\r\n                var name = availableLayers[i];\r\n                if (!layer.isVisibleByScale(name) && !download)\r\n                    continue;\r\n                if (!layer.wrap.getInfo(name).queryable)\r\n                    continue;\r\n                serviceObj.layerNames.push(name);\r\n                var path = layer.getPath(name);\r\n                serviceObj.layers.push({\r\n                    name: name,\r\n                    title: path[path.length - 1],\r\n                    path: path.slice(1),\r\n                    features: []\r\n                });\r\n            }\r\n            if (serviceObj.layerNames.length == 0)\r\n                return;\r\n            if (typeof (serviceObj.request) !== \"undefined\") {\r\n                return;\r\n            }\r\n            serviceObj.request = serviceObj.request || layer.getWFSCapabilitiesPromise(); //WFSCapabilities.Promises(url);\r\n            arrPromises.push(new Promise(function (resolve, reject) {\r\n                serviceObj.request.then(function (capabilities) {\r\n                    var service = null;\r\n                    var errors = [];\r\n                    for (var url in services)\r\n                        if (services[url].request && services[url].request == serviceObj.request) {\r\n                            service = services[url];\r\n                        }\r\n                    var _numMaxFeatures = null;\r\n                    var layerList = service.layerNames;\r\n                    if (!(layerList instanceof Array) || !layerList.length) return;//condici\\u00f3n de salida\r\n                    //comprobamos que tiene el getfeature habilitado\r\n                    if (typeof (capabilities.Operations.GetFeature) === \"undefined\") {\r\n                        errors.push({ key: TC.Consts.WFSErrors.GetFeatureNotAvailable, params: { serviceTitle: _getServiceTitle(service) } })\r\n                        resolve({ \"errors\": errors });\r\n                        return;\r\n                    }\r\n                    var availableLayers = [];\r\n                    for (var i = 0; i < layerList.length; i++) {\r\n                        //Comprbamos si la capa en el WMS tiene el mimso nombre que en el WFS\r\n                        var layer = layerList[i].substring(layerList[i].indexOf(\":\") + 1);\r\n                        //quitamos los ultimos caracteres que sean \"_\" , cosas de Idena\r\n                        while (layer[layer.length - 1] === \"_\") {\r\n                            layer = layer.substring(0, layer.lastIndexOf(\"_\"));\r\n                        }\r\n                        if (!capabilities.FeatureTypes.hasOwnProperty(layer)) {\r\n                            var titles = service.mapLayers[0].getPath(layer);\r\n                            errors.push({ key: TC.Consts.WFSErrors.LayersNotAvailable, params: { serviceTitle: _getServiceTitle(service), \"layerName\": titles[titles.length - 1] } });\r\n                            continue;\r\n                        }\r\n                        if (availableLayers.indexOf(layer) < 0)\r\n                            availableLayers.push(layer);\r\n                    }\r\n                    if (availableLayers.length == 0) {\r\n                        errors.push({ key: TC.Consts.WFSErrors.NoValidLayers, params: { serviceTitle: _getServiceTitle(service) } });\r\n                        resolve({ \"errors\": errors });\r\n                        return;\r\n                    }\r\n                    if (capabilities.Operations.GetFeature.CountDefault)\r\n                        _numMaxFeatures = capabilities.Operations.GetFeature.CountDefault.DefaultValue;\r\n                    //comprobamos si soporta querys    \r\n                    if (\r\n                        (capabilities.version === \"1.0.0\" && !capabilities.Operations.GetFeature.Operations.hasOwnProperty(\"Query\"))\r\n                        ||\r\n                        ((capabilities.version === \"2.0.0\" || capabilities.version === \"1.1.0\") && capabilities.Operations.QueryExpressions.AllowedValues.Value.indexOf(\"wfs:Query\") < 0)\r\n                    ) {\r\n                        errors.push({ key: TC.Consts.WFSErrors.QueryNotAvailable, params: { serviceTitle: _getServiceTitle(service) } });\r\n                        resolve({ \"errors\": errors });\r\n                        return;\r\n                    }\r\n                    var url = (capabilities.Operations.GetFeature.DCPType ? capabilities.Operations.GetFeature.DCPType[1].HTTP.Post.onlineResource : capabilities.Operations.GetFeature.DCP.HTTP.Post[\"xlink:href\"]);\r\n\r\n                    // var url2 = service.mapLayers[0].getFeatureUrl(url);\r\n                    service.mapLayers[0].getFeatureUrl(url).then(function (url2) {\r\n                        if (_numMaxFeatures) {\r\n                            jQuery.ajax({\r\n                                url: url2,\r\n                                data: TC.Util.WFSQueryBuilder(availableLayers, filter, capabilities, outputFormat, true),\r\n                                cache: false,\r\n                                contentType: \"application/xml\",\r\n                                type: \"POST\",\r\n                            }).then(function () {\r\n                                if (arguments[0] instanceof XMLDocument) {\r\n                                    var responseAsJSON = xml2json(arguments[0]);\r\n                                    if (responseAsJSON.Exception) {\r\n                                        resolve({\r\n                                            errors: [{\r\n                                                key: TC.Consts.WFSErrors.Indeterminate,\r\n                                                params: {\r\n                                                    err: responseAsJSON.Exception.exceptionCode, errorThrown: responseAsJSON.Exception.ExceptionText, serviceTitle: service.mapLayers.reduce(function (prev, cur) {\r\n                                                        return prev || cur.title;\r\n                                                    }, '')\r\n                                                }\r\n                                            }]\r\n                                        })\r\n                                        return;\r\n                                    }\r\n                                }\r\n                                var featFounds = parseInt(responseAsJSON.numberMatched || responseAsJSON.numberOfFeatures, 10)\r\n                                if (isNaN(featFounds) || featFounds > parseInt(_numMaxFeatures, 10)) {\r\n                                    resolve({\r\n                                        errors: [{\r\n                                            key: TC.Consts.WFSErrors.NumMaxFeatures, params: { limit: _numMaxFeatures, serviceTitle: _getServiceTitle(service) }\r\n                                        }]\r\n                                    });\r\n                                    return;\r\n                                }\r\n                                else if (featFounds === 0) {\r\n                                    resolve({\r\n                                        errors: [{\r\n                                            key: TC.Consts.WFSErrors.NoFeatures, params: { serviceTitle: _getServiceTitle(service) }\r\n                                        }]\r\n                                    });\r\n                                }\r\n                                else if (download) {\r\n                                    resolve({\r\n                                        url: url,\r\n                                        data: TC.Util.WFSQueryBuilder(availableLayers, filter, capabilities, outputFormat, false),\r\n                                        service: service,\r\n                                        numFeatures: featFounds,\r\n                                        errors: errors\r\n                                    });\r\n                                }\r\n\r\n                            }\r\n                                , function (xhr, textStatus, errorThrown) {\r\n                                    resolve({\r\n                                        errors: [{\r\n                                            key: TC.Consts.WFSErrors.Indeterminate,\r\n                                            params: { err: textStatus, errorThrown: errorThrown, serviceTitle: _getServiceTitle(service) }\r\n                                        }]\r\n                                    });\r\n                                    return;\r\n                                });\r\n                        }\r\n                        else {\r\n                            if (!download) {\r\n                                resolve({\r\n                                    url: url2,\r\n                                    data: TC.Util.WFSQueryBuilder(availableLayers, filter, capabilities, outputFormat, false),\r\n                                    service: service,\r\n                                    errors: errors\r\n                                });\r\n                            }\r\n                        }\r\n                        if (download && !_numMaxFeatures) {\r\n                            resolve({\r\n                                url: url,\r\n                                data: TC.Util.WFSQueryBuilder(availableLayers, filter, capabilities, outputFormat, false),\r\n                                service: service,\r\n                                errors: errors\r\n                            });\r\n                        }\r\n                        if (!download) {\r\n                            jQuery.ajax({\r\n                                url: url2,\r\n                                data: TC.Util.WFSQueryBuilder(availableLayers, filter, capabilities, outputFormat, false),\r\n                                cache: false,\r\n                                contentType: \"application/xml\",\r\n                                type: \"POST\",\r\n                            }).then(function () {\r\n                                if (arguments[1] == \"success\") {\r\n                                    if (arguments[0] instanceof XMLDocument) {\r\n                                        var responseAsJSON = xml2json(arguments[0]);\r\n                                        if (responseAsJSON.Exception) {\r\n                                            resolve({\r\n                                                errors: [{\r\n                                                    key: TC.Consts.WFSErrors.Indeterminate,\r\n                                                    params: {\r\n                                                        err: responseAsJSON.Exception.exceptionCode, errorThrown: responseAsJSON.Exception.ExceptionText, serviceTitle: service.mapLayers.reduce(function (prev, cur) {\r\n                                                            return prev || cur.title;\r\n                                                        }, '')\r\n                                                    }\r\n                                                }]\r\n                                            })\r\n                                            return;\r\n                                        }\r\n                                    }\r\n                                    resolve({ service: service, response: arguments, errors: errors });\r\n                                }\r\n                                else {\r\n                                    reject(arguments);\r\n                                    return;\r\n                                }\r\n                            },\r\n                                function (xhr, textStatus, errorThrown) {\r\n                                    resolve({\r\n                                        errors: [{\r\n                                            key: TC.Consts.WFSErrors.Indeterminate,\r\n                                            params: { err: textStatus, errorThrown: errorThrown, serviceTitle: _getServiceTitle(service) }\r\n                                        }]\r\n                                    });\r\n                                    return;\r\n                                });\r\n                        }\r\n                    });\r\n                }, function (jqXHR, textStatus, errorThrown) {\r\n                    var service = null;\r\n                    for (var title in services)\r\n                        if (services[title].request && services[title].request === serviceObj.request) {\r\n                            service = services[title];\r\n                        }\r\n                    resolve({ errors: [{ key: TC.Consts.WFSErrors.GetCapabilities, params: { err: errorThrown, serviceTitle: _getServiceTitle(service) } }] });\r\n                });\r\n            }));\r\n        });\r\n        return arrPromises;\r\n    };\r\n    TC.WFSGetFeatureBuilder = WFSGetFeatureBuilder;\r\n\r\n    var readFeaturesFromResponse = function (map, data, jqXHR) {\r\n        var featureInsertionPoints = [];\r\n        var format;\r\n        var iFormat = jqXHR.getResponseHeader(\"Content-type\");\r\n        if (iFormat && iFormat.indexOf(\";\") > -1)\r\n            iFormat = iFormat.substr(0, iFormat.indexOf(\";\")).trim();\r\n\r\n        if (!iFormat) iFormat = data.requestedFormat;\r\n        switch (iFormat) {\r\n            case 'application/json':\r\n                format = new ol.format.GeoJSON();\r\n                break;\r\n            case 'application/vnd.ogc.gml':\r\n                if (data.responseText.indexOf(\"FeatureCollection\") > -1)\r\n                    format = new ol.format.WFS({\r\n                        gmlFormat: new ol.format.GML2({\r\n                            srsName: map.crs\r\n                        })\r\n                    });\r\n                else\r\n                    format = new ol.format.WMSGetFeatureInfo();\r\n                break;\r\n            case 'application/vnd.ogc.gml/3.1.1':\r\n                format = new ol.format.GML3Patched({\r\n                    srsName: map.crs\r\n                });\r\n                break;\r\n            case \"text/xml\":\r\n            case \"application/xml\":\r\n                //posible error\r\n                var jqXHR = xml2json(data);\r\n                if (jqXHR.ServiceException)\r\n                    TC.error(jqXHR.ServiceException);\r\n                format = null;\r\n                break;\r\n            default:\r\n                format = null;\r\n                break;\r\n        }\r\n        if (format) {\r\n            return format.readFeatures(jqXHR.responseText, {\r\n                featureProjection: ol.proj.get(map.crs)\r\n            });\r\n        }\r\n        else {\r\n            return null;\r\n            ////si no hay formato reconocido y parseable, metemos un iframe con la respuesta\r\n            ////y prau\r\n            ////para eso, creo una falsa entrada de tipo feature, con un campo especial rawUrl o rawContent\r\n            //var l = service.layers[0];\r\n            //l.features.push({\r\n            //    error: response.responseText\r\n            //});\r\n        }\r\n    };\r\n    var featureToServiceDistributor = function (features, service) {\r\n        var featurePromises = [];\r\n        var featureInsertionPoints = [];\r\n        var isParentOrSame = function (layer, na, nb) {\r\n            var result = false;\r\n            if (na === nb || (na.indexOf(nb) === 0)) {\r\n                result = true;\r\n            }\r\n            else {\r\n                var pa = layer.getPath(na);\r\n                var pb = layer.getPath(nb);\r\n                if (pa.length > 0 && pb.length >= pa.length) {\r\n                    result = true;\r\n                    for (var i = 0; i < pa.length; i++) {\r\n                        if (pa[i] !== pb[i]) {\r\n                            result = false;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            return result;\r\n        };\r\n        for (var j = 0; j < features.length; j++) {\r\n            var feature = features[j];\r\n            if (feature instanceof ol.Feature) {\r\n                var fid = feature.getId() || TC.getUID();\r\n                var found = false;\r\n                var layerName = fid.substr(0, fid.lastIndexOf('.'));\r\n                for (var k = 0; k < service.layers.length; k++) {\r\n                    var l = service.layers[k];\r\n                    var lName = l.name.substr(l.name.indexOf(':') + 1);\r\n                    if (service.mapLayers.some(function (mapLayer) { return isParentOrSame(mapLayer, lName, layerName) })) {\r\n                        found = true;\r\n                        featurePromises.push(TC.wrap.Feature.createFeature(feature));\r\n\r\n                        featureInsertionPoints[feature.id_] = (l.features);\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                //si llegamos aqu\\u00ed y no he encontrado su layer, es que no cuadraba el prefijo del fid con el id del layer\r\n                //esto pasa, p.ej, en cartociudad\r\n                if (!found) {\r\n                    //as\\u00ed que creo un layer de palo para la respuesta del featInfo\r\n                    var fakeLayer;\r\n                    if (fakeLayers[layerName]) fakeLayer = fakeLayers[layerName];\r\n                    else {\r\n                        fakeLayer = {\r\n                            name: layerName, title: layerName, features: []\r\n                        };\r\n                        fakeLayers[layerName] = fakeLayer;\r\n                        service.layers.push(fakeLayer);\r\n                    }\r\n\r\n                    if (!opts.featureId || feature.getId() === opts.featureId) { // Mirar si en las opciones pone que solo busque una feature\r\n                        featurePromises.push(TC.wrap.Feature.createFeature(feature));\r\n                        featureInsertionPoints.push(fakeLayer.features);\r\n                    }\r\n                }\r\n            }\r\n        }//iteraci\\u00f3n sobre las features de esta respuesta\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            Promise.all(featurePromises).then(function (features) {\r\n                features.forEach(function (feat) {\r\n                    feat.attributes = [];\r\n                    //feat.showsPopup = false;\r\n                    for (var key in feat.data) {\r\n                        var value = feat.data[key];\r\n                        if (typeof value !== 'object') {\r\n                            feat.attributes.push({\r\n                                name: key, value: value\r\n                            });\r\n                        }\r\n                    }\r\n                    featureInsertionPoints[feat.id].push(feat);\r\n                });\r\n                resolve({\r\n                    service: service\r\n                })\r\n            });\r\n        });\r\n    }\r\n\r\n    TC.wrap.control.GeometryFeatureInfo.prototype.getFeaturesByGeometry = function (feature, xy) {\r\n\r\n        var self = this;\r\n        var map = self.parent.map;\r\n        self.parent.filterFeature = feature;\r\n        feature.layer = self.parent.filterLayer;\r\n\r\n        map.wrap.getMap().then(function (olMap) {\r\n\r\n            var olGeometry = feature.wrap.feature.getGeometry();\r\n            var stride = olGeometry.stride;\r\n            var flatCoordinates = olGeometry.getFlatCoordinates();\r\n            //calcular el punto mas alto\r\n            if (!xy) {\r\n                var bestPoint = null;\r\n                for (var i = 1, len = flatCoordinates.length; i < len; i += stride) {\r\n                    if (!bestPoint || bestPoint[1] < flatCoordinates[i]) {\r\n                        bestPoint = [flatCoordinates[i - 1], flatCoordinates[i]];\r\n                    }\r\n                }\r\n                xy = olMap.getPixelFromCoordinate(new ol.geom.Point(bestPoint).getCoordinates());\r\n            }\r\n\r\n            self.parent.beforeRequest({ xy: xy });\r\n\r\n            var arrRequests = WFSGetFeatureBuilder(map, new TC.filter.intersects(feature, map.crs !== map.options.crs ? map.crs : undefined), \"JSON\");\r\n\r\n            const arrPromises = [];\r\n            Promise.all(arrRequests).then(function (responses) {\r\n                var targetServices = [];\r\n                var featureCount = 0;\r\n                var hayError = false;\r\n\r\n                for (var i = 0; i < responses.length; i++) {\r\n                    const responseObj = responses[i];\r\n                    if (!responseObj) continue;\r\n                    arrPromises[arrPromises.length] = new Promise(function (resolve, reject) {\r\n                        if (responseObj.errors && responseObj.errors.length) {\r\n                            for (var j = 0; j < responseObj.errors.length; j++) {\r\n                                var errorMsg, errorType = TC.Consts.msgType.WARNING;\r\n                                hayError = true;\r\n                                var error = responseObj.errors[j];\r\n                                switch (error.key) {\r\n                                    case TC.Consts.WFSErrors.NumMaxFeatures:\r\n                                        errorMsg = self.parent.getLocaleString(\"wfs.tooManyFeatures\", error.params);\r\n                                        break;\r\n                                        /*case TC.Consts.WFSErrors.NoLayers:\r\n                                            errorMsg = self.parent.getLocaleString('noLayersLoaded');*/\r\n                                        break;\r\n                                    case TC.Consts.WFSErrors.GetCapabilities:\r\n                                        errorMsg = self.parent.getLocaleString('wfsGFI.inValidService', error.params);\r\n                                        break;\r\n                                    case TC.Consts.WFSErrors.NoFeatures:\r\n                                        //si no hay features nos callamos. Quizas en un futuro se muestre una alerta\r\n                                        hayError = false;\r\n                                        continue;\r\n                                        break;\r\n                                    case TC.Consts.WFSErrors.Indeterminate:\r\n                                        errorMsg = self.parent.getLocaleString(\"wfs.IndeterminateError\");\r\n                                        TC.error(\"Error:{error} \\r\\n Descripcion:{descripcion} \\r\\n Servicio:{serviceName}\".format({ error: error.params.err, descripcion: error.params.errorThrown, serviceName: error.params.serviceTitle }), TC.Consts.msgErrorMode.CONSOLE);\r\n                                        errorType = TC.Consts.msgType.ERROR;\r\n                                        break;\r\n                                    default:\r\n                                        errorMsg = self.parent.getLocaleString(\"wfsGFI.\" + error.key, error.params);\r\n                                        break;\r\n                                }\r\n\r\n                                map.toast(errorMsg, { type: errorType });\r\n                            }\r\n                            if (!responseObj.response) {\r\n                                resolve();\r\n                            }\r\n                        }\r\n                    });\r\n\r\n                    // Puede no haber response porque la URL no es correcta, metemos un condicional\r\n                    var featuresFound = responses[i].response ? readFeaturesFromResponse(map, responses[i].response[0], responses[i].response[2]) : [];\r\n                    //ahora se distribuye la features por servicio y capa\r\n                    arrPromises[arrPromises.length - 1] = featureToServiceDistributor(featuresFound, responses[i].service);\r\n                    targetServices.push(responses[i].service);\r\n                    featureCount = featureCount + featuresFound.length;\r\n                }\r\n                Promise.all(arrPromises).then(function () {\r\n                    self.parent.responseCallback({\r\n                        xy: xy || null, services: targetServices, featureCount: featureCount\r\n                    });\r\n                });\r\n            }, function (e) {\r\n                self.parent.responseCallback({});\r\n            })\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Popup.prototype = function () {\r\n        this.popup = null;\r\n    };\r\n\r\n    TC.Consts.event.PANANIMATIONSTART = 'pananimationstart.tc';\r\n    TC.Consts.event.PANANIMATIONEND = 'pananimationend.tc';\r\n    TC.wrap.control.Popup.prototype.fitToView = function () {\r\n        var self = this;\r\n        var map = self.parent.map;\r\n        var olMap = self.parent.map.wrap.map;\r\n\r\n        var popupBoundingRect = self.parent.popupDiv.getBoundingClientRect();\r\n        var mapBoundingRect = map.div.getBoundingClientRect();\r\n\r\n        var topLeft = olMap.getCoordinateFromPixel([popupBoundingRect.left - mapBoundingRect.left, popupBoundingRect.top - mapBoundingRect.top]);\r\n        var bottomRight = olMap.getCoordinateFromPixel([popupBoundingRect.right - mapBoundingRect.left, popupBoundingRect.bottom - mapBoundingRect.top]);\r\n        var west = topLeft[0];\r\n        var north = topLeft[1];\r\n        var east = bottomRight[0];\r\n        var south = bottomRight[1];\r\n\r\n        var popupExt = [west, south, east, north];\r\n        var mapExt = map.getExtent();\r\n\r\n        if (!ol.extent.containsExtent(mapExt, popupExt)) {\r\n            var overflows = {\r\n                left: Math.max(mapExt[0] - popupExt[0], 0),\r\n                bottom: Math.max(mapExt[1] - popupExt[1], 0),\r\n                right: Math.max(popupExt[2] - mapExt[2], 0),\r\n                top: Math.max(popupExt[3] - mapExt[3], 0)\r\n            };\r\n\r\n            if (self.parent.dragged) {\r\n                // Movemos el popup\r\n                var newPos = self.popup.getPosition();\r\n                if (overflows.right) {\r\n                    newPos[0] = newPos[0] - overflows.right;\r\n                }\r\n                else if (overflows.left) {\r\n                    newPos[0] = newPos[0] + overflows.left;\r\n                }\r\n                if (overflows.top) {\r\n                    newPos[1] = newPos[1] - overflows.top;\r\n                }\r\n                else if (overflows.bottom) {\r\n                    newPos[1] = newPos[1] + overflows.bottom;\r\n                }\r\n                var newPixelPos = olMap.getPixelFromCoordinate(newPos);\r\n                newPixelPos[1] = olMap.getSize()[1] - newPixelPos[1];\r\n                self.parent._previousContainerPosition = newPixelPos;\r\n                self.popup._oldUpdatePixelPosition(newPos);\r\n            }\r\n            else {\r\n                if (self.parent.isVisible()) {\r\n                    // Movemos el mapa\r\n                    var view = olMap.getView();\r\n                    var ct = view.getCenter().slice();\r\n\r\n                    if (overflows.top) ct[1] += overflows.top;\r\n                    else if (overflows.bottom) ct[1] -= overflows.bottom;\r\n                    if (overflows.right) ct[0] += overflows.right;\r\n                    else if (overflows.left) ct[0] -= overflows.left;\r\n\r\n                    view.animate({\r\n                        center: ct, easing: function (percent) {\r\n                            if (percent === 0) self.parent.map.trigger(TC.Consts.event.PANANIMATIONSTART);\r\n                            if (percent === 1) self.parent.map.trigger(TC.Consts.event.PANANIMATIONEND);\r\n                            return percent;\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Popup.prototype.setDragged = function (dragged) {\r\n        var popup = this.popup;\r\n        //var view = popup.getMap().getView();\r\n        //var onViewChange = function () {\r\n        //    console.log(this.getCenter());\r\n        //};\r\n        if (dragged) {\r\n            // Parcheamos funciones para que el popup no se mueva cuando cambiamos el extent del mapa\r\n            if (!popup._oldUpdatePixelPosition) {\r\n                popup._oldUpdatePixelPosition = popup.updatePixelPosition;\r\n                popup.updatePixelPosition = function () {\r\n                };\r\n            }\r\n            if (!popup._newHandleOffsetChanged) {\r\n                popup._newHandleOffsetChanged = function () {\r\n                    this._oldUpdatePixelPosition();\r\n                };\r\n                ol.events.unlisten(\r\n                    popup, ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),\r\n                    popup.handleOffsetChanged, popup);\r\n                ol.events.listen(\r\n                    popup, ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),\r\n                    popup._newHandleOffsetChanged, popup);\r\n            }\r\n            //view.on(['change:center','change:resolution'], onViewChange);\r\n        }\r\n        else {\r\n            // Redefinimos las propiedades de posicionamiento porque al arrastrarlo, las hemos modificado.\r\n            const containerStyle = popup.getElement().parentElement.style;\r\n            containerStyle.setProperty('top', popup.rendered.top_);\r\n            containerStyle.setProperty('bottom', popup.rendered.bottom_);\r\n            containerStyle.setProperty('left', popup.rendered.left_);\r\n            containerStyle.setProperty('right', popup.rendered.right_);\r\n\r\n            delete this.parent._previousContainerPosition;\r\n            // Deshacemos parcheo\r\n            if (popup._oldUpdatePixelPosition) {\r\n                popup.updatePixelPosition = popup._oldUpdatePixelPosition;\r\n                delete popup._oldUpdatePixelPosition;\r\n            }\r\n            if (popup._newHandleOffsetChanged) {\r\n                ol.events.unlisten(\r\n                    popup, ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),\r\n                    popup._newHandleOffsetChanged, popup);\r\n                ol.events.listen(\r\n                    popup, ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),\r\n                    popup.handleOffsetChanged, popup);\r\n                delete popup._newHandleOffsetChanged;\r\n            }\r\n            //view.un(['change:center', 'change:resolution'], onViewChange);\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getLegend = function () {\r\n        var self = this;\r\n        var result = {\r\n        };\r\n        var style = getNativeStyle(self.feature);\r\n        if (style) {\r\n            var image = style.getImage();\r\n            if (image) {\r\n                if (image instanceof ol.style.Icon) {\r\n                    result.src = image.getSrc();\r\n                    var scale = image.getScale();\r\n                    if (scale) {\r\n                        result.scale = scale;\r\n                        var img = image.getImage();\r\n                        if (img.width) {\r\n                            result.width = img.width * scale;\r\n                            result.height = img.height * scale;\r\n                        }\r\n                    }\r\n                }\r\n                else if (image instanceof ol.style.Circle) {\r\n                    result.src = image.canvas_.toDataURL();\r\n                }\r\n                if (self.parent.options.radius) {\r\n                    result.height = result.width = self.parent.options.radius * 2;\r\n                }\r\n                else {\r\n                    result.width = result.width || self.parent.options.width;\r\n                    result.height = result.height || self.parent.options.height;\r\n                }\r\n            }\r\n            else {\r\n                // No image, find stroke and fill\r\n                var stroke = style.getStroke();\r\n                var fill = style.getFill();\r\n                if (stroke) {\r\n                    var strokeColor = stroke.getColor();\r\n                    if (strokeColor) {\r\n                        result.strokeColor = ol.color.asString(strokeColor);\r\n                    }\r\n                    var strokeWidth = stroke.getWidth();\r\n                    if (strokeWidth) {\r\n                        result.strokeWidth = strokeWidth;\r\n                    }\r\n                }\r\n                if (fill) {\r\n                    var fillColor = fill.getColor();\r\n                    if (fillColor) {\r\n                        result.fillColor = ol.color.asString(fillColor);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    var createNativeFeature = function (coords, geometryConstructor, geometryName) {\r\n        var result;\r\n        var featureOptions = {};\r\n        var gn = geometryName || 'geometry';\r\n        featureOptions[gn] = new geometryConstructor(coords);\r\n        result = new ol.Feature(featureOptions);\r\n        if (geometryName) {\r\n            result.setGeometryName(geometryName);\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createPoint = function (coords, options) {\r\n        var self = this;\r\n\r\n        if ($.isArray(coords)) {\r\n            self.feature = createNativeFeature(coords, ol.geom.Point, options.geometryName);\r\n        }\r\n        else if (self.isNative(coords)) {\r\n            self.feature = coords;\r\n            self.parent.geometry = coords.getGeometry().getCoordinates();\r\n        }\r\n        self.feature._wrap = self;\r\n        self.feature.setStyle(createNativeStyle({ styles: { point: options } }, self.feature));\r\n        self.setData(self.parent.data);\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createMarker = function (coords, options) {\r\n        var self = this;\r\n\r\n        var iconUrl = TC.Util.getPointIconUrl(options);\r\n        if (iconUrl) {\r\n            options.url = iconUrl;\r\n            if ($.isArray(coords)) {\r\n                self.feature = createNativeFeature(coords, ol.geom.Point, options.geometryName);\r\n            }\r\n            else if (self.isNative(coords)) {\r\n                self.feature = coords;\r\n                self.parent.geometry = coords.getGeometry().getCoordinates();\r\n            }\r\n            self.feature._wrap = self;\r\n            self.feature.setStyle(createNativeStyle({ styles: { marker: options } }, self.feature));\r\n            self.setData(self.parent.data);\r\n        }\r\n        else {\r\n            self.createPoint(coords, options);\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createPolyline = function (coords, options) {\r\n        var self = this;\r\n\r\n        if ($.isArray(coords)) {\r\n            self.feature = createNativeFeature(coords, ol.geom.LineString, options.geometryName);\r\n        }\r\n        else if (self.isNative(coords)) {\r\n            self.feature = coords;\r\n            self.parent.geometry = coords.getGeometry().getCoordinates();\r\n        }\r\n        self.feature._wrap = self;\r\n        if (options) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { line: options } }, self.feature));\r\n        }\r\n        self.setData(self.parent.data);\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createPolygon = function (coords, options) {\r\n        var self = this;\r\n\r\n        if ($.isArray(coords)) {\r\n            if (coords.length) {\r\n                var ringCoords = coords[0];\r\n                if ($.isArray(ringCoords) && ringCoords.length) {\r\n                    var pointCoord = ringCoords[0];\r\n                    if (!$.isArray(pointCoord)) {\r\n                        // anillo solo, lo metemos dentro de un array de anillos\r\n                        coords = [coords];\r\n                    }\r\n                    for (var i = 0; i < coords.length; i++) {\r\n                        ringCoords = coords[i];\r\n                        var startPoint = ringCoords[0];\r\n                        var endPoint = ringCoords[ringCoords.length - 1];\r\n                        if (startPoint[0] !== endPoint[0] || startPoint[1] !== endPoint[1]) {\r\n                            ringCoords[ringCoords.length] = startPoint;\r\n                        }\r\n                        self.parent.geometry = coords;\r\n                        self.feature = createNativeFeature(coords, ol.geom.MultiLineString, options.geometryName);\r\n                    }\r\n                    self.parent.geometry = coords;\r\n                    self.feature = createNativeFeature(coords, ol.geom.Polygon, options.geometryName);\r\n                }\r\n            }\r\n        }\r\n        else if (self.isNative(coords)) {\r\n            self.feature = coords;\r\n            self.parent.geometry = coords.getGeometry().getCoordinates();\r\n        }\r\n        self.feature._wrap = self;\r\n        var opts = options || {};\r\n        if (opts.strokeColor || opts.strokeWidth || opts.fillColor || opts.fillOpacity) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { polygon: opts } }, self.feature));\r\n        }\r\n        self.setData(self.parent.data);\r\n    };\r\n\r\n\r\n    TC.wrap.Feature.prototype.createMultiPolyline = function (coords, options) {\r\n        var self = this;\r\n\r\n        if ($.isArray(coords)) {\r\n            if (coords.length) {\r\n                var plnCoords = coords[0];\r\n                if ($.isArray(plnCoords) && plnCoords.length) {\r\n                    var pointCoord = plnCoords[0];\r\n                    if (!$.isArray(pointCoord)) {\r\n                        // polilínea sola, la metemos dentro de un array de polilíneas\r\n                        coords = [coords];\r\n                    }\r\n                    self.parent.geometry = coords;\r\n                    self.feature = createNativeFeature(coords, ol.geom.MultiLineString, options.geometryName);\r\n                }\r\n            }\r\n        }\r\n        else if (self.isNative(coords)) {\r\n            self.feature = coords;\r\n            self.parent.geometry = coords.getGeometry().getCoordinates();\r\n        }\r\n        self.feature._wrap = self;\r\n        if (options) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { line: options } }, self.feature));\r\n        }\r\n        self.setData(self.parent.data);\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createMultiPolygon = function (coords, options) {\r\n        var self = this;\r\n\r\n        if ($.isArray(coords)) {\r\n            if (coords.length) {\r\n                var pgnCoords = coords[0];\r\n                if ($.isArray(pgnCoords) && pgnCoords.length) {\r\n                    var ringCoords = pgnCoords[0];\r\n                    if ($.isArray(ringCoords) && ringCoords.length) {\r\n                        var pointCoord = ringCoords[0];\r\n                        if (!$.isArray(pointCoord)) {\r\n                            // polígono solo, lo metemos dentro de un array de polígonos\r\n                            coords = [coords];\r\n                        }\r\n                    }\r\n                    else {\r\n                        // anillo solo, lo metemos de un array de anillos y este en un array de polígonos\r\n                        coords = [[coords]];\r\n                    }\r\n                    // Close rings\r\n                    for (var i = 0, ii = coords.length; i < ii; i++) {\r\n                        pgnCoords = coords[i];\r\n                        for (var j = 0, jj = pgnCoords.length; j < jj; j++) {\r\n                            ringCoords = pgnCoords[j];\r\n                            var startPoint = ringCoords[0];\r\n                            var endPoint = ringCoords[ringCoords.length - 1];\r\n                            if (startPoint[0] !== endPoint[0] || startPoint[1] !== endPoint[1]) {\r\n                                ringCoords[ringCoords.length] = startPoint;\r\n                            }\r\n                        }\r\n                    }\r\n                    self.parent.geometry = coords;\r\n                    self.feature = createNativeFeature(coords, ol.geom.MultiPolygon, options.geometryName);\r\n                }\r\n            }\r\n        }\r\n        else if (self.isNative(coords)) {\r\n            self.feature = coords;\r\n            self.parent.geometry = coords.getGeometry().getCoordinates();\r\n        }\r\n        self.feature._wrap = self;\r\n        var opts = options || {};\r\n        if (opts.strokeColor || opts.strokeWidth || opts.fillColor || opts.fillOpacity) {\r\n            self.feature.setStyle(createNativeStyle({ styles: { polygon: opts } }, self.feature));\r\n        }\r\n        self.setData(self.parent.data);\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.createCircle = function (coords, options) {\r\n        var self = this;\r\n\r\n        if ($.isArray(coords) &&\r\n            $.isArray(coords[0])\r\n            && typeof coords[0][0] === 'number' && typeof coords[0][1] === 'number'\r\n            && typeof coords[1] === 'number') {\r\n\r\n            var featureOptions = {};\r\n            var geometryName = options.geometryName || 'geometry';\r\n            featureOptions[geometryName] = new ol.geom.Circle(coords[0], coords[1]);\r\n            self.feature = new ol.Feature(featureOptions);\r\n            if (options.geometryName) {\r\n                self.feature.setGeometryName(options.geometryName);\r\n            }\r\n        }\r\n        else if (self.isNative(coords)) {\r\n            self.feature = coords;\r\n            var nativeGeometry = coords.getGeometry();\r\n            self.parent.geometry = [nativeGeometry.getCenter(), nativeGeometry.getRadius()];\r\n        }\r\n        self.feature._wrap = self;\r\n        if (options) {\r\n            self.feature.setStyle(\r\n                new ol.style.Style({\r\n                    stroke: new ol.style.Stroke({\r\n                        color: options.strokeColor,\r\n                        width: options.strokeWidth,\r\n                        lineDash: options.lineDash\r\n                    }),\r\n                    fill: new ol.style.Fill({\r\n                        color: getRGBA(options.fillColor, options.fillOpacity)\r\n                    })\r\n                })\r\n            );\r\n        }\r\n        self.setData(self.parent.data);\r\n    };\r\n\r\n    TC.wrap.Feature.createFeature = function (olFeat, options) {\r\n        return new Promise(function (resolve, reject) {\r\n            var olGeometry = olFeat.getGeometry();\r\n            options = options || {};\r\n            options.id = olFeat.getId();\r\n\r\n            // geometría\r\n            var geomStr;\r\n            switch (true) {\r\n                case olGeometry instanceof ol.geom.Point:\r\n                    var olStyle = olFeat.getStyle();\r\n                    if ($.isFunction(olStyle)) {\r\n                        olStyle = olStyle.call(olFeat);\r\n                    }\r\n                    var olStyles = olStyle ? ($.isArray(olStyle) ? olStyle : [olStyle]) : [];\r\n                    for (var i = 0, len = olStyles.length; i < len; i++) {\r\n                        olStyle = olStyles[i];\r\n                        if (olStyle.getImage() instanceof ol.style.Icon) {\r\n                            geomStr = 'Marker';\r\n                            break;\r\n                        }\r\n                    }\r\n                    geomStr = geomStr || 'Point';\r\n                    break;\r\n                case olGeometry instanceof ol.geom.LineString:\r\n                    geomStr = 'Polyline';\r\n                    break;\r\n                case olGeometry instanceof ol.geom.Polygon:\r\n                    geomStr = 'Polygon';\r\n                    break;\r\n                case olGeometry instanceof ol.geom.MultiLineString:\r\n                    geomStr = 'MultiPolyline';\r\n                    break;\r\n                case olGeometry instanceof ol.geom.MultiPolygon:\r\n                    geomStr = 'MultiPolygon';\r\n                    break;\r\n                default:\r\n                    break;\r\n            }\r\n            if (geomStr) {\r\n                TC.loadJS(\r\n                    !TC.feature || (TC.feature && !TC.feature[geomStr]),\r\n                    [TC.apiLocation + 'TC/feature/' + geomStr],\r\n                    function () {\r\n                        var feat = new TC.feature[geomStr](olFeat, options);\r\n                        feat.data = feat.wrap.getData();\r\n                        resolve(feat);\r\n                    }\r\n                );\r\n            }\r\n            else {\r\n                TC.loadJS(\r\n                    !TC.Feature,\r\n                    [TC.apiLocation + 'TC/Feature'],\r\n                    function () {\r\n                        var feat = new TC.Feature(olFeat, options);\r\n                        feat.data = feat.wrap.getData();\r\n                        resolve(feat);\r\n                    }\r\n                );\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.cloneFeature = function () {\r\n        return this.feature.clone();\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getStyle = function () {\r\n        var self = this;\r\n        var result = {};\r\n        var olStyle = self.feature.getStyle();\r\n        if ($.isFunction(olStyle)) {\r\n            olStyle = olStyle.call(self.feature);\r\n        }\r\n        var olStyles = olStyle ? ($.isArray(olStyle) ? olStyle : [olStyle]) : [];\r\n\r\n        const getFill = function (style, obj) {\r\n            if (style) {\r\n                const fill = style.getFill();\r\n                if (fill) {\r\n                    obj.fillColor = fill.getColor();\r\n                    if ($.isArray(obj.fillColor)) {\r\n                        obj.fillOpacity = obj.fillColor[3];\r\n                    }\r\n                }\r\n            }\r\n        };\r\n        const getStroke = function (style, obj) {\r\n            if (style) {\r\n                const stroke = style.getStroke();\r\n                if (stroke) {\r\n                    obj.strokeColor = stroke.getColor();\r\n                    obj.strokeWidth = stroke.getWidth();\r\n                }\r\n            }\r\n        };\r\n\r\n        for (var i = 0, len = olStyles.length; i < len; i++) {\r\n            olStyle = olStyles[i];\r\n            getFill(olStyle, result);\r\n            getStroke(olStyle, result);\r\n            const image = olStyle.getImage();\r\n            if (image instanceof ol.style.Icon) {\r\n                result.url = image.getSrc();\r\n                const size = image.getSize();\r\n                const scale = image.getScale() || 1;\r\n                if (size) {\r\n                    result.width = size[0] * scale;\r\n                    result.height = size[1] * scale;\r\n                }\r\n                var anchor = image.getAnchor();\r\n                if (anchor) {\r\n                    result.anchor = [anchor[0] * scale, anchor[1] * scale];\r\n                    if (size) {\r\n                        // getAnchor devuelve los valores en pixels, hay que transformar a fracción\r\n                        result.anchor[0] = result.anchor[0] / result.width;\r\n                        result.anchor[1] = result.anchor[1] / result.height;\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                getFill(image, result);\r\n                getStroke(image, result);\r\n            }\r\n            var text = olStyle.getText();\r\n            if (text) {\r\n                result.label = text.getText();\r\n                var font = text.getFont();\r\n                if (font) {\r\n                    // A 96dpi 3pt = 4px\r\n                    result.fontSize = parseInt(font.match(/\\d+pt/)) || parseInt(font.match(/\\d+px/)) * 0.75;\r\n                }\r\n                var rotation = text.getRotation();\r\n                if (rotation) {\r\n                    result.angle = -180 * rotation / Math.PI;\r\n                }\r\n                result.labelOffset = [text.getOffsetX(), text.getOffsetY()];\r\n                fill = text.getFill();\r\n                if (fill) {\r\n                    result.fontColor = fill.getColor();\r\n                }\r\n                stroke = text.getStroke();\r\n                if (stroke) {\r\n                    result.labelOutlineColor = stroke.getColor();\r\n                    result.labelOutlineWidth = stroke.getWidth();\r\n                }\r\n            }\r\n        }\r\n        $.extend(self.parent.options, result);\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getGeometry = function () {\r\n        var result;\r\n        var self = this;\r\n        if (self.feature && self.feature.getGeometry) {\r\n            var geom = self.feature.getGeometry();\r\n            if (geom) {\r\n                if (geom.getCoordinates) {\r\n                    result = geom.getCoordinates();\r\n                }\r\n                else if (geom instanceof ol.geom.Circle) {\r\n                    result = [geom.getCenter(), geom.getRadius()];\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.setGeometry = function (geometry) {\r\n        var result = false;\r\n        var self = this;\r\n        if (self.feature && self.feature.getGeometry) {\r\n            var geom = self.feature.getGeometry();\r\n            var point,\r\n                points,\r\n                ringsOrPolylines,\r\n                polygons,\r\n                isMultiPolygon,\r\n                isPolygonOrLineString,\r\n                isLineString;\r\n            // punto: array de números\r\n            // línea o anillo: array de puntos\r\n            // multilínea o polígono: array de líneas o anillos\r\n            // multipolígono: array de polígonos\r\n            // Por tanto podemos recorrer los tipos en un switch sin breaks\r\n            switch (true) {\r\n                case (geom instanceof ol.geom.MultiPolygon):\r\n                    isMultiPolygon = true;\r\n                    polygons = geometry;\r\n                    if ($.isArray(polygons)) {\r\n                        ringsOrPolylines = geometry[0];\r\n                    }\r\n                case (geom instanceof ol.geom.Polygon || geom instanceof ol.geom.MultiLineString):\r\n                    isPolygonOrLineString = true;\r\n                    ringsOrPolylines = isMultiPolygon ? ringsOrPolylines : geometry;\r\n                    if ($.isArray(ringsOrPolylines)) {\r\n                        points = ringsOrPolylines[0];\r\n                    }\r\n                case (geom instanceof ol.geom.LineString):\r\n                    isLineString = true;\r\n                    points = isPolygonOrLineString ? points : geometry;\r\n                    if ($.isArray(points)) {\r\n                        point = points[0];\r\n                    }\r\n                case (geom instanceof ol.geom.Point):\r\n                    point = isLineString ? point : geometry;\r\n                    if ($.isArray(point) && typeof point[0] === 'number' && typeof point[1] === 'number') {\r\n                        var layout;\r\n                        switch (point.length) {\r\n                            case 3:\r\n                                layout = ol.geom.GeometryLayout.XYZ;\r\n                                break;\r\n                            case 4:\r\n                                layout = ol.geom.GeometryLayout.XYZM;\r\n                                break;\r\n                            default:\r\n                                layout = ol.geom.GeometryLayout.XY;\r\n                                break;\r\n                        }\r\n                        geom.setCoordinates(geometry, layout);\r\n                        result = true;\r\n                    }\r\n                    break;\r\n                case (geom instanceof ol.geom.Circle):\r\n                    if ($.isArray(geometry) &&\r\n                        $.isArray(geometry[0])\r\n                        && typeof geometry[0][0] === 'number' && typeof geometry[0][1] === 'number'\r\n                        && typeof geometry[1] === 'number') {\r\n                        geom.setCenterAndRadius(geometry[0], geometry[1]);\r\n                        result = true;\r\n                    }\r\n                    break;\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getId = function () {\r\n        var result;\r\n        var self = this;\r\n        if (self.feature) {\r\n            result = self.feature.getId();\r\n        };\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.setId = function (id) {\r\n        var self = this;\r\n        if (self.feature) {\r\n            self.feature.setId(id);\r\n        };\r\n    };\r\n\r\n    const getPolygonLength = function (polygon, options) {\r\n        const self = this;\r\n        var result = 0;\r\n        polygon.getLinearRings().forEach(function (ring) {\r\n            coordinates = ring.getCoordinates();\r\n            if (options.crs) {\r\n                coordinates = TC.Util.reproject(coordinates, self.parent.layer.map.crs, options.crs);\r\n            }\r\n            const polygon = new ol.geom.Polygon([coordinates]);\r\n            const newRing = polygon.getLinearRing(0);\r\n            result = result + ol.geom.flat.length.linearRing(newRing.flatCoordinates, 0, newRing.flatCoordinates.length, newRing.stride);\r\n        });\r\n        return result;\r\n    };\r\n\r\n    const getLineStringLength = function (lineString, options) {\r\n        const self = this;\r\n        coordinates = lineString.getCoordinates();\r\n        if (options.crs) {\r\n            coordinates = TC.Util.reproject(coordinates, self.parent.layer.map.crs, options.crs);\r\n        }\r\n        const line = new ol.geom.LineString(coordinates);\r\n        return line.getLength();\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getLength = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        var result = 0;\r\n\r\n        const geom = self.feature.getGeometry();\r\n        var coordinates;\r\n        switch (true) {\r\n            case geom instanceof ol.geom.Polygon:\r\n                result = getPolygonLength.call(self, geom, options);\r\n                break;\r\n            case geom instanceof ol.geom.LineString:\r\n                result = getLineStringLength.call(self, geom, options);\r\n                break;\r\n            case geom instanceof ol.geom.MultiPolygon:\r\n                geom.getPolygons().forEach(function (polygon) {\r\n                    result = result + getPolygonLength.call(self, polygon, options);\r\n                });\r\n                break;\r\n            case geom instanceof ol.geom.MultiPolygon:\r\n                geom.getLineStrings().forEach(function (lineString) {\r\n                    result = result + getLineStringLength.call(self, lineString, options);\r\n                });\r\n                break;\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getArea = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n\r\n        const geom = self.feature.getGeometry();\r\n        var coordinates;\r\n        if (geom instanceof ol.geom.Polygon) {\r\n            coordinates = geom.getLinearRing(0).getCoordinates();\r\n            if (options.crs) {\r\n                coordinates = TC.Util.reproject(coordinates, self.parent.layer.map.crs, options.crs);\r\n            }\r\n            const polygon = new ol.geom.Polygon([coordinates]);\r\n            return polygon.getArea();\r\n        }\r\n    };\r\n\r\n    const getFeatureStyle = function (readonly) {\r\n        var style = this.getStyle();\r\n        if ($.isFunction(style)) {\r\n            style = style.call(this);\r\n        }\r\n        if ($.isArray(style)) {\r\n            style = style[style.length - 1];\r\n        }\r\n        if (!style && !readonly) {\r\n            style = new ol.style.Style();\r\n            this.setStyle(style);\r\n        }\r\n        return style;\r\n    };\r\n\r\n    const getLayerStyle = function (feature) {\r\n        var style = this.getStyle();\r\n        if ($.isFunction(style)) {\r\n            style = style(feature);\r\n        }\r\n        if ($.isArray(style)) {\r\n            style = style[style.length - 1];\r\n        }\r\n        if (!style) {\r\n            style = new ol.style.Style();\r\n        }\r\n        return style;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.setStyle = function (options) {\r\n        const self = this;\r\n        const olFeat = self.feature;\r\n        if (options === null) {\r\n            olFeat.setStyle(null);\r\n            return;\r\n        }\r\n        const feature = self.parent;\r\n        const geom = olFeat.getGeometry();\r\n        var style = getFeatureStyle.call(olFeat);\r\n        var layerStyle;\r\n        if (feature.layer) {\r\n            layerStyle = getLayerStyle.call(feature.layer.wrap.layer, feature.wrap.feature);\r\n        }\r\n        if (geom instanceof ol.geom.Point || geom instanceof ol.geom.MultiPoint) {\r\n\r\n            var imageStyle;\r\n            if (options.anchor || options.url || options.cssClass) { // Marcador\r\n                imageStyle = style.getImage();\r\n                const iconOptions = {};\r\n                if (imageStyle instanceof ol.style.Icon) {\r\n                    iconOptions.src = options.url || TC.Util.getBackgroundUrlFromCss(options.cssClass) || imageStyle.getSrc();\r\n\r\n                    if (options.width && options.height) {\r\n                        iconOptions.size = [getStyleValue(options.width, feature), getStyleValue(options.height, feature)];\r\n                    }\r\n                    else {\r\n                        iconOptions.size = imageStyle.getSize();\r\n                    }\r\n                    iconOptions.anchor = getStyleValue(options.anchor, feature) || imageStyle.getAnchor().map(function (elm, idx) {\r\n                        return elm / iconOptions.size[idx];\r\n                    });\r\n                }\r\n                else {\r\n                    iconOptions.src = TC.Util.getPointIconUrl(options);\r\n                    iconOptions.anchor = getStyleValue(options.anchor, feature);\r\n                    iconOptions.size = [getStyleValue(options.width, feature), getStyleValue(options.height, feature)];\r\n                };\r\n                if (options.angle) {\r\n                    iconOptions.angle = options.angle;\r\n                }\r\n\r\n                imageStyle = new ol.style.Icon(iconOptions);\r\n            }\r\n            else if (!(style.getImage()) && style.getText()) { // Etiqueta\r\n\r\n                if (options.label !== undefined) {\r\n                    style = getFeatureStyle.call(olFeat);\r\n                    if (options.label.length) {\r\n                        style.setText(createNativeTextStyle(options, feature));\r\n                    }\r\n                    else {\r\n                        style.setText();\r\n                    }\r\n                } else {\r\n                    style.setText();\r\n                }\r\n            }\r\n            else { // Punto sin icono\r\n                imageStyle = style.getImage();\r\n                if (!imageStyle) {\r\n                    imageStyle = new ol.style.Circle();\r\n                }\r\n                const circleOptions = {\r\n                    radius: getStyleValue(options.radius, feature) ||\r\n                    (getStyleValue(options.height, feature) + getStyleValue(options.width, feature)) / 4\r\n                };\r\n                if (isNaN(circleOptions.radius)) {\r\n                    circleOptions.radius = imageStyle.getRadius();\r\n                }\r\n                if (options.fillColor) {\r\n                    circleOptions.fill = new ol.style.Fill({\r\n                        color: getRGBA(getStyleValue(options.fillColor, feature), getStyleValue(options.fillOpacity, feature))\r\n                    });\r\n                }\r\n                else {\r\n                    circleOptions.fill = imageStyle.getFill();\r\n                }\r\n                circleOptions.stroke = imageStyle.getStroke();\r\n                const layerStroke = layerStyle && layerStyle.getStroke();\r\n                if (options.strokeColor || options.strokeWidth) {\r\n                    if (!circleOptions.stroke) {\r\n                        circleOptions.stroke = new ol.style.Stroke();\r\n                    }\r\n                    if (options.strokeColor) {\r\n                        circleOptions.stroke.setColor(getStyleValue(options.strokeColor, feature));\r\n                    }\r\n                    else {\r\n                        const strokeColor = circleOptions.stroke.getColor() || (layerStroke && layerStroke.getColor() || TC.Cfg.styles.point.strokeColor);\r\n                        circleOptions.stroke.setColor(getStyleValue(strokeColor, feature));\r\n                    }\r\n                    if (options.strokeWidth) {\r\n                        circleOptions.stroke.setWidth(getStyleValue(options.strokeWidth, feature));\r\n                    }\r\n                    else {\r\n                        const strokeWidth = circleOptions.stroke.getWidth() || (layerStroke && layerStroke.getWidth() || TC.Cfg.styles.point.strokeWidth);\r\n                        circleOptions.stroke.setWidth(getStyleValue(strokeWidth, feature));\r\n                    }\r\n                }\r\n                imageStyle = new ol.style.Circle(circleOptions);\r\n            }\r\n            style.setImage(imageStyle);\r\n        }\r\n        else {\r\n            var stroke = style.getStroke();\r\n            var strokeChanged = false;\r\n            if (!stroke) {\r\n                stroke = new ol.style.Stroke();\r\n            }\r\n            if (options.strokeColor) {\r\n                stroke.setColor(getStyleValue(options.strokeColor, feature));\r\n                strokeChanged = true;\r\n            }\r\n            if (options.strokeWidth) {\r\n                stroke.setWidth(getStyleValue(options.strokeWidth, feature));\r\n                strokeChanged = true;\r\n                style.setStroke(stroke);\r\n            }\r\n            if (options.lineDash) {\r\n                stroke.setLineDash(options.lineDash)\r\n                strokeChanged = true;\r\n                style.setStroke(stroke);\r\n            }\r\n            if (strokeChanged) {\r\n                style.setStroke(stroke);\r\n            }\r\n            if (geom instanceof ol.geom.Polygon || geom instanceof ol.geom.MultiPolygon) {\r\n                if (options.fillColor || options.fillOpacity) {\r\n                    var fill = style.getFill() || new ol.style.Fill();\r\n                    fill.setColor(getRGBA(getStyleValue(options.fillColor, feature), getStyleValue(options.fillOpacity, feature)));\r\n                    style.setFill(fill);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (options.label !== undefined) {\r\n            style = getFeatureStyle.call(olFeat);\r\n            if (options.label.length) {\r\n                style.setText(createNativeTextStyle(options, feature));\r\n            }\r\n            else {\r\n                style.setText();\r\n            }\r\n        }\r\n\r\n        olFeat.changed();\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.toggleSelectedStyle = function (condition) {\r\n        const self = this;\r\n        const feature = self.feature;\r\n        const setStyle = condition === undefined ? !feature._originalStyle : condition;\r\n        if (setStyle) {\r\n            setSelectedStyle(feature);\r\n        }\r\n        else {\r\n            removeSelectedStyle(feature);\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getInnerPoint = function (options) {\r\n        var result;\r\n        var opts = options || {};\r\n        // Funciones para hacer clipping con el extent actual. Así nos aseguramos de que el popup sale en un punto visible actualmente.\r\n        var feature = this.feature;\r\n        var geometry = feature.getGeometry();\r\n\r\n        var clipCoord = function (coord) {\r\n            var clipBox = opts.clipBox;\r\n            coord[0] = Math.min(Math.max(coord[0], clipBox[0]), clipBox[2]);\r\n            coord[1] = Math.min(Math.max(coord[1], clipBox[1]), clipBox[3]);\r\n        };\r\n        var clipGeometry = function clipGeometry(geom) {\r\n            if (opts.clipBox) {\r\n                if ($.isArray(geom)) {\r\n                    if ($.isArray(geom[0])) {\r\n                        for (var i = 0, len = geom.length; i < len; i++) {\r\n                            clipGeometry(geom[i]);\r\n                        }\r\n                    }\r\n                    else {\r\n                        clipCoord(geom);\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        result = geometry.getFirstCoordinate();\r\n        switch (geometry.getType()) {\r\n            case ol.geom.GeometryType.MULTI_POLYGON:\r\n                var area = 0;\r\n                geometry = geometry.getPolygons().reduce(function (prev, cur) {\r\n                    const curArea = cur.getArea();\r\n                    const result = curArea > area ? cur : prev;\r\n                    area = curArea;\r\n                    return result;\r\n                });\r\n            case ol.geom.GeometryType.POLYGON:\r\n                var isInsideRing = function (point, ring) {\r\n                    var result = false;\r\n                    for (var i = 0, j = ring.length - 1; i < ring.length; j = i++) {\r\n                        var xi = ring[i][0], yi = ring[i][1];\r\n                        var xj = ring[j][0], yj = ring[j][1];\r\n                        var intersect = ((yi > point[1]) != (yj > point[1])) &&\r\n                            (point[0] < (xj - xi) * (point[1] - yi) / (yj - yi) + xi);\r\n                        if (intersect) result = !result;\r\n                    }\r\n                    return result;\r\n                };\r\n                var coords = geometry.getCoordinates();\r\n                clipGeometry(coords);\r\n                geometry = new ol.geom.Polygon(coords);\r\n                result = geometry.getInteriorPoint().getCoordinates();\r\n                var rings = geometry.getLinearRings();\r\n                // Miramos si el punto está dentro de un agujero\r\n                for (var i = 1; i < rings.length; i++) {\r\n                    if (isInsideRing(result, rings[i].getCoordinates())) {\r\n                        result = geometry.getClosestPoint(result);\r\n                        break;\r\n                    }\r\n                }\r\n                break;\r\n            case ol.geom.GeometryType.MULTI_LINE_STRING:\r\n                var length = 0;\r\n                geometry = geometry.getLineStrings().reduce(function (prev, cur) {\r\n                    const curLength = cur.getLength();\r\n                    const result = curLength > length ? cur : prev;\r\n                    length = curLength;\r\n                    return result;\r\n                });\r\n            case ol.geom.GeometryType.LINE_STRING:\r\n                var centroid = [0, 0];\r\n                var coords = geometry.getCoordinates();\r\n                clipGeometry(coords);\r\n                geometry = new ol.geom.LineString(coords);\r\n                for (var i = 0; i < coords.length; i++) {\r\n                    centroid[0] += coords[i][0];\r\n                    centroid[1] += coords[i][1];\r\n                }\r\n                centroid[0] /= coords.length;\r\n                centroid[1] /= coords.length;\r\n                result = geometry.getClosestPoint(centroid);\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.showPopup = function (popupCtl) {\r\n        var self = this;\r\n        var map = popupCtl.map;\r\n\r\n        if (map) {\r\n            var feature = self.feature;\r\n            if (feature) {\r\n                map.currentFeature = self.parent;\r\n                var currentExtent = map.getExtent();\r\n\r\n                self._innerCentroid = self.getInnerPoint({ clipBox: currentExtent });\r\n\r\n                popupCtl.contentDiv.innerHTML = self.parent.getInfo({ locale: map.options.locale });\r\n                popupCtl.menuDiv.innerHTML = '';\r\n                if (popupCtl.options.closeButton || popupCtl.options.closeButton === undefined) {\r\n                    const btn = document.createElement('div');\r\n                    btn.classList.add(popupCtl.CLASS + '-close');\r\n                    btn.setAttribute('title', popupCtl.getLocaleString('close'));\r\n                    popupCtl.menuDiv.appendChild(btn);\r\n                    btn.addEventListener(TC.Consts.event.CLICK, function () {\r\n                        popupCtl.hide();\r\n                    });\r\n                    popupCtl.contentDiv.classList.add(popupCtl.CLASS + '-has-btn');\r\n                    // En OL2 los featureInfo en versión \"baraja de cartas\" salen sin tamaño.\r\n                    // Para evitar esto, la clase tc-ctl-finfo tiene ancho y alto establecidos.\r\n                    // Pero eso hace que en el popup salgan barras de scroll, porque contentDiv se crea demasiado pequeño.\r\n                    // Rehacemos el tamaño de tc-ctl-finfo para eliminarlas.\r\n                    const finfo = popupCtl.contentDiv.querySelector('.tc-ctl-finfo');\r\n                    if (finfo) {\r\n                        finfo.width = 'auto';\r\n                        finfo.height = 'auto';\r\n                    }\r\n                }\r\n\r\n                var options = self.parent.options;\r\n                if (TC.Util.isEmptyObject(options) && self.parent.layer &&\r\n                    self.parent.layer.options && self.parent.layer.options.styles) {\r\n\r\n                    switch (self.parent.CLASSNAME) {\r\n                        case \"TC.feature.Point\":\r\n                            options = self.parent.layer.options.styles.point;\r\n\r\n                            // 11/03/2019 Al crear las features del API desde las features nativas, \r\n                            // se valida si la feature tiene icono para definir si es punto o marcador\r\n                            // el problema viene cuando la feature no tiene estilo propio sino que lo obtiene de la capa,\r\n                            // en esos casos se define como punto lo que es un marcador y cuando llegamos aquí no se accede a las\r\n                            // opciones de marcador sino de punto.\r\n                            if (!options || TC.Util.isEmptyObject(options)) {\r\n                                options = self.parent.layer.options.styles.marker;\r\n                            }\r\n                            break;\r\n                        case \"TC.feature.Marker\":\r\n                            options = self.parent.layer.options.styles.marker;\r\n                            break;\r\n                        case \"TC.feature.Circle\":\r\n                            options = self.parent.layer.options.styles.circle;\r\n                            break;\r\n                        case \"TC.feature.MultiPolygon\":\r\n                        case \"TC.feature.Polygon\":\r\n                            options = self.parent.layer.options.styles.polygon;\r\n                            break;\r\n                        case \"TC.feature.MultiPolyline\":\r\n                        case \"TC.feature.Polyline\":\r\n                            options = self.parent.layer.options.styles.line;\r\n                            break;\r\n                    }\r\n                }\r\n\r\n                // Calcular anchor\r\n                var anchor;\r\n                if (options.anchor) {\r\n                    anchor = options.anchor;\r\n                }\r\n                else {\r\n                    var style;\r\n                    var f = feature._wrap.parent;\r\n                    for (var i = 0; i < map.workLayers.length; i++) {\r\n                        var layer = map.workLayers[i];\r\n                        if (!layer.isRaster()) {\r\n                            if ($.inArray(f, layer.features) >= 0) {\r\n                                style = layer.wrap.styleFunction(feature);\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                    if ($.isArray(style)) {\r\n                        const image = style[0].getImage();\r\n                        anchor = !image || image instanceof ol.style.Icon ? [0.5, 0] : [0.5, 0.5];\r\n                    }\r\n                }\r\n                const offset = [0, 0];\r\n                if (anchor) {\r\n                    if (options.height) {\r\n                        offset[1] = -options.height * anchor[1];\r\n                    }\r\n                    else {\r\n                        var fStyle = getFeatureStyle.call(feature, true);\r\n                        if (fStyle) {\r\n                            const image = fStyle.getImage();\r\n                            if (image instanceof ol.style.Icon) {\r\n                                offset[1] = image.getImageSize()[1] * -image.getScale();\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                popupCtl.wrap.setDragged(false);\r\n                popupCtl.wrap.popup.setOffset(offset);\r\n                popupCtl.wrap.popup.setPosition(self._innerCentroid);\r\n                popupCtl.popupDiv.classList.add(TC.Consts.classes.VISIBLE);\r\n            }\r\n            else {\r\n                map.wrap.hidePopup(popupCtl);\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.isNative = function (feature) {\r\n        return feature instanceof ol.Feature;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getPath = function () {\r\n        var result = [];\r\n        var self = this;\r\n        if (self.feature && self.feature._folders) {\r\n            result = self.feature._folders;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getBounds = function () {\r\n        var result = null;\r\n        var self = this;\r\n        if (self.feature) {\r\n            result = self.feature.getGeometry().getExtent();\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getTemplate = function () {\r\n        var result = null;\r\n        var self = this;\r\n        var style = self.feature.getStyle();\r\n        if (typeof style === 'function') {\r\n            style = style.call(self.feature);\r\n        }\r\n        if ($.isArray(style)) {\r\n            for (var i = 0; i < style.length; i++) {\r\n                if (style[i]._balloon) {\r\n                    var s = style[i]._balloon.getText();\r\n                    if (s) {\r\n                        style = style[i]._balloon;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (style && !$.isArray(style) && style.getText) {\r\n            result = style.getText();\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.getData = function () {\r\n        var self = this;\r\n        var result = self.feature.getProperties();\r\n        // En caso de clusters\r\n        if ($.isArray(result.features)) {\r\n            if (result.features.length === 1) {\r\n                result = result.features[0].getProperties();\r\n            }\r\n            else {\r\n                result = result.features.length + ' elementos';\r\n            }\r\n        }\r\n        var geometryName = self.feature.getGeometryName();\r\n        if (result[geometryName]) {\r\n            delete result[geometryName];\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.setData = function (data) {\r\n        this.feature.setProperties(data);\r\n    };\r\n\r\n    TC.wrap.Feature.prototype.clearData = function () {\r\n        const feature = this.feature;\r\n        const geometryName = feature.getGeometryName();\r\n        feature.getKeys().forEach(function (key) {\r\n            if (key !== geometryName) {\r\n                feature.unset(key);\r\n            }\r\n        });\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.mouseMoveHandler = function (evt) {\r\n        const self = this;\r\n        if (self.sketch) {\r\n            self.parent.trigger(TC.Consts.event.MEASUREPARTIAL, self.getMeasureData());\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.mouseOverHandler = function (evt) {\r\n        const self = this;\r\n        if (self.sketch && self.hoverCoordinate) {\r\n            self.pushCoordinate(self.hoverCoordinate);\r\n            self.hoverCoordinate = null;\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.clickHandler = function (evt) {\r\n        const self = this;\r\n        if (self.parent.map.view === TC.Consts.view.PRINTING) {\r\n            return;\r\n        }\r\n        if (self._mdPx) { // No operamos si el clic es consecuencia es en realidad un drag\r\n            const dx = self._mdPx[0] - evt.clientX;\r\n            const dy = self._mdPx[1] - evt.clientY;\r\n            if (dx * dx + dy * dy > self.interaction.squaredClickTolerance_) {\r\n                return;\r\n            }\r\n        }\r\n        if (self.sketch) {\r\n            var coords = self.sketch.getGeometry().getCoordinates();\r\n            self.parent.trigger(TC.Consts.event.POINT, {\r\n                point: coords[coords.length - 1]\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.mousedownHandler = function (evt) {\r\n        const self = this;\r\n        self._mdPx = [evt.clientX, evt.clientY];\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.getMeasureData = function () {\r\n        var self = this;\r\n\r\n        var formatLength = function (line, data) {\r\n            line = new ol.geom.LineString(TC.Util.reproject(line.getCoordinates(), self.parent.map.crs, self.parent.map.options.utmCrs));\r\n            data.length = line.getLength();\r\n        };\r\n\r\n        var formatArea = function (polygon, data) {\r\n            polygon = new ol.geom.Polygon([TC.Util.reproject(polygon.getLinearRing(0).getCoordinates(), self.parent.map.crs, self.parent.map.options.utmCrs)]);\r\n            data.area = polygon.getArea();\r\n            var ring = polygon.getLinearRing(0);\r\n            data.perimeter = ol.geom.flat.length.linearRing(ring.flatCoordinates, 0, ring.flatCoordinates.length, ring.stride);\r\n        };\r\n\r\n        var result = {\r\n            units: ol.proj.Units.METERS\r\n        };\r\n        if (this.sketch) {\r\n            var geom = (this.sketch.getGeometry());\r\n            if (geom instanceof ol.geom.Polygon) {\r\n                formatArea(geom, result);\r\n            }\r\n            else if (geom instanceof ol.geom.LineString) {\r\n                formatLength(geom, result);\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    // Función para reproyectar el dibujo actual\r\n    const drawProjectionChangeHandler = function (ctl, e) {\r\n        if (ctl.sketch) {\r\n            const oldProj = e.oldValue.getProjection();\r\n            const newProj = e.target.get(e.key).getProjection();\r\n            if (oldProj.getCode() !== newProj.getCode()) {\r\n                const geom = ctl.sketch.getGeometry();\r\n                geom.transform(oldProj, newProj);\r\n                ctl.interaction.sketchPoint_.getGeometry().transform(oldProj, newProj);\r\n                const flatCoordinates = [];\r\n                var sketchCoords;\r\n                if (ctl.interaction.mode_ === ol.interaction.Draw.Mode_.POLYGON) {\r\n                    sketchCoords = ctl.interaction.sketchCoords_[0];\r\n                }\r\n                else {\r\n                    sketchCoords = ctl.interaction.sketchCoords_;\r\n                }\r\n                ol.geom.flat.deflate.coordinates(flatCoordinates, 0, sketchCoords, geom.stride);\r\n                const transformFn = ol.proj.getTransform(oldProj, newProj);\r\n                transformFn(flatCoordinates, flatCoordinates, geom.stride);\r\n                sketchCoords = ol.geom.flat.inflate.coordinates(flatCoordinates, 0, flatCoordinates.length, geom.stride);\r\n                if (ctl.interaction.mode_ === ol.interaction.Draw.Mode_.POLYGON) {\r\n                    ctl.interaction.sketchCoords_ = [sketchCoords];\r\n                }\r\n                else {\r\n                    ctl.interaction.sketchCoords_ = sketchCoords;\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.activate = function (mode) {\r\n        var self = this;\r\n\r\n        var type;\r\n        switch (mode) {\r\n            case TC.Consts.geom.POLYGON:\r\n                type = ol.geom.GeometryType.POLYGON;\r\n                break;\r\n            case TC.Consts.geom.POINT:\r\n                type = ol.geom.GeometryType.POINT;\r\n                break;\r\n            default:\r\n                type = ol.geom.GeometryType.LINE_STRING;\r\n                break;\r\n        }\r\n        if (self.parent.map) {\r\n            Promise.all([self.parent.map.wrap.getMap(), self.parent.getLayer()]).then(function (objects) {\r\n                const olMap = objects[0];\r\n                const layer = objects[1];\r\n                if (layer) {\r\n                    layer.wrap.getLayer().then(function (olLayer) {\r\n\r\n                        if (!self.viewport) self.viewport = olMap.getViewport();\r\n\r\n                        if (self.interaction) {\r\n                            olMap.removeInteraction(self.interaction);\r\n                            if (self._mousedownHandler) {\r\n                                self.viewport.removeEventListener('mousedown', self._mousedownHandler);\r\n                                self._mousedownHandler = null;\r\n                            }\r\n                            if (self._clickHandler) {\r\n                                self.viewport.removeEventListener(TC.Consts.event.CLICK, self._clickHandler);\r\n                                self._clickHandler = null;\r\n                            }\r\n                            if (self._mouseMoveHandler && self._mouseOverHandler) {\r\n                                self.viewport.removeEventListener(MOUSEMOVE, self._mouseMoveHandler);\r\n                                self.viewport.removeEventListener(MOUSEOVER, self._mouseOverHandler);\r\n                            }\r\n                        }\r\n\r\n                        if (self.snapInteraction) {\r\n                            olMap.removeInteraction(self.snapInteraction);\r\n                        }\r\n\r\n                        if (mode) {\r\n                            self._mousedownHandler = $.proxy(self.mousedownHandler, self);\r\n                            self._clickHandler = $.proxy(self.clickHandler, self);\r\n                            self.viewport.addEventListener('mousedown', self._mousedownHandler);\r\n                            self.viewport.addEventListener(TC.Consts.event.CLICK, self._clickHandler);\r\n                            if (self.parent.measure) {\r\n                                self._mouseMoveHandler = self.mouseMoveHandler.bind(self);\r\n                                self._mouseOverHandler = self.mouseOverHandler.bind(self);\r\n                                self.viewport.addEventListener(MOUSEMOVE, self._mouseMoveHandler);\r\n                                self.viewport.addEventListener(MOUSEOVER, self._mouseOverHandler);\r\n                            }\r\n\r\n                            var drawOptions = {\r\n                                type: type,\r\n                                snapTolerance: 0,\r\n                                condition: function () {\r\n                                    if (ol.events.condition.shiftKeyOnly(arguments[0])) {\r\n                                        hole = olMap.forEachFeatureAtPixel(olMap.getPixelFromCoordinate(arguments[0].coordinate), function (feature) {\r\n                                            if (ol.geom.GeometryType.POLYGON == feature.getGeometry().getType() ||\r\n                                                ol.geom.GeometryType.MULTI_POLYGON == feature.getGeometry().getType()) {\r\n                                                return feature;\r\n                                            }\r\n                                            return null;\r\n                                        },\r\n                                            {\r\n                                                hitTolerance: hitTolerance\r\n                                            });\r\n                                    }\r\n\r\n                                    if (self.parent.map.view === TC.Consts.view.PRINTING) {\r\n                                        return null;\r\n                                    }\r\n\r\n                                    return true;\r\n                                }\r\n                            };\r\n                            if (olLayer) {\r\n                                drawOptions.source = olLayer.getSource();\r\n                            }\r\n                            switch (mode) {\r\n                                case TC.Consts.geom.RECTANGLE:\r\n                                    drawOptions.style = createNativeStyle({\r\n                                        styles: { line: self.parent.styles.line }\r\n                                    });\r\n                                    drawOptions.type = ol.geom.GeometryType.LINE_STRING;\r\n                                    drawOptions.maxPoints = 2;\r\n                                    drawOptions.geometryFunction = function (coordinates, geometry) {\r\n                                        if (!geometry) {\r\n                                            geometry = new ol.geom.Polygon(null);\r\n                                        }\r\n                                        var start = coordinates[0];\r\n                                        var end = coordinates[1];\r\n                                        geometry.setCoordinates([\r\n                                            [start, [start[0], end[1]], end, [end[0], start[1]], start]\r\n                                        ]);\r\n                                        return geometry;\r\n                                    };\r\n                                    break;\r\n                                case TC.Consts.geom.POLYGON:\r\n                                    drawOptions.style = createNativeStyle({\r\n                                        styles: { polygon: self.parent.styles.polygon }\r\n                                    });\r\n                                    break;\r\n                                case TC.Consts.geom.POINT:\r\n                                    drawOptions.style = createNativeStyle({\r\n                                        styles: { point: self.parent.styles.point }\r\n                                    });\r\n                                    break;\r\n                                default:\r\n                                    drawOptions.style = createNativeStyle({\r\n                                        styles: { line: self.parent.styles.line }\r\n                                    });\r\n                                    break;\r\n                            }\r\n\r\n                            self.interaction = new ol.interaction.Draw(drawOptions);\r\n\r\n                            self.interaction.on(ol.interaction.DrawEventType.DRAWSTART, function (evt) {\r\n                                self.sketch = evt.feature;\r\n                                self.parent.trigger(TC.Consts.event.DRAWSTART);\r\n                            }, this);\r\n\r\n                            self.interaction.on(ol.interaction.DrawEventType.DRAWEND, function (evt) {\r\n                                evt.feature.setStyle(evt.target.overlay_.getStyle().map(function (style) {\r\n                                    return style.clone();\r\n                                }));\r\n                                if (self.parent.measure) {\r\n                                    self.parent.trigger(TC.Consts.event.MEASURE, self.getMeasureData());\r\n                                }\r\n                                createFeatureFromNative(self.sketch).then(function (feat) {\r\n                                    self.parent.trigger(TC.Consts.event.DRAWEND, { feature: feat });\r\n                                    self.sketch = null;\r\n                                });\r\n                            }, this);\r\n\r\n                            self._projectionChangeHandler = function (e) {\r\n                                drawProjectionChangeHandler(self, e);\r\n                            };\r\n                            olMap.on('change:view', self._projectionChangeHandler);\r\n\r\n                            olMap.addInteraction(self.interaction);\r\n\r\n                            if (self.parent.snapping) {\r\n                                var snapOptions = {};\r\n                                if (olLayer) {\r\n                                    snapOptions.source = olLayer.getSource();\r\n                                }\r\n                                else if (self.parent.snapping instanceof TC.Layer) {\r\n                                    snapOptions.source = self.parent.snapping.wrap.layer.getSource();\r\n                                }\r\n                                self.snapInteraction = new ol.interaction.Snap(snapOptions);\r\n                                olMap.addInteraction(self.snapInteraction);\r\n                            }\r\n                        }\r\n\r\n                        self.redoStack = [];\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.deactivate = function () {\r\n        var self = this;\r\n        if (self.parent.map) {\r\n            Promise.all([self.parent.map.wrap.getMap(), self.parent.getLayer()]).then(function (objects) {\r\n                const olMap = objects[0];\r\n                const layer = objects[1];\r\n                if (self.viewport) {\r\n                    if (self._mousedownHandler) {\r\n                        self.viewport.removeEventListener('mousedown', self._mousedownHandler);\r\n                        self._mousedownHandler = null;\r\n                    }\r\n                    if (self._clickHandler) {\r\n                        self.viewport.removeEventListener(TC.Consts.event.CLICK, self._clickHandler);\r\n                        self._clickHandler = null;\r\n                    }\r\n                }\r\n                if (layer && !self.parent.persistent) {\r\n                    layer.clearFeatures();\r\n                }\r\n                if (self.interaction) {\r\n                    olMap.removeInteraction(self.interaction);\r\n                    self.interaction = null;\r\n                }\r\n                olMap.un('change:view', self._projectionChangeHandler);\r\n            });\r\n        }\r\n    };\r\n\r\n    //El valor devuelto es lo que va al stack de redo\r\n    TC.wrap.control.Draw.prototype.popCoordinate = function () {\r\n        var self = this;\r\n        var result = null;\r\n        if (self.interaction) {\r\n            var feature = self.interaction.sketchFeature_;\r\n            if (feature) {\r\n                var coords;\r\n                var geom = feature.getGeometry();\r\n\r\n                if (geom instanceof ol.geom.Polygon) {\r\n                    coords = geom.getCoordinates()[0];\r\n                }\r\n                else if (geom instanceof ol.geom.LineString) {\r\n                    coords = geom.getCoordinates();\r\n                }\r\n                var fullCoords = coords;\r\n                if (coords.length > 1) {\r\n\r\n                    var puntos;\r\n                    if (geom instanceof ol.geom.Polygon)\r\n                        puntos = self.interaction.sketchCoords_[0];\r\n                    else if (geom instanceof ol.geom.LineString)\r\n                        puntos = self.interaction.sketchCoords_;\r\n\r\n                    /*\r\n                    Al menos con linestring, no necesariamente hay que quitar el último\r\n                    Porque OL mete en coordinates del sketchFeature_ tanto el último marcado como el que flota detrás del cursor\r\n                    Para comprobar que realmente es ése, podemos contrastarlo con self.interaction.sketchPoint_.getGeometry().getCoordinates()\r\n                    */\r\n                    var flyingPointContained = false;\r\n                    if (self.interaction.sketchPoint_) {\r\n                        var flyingPoint = self.interaction.sketchPoint_.getGeometry().getCoordinates();\r\n                        for (var i = 0; i < coords.length; i++) {\r\n                            if (coords[i][0] == flyingPoint[0] && coords[i][1] == flyingPoint[1]) {\r\n                                flyingPointContained = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    var index;\r\n                    if (flyingPointContained) index = puntos.length - 2;\r\n                    else index = puntos.length - 1;\r\n\r\n                    result = puntos[index];\r\n                    puntos.splice(index, 1);\r\n\r\n                    if (geom instanceof ol.geom.Polygon) {\r\n                        geom.setCoordinates([puntos]);\r\n                        self.interaction.sketchLine_.getGeometry().setCoordinates(puntos);\r\n                    }\r\n                    else {\r\n                        geom.setCoordinates(puntos);\r\n                    }\r\n\r\n\r\n                    feature.setGeometry(geom);\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.pushCoordinate = function (coord) {\r\n        var self = this;\r\n        var result = false;\r\n        if (self.interaction) {\r\n            var feature = self.interaction.sketchFeature_;\r\n            if (feature) {\r\n                var coords;\r\n                var geom = feature.getGeometry();\r\n\r\n                if (geom instanceof ol.geom.Polygon) {\r\n                    coords = geom.getCoordinates()[0];\r\n                } else if (geom instanceof ol.geom.LineString) {\r\n                    coords = geom.getCoordinates();\r\n                }\r\n                var fullCoords = coords;\r\n                //coords.push(coord);\r\n\r\n                var puntos;\r\n                if (geom instanceof ol.geom.Polygon) {\r\n                    puntos = self.interaction.sketchCoords_[0];\r\n                    //self.interaction.sketchCoords_[0].push(coord);\r\n                    //geom.setCoordinates([fullCoords], ol.geom.GeometryLayout.XY);\r\n                } else if (geom instanceof ol.geom.LineString) {\r\n\r\n                    puntos = self.interaction.sketchCoords_;\r\n                }\r\n\r\n                //Si hay punto volador, hay que meter la coordenada justo antes\r\n                var flyingPointContained = false;\r\n                if (self.interaction.sketchPoint_) {\r\n                    var flyingPoint = self.interaction.sketchPoint_.getGeometry().getCoordinates();\r\n                    for (var i = 0; i < coords.length; i++) {\r\n                        if (coords[i][0] == flyingPoint[0] && coords[i][1] == flyingPoint[1]) {\r\n                            flyingPointContained = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n\r\n\r\n                if (flyingPointContained) index = puntos.length - 1;\r\n                else index = puntos.length;\r\n                puntos.splice(index, 0, coord);\r\n\r\n                if (geom instanceof ol.geom.LineString)\r\n                    geom.setCoordinates(puntos, ol.geom.GeometryLayout.XY);\r\n                else {\r\n                    geom.setCoordinates([puntos], ol.geom.GeometryLayout.XY);\r\n                    self.interaction.sketchLine_.getGeometry().setCoordinates(puntos);\r\n                    //feature.setGeometry(geom);\r\n                }\r\n\r\n\r\n                result = true;\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.undo = function () {\r\n        var self = this;\r\n        var result = false;\r\n\r\n        var coord = self.popCoordinate();\r\n        if (coord) {\r\n            self.redoStack.push(coord);\r\n            result = true;\r\n        }\r\n\r\n        self.parent.trigger(TC.Consts.event.MEASUREPARTIAL, self.getMeasureData());\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.redo = function () {\r\n        var self = this;\r\n        var result = false;\r\n\r\n        if (self.redoStack.length > 0) {\r\n            self.pushCoordinate(self.redoStack.pop());\r\n            result = true;\r\n        }\r\n\r\n        self.parent.trigger(TC.Consts.event.MEASUREPARTIAL, self.getMeasureData());\r\n\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.end = function () {\r\n        var self = this;\r\n        if (self.interaction && self.interaction.sketchFeature_)\r\n            self.interaction.finishDrawing();\r\n    };\r\n\r\n    TC.wrap.control.Draw.prototype.setStyle = function (style) {\r\n        const self = this;\r\n        if (self.interaction) {\r\n            self.interaction.overlay_.setStyle(createNativeStyle({\r\n                styles: style\r\n            }));\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.CacheBuilder.prototype.getRequestSchemas = function (options) {\r\n        var self = this;\r\n        var extent = options.extent;\r\n        var layers = options.layers;\r\n        var result = new Array(layers.length);\r\n        for (var i = 0, len = result.length; i < len; i++) {\r\n            var layer = layers[i];\r\n            var schema = {\r\n                layerId: layer.id\r\n            };\r\n            var olSource = layer.wrap.layer.getSource();\r\n            if (olSource.getUrls) {\r\n                schema.url = olSource.getUrls()[0];\r\n            }\r\n            if (olSource.getTileGrid) {\r\n                var tileGrid = olSource.getTileGrid();\r\n                var resolutions = tileGrid.getResolutions();\r\n                var matrixIds = tileGrid.getMatrixIds();\r\n                var node = layer.getLayerNodeByName(layer.layerNames);\r\n                var tmsLimits = null;\r\n                for (var j = 0, llen = node.TileMatrixSetLink.length; j < llen; j++) {\r\n                    var tmsl = node.TileMatrixSetLink[j];\r\n                    if (tmsl.TileMatrixSet === layer.matrixSet) {\r\n                        tmsLimits = tmsl.TileMatrixSetLimits;\r\n                        break;\r\n                    }\r\n                }\r\n                schema.tileMatrixLimits = [];\r\n                for (var j = 0, rlen = resolutions.length; j < rlen; j++) {\r\n                    var origin = tileGrid.getOrigin(j);\r\n                    var tileSize = tileGrid.getTileSize(j);\r\n                    var resolution = resolutions[j];\r\n                    var unitsPerTile = tileSize * resolution;\r\n                    var tml = {\r\n                        mId: matrixIds[j],\r\n                        res: resolution,\r\n                        origin: origin,\r\n                        tSize: tileSize,\r\n                        cl: Math.floor((extent[0] - origin[0]) / unitsPerTile),\r\n                        cr: Math.floor((extent[2] - origin[0]) / unitsPerTile),\r\n                        rt: Math.floor((origin[1] - extent[3]) / unitsPerTile),\r\n                        rb: Math.floor((origin[1] - extent[1]) / unitsPerTile)\r\n                    }\r\n                    if (tmsLimits) {\r\n                        var tmsLimit = tmsLimits[j];\r\n                        if (tmsLimit) {\r\n                            tml.cl = Math.max(tml.cl, tmsLimit.MinTileCol);\r\n                            tml.cr = Math.min(tml.cr, tmsLimit.MaxTileCol);\r\n                            tml.rt = Math.max(tml.rt, tmsLimit.MinTileRow);\r\n                            tml.rb = Math.min(tml.rb, tmsLimit.MaxTileRow);\r\n                        }\r\n                    }\r\n                    if (tml.cl <= tml.cr && tml.rt <= tml.rb) {\r\n                        schema.tileMatrixLimits.push(tml);\r\n                    }\r\n                }\r\n            }\r\n            result[i] = schema;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.CacheBuilder.prototype.getGetTilePattern = function (layer) {\r\n        var result = \"\";\r\n        var olSource = layer.wrap.layer.getSource();\r\n        if (olSource.getUrls) {\r\n            result = olSource.getUrls()[0];\r\n        }\r\n        if (layer.options.encoding !== TC.Consts.WMTSEncoding.RESTFUL) {\r\n            if (result.indexOf('?') < 0) {\r\n                result = result + '?';\r\n            }\r\n            if (result.indexOf('?') === result.length - 1) {\r\n                result = result + 'layer=' + layer.layerNames + '&style=default&tilematrixset=' + encodeURIComponent(layer.matrixSet) +\r\n                    '&Service=WMTS&Request=GetTile&Version=1.0.0&Format=' + encodeURIComponent(layer.format) +\r\n                    '&TileMatrix={TileMatrix}&TileCol={TileCol}&TileRow={TileRow}';\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    const createHaloStroke1 = function (width) {\r\n        return new ol.style.Stroke({\r\n            color: '#ffffff',\r\n            width: width + 4,\r\n        });\r\n    };\r\n\r\n    const createHaloStroke2 = function (width) {\r\n        return new ol.style.Stroke({\r\n            color: '#000000',\r\n            width: width + 6,\r\n        });\r\n    };\r\n\r\n    const addHaloToStyle = function (style) {\r\n        if (style === undefined) {\r\n            style = [];\r\n        }\r\n        if (style instanceof ol.style.Style) {\r\n            style = [style];\r\n        }\r\n        style = style.slice();\r\n        const mainStyle = style[0];\r\n        if (mainStyle) {\r\n            const image = mainStyle.getImage();\r\n            var strokeWidth;\r\n            if (image instanceof ol.style.RegularShape) {\r\n                strokeWidth = image.getStroke().getWidth();\r\n                const radius = image.getRadius();\r\n                const haloPart1 = mainStyle.clone();\r\n                haloPart1.setImage(new ol.style.Circle({\r\n                    radius: radius,\r\n                    stroke: createHaloStroke1(strokeWidth)\r\n                }));\r\n                style.unshift(haloPart1);\r\n                const haloPart2 = mainStyle.clone();\r\n                haloPart2.setImage(new ol.style.Circle({\r\n                    radius: radius,\r\n                    stroke: createHaloStroke2(strokeWidth)\r\n                }));\r\n                style.unshift(haloPart2);\r\n            }\r\n            else {\r\n                strokeWidth = mainStyle.getStroke().getWidth();\r\n                style.unshift(new ol.style.Style({\r\n                    stroke: createHaloStroke1(strokeWidth)\r\n                }));\r\n                style.unshift(new ol.style.Style({\r\n                    stroke: createHaloStroke2(strokeWidth)\r\n                }));\r\n            }\r\n            return style;\r\n        }\r\n        return null;\r\n    };\r\n\r\n    const createSelectedStyle = function (feat) {\r\n        feat._originalStyle = feat._originalStyle || feat.getStyle();\r\n        if ($.isFunction(feat._originalStyle)) {\r\n            return function (f, r) {\r\n                return addHaloToStyle(feat._originalStyle(f, r));\r\n            };\r\n        }\r\n        return addHaloToStyle(feat._originalStyle);\r\n    };\r\n\r\n    const setSelectedStyle = function (feat) {\r\n        updateSelectedStyle.call(feat);\r\n        feat.changed();\r\n        ol.events.listen(feat, ol.events.EventType.CHANGE, updateSelectedStyle, feat);\r\n    };\r\n\r\n    const removeSelectedStyle = function (feat) {\r\n        ol.events.unlisten(feat, ol.events.EventType.CHANGE, updateSelectedStyle, feat);\r\n        if (feat._originalStyle) {\r\n            feat.setStyle(null);\r\n            feat.setStyle(feat._originalStyle);\r\n        }\r\n        feat._originalStyle = null;\r\n    };\r\n\r\n    const updateSelectedStyle = function () {\r\n        this.style_ = createSelectedStyle(this);\r\n        this.styleFunction_ = !this.style_ ? undefined : ol.Feature.createStyleFunction(this.style_);\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.activate = function () {\r\n        const self = this;\r\n        if (self.parent.map) {\r\n            Promise.all([self.parent.map.wrap.getMap(), self.parent.layer.wrap.getLayer()]).then(function (olObjects) {\r\n                const olMap = olObjects[0];\r\n                const olLayer = olObjects[1];\r\n                if (self.selectInteraction) {\r\n                    olMap.removeInteraction(self.selectInteraction);\r\n                }\r\n                var select = new ol.interaction.Select({\r\n                    layers: [olLayer],\r\n                    hitTolerance: hitTolerance\r\n                });\r\n                self.selectInteraction = select;\r\n                olMap.addInteraction(select);\r\n                var getWrapperFeature = function (elm) {\r\n                    return elm._wrap.parent;\r\n                };\r\n                select.on('select', function (event) {\r\n                    if (event.selected.length > 0) {\r\n                        self.parent.trigger(TC.Consts.event.FEATURESSELECT, { ctrl: self, features: event.selected.map(getWrapperFeature) });\r\n                    }\r\n                    if (event.deselected.length > 0) {\r\n                        if (event.selected.length == 0) {\r\n                            self.parent.trigger(TC.Consts.event.FEATURESUNSELECT, { ctrl: self.parent, features: event.deselected.map(getWrapperFeature) });\r\n                        }\r\n                    }\r\n                });\r\n                if (self.modifyInteraction) {\r\n                    olMap.removeInteraction(self.modifyInteraction);\r\n                }\r\n                var modify = new ol.interaction.Modify({\r\n                    features: select.getFeatures()\r\n                });\r\n                modify.on(ol.interaction.ModifyEventType.MODIFYEND, function (e) {\r\n                    e.features.forEach(function (feature) {\r\n                        feature._wrap.parent.geometry = feature._wrap.getGeometry();\r\n                        self.parent.trigger(TC.Consts.event.FEATUREMODIFY, { feature: feature._wrap.parent, layer: self.parent.layer });\r\n                    });\r\n                });\r\n                self.modifyInteraction = modify;\r\n                olMap.addInteraction(modify);\r\n\r\n                if (self.snapInteraction) {\r\n                    olMap.removeInteraction(self.snapInteraction);\r\n                }\r\n                if (self.parent.snapping) {\r\n                    self.snapInteraction = new ol.interaction.Snap({\r\n                        source: olLayer.getSource()\r\n                    });\r\n                    olMap.addInteraction(self.snapInteraction);\r\n                }\r\n\r\n                if (!self._onMouseMove) {\r\n                    self._onMouseMove = function (e) {\r\n                        const mapTarget = olMap.getTarget();\r\n                        var hit = false;\r\n                        var feature;\r\n\r\n                        var pixel = olMap.getEventPixel(e);\r\n                        hit = olMap.forEachFeatureAtPixel(pixel, function (feature, layer) {\r\n                            if (layer === self.parent.layer.wrap.layer) {\r\n                                return true;\r\n                            }\r\n                            return false;\r\n                        },\r\n                            {\r\n                                hitTolerance: hitTolerance\r\n                            });\r\n\r\n                        if (hit) {\r\n                            mapTarget.style.cursor = 'pointer';\r\n                        } else {\r\n                            mapTarget.style.cursor = '';\r\n                            //self.parent.trigger(TC.Consts.event.FEATUREOUT);\r\n                        }\r\n                    };\r\n                }\r\n\r\n                olMap.getViewport().addEventListener(MOUSEMOVE, self._onMouseMove);\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.deactivate = function () {\r\n        const self = this;\r\n        if (self.modifyInteraction) {\r\n            self.modifyInteraction.setActive(false);\r\n            self.selectInteraction.setActive(false);\r\n            self.parent.map.wrap.getMap().then(function (olMap) {\r\n                olMap.getViewport().removeEventListener(MOUSEMOVE, self._onMouseMove);\r\n                olMap.removeInteraction(self.modifyInteraction);\r\n                olMap.removeInteraction(self.selectInteraction);\r\n                self.modifyInteraction = null;\r\n                self.selectInteraction = null;\r\n            });\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.getSelectedFeatures = function () {\r\n        var self = this;\r\n        var result = [];\r\n        if (self.selectInteraction) {\r\n            self.selectInteraction.getFeatures().forEach(function (elm) {\r\n                result[result.length] = elm._wrap.parent;\r\n            });\r\n        }\r\n        return result;\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.setSelectedFeatures = function (features) {\r\n        var self = this;\r\n        if (self.selectInteraction) {\r\n            var source = self.selectInteraction.featureOverlay_.getSource();\r\n            source.clear();\r\n            source.addFeatures(features.map(function (elm) {\r\n                return elm.wrap.feature;\r\n            }));\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Modify.prototype.unselectFeatures = function (features) {\r\n        features = features || [];\r\n        const self = this;\r\n        const selectedFeatures = self.selectInteraction ? self.selectInteraction.getFeatures() : null;\r\n        if (selectedFeatures) {\r\n            const unselectedFeatures = [];\r\n            selectedFeatures.getArray().slice().forEach(function (olFeature) {\r\n                if (!features.length || features.indexOf(olFeature) >= 0) {\r\n                    selectedFeatures.remove(olFeature);\r\n                    unselectedFeatures[unselectedFeatures.length] = olFeature._wrap.parent;\r\n                }\r\n            });\r\n            if (unselectedFeatures.length) {\r\n                self.parent.trigger(TC.Consts.event.FEATURESUNSELECT, { features: unselectedFeatures });\r\n            }\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Edit.prototype.activate = function (mode) {\r\n        var self = this;\r\n        self.cancel(true);\r\n        //if (!self.session) {\r\n        //    self.session = {\r\n        //        features: []\r\n        //        , featuresAdded: []\r\n        //        , featuresRemoved: []\r\n        //        , featuresModified: []\r\n        //    };\r\n        //}\r\n        if (mode === TC.Consts.editMode.SELECT) {\r\n            TC.wrap.control.Modify.prototype.activate.call(self);\r\n        }\r\n    };\r\n\r\n    TC.wrap.control.Edit.prototype.deactivate = function () {\r\n        var self = this;\r\n        TC.wrap.control.Modify.prototype.deactivate.call(self);\r\n\r\n        if (self.drawInteraction) {\r\n            self.drawInteraction.abortDrawing_();\r\n            self.drawInteraction.setActive(false);\r\n            //self.drawInteraction.destroy();\r\n            self.parent.map.wrap.getMap().then(function (olMap) {\r\n                olMap.removeInteraction(self.drawInteraction);\r\n                self.drawInteraction = null;\r\n            });\r\n            //    self.control.layer.events.un(\"sketchcomplete\");\r\n            //    self.control.deactivate();\r\n            //    self.control.destroy();\r\n            //    self.control = null;\r\n        }\r\n        self.parent.trigger(TC.Consts.event.CONTROLDEACTIVATE, { ctrl: self });\r\n        //self.session = null;        \r\n    };\r\n\r\n    TC.wrap.control.Edit.prototype.cancel = function (deactivate, cancelTxt) {\r\n        var self = this;\r\n        self.points = [];\r\n        self.histPoints = [];\r\n        var layer = (self.control && self.control.layer) || (self.modifyInteraction && self.modifyInteraction.layer);\r\n        //if (!self.session || ((self.modifyInteraction && self.modifyInteraction.modified) || (self.session.featuresAdded && self.session.featuresAdded.length)) && cancelTxt && !confirm(cancelTxt))\r\n        //    return;\r\n        if (self.selectInteraction) {\r\n            var features = self.selectInteraction.getFeatures();\r\n            self.parent.trigger(TC.Consts.event.FEATURESUNSELECT, { ctrl: self.parent, feature: features.get(0) });\r\n            features.clear();\r\n            self.selectInteraction.setActive(false);\r\n        }\r\n        //if (self.drawInteraction) {\r\n        //    self.drawInteraction.abortDrawing_();\r\n        //    if (deactivate) {\r\n        //        self.drawInteraction.setActive(false);\r\n        //    }\r\n        //}\r\n        //if(self.modifyInteraction)\r\n        //{\r\n        //    if (self.modifyInteraction.feature)\r\n        //        self.modifyInteraction.unselectFeature(self.modifyInteraction.feature);\r\n        //    if (deactivate)\r\n        //    {\r\n        //        self.modifyInteraction.deactivate();\r\n        //    }   \r\n        //}\r\n        ////if (self.session.featuresAdded && self.session.featuresAdded.length > 0) {\r\n        ////    layer.removeFeatures(self.session.featuresAdded);\r\n        ////    self.session.featuresAdded = [];\r\n        ////}\r\n        //self.parent.trigger(TC.Consts.event.EDITIONCANCEL, { ctrl: self });\r\n        ////no se por que hostias se cambia el renderIntent a las features\r\n        //$.each(layer.features, function (i, feat) {\r\n        //    feat.renderIntent = \"\";\r\n        //});    \r\n        //layer.removeAllFeatures();\r\n        //layer.addFeatures(self.session.features);        \r\n        //self.clearSession();\r\n    };\r\n\r\n    TC.wrap.control.Edit.prototype.getSelectedFeatures = function () {\r\n        return TC.wrap.control.Modify.prototype.getSelectedFeatures.call(this);\r\n    };\r\n\r\n    TC.wrap.control.Edit.prototype.setSelectedFeatures = function (features) {\r\n        TC.wrap.control.Modify.prototype.setSelectedFeatures.call(this, features);\r\n    };\r\n\r\n    TC.wrap.control.Edit.prototype.deleteFeatures = function (features) {\r\n        var self = this;\r\n        if ($.isArray(features)) {\r\n            var olFeatures = features.map(function (elm) {\r\n                return elm.wrap.feature;\r\n            });\r\n            self.parent.layer.wrap.getLayer().then(function (olLayer) {\r\n                var selectedFeatures = self.selectInteraction ? self.selectInteraction.getFeatures() : null;\r\n                for (var i = 0, len = olFeatures.length; i < len; i++) {\r\n                    var olFeature = olFeatures[i];\r\n                    if (selectedFeatures) {\r\n                        selectedFeatures.remove(olFeature);\r\n                        self.parent.trigger(TC.Consts.event.FEATURESUNSELECT, { feature: olFeature._wrap.parent });\r\n                    }\r\n                    olLayer.getSource().removeFeature(olFeature);\r\n                    self.parent.trigger(TC.Consts.event.FEATUREREMOVE, { feature: olFeature._wrap.parent });\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    //TC.wrap.control.Edit.prototype.clearSession = function () {\r\n    //    var self = this;\r\n    //    delete self.session;\r\n    //};\r\n\r\n    TC.wrap.Feature.prototype.toGML = function (version, srsName) {\r\n        var parser = new ol.format.GML();\r\n        var xml = parser.writeGeometryNode(this.feature.getGeometry(), {\r\n            dataProjection: srsName\r\n        });\r\n        //reemplazo todos los <loquesea por <gml:loquesea y </loquesea por </gml:loquesea\r\n        return new XMLSerializer().serializeToString(xml.firstChild).replace(/\\<\\/?\\w/gm, function (str) { var pos = str.indexOf(\"/\") > 0 ? str.indexOf(\"/\") + 1 : 1; return str.substring(0, pos) + \"gml:\" + str.substring(pos) })\r\n        //return new XMLSerializer().serializeToString(xml.firstChild).replace(/\\</gm, \"<gml:\");\r\n    };\r\n\r\n\r\n    TC.wrap.Feature.prototype.toGeoJSON = function () {\r\n        var parser = new ol.format.GeoJSON();\r\n        return parser.writeGeometry(this.feature.getGeometry());\r\n    };\r\n\r\n    TC.wrap.Geometry.write = function (options) {\r\n        options = options || {};\r\n        var geometry;\r\n        switch (options.format) {\r\n            default:\r\n                options.parser = new ol.format.GeoJSON();\r\n        };\r\n        switch (options.type) {\r\n            case TC.Consts.geom.POLYLINE:\r\n                geometry = new ol.geom.LineString(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.POLYGON:\r\n                geometry = new ol.geom.Polygon(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.MULTIPOINT:\r\n                geometry = new ol.geom.MultiPoint(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.MULTIPOLYLINE:\r\n                geometry = new ol.geom.MultiLineString(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.MULTIPOLYGON:\r\n                geometry = new ol.geom.MultiPolygon(options.coordinates);\r\n                break;\r\n            case TC.Consts.geom.POINT:\r\n            default:\r\n                geometry = new ol.geom.Point(options.coordinates);\r\n                break;\r\n        };\r\n        return options.parser.writeGeometry(geometry);\r\n    };\r\n\r\n    TC.wrap.Geometry.toGeoJSON = function (options) {\r\n        return TC.wrap.Geometry.write(options);\r\n    };\r\n\r\n    return ol;\r\n});\r\n"],"file":"../../ol/ol.min.js"}