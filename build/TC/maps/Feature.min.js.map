{"version":3,"sources":["Feature.js"],"names":["TC","feature","Feature","coords","options","this","wrap","parent","isNative","_wrap","id","getId","geometry","getGeometry","_folders","folders","data","getData","opts","Util","extend","getUID","_visibilityState","Consts","visibility","VISIBLE","undefined","showsPopup","layer","_selected","selected","select","prototype","STYLETYPE","geom","POLYGON","CLASSNAME","getPath","result","group","setVisibility","visible","self","popup","map","getControlsByClass","control","Popup","filter","currentFeature","length","p","isVisible","hide","NOT_VISIBLE","setFeatureVisibility","setId","getBounds","setStyle","style","toggleSelectedStyle","condition","_hasSelectedStyle","getLegend","_legend","getCoords","getCoordsArray","isPoint","elm","Array","isArray","flattenFn","val","reduce","reduceFn","acc","concat","getGeometryStride","firstCoord","setCoords","toNumberCoords","arr","forEach","idx","console","log","parseFloat","setGeometry","setData","unsetData","key","clearData","getInfo","locale","getMapLocale","template","getTemplate","replace","match","p1","html","hSlots","openText","getLocaleString","titleText","formatValue","value","isURL","formatNumber","recursiva","i","Object","headers","unshift","join","title","clone","nativeClone","cloneFeature","constructor","getStyle","showPopup","ctlPromise","popups","len","caller","Promise","resolve","addControl","then","ctl","attrTable","contentDiv","querySelector","querySelectorAll","maxWidth","getBoundingClientRect","width","h","trigger","event","POPUP","fitToView","showResultsPanel","resultsPanelOptions","content","titles","main","max","controlContainer","position","POSITION","RIGHT","div","document","createElement","appendChild","ControlContainer","ResultsPanel","ctrl","close","chart","menuDiv","innerHTML","open","getInfoContainer","onViewChange","e","off","VIEWCHANGE","on","selectedFeatures","push","selectionOptions","selection","Cfg","styles","unselect","indexOf","splice","isSelected","toGML","version","srsName"],"mappings":"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","sourcesContent":["TC.feature = TC.feature || {};\r\nTC.Feature = function (coords, options) {\r\n    var self = this;\r\n\r\n    self.wrap = new TC.wrap.Feature();\r\n    self.wrap.parent = self;\r\n    if (self.wrap.isNative(coords)) {\r\n        self.wrap.feature = coords;\r\n        coords._wrap = self.wrap;\r\n        self.id = self.wrap.getId();\r\n        self.geometry = self.wrap.getGeometry();\r\n        if (coords._folders) {\r\n            self.folders = coords._folders;\r\n        }\r\n        self.data = self.wrap.getData();\r\n    }\r\n\r\n    var opts = self.options = TC.Util.extend(true, {}, options);\r\n\r\n    self.id = self.id || opts.id || TC.getUID();\r\n    self.data = opts.data || self.data || null;\r\n    self._visibilityState = TC.Consts.visibility.VISIBLE;\r\n    if (opts.showsPopup === undefined) {\r\n        self.showsPopup = true;\r\n    }\r\n    else {\r\n        self.showsPopup = opts.showsPopup;\r\n    }\r\n    self.layer = opts.layer || null;\r\n    self._selected = false;\r\n\r\n    if (opts.selected) {\r\n        self.select();\r\n    }\r\n};\r\n\r\nTC.Feature.prototype.STYLETYPE = TC.Consts.geom.POLYGON;\r\n\r\nTC.Feature.prototype.CLASSNAME = 'TC.Feature';\r\n\r\nTC.Feature.prototype.getPath = function () {\r\n    var result = [];\r\n    var self = this;\r\n    if (self.folders) {\r\n        result = self.folders;\r\n    }\r\n    else if (self.options.group) {\r\n        result = [self.options.group];\r\n    }\r\n    return result;\r\n};\r\n\r\nTC.Feature.prototype.setVisibility = function (visible) {\r\n    var self = this;\r\n\r\n    // Ocultamos el posible popup\r\n    if (!visible && self.showsPopup && self.layer) {\r\n        var popup = self.layer.map.getControlsByClass(TC.control.Popup).filter(function (popup) {\r\n            return popup.currentFeature === self\r\n        });\r\n\r\n        if (popup.length > 0) {\r\n            const p = popup[0];\r\n            if (p.isVisible()) {\r\n                p.hide();\r\n            }\r\n        }\r\n    }\r\n\r\n    if ((visible && self._visibilityState === TC.Consts.visibility.NOT_VISIBLE) || (!visible && self._visibilityState === TC.Consts.visibility.VISIBLE)) {\r\n        self._visibilityState = visible ? TC.Consts.visibility.VISIBLE : TC.Consts.visibility.NOT_VISIBLE;\r\n        self.layer.wrap.setFeatureVisibility(self, visible);\r\n    }\r\n};\r\n\r\nTC.Feature.prototype.setId = function (id) {\r\n    var self = this;\r\n    self.id = id;\r\n    self.wrap.setId(id);\r\n};\r\n\r\nTC.Feature.prototype.getBounds = function () {\r\n    return this.wrap.getBounds();\r\n};\r\n\r\nTC.Feature.prototype.setStyle = function (style) {\r\n    this.wrap.setStyle(style);\r\n};\r\n\r\nTC.Feature.prototype.toggleSelectedStyle = function (condition) {\r\n    const self = this;\r\n    if (self._hasSelectedStyle != condition) {\r\n        self._hasSelectedStyle = condition;\r\n        self.wrap.toggleSelectedStyle(condition);\r\n    }\r\n};\r\n\r\nTC.Feature.prototype.getLegend = function () {\r\n    var self = this;\r\n    if (!self._legend) {\r\n        self._legend = self.wrap.getLegend();\r\n    }\r\n    return self._legend;\r\n};\r\n\r\nTC.Feature.prototype.getCoords = function () {\r\n    const self = this;\r\n    self.geometry = self.wrap.getGeometry();\r\n    return self.geometry;\r\n};\r\n\r\nTC.Feature.prototype.getCoordsArray = function () {\r\n    const self = this;\r\n    const isPoint = function (elm) {\r\n        return Array.isArray(elm) && elm.length >= 2 && typeof elm[0] === 'number' && typeof elm[1] === 'number';\r\n    };\r\n    const flattenFn = function (val) {\r\n        return isPoint(val) ? [val] : val.reduce(reduceFn, []);\r\n    }\r\n    const reduceFn = function (acc, elm) {\r\n        if (isPoint(elm)) {\r\n            acc[acc.length] = elm;\r\n        }\r\n        else {\r\n            acc = acc.concat(flattenFn(elm));\r\n        }\r\n        return acc;\r\n    };\r\n    return flattenFn(self.getCoords());\r\n};\r\n\r\nTC.Feature.prototype.getGeometryStride = function () {\r\n    const self = this;\r\n    const coordsArray = self.getCoordsArray();\r\n    const firstCoord = coordsArray[0];\r\n    if (firstCoord) {\r\n        return firstCoord.length;\r\n    }\r\n    return 0;\r\n}\r\n\r\n\r\nTC.Feature.prototype.setCoords = function (coords) {\r\n    const self = this;\r\n\r\n    const toNumberCoords = function (arr) {\r\n        arr.forEach(function (elm, idx) {\r\n            if (Array.isArray(elm)) {\r\n                toNumberCoords(elm);\r\n            }\r\n            else {\r\n                if (elm === null) {\r\n                    arr[idx] = 0;\r\n                }\r\n                else if (typeof elm !== 'number') {\r\n                    console.log('Warning: coordinate does not have number type');\r\n                    arr[idx] = parseFloat(elm);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    if (Array.isArray(coords)) {\r\n        toNumberCoords(coords);\r\n    }\r\n\r\n    self.geometry = coords;\r\n    return self.wrap.setGeometry(coords);\r\n};\r\n\r\nTC.Feature.prototype.getData = function () {\r\n    var result = null;\r\n    var self = this;\r\n    if (self.data) {\r\n        result = self.data;\r\n    }\r\n    else {\r\n        result = self.wrap.getData();\r\n    }\r\n    return result;\r\n};\r\n\r\nTC.Feature.prototype.setData = function (data) {\r\n    const self = this;\r\n    self.data = TC.Util.extend(self.data, data);\r\n    self.wrap.setData(data);\r\n};\r\n\r\nTC.Feature.prototype.unsetData = function (key) {\r\n    const self = this;\r\n    delete self.data[key];\r\n    self.wrap.unsetData(key);\r\n};\r\n\r\nTC.Feature.prototype.clearData = function () {\r\n    const self = this;\r\n    self.data = {};\r\n    self.wrap.clearData();\r\n};\r\n\r\nTC.Feature.prototype.getInfo = function (options) {\r\n    var result = null;\r\n    var self = this;\r\n    options = options || {};\r\n    var locale = options.locale || (self.layer && self.layer.map && TC.Util.getMapLocale(self.layer.map));\r\n    var data = self.getData();\r\n    if (typeof data === 'object') {\r\n        var template = self.wrap.getTemplate();\r\n        if (template) {\r\n            // GLS: Contemplo en la expresión regular la opción de que el nombre del campo se componga de $[aaa/abc/loQueMeInteresa] \r\n            // (la expresión no está limitada a 2 niveles), hasta ahora se manejaba $[loQueMeInteresa]\r\n            result = template.replace(/\\$\\[?(?:\\w+\\/)*(\\w+)\\]/g, function (match, p1) {\r\n                return data[p1];\r\n            });\r\n        }\r\n        else {\r\n            var html = [];\r\n            const hSlots = [];\r\n            const openText = TC.Util.getLocaleString(locale, 'open');\r\n            const titleText = TC.Util.getLocaleString(locale, 'linkInNewWindow');\r\n            const formatValue = function (value) {\r\n                var html = [];\r\n                var isUrl = TC.Util.isURL(value);\r\n                if (isUrl) {\r\n                    html[html.length] = '<a href=\"';\r\n                    html[html.length] = value;\r\n                    html[html.length] = '\" target=\"_blank\" title=\"';\r\n                    html[html.length] = titleText;\r\n                    html[html.length] = '\">';\r\n                    html[html.length] = openText;\r\n                    html[html.length] = '</a>';\r\n                }\r\n                else {\r\n                    html[html.length] = value !== undefined ? (typeof (value) === \"number\"?TC.Util.formatNumber(value, locale):value) : '&mdash;';\r\n                }\r\n                return html;\r\n            }\r\n            const recursiva = function (data) {\r\n                var html = [];\r\n                if (data instanceof Array) {\r\n                    html[html.length] = '<div class=\"complexAttr\">';\r\n                    var id = 'complexAttr_' + TC.getUID()\r\n                    html[html.length] = '<input type=\"checkbox\" id=\"' + id + '\" />';\r\n                    html[html.length] = '<div>';\r\n                    html[html.length] = '<label for=\"' + id + '\" title=\"\" class=\"plus\"></label>';\r\n                    html[html.length] = '<label for=\"' + id + '\" title=\"\" class=\"title\">' + data.length + ' ' + TC.Util.getLocaleString(locale, 'featureInfo.complexData.array') + '</label><br/>';\r\n                    html[html.length] = '<table class=\"complexAttr\"><tbody>';\r\n                    for (var i = 0; i < data.length; i++) {\r\n                        html[html.length] = '<tr><td>';\r\n                        html = html.concat(recursiva(data[i]));\r\n                        html[html.length] = '</td></tr>';\r\n                    }\r\n                    html[html.length] = '</tbody></table></div></div>';\r\n                } else if (data instanceof Object) {\r\n                    html[html.length] = '<table class=\"complexAttr\"><tbody>';\r\n                    for (var i in data) {\r\n                        html[html.length] = '<tr>';\r\n                        if (data[i] && data[i] instanceof Array) {\r\n                            html[html.length] = '<th style=\"display:none\">' + i + '</th><td>'\r\n                            html[html.length] = '<label for=\"' + id + '\" class=\"title\">' + i + '</label><br/>';\r\n                            html = html.concat(recursiva(data[i]));\r\n                            html[html.length] = '</div></td>';\r\n                        }\r\n                        else if (data[i] && data[i] instanceof Object) {\r\n                            //if(data[i] && Object.entries(data[i]).some((item)=>{return item[1] instanceof Object})){\t\t\t\t\t\t\r\n                            var id = 'complexAttr_' + TC.getUID()\r\n                            html[html.length] = '<th style=\"display:none\">' + i + '</th><td>';\r\n                            html[html.length] = '<input type=\"checkbox\" id=\"' + id + '\" /><div>';\r\n                            html[html.length] = '<label for=\"' + id + '\" title=\"\" class=\"plus\"></label>';\r\n                            html[html.length] = '<label for=\"' + id + '\" title=\"\" class=\"title\">' + i + '</label><br/>';\r\n                            html = html.concat(recursiva(data[i]));\r\n                            html[html.length] = '</div></td>';\r\n                        }\r\n                        else {\r\n                            html[html.length] = '<th class=\"key\">' + i + '</th>';\r\n                            html[html.length] = '<td class=\"value\">';\r\n                            html = html.concat(recursiva(data[i]));\r\n                            html[html.length] = '</td>';\r\n                        }\r\n                        html[html.length] = '</tr>';\r\n                    }\n                    html[html.length] = '</tbody></table>';\n                } else {\n                    html = html.concat(formatValue(data));\n                }\n                return html;\n            };\r\n            for (var key in data) {\r\n                const value = data[key];\r\n                const match = key.match(/^h(\\d)_/i);\r\n                if (match) {\r\n                    hSlots[match[1]] = value;\r\n                }\r\n                else {\r\n                    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'undefined') {\r\n                        html[html.length] = '<tr><th>';\r\n                        html[html.length] = key;\r\n                        html[html.length] = '</th><td>';\r\n                        html = html.concat(formatValue(value));\r\n                        html[html.length] = '</td></tr>';\r\n                    }\r\n                    else {\r\n                        html[html.length] = '<tr><th>';\r\n                        html[html.length] = key;\r\n                        html[html.length] = '</th><td>';\r\n                        html = html.concat(recursiva(value))\r\n                        html[html.length] = '</td></tr>';\r\n\r\n                    }\r\n                }\r\n            }\r\n            const headers = hSlots\r\n                .map(function (val, idx) {\r\n                    if (val) {\r\n                        return '<h' + idx + '>' + val + '</h' + idx + '>';\r\n                    }\r\n                })\r\n                .filter(function (val) {\r\n                    return val;\r\n                });\r\n            if (headers.length) {\r\n                html = headers.concat(html);\r\n            }\r\n            if (html.length > 0) {\r\n                html.unshift('<table class=\"tc-attr\">');\r\n                html[html.length] = '</table>';\r\n                result = html.join('');\r\n            }\r\n        }\r\n    }\r\n    else if (typeof data === 'string') {\r\n        result = data;\r\n    }\r\n    if (!result) {\r\n        result = self.title;\r\n        if (self.group) {\r\n            result += ' ' + self.group;\r\n        }\r\n    }\r\n    if (!result) {\r\n        result = TC.Util.getLocaleString(locale, 'noData');\r\n    }\r\n    return result;\r\n};\r\n\r\nTC.Feature.prototype.clone = function () {\r\n    var self = this;\r\n    var nativeClone = self.wrap.cloneFeature();\r\n    nativeClone._wrap = self.wrap;\r\n    return new self.constructor(nativeClone, self.options);\r\n};\r\n\r\nTC.Feature.prototype.getStyle = function () {\r\n    return this.wrap.getStyle();\r\n};\r\n\r\nTC.Feature.prototype.showPopup = function (control) {\r\n    const self = this;\r\n    const map = (self.layer && self.layer.map) || (control && control.map);\r\n    if (map) {\r\n        var ctlPromise;\r\n        var popup = control || self.popup;\r\n        if (!popup) {\r\n            // Buscamos un popup existente que no esté asociado a un control.\r\n            var popups = map.getControlsByClass('TC.control.Popup');\r\n            for (var i = 0, len = popups.length; i < len; i++) {\r\n                var p = popups[i];\r\n                if (!p.caller) {\r\n                    popup = p;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        if (popup) {\r\n            popup.currentFeature = self;\r\n            ctlPromise = Promise.resolve(popup);\r\n        }\r\n        else {\r\n            ctlPromise = map.addControl('popup');\r\n        }\r\n        ctlPromise.then(function (ctl) {\r\n            ctl.currentFeature = self;\r\n            map.getControlsByClass(TC.control.Popup)\r\n                .filter(p => p !== ctl && p.isVisible())\r\n                .forEach(p => p.hide());\r\n            self.wrap.showPopup(ctl);\r\n            // Ajustamos el ancho del título al de la tabla de atributos\r\n            const attrTable = ctl.contentDiv.querySelector(\"table.tc-attr\");\r\n            const headers = ctl.contentDiv.querySelectorAll(\"h1,h2,h3,h4,h5\");\r\n            if (attrTable && headers.length) {\r\n                const maxWidth = attrTable.getBoundingClientRect().width + 'px';\r\n                headers.forEach(function (h) {\r\n                    h.style.maxWidth = maxWidth;\r\n                });\r\n            }\r\n            map.trigger(TC.Consts.event.POPUP, { control: ctl });\r\n            ctl.fitToView(true);\r\n        });\r\n    }\r\n};\r\n\r\nTC.Feature.prototype.showResultsPanel = function (control) {\r\n    const self = this;\r\n    const map = (self.layer && self.layer.map) || (control && control.map);\r\n    if (map) {\r\n        var ctlPromise;\r\n\r\n        var resultsPanelOptions = {\r\n            content: \"table\",\r\n            titles: {\r\n                main: TC.Util.getLocaleString(map.options.locale, \"rsp.title\"),\r\n                max: TC.Util.getLocaleString(map.options.locale, \"rsp.title\")\r\n            }\r\n        };\r\n        var controlContainer = map.getControlsByClass('TC.control.ControlContainer')[0];\r\n        if (controlContainer) {\r\n            resultsPanelOptions.position = controlContainer.POSITION.RIGHT;\r\n            ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n        } else {\r\n            resultsPanelOptions.div = document.createElement('div');\r\n            map.div.appendChild(resultsPanelOptions.div);\r\n            ctlPromise = map.addControl('resultsPanel', resultsPanelOptions);\r\n        }\r\n\r\n        ctlPromise.then(function (ctl) {\r\n            ctl.currentFeature = self;\r\n\r\n            // GLS: si contamos con el contenedor de controles no es necesario cerra el resto de paneles ya que no habrá solape excepto los paneles\r\n            if (map.getControlsByClass(TC.control.ControlContainer).length === 0) {\r\n                map.getControlsByClass(TC.control.ResultsPanel).filter(function (ctrl) { return ctrl.options.content === \"table\" }).forEach(function (p) {\r\n                    p.close();\r\n                });\r\n            }\r\n\r\n            // cerramos los paneles con feature asociada que no sean gráfico\r\n            const panels = map.getControlsByClass('TC.control.ResultsPanel');\r\n            panels.forEach(function (p) {\r\n                if (p.currentFeature && !p.chart) {\r\n                    p.close();\r\n                }\r\n            });\r\n\r\n            ctl.menuDiv.innerHTML = '';\r\n            ctl.open(self.getInfo({ locale: map.options.locale }), ctl.getInfoContainer());\r\n\r\n            var onViewChange = function (e) {\r\n                map.off(TC.Consts.event.VIEWCHANGE, onViewChange);\r\n\r\n                ctl.close();\r\n            };\r\n            map.on(TC.Consts.event.VIEWCHANGE, onViewChange);\r\n        });\r\n    }\r\n};\r\n\r\n\r\nTC.Feature.prototype.select = function () {\r\n    var self = this;\r\n    self._selected = true;\r\n    if (self.layer) {\r\n        self.layer.selectedFeatures.push(self);\r\n    }\r\n    var selectionOptions = self.options.selection || {};\r\n    self.setStyle(TC.Util.extend({}, TC.Cfg.styles.selection[self.STYLETYPE], selectionOptions[self.STYLETYPE]));\r\n};\r\n\r\nTC.Feature.prototype.unselect = function () {\r\n    const self = this;\r\n    self._selected = false;\r\n    // Volvemos al estilo por defecto\r\n    self.setStyle(self.options);\r\n\r\n    if (self.layer) {\r\n        const idx = self.layer.selectedFeatures.indexOf(self);\r\n        if (idx >= 0) {\r\n            self.layer.selectedFeatures.splice(idx, 1);\r\n        }\r\n    }\r\n};\r\n\r\nTC.Feature.prototype.isSelected = function () {\r\n    return this._selected;\r\n};\r\n\r\nTC.Feature.prototype.toGML = function (version, srsName) {\r\n    return this.wrap.toGML(version, srsName);\r\n};\r\n\r\n\r\n"]}