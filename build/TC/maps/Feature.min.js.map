{"version":3,"sources":["Feature.js"],"names":["TC","feature","Feature","coords","options","this","wrap","parent","isNative","_wrap","id","getId","geometry","getGeometry","_folders","folders","data","getData","opts","Util","extend","getUID","_visibilityState","Consts","visibility","VISIBLE","undefined","showsPopup","layer","_selected","selected","select","prototype","STYLETYPE","geom","POLYGON","CLASSNAME","getPath","result","group","setVisibility","visible","self","popup","map","getControlsByClass","control","Popup","filter","currentFeature","length","hide","NOT_VISIBLE","setFeatureVisibility","setId","getBounds","setStyle","style","toggleSelectedStyle","condition","getLegend","_legend","getCoords","getCoordsArray","isPoint","elm","Array","isArray","flattenFn","val","reduce","reduceFn","acc","concat","getGeometryStride","firstCoord","setCoords","toNumberCoords","arr","forEach","idx","console","log","parseFloat","setGeometry","setData","clearData","getInfo","locale","getMapLocale","template","getTemplate","replace","match","p1","html","hSlots","openText","getLocaleString","titleText","key","value","isURL","formatNumber","headers","unshift","join","title","clone","nativeClone","cloneFeature","constructor","getStyle","showPopup","ctlPromise","popups","i","len","p","caller","Promise","resolve","addControl","then","ctl","isVisible","attrTable","contentDiv","querySelector","querySelectorAll","maxWidth","getBoundingClientRect","width","h","trigger","event","POPUP","fitToView","showResultsPanel","panel","resultsPanels","ctrl","content","resultsPanelOptions","controlContainer","side","SIDE","RIGHT","div","document","createElement","appendChild","ControlContainer","ResultsPanel","close","remove","menuDiv","innerHTML","open","getInfoContainer","onViewChange","e","off","VIEWCHANGE","on","selectedFeatures","push","selectionOptions","selection","Cfg","styles","unselect","indexOf","splice","isSelected","toGML","version","srsName"],"mappings":"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","sourcesContent":["TC.feature = TC.feature || {};\r\nTC.Feature = function (coords, options) {\r\n    var self = this;\r\n\r\n    self.wrap = new TC.wrap.Feature();\r\n    self.wrap.parent = self;\r\n    if (self.wrap.isNative(coords)) {\r\n        self.wrap.feature = coords;\r\n        coords._wrap = self.wrap;\r\n        self.id = self.wrap.getId();\r\n        self.geometry = self.wrap.getGeometry();\r\n        if (coords._folders) {\r\n            self.folders = coords._folders;\r\n        }\r\n        self.data = self.wrap.getData();\r\n    }\r\n\r\n    var opts = self.options = TC.Util.extend(true, {}, options);\r\n\r\n    self.id = self.id || opts.id || TC.getUID();\r\n    self.data = opts.data || self.data || null;\r\n    self._visibilityState = TC.Consts.visibility.VISIBLE;\r\n    if (opts.showsPopup === undefined) {\r\n        self.showsPopup = true;\r\n    }\r\n    else {\r\n        self.showsPopup = opts.showsPopup;\r\n    }\r\n    self.layer = opts.layer || null;\r\n    self._selected = false;\r\n\r\n    if (opts.selected) {\r\n        self.select();\r\n    }\r\n};\r\n\r\nTC.Feature.prototype.STYLETYPE = TC.Consts.geom.POLYGON;\r\n\r\nTC.Feature.prototype.CLASSNAME = 'TC.Feature';\r\n\r\nTC.Feature.prototype.getPath = function () {\r\n    var result = [];\r\n    var self = this;\r\n    if (self.folders) {\r\n        result = self.folders;\r\n    }\r\n    else if (self.options.group) {\r\n        result = [self.options.group];\r\n    }\r\n    return result;\r\n};\r\n\r\nTC.Feature.prototype.setVisibility = function (visible) {\r\n    var self = this;\r\n\r\n    // Ocultamos el posible popup\r\n    if (!visible && self.showsPopup && self.layer) {\r\n        var popup = self.layer.map.getControlsByClass(TC.control.Popup).filter(function (popup) {\r\n            return popup.currentFeature === self\r\n        });\r\n\r\n        if (popup.length > 0) {\r\n            popup[0].hide();\r\n        }\r\n    }\r\n\r\n    if ((visible && self._visibilityState === TC.Consts.visibility.NOT_VISIBLE) || (!visible && self._visibilityState === TC.Consts.visibility.VISIBLE)) {\r\n        self._visibilityState = visible ? TC.Consts.visibility.VISIBLE : TC.Consts.visibility.NOT_VISIBLE;\r\n        self.layer.wrap.setFeatureVisibility(self, visible);\r\n    }\r\n};\r\n\r\nTC.Feature.prototype.setId = function (id) {\r\n    var self = this;\r\n    self.id = id;\r\n    self.wrap.setId(id);\r\n};\r\n\r\nTC.Feature.prototype.getBounds = function () {\r\n    return this.wrap.getBounds();\r\n};\r\n\r\nTC.Feature.prototype.setStyle = function (style) {\r\n    this.wrap.setStyle(style);\r\n};\r\n\r\nTC.Feature.prototype.toggleSelectedStyle = function (condition) {\r\n    this.wrap.toggleSelectedStyle(condition);\r\n};\r\n\r\nTC.Feature.prototype.getLegend = function () {\r\n    var self = this;\r\n    if (!self._legend) {\r\n        self._legend = self.wrap.getLegend();\r\n    }\r\n    return self._legend;\r\n};\r\n\r\nTC.Feature.prototype.getCoords = function () {\r\n    const self = this;\r\n    self.geometry = self.wrap.getGeometry();\r\n    return self.geometry;\r\n};\r\n\r\nTC.Feature.prototype.getCoordsArray = function () {\r\n    const self = this;\r\n    const isPoint = function (elm) {\r\n        return Array.isArray(elm) && elm.length >= 2 && typeof elm[0] === 'number' && typeof elm[1] === 'number';\r\n    };\r\n    const flattenFn = function (val) {\r\n        return isPoint(val) ? [val] : val.reduce(reduceFn, []);\r\n    }\r\n    const reduceFn = function (acc, elm) {\r\n        if (isPoint(elm)) {\r\n            acc[acc.length] = elm;\r\n        }\r\n        else {\r\n            acc = acc.concat(flattenFn(elm));\r\n        }\r\n        return acc;\r\n    };\r\n    return flattenFn(self.getCoords());\r\n};\r\n\r\nTC.Feature.prototype.getGeometryStride = function () {\r\n    const self = this;\r\n    const coordsArray = self.getCoordsArray();\r\n    const firstCoord = coordsArray[0];\r\n    if (firstCoord) {\r\n        return firstCoord.length;\r\n    }\r\n    return 0;\r\n}\r\n\r\n\r\nTC.Feature.prototype.setCoords = function (coords) {\r\n    const self = this;\r\n\r\n    const toNumberCoords = function (arr) {\r\n        arr.forEach(function (elm, idx) {\r\n            if (Array.isArray(elm)) {\r\n                toNumberCoords(elm);\r\n            }\r\n            else {\r\n                if (typeof elm !== 'number') {\r\n                    console.log('Warning: coordinate does not have number type');\r\n                    arr[idx] = parseFloat(elm);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    if (Array.isArray(coords)) {\r\n        toNumberCoords(coords);\r\n    }\r\n\r\n    self.geometry = coords;\r\n    return self.wrap.setGeometry(coords);\r\n};\r\n\r\nTC.Feature.prototype.getData = function () {\r\n    var result = null;\r\n    var self = this;\r\n    if (self.data) {\r\n        result = self.data;\r\n    }\r\n    else {\r\n        result = self.wrap.getData();\r\n    }\r\n    return result;\r\n};\r\n\r\nTC.Feature.prototype.setData = function (data) {\r\n    var self = this;\r\n    self.data = TC.Util.extend(self.data, data);\r\n    self.wrap.setData(data);\r\n};\r\n\r\nTC.Feature.prototype.clearData = function () {\r\n    var self = this;\r\n    self.data = {};\r\n    self.wrap.clearData();\r\n};\r\n\r\nTC.Feature.prototype.getInfo = function (options) {\r\n    var result = null;\r\n    var self = this;\r\n    options = options || {};\r\n    var locale = options.locale || (self.layer && self.layer.map && TC.Util.getMapLocale(self.layer.map));\r\n    var data = self.getData();\r\n    if (typeof data === 'object') {\r\n        var template = self.wrap.getTemplate();\r\n        if (template) {\r\n            // GLS: Contemplo en la expresión regular la opción de que el nombre del campo se componga de $[aaa/abc/loQueMeInteresa] \r\n            // (la expresión no está limitada a 2 niveles), hasta ahora se manejaba $[loQueMeInteresa]\r\n            result = template.replace(/\\$\\[?(?:\\w+\\/)*(\\w+)\\]/g, function (match, p1) {\r\n                return data[p1];\r\n            });\r\n        }\r\n        else {\r\n            var html = [];\r\n            const hSlots = [];\r\n            const openText = TC.Util.getLocaleString(locale, 'open');\r\n            const titleText = TC.Util.getLocaleString(locale, 'linkInNewWindow');\r\n            for (var key in data) {\r\n                const value = data[key];\r\n                const match = key.match(/^h(\\d)_/i);\r\n                if (match) {\r\n                    hSlots[match[1]] = value;\r\n                }\r\n                else {\r\n                    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'undefined') {\r\n                        html[html.length] = '<tr><th>';\r\n                        html[html.length] = key;\r\n                        html[html.length] = '</th><td>';\r\n                        var isUrl = TC.Util.isURL(value);\r\n                        if (isUrl) {\r\n                            html[html.length] = '<a href=\"';\r\n                            html[html.length] = value;\r\n                            html[html.length] = '\" target=\"_blank\" title=\"';\r\n                            html[html.length] = titleText;\r\n                            html[html.length] = '\">';\r\n                            html[html.length] = openText;\r\n                            html[html.length] = '</a>';\r\n                        }\r\n                        else {\r\n                            html[html.length] = value !== undefined ? TC.Util.formatNumber(value, locale) : '&mdash;';\r\n                        }\r\n                        html[html.length] = '</td></tr>';\r\n                    }\r\n                }\r\n            }\r\n            const headers = hSlots\r\n                .map(function (val, idx) {\r\n                    if (val) {\r\n                        return '<h' + idx + '>' + val + '</h' + idx + '>';\r\n                    }\r\n                })\r\n                .filter(function (val) {\r\n                    return val;\r\n                });\r\n            if (headers.length) {\r\n                html = headers.concat(html);\r\n            }\r\n            if (html.length > 0) {\r\n                html.unshift('<table class=\"tc-attr\">');\r\n                html[html.length] = '</table>';\r\n                result = html.join('');\r\n            }\r\n        }\r\n    }\r\n    else if (typeof data === 'string') {\r\n        result = data;\r\n    }\r\n    if (!result) {\r\n        result = self.title;\r\n        if (self.group) {\r\n            result += ' ' + self.group;\r\n        }\r\n    }\r\n    if (!result) {\r\n        result = TC.Util.getLocaleString(locale, 'noData');\r\n    }\r\n    return result;\r\n};\r\n\r\nTC.Feature.prototype.clone = function () {\r\n    var self = this;\r\n    var nativeClone = self.wrap.cloneFeature();\r\n    nativeClone._wrap = self.wrap;\r\n    return new self.constructor(nativeClone, self.options);\r\n};\r\n\r\nTC.Feature.prototype.getStyle = function () {\r\n    return this.wrap.getStyle();\r\n};\r\n\r\nTC.Feature.prototype.showPopup = function (control) {\r\n    const self = this;\r\n    const map = (self.layer && self.layer.map) || (control && control.map);\r\n    if (map) {\r\n        var ctlPromise;\r\n        var popup = control || self.popup;\r\n        if (!popup) {\r\n            // Buscamos un popup existente que no esté asociado a un control.\r\n            var popups = map.getControlsByClass('TC.control.Popup');\r\n            for (var i = 0, len = popups.length; i < len; i++) {\r\n                var p = popups[i];\r\n                if (!p.caller) {\r\n                    popup = p;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        if (popup) {\r\n            popup.currentFeature = self;\r\n            ctlPromise = Promise.resolve(popup);\r\n        }\r\n        else {\r\n            ctlPromise = map.addControl('popup');\r\n        }\r\n        ctlPromise.then(function (ctl) {            \r\n            ctl.currentFeature = self;\r\n            map.getControlsByClass(TC.control.Popup).forEach(function (p) {\r\n                if (p.isVisible()) {\r\n                    p.hide();\r\n                }\r\n            });\r\n            self.wrap.showPopup(ctl);\r\n            // Ajustamos el ancho del título al de la tabla de atributos\r\n            const attrTable = ctl.contentDiv.querySelector(\"table.tc-attr\");\r\n            const headers = ctl.contentDiv.querySelectorAll(\"h1,h2,h3,h4,h5\");\r\n            if (attrTable && headers.length) {\r\n                const maxWidth = attrTable.getBoundingClientRect().width + 'px';\r\n                headers.forEach(function (h) {\r\n                    h.style.maxWidth = maxWidth;\r\n                });\r\n            }\r\n            map.trigger(TC.Consts.event.POPUP, { control: ctl });\r\n            ctl.fitToView(true);\r\n        });\r\n    }\r\n};\r\n\r\nTC.Feature.prototype.showResultsPanel = function (control) {\r\n    const self = this;\r\n    const map = (self.layer && self.layer.map) || (control && control.map);\r\n    if (map) {\r\n        var ctlPromise;\r\n        var panel = control;\r\n        if (!panel) {\r\n            // Buscamos un resultsPanel existente que no esté asociado a un control.\r\n            var resultsPanels = map.getControlsByClass('TC.control.ResultsPanel').filter(function (ctrl) { return ctrl.options.content === \"table\" });\r\n            for (var i = 0, len = resultsPanels.length; i < len; i++) {\r\n                var p = resultsPanels[i];\r\n                if (!p.caller) {\r\n                    panel = p;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        if (panel) {\r\n            panel.currentFeature = self;\r\n            ctlPromise = Promise.resolve(panel);\r\n        }\r\n        else {\r\n            var resultsPanelOptions = {\r\n                content: \"table\"\r\n            };            \r\n            var controlContainer = map.getControlsByClass('TC.control.ControlContainer')[0];\r\n            if (controlContainer) {\r\n                resultsPanelOptions.side = controlContainer.SIDE.RIGHT;\r\n                ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n            } else {\r\n                resultsPanelOptions.div = document.createElement('div');\r\n                map.div.appendChild(resultsPanelOptions.div);\r\n                ctlPromise = map.addControl('resultsPanel', resultsPanelOptions);\r\n            }\r\n        }\r\n        ctlPromise.then(function (ctl) {            \r\n            ctl.currentFeature = self;\r\n\r\n            // GLS: si contamos con el contenedor de controles no es necesario cerra el resto de paneles ya que no habrá solape excepto los paneles\r\n            if (map.getControlsByClass(TC.control.ControlContainer).length === 0) {\r\n                map.getControlsByClass(TC.control.ResultsPanel).filter(function (ctrl) { return ctrl.options.content === \"table\" }).forEach(function (p) {\r\n                    p.close();\r\n                });\r\n            }\r\n\r\n            // cerramos los paneles con feature asociada\r\n            const panels = map.getControlsByClass('TC.control.ResultsPanel');\r\n            panels.forEach(function (p) {\r\n                if (p.currentFeature) {\r\n                    p.close();\r\n                }\r\n            });\r\n\r\n            if (ctl.div.querySelector('.tc-ctl-print-btn')) {\r\n                ctl.div.querySelector('.tc-ctl-print-btn').remove();\r\n            }\r\n            ctl.menuDiv.innerHTML = '';\r\n            ctl.open(self.getInfo({ locale: map.options.locale }), ctl.getInfoContainer());            \r\n\r\n            var onViewChange = function (e) {\r\n                map.off(TC.Consts.event.VIEWCHANGE, onViewChange);\r\n\r\n                ctl.close();\r\n            };\r\n            map.on(TC.Consts.event.VIEWCHANGE, onViewChange);\r\n        });\r\n    }\r\n};\r\n\r\n\r\nTC.Feature.prototype.select = function () {\r\n    var self = this;\r\n    self._selected = true;\r\n    if (self.layer) {\r\n        self.layer.selectedFeatures.push(self);\r\n    }\r\n    var selectionOptions = self.options.selection || {};\r\n    self.setStyle(TC.Util.extend({}, TC.Cfg.styles.selection[self.STYLETYPE], selectionOptions[self.STYLETYPE]));\r\n};\r\n\r\nTC.Feature.prototype.unselect = function () {\r\n    const self = this;\r\n    self._selected = false;\r\n    // Volvemos al estilo por defecto\r\n    self.setStyle(self.options);\r\n\r\n    if (self.layer) {\r\n        const idx = self.layer.selectedFeatures.indexOf(self);\r\n        if (idx >= 0) {\r\n            self.layer.selectedFeatures.splice(idx, 1);\r\n        }\r\n    }\r\n};\r\n\r\nTC.Feature.prototype.isSelected = function () {\r\n    return this._selected;\r\n};\r\n\r\nTC.Feature.prototype.toGML = function (version, srsName) {\r\n    return this.wrap.toGML(version, srsName);\r\n};\r\n\r\n\r\n"]}