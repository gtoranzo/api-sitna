{"version":3,"sources":["control/MapInfo.js"],"names":["TC","control","Control","syncLoadJS","apiLocation","MapInfo","apply","this","arguments","inherit","ctlProto","prototype","CLASS","register","map","self","result","call","QR_MAX_URL_LENGTH","SHORTEN_URL_LENGTH","exportsState","includeControls","undefined","options","ready","controlStates","state","ctl","_controlStatesLoaded","importControlStates","exportControlStates","controls","exportState","filter","key","hasOwnProperty","stateArray","forEach","getControlById","id","loaded","importState","featureToShare","sharedFeaturesLayer","layerState","clone","showsPopup","layer","features","crs","length","addLayer","getUID","owner","type","Consts","layerType","VECTOR","title","getLocaleString","stealth","then","zoomToFeatures","manageMaxLengthExceed","generateLink","currentUrl","window","location","href","hashPosition","indexOf","substring","extraParams","params","Util","getQueryStringParams","extend","qsPosition","concat","getParamString","getParameterByName","replace","push","extraStates","hashState","getMapState","url","browser","URL_MAX_LENGTH","qr","shortenedLink","wait","Promise","resolve","reject","onError","toast","msgType","ERROR","getLoadingIndicator","removeWait","start","end","generateLinkWithoutParams","addWait","tool","Proxification","data","FormData","append","proxify","allowedMixedContent","fetch","catch","error","shortenUrl","response","responseText","makeQRCode","codeContainer","width","height","loadJS","QRCode","text","MutationObserver","mutationsList","observer","srcMutation","mutation","attributeName","disconnect","target","src","observe","attributes","childList","subtree","drawScaleBarIntoCanvas","canvas","sb","getControlsByClass","ScaleBar","ctx","document","createElement","getContext","save","node","getElementsByClassName","item","boundingCR","getBoundingClientRect","textContent","beginPath","strokeStyle","getComputedStyle","borderColor","setSize","left","top","moveTo","lineTo","stroke","measureText","textPosition","x","y","fill","fillnode","fillBoundingCR","globalAlpha","fillStyle","backgroundColor","fillRect","drawFill","textColor","color","font","fontSize","fontFamily","textAlign","textBaseline","fillText","registerListeners","registeredListeners","on","event","LAYERADD","bind","LAYERREMOVE","FEATUREADD","FEATUREREMOVE","FEATURESCLEAR"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.control.MapInfo = function () {\r\n    var self = this;\r\n\r\n    TC.Control.apply(self, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.MapInfo, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.MapInfo.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-mi';\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self.QR_MAX_URL_LENGTH = 150;\r\n        self.SHORTEN_URL_LENGTH = 32715;\r\n\r\n        self.exportsState = false;\r\n\r\n        self.includeControls = self.options.includeControls === undefined || self.options.includeControls;\r\n\r\n        map.ready(function () {\r\n            const controlStates = map.state && map.state.ctl;\r\n            if (controlStates) {\r\n                if (!map._controlStatesLoaded) { // Para evitar que si hay varios controles Share cargados, cada uno importe por su cuenta.\r\n                    self.importControlStates(controlStates);\r\n                    map._controlStatesLoaded = true;\r\n                }\r\n            }\r\n        });\r\n\r\n        return result;\r\n    }\r\n\r\n    ctlProto.exportControlStates = function () {\r\n        const self = this;\r\n        if (self.map) {\r\n            return self.map.controls\r\n                .map(function (ctl) {\r\n                    return ctl.exportState();\r\n                })\r\n                .filter(function (state) {\r\n                    // Quitamos los estados nulos o vacíos\r\n                    if (state) {\r\n                        for (var key in state) {\r\n                            if (state.hasOwnProperty(key)) {\r\n                                return true;\r\n                            }\r\n                        }\r\n                    }\r\n                    return false;\r\n                });\r\n        }\r\n        return [];\r\n    };\r\n\r\n    ctlProto.importControlStates = function (stateArray) {\r\n        const self = this;\r\n        if (self.map) {\r\n            stateArray.forEach(function (state) {\r\n                const ctl = self.map.getControlById(state.id);\r\n                if (ctl) {\r\n                    self.map.loaded(function () {\r\n                        ctl.importState(state);\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState) {\r\n            const state = {};\r\n            if (self.featureToShare || self.sharedFeaturesLayer) {\r\n                var layerState;\r\n                state.id = self.id;\r\n                if (self.featureToShare) {\r\n                    const featureToShare = self.featureToShare.clone();\r\n                    featureToShare.showsPopup = true;\r\n                    layerState = self.featureToShare.layer.exportState({\r\n                        features: [featureToShare]\r\n                    });\r\n                }\r\n                else {\r\n                    layerState = self.sharedFeaturesLayer.exportState();\r\n                }\r\n                state.features = layerState.features;\r\n                if (layerState.crs) {\r\n                    state.crs = layerState.crs;\r\n                }\r\n            }\r\n            return state;\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        if (self.map && state.features.length) {\r\n            self.map.addLayer({\r\n                id: self.getUID(),\r\n                owner: self,\r\n                type: TC.Consts.layerType.VECTOR,\r\n                title: self.getLocaleString('foi'),\r\n                stealth: true\r\n            }).then(function (layer) {\r\n                self.sharedFeaturesLayer = layer;\r\n                layer.importState({ features: state.features, crs: state.crs }).then(function () {\r\n                    self.map.zoomToFeatures(layer.features);\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.manageMaxLengthExceed = function () {\r\n        throw \"Falta implementación del método manageMaxLengthExceed\";\r\n    };\r\n\r\n    ctlProto.generateLink = function () {\r\n        var self = this;\r\n\r\n        var currentUrl = window.location.href;\r\n        var hashPosition = currentUrl.indexOf('#');\r\n        if (hashPosition > 0) {\r\n            currentUrl = currentUrl.substring(0, hashPosition);\r\n        }\r\n\r\n        if (self.extraParams) {\r\n            // Hacemos merge de parámetros de URL\r\n            var params = TC.Util.getQueryStringParams(currentUrl);\r\n            TC.Util.extend(params, self.extraParams);\r\n            var qsPosition = currentUrl.indexOf('?');\r\n            if (qsPosition >= 0) {\r\n                currentUrl = currentUrl.substring(0, qsPosition);\r\n            }\r\n            currentUrl = currentUrl.concat('?', TC.Util.getParamString(params));\r\n        }\r\n\r\n        // eliminamos el parámetro del idioma, si no lo arrastramos al compartir\r\n        if (TC.Util.getParameterByName('lang').length > 0) {\r\n            if (currentUrl.indexOf('&') > -1) { // tenemos más parámetros en la url\r\n                currentUrl = currentUrl.replace(\"lang\" + \"=\" + TC.Util.getParameterByName('lang') + '&', '');\r\n            } else {\r\n                currentUrl = currentUrl.replace('?' + \"lang\" + \"=\" + TC.Util.getParameterByName('lang'), '');\r\n            }\r\n        }\r\n\r\n        const controlStates = self.includeControls ? self.exportControlStates() : [];\r\n        if (self.exportsState && (self.featureToShare || self.sharedFeaturesLayer)) {\r\n            controlStates.push(self.exportState());\r\n        }\r\n        const extraStates = controlStates.length ? { ctl: controlStates } : undefined;\r\n\r\n        var hashState = self.map.getMapState(extraStates);\r\n\r\n        var url = currentUrl.concat(\"#\", hashState);\r\n        self.manageMaxLengthExceed({ browser: url.length > TC.Consts.URL_MAX_LENGTH, qr: url.length > self.SHORTEN_URL_LENGTH });\r\n        return url;\r\n    };\r\n\r\n    ctlProto.shortenedLink = function () {\r\n        const self = this;\r\n        var wait;\r\n\r\n        const generateLinkWithoutParams = function () {\r\n            var url = self.generateLink();\r\n            var start = url.indexOf('?');\r\n            var end = url.indexOf('#');\r\n\r\n            //Borramos los parámetros de la URL y dejamos sólo el hash\r\n            if (start > 0) {\r\n                if (start < end) {\r\n                    url = url.replace(url.substring(start, end), '');\r\n                } else {\r\n                    url = url.replace(url.substring(start, url.length - 1), '');\r\n                }\r\n            }\r\n\r\n            return url;\r\n        };\r\n        const shortenUrl = function (url) {\r\n            var shortenServiceUrl = \"https://tinyurl.com/api-create.php\";\r\n\r\n            if (!TC.tool || !TC.tool.Proxification) {\r\n                TC.syncLoadJS(TC.apiLocation + 'TC/tool/Proxification');\r\n            }\r\n\r\n            var data = new FormData();\r\n            data.append(\"url\", url);\r\n\r\n            var toolProxification = new TC.tool.Proxification(TC.proxify, { allowedMixedContent: false });\r\n            return toolProxification.fetch(shortenServiceUrl, {\r\n                type: 'POST',\r\n                data: data\r\n            }).then(function (data) {\r\n                return data;\r\n            }).catch(function (error) {\r\n                return null;\r\n            });\r\n        };\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            const onError = function () {\r\n                self.map.toast(self.getLocaleString(\"urlTooLongForShortener\"), { type: TC.Consts.msgType.ERROR });\r\n                self.map.getLoadingIndicator().removeWait(wait);\r\n                resolve(\"\");\r\n            };\r\n\r\n            var url = generateLinkWithoutParams();\r\n\r\n            if (url.length > self.QR_MAX_URL_LENGTH && url.length < self.SHORTEN_URL_LENGTH) {\r\n\r\n                wait = self.map.getLoadingIndicator().addWait();\r\n\r\n                shortenUrl(url).then(function (response) {\r\n                    if (response && response.responseText) {\r\n                        self.map.getLoadingIndicator().removeWait(wait);\r\n                        resolve(response.responseText.replace('http://', 'https://'));\r\n                    } else {\r\n                        onError();\r\n                    }\r\n                }, onError);\r\n            } else {\r\n                if (url.length >= self.SHORTEN_URL_LENGTH) {\r\n                    onError();\r\n                }\r\n\r\n                resolve(\"\");\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.makeQRCode = function (codeContainer, width, height) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            TC.loadJS(\r\n                typeof QRCode === 'undefined',\r\n                [TC.apiLocation + 'lib/qrcode/qrcode.min.js'],\r\n                function () {\r\n                    self.shortenedLink().then(function (url) {\r\n                        url = url || \"\";\r\n                        if (url.length > 0) {\r\n                            var options = {\r\n                                text: url\r\n                            };\r\n\r\n                            if (width && height) {\r\n                                options.width = width;\r\n                                options.height = height;\r\n                            }\r\n\r\n                            var config = { attributes: true, childList: true, subtree: true };\r\n                            var observer = new MutationObserver(function (mutationsList, observer) {\r\n                                var srcMutation = mutationsList.filter(function (mutation) {\r\n                                    return mutation.type === \"attributes\"\r\n                                }).filter(function (mutation) {\r\n                                    return mutation.attributeName.indexOf('src') > -1;\r\n                                });\r\n\r\n                                if (srcMutation.length > 0) {\r\n                                    observer.disconnect();\r\n                                    resolve(srcMutation[0].target.src);\r\n                                }\r\n                            });\r\n                            observer.observe(codeContainer, config);\r\n                            new QRCode(codeContainer, options);\r\n                        } else {\r\n                            resolve();\r\n                        }\r\n                    });\r\n                });\r\n        });\r\n    };\r\n\r\n    ctlProto.drawScaleBarIntoCanvas = function (options) {\r\n        const self = this;\r\n        var canvas;\r\n        var sb = self.map.getControlsByClass(TC.control.ScaleBar);\r\n        if (sb.length == 0) {\r\n            return null;\r\n        }\r\n\r\n        options = options || {};\r\n\r\n        const drawFill = function (ctx, width, height) {\r\n            var elem = document.getElementsByClassName(sb[0].CLASS);\r\n            var fillnode = elem.item(0);\r\n            var fillBoundingCR = TC.Util.extend({}, fillnode.getBoundingClientRect());\r\n\r\n            fillBoundingCR.left = (options.left || 15) - 2;\r\n\r\n            fillBoundingCR.top = options.top || 15;\r\n            fillBoundingCR.top--;\r\n\r\n            ctx.globalAlpha = 0.5;\r\n            ctx.fillStyle = window.getComputedStyle(fillnode).backgroundColor;\r\n            width += 4;\r\n            height += 4;\r\n            ctx.fillRect(fillBoundingCR.left, fillBoundingCR.top, width, height);\r\n        };\r\n\r\n        if (!options.canvas) {\r\n            canvas = document.createElement('CANVAS');\r\n        } else {\r\n            canvas = options.canvas;\r\n        }\r\n\r\n        var ctx = canvas.getContext(\"2d\");\r\n        ctx.save();\r\n\r\n        var elem = document.getElementsByClassName(\"ol-scale-line-inner\");\r\n        var node = elem.item(0);\r\n        var boundingCR = TC.Util.extend({}, node.getBoundingClientRect());\r\n\r\n        var text = node.textContent;\r\n\r\n        ctx.beginPath();\r\n        ctx.strokeStyle = window.getComputedStyle(node).borderColor;\r\n\r\n        var width, height;\r\n\r\n        if (boundingCR.width > boundingCR.height) {\r\n\r\n            width = boundingCR.width;\r\n            height = boundingCR.height;\r\n        }\r\n        else {\r\n\r\n            width = boundingCR.height;\r\n            height = boundingCR.width;\r\n        }\r\n\r\n        if (options.setSize) {\r\n            canvas.width = width;\r\n            canvas.height = height;\r\n        }        \r\n\r\n        boundingCR.left = options.left != undefined ? options.left : 15;\r\n        boundingCR.top = options.top != undefined ? options.top : 15;\r\n\r\n        ctx.moveTo(boundingCR.left, boundingCR.top);\r\n        ctx.lineTo(boundingCR.left, boundingCR.top + height);\r\n        ctx.lineTo(boundingCR.left + width, boundingCR.top + height);\r\n        ctx.lineTo(boundingCR.left + width, boundingCR.top);\r\n\r\n        ctx.stroke();\r\n\r\n        var textMetrics = ctx.measureText(text);\r\n        var textPosition = {\r\n            x: boundingCR.left + width / 2,\r\n            y: boundingCR.top + height / 2\r\n        };\r\n\r\n        if (options.fill) {\r\n            drawFill(ctx, width, height);\r\n        }\r\n\r\n        ctx.globalAlpha = 1.0;\r\n        ctx.fillStyle = options.textColor != undefined ? options.textColor : window.getComputedStyle(node).color;\r\n\r\n        ctx.font = options.font != undefined ? options.font : window.getComputedStyle(node).fontSize + \" \" + window.getComputedStyle(node).fontFamily;\r\n        ctx.textAlign = \"center\";\r\n        ctx.textBaseline = \"middle\";\r\n        ctx.fillText(text, textPosition.x, textPosition.y);\r\n\r\n        return canvas;\r\n    };\r\n\r\n    ctlProto.registerListeners = function () {\r\n        const self = this;\r\n\r\n        if (!self.registeredListeners) {\r\n            self.map.on(TC.Consts.event.LAYERADD, self.generateLink.bind(self))\r\n                .on(TC.Consts.event.LAYERREMOVE, self.generateLink.bind(self))\r\n                .on(TC.Consts.event.FEATUREADD, self.generateLink.bind(self))\r\n                .on(TC.Consts.event.FEATUREREMOVE + ' ' + TC.Consts.event.FEATURESCLEAR, self.generateLink.bind(self));\r\n\r\n            self.registeredListeners = true;\r\n        }\r\n    };\r\n\r\n})();"]}