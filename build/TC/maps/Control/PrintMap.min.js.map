{"version":3,"sources":["control/PrintMap.js"],"names":["TC","control","MapInfo","syncLoadJS","apiLocation","PrintMap","Control","apply","this","arguments","inherit","ctlProto","prototype","CLASS","ORIENTATION","PAGE_SIZE","a4_portrait","logoWidth","logoHeight","layoutPDF","pageSize","width","height","pageMargins","content","columns","image","margin","text","alignment","table","widths","body","layout","paddingLeft","i","node","paddingRight","paddingTop","paddingBottom","reset","a4_landscape","a3_portrait","a3_landscape","getLayout","orientation","format","getLogoColumn","getScaleBarColumn","options","sideLength","template","isDebug","dust","register","body_0","chk","ctx","w","h","$key","__dustBody","hasLegend","map","workLayers","some","layer","type","Consts","layerType","WMS","getVisibility","self","result","call","mustBeExportable","manageLegendOnZoom","toString","toUpperCase","div","addEventListener","EventTarget","listenerBySelector","setView","view","PRINTING","codeContainer","document","querySelector","checked","createElement","classList","add","appendChild","innerHTML","makeQRCode","printBtnSelector","on","event","STARTLOADING","printBtn","disabled","STOPLOADING","remove","ZOOM","updateCanvas","printFormat","bounding","getBoundingClientRect","Number","isInteger","style","Math","round","toast","getLocaleString","msgType","INFO","duration","wrap","updateSize","resetPrinting","off","toastHide","currentFormat","removeProperty","DEFAULT","_viewDiv","classes","HIDDEN","Util","getDiv","getRenderedHtml","html","insertAdjacentHTML","createPdf","bind","value","evt","generateLink","registerListeners","loadingCtrl","getControlsByClass","LoadingIndicator","hasWait","addWait","loadJS","window","pdfMake","url","PDFMAKE","olViewport","querySelectorAll","len","length","elm","parentElement","contains","canvas","printLayout","createPDF","filename","location","host","title","trim","getFormattedDate","Date","download","replace","error","ERROR","message","stack","msgErrorMode","EMAIL","removeWait","imageErrorHandling","imageUrl","getLegend","layers","filter","legendByGroup","_process","parentLayer","treeLevel","isVisibleByScale","name","src","srcBase64","params","base64LegendSrc","legend","push","level","_traverse","o","func","Array","isArray","hasOwnProperty","children","header","forEach","hideTree","tree","getTree","Promise","resolve","reject","all","imagePromises","j","k","l","tool","Proxification","proxify","allowedMixedContent","fetchImage","exportable","then","img","complete","imageDetail","imgTagToDataUrl","base64","_getLegendImages","group","index","groupIndex","item","reduce","prev","current","vector","sort","a","b","groupWithHeight","rows","colSpan","fontSize","headerRows","concat","toLowerCase","headerItem","itemIndex","position","indexOf","imageWidth","imageHeight","data","splice","dontBreakRows","keepWithHeaderRows","getGroupTable","basics","onLogoError","logoColumn","logo","imgToDataUrl","dataUrl","calculateAspectRatioFit","titleColumn","getTitleColumn","onError","scaleBarColumn","scaleCtrl","ScaleBar","elem","getElementsByClassName","styling","getComputedStyle","leftBorder","parseInt","getPropertyValue","rightBorder","border","getText","qrTarget","qrCodeBase64","addToCanvas","x","y","mapCanvas","fn","basicsDone","mapPlace","getMap","toDataURL","visible","names","pageBreak","pageOrientation","manageMaxLengthExceed","maxLengthExceed","alertElm","toggle","qr"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapInfo) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapInfo');\r\n}\r\n\r\nTC.control.PrintMap = function () {\r\n    var self = this;\r\n\r\n    TC.Control.apply(self, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.PrintMap, TC.control.MapInfo);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.PrintMap.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-printMap';\r\n\r\n    var self = this;\r\n\r\n    const ORIENTATION = {\r\n        PORTRAIT: 'portrait',\r\n        LANDSCAPE: 'landscape'\r\n    };\r\n    const PAGE_SIZE = {\r\n        A4: 'A4',\r\n        A3: 'A3'\r\n    };\r\n\r\n    /*\r\n        GLS:\r\n        La librería makePDF se basa en la librería PDFKit explicación sobre la unidad de medida que usa:\r\n        PDF points (72 per inch)\r\n        https://stackoverflow.com/questions/51540144/pdfkit-node-js-measurement-unit\r\n        https://www.ninjaunits.com/converters/pixels/points-pixels/\r\n        https://www.ninjaunits.com/converters/pixels/pixels-points/\r\n\r\n        La clave es mantener las dimensiones del mapa en px enteros (canvas sólo admite px enteros), ajustando el layout que está en puntos y que sí admite decimales\r\n    */\r\n\r\n    /* GLS: si se cambian los valores de los layout es necesario actualizar los valores de la clases CSS:  tc-ctl-printMap-portrait-a4 indicando el valor en px la sección del mapa   */\r\n    var a4_portrait = {\r\n        logoWidth: 60,\r\n        logoHeight: 30,\r\n        layoutPDF: {\r\n            pageSize: {\r\n                width: 595,\r\n                height: 842\r\n            },\r\n            pageMargins: [29.5, 14, 29.5, 22.5],\r\n            content: [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            /*width: 45,*/\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            width: 489,\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0]\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 534,\r\n                                height: 775.5\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        reset: function () {\r\n            this.layoutPDF.content = [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            /*width: 45,*/\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            width: 489,\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0]\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 534,\r\n                                height: 775.5\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ];\r\n        }\r\n    };\r\n    /* GLS: si se cambian los valores de los layout es necesario actualizar los valores de la clases CSS:  tc-ctl-printMap-landscape-a4 indicando el valor en px la sección del mapa   */\r\n    var a4_landscape = {\r\n        logoWidth: 60,\r\n        logoHeight: 30,\r\n        layoutPDF: {\r\n            pageSize: {\r\n                width: 842,\r\n                height: 595\r\n            },\r\n            pageMargins: [30, 14, 30, 22],\r\n            content: [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            /*width: 45,*/\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0],\r\n                            width: 600\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 780,\r\n                                height: 528\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        reset: function () {\r\n            this.layoutPDF.content = [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            /*width: 45,*/\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0],\r\n                            width: 600\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 780,\r\n                                height: 528\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ];\r\n        }\r\n    };\r\n\r\n    /* GLS: si se cambian los valores de los layout es necesario actualizar los valores de la clases CSS:  tc-ctl-printMap-portrait-a3 indicando el valor en px la sección del mapa   */\r\n    var a3_portrait = {\r\n        logoWidth: 60,\r\n        logoHeight: 30,\r\n        layoutPDF: {\r\n            pageSize: {\r\n                width: 841.89,\r\n                height: 1190.55\r\n            },\r\n            pageMargins: [29.954, 14, 29.954, 21.55],\r\n            content: [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            width: 45,\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            width: 489,\r\n                            margin: [0, 10, 0, 0],\r\n                            alignment: 'center'\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 780,\r\n                                height: 1125\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        reset: function () {\r\n            this.layoutPDF.content = [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            width: 45,\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            width: 489,\r\n                            margin: [0, 10, 0, 0],\r\n                            alignment: 'center'\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 780,\r\n                                height: 1125\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ];\r\n        }\r\n    };\r\n    /* GLS: si se cambian los valores de los layout es necesario actualizar los valores de la clases CSS:  tc-ctl-printMap-landscape-a3 indicando el valor en px la sección del mapa   */\r\n    var a3_landscape = {\r\n        logoWidth: 60,\r\n        logoHeight: 30,\r\n        layoutPDF: {\r\n            pageSize: {\r\n                width: 1190.55,\r\n                height: 841.89\r\n            },\r\n            pageMargins: [28.775, 14, 28.775, 14.89],\r\n            content: [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            width: 45,\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0],\r\n                            width: 600\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 1131,\r\n                                height: 783\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        reset: function () {\r\n            this.layoutPDF.content = [\r\n                {\r\n                    columns: [\r\n                        { /* logo */\r\n                            image: null,\r\n                            height: 22,\r\n                            width: 45,\r\n                            margin: [0, 0, 0, 6]\r\n                        },\r\n                        { /* título */\r\n                            text: \"\",\r\n                            alignment: 'center',\r\n                            margin: [0, 10, 0, 0],\r\n                            width: 600\r\n                        },\r\n                        { /* barra de escala */\r\n                            alignment: 'right',\r\n                            margin: [0, 10, 0, 0]\r\n                        }\r\n                    ]\r\n                },\r\n                {\r\n                    table: {\r\n                        widths: ['*'],\r\n                        body: [\r\n                            [{ /* mapa */\r\n                                image: null,\r\n                                width: 1131,\r\n                                height: 783\r\n                            }]\r\n                        ]\r\n                    },\r\n                    layout: {\r\n                        paddingLeft: function (i, node) { return 0; },\r\n                        paddingRight: function (i, node) { return 0; },\r\n                        paddingTop: function (i, node) { return 0; },\r\n                        paddingBottom: function (i, node) { return 0; }\r\n                    }\r\n                }\r\n            ];\r\n        }\r\n    };\r\n\r\n    const getLayout = function (orientation, format) {\r\n        switch (orientation) {\r\n            case ORIENTATION.PORTRAIT: {\r\n                switch (format) {\r\n                    case PAGE_SIZE.A4: {\r\n                        return a4_portrait;\r\n                    }\r\n                    case PAGE_SIZE.A3: {\r\n                        return a3_portrait;\r\n                    }\r\n                    default:\r\n                }\r\n                break;\r\n            }\r\n            case ORIENTATION.LANDSCAPE: {\r\n                switch (format) {\r\n                    case PAGE_SIZE.A4: {\r\n                        return a4_landscape;\r\n                    }\r\n                    case PAGE_SIZE.A3: {\r\n                        return a3_landscape;\r\n                    }\r\n                    default:\r\n                }\r\n                break;\r\n            }\r\n            default:\r\n                return a4_portrait;\r\n        }\r\n    };\r\n\r\n    const getLogoColumn = function (layout) {\r\n        return layout.layoutPDF.content[0].columns[0];\r\n    };\r\n    const getTitleColumn = function (layout) {\r\n        return layout.layoutPDF.content[0].columns[1];\r\n    };\r\n    const getScaleBarColumn = function (layout) {\r\n        return layout.layoutPDF.content[0].columns[2];\r\n    };\r\n    const getMap = function (layout) {\r\n        return layout.layoutPDF.content[1].table.body[0][0];\r\n    };\r\n\r\n    const options = {\r\n        qrCode: {\r\n            sideLength: 85\r\n        }\r\n    };\r\n\r\n    ctlProto.template = {};\r\n\r\n    if (TC.isDebug) {\r\n        ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/PrintMap.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-view'] = TC.apiLocation + \"TC/templates/PrintMapView.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-tools'] = TC.apiLocation + \"TC/templates/PrintMapTools.html\";\r\n    }\r\n    else {\r\n        ctlProto.template[ctlProto.CLASS] = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"print\" }).w(\"</h2><div><div class=\\\"tc-ctl-printMap-div\\\"><div class=\\\"tc-group tc-ctl-printMap-cnt\\\"><label>\").h(\"i18n\", ctx, {}, { \"$key\": \"title\" }).w(\":</label><input type=\\\"text\\\" class=\\\"tc-ctl-printMap-title tc-textbox\\\" maxlength=\\\"30\\\" placeholder=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"mapTitle\" }).w(\"\\\" /></div><div class=\\\"tc-group tc-ctl-printMap-cnt\\\"><label>\").h(\"i18n\", ctx, {}, { \"$key\": \"layout\" }).w(\":</label><select id=\\\"print-design\\\" class=\\\"tc-combo\\\"><option value=\\\"landscape\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"landscape\" }).w(\"</option><option value=\\\"portrait\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"portrait\" }).w(\"</option></select></div><div class=\\\"tc-group tc-ctl-printMap-cnt\\\"><label>\").h(\"i18n\", ctx, {}, { \"$key\": \"size\" }).w(\":</label><select id=\\\"print-size\\\" class=\\\"tc-combo\\\"><option value=\\\"a4\\\">A4</option><option value=\\\"a3\\\">A3</option></select></div><div class=\\\"tc-group tc-ctl-printMap-cnt tc-ctl-printMap-cnt-btn\\\"><input id=\\\"tc-ctl-printMap-image-qr\\\" class=\\\"tc-hidden\\\" type=\\\"checkbox\\\" checked style=\\\"display:none;\\\" /><label for=\\\"tc-ctl-printMap-image-qr\\\" class=\\\"tc-ctl-printMap-image-qr-label\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"createQrCodeToImage\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"appendQRCode\" }).w(\"</label><button class=\\\"tc-ctl-printMap-btn tc-button tc-icon-button\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"printMap\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"print\" }).w(\"</button></div><div class=\\\"tc-group tc-ctl-printMap-cnt\\\"><div class=\\\"tc-ctl-printMap-alert tc-alert alert-warning tc-hidden\\\"><p>\").h(\"i18n\", ctx, {}, { \"$key\": \"qrAdvice|s\" }).w(\"</p></div></div></div></div>\"); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-view'] = function () { dust.register(ctlProto.CLASS + '-view', body_0); function body_0(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-printMap-view\\\"> </div>\"); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-tools'] = function () { dust.register(ctlProto.CLASS + '-tools', body_0); function body_0(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-printMap-tools\\\"><div class=\\\"tc-ctl-printMap-btn-pdf\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"printpdf\" }).w(\"\\\"></div><div class=\\\"tc-ctl-printMap-btn-close\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"close\" }).w(\"\\\"></div></div> \"); } body_0.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    const hasLegend = function () {\r\n        const self = this;\r\n\r\n        return self.map.workLayers.some(function (layer) {\r\n            return layer.type === TC.Consts.layerType.WMS && layer.getVisibility();\r\n        });\r\n    };\r\n\r\n    const hasLegendToPrint = function () {\r\n        const self = this;\r\n\r\n        return self.map.workLayers.some(function (layer) {\r\n            if (layer.type === TC.Consts.layerType.WMS && layer.getVisibility()) {\r\n                for (var i = 0; i < layer.names.length; i++) {\r\n                    if (layer.isVisibleByScale(layer.names[i])) {\r\n                        return true;\r\n                    }\r\n                }\r\n\r\n                return false;\r\n            }\r\n\r\n            return false;\r\n        });\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.control.MapInfo.prototype.register.call(self, map);\r\n\r\n        // GLS: Añado el flag al mapa para tenerlo en cuenta cuando se establece la función de carga de imágenes\r\n        self.map.mustBeExportable = true;\r\n\r\n        const manageLegendOnZoom = function () {\r\n            var layout = getLayout(self.orientation || ORIENTATION.PORTRAIT, self.format.toString().toUpperCase() || \"A4\");\r\n            layout.reset();\r\n        };\r\n\r\n        const print = function () {\r\n\r\n            self.map.setView(TC.Consts.view.PRINTING);\r\n\r\n            var codeContainer = document.querySelector('.' + self.CLASS + '-qrcode');\r\n            if (document.querySelector(\"#\" + self.CLASS + \"-image-qr\").checked) {\r\n                if (!codeContainer) {\r\n                    codeContainer = document.createElement('div');\r\n                    codeContainer.classList.add(self.CLASS + '-qrcode');\r\n                    self.map.div.appendChild(codeContainer);\r\n                }\r\n\r\n                codeContainer.innerHTML = '';\r\n                self.makeQRCode(codeContainer, options.qrCode.sideLength, options.qrCode.sideLength);\r\n            } else {\r\n                if (codeContainer) {\r\n                    codeContainer.innerHTML = '';\r\n                }\r\n            }\r\n\r\n            const printBtnSelector = '.' + self.CLASS + '-btn';\r\n            self.map.on(TC.Consts.event.STARTLOADING, function () {\r\n                const printBtn = self.div.querySelector(printBtnSelector);\r\n                printBtn.classList.add('disabled');\r\n                printBtn.disabled = true;\r\n            });\r\n\r\n            self.map.on(TC.Consts.event.STOPLOADING, function () {\r\n                const printBtn = self.div.querySelector(printBtnSelector);\r\n                printBtn.classList.remove('disabled');\r\n                printBtn.disabled = false;\r\n            });\r\n\r\n            if (hasLegend.call(self)) {\r\n                // GLS: controlamos si una capa deja de verse por la escala para resetear la leyenda                \r\n                self.map.on(TC.Consts.event.ZOOM, manageLegendOnZoom);\r\n            }\r\n\r\n            const updateCanvas = function (printFormat) {\r\n                if (printFormat) {\r\n                    self.map.div.classList.add(printFormat);\r\n                    /**\r\n                     * Validamos que el resultado en pixels sean valores enteros, si no lo son, redondeamos y establecemos evitando estiramiento del canvas /\r\n                     */\r\n                    var bounding = self.map.div.getBoundingClientRect();\r\n                    if (!Number.isInteger(bounding.width)) {\r\n                        self.map.div.style.width = Math.round(bounding.width) + 'px';\r\n                    }\r\n                    if (!Number.isInteger(bounding.height)) {\r\n                        self.map.div.style.height = Math.round(bounding.height) + 'px';\r\n                    }\r\n\r\n                    self.map.toast(self.getLocaleString('print.advice.title') + ': ' + self.getLocaleString('print.advice.desc'), { type: TC.Consts.msgType.INFO, duration: 7000 });\r\n                }\r\n\r\n                self.map.wrap.map.updateSize();\r\n            };\r\n\r\n            const resetPrinting = function () {\r\n\r\n                var layout = getLayout(self.orientation || ORIENTATION.PORTRAIT, self.format.toString().toUpperCase() || \"A4\");\r\n                layout.reset();\r\n\r\n                if (hasLegend.call(self)) {\r\n                    self.map.off(TC.Consts.event.ZOOM, manageLegendOnZoom);\r\n                }\r\n\r\n                self.map.toastHide(self.getLocaleString('print.advice.title') + ': ' + self.getLocaleString('print.advice.desc'));\r\n\r\n                self.map.div.classList.remove(self.currentFormat, self.CLASS + '-printing');\r\n\r\n                self.map.div.style.removeProperty('width');\r\n                self.map.div.style.removeProperty('height');\r\n\r\n                updateCanvas();\r\n\r\n                self.map.setView(TC.Consts.view.DEFAULT);\r\n\r\n                self._viewDiv.classList.add(TC.Consts.classes.HIDDEN);\r\n            };\r\n\r\n            if (!self._viewDiv) {\r\n                self._viewDiv = TC.Util.getDiv();\r\n                document.body.appendChild(self._viewDiv);\r\n\r\n                self.getRenderedHtml(self.CLASS + '-view', null, function (html) {\r\n                    self._viewDiv.innerHTML = html;\r\n                });\r\n\r\n                self.getRenderedHtml(self.CLASS + '-tools', null, function (html) {\r\n                    self.map.div.insertAdjacentHTML('beforeend', html);\r\n\r\n                    self.map.div.querySelector('.' + self.CLASS + '-btn-close').addEventListener('click', resetPrinting);\r\n\r\n                    self.map.div.querySelector('.' + self.CLASS + '-btn-pdf').addEventListener('click', self.createPdf.bind(self));\r\n                });\r\n            }\r\n\r\n            self.orientation = self.div.querySelector(\"#print-design\").value;\r\n            self.format = self.div.querySelector(\"#print-size\").value;\r\n\r\n            self.currentFormat = self.CLASS + '-' + self.orientation + '-' + self.format;\r\n\r\n            self._viewDiv.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n            self.map.div.classList.add(self.CLASS + \"-printing\");\r\n            updateCanvas(self.currentFormat);\r\n        };\r\n\r\n        self.div.addEventListener('click', TC.EventTarget.listenerBySelector('.' + self.CLASS + '-btn', print));\r\n\r\n        self.div.addEventListener('click', TC.EventTarget.listenerBySelector('#' + self.CLASS + '-image-qr', function (evt) {\r\n            self.generateLink();\r\n        }));\r\n\r\n        self.div.addEventListener('click', TC.EventTarget.listenerBySelector('h2', function (evt) {\r\n            self.generateLink();\r\n            self.registerListeners();\r\n        }));\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.createPdf = function () {\r\n        var self = this;\r\n\r\n        var loadingCtrl = self.map.getControlsByClass(TC.control.LoadingIndicator)[0];\r\n        var hasWait = loadingCtrl.addWait();\r\n\r\n        TC.loadJS(!window.pdfMake, [TC.Consts.url.PDFMAKE], function () {\r\n            const olViewport = self.map.div.querySelectorAll('.ol-viewport');\r\n            for (var i = 0, len = olViewport.length; i < len; i++) {\r\n                const elm = olViewport[i];\r\n                if (!elm.parentElement.classList.contains('ol-overviewmap-map')) {\r\n                    self.canvas = elm.querySelector('canvas');\r\n                    break;\r\n                }\r\n            }\r\n\r\n            var layout = getLayout(self.orientation || ORIENTATION.PORTRAIT, self.format.toString().toUpperCase() || \"A4\");\r\n            var printLayout = layout.layoutPDF;\r\n\r\n            const createPDF = function (printLayout) {\r\n                var filename = window.location.host + '_';\r\n                var title = self.div.querySelector('.' + self.CLASS + '-title').value.trim();\r\n\r\n                if (title) {\r\n                    filename += title;\r\n                } else {\r\n                    var currentDate = TC.Util.getFormattedDate(new Date().toString(), true);\r\n                    filename += currentDate;\r\n                }\r\n\r\n                try {\r\n                    pdfMake.createPdf(printLayout).download(filename.replace(/[\\\\\\/:*?\"<>\\|]/g, \"\") + '.pdf');\r\n                } catch (error) {\r\n                    self.map.toast(self.getLocaleString('print.error'), { type: TC.Consts.msgType.ERROR });\r\n                    TC.error(error.message + '  ' + error.stack, TC.Consts.msgErrorMode.EMAIL);\r\n                }\r\n\r\n                loadingCtrl.removeWait(hasWait);\r\n            };\r\n\r\n            const imageErrorHandling = function (imageUrl) {\r\n                TC.error(self.getLocaleString('print.error'));\r\n                TC.error('No se ha podido generar el base64 correspondiente a la imagen: ' + imageUrl, TC.Consts.msgErrorMode.EMAIL, 'Error en la impresión'); //Correo de error\r\n            };\r\n\r\n            const getLogo = function () {\r\n\r\n                const onLogoError = function () {\r\n                    var logoColumn = getLogoColumn(layout);\r\n                    delete logoColumn.image;\r\n                    logoColumn.text = \"\";\r\n                    return logoColumn;\r\n                };\r\n\r\n                if (self.options.logo) {\r\n                    return TC.Util.imgToDataUrl(self.options.logo, 'image/png').then(function (result) {\r\n                        const canvas = result.canvas;\r\n                        const dataUrl = result.dataUrl;\r\n                        var size = TC.Util.calculateAspectRatioFit(canvas.width, canvas.height, layout.logoWidth, layout.logoHeight);\r\n\r\n                        var logoColumn = getLogoColumn(layout);\r\n                        //URI: si no se define la anchura en el layout calcula la anchura en función de proporción entre ancho y alto de la imagen y el alto de su posición en el PDF\r\n                        if (!logoColumn.width)\r\n                            logoColumn.width = (canvas.width / canvas.height) * logoColumn.height;\r\n                        logoColumn.image = dataUrl;\r\n                        return logoColumn;\r\n\r\n                    }, function () {\r\n                        imageErrorHandling(self.options.logo);\r\n\r\n                        return onLogoError();\r\n                    });\r\n                } else {\r\n                    return onLogoError();\r\n                }\r\n            };\r\n            const getScaleBar = function () {\r\n                const onError = function () {\r\n                    var scaleBarColumn = getScaleBarColumn(layout);\r\n                    delete scaleBarColumn.image;\r\n                    scaleBarColumn.text = \"\";\r\n                    scaleBarColumn.width = \"auto\";\r\n                    return scaleBarColumn;\r\n                };\r\n\r\n                var scaleCtrl = self.map.getControlsByClass(TC.control.ScaleBar)[0];\r\n                if (scaleCtrl) {\r\n                    var elem = document.getElementsByClassName(\"ol-scale-line-inner\"); // no cogemos el DIV del control ya que contiene los bordes y suman al ancho total\r\n                    var bounding = elem[0].getBoundingClientRect();\r\n                    if (bounding) {\r\n                        var styling = getComputedStyle(elem[0], null);\r\n                        var leftBorder = parseInt(styling.getPropertyValue('border-left-width').replace('px', '')) || 0;\r\n                        var rightBorder = parseInt(styling.getPropertyValue('border-right-width').replace('px', '')) || 0;\r\n\r\n                        var scaleBarColumn = getScaleBarColumn(layout);\r\n\r\n                        scaleBarColumn.table = {\r\n                            widths: [((bounding.width > bounding.height ? bounding.width : bounding.height) - leftBorder - rightBorder) * 0.75], // lo pasamos a pt\r\n                            body: [\r\n                                [{ border: [true, false, true, true], text: scaleCtrl.getText(), fontSize: 10, alignment: 'center' }]\r\n                            ]\r\n                        };\r\n\r\n                        scaleBarColumn.layout = {\r\n                            paddingLeft: function (i, node) { return 0; },\r\n                            paddingRight: function (i, node) { return 0; },\r\n                            paddingTop: function (i, node) { return 0; },\r\n                            paddingBottom: function (i, node) { return 0; }\r\n                        };\r\n\r\n                        return scaleBarColumn;\r\n                    } else {\r\n                        return onError();\r\n                    }\r\n                } else {\r\n                    return onError();\r\n                }\r\n            };\r\n            const getLegend = function () {\r\n                var content = [];\r\n                var layers = self.map.workLayers.filter(function (layer) {\r\n                    return layer.type === TC.Consts.layerType.WMS && layer.getVisibility();\r\n                });\r\n                var legendByGroup = [];\r\n                var indentationIncrement = 7;\r\n\r\n                var _process = function (value, parentLayer, treeLevel) {\r\n                    if (parentLayer.isVisibleByScale(value.name)) { //Si la capa es visible, la mostramos en la leyenda\r\n                        var src,\r\n                            srcBase64;\r\n\r\n                        //Para las capas cargadas por POST (por ejemplo la búsquedas de Comercio Pamplona)\r\n                        if (parentLayer.options && parentLayer.options.params && parentLayer.options.params.base64LegendSrc) {\r\n                            srcBase64 = parentLayer.options.params.base64LegendSrc;\r\n                        }\r\n                        else if (value.legend) {\r\n                            src = value.legend.src;\r\n                        }\r\n\r\n                        result.push({ src: src, title: value.title, level: treeLevel, srcBase64: srcBase64 });\r\n                    }\r\n                };\r\n                var _traverse = function (o, func, parentLayer, treeLevel) {\r\n                    if (Array.isArray(o)) {\r\n                        for (var i = 0; i < o.length; i++) {\r\n                            _traverse(o[i], func, parentLayer, treeLevel);\r\n                        }\r\n                    } else {\r\n                        if (o && o.hasOwnProperty('children') && o.children.length > 0) {\r\n                            if (o.title && o.name) {\r\n                                result.push({ header: o.title, level: treeLevel });\r\n                            }\r\n                            _traverse(o.children, func, parentLayer, ++treeLevel);\r\n                        }\r\n                    }\r\n\r\n                    if (o && o.hasOwnProperty('children') && o.children.length == 0) {\r\n                        func.apply(this, [o, parentLayer, treeLevel]);\r\n                        treeLevel--;\r\n                    }\r\n                };\r\n                var _getLegendImages = function () {\r\n                    var imagePromises = [];\r\n\r\n                    for (var i = 0; i < legendByGroup.length; i++) {\r\n                        var layers = legendByGroup[i].layers;\r\n\r\n                        for (var j = 0; j < layers.length; j++) {\r\n                            (function (k, l) {\r\n                                var layer = legendByGroup[k].layers[l];\r\n                                var src = layer.src || layer.srcBase64;\r\n\r\n                                if (src) {\r\n\r\n                                    if (!TC.tool || !TC.tool.Proxification) {\r\n                                        TC.syncLoadJS(TC.apiLocation + 'TC/tool/Proxification');\r\n                                    }\r\n\r\n                                    imagePromises.push(new Promise(function (resolve, reject) {\r\n                                        var toolProxification = new TC.tool.Proxification(TC.proxify, { allowedMixedContent: true });\r\n                                        toolProxification.fetchImage(src, { exportable: true }).then(function (img) {\r\n                                            if (img.complete) {\r\n                                                var imageDetail = TC.Util.imgTagToDataUrl(img, 'image/png');\r\n                                                layer.image = { base64: imageDetail.base64, canvas: imageDetail.canvas };\r\n                                            } else {\r\n                                                imageErrorHandling(src);\r\n                                            }\r\n\r\n                                            resolve();\r\n\r\n                                        }, function (error) {\r\n                                            imageErrorHandling(src);\r\n                                            reject();\r\n                                        });\r\n                                    }));\r\n                                }\r\n                            })(i, j);\r\n                        }\r\n                    }\r\n\r\n                    return imagePromises;\r\n                };\r\n\r\n                layers.forEach(function (layer) {\r\n                    result = [];\r\n\r\n                    var hideTree = layer.options.hideTree;\r\n\r\n                    layer.tree = null;\r\n                    layer.options.hideTree = true;\r\n\r\n                    _traverse(layer.getTree(), _process, layer, 0);\r\n\r\n                    layer.options.hideTree = hideTree;\r\n\r\n                    if (result.length > 0) {\r\n                        legendByGroup.push({ title: layer.title, layers: result });\r\n                    }\r\n                });\r\n\r\n                return new Promise(function (resolve, reject) {\r\n                    Promise.all(_getLegendImages()).then(function () {\r\n\r\n                        const getGroupTable = function (group, index) {                            \r\n                            var rows = [[{ text: group.title, colSpan: 2, alignment: 'left', fontSize: 11, margin: [0, index > 0 ? 10 : 0, 0, 5] }, {}]];\r\n                            var indentation = 10;\r\n\r\n                            rows = rows.concat(group.layers.filter(function (item) {\r\n                                return item.hasOwnProperty('header') && item.header.trim().toLowerCase() !== group.title.trim().toLowerCase();\r\n                            }).map(function (item) {\r\n                                return [{ text: item.header.trim(), colSpan: 2, alignment: 'left', margin: [indentation * item.level, 0, 0, 3] }, {}];\r\n                            }));\r\n\r\n                            const headerRows = rows.length;\r\n                            var headerItem = null;\r\n                            var itemIndex = null;\r\n\r\n                            const getLayerTable = function (item, index) {\r\n                                if (item.header) {\r\n                                    headerItem = item;\r\n\r\n                                    if (itemIndex) {\r\n                                        itemIndex = null;\r\n                                    }\r\n                                } else {\r\n                                    if (!itemIndex) {\r\n                                        itemIndex = 1;\r\n                                    }\r\n\r\n                                    var position;\r\n                                    if (headerItem) {\r\n                                        var headerIndex = rows.map(function (item) { return item[0].text }).indexOf(headerItem.header);\r\n                                        position = headerIndex + itemIndex++;\r\n                                    }\r\n\r\n                                    if (item.image) {\r\n                                        var imageWidth = item.image.canvas.width / 2;\r\n                                        var imageHeight = (imageWidth * item.image.canvas.height / item.image.canvas.width);\r\n\r\n                                        var data = [{\r\n                                            text: item.title,\r\n                                            fontSize: 9,\r\n                                            width: 'auto',\r\n                                            margin: [indentation * item.level, 0, 0, 2]\r\n                                        }, {\r\n                                            image: item.image.base64,\r\n                                            width: imageWidth,\r\n                                            height: imageHeight,\r\n                                            margin: [indentation * item.level, 0, 0, 2]\r\n                                        }];\r\n\r\n                                        if (position) {\r\n                                            rows.splice(position, 0, data);\r\n                                        } else {\r\n                                            rows.push(data);\r\n                                        }\r\n\r\n                                    } else {\r\n                                        var data = [{\r\n                                            text: item.title,\r\n                                            fontSize: 9,\r\n                                            colSpan: 2,\r\n                                            margin: [indentation * item.level, 0, 0, 2]\r\n                                        }, {}];\r\n\r\n                                        if (position) {\r\n                                            rows.splice(position, 0, data);\r\n                                        } else {\r\n                                            rows.push(data);\r\n                                        }\r\n                                    }\r\n                                }\r\n                            };\r\n\r\n                            group.layers.forEach(getLayerTable);\r\n\r\n                            content.push({\r\n                                layout: 'noBorders',\r\n                                table: {\r\n                                    dontBreakRows: true,\r\n                                    keepWithHeaderRows: 1,\r\n                                    headerRows: headerRows,\r\n                                    body: rows\r\n                                }\r\n                            });\r\n                        };\r\n\r\n                        legendByGroup.map(function (group, index) {\r\n                            return {\r\n                                groupIndex: index,\r\n                                height: group.layers.filter(function (item) {\r\n                                    return item.image && item.image.canvas;\r\n                                }).reduce(function (prev, current, index, vector) {\r\n                                    return prev + vector[index].image.canvas.height;\r\n                                }, 0)\r\n                            }\r\n                        }).sort(function (a, b) {\r\n                            if (a.height > b.height) {\r\n                                return 1;\r\n                            }\r\n                            if (a.height < b.height) {\r\n                                return -1;\r\n                            }\r\n                            return 0;\r\n                        }).forEach(function (groupWithHeight, index) {\r\n                            getGroupTable(legendByGroup[groupWithHeight.groupIndex], index)\r\n                        });\r\n\r\n                        resolve(content);\r\n\r\n                    }, function () {\r\n                        reject([]);\r\n                    });\r\n                });\r\n            };\r\n            const drawQR = function () {\r\n                // GLS: añadimos el QR\r\n                //QR\r\n                if (document.querySelector(\"#\" + self.CLASS + \"-image-qr\").checked) {\r\n                    const qrTarget = document.querySelector('.' + self.CLASS + '-qrcode');\r\n                    qrTarget.innerHTML = '';\r\n                    return self.makeQRCode(qrTarget, options.qrCode.sideLength, options.qrCode.sideLength).then(function (qrCodeBase64) {\r\n                        if (qrCodeBase64) {\r\n                            return TC.Util.addToCanvas(self.canvas, qrCodeBase64, { x: self.canvas.width - options.qrCode.sideLength, y: self.canvas.height - options.qrCode.sideLength }, {width: options.qrCode.sideLength, height: options.qrCode.sideLength }).then(function (mapCanvas) {\r\n                                return mapCanvas;\r\n                            });\r\n                        } else {\r\n                            TC.error(self.getLocaleString('print.qr.error'));\r\n                            return self.canvas;\r\n                        }\r\n                    });\r\n                } else {\r\n                    return self.canvas;\r\n                }\r\n            };\r\n\r\n            const basics = [getLogo, function () {\r\n                var titleColumn = getTitleColumn(layout);\r\n                titleColumn.text = self.div.querySelector('.' + self.CLASS + '-title').value.trim();\r\n                return titleColumn;\r\n            }, getScaleBar, drawQR];\r\n\r\n            Promise.all(basics.map(function (fn) {\r\n                return fn();\r\n            })).then(function (basicsDone) {\r\n\r\n                if (basicsDone[2].table) { // GLS: ajustamos el ancho del título para arrinconar la escala\r\n                    layout.layoutPDF.content[0].columns[1].width = layout.layoutPDF.pageSize.width - (layout.layoutPDF.pageMargins[0] + layout.layoutPDF.pageMargins[2]) - layout.layoutPDF.content[0].columns[0].width - (layout.layoutPDF.content[0].columns[2].table.widths[0] + 2);\r\n                }\r\n\r\n                var mapPlace = getMap(layout);\r\n                var canvas = basicsDone[3] || self.canvas;\r\n\r\n                mapPlace.image = canvas.toDataURL();\r\n\r\n                if (self.options.legend &&\r\n                    self.options.legend.visible &&\r\n                    hasLegendToPrint.call(self) && // GLS: validamos que haya capas visibles por escala \r\n                    printLayout.content.length == 2) { // GLS: es la primera descarga o hemos resetado la leyenda por algún zoom por lo que no tenemos la leyenda en el layout\r\n\r\n                    const title = self.div.querySelector('.' + self.CLASS + '-title').value.trim();\r\n                    printLayout.content.push({\r\n                        pageBreak: 'before',\r\n                        pageOrientation: self.options.legend.orientation || 'portrait',\r\n                        text: title.length > 0 ? title : '',\r\n                        fontSize: 14,\r\n                        margin: [0, 20, 0, 10]\r\n                    });\r\n\r\n                    getLegend().then(function (content) {\r\n                        printLayout.content = printLayout.content.concat(content);\r\n                        createPDF(printLayout);\r\n                    });\r\n                } else {\r\n                    createPDF(printLayout);\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.manageMaxLengthExceed = function (maxLengthExceed) {\r\n        const self = this;\r\n\r\n        const alertElm = self.div.querySelector('.' + self.CLASS + '-alert');\r\n        if (document.querySelector(\"#\" + self.CLASS + \"-image-qr\").checked) {\r\n            alertElm.classList.toggle(TC.Consts.classes.HIDDEN, !maxLengthExceed.qr);\r\n        } else {\r\n            alertElm.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n})();"]}