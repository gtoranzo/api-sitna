{"version":3,"sources":["Control/Legend.js"],"names":["TC","control","MapContents","syncLoadJS","apiLocation","Legend","apply","this","arguments","inherit","ctlProto","prototype","CLASS","template","isDebug","dust","register","body_0","chk","ctx","w","h","$key","s","get","else","body_1","block","body_2","__dustBody","p","rebase","getPath","x","body_11","body_3","f","body_4","body_10","body_5","body_8","body_6","body_7","body_9","_dataKeys","map","self","on","Consts","event","VIEWCHANGE","e","view","onLayerAdd","loadGraphics","bind","THREED","LAYERADD","DEFAULT","off","call","getLayerUIElements","forEach","li","layer","$","data","querySelectorAll","l","img","querySelector","undefined","getAttribute","length","styleLegendImage","updateScale","inScale","outOfScale","layersInScale","classList","contains","uid","isVisibleByScale","remove","add","update","getTree","visible","notVisible","hasVisible","_cache","visibilityStates","visibility","NOT_VISIBLE","HAS_VISIBLE","updateLayerVisibility","updateLayerTree","isBase","options","stealth","hideTree","tree","div","classes","HIDDEN","loadJSInOrder","window","url","templating","render","layerTrees","id","err","out","newLi","DOMParser","parseFromString","body","firstChild","ul","lis","innerHTML","setAttribute","insertBefore","error","removeLayer","getVisibility"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapContents');\r\n}\r\n\r\nTC.control.Legend = function () {\r\n    TC.control.MapContents.apply(this, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.Legend, TC.control.MapContents);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Legend.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-legend';\r\n\r\n    ctlProto.template = {};\r\n    if (TC.isDebug) {\r\n        ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/Legend.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-node'] = TC.apiLocation + \"TC/templates/LegendNode.html\";\r\n    }\r\n    else {\r\n        ctlProto.template[ctlProto.CLASS] = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"legend\" }).w(\"</h2><div class=\\\"tc-ctl-legend-tree\\\"><ul class=\\\"tc-ctl-legend-branch\\\">\").s(ctx.get([\"workLayers\"], false), ctx, { \"else\": body_1, \"block\": body_2 }, {}).w(\"</ul></div>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-legend-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noData\" }).w(\"</li>\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.p(\"tc-ctl-legend-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_2.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-node'] = function () { dust.register(ctlProto.CLASS + '-node', body_0); function body_0(chk, ctx) { return chk.x(ctx.get([\"customLegend\"], false), ctx, { \"else\": body_1, \"block\": body_11 }, {}); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"<li \").x(ctx.get([\"children\"], false), ctx, { \"else\": body_2, \"block\": body_3 }, {}).w(\" data-tc-layer-name=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\" data-tc-layer-uid=\\\"\").f(ctx.get([\"uid\"], false), ctx, \"h\").w(\"\\\"><div class=\\\"tc-ctl-legend-title\\\">\").f(ctx.get([\"title\"], false), ctx, \"h\").w(\"</div>\").x(ctx.get([\"legend\"], false), ctx, { \"block\": body_4 }, {}).w(\"<ul class=\\\"tc-ctl-legend-branch\\\">\").s(ctx.get([\"children\"], false), ctx, { \"block\": body_10 }, {}).w(\"</ul></li>\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-legend-node tc-ctl-legend-leaf\\\" \"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-legend-node\\\" \"); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-legend-watch\\\">\").x(ctx.getPath(false, [\"legend\", \"src\"]), ctx, { \"else\": body_5, \"block\": body_8 }, {}).w(\"</div><div class=\\\"tc-ctl-legend-nvr\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"notVisibleAtCurrentResolution\" }).w(\"</div>\"); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.x(ctx.getPath(false, [\"legend\", \"width\"]), ctx, { \"block\": body_6 }, {}); } body_5.__dustBody = !0; function body_6(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-legend-img\\\" style=\\\"border:solid \").f(ctx.getPath(false, [\"legend\", \"strokeWidth\"]), ctx, \"h\").w(\"px \").f(ctx.getPath(false, [\"legend\", \"strokeColor\"]), ctx, \"h\").w(\";background-color:\").f(ctx.getPath(false, [\"legend\", \"fillColor\"]), ctx, \"h\").x(ctx.getPath(false, [\"legend\", \"width\"]), ctx, { \"block\": body_7 }, {}).w(\"\\\"></div>\"); } body_6.__dustBody = !0; function body_7(chk, ctx) { return chk.w(\";width:\").f(ctx.getPath(false, [\"legend\", \"width\"]), ctx, \"h\").w(\"px;height:\").f(ctx.getPath(false, [\"legend\", \"height\"]), ctx, \"h\").w(\"px;border-radius:50%\"); } body_7.__dustBody = !0; function body_8(chk, ctx) { return chk.w(\"<img src=\\\"\\\" data-tc-img=\\\"\").f(ctx.getPath(false, [\"legend\", \"src\"]), ctx, \"h\").w(\"\\\" \").x(ctx.getPath(false, [\"legend\", \"width\"]), ctx, { \"block\": body_9 }, {}).w(\" />\"); } body_8.__dustBody = !0; function body_9(chk, ctx) { return chk.w(\"style=\\\"width:\").f(ctx.getPath(false, [\"legend\", \"width\"]), ctx, \"h\").w(\"px;height:\").f(ctx.getPath(false, [\"legend\", \"height\"]), ctx, \"h\").w(\"px;\\\" \"); } body_9.__dustBody = !0; function body_10(chk, ctx) { return chk.p(\"tc-ctl-legend-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_10.__dustBody = !0; function body_11(chk, ctx) { return chk.f(ctx.get([\"customLegend\"], false), ctx, \"h\", [\"s\"]); } body_11.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    var _dataKeys = {\r\n        layer: 'tcLayer',\r\n        layerUid: 'tcLayerUid'\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        map.on(TC.Consts.event.VIEWCHANGE, function (e) {\r\n            const view = e.view;\r\n            const onLayerAdd = self.loadGraphics.bind(self);\r\n\r\n            if (view === TC.Consts.view.THREED) {                \r\n                map.on(TC.Consts.event.LAYERADD, onLayerAdd);\r\n            } else if (view === TC.Consts.view.DEFAULT) {\r\n                map.off(TC.Consts.event.LAYERADD, onLayerAdd);\r\n            }\r\n        });\r\n\r\n        return TC.control.MapContents.prototype.register.call(self, map);\r\n    };\r\n\r\n    ctlProto.loadGraphics = function () {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            var layer = $(li).data(_dataKeys.layer);\r\n            if (layer) {\r\n                li.querySelectorAll('li.' + self.CLASS + '-node-visible').forEach(function (l) {\r\n                    const img = l.querySelector('img');\r\n                    if (img && img.getAttribute('src') !== undefined && img.getAttribute('src').length === 0) {\r\n                        self.styleLegendImage(img, layer);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.updateScale = function () {\r\n        var self = this;\r\n        var inScale = self.CLASS + '-node-inscale';\r\n        var outOfScale = self.CLASS + '-node-outofscale';\r\n\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            var layer = $(li).data(_dataKeys.layer);\r\n\r\n            if (layer) {\r\n                var layersInScale = false;\r\n                li.querySelectorAll('li').forEach(function (l) {\r\n                    if (l.classList.contains(self.CLASS + '-node-visible')) {\r\n                        var uid = $(l).data(_dataKeys.layerUid);\r\n                        if (layer.isVisibleByScale((uid))) {\r\n                            layersInScale = true;\r\n                            l.classList.remove(outOfScale);\r\n                            l.classList.add(inScale);\r\n                            const img = l.querySelector('img');\r\n                            if (img) {\r\n                                self.styleLegendImage(img, layer);\r\n                            }\r\n                        }\r\n                        else {\r\n                            l.classList.add(outOfScale);\r\n                            l.classList.remove(inScale);\r\n                        }\r\n                    }\r\n                });\r\n                if (layersInScale) {\r\n                    li.classList.remove(outOfScale);\r\n                    li.classList.add(inScale);\r\n                }\r\n                else {\r\n                    li.classList.remove(inScale);\r\n                    li.classList.add(outOfScale);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.update = function () {\r\n        var self = this;\r\n\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            var layer = $(li).data(_dataKeys.layer);\r\n            if (layer) {\r\n                layer.getTree();\r\n\r\n                li.querySelectorAll('li').forEach(function (l) {\r\n                    var uid = $(l).data(_dataKeys.layerUid);\r\n                    var visible = self.CLASS + '-node-visible';\r\n                    var notVisible = self.CLASS + '-node-notvisible';\r\n                    var hasVisible = self.CLASS + '-node-hasvisible';\r\n\r\n                    switch (layer._cache.visibilityStates[uid]) {\r\n                        case TC.Consts.visibility.NOT_VISIBLE:\r\n                            l.classList.remove(visible);\r\n                            l.classList.remove(hasVisible);\r\n                            l.classList.add(notVisible);                            \r\n                            break;\r\n                        case TC.Consts.visibility.HAS_VISIBLE:\r\n                            l.classList.remove(visible);\r\n                            l.classList.remove(notVisible);\r\n                            l.classList.add(hasVisible);                            \r\n                            break;\r\n                        default:\r\n                            // visible\r\n                            l.classList.remove(notVisible);\r\n                            l.classList.remove(hasVisible);\r\n                            l.classList.add(visible);                            \r\n                            break;\r\n                    }\r\n                });\r\n\r\n                self.updateLayerVisibility(layer);\r\n            }\r\n        });\r\n        self.updateScale();\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        var self = this;        \r\n\r\n        if (!layer.isBase && !layer.options.stealth) {\r\n            \r\n            //// 09/04/2019 GLS: ignoramos el atributo que venga en la capa porque en la leyenda queremos que el árbol se muestre siempre y \r\n            //// nos ahorramos el tener que pasarlo en el estado del mapa\r\n            if (layer.hideTree || layer.options.hideTree) {\r\n                layer.tree = null;\r\n                layer.hideTree = layer.options.hideTree = false;\r\n\r\n                layer._cache.visibilityStates = {};\r\n            }            \r\n\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            self.div.querySelector('.' + self.CLASS + '-empty').classList.add(TC.Consts.classes.HIDDEN);            \r\n\r\n            TC.loadJSInOrder(\r\n                !window.dust,\r\n                TC.url.templating,\r\n                function () {\r\n                    dust.render(self.CLASS + '-node', self.layerTrees[layer.id], function (err, out) {\r\n                        const parser = new DOMParser();\r\n                        const newLi = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                        const uid = $(newLi).data(_dataKeys.layerUid);\r\n                        const ul = self.div.querySelector('ul.' + self.CLASS + '-branch');\r\n                        const lis = ul.querySelectorAll('li[data-tc-layer-uid=\"' + uid + '\"]');\r\n                        if (lis.length === 1) {\r\n                            const li = lis[0];\r\n                            li.innerHTML = newLi.innerHTML;\r\n                            li.setAttribute('class', newLi.getAttribute('class')); // Esto actualiza si un nodo deja de ser hoja o pasa a ser hoja\r\n                        }\r\n                        else {\r\n                            $(newLi).data(_dataKeys.layer, layer);\r\n                            ul.insertBefore(newLi, ul.firstChild);\r\n                        }\r\n                        if (err) {\r\n                            TC.error(err);\r\n                        }\r\n                    });\r\n                    self.update();\r\n                }\r\n            );\r\n        }\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        if (!layer.isBase) {\r\n            TC.control.MapContents.prototype.removeLayer.call(this, layer);\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerVisibility = function (layer) {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            if ($(li).data(_dataKeys.layer) === layer) {\r\n                if (layer.getVisibility()) {\r\n                    li.classList.remove(self.CLASS + '-node-notvisible');\r\n                }\r\n                else {\r\n                    li.classList.add(self.CLASS + '-node-notvisible');\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getLayerUIElements = function () {\r\n        const self = this;\r\n        return self.div.querySelector('ul.' + self.CLASS + '-branch').querySelectorAll('li.' + self.CLASS + '-node');\r\n    };\r\n})();\r\n"],"file":"../../Control/Legend.min.js"}