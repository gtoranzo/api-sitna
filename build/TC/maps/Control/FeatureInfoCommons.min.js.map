{"version":3,"sources":["Control/FeatureInfoCommons.js"],"names":["TC","control","Click","syncLoadJS","apiLocation","Consts","event","POPUP","POPUPHIDE","DRAWCHART","DRAWTABLE","RESULTSPANELCLOSE","FeatureInfoCommons","apply","this","arguments","cs","_classSelector","CLASS","_selectors","LIST_ITEM","resultsLayer","filterLayer","_layersPromise","filterFeature","info","popup","resultsPanel","lastFeatureCount","exportsState","displayMode","RESULTS_PANEL","Array","from","toStr","Object","prototype","toString","isCallable","fn","call","maxSafeInteger","Math","pow","toLength","value","len","number","Number","isNaN","isFinite","floor","abs","toInteger","min","max","arrayLike","items","TypeError","T","mapFn","length","kValue","A","k","layerCount","ctl","services","reduce","sCount","service","layers","lCount","layer","inherit","ctlProto","TITLE_SEPARATOR","isDebug","template","dust","register","body_0","chk","ctx","x","get","block","body_1","w","s","else","body_4","body_6","body_30","__dustBody","f","body_2","body_3","h","$key","getPath","nx","body_5","body_7","body_10","body_11","body_29","body_8","body_9","body_12","body_13","body_14","body_16","body_17","body_15","body_18","body_23","body_19","body_22","body_20","body_21","body_24","body_25","key","body_26","body_27","body_28","body_31","type","map","self","result","_createLayers","loaded","shareCtl","getControlsByClass","loadSharedFeature","loadParamFeature","options","setDisplayMode","on","e","getDisplayControl","highlightedFeature","removeFeature","querying","clearFeatures","currentFeature","id","indexOf","_decorateDisplay","setTimeout","LAYERREMOVE","workLayers","filter","layerType","WMS","forEach","names","url","concat","getDisgregatedLayerNames","i","mapNames","mapLayers","arr","name","every","downplayFeatures","closeResults","VIEWCHANGE","render","div","classList","add","classes","HIDDEN","_set1stRenderPromise","Promise","resolve","responseCallback","featureCount","_addSourceAttributes","trigger","FEATUREINFO","$","extend","NOFEATUREINFO","responseError","status","toast","getLocaleString","msgType","ERROR","markerStyle","cssClass","POINT","anchor","width","height","noPrint","mode","rp","ctrl","content","caller","CONTROLADD","setResultsPanel","ResultsPanel","off","addControl","closeButton","draggable","then","onShowPopup","_resetSize","getDisplayTarget","Popup","getContainerElement","getTableContainer","getMenuTarget","getMenuElement","displayResults","clone","cloneNode","remove","data","outerHTML","ControlContainer","p","isVisible","close","open","getInfoContainer","displayResultsCallback","showPopup","getElementIndex","elm","parentElement","childNodes","getParentElement","tagName","getFeatureElement","feature","querySelectorAll","li","currentFeatureLi","currentLayerLi","currentServiceLi","getFeature","getNextFeatureElement","delta","lis","matches","CHECKED","getFeaturePath","ii","j","jj","kk","features","title","prev","cur","path","hide","querySelector","selector","eventType","addEventListener","EventTarget","listenerBySelector","highlightFeature","target","CLICK","contains","style","display","fitToView","defaultFeature","DEFAULT","table","DISABLED","window","getSelection","trim","ZOOM","zoomHandler","_zooming","zoomToFeatures","animate","stopPropagation","a","Modernizr","touch","Util","swipe","left","right","_fitSize","featureObj","insertLinks","linkText","titleText","td","text","textContent","isURL","innerHTML","featureOrElement","featureLi","Feature","layerLi","serviceLi","serviceIdx","layerIdx","featureIdx","exception","FROMLEFT","FROMRIGHT","setAttribute","getFeatureIndex","slice","item","geometry","addFeature","exceptionFLi","undefined","exceptionLLi","exceptionSLi","offsetLeft","offsetWidth","removeProperty","maxj","maxk","beforeRequest","BEFOREFEATUREINFO","xy","activate","wrap","Control","deactivate","stopChain","exportState","importState","state","getUID","VECTOR","stealth","styles","line","strokeColor","lineColor","strokeWidth","polygon","fillColor","fillOpacity","reject","all","addLayer","resultsContainer","loadJS","Print","printTitle","Point","geom","crs","formatNumber","locale","y","showsPopup","serviceAttrName","layerAttrName","newData","join","allData","getData","clearData","setData"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.Click) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/Click');\r\n}\r\n\r\nTC.Consts.event.POPUP = TC.Consts.event.POPUP || 'popup.tc';\r\nTC.Consts.event.POPUPHIDE = TC.Consts.event.POPUPHIDE || 'popuphide.tc';\r\nTC.Consts.event.DRAWCHART = TC.Consts.event.DRAWCHART || 'drawchart.tc';\r\nTC.Consts.event.DRAWTABLE = TC.Consts.event.DRAWTABLE || 'drawtable.tc';\r\nTC.Consts.event.RESULTSPANELCLOSE = TC.Consts.event.RESULTSPANELCLOSE || 'resultspanelclose.tc';\r\n\r\nTC.control.FeatureInfoCommons = function () {\r\n    const self = this;\r\n    TC.control.Click.apply(self, arguments);\r\n\r\n    const cs = self._classSelector = '.' + self.CLASS;\r\n    self._selectors = {\r\n        LIST_ITEM: 'ul' + cs + '-features li'\r\n    };\r\n\r\n    self.resultsLayer = null;\r\n    self.filterLayer = null;\r\n    self._layersPromise = null;\r\n    self.filterFeature = null;\r\n    self.info = null;\r\n    self.popup = null;\r\n    self.resultsPanel = null;\r\n    self.lastFeatureCount = null;\r\n    self.exportsState = true;\r\n};\r\n\r\nTC.control.FeatureInfoCommons.displayMode = {\r\n    POPUP: 'popup',\r\n    RESULTS_PANEL: 'resultsPanel'\r\n};\r\n\r\n(function () {\r\n\r\n    if (!Array.from) {\r\n        Array.from = (function () {\r\n            var toStr = Object.prototype.toString;\r\n            var isCallable = function (fn) {\r\n                return typeof fn === 'function' || toStr.call(fn) === '[object Function]';\r\n            };\r\n            var toInteger = function (value) {\r\n                var number = Number(value);\r\n                if (isNaN(number)) { return 0; }\r\n                if (number === 0 || !isFinite(number)) { return number; }\r\n                return (number > 0 ? 1 : -1) * Math.floor(Math.abs(number));\r\n            };\r\n            var maxSafeInteger = Math.pow(2, 53) - 1;\r\n            var toLength = function (value) {\r\n                var len = toInteger(value);\r\n                return Math.min(Math.max(len, 0), maxSafeInteger);\r\n            };\r\n\r\n            // La propiedad length del método from es 1.\r\n            return function from(arrayLike/*, mapFn, thisArg */) {\r\n                // 1. Deje a C ser el este valor.\r\n                var C = this;\r\n\r\n                // 2. Deje que los elementos sean ToObject(arrayLike).\r\n                var items = Object(arrayLike);\r\n\r\n                // 3. Retornar IfAbrupt(items).\r\n                if (arrayLike == null) {\r\n                    throw new TypeError(\"Array.from requiere un objeto array-like - not null or undefined\");\r\n                }\r\n\r\n                // 4. Si mapfn no está definida, entonces deja que sea false.\r\n                var mapFn = arguments.length > 1 ? arguments[1] : void undefined;\r\n                var T;\r\n                if (typeof mapFn !== 'undefined') {\r\n                    // 5. si no\r\n                    // 5. a If IsCallable(mapfn) es false, lanza una excepción TypeError.\r\n                    if (!isCallable(mapFn)) {\r\n                        throw new TypeError('Array.from: si hay mapFn, el segundo argumento debe ser una función');\r\n                    }\r\n\r\n                    // 5. b. Si thisArg se suministró, deje que T sea thisArg; si no, deje que T esté indefinido.\r\n                    if (arguments.length > 2) {\r\n                        T = arguments[2];\r\n                    }\r\n                }\r\n\r\n                // 10. Let lenValue be Get(items, \"length\").\r\n                // 11. Let len be ToLength(lenValue).\r\n                var len = toLength(items.length);\r\n\r\n                // 13. If IsConstructor(C) is true, then\r\n                // 13. a. Let A be the result of calling the [[Construct]] internal method of C with an argument list containing the single item len.\r\n                // 14. a. Else, Let A be ArrayCreate(len).\r\n                var A = isCallable(C) ? Object(new C(len)) : new Array(len);\r\n\r\n                // 16. Let k be 0.\r\n                var k = 0;\r\n                // 17. Repeat, while k < len… (also steps a - h)\r\n                var kValue;\r\n                while (k < len) {\r\n                    kValue = items[k];\r\n                    if (mapFn) {\r\n                        A[k] = typeof T === 'undefined' ? mapFn(kValue, k) : mapFn.call(T, kValue, k);\r\n                    } else {\r\n                        A[k] = kValue;\r\n                    }\r\n                    k += 1;\r\n                }\r\n                // 18. Let putStatus be Put(A, \"length\", len, true).\r\n                A.length = len;\r\n                // 20. Return A.\r\n                return A;\r\n            };\r\n        }());\r\n    }\r\n\r\n    var layerCount = function (ctl) {\r\n        return ctl.info.services ?\r\n            ctl.info.services.reduce(function (sCount, service) {\r\n                return sCount + service.layers.reduce(function (lCount, layer) {\r\n                    return lCount + 1;\r\n                }, 0);\r\n            }, 0) : 0;\r\n    };\r\n\r\n    TC.inherit(TC.control.FeatureInfoCommons, TC.control.Click);\r\n\r\n    var ctlProto = TC.control.FeatureInfoCommons.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-finfo';\r\n\r\n    ctlProto.TITLE_SEPARATOR = ' • ';\r\n\r\n    if (TC.isDebug) {\r\n        ctlProto.template = TC.apiLocation + \"TC/templates/FeatureInfo.html\";\r\n    }\r\n    else {\r\n        ctlProto.template = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.x(ctx.get([\"elevation\"], false), ctx, { \"block\": body_1 }, {}).w(\"<ul class=\\\"tc-ctl-finfo-services\\\">\").s(ctx.get([\"services\"], false), ctx, { \"else\": body_4, \"block\": body_6 }, {}).w(\"</ul>\").x(ctx.get([\"featureCount\"], false), ctx, { \"block\": body_30 }, {}); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-finfo-coords\\\"><span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-crs\\\">CRS: <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.get([\"crs\"], false), ctx, \"h\").w(\"</span></span> \").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_2, \"block\": body_3 }, {}).w(\" <span class=\\\"tc-ctl-finfo-coords-pair\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"ele\" }).w(\": <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.get([\"elevation\"], false), ctx, \"h\").w(\" m</span></span></div>\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.w(\"<span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x\\\">x: <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.getPath(false, [\"coords\", \"0\"]), ctx, \"h\").w(\"</span></span> <span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x\\\">y: <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.getPath(false, [\"coords\", \"1\"]), ctx, \"h\").w(\"</span></span> \"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.w(\"<span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lat\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"lat\" }).w(\": <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.getPath(false, [\"coords\", \"1\"]), ctx, \"h\").w(\"</span></span> <span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lon\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"lon\" }).w(\": <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.getPath(false, [\"coords\", \"0\"]), ctx, \"h\").w(\"</span></span> \"); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.nx(ctx.get([\"elevation\"], false), ctx, { \"block\": body_5 }, {}); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-finfo-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noData\" }).w(\"</li>\"); } body_5.__dustBody = !0; function body_6(chk, ctx) { return chk.w(\"<li><h3>\").x(ctx.get([\"title\"], false), ctx, { \"else\": body_7, \"block\": body_10 }, {}).w(\"</h3><div class=\\\"tc-ctl-finfo-service-content\\\">\").s(ctx.get([\"hasLimits\"], false), ctx, { \"else\": body_11, \"block\": body_29 }, {}).w(\"</div></li>\"); } body_6.__dustBody = !0; function body_7(chk, ctx) { return chk.x(ctx.getPath(false, [\"layers\", \"0\", \"title\"]), ctx, { \"else\": body_8, \"block\": body_9 }, {}); } body_7.__dustBody = !0; function body_8(chk, ctx) { return chk.f(ctx.getPath(false, [\"layer\", \"name\"]), ctx, \"h\"); } body_8.__dustBody = !0; function body_9(chk, ctx) { return chk.f(ctx.getPath(false, [\"layers\", \"0\", \"title\"]), ctx, \"h\"); } body_9.__dustBody = !0; function body_10(chk, ctx) { return chk.f(ctx.get([\"title\"], false), ctx, \"h\"); } body_10.__dustBody = !0; function body_11(chk, ctx) { return chk.w(\"<ul class=\\\"tc-ctl-finfo-layers\\\">\").s(ctx.get([\"layers\"], false), ctx, { \"else\": body_12, \"block\": body_13 }, {}).w(\"</ul>\"); } body_11.__dustBody = !0; function body_12(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-finfo-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noDataAtThisService\" }).w(\"</li>\"); } body_12.__dustBody = !0; function body_13(chk, ctx) { return chk.w(\"<li><h4><span class=\\\"tc-ctl-finfo-layer-n\\\">\").f(ctx.getPath(false, [\"features\", \"length\"]), ctx, \"h\").w(\"</span> \").s(ctx.get([\"path\"], false), ctx, { \"block\": body_14 }, {}).w(\"</h4> <div class=\\\"tc-ctl-finfo-layer-content\\\"><ul class=\\\"tc-ctl-finfo-features\\\">\").s(ctx.get([\"features\"], false), ctx, { \"else\": body_16, \"block\": body_17 }, {}).w(\"</ul></div></li>\"); } body_13.__dustBody = !0; function body_14(chk, ctx) { return chk.f(ctx.getPath(true, []), ctx, \"h\").h(\"sep\", ctx, { \"block\": body_15 }, {}); } body_14.__dustBody = !0; function body_15(chk, ctx) { return chk.w(\" &bull; \"); } body_15.__dustBody = !0; function body_16(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-finfo-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noDataInThisLayer\" }).w(\"</li>\"); } body_16.__dustBody = !0; function body_17(chk, ctx) { return chk.w(\"<li>\").x(ctx.get([\"rawContent\"], false), ctx, { \"else\": body_18, \"block\": body_23 }, {}).w(\"</li>\"); } body_17.__dustBody = !0; function body_18(chk, ctx) { return chk.x(ctx.get([\"error\"], false), ctx, { \"else\": body_19, \"block\": body_22 }, {}); } body_18.__dustBody = !0; function body_19(chk, ctx) { return chk.w(\"<h5>\").f(ctx.get([\"id\"], false), ctx, \"h\").w(\"</h5><table\").x(ctx.get([\"geometry\"], false), ctx, { \"block\": body_20 }, {}).w(\"><tbody>\").s(ctx.get([\"attributes\"], false), ctx, { \"block\": body_21 }, {}).w(\"</tbody></table>\"); } body_19.__dustBody = !0; function body_20(chk, ctx) { return chk.w(\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"clickToShowOnMap\" }).w(\"\\\"\"); } body_20.__dustBody = !0; function body_21(chk, ctx) { return chk.w(\"<tr><th class=\\\"tc-ctl-finfo-attr\\\">\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"</th><td class=\\\"tc-ctl-finfo-val\\\">\").f(ctx.get([\"value\"], false), ctx, \"h\").w(\"</td></tr>\"); } body_21.__dustBody = !0; function body_22(chk, ctx) { return chk.w(\"<span class=\\\"tc-ctl-finfo-errors\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"fi.error\" }).w(\"<span class=\\\"tc-ctl-finfo-error-text\\\">\").f(ctx.get([\"error\"], false), ctx, \"h\").w(\"</span></span>\"); } body_22.__dustBody = !0; function body_23(chk, ctx) { return chk.w(\"<h5>\").h(\"i18n\", ctx, {}, { \"$key\": \"feature\" }).w(\"</h5>\").h(\"eq\", ctx, { \"else\": body_24, \"block\": body_25 }, { \"key\": ctx.get([\"rawFormat\"], false), \"value\": \"text/html\" }); } body_23.__dustBody = !0; function body_24(chk, ctx) { return chk.w(\"<pre>\").f(ctx.get([\"rawContent\"], false), ctx, \"h\").w(\"</pre>\"); } body_24.__dustBody = !0; function body_25(chk, ctx) { return chk.w(\" \").x(ctx.get([\"expandUrl\"], false), ctx, { \"block\": body_26 }, {}); } body_25.__dustBody = !0; function body_26(chk, ctx) { return chk.h(\"ne\", ctx, { \"else\": body_27, \"block\": body_28 }, { \"key\": ctx.get([\"expandUrl\"], false), \"value\": \"\" }); } body_26.__dustBody = !0; function body_27(chk, ctx) { return chk.w(\"<iframe src=\\\"\").f(ctx.get([\"rawUrl\"], false), ctx, \"h\").w(\"\\\"></iframe>\"); } body_27.__dustBody = !0; function body_28(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-finfo-features-iframe-cnt\\\"><iframe src=\\\"\").f(ctx.get([\"rawUrl\"], false), ctx, \"h\").w(\"\\\"></iframe><a class=\\\"tc-ctl-finfo-open\\\" onclick=\\\"window.open('\").f(ctx.get([\"expandUrl\"], false), ctx, \"h\").w(\"', '_blank')\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"expand\" }).w(\"\\\"></a></div>\"); } body_28.__dustBody = !0; function body_29(chk, ctx) { return chk.w(\"<span class=\\\"tc-ctl-finfo-errors\\\">\").f(ctx.get([\"hasLimits\"], false), ctx, \"h\").w(\"</span>\"); } body_29.__dustBody = !0; function body_30(chk, ctx) { return chk.h(\"gt\", ctx, { \"block\": body_31 }, { \"key\": ctx.get([\"featureCount\"], false), \"value\": \"1\", \"type\": \"number\" }); } body_30.__dustBody = !0; function body_31(chk, ctx) { return chk.w(\"<a class=\\\"tc-ctl-btn tc-ctl-finfo-btn-prev\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"previous\" }).w(\"</a><div class=\\\"tc-ctl-finfo-counter\\\"><span class=\\\"tc-ctl-finfo-counter-current\\\"></span>/\").f(ctx.get([\"featureCount\"], false), ctx, \"h\").w(\"</div><a class=\\\"tc-ctl-btn tc-ctl-finfo-btn-next\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"next\" }).w(\"</a>\"); } body_31.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        const result = TC.control.Click.prototype.register.call(self, map);\r\n\r\n        self._createLayers();\r\n\r\n        map.loaded(function () {\r\n            const shareCtl = map.getControlsByClass('TC.control.Share')[0];\r\n            if (shareCtl) {\r\n                self.loadSharedFeature(shareCtl.loadParamFeature());\r\n            }\r\n        });\r\n\r\n        self.displayMode = self.options.displayMode || TC.control.FeatureInfoCommons.displayMode.POPUP;\r\n        self.setDisplayMode(self.displayMode);\r\n\r\n        map\r\n            .on(TC.Consts.event.POPUPHIDE + ' ' + TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                if (e.control === self.getDisplayControl() && self.resultsLayer) {\r\n                    if (self.highlightedFeature) {\r\n                        self.resultsLayer.removeFeature(self.highlightedFeature);\r\n                        self.highlightedFeature = null;\r\n                    }\r\n                    if (!self.querying) {\r\n                        self.filterLayer.clearFeatures();\r\n                    }\r\n                }\r\n            })\r\n            .on(TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                self.highlightedFeature = null;\r\n            })\r\n            .on(TC.Consts.event.POPUP + ' ' + TC.Consts.event.DRAWTABLE + ' ' + TC.Consts.event.DRAWCHART, function (e) {\r\n                const control = e.control;\r\n                if (control.currentFeature !== self.filterFeature) {\r\n                    self.highlightedFeature = control.currentFeature;\r\n                }\r\n\r\n                // GLS: si la feature es resultado de GFI decoramos\r\n                if (e.control.currentFeature && e.control.currentFeature.layer && [self.filterLayer.id, self.resultsLayer.id].indexOf(e.control.currentFeature.layer.id) > -1) {\r\n                    self._decorateDisplay(control);\r\n                }\r\n            })\r\n            .on(TC.Consts.event.DRAWCHART, function (e) {\r\n                setTimeout(function () {\r\n                    self.highlightedFeature = e.control.currentFeature;\r\n                }, 50);\r\n            })\r\n            .on(TC.Consts.event.LAYERREMOVE, function () {\r\n                if (self.info && self.info.services) {\r\n                    const services = {};\r\n                    self.map.workLayers\r\n                        .filter(function (layer) {\r\n                            return layer.type === TC.Consts.layerType.WMS;\r\n                        })\r\n                        .forEach(function (layer) {\r\n                            const names = services[layer.url] || [];\r\n                            services[layer.url] = names.concat(layer.getDisgregatedLayerNames())\r\n                        });\r\n                    for (var i = 0, len = self.info.services.length; i < len; i++) {\r\n                        const service = self.info.services[i];\r\n                        const mapNames = services[service.mapLayers[0].url] || [];\r\n                        const infoNames = service.layers.reduce(function (arr, layer) {\r\n                            return arr.concat(layer.name);\r\n                        }, []);\r\n                        if (!infoNames.every(function (name) {\r\n                            return mapNames.indexOf(name) >= 0;\r\n                        })) {\r\n                            // En el objeto info hay capas que no están ya en el mapa: borramos resultados.\r\n                            self.downplayFeatures();\r\n                            self.info = null;\r\n                            self.closeResults();\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            })\r\n            .on(TC.Consts.event.VIEWCHANGE, function (e) {                \r\n                self.closeResults();\r\n            });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.render = function () {\r\n        const self = this;\r\n        // Este div se usa como buffer, así que no debe ser visible.\r\n        self.div.classList.add(TC.Consts.classes.HIDDEN);\r\n        return self._set1stRenderPromise(Promise.resolve());\r\n    };\r\n\r\n    ctlProto.responseCallback = function (options) {\r\n        const self = this;\r\n        self.querying = false;\r\n\r\n        if (self.filterFeature) {\r\n            self.info = { services: options.services };\r\n        }\r\n\r\n        if (!options.featureCount) {\r\n            self.lastFeatureCount = 0;\r\n            self.map.trigger(TC.Consts.event.NOFEATUREINFO, { control: self });\r\n            self.closeResults();\r\n        }\r\n        else {\r\n            self._addSourceAttributes();\r\n            self.lastFeatureCount = options.featureCount;\r\n            self.map.trigger(TC.Consts.event.FEATUREINFO, $.extend({ control: self }, options));\r\n        }\r\n    };\r\n\r\n    ctlProto.responseError = function (options) {\r\n        const self = this;\r\n        if (options.status === 404) {\r\n            self.map.toast(self.getLocaleString(\"featureInfo.tooManyLayers\"), { type: TC.Consts.msgType.ERROR });\r\n        }\r\n        self.responseCallback({});\r\n    };\r\n\r\n    ctlProto.markerStyle = {\r\n        cssClass: TC.Consts.classes.POINT,\r\n        anchor: [0.5, 0.5],\r\n        width: 15,\r\n        height: 15,\r\n        noPrint: true\r\n    };\r\n\r\n    ctlProto.setDisplayMode = function (mode) {\r\n        var self = this;\r\n        self.displayMode = mode;\r\n        var map = self.map;\r\n        switch (mode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                if (!self.resultsPanel) {\r\n                    var rp = map.getControlsByClass('TC.control.ResultsPanel').filter(function (ctrl) { return ctrl.options.content === \"table\" })[0];\r\n                    if (rp) {\r\n                        self.resultsPanel = rp;\r\n                        rp.caller = self;\r\n                    }\r\n                    else {\r\n                        var setResultsPanel = function setResultsPanel(e) {\r\n                            const control = e.control;\r\n                            if (TC.control.ResultsPanel && control instanceof TC.control.ResultsPanel) {\r\n                                self.resultsPanel = control;\r\n                                control.caller = self;\r\n                                map.off(TC.Consts.event.CONTROLADD, setResultsPanel);\r\n                            }\r\n                        };\r\n                        map.on(TC.Consts.event.CONTROLADD, setResultsPanel);\r\n                    }\r\n                }\r\n                break;\r\n            default:\r\n                self.displayMode = TC.control.FeatureInfoCommons.displayMode.POPUP;\r\n                if (!self.popup) {\r\n                    map.addControl('popup', {\r\n                        closeButton: true,\r\n                        draggable: self.options.draggable\r\n                    }).then(function (popup) {\r\n                        self.popup = popup;\r\n                        popup.caller = self;\r\n                        map.on(TC.Consts.event.POPUP, function (e) {\r\n                            self.onShowPopup(e);\r\n                        });\r\n\r\n                        map.on(TC.Consts.event.POPUPHIDE, function (e) {\r\n                            if (e.control === popup) {\r\n                                //restaurar el ancho automático\r\n                                self._resetSize();\r\n                            }\r\n                        });\r\n                    });\r\n                }\r\n                break;\r\n        }\r\n    };\r\n\r\n    ctlProto.getDisplayControl = function () {\r\n        var self = this;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                return self.resultsPanel;\r\n            default:\r\n                return self.popup;\r\n        }\r\n    };\r\n\r\n    ctlProto.getDisplayTarget = function (options) {\r\n        var self = this;\r\n        options = options || {};\r\n        if (options.control) {\r\n            switch (true) {\r\n                case TC.control.Popup && options.control instanceof TC.control.Popup:\r\n                    return options.control.getContainerElement();\r\n                case TC.control.ResultsPanel && options.control instanceof TC.control.ResultsPanel:\r\n                    return options.control.getTableContainer();\r\n                default:\r\n                    return null;\r\n            }\r\n        }\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                return self.resultsPanel.getTableContainer();\r\n            default:\r\n                return self.popup.getContainerElement();\r\n        }\r\n    };\r\n\r\n    ctlProto.getMenuTarget = function () {\r\n        var self = this;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                return self.resultsPanel.getMenuElement();\r\n            default:\r\n                return self.popup.getMenuElement();\r\n        }\r\n    };\r\n\r\n    ctlProto.displayResults = function () {\r\n        var self = this;\r\n        const clone = self.div.cloneNode(true);\r\n        clone.classList.remove(TC.Consts.classes.HIDDEN);\r\n        self.filterFeature.data = clone.outerHTML;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                if (self.resultsPanel) {\r\n\r\n                    // GLS: si contamos con el control de controles no es necesario cerrar los paneles visibles ya que no habría solape\r\n                    if (self.map.getControlsByClass(TC.control.ControlContainer).length === 0) {\r\n                        self.map.getControlsByClass(TC.control.ResultsPanel).forEach(function (p) {\r\n                            if (p.isVisible()) {\r\n                                p.close();\r\n                            }\r\n                        });\r\n                    } else {\r\n                        // cerramos los paneles con feature asociada\r\n                        const panels = self.map.getControlsByClass('TC.control.ResultsPanel');\r\n                        panels.forEach(function (p) {\r\n                            if (p !== self.resultsPanel && p.currentFeature) {\r\n                                p.close();\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    self.resultsPanel.currentFeature = self.filterFeature;\r\n                    self.resultsPanel.open(self.filterFeature.data, self.resultsPanel.getInfoContainer());\r\n                    \r\n\r\n                    self.displayResultsCallback();\r\n                }\r\n\r\n                break;\r\n            default:\r\n                if (self.popup) {\r\n                    self.filterFeature.showPopup(self.popup);\r\n                }\r\n                break;\r\n        }\r\n    };\r\n\r\n    const getElementIndex = function (elm) {\r\n        return Array.from(elm.parentElement.childNodes).indexOf(elm);\r\n    };\r\n\r\n    const getParentElement = function (elm, tagName) {\r\n        var result = elm;\r\n        do {\r\n            result = result.parentElement;\r\n        }\r\n        while (result && result.tagName !== tagName);\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getFeatureElement = function (feature) {\r\n        const self = this;\r\n        var result;\r\n        const getIndex = function (elm) {\r\n            return Array.from(elm.parentElement.childNodes).getIndex(elm);\r\n        };\r\n        self.getDisplayTarget().querySelectorAll(self._selectors.LIST_ITEM).forEach(function (li) {\r\n            const currentFeatureLi = li;\r\n            const currentLayerLi = getParentElement(li, 'LI');\r\n            const currentServiceLi = getParentElement(currentLayerLi, 'LI');\r\n            var feat = self.getFeature(getElementIndex(currentServiceLi), getElementIndex(currentLayerLi), getElementIndex(currentFeatureLi));\r\n            if (feat === feature) {\r\n                result = currentFeatureLi;\r\n            }\r\n        });\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getNextFeatureElement = function (delta) {\r\n        const self = this;\r\n        const lis = self.getDisplayTarget().querySelectorAll('ul.' + self.CLASS + '-features > li');\r\n        const length = lis.length;\r\n        for (var i = 0; i < length; i++) {\r\n            if (lis[i].matches('.' + TC.Consts.classes.CHECKED)) {\r\n                return lis[(i + delta + length) % length]\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.getFeaturePath = function (feature) {\r\n        const self = this;\r\n        if (self.info && self.info.services) {\r\n            for (var i = 0, ii = self.info.services.length; i < ii; i++) {\r\n                const service = self.info.services[i];\r\n                for (var j = 0, jj = service.layers.length; j < jj; j++) {\r\n                    const layer = service.layers[j];\r\n                    for (var k = 0, kk = layer.features.length; k < kk; k++) {\r\n                        if (layer.features[k] === feature) {\r\n                            return {\r\n                                service: service.title || service.mapLayers.reduce(function (prev, cur) {\r\n                                    return prev || cur.title;\r\n                                }, ''),\r\n                                layer: layer.path\r\n                            };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.closeResults = function () {\r\n        var self = this;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                if (self.resultsPanel && self.resultsPanel.isVisible()) {\r\n                    self.resultsPanel.close();\r\n                }\r\n                break;\r\n            default:\r\n                if (self.popup && self.popup.isVisible()) {\r\n                    self.popup.hide();\r\n                }\r\n                break;\r\n        }\r\n    };\r\n\r\n    ctlProto.displayResultsCallback = function () {\r\n        var self = this;\r\n        const content = self.getDisplayTarget().querySelector('.' + self.CLASS);\r\n\r\n        var selector;\r\n        // Evento para resaltar una feature\r\n        var eventType = 'click'; // En iPad se usa click en vez de touchstart para evitar que se resalte una feature al hacer scroll\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(self._selectors.LIST_ITEM, function (e) {\r\n            self.highlightFeature(e.target);\r\n        }));\r\n\r\n        // Evento para ir a la siguiente feature\r\n        eventType = TC.Consts.event.CLICK;\r\n        selector = '.' + self.CLASS + '-btn-next';\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            self.highlightFeature(self.getNextFeatureElement(1), 1);\r\n            return false;\r\n        }));\r\n\r\n        // Evento para ir a la feature anterior\r\n        selector = '.' + self.CLASS + '-btn-prev';\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            self.highlightFeature(self.getNextFeatureElement(-1), -1);\r\n            return false;\r\n        }));\r\n\r\n        // Evento para desplegar/replegar features de capa\r\n        selector = 'ul.' + self.CLASS + '-layers h4';\r\n\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            const li = getParentElement(e.target, 'LI');\r\n            if (li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                // Si no está en modo móvil ocultamos la capa (si hay más de una)\r\n                if (content.querySelector('.tc-ctl-finfo-btn-next') && content.querySelector('.tc-ctl-finfo-btn-next').style.display === 'none') {\r\n                    if (layerCount(self) > 1) {\r\n                        self.downplayFeatures();\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                self.highlightFeature(li.querySelector(self._selectors.LIST_ITEM));\r\n                if (self.displayMode === TC.control.FeatureInfoCommons.displayMode.POPUP) {\r\n                    self.popup.fitToView(true);\r\n                }\r\n            }\r\n        }));\r\n\r\n        // Evento para borrar la feature resaltada\r\n        selector = '.' + self.CLASS + '-del-btn';\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            self.downplayFeatures();\r\n            self.closeResults();\r\n        }));\r\n\r\n        if (self.info) {\r\n            if (self.info.defaultFeature && self.getFeatureElement(self.info.defaultFeature)) {\r\n                self.getFeatureElement(self.info.defaultFeature).classList.add(TC.Consts.classes.DEFAULT);\r\n                self.highlightFeature(self.info.defaultFeature);\r\n            }\r\n            else if (content.querySelector(self._selectors.LIST_ITEM)) {\r\n                self.highlightFeature(content.querySelector(self._selectors.LIST_ITEM));\r\n            }\r\n        }\r\n\r\n        content.querySelectorAll('table').forEach(function (table) {\r\n            table.addEventListener(TC.Consts.event.CLICK, function (e) {                \r\n                const li = this.parentElement;\r\n                if (li.classList.contains(TC.Consts.classes.DISABLED)) {\r\n                    return;\r\n                }\r\n                if (li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                    // Si ya está seleccionada hacemos zoom\r\n                    if (self.resultsLayer.features[0] && window.getSelection() && window.getSelection().toString().trim().length === 0) {\r\n                        // Proceso para desactivar highlightFeature mientras hacemos zoom\r\n                        var zoomHandler = function zoomHandler() {\r\n                            self._zooming = false;\r\n                            self.map.off(TC.Consts.event.ZOOM, zoomHandler);\r\n                        };\r\n                        self.map.on(TC.Consts.event.ZOOM, zoomHandler);\r\n                        self._zooming = true;\r\n                        ///////\r\n                        \r\n                        self.map.zoomToFeatures([self.resultsLayer.features[0]], { animate: true });\r\n                    }\r\n                }\r\n                else {\r\n                    // Si no está seleccionada la seleccionamos\r\n                    self.highlightFeature(li);\r\n                }\r\n                e.stopPropagation();\r\n            });\r\n        });\r\n        content.querySelectorAll('table a').forEach(function (a) {\r\n            a.addEventListener(\"click\", function (e) {\r\n                e.stopPropagation();\r\n            });\r\n        });\r\n\r\n        if (Modernizr.touch && self.displayMode === TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL) {\r\n            if (content.querySelector('.' + self.CLASS + '-btn-prev') && content.querySelector('.' + self.CLASS + '-btn-prev').style.display !== 'none') { // Si los botones de anterior/siguiente están visibles, montamos el swipe\r\n                if (self.resultsPanel) {\r\n                    TC.Util.swipe(self.resultsPanel.div, 'disable');\r\n                }\r\n\r\n                if (layerCount(self) > 1) {\r\n                    TC.Util.swipe(content, {\r\n                        left: function () {\r\n                            self.highlightFeature(self.getNextFeatureElement(1), 1);\r\n                        },\r\n                        right: function () {\r\n                            self.highlightFeature(self.getNextFeatureElement(-1), -1);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.onShowPopup = function (e) {\r\n        var self = this;\r\n        var map = self.map;\r\n        var transitionEnd = 'transitionend.tc';\r\n        if (e.control === self.popup) {\r\n\r\n            self.displayResultsCallback();\r\n\r\n            //ajustar el ancho para que no sobre a la derecha\r\n            self._fitSize();\r\n        }\r\n    };\r\n\r\n    ctlProto.loadSharedFeature = function (featureObj) {\r\n\r\n    };\r\n\r\n    ctlProto.insertLinks = function () {\r\n        var self = this;\r\n        const linkText = self.getLocaleString('open');\r\n        const titleText = self.getLocaleString('linkInNewWindow');\r\n        self.div.querySelectorAll('td.' + self.CLASS + '-val').forEach(function (td) {\r\n            const text = td.textContent;\r\n            if (TC.Util.isURL(text)) {\r\n                td.innerHTML = '<a href=\"' + text + '\" target=\"_blank\" title=\"' + titleText + '\">' + linkText + '</a>';\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.highlightFeature = function (featureOrElement, delta) {\r\n        const self = this;\r\n        var feature;\r\n        if (!self._zooming) {\r\n            var featureLi;\r\n            // this puede ser o el elemento HTML de la lista correspondiente a la feature o la feature en sí\r\n            if (featureOrElement instanceof TC.Feature) {\r\n                feature = featureOrElement;\r\n                featureLi = self.getFeatureElement(feature);\r\n            }\r\n            else {\r\n                featureLi = featureOrElement;\r\n                while (featureLi && featureLi.tagName !== 'LI') {\r\n                    featureLi = featureLi.parentElement;\r\n                }\r\n            }\r\n            const layerLi = getParentElement(featureLi, 'LI');\r\n            const serviceLi = getParentElement(layerLi, 'LI');\r\n\r\n            const serviceIdx = getElementIndex(serviceLi);\r\n            const layerIdx = getElementIndex(layerLi);\r\n            const featureIdx = getElementIndex(featureLi);\r\n            feature = feature || self.getFeature(serviceIdx, layerIdx, featureIdx);\r\n\r\n            self.downplayFeatures({ exception: feature });\r\n            featureLi.classList.add(TC.Consts.classes.CHECKED);\r\n            layerLi.classList.add(TC.Consts.classes.CHECKED);\r\n            serviceLi.classList.add(TC.Consts.classes.CHECKED);\r\n            if (delta > 0) {\r\n                featureLi.classList.add(TC.Consts.classes.FROMLEFT);\r\n                layerLi.classList.add(TC.Consts.classes.FROMLEFT);\r\n                serviceLi.classList.add(TC.Consts.classes.FROMLEFT);\r\n            }\r\n            else if (delta < 0) {\r\n                featureLi.classList.add(TC.Consts.classes.FROMRIGHT);\r\n                layerLi.classList.add(TC.Consts.classes.FROMRIGHT);\r\n                serviceLi.classList.add(TC.Consts.classes.FROMRIGHT);\r\n            }\r\n\r\n            if (featureLi.querySelector('table')) {\r\n                featureLi.querySelector('table').setAttribute('title', self.getLocaleString('clickToCenter'));\r\n            }\r\n\r\n            self.highlightedFeature = feature;\r\n\r\n            if (self.getDisplayTarget().querySelector('.' + self.CLASS + '-counter-current')) {\r\n                self.getDisplayTarget().querySelector('.' + self.CLASS + '-counter-current').innerHTML = self.getFeatureIndex(serviceIdx, layerIdx, featureIdx) + 1;\r\n            }\r\n\r\n\r\n            var features = self.resultsLayer.features.slice();\r\n            var featureAlreadyHighlighted = features.filter(function (item) {\r\n                return feature && feature.id === item.id;\r\n            });\r\n\r\n            //Si la feature a resaltar ya está resaltada, no hacemos nada. Así evitamos parpadeo\r\n            if (featureAlreadyHighlighted.length > 0) {\r\n                return;\r\n            }\r\n\r\n            for (var i = 0; i < features.length; i++) {\r\n                var f = features[i];\r\n                if (f !== self.filterFeature) {\r\n                    self.resultsLayer.removeFeature(f);\r\n                }\r\n            }\r\n            if (feature && feature.geometry) {\r\n                self.resultsLayer.addFeature(feature);\r\n            }\r\n            else {\r\n                featureLi.classList.add(TC.Consts.classes.DISABLED);\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.downplayFeatures = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        if (self.highlightedFeature !== options.exception) {\r\n            self.highlightedFeature = null;\r\n        }\r\n        const exceptionFLi = options.exception ? self.getFeatureElement(options.exception) : undefined;\r\n        var exceptionLLi, exceptionSLi;\r\n        if (exceptionFLi) {\r\n            exceptionLLi = getParentElement(exceptionFLi, 'LI');\r\n            exceptionSLi = getParentElement(exceptionLLi, 'LI');\r\n        }\r\n\r\n        self.resultsLayer.clearFeatures();\r\n        const target = self.getDisplayTarget();\r\n        Array.from(target.querySelectorAll('ul.' + self.CLASS + '-services li'))\r\n            .filter(function (li) {\r\n                return li !== exceptionFLi && li !== exceptionLLi && li !== exceptionSLi;\r\n            })\r\n            .forEach(function (li) {\r\n                li.classList.remove(TC.Consts.classes.CHECKED);\r\n                li.classList.remove(TC.Consts.classes.DISABLED);\r\n                li.classList.remove(TC.Consts.classes.FROMLEFT);\r\n                li.classList.remove(TC.Consts.classes.FROMRIGHT);\r\n            })\r\n        target.querySelectorAll('.' + self.CLASS + '-features table').forEach(function (table) {\r\n            table.setAttribute('title', self.getLocaleString('clickToShowOnMap'));\r\n        });\r\n    };\r\n\r\n    ctlProto._fitSize = function () {\r\n        const self = this;\r\n        const target = self.getDisplayTarget();\r\n        var max = 0;\r\n        //medir la máxima anchura de <ul>\r\n        target.querySelectorAll(\".tc-ctl-finfo-features li\").forEach(function (elm) {\r\n            max = Math.max(max, elm.offsetLeft + elm.offsetWidth);\r\n        });\r\n\r\n        //alert(\"max=\" + max);\r\n        if (max) {\r\n            target.style.width = max + 50 + 'px';\r\n        }\r\n    };\r\n\r\n    ctlProto._resetSize = function () {\r\n        const self = this;\r\n        self.getDisplayTarget().style.removeProperty('width');\r\n    };\r\n\r\n    ctlProto.getFeature = function (serviceIdx, layerIdx, featureIdx) {\r\n        const self = this;\r\n        var result;\r\n        const info = self.info;\r\n        if (info && info.services) {\r\n            result = info.services[serviceIdx];\r\n            if (result) {\r\n                result = result.layers[layerIdx];\r\n                if (result) {\r\n                    result = result.features[featureIdx];\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getFeatureIndex = function (serviceIdx, layerIdx, featureIdx) {\r\n        const self = this;\r\n        var result = -1;\r\n        const info = self.info;\r\n        if (info) {\r\n            for (var i = 0; i <= serviceIdx; i++) {\r\n                var service = info.services[i];\r\n                var maxj = i === serviceIdx ? layerIdx : service.layers.length - 1;\r\n                for (var j = 0; j <= maxj; j++) {\r\n                    var layer = service.layers[j];\r\n                    var maxk = j === layerIdx ? featureIdx : layer.features.length - 1;\r\n                    for (var k = 0; k <= maxk; k++) {\r\n                        result = result + 1;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.beforeRequest = function (options) {\r\n        var self = this;\r\n        self.querying = true;\r\n        self.map.trigger(TC.Consts.event.BEFOREFEATUREINFO, {\r\n            xy: options.xy,\r\n            control: self\r\n        });\r\n        self.closeResults();\r\n        if (self.map && self.resultsLayer) {\r\n            self.lastFeatureCount = null;\r\n\r\n            self.resultsLayer.features.forEach(function (feature) {\r\n                self.resultsLayer.removeFeature(feature);\r\n            });\r\n            self.info = null;\r\n        }\r\n    };\r\n\r\n    ctlProto.activate = function () {\r\n        var self = this;\r\n        if (self.wrap) {\r\n            self.wrap.activate();\r\n        }\r\n        TC.Control.prototype.activate.call(self);\r\n    };\r\n\r\n    ctlProto.deactivate = function (stopChain) {\r\n        var self = this;\r\n        if (self.popup) {\r\n            self.popup.hide();\r\n        }\r\n        self.resultsLayer.clearFeatures();\r\n        self.filterLayer.clearFeatures();\r\n        if (self.wrap) {\r\n            self.wrap.deactivate();\r\n        }\r\n        TC.Control.prototype.deactivate.call(self, stopChain);\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState && self.resultsLayer) {\r\n            return {\r\n                id: self.id,\r\n                layer: self.resultsLayer.exportState()\r\n            };\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        self._layersPromise.then(function () {\r\n            self.resultsLayer.importState(state.layer);\r\n        });\r\n    };\r\n\r\n    ctlProto._createLayers = function () {\r\n        const self = this;\r\n\r\n        var resultsLayer;\r\n        if (self.options.resultsLayer) { // En caso de que se haya indicado una capa por configuración, la utilizamos\r\n            resultsLayer = self.options.resultsLayer;\r\n        } else {\r\n            resultsLayer = {\r\n                id: self.getUID(),\r\n                title: self.CLASS + ': Results layer',\r\n                type: TC.Consts.layerType.VECTOR,\r\n                stealth: true\r\n            };\r\n        }\r\n        var filterLayer;\r\n        if (self.options.filterLayer) {\r\n            filterLayer = self.options.filterLayer;\r\n        }\r\n        else {\r\n            filterLayer = {\r\n                id: self.getUID(),\r\n                title: self.CLASS + ': Filter layer',\r\n                stealth: true,\r\n                type: TC.Consts.layerType.VECTOR\r\n                , styles: {\r\n                    line: { strokeColor: self.lineColor, strokeWidth: 2 },\r\n                    polygon: { strokeColor: self.lineColor, strokeWidth: 2, fillColor: \"#000\", fillOpacity: 0.3 }\r\n                }\r\n            };\r\n        }\r\n\r\n        const map = self.map;\r\n        self._layersPromise = new Promise(function (resolve, reject) {\r\n            map.loaded(function () {\r\n                Promise.all([map.addLayer(resultsLayer), map.addLayer(filterLayer)]).then(function (layers) {\r\n                    self.resultsLayer = layers[0];\r\n                    self.filterLayer = layers[1];\r\n                    resolve();\r\n                });\r\n            });\r\n        });\r\n\r\n        return self._layersPromise;\r\n    };\r\n\r\n    ctlProto._decorateDisplay = function (ctl) {\r\n        const self = this;        \r\n\r\n        const resultsContainer = self.getDisplayTarget({ control: ctl });\r\n\r\n        // Añadimos botón de imprimir\r\n        TC.loadJS(\r\n            !TC.control.Print,\r\n            [TC.apiLocation + 'TC/control/Print'],\r\n            function () {\r\n                if (!resultsContainer.querySelectorAll('.' + TC.control.Print.prototype.CLASS + '-btn').length) {\r\n                    var printTitle = self.getLocaleString(\"feature\");\r\n                    if (ctl === self.getDisplayControl()) {\r\n                        if (TC.feature.Point && self.filterFeature instanceof TC.feature.Point) {\r\n                            const geom = self.filterFeature.geometry;\r\n                            printTitle = self.getLocaleString('featuresAt', {\r\n                                crs: self.map.crs,\r\n                                x: TC.Util.formatNumber(geom[0], self.map.locale),\r\n                                y: TC.Util.formatNumber(geom[1], self.map.locale)\r\n                            });\r\n                        }\r\n                        else {\r\n                            printTitle = self.getLocaleString('spatialQueryResults');\r\n                        }\r\n                    }\r\n                    else if (ctl.currentFeature) {\r\n                        printTitle = ctl.currentFeature.id;\r\n                    }\r\n                    // Si hay datos porque el popup es de un GFI con éxito o es de una feature resaltada damos la opción de imprimirlos\r\n                    if (self.lastFeatureCount || (ctl.currentFeature && ctl.currentFeature.showsPopup === true)) {\r\n                        new TC.control.Print({\r\n                            target: resultsContainer,\r\n                            title: printTitle\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        );\r\n    };\r\n\r\n    ctlProto._addSourceAttributes = function () {\r\n        const self = this;\r\n        const serviceAttrName = 'h3_' + self.getLocaleString('service');\r\n        const layerAttrName = 'h4_' + self.getLocaleString('layer');\r\n        // Añadimos como atributos los títulos de servicio y capa\r\n        if (self.info && self.info.services) {\r\n            self.info.services.forEach(function (service) {\r\n                service.layers.forEach(function (layer) {\r\n                    layer.features.forEach(function (feature) {\r\n                        if (feature instanceof TC.Feature) {\r\n                            const path = self.getFeaturePath(feature);\r\n                            if (path) {\r\n                                const newData = {};\r\n                                newData[serviceAttrName] = path.service;\r\n                                if (path.layer) {\r\n                                    newData[layerAttrName] = path.layer.join(self.TITLE_SEPARATOR);\r\n                                }\r\n                                const allData = $.extend(newData, feature.getData());\r\n                                feature.clearData();\r\n                                feature.setData(allData);\r\n                            }\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n})();\r\n"],"file":"../../Control/FeatureInfoCommons.min.js"}