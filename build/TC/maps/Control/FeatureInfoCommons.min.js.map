{"version":3,"sources":["control/FeatureInfoCommons.js"],"names":["TC","control","Click","syncLoadJS","apiLocation","Consts","event","POPUP","POPUPHIDE","DRAWCHART","DRAWTABLE","RESULTSPANELCLOSE","FeatureInfoCommons","apply","this","arguments","cs","_classSelector","CLASS","_selectors","LIST_ITEM","resultsLayer","filterLayer","_layersPromise","filterFeature","info","popup","resultsPanel","lastFeatureCount","exportsState","displayMode","RESULTS_PANEL","inherit","ctlProto","prototype","TITLE_SEPARATOR","isDebug","template","dust","register","body_0","chk","ctx","x","get","block","body_1","w","s","else","body_4","body_6","body_30","__dustBody","f","body_2","body_3","h","$key","getPath","nx","body_5","body_7","body_10","body_11","body_29","body_8","body_9","body_12","body_13","body_14","body_16","body_17","body_15","body_18","body_23","body_19","body_22","body_20","body_21","body_24","body_25","key","value","body_26","body_27","body_28","body_31","type","map","self","result","call","_createLayers","loaded","shareCtl","getControlsByClass","loadSharedFeature","loadParamFeature","options","setDisplayMode","on","e","getDisplayControl","highlightedFeature","removeFeature","querying","feature","currentFeature","layer","id","indexOf","_decorateDisplay","setTimeout","LAYERREMOVE","services","workLayers","filter","layerType","WMS","forEach","names","url","concat","getDisgregatedLayerNames","i","len","length","service","mapNames","mapLayers","layers","reduce","arr","name","every","downplayFeatures","closeResults","VIEWCHANGE","render","div","classList","add","classes","HIDDEN","_set1stRenderPromise","Promise","resolve","responseCallback","featureCount","_addSourceAttributes","trigger","FEATUREINFO","Util","extend","NOFEATUREINFO","responseError","status","toast","getLocaleString","msgType","ERROR","markerStyle","cssClass","POINT","anchor","width","height","noPrint","mode","rp","ctrl","content","caller","CONTROLADD","setResultsPanel","ResultsPanel","off","addControl","closeButton","draggable","then","onShowPopup","_resetSize","getDisplayTarget","Popup","getContainerElement","getTableContainer","getMenuTarget","getMenuElement","displayResults","clone","cloneNode","remove","data","outerHTML","ControlContainer","p","isVisible","close","open","getInfoContainer","displayResultsCallback","showPopup","getElementIndex","elm","Array","from","parentElement","childNodes","getParentElement","tagName","getFeatureElement","querySelectorAll","li","currentFeatureLi","currentLayerLi","currentServiceLi","getFeature","getNextFeatureElement","delta","lis","matches","CHECKED","getFeaturePath","ii","j","jj","k","kk","features","title","prev","cur","path","hide","querySelector","selector","ctl","eventType","addEventListener","EventTarget","listenerBySelector","highlightFeature","target","CLICK","contains","anotherLayer","getComputedStyle","display","fitToView","defaultFeature","DEFAULT","table","DISABLED","window","getSelection","toString","trim","ZOOM","zoomHandler","_zooming","zoomToFeatures","animate","stopPropagation","a","browserFeatures","touch","style","swipe","sCount","lCount","left","right","_fitSize","featureObj","insertLinks","linkText","titleText","td","text","textContent","isURL","innerHTML","featureOrElement","featureLi","Feature","layerLi","serviceLi","serviceIdx","layerIdx","featureIdx","exception","FROMLEFT","FROMRIGHT","setAttribute","getFeatureIndex","slice","item","geometry","addFeature","exceptionFLi","undefined","exceptionLLi","exceptionSLi","clearFeatures","max","Math","offsetLeft","offsetWidth","removeProperty","maxj","maxk","beforeRequest","BEFOREFEATUREINFO","xy","activate","wrap","Control","deactivate","stopChain","exportState","importState","state","getUID","VECTOR","stealth","styles","line","strokeColor","lineColor","strokeWidth","polygon","fillColor","fillOpacity","reject","all","addLayer","resultsContainer","loadJS","Print","printTitle","Point","geom","crs","formatNumber","locale","y","showsPopup","serviceAttrName","layerAttrName","newData","join","allData","getData","clearData","setData"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.Click) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/Click');\r\n}\r\n\r\nTC.Consts.event.POPUP = TC.Consts.event.POPUP || 'popup.tc';\r\nTC.Consts.event.POPUPHIDE = TC.Consts.event.POPUPHIDE || 'popuphide.tc';\r\nTC.Consts.event.DRAWCHART = TC.Consts.event.DRAWCHART || 'drawchart.tc';\r\nTC.Consts.event.DRAWTABLE = TC.Consts.event.DRAWTABLE || 'drawtable.tc';\r\nTC.Consts.event.RESULTSPANELCLOSE = TC.Consts.event.RESULTSPANELCLOSE || 'resultspanelclose.tc';\r\n\r\nTC.control.FeatureInfoCommons = function () {\r\n    const self = this;\r\n    TC.control.Click.apply(self, arguments);\r\n\r\n    const cs = self._classSelector = '.' + self.CLASS;\r\n    self._selectors = {\r\n        LIST_ITEM: 'ul' + cs + '-features li'\r\n    };\r\n\r\n    self.resultsLayer = null;\r\n    self.filterLayer = null;\r\n    self._layersPromise = null;\r\n    self.filterFeature = null;\r\n    self.info = null;\r\n    self.popup = null;\r\n    self.resultsPanel = null;\r\n    self.lastFeatureCount = null;\r\n    self.exportsState = true;\r\n};\r\n\r\nTC.control.FeatureInfoCommons.displayMode = {\r\n    POPUP: 'popup',\r\n    RESULTS_PANEL: 'resultsPanel'\r\n};\r\n\r\n(function () {\r\n\r\n    var layerCount = function (ctl) {\r\n        return ctl.info.services ?\r\n            ctl.info.services.reduce(function (sCount, service) {\r\n                return sCount + service.layers.reduce(function (lCount, layer) {\r\n                    return lCount + 1;\r\n                }, 0);\r\n            }, 0) : 0;\r\n    };\r\n\r\n    TC.inherit(TC.control.FeatureInfoCommons, TC.control.Click);\r\n\r\n    var ctlProto = TC.control.FeatureInfoCommons.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-finfo';\r\n\r\n    ctlProto.TITLE_SEPARATOR = ' • ';\r\n\r\n    if (TC.isDebug) {\r\n        ctlProto.template = TC.apiLocation + \"TC/templates/FeatureInfo.html\";\r\n    }\r\n    else {\r\n        ctlProto.template = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.x(ctx.get([\"displayElevation\"], false), ctx, { \"block\": body_1 }, {}).w(\"<ul class=\\\"tc-ctl-finfo-services\\\">\").s(ctx.get([\"services\"], false), ctx, { \"else\": body_4, \"block\": body_6 }, {}).w(\"</ul>\").x(ctx.get([\"featureCount\"], false), ctx, { \"block\": body_30 }, {}); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-finfo-coords\\\"><span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-crs\\\">CRS: <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.get([\"crs\"], false), ctx, \"h\").w(\"</span></span> \").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_2, \"block\": body_3 }, {}).w(\" <span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-elev\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"ele\" }).w(\": <span class=\\\"tc-ctl-finfo-coords-val\\\"></span></span></div>\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.w(\"<span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x\\\">x: <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.getPath(false, [\"coords\", \"0\"]), ctx, \"h\").w(\"</span></span> <span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x\\\">y: <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.getPath(false, [\"coords\", \"1\"]), ctx, \"h\").w(\"</span></span> \"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.w(\"<span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lat\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"lat\" }).w(\": <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.getPath(false, [\"coords\", \"1\"]), ctx, \"h\").w(\"</span></span> <span class=\\\"tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lon\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"lon\" }).w(\": <span class=\\\"tc-ctl-finfo-coords-val\\\">\").f(ctx.getPath(false, [\"coords\", \"0\"]), ctx, \"h\").w(\"</span></span> \"); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.nx(ctx.get([\"displayElevation\"], false), ctx, { \"block\": body_5 }, {}); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-finfo-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noData\" }).w(\"</li>\"); } body_5.__dustBody = !0; function body_6(chk, ctx) { return chk.w(\"<li><h3>\").x(ctx.get([\"title\"], false), ctx, { \"else\": body_7, \"block\": body_10 }, {}).w(\"</h3><div class=\\\"tc-ctl-finfo-service-content\\\">\").s(ctx.get([\"hasLimits\"], false), ctx, { \"else\": body_11, \"block\": body_29 }, {}).w(\"</div></li>\"); } body_6.__dustBody = !0; function body_7(chk, ctx) { return chk.x(ctx.getPath(false, [\"layers\", \"0\", \"title\"]), ctx, { \"else\": body_8, \"block\": body_9 }, {}); } body_7.__dustBody = !0; function body_8(chk, ctx) { return chk.f(ctx.getPath(false, [\"layer\", \"name\"]), ctx, \"h\"); } body_8.__dustBody = !0; function body_9(chk, ctx) { return chk.f(ctx.getPath(false, [\"layers\", \"0\", \"title\"]), ctx, \"h\"); } body_9.__dustBody = !0; function body_10(chk, ctx) { return chk.f(ctx.get([\"title\"], false), ctx, \"h\"); } body_10.__dustBody = !0; function body_11(chk, ctx) { return chk.w(\"<ul class=\\\"tc-ctl-finfo-layers\\\">\").s(ctx.get([\"layers\"], false), ctx, { \"else\": body_12, \"block\": body_13 }, {}).w(\"</ul>\"); } body_11.__dustBody = !0; function body_12(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-finfo-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noDataAtThisService\" }).w(\"</li>\"); } body_12.__dustBody = !0; function body_13(chk, ctx) { return chk.w(\"<li><h4><span class=\\\"tc-ctl-finfo-layer-n\\\">\").f(ctx.getPath(false, [\"features\", \"length\"]), ctx, \"h\").w(\"</span> \").s(ctx.get([\"path\"], false), ctx, { \"block\": body_14 }, {}).w(\"</h4> <div class=\\\"tc-ctl-finfo-layer-content\\\"><ul class=\\\"tc-ctl-finfo-features\\\">\").s(ctx.get([\"features\"], false), ctx, { \"else\": body_16, \"block\": body_17 }, {}).w(\"</ul></div></li>\"); } body_13.__dustBody = !0; function body_14(chk, ctx) { return chk.f(ctx.getPath(true, []), ctx, \"h\").h(\"sep\", ctx, { \"block\": body_15 }, {}); } body_14.__dustBody = !0; function body_15(chk, ctx) { return chk.w(\" &bull; \"); } body_15.__dustBody = !0; function body_16(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-finfo-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noDataInThisLayer\" }).w(\"</li>\"); } body_16.__dustBody = !0; function body_17(chk, ctx) { return chk.w(\"<li>\").x(ctx.get([\"rawContent\"], false), ctx, { \"else\": body_18, \"block\": body_23 }, {}).w(\"</li>\"); } body_17.__dustBody = !0; function body_18(chk, ctx) { return chk.x(ctx.get([\"error\"], false), ctx, { \"else\": body_19, \"block\": body_22 }, {}); } body_18.__dustBody = !0; function body_19(chk, ctx) { return chk.w(\"<h5>\").f(ctx.get([\"id\"], false), ctx, \"h\").w(\"</h5><table\").x(ctx.get([\"geometry\"], false), ctx, { \"block\": body_20 }, {}).w(\"><tbody>\").s(ctx.get([\"attributes\"], false), ctx, { \"block\": body_21 }, {}).w(\"</tbody></table>\"); } body_19.__dustBody = !0; function body_20(chk, ctx) { return chk.w(\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"clickToShowOnMap\" }).w(\"\\\"\"); } body_20.__dustBody = !0; function body_21(chk, ctx) { return chk.w(\"<tr><th class=\\\"tc-ctl-finfo-attr\\\">\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"</th><td class=\\\"tc-ctl-finfo-val\\\">\").f(ctx.get([\"value\"], false), ctx, \"h\").w(\"</td></tr>\"); } body_21.__dustBody = !0; function body_22(chk, ctx) { return chk.w(\"<span class=\\\"tc-ctl-finfo-errors\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"fi.error\" }).w(\"<span class=\\\"tc-ctl-finfo-error-text\\\">\").f(ctx.get([\"error\"], false), ctx, \"h\").w(\"</span></span>\"); } body_22.__dustBody = !0; function body_23(chk, ctx) { return chk.w(\"<h5>\").h(\"i18n\", ctx, {}, { \"$key\": \"feature\" }).w(\"</h5>\").h(\"eq\", ctx, { \"else\": body_24, \"block\": body_25 }, { \"key\": ctx.get([\"rawFormat\"], false), \"value\": \"text/html\" }); } body_23.__dustBody = !0; function body_24(chk, ctx) { return chk.w(\"<pre>\").f(ctx.get([\"rawContent\"], false), ctx, \"h\").w(\"</pre>\"); } body_24.__dustBody = !0; function body_25(chk, ctx) { return chk.w(\" \").x(ctx.get([\"expandUrl\"], false), ctx, { \"block\": body_26 }, {}); } body_25.__dustBody = !0; function body_26(chk, ctx) { return chk.h(\"ne\", ctx, { \"else\": body_27, \"block\": body_28 }, { \"key\": ctx.get([\"expandUrl\"], false), \"value\": \"\" }); } body_26.__dustBody = !0; function body_27(chk, ctx) { return chk.w(\"<iframe src=\\\"\").f(ctx.get([\"rawUrl\"], false), ctx, \"h\").w(\"\\\"></iframe>\"); } body_27.__dustBody = !0; function body_28(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-finfo-features-iframe-cnt\\\"><iframe src=\\\"\").f(ctx.get([\"rawUrl\"], false), ctx, \"h\").w(\"\\\"></iframe><a class=\\\"tc-ctl-finfo-open\\\" onclick=\\\"window.open('\").f(ctx.get([\"expandUrl\"], false), ctx, \"h\").w(\"', '_blank')\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"expand\" }).w(\"\\\"></a></div>\"); } body_28.__dustBody = !0; function body_29(chk, ctx) { return chk.w(\"<span class=\\\"tc-ctl-finfo-errors\\\">\").f(ctx.get([\"hasLimits\"], false), ctx, \"h\").w(\"</span>\"); } body_29.__dustBody = !0; function body_30(chk, ctx) { return chk.h(\"gt\", ctx, { \"block\": body_31 }, { \"key\": ctx.get([\"featureCount\"], false), \"value\": \"1\", \"type\": \"number\" }); } body_30.__dustBody = !0; function body_31(chk, ctx) { return chk.w(\"<a class=\\\"tc-ctl-btn tc-ctl-finfo-btn-prev\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"previous\" }).w(\"</a><div class=\\\"tc-ctl-finfo-counter\\\"><span class=\\\"tc-ctl-finfo-counter-current\\\"></span>/\").f(ctx.get([\"featureCount\"], false), ctx, \"h\").w(\"</div><a class=\\\"tc-ctl-btn tc-ctl-finfo-btn-next\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"next\" }).w(\"</a>\"); } body_31.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        const result = TC.control.Click.prototype.register.call(self, map);\r\n\r\n        self._createLayers();\r\n\r\n        map.loaded(function () {\r\n            const shareCtl = map.getControlsByClass('TC.control.Share')[0];\r\n            if (shareCtl) {\r\n                self.loadSharedFeature(shareCtl.loadParamFeature());\r\n            }\r\n        });\r\n\r\n        self.displayMode = self.options.displayMode || TC.control.FeatureInfoCommons.displayMode.POPUP;\r\n        self.setDisplayMode(self.displayMode);\r\n\r\n        map\r\n            .on(TC.Consts.event.POPUPHIDE + ' ' + TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                if (e.control === self.getDisplayControl() && self.resultsLayer) {\r\n                    if (self.highlightedFeature) {\r\n                        self.resultsLayer.removeFeature(self.highlightedFeature);\r\n                        self.highlightedFeature = null;\r\n                    }\r\n                    if (!self.querying && e.feature) {\r\n                        self.filterLayer.removeFeature(e.feature);\r\n                    }\r\n                }\r\n            })\r\n            .on(TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                self.highlightedFeature = null;\r\n            })\r\n            .on(TC.Consts.event.POPUP + ' ' + TC.Consts.event.DRAWTABLE + ' ' + TC.Consts.event.DRAWCHART, function (e) {\r\n                const control = e.control;\r\n                if (control.currentFeature !== self.filterFeature) {\r\n                    self.highlightedFeature = control.currentFeature;\r\n                }\r\n\r\n                // GLS: si la feature es resultado de GFI decoramos\r\n                if (e.control.currentFeature &&\r\n                    e.control.currentFeature.layer &&\r\n                    self.filterLayer &&\r\n                    self.resultsLayer &&\r\n                    [self.filterLayer.id, self.resultsLayer.id].indexOf(e.control.currentFeature.layer.id) > -1) {\r\n                    self._decorateDisplay(control);\r\n                }\r\n            })\r\n            .on(TC.Consts.event.DRAWCHART, function (e) {\r\n                setTimeout(function () {\r\n                    self.highlightedFeature = e.control.currentFeature;\r\n                }, 50);\r\n            })\r\n            .on(TC.Consts.event.LAYERREMOVE, function () {\r\n                if (self.info && self.info.services) {\r\n                    const services = {};\r\n                    self.map.workLayers\r\n                        .filter(function (layer) {\r\n                            return layer.type === TC.Consts.layerType.WMS;\r\n                        })\r\n                        .forEach(function (layer) {\r\n                            const names = services[layer.url] || [];\r\n                            services[layer.url] = names.concat(layer.getDisgregatedLayerNames())\r\n                        });\r\n                    for (var i = 0, len = self.info.services.length; i < len; i++) {\r\n                        const service = self.info.services[i];\r\n                        const mapNames = services[service.mapLayers[0].url] || [];\r\n                        const infoNames = service.layers.reduce(function (arr, layer) {\r\n                            return arr.concat(layer.name);\r\n                        }, []);\r\n                        if (!infoNames.every(function (name) {\r\n                            return mapNames.indexOf(name) >= 0;\r\n                        })) {\r\n                            // En el objeto info hay capas que no están ya en el mapa: borramos resultados.\r\n                            self.downplayFeatures();\r\n                            self.info = null;\r\n                            self.closeResults();\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            })\r\n            .on(TC.Consts.event.VIEWCHANGE, function (e) {                \r\n                self.closeResults();\r\n            });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.render = function () {\r\n        const self = this;\r\n        // Este div se usa como buffer, así que no debe ser visible.\r\n        self.div.classList.add(TC.Consts.classes.HIDDEN);\r\n        return self._set1stRenderPromise(Promise.resolve());\r\n    };\r\n\r\n    ctlProto.responseCallback = function (options) {\r\n        const self = this;\r\n        self.querying = false;\r\n\r\n        if (self.filterFeature) {\r\n            self.info = { services: options.services };\r\n        }\r\n\r\n        if (!options.featureCount) {\r\n            self.lastFeatureCount = 0;\r\n            self.map.trigger(TC.Consts.event.NOFEATUREINFO, { control: self });\r\n            self.closeResults();\r\n        }\r\n        else {\r\n            self._addSourceAttributes();\r\n            self.lastFeatureCount = options.featureCount;\r\n            self.map.trigger(TC.Consts.event.FEATUREINFO, TC.Util.extend({ control: self }, options));\r\n        }\r\n    };\r\n\r\n    ctlProto.responseError = function (options) {\r\n        const self = this;\r\n        if (options.status === 404) {\r\n            self.map.toast(self.getLocaleString(\"featureInfo.tooManyLayers\"), { type: TC.Consts.msgType.ERROR });\r\n        }\r\n        self.responseCallback({});\r\n    };\r\n\r\n    ctlProto.markerStyle = {\r\n        cssClass: TC.Consts.classes.POINT,\r\n        anchor: [0.5, 0.5],\r\n        width: 15,\r\n        height: 15,\r\n        noPrint: true\r\n    };\r\n\r\n    ctlProto.setDisplayMode = function (mode) {\r\n        var self = this;\r\n        self.displayMode = mode;\r\n        var map = self.map;\r\n        switch (mode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                if (!self.resultsPanel) {\r\n                    var rp = map.getControlsByClass('TC.control.ResultsPanel').filter(function (ctrl) { return ctrl.options.content === \"table\" })[0];\r\n                    if (rp) {\r\n                        self.resultsPanel = rp;\r\n                        rp.caller = self;\r\n                    }\r\n                    else {\r\n                        var setResultsPanel = function setResultsPanel(e) {\r\n                            const control = e.control;\r\n                            if (TC.control.ResultsPanel && control instanceof TC.control.ResultsPanel) {\r\n                                self.resultsPanel = control;\r\n                                control.caller = self;\r\n                                map.off(TC.Consts.event.CONTROLADD, setResultsPanel);\r\n                            }\r\n                        };\r\n                        map.on(TC.Consts.event.CONTROLADD, setResultsPanel);\r\n                    }\r\n                }\r\n                break;\r\n            default:\r\n                self.displayMode = TC.control.FeatureInfoCommons.displayMode.POPUP;\r\n                if (!self.popup) {\r\n                    map.addControl('popup', {\r\n                        closeButton: true,\r\n                        draggable: self.options.draggable\r\n                    }).then(function (popup) {\r\n                        self.popup = popup;\r\n                        popup.caller = self;\r\n                        map.on(TC.Consts.event.POPUP, function (e) {\r\n                            self.onShowPopup(e);\r\n                        });\r\n\r\n                        map.on(TC.Consts.event.POPUPHIDE, function (e) {\r\n                            if (e.control === popup) {\r\n                                //restaurar el ancho automático\r\n                                self._resetSize();\r\n                            }\r\n                        });\r\n                    });\r\n                }\r\n                break;\r\n        }\r\n    };\r\n\r\n    ctlProto.getDisplayControl = function () {\r\n        var self = this;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                return self.resultsPanel;\r\n            default:\r\n                return self.popup;\r\n        }\r\n    };\r\n\r\n    ctlProto.getDisplayTarget = function (options) {\r\n        var self = this;\r\n        options = options || {};\r\n        if (options.control) {\r\n            switch (true) {\r\n                case TC.control.Popup && options.control instanceof TC.control.Popup:\r\n                    return options.control.getContainerElement();\r\n                case TC.control.ResultsPanel && options.control instanceof TC.control.ResultsPanel:\r\n                    return options.control.getTableContainer();\r\n                default:\r\n                    return null;\r\n            }\r\n        }\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                return self.resultsPanel.getTableContainer();\r\n            default:\r\n                return self.popup.getContainerElement();\r\n        }\r\n    };\r\n\r\n    ctlProto.getMenuTarget = function () {\r\n        var self = this;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                return self.resultsPanel.getMenuElement();\r\n            default:\r\n                return self.popup.getMenuElement();\r\n        }\r\n    };\r\n\r\n    ctlProto.displayResults = function () {\r\n        var self = this;\r\n        const clone = self.div.cloneNode(true);\r\n        clone.classList.remove(TC.Consts.classes.HIDDEN);\r\n        self.filterFeature.data = clone.outerHTML;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                if (self.resultsPanel) {\r\n\r\n                    // GLS: si contamos con el control de controles no es necesario cerrar los paneles visibles ya que no habría solape\r\n                    if (self.map.getControlsByClass(TC.control.ControlContainer).length === 0) {\r\n                        self.map.getControlsByClass(TC.control.ResultsPanel).forEach(function (p) {\r\n                            if (p.isVisible()) {\r\n                                p.close();\r\n                            }\r\n                        });\r\n                    } else {\r\n                        // cerramos los paneles con feature asociada\r\n                        const panels = self.map.getControlsByClass('TC.control.ResultsPanel');\r\n                        panels.forEach(function (p) {\r\n                            if (p !== self.resultsPanel && p.currentFeature) {\r\n                                p.close();\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    self.resultsPanel.currentFeature = self.filterFeature;\r\n                    self.resultsPanel.open(self.filterFeature.data, self.resultsPanel.getInfoContainer());\r\n                    \r\n\r\n                    self.displayResultsCallback();\r\n                }\r\n\r\n                break;\r\n            default:\r\n                if (self.popup) {\r\n                    self.filterFeature.showPopup(self.popup);\r\n                }\r\n                break;\r\n        }\r\n    };\r\n\r\n    const getElementIndex = function (elm) {\r\n        return Array.from(elm.parentElement.childNodes).indexOf(elm);\r\n    };\r\n\r\n    const getParentElement = function (elm, tagName) {\r\n        var result = elm;\r\n        do {\r\n            result = result.parentElement;\r\n        }\r\n        while (result && result.tagName !== tagName);\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getFeatureElement = function (feature) {\r\n        const self = this;\r\n        var result;\r\n        const getIndex = function (elm) {\r\n            return Array.from(elm.parentElement.childNodes).getIndex(elm);\r\n        };\r\n        self.getDisplayTarget().querySelectorAll(self._selectors.LIST_ITEM).forEach(function (li) {\r\n            const currentFeatureLi = li;\r\n            const currentLayerLi = getParentElement(li, 'LI');\r\n            const currentServiceLi = getParentElement(currentLayerLi, 'LI');\r\n            var feat = self.getFeature(getElementIndex(currentServiceLi), getElementIndex(currentLayerLi), getElementIndex(currentFeatureLi));\r\n            if (feat === feature) {\r\n                result = currentFeatureLi;\r\n            }\r\n        });\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getNextFeatureElement = function (delta) {\r\n        const self = this;\r\n        const lis = self.getDisplayTarget().querySelectorAll('ul.' + self.CLASS + '-features > li');\r\n        const length = lis.length;\r\n        for (var i = 0; i < length; i++) {\r\n            if (lis[i].matches('.' + TC.Consts.classes.CHECKED)) {\r\n                return lis[(i + delta + length) % length]\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.getFeaturePath = function (feature) {\r\n        const self = this;\r\n        if (self.info && self.info.services) {\r\n            for (var i = 0, ii = self.info.services.length; i < ii; i++) {\r\n                const service = self.info.services[i];\r\n                for (var j = 0, jj = service.layers.length; j < jj; j++) {\r\n                    const layer = service.layers[j];\r\n                    for (var k = 0, kk = layer.features.length; k < kk; k++) {\r\n                        if (layer.features[k] === feature) {\r\n                            return {\r\n                                service: service.title || service.mapLayers.reduce(function (prev, cur) {\r\n                                    return prev || cur.title;\r\n                                }, ''),\r\n                                layer: layer.path\r\n                            };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.closeResults = function () {\r\n        var self = this;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                if (self.resultsPanel && self.resultsPanel.isVisible()) {\r\n                    self.resultsPanel.close();\r\n                }\r\n                break;\r\n            default:\r\n                if (self.popup && self.popup.isVisible()) {\r\n                    self.popup.hide();\r\n                }\r\n                break;\r\n        }\r\n    };\r\n\r\n    ctlProto.displayResultsCallback = function () {\r\n        var self = this;\r\n        const content = self.getDisplayTarget().querySelector('.' + self.CLASS);\r\n\r\n        var selector;\r\n        // Evento para resaltar una feature\r\n        var eventType = 'click'; // En iPad se usa click en vez de touchstart para evitar que se resalte una feature al hacer scroll\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(self._selectors.LIST_ITEM, function (e) {\r\n            self.highlightFeature(e.target);\r\n        }));\r\n\r\n        // Evento para ir a la siguiente feature\r\n        eventType = TC.Consts.event.CLICK;\r\n        selector = '.' + self.CLASS + '-btn-next';\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            self.highlightFeature(self.getNextFeatureElement(1), 1);\r\n            return false;\r\n        }));\r\n\r\n        // Evento para ir a la feature anterior\r\n        selector = '.' + self.CLASS + '-btn-prev';\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            self.highlightFeature(self.getNextFeatureElement(-1), -1);\r\n            return false;\r\n        }));\r\n\r\n        // Evento para desplegar/replegar features de capa\r\n        selector = 'ul.' + self.CLASS + '-layers h4';\r\n\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            const li = getParentElement(e.target, 'LI');\r\n            if (li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                // Si no está en modo móvil ocultamos la capa (si hay más de una)\r\n                const anotherLayer = content.querySelector('.tc-ctl-finfo-layers li:not(.tc-checked)');\r\n                if (anotherLayer && getComputedStyle(anotherLayer).display !== 'none') {\r\n                    self.downplayFeatures();\r\n                }\r\n            }\r\n            else {\r\n                self.highlightFeature(li.querySelector(self._selectors.LIST_ITEM));\r\n                if (self.displayMode === TC.control.FeatureInfoCommons.displayMode.POPUP) {\r\n                    self.popup.fitToView(true);\r\n                }\r\n            }\r\n        }));\r\n\r\n        // Evento para borrar la feature resaltada\r\n        selector = '.' + self.CLASS + '-del-btn';\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            self.downplayFeatures();\r\n            self.closeResults();\r\n        }));\r\n\r\n        if (self.info) {\r\n            if (self.info.defaultFeature && self.getFeatureElement(self.info.defaultFeature)) {\r\n                self.getFeatureElement(self.info.defaultFeature).classList.add(TC.Consts.classes.DEFAULT);\r\n                self.highlightFeature(self.info.defaultFeature);\r\n            }\r\n            else if (content.querySelector(self._selectors.LIST_ITEM)) {\r\n                self.highlightFeature(content.querySelector(self._selectors.LIST_ITEM));\r\n            }\r\n        }\r\n\r\n        content.querySelectorAll('table').forEach(function (table) {\r\n            table.addEventListener(TC.Consts.event.CLICK, function (e) {                \r\n                const li = this.parentElement;\r\n                if (li.classList.contains(TC.Consts.classes.DISABLED)) {\r\n                    return;\r\n                }\r\n                if (li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                    // Si ya está seleccionada hacemos zoom\r\n                    if (self.resultsLayer.features[0] && window.getSelection() && window.getSelection().toString().trim().length === 0) {\r\n                        // Proceso para desactivar highlightFeature mientras hacemos zoom\r\n                        var zoomHandler = function zoomHandler() {\r\n                            self._zooming = false;\r\n                            self.map.off(TC.Consts.event.ZOOM, zoomHandler);\r\n                        };\r\n                        self.map.on(TC.Consts.event.ZOOM, zoomHandler);\r\n                        self._zooming = true;\r\n                        ///////\r\n                        \r\n                        self.map.zoomToFeatures([self.resultsLayer.features[0]], { animate: true });\r\n                    }\r\n                }\r\n                else {\r\n                    // Si no está seleccionada la seleccionamos\r\n                    self.highlightFeature(li);\r\n                }\r\n                e.stopPropagation();\r\n            });\r\n        });\r\n        content.querySelectorAll('table a').forEach(function (a) {\r\n            a.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                e.stopPropagation();\r\n            });\r\n        });\r\n\r\n        if (TC.browserFeatures.touch() && self.displayMode === TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL) {\r\n            if (content.querySelector('.' + self.CLASS + '-btn-prev').style.display !== 'none') { // Si los botones de anterior/siguiente están visibles, montamos el swipe\r\n                if (self.resultsPanel) {\r\n                    TC.Util.swipe(self.resultsPanel.div, 'disable');\r\n                }\r\n\r\n                if (layerCount(self) > 1) {\r\n                    TC.Util.swipe(content, {\r\n                        left: function () {\r\n                            self.highlightFeature(self.getNextFeatureElement(1), 1);\r\n                        },\r\n                        right: function () {\r\n                            self.highlightFeature(self.getNextFeatureElement(-1), -1);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.onShowPopup = function (e) {\r\n        const self = this;\r\n        if (e.control === self.popup) {\r\n\r\n            self.displayResultsCallback();\r\n\r\n            //ajustar el ancho para que no sobre a la derecha\r\n            self._fitSize();\r\n        }\r\n    };\r\n\r\n    ctlProto.loadSharedFeature = function (featureObj) {\r\n\r\n    };\r\n\r\n    ctlProto.insertLinks = function () {\r\n        var self = this;\r\n        const linkText = self.getLocaleString('open');\r\n        const titleText = self.getLocaleString('linkInNewWindow');\r\n        self.div.querySelectorAll('td.' + self.CLASS + '-val').forEach(function (td) {\r\n            const text = td.textContent;\r\n            if (TC.Util.isURL(text)) {\r\n                td.innerHTML = '<a href=\"' + text + '\" target=\"_blank\" title=\"' + titleText + '\">' + linkText + '</a>';\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.highlightFeature = function (featureOrElement, delta) {\r\n        const self = this;\r\n        var feature;\r\n        if (!self._zooming) {\r\n            var featureLi;\r\n            // this puede ser o el elemento HTML de la lista correspondiente a la feature o la feature en sí\r\n            if (featureOrElement instanceof TC.Feature) {\r\n                feature = featureOrElement;\r\n                featureLi = self.getFeatureElement(feature);\r\n            }\r\n            else {\r\n                featureLi = featureOrElement;\r\n                while (featureLi && featureLi.tagName !== 'LI') {\r\n                    featureLi = featureLi.parentElement;\r\n                }\r\n            }\r\n            const layerLi = getParentElement(featureLi, 'LI');\r\n            const serviceLi = getParentElement(layerLi, 'LI');\r\n\r\n            const serviceIdx = getElementIndex(serviceLi);\r\n            const layerIdx = getElementIndex(layerLi);\r\n            const featureIdx = getElementIndex(featureLi);\r\n            feature = feature || self.getFeature(serviceIdx, layerIdx, featureIdx);\r\n\r\n            self.downplayFeatures({ exception: feature });\r\n            featureLi.classList.add(TC.Consts.classes.CHECKED);\r\n            layerLi.classList.add(TC.Consts.classes.CHECKED);\r\n            serviceLi.classList.add(TC.Consts.classes.CHECKED);\r\n            if (delta > 0) {\r\n                featureLi.classList.add(TC.Consts.classes.FROMLEFT);\r\n                layerLi.classList.add(TC.Consts.classes.FROMLEFT);\r\n                serviceLi.classList.add(TC.Consts.classes.FROMLEFT);\r\n            }\r\n            else if (delta < 0) {\r\n                featureLi.classList.add(TC.Consts.classes.FROMRIGHT);\r\n                layerLi.classList.add(TC.Consts.classes.FROMRIGHT);\r\n                serviceLi.classList.add(TC.Consts.classes.FROMRIGHT);\r\n            }\r\n\r\n            if (featureLi.querySelector('table')) {\r\n                featureLi.querySelector('table').setAttribute('title', self.getLocaleString('clickToCenter'));\r\n            }\r\n\r\n            self.highlightedFeature = feature;\r\n\r\n            if (self.getDisplayTarget().querySelector('.' + self.CLASS + '-counter-current')) {\r\n                self.getDisplayTarget().querySelector('.' + self.CLASS + '-counter-current').innerHTML = self.getFeatureIndex(serviceIdx, layerIdx, featureIdx) + 1;\r\n            }\r\n\r\n\r\n            var features = self.resultsLayer.features.slice();\r\n            var featureAlreadyHighlighted = features.filter(function (item) {\r\n                return feature && feature.id === item.id;\r\n            });\r\n\r\n            //Si la feature a resaltar ya está resaltada, no hacemos nada. Así evitamos parpadeo\r\n            if (featureAlreadyHighlighted.length > 0) {\r\n                return;\r\n            }\r\n\r\n            for (var i = 0; i < features.length; i++) {\r\n                var f = features[i];\r\n                if (f !== self.filterFeature) {\r\n                    self.resultsLayer.removeFeature(f);\r\n                }\r\n            }\r\n            if (feature && feature.geometry) {\r\n                self.resultsLayer.addFeature(feature);\r\n            }\r\n            else {\r\n                featureLi.classList.add(TC.Consts.classes.DISABLED);\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.downplayFeatures = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        if (self.highlightedFeature !== options.exception) {\r\n            self.highlightedFeature = null;\r\n        }\r\n        const exceptionFLi = options.exception ? self.getFeatureElement(options.exception) : undefined;\r\n        var exceptionLLi, exceptionSLi;\r\n        if (exceptionFLi) {\r\n            exceptionLLi = getParentElement(exceptionFLi, 'LI');\r\n            exceptionSLi = getParentElement(exceptionLLi, 'LI');\r\n        }\r\n\r\n        self.resultsLayer.clearFeatures();\r\n        const target = self.getDisplayTarget();\r\n        Array.from(target.querySelectorAll('ul.' + self.CLASS + '-services li'))\r\n            .filter(function (li) {\r\n                return li !== exceptionFLi && li !== exceptionLLi && li !== exceptionSLi;\r\n            })\r\n            .forEach(function (li) {\r\n                li.classList.remove(\r\n                    TC.Consts.classes.CHECKED,\r\n                    TC.Consts.classes.DISABLED,\r\n                    TC.Consts.classes.FROMLEFT,\r\n                    TC.Consts.classes.FROMRIGHT);\r\n            });\r\n        target.querySelectorAll('.' + self.CLASS + '-features table').forEach(function (table) {\r\n            table.setAttribute('title', self.getLocaleString('clickToShowOnMap'));\r\n        });\r\n    };\r\n\r\n    ctlProto._fitSize = function () {\r\n        const self = this;\r\n        const target = self.getDisplayTarget();\r\n        var max = 0;\r\n        //medir la máxima anchura de <ul>\r\n        target.querySelectorAll(\".tc-ctl-finfo-features li\").forEach(function (elm) {\r\n            max = Math.max(max, elm.offsetLeft + elm.offsetWidth);\r\n        });\r\n\r\n        //alert(\"max=\" + max);\r\n        if (max) {\r\n            target.style.width = max + 50 + 'px';\r\n        }\r\n    };\r\n\r\n    ctlProto._resetSize = function () {\r\n        const self = this;\r\n        self.getDisplayTarget().style.removeProperty('width');\r\n    };\r\n\r\n    ctlProto.getFeature = function (serviceIdx, layerIdx, featureIdx) {\r\n        const self = this;\r\n        var result;\r\n        const info = self.info;\r\n        if (info && info.services) {\r\n            result = info.services[serviceIdx];\r\n            if (result) {\r\n                result = result.layers[layerIdx];\r\n                if (result) {\r\n                    result = result.features[featureIdx];\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getFeatureIndex = function (serviceIdx, layerIdx, featureIdx) {\r\n        const self = this;\r\n        var result = -1;\r\n        const info = self.info;\r\n        if (info) {\r\n            for (var i = 0; i <= serviceIdx; i++) {\r\n                var service = info.services[i];\r\n                var maxj = i === serviceIdx ? layerIdx : service.layers.length - 1;\r\n                for (var j = 0; j <= maxj; j++) {\r\n                    var layer = service.layers[j];\r\n                    var maxk = j === layerIdx ? featureIdx : layer.features.length - 1;\r\n                    for (var k = 0; k <= maxk; k++) {\r\n                        result = result + 1;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.beforeRequest = function (options) {\r\n        var self = this;\r\n        self.querying = true;\r\n        self.map.trigger(TC.Consts.event.BEFOREFEATUREINFO, {\r\n            xy: options.xy,\r\n            control: self\r\n        });\r\n        self.closeResults();\r\n        if (self.map && self.resultsLayer) {\r\n            self.lastFeatureCount = null;\r\n\r\n            self.resultsLayer.features.forEach(function (feature) {\r\n                self.resultsLayer.removeFeature(feature);\r\n            });\r\n            self.info = null;\r\n        }\r\n    };\r\n\r\n    ctlProto.activate = function () {\r\n        var self = this;\r\n        if (self.wrap) {\r\n            self.wrap.activate();\r\n        }\r\n        TC.Control.prototype.activate.call(self);\r\n    };\r\n\r\n    ctlProto.deactivate = function (stopChain) {\r\n        var self = this;\r\n        if (self.popup) {\r\n            self.popup.hide();\r\n        }\r\n        self.resultsLayer.clearFeatures();\r\n        self.filterLayer.clearFeatures();\r\n        self.filterFeature = null;\r\n        if (self.wrap) {\r\n            self.wrap.deactivate();\r\n        }\r\n        TC.Control.prototype.deactivate.call(self, stopChain);\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState && self.resultsLayer) {\r\n            return {\r\n                id: self.id,\r\n                layer: self.resultsLayer.exportState()\r\n            };\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        self._layersPromise.then(function () {\r\n            self.resultsLayer.importState(state.layer);\r\n        });\r\n    };\r\n\r\n    ctlProto._createLayers = function () {\r\n        const self = this;\r\n\r\n        var resultsLayer;\r\n        if (self.options.resultsLayer) { // En caso de que se haya indicado una capa por configuración, la utilizamos\r\n            resultsLayer = self.options.resultsLayer;\r\n        } else {\r\n            resultsLayer = {\r\n                id: self.getUID(),\r\n                title: self.CLASS + ': Results layer',\r\n                type: TC.Consts.layerType.VECTOR,\r\n                stealth: true\r\n            };\r\n        }\r\n        var filterLayer;\r\n        if (self.options.filterLayer) {\r\n            filterLayer = self.options.filterLayer;\r\n        }\r\n        else {\r\n            filterLayer = {\r\n                id: self.getUID(),\r\n                title: self.CLASS + ': Filter layer',\r\n                stealth: true,\r\n                type: TC.Consts.layerType.VECTOR\r\n                , styles: {\r\n                    line: { strokeColor: self.lineColor, strokeWidth: 2 },\r\n                    polygon: { strokeColor: self.lineColor, strokeWidth: 2, fillColor: \"#000\", fillOpacity: 0.3 }\r\n                }\r\n            };\r\n        }\r\n\r\n        const map = self.map;\r\n        self._layersPromise = new Promise(function (resolve, reject) {\r\n            map.loaded(function () {\r\n                Promise.all([map.addLayer(resultsLayer), map.addLayer(filterLayer)]).then(function (layers) {\r\n                    self.resultsLayer = layers[0];\r\n                    self.filterLayer = layers[1];\r\n                    resolve();\r\n                });\r\n            });\r\n        });\r\n\r\n        return self._layersPromise;\r\n    };\r\n\r\n    ctlProto._decorateDisplay = function (ctl) {\r\n        const self = this;        \r\n\r\n        const resultsContainer = self.getDisplayTarget({ control: ctl });\r\n\r\n        // Añadimos botón de imprimir\r\n        TC.loadJS(\r\n            !TC.control.Print,\r\n            [TC.apiLocation + 'TC/control/Print'],\r\n            function () {\r\n                if (!resultsContainer.querySelectorAll('.' + TC.control.Print.prototype.CLASS + '-btn').length) {\r\n                    var printTitle = self.getLocaleString(\"feature\");\r\n                    if (ctl === self.getDisplayControl()) {\r\n                        if (TC.feature.Point && self.filterFeature instanceof TC.feature.Point) {\r\n                            const geom = self.filterFeature.geometry;\r\n                            printTitle = self.getLocaleString('featuresAt', {\r\n                                crs: self.map.crs,\r\n                                x: TC.Util.formatNumber(geom[0], self.map.locale),\r\n                                y: TC.Util.formatNumber(geom[1], self.map.locale)\r\n                            });\r\n                        }\r\n                        else {\r\n                            printTitle = self.getLocaleString('spatialQueryResults');\r\n                        }\r\n                    }\r\n                    else if (ctl.currentFeature) {\r\n                        printTitle = ctl.currentFeature.id;\r\n                    }\r\n                    // Si hay datos porque el popup es de un GFI con éxito o es de una feature resaltada damos la opción de imprimirlos\r\n                    if (self.lastFeatureCount || (ctl.currentFeature && ctl.currentFeature.showsPopup === true)) {\r\n                        new TC.control.Print({\r\n                            target: resultsContainer,\r\n                            title: printTitle\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        );\r\n    };\r\n\r\n    ctlProto._addSourceAttributes = function () {\r\n        const self = this;\r\n        const serviceAttrName = 'h3_' + self.getLocaleString('service');\r\n        const layerAttrName = 'h4_' + self.getLocaleString('layer');\r\n        // Añadimos como atributos los títulos de servicio y capa\r\n        if (self.info && self.info.services) {\r\n            self.info.services.forEach(function (service) {\r\n                service.layers.forEach(function (layer) {\r\n                    layer.features.forEach(function (feature) {\r\n                        if (feature instanceof TC.Feature) {\r\n                            const path = self.getFeaturePath(feature);\r\n                            if (path) {\r\n                                const newData = {};\r\n                                newData[serviceAttrName] = path.service;\r\n                                if (path.layer) {\r\n                                    newData[layerAttrName] = path.layer.join(self.TITLE_SEPARATOR);\r\n                                }\r\n                                const allData = TC.Util.extend(newData, feature.getData());\r\n                                feature.clearData();\r\n                                feature.setData(allData);\r\n                            }\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n})();\r\n"]}