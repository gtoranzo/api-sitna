{"version":3,"sources":["control/FeatureInfoCommons.js"],"names":["TC","control","Click","syncLoadJS","apiLocation","Consts","event","POPUP","POPUPHIDE","DRAWCHART","DRAWTABLE","RESULTSPANELCLOSE","FeatureInfoCommons","apply","this","arguments","cs","_classSelector","CLASS","_selectors","LIST_ITEM","resultsLayer","filterLayer","_layersPromise","filterFeature","info","_infoHistory","popup","resultsPanel","lastFeatureCount","exportsState","displayMode","RESULTS_PANEL","inherit","ctlProto","prototype","TITLE_SEPARATOR","DEFAULT_STROKE_COLOR","template","dust","register","body_0","chk","ctx","w","f","get","x","else","body_1","block","body_2","body_3","s","body_4","body_7","body_31","__dustBody","getPath","h","$key","nx","body_5","body_6","body_8","body_11","body_12","body_30","body_9","body_10","body_13","body_14","body_15","body_17","body_18","body_16","body_19","body_24","body_20","body_23","body_21","body_22","p","rebase","body_25","body_26","key","value","body_27","body_28","body_29","body_32","type","array","object","on","map","self","result","call","_createLayers","loaded","shareCtl","getControlsByClass","loadSharedFeature","loadParamFeature","options","setDisplayMode","e","getDisplayControl","highlightedFeature","persistentHighlights","downplayFeature","querying","feature","removeFeature","currentFeature","caller","_decorateDisplay","setTimeout","LAYERREMOVE","Object","keys","length","services","workLayers","filter","layer","layerType","WMS","forEach","names","url","concat","getDisgregatedLayerNames","featuresDeleted","historyService","hasOwnProperty","service","name","historyLayer","indexOf","slice","closeResults","VIEWCHANGE","render","div","classList","add","classes","HIDDEN","_set1stRenderPromise","Promise","resolve","responseCallback","featureCount","_addSourceAttributes","trigger","FEATUREINFO","Util","extend","NOFEATUREINFO","responseError","status","toast","getLocaleString","msgType","ERROR","markerStyle","cssClass","POINT","anchor","width","height","noPrint","mode","addControl","then","rp","closeButton","draggable","onShowPopup","_resetSize","getDisplayTarget","Popup","getContainerElement","ResultsPanel","getInfoContainer","getMenuTarget","getMenuElement","displayResults","clone","cloneNode","remove","data","outerHTML","ControlContainer","isVisible","close","chart","open","loadJS","Print","printBtn","querySelectorAll","displayResultsCallback","showPopup","getElementIndex","elm","Array","from","parentElement","children","getParentElement","tagName","getFeatureElement","li","currentFeatureLi","currentLayerLi","currentServiceLi","getFeature","getNextFeatureElement","delta","lis","i","matches","CHECKED","getFeaturePath","ii","j","jj","layers","k","kk","features","title","mapLayers","reduce","prev","cur","path","hide","content","querySelector","selector","ctl","eventType","addEventListener","EventTarget","listenerBySelector","highlightFeature","target","CLICK","contains","anotherLayer","getComputedStyle","display","downplayFeatures","fitToView","defaultFeature","DEFAULT","table","DISABLED","window","getSelection","toString","trim","ZOOM","zoomHandler","_zooming","off","zoomToFeatures","animate","stopPropagation","a","browserFeatures","touch","prevBtn","style","swipe","sCount","lCount","left","right","_fitSize","featureObj","insertLinks","linkText","titleText","td","text","textContent","isURL","innerHTML","featureOrElement","featureLi","Feature","layerLi","serviceLi","serviceIdx","layerIdx","featureIdx","exception","FROMLEFT","FROMRIGHT","setAttribute","getFeatureIndex","featureAlreadyHighlighted","item","id","geometry","showsPopup","addFeature","idx","splice","exceptionFLi","undefined","exceptionLLi","exceptionSLi","max","checkbox","checked","Math","offsetLeft","offsetWidth","removeProperty","maxj","maxk","beforeRequest","BEFOREFEATUREINFO","xy","activate","wrap","Control","deactivate","stopChain","clearFeatures","exportState","importState","state","getUID","VECTOR","owner","stealth","styles","geometryType","geom","POLYLINE","line","POLYGON","polygon","reject","all","addLayer","resultsContainer","printTitle","Point","crs","formatCoord","isGeo","DEGREE_PRECISION","METER_PRECISION","y","printableElement","serviceAttrName","layerAttrName","newData","join","allData","getData","clearData","setData"],"mappings":"AAAAA,GAAGC,QAAUD,GAAGC,SAAW,GAEtBD,GAAGC,QAAQC,OACZF,GAAGG,WAAWH,GAAGI,YAAc,oBAGnCJ,GAAGK,OAAOC,MAAMC,MAAQP,GAAGK,OAAOC,MAAMC,OAAS,WACjDP,GAAGK,OAAOC,MAAME,UAAYR,GAAGK,OAAOC,MAAME,WAAa,eACzDR,GAAGK,OAAOC,MAAMG,UAAYT,GAAGK,OAAOC,MAAMG,WAAa,eACzDT,GAAGK,OAAOC,MAAMI,UAAYV,GAAGK,OAAOC,MAAMI,WAAa,eACzDV,GAAGK,OAAOC,MAAMK,kBAAoBX,GAAGK,OAAOC,MAAMK,mBAAqB,uBAEzEX,GAAGC,QAAQW,mBAAqB,WAE5BZ,GAAGC,QAAQC,MAAMW,MADJC,KACgBC,WAE7B,MAAMC,EAHOF,KAGGG,eAAiB,IAHpBH,KAG+BI,MAH/BJ,KAIRK,WAAa,CACdC,UAAW,KAAOJ,EAAK,gBALdF,KAQRO,aAAe,KARPP,KASRQ,YAAc,KATNR,KAURS,eAAiB,KAVTT,KAWRU,cAAgB,KAXRV,KAYRW,KAAO,KAZCX,KAaRY,aAAe,GAbPZ,KAcRa,MAAQ,KAdAb,KAeRc,aAAe,KAfPd,KAgBRe,iBAAmB,KAhBXf,KAiBRgB,cAAe,GAGxB9B,GAAGC,QAAQW,mBAAmBmB,YAAc,CACxCxB,MAAO,QACPyB,cAAe,iBAGnB,WAWIhC,GAAGiC,QAAQjC,GAAGC,QAAQW,mBAAoBZ,GAAGC,QAAQC,OAErD,IAAIgC,EAAWlC,GAAGC,QAAQW,mBAAmBuB,UAE7CD,EAAShB,MAAQ,eAEjBgB,EAASE,gBAAkB,WAC3BF,EAASG,qBAAuB,UAEhCH,EAASI,SAAW,GACpBJ,EAASI,SAASJ,EAAShB,OAAS,WAAWqB,KAAKC,SAASN,EAAShB,MAAMuB,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,+IAAqJC,EAAEF,EAAIG,IAAI,CAAC,QAAQ,GAAOH,EAAI,KAAKC,EAAE,kBAAkBG,EAAEJ,EAAIG,IAAI,CAAC,UAAU,GAAOH,EAAI,CAACK,KAAOC,EAAOC,MAAQC,GAAQ,IAAIJ,EAAEJ,EAAIG,IAAI,CAAC,qBAAqB,GAAOH,EAAI,CAACO,MAAQE,GAAQ,IAAIR,EAAE,4CAA8CS,EAAEV,EAAIG,IAAI,CAAC,aAAa,GAAOH,EAAI,CAACK,KAAOM,EAAOJ,MAAQK,GAAQ,IAAIX,EAAE,SAASG,EAAEJ,EAAIG,IAAI,CAAC,iBAAiB,GAAOH,EAAI,CAACO,MAAQM,GAAS,IAAKf,EAAOgB,YAAW,EAAG,SAASR,EAAOP,EAAIC,GAAK,OAAOD,EAAIE,EAAE,0GAA8GC,EAAEF,EAAIe,SAAQ,EAAO,CAAC,SAAS,MAAMf,EAAI,KAAKC,EAAE,wHAA4HC,EAAEF,EAAIe,SAAQ,EAAO,CAAC,SAAS,MAAMf,EAAI,KAAKC,EAAE,kBAAmBK,EAAOQ,YAAW,EAAG,SAASN,EAAOT,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mEAAqEe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,QAAQhB,EAAE,4CAA8CC,EAAEF,EAAIe,SAAQ,EAAO,CAAC,SAAS,MAAMf,EAAI,KAAKC,EAAE,iFAAmFe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,QAAQhB,EAAE,4CAA8CC,EAAEF,EAAIe,SAAQ,EAAO,CAAC,SAAS,MAAMf,EAAI,KAAKC,EAAE,kBAAmBO,EAAOM,YAAW,EAAG,SAASL,EAAOV,EAAIC,GAAK,OAAOD,EAAIE,EAAE,6DAA+De,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,QAAQhB,EAAE,0DAA6DQ,EAAOK,YAAW,EAAG,SAASH,EAAOZ,EAAIC,GAAK,OAAOD,EAAImB,GAAGlB,EAAIG,IAAI,CAAC,YAAY,GAAOH,EAAI,CAACO,MAAQY,GAAQ,IAAKR,EAAOG,YAAW,EAAG,SAASK,EAAOpB,EAAIC,GAAK,OAAOD,EAAImB,GAAGlB,EAAIG,IAAI,CAAC,qBAAqB,GAAOH,EAAI,CAACO,MAAQa,GAAQ,IAAKD,EAAOL,YAAW,EAAG,SAASM,EAAOrB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mCAAqCe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,WAAWhB,EAAE,SAAUmB,EAAON,YAAW,EAAG,SAASF,EAAOb,EAAIC,GAAK,OAAOD,EAAIE,EAAE,YAAYG,EAAEJ,EAAIG,IAAI,CAAC,UAAU,GAAOH,EAAI,CAACK,KAAOgB,EAAOd,MAAQe,GAAS,IAAIrB,EAAE,mDAAqDS,EAAEV,EAAIG,IAAI,CAAC,cAAc,GAAOH,EAAI,CAACK,KAAOkB,EAAQhB,MAAQiB,GAAS,IAAIvB,EAAE,eAAgBW,EAAOE,YAAW,EAAG,SAASO,EAAOtB,EAAIC,GAAK,OAAOD,EAAIK,EAAEJ,EAAIe,SAAQ,EAAO,CAAC,SAAS,IAAI,UAAUf,EAAI,CAACK,KAAOoB,EAAOlB,MAAQmB,GAAS,IAAKL,EAAOP,YAAW,EAAG,SAASW,EAAO1B,EAAIC,GAAK,OAAOD,EAAIG,EAAEF,EAAIe,SAAQ,EAAO,CAAC,QAAQ,SAASf,EAAI,KAAMyB,EAAOX,YAAW,EAAG,SAASY,EAAQ3B,EAAIC,GAAK,OAAOD,EAAIG,EAAEF,EAAIe,SAAQ,EAAO,CAAC,SAAS,IAAI,UAAUf,EAAI,KAAM0B,EAAQZ,YAAW,EAAG,SAASQ,EAAQvB,EAAIC,GAAK,OAAOD,EAAIG,EAAEF,EAAIG,IAAI,CAAC,UAAU,GAAOH,EAAI,KAAMsB,EAAQR,YAAW,EAAG,SAASS,EAAQxB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,oCAAsCS,EAAEV,EAAIG,IAAI,CAAC,WAAW,GAAOH,EAAI,CAACK,KAAOsB,EAAQpB,MAAQqB,GAAS,IAAI3B,EAAE,SAAUsB,EAAQT,YAAW,EAAG,SAASa,EAAQ5B,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mCAAqCe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,wBAAwBhB,EAAE,SAAU0B,EAAQb,YAAW,EAAG,SAASc,EAAQ7B,EAAIC,GAAK,OAAOD,EAAIE,EAAE,+CAAiDC,EAAEF,EAAIe,SAAQ,EAAO,CAAC,WAAW,WAAWf,EAAI,KAAKC,EAAE,YAAYS,EAAEV,EAAIG,IAAI,CAAC,SAAS,GAAOH,EAAI,CAACO,MAAQsB,GAAS,IAAI5B,EAAE,+HAAmIS,EAAEV,EAAIG,IAAI,CAAC,aAAa,GAAOH,EAAI,CAACK,KAAOyB,EAAQvB,MAAQwB,GAAS,IAAI9B,EAAE,oBAAqB2B,EAAQd,YAAW,EAAG,SAASe,EAAQ9B,EAAIC,GAAK,OAAOD,EAAIG,EAAEF,EAAIe,SAAQ,EAAM,IAAIf,EAAI,KAAKgB,EAAE,MAAMhB,EAAI,CAACO,MAAQyB,GAAS,IAAKH,EAAQf,YAAW,EAAG,SAASkB,EAAQjC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,YAAa+B,EAAQlB,YAAW,EAAG,SAASgB,EAAQ/B,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mCAAqCe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,sBAAsBhB,EAAE,SAAU6B,EAAQhB,YAAW,EAAG,SAASiB,EAAQhC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQG,EAAEJ,EAAIG,IAAI,CAAC,eAAe,GAAOH,EAAI,CAACK,KAAO4B,EAAQ1B,MAAQ2B,GAAS,IAAIjC,EAAE,SAAU8B,EAAQjB,YAAW,EAAG,SAASmB,EAAQlC,EAAIC,GAAK,OAAOD,EAAIK,EAAEJ,EAAIG,IAAI,CAAC,UAAU,GAAOH,EAAI,CAACK,KAAO8B,EAAQ5B,MAAQ6B,GAAS,IAAKH,EAAQnB,YAAW,EAAG,SAASqB,EAAQpC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQC,EAAEF,EAAIG,IAAI,CAAC,OAAO,GAAOH,EAAI,KAAKC,EAAE,eAAeG,EAAEJ,EAAIG,IAAI,CAAC,aAAa,GAAOH,EAAI,CAACO,MAAQ8B,GAAS,IAAIpC,EAAE,YAAYS,EAAEV,EAAIG,IAAI,CAAC,eAAe,GAAOH,EAAI,CAACO,MAAQ+B,GAAS,IAAIrC,EAAE,oBAAqBkC,EAAQrB,YAAW,EAAG,SAASuB,EAAQtC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,YAAae,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,qBAAqBhB,EAAE,KAAOoC,EAAQvB,YAAW,EAAG,SAASwB,EAAQvC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,sCAAwCC,EAAEF,EAAIG,IAAI,CAAC,SAAS,GAAOH,EAAI,KAAKC,EAAE,sCAAwCsC,EAAE,sBAAsBvC,EAAIA,EAAIwC,OAAOxC,EAAIG,IAAI,CAAC,UAAU,IAAQ,IAAIF,EAAE,cAAeqC,EAAQxB,YAAW,EAAG,SAASsB,EAAQrC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,sCAAwCe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,aAAahB,EAAE,0CAA4CC,EAAEF,EAAIG,IAAI,CAAC,UAAU,GAAOH,EAAI,KAAKC,EAAE,kBAAmBmC,EAAQtB,YAAW,EAAG,SAASoB,EAAQnC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,YAAYhB,EAAE,SAASe,EAAE,KAAKhB,EAAI,CAACK,KAAOoC,EAAQlC,MAAQmC,GAAS,CAACC,IAAM3C,EAAIG,IAAI,CAAC,cAAc,GAAOyC,MAAQ,cAAeV,EAAQpB,YAAW,EAAG,SAAS2B,EAAQ1C,EAAIC,GAAK,OAAOD,EAAIE,EAAE,SAASC,EAAEF,EAAIG,IAAI,CAAC,eAAe,GAAOH,EAAI,KAAKC,EAAE,UAAWwC,EAAQ3B,YAAW,EAAG,SAAS4B,EAAQ3C,EAAIC,GAAK,OAAOD,EAAIE,EAAE,oCAAoCG,EAAEJ,EAAIG,IAAI,CAAC,cAAc,GAAOH,EAAI,CAACO,MAAQsC,GAAS,IAAKH,EAAQ5B,YAAW,EAAG,SAAS+B,EAAQ9C,EAAIC,GAAK,OAAOD,EAAIiB,EAAE,KAAKhB,EAAI,CAACK,KAAOyC,EAAQvC,MAAQwC,GAAS,CAACJ,IAAM3C,EAAIG,IAAI,CAAC,cAAc,GAAOyC,MAAQ,KAAMC,EAAQ/B,YAAW,EAAG,SAASgC,EAAQ/C,EAAIC,GAAK,OAAOD,EAAIE,EAAE,iBAAkBC,EAAEF,EAAIG,IAAI,CAAC,WAAW,GAAOH,EAAI,KAAKC,EAAE,eAAiB6C,EAAQhC,YAAW,EAAG,SAASiC,EAAQhD,EAAIC,GAAK,OAAOD,EAAIE,EAAE,+DAAkEC,EAAEF,EAAIG,IAAI,CAAC,WAAW,GAAOH,EAAI,KAAKC,EAAE,mEAAsEC,EAAEF,EAAIG,IAAI,CAAC,cAAc,GAAOH,EAAI,KAAKC,EAAE,2BAA2Be,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,WAAWhB,EAAE,gBAAkB8C,EAAQjC,YAAW,EAAG,SAASU,EAAQzB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,sCAAwCC,EAAEF,EAAIG,IAAI,CAAC,cAAc,GAAOH,EAAI,KAAKC,EAAE,WAAYuB,EAAQV,YAAW,EAAG,SAASD,EAAQd,EAAIC,GAAK,OAAOD,EAAIiB,EAAE,KAAKhB,EAAI,CAACO,MAAQyC,GAAS,CAACL,IAAM3C,EAAIG,IAAI,CAAC,iBAAiB,GAAOyC,MAAQ,IAAIK,KAAO,WAAYpC,EAAQC,YAAW,EAAG,SAASkC,EAAQjD,EAAIC,GAAK,OAAOD,EAAIE,EAAE,gDAAkDe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,aAAahB,EAAE,6FAAiGC,EAAEF,EAAIG,IAAI,CAAC,iBAAiB,GAAOH,EAAI,KAAKC,EAAE,sDAAwDe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,SAAShB,EAAE,QAAS+C,EAAQlC,YAAW,EAAG,OAAOhB,GACh9NP,EAASI,SAASJ,EAAShB,MAAQ,WAAa,WAAWqB,KAAKC,SAASN,EAAShB,MAAQ,UAAUuB,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIiB,EAAE,WAAWhB,EAAI,CAACkD,MAAQ5C,EAAOD,KAAOI,EAAOF,MAAQI,GAAQ,CAACwC,OAASnD,EAAIe,SAAQ,EAAM,MAAOjB,EAAOgB,YAAW,EAAG,SAASR,EAAOP,EAAIC,GAAK,OAAOD,EAAIE,EAAE,oEAAyEC,EAAEF,EAAIe,SAAQ,EAAM,IAAIf,EAAI,IAAI,CAAC,aAAaC,EAAE,mCAAqCC,EAAEF,EAAIe,SAAQ,EAAM,IAAIf,EAAI,IAAI,CAAC,aAAaC,EAAE,4DAAkEC,EAAEF,EAAIe,SAAQ,EAAM,IAAIf,EAAI,IAAI,CAAC,aAAaC,EAAE,6BAAkCe,EAAE,OAAOhB,EAAI,GAAG,CAAC2C,IAAM3C,EAAIe,SAAQ,EAAM,MAAMd,EAAE,KAAKe,EAAE,OAAOhB,EAAI,GAAG,CAACiB,KAAO,kCAAkChB,EAAE,oDAAsDe,EAAE,UAAUhB,EAAI,CAACO,MAAQC,GAAQ,CAAC4C,GAAKpD,EAAIe,SAAQ,EAAM,MAAMd,EAAE,gCAAiCK,EAAOQ,YAAW,EAAG,SAASN,EAAOT,EAAIC,GAAK,OAAOD,EAAIE,EAAE,YAAYsC,EAAE,sBAAsBvC,EAAIA,EAAIwC,OAAOxC,EAAIG,IAAI,CAAC,UAAU,IAAQ,IAAIF,EAAE,cAAeO,EAAOM,YAAW,EAAG,SAASL,EAAOV,EAAIC,GAAK,OAAOD,EAAIG,EAAEF,EAAIe,SAAQ,EAAM,IAAIf,EAAI,IAAI,CAAC,MAAOS,EAAOK,YAAW,EAAG,SAASH,EAAOZ,EAAIC,GAAK,OAAOD,EAAIE,EAAE,sCAAwCe,EAAE,UAAUhB,EAAI,CAACO,MAAQY,GAAQ,CAACiC,GAAKpD,EAAIe,SAAQ,EAAM,MAAMd,EAAE,oBAAqBU,EAAOG,YAAW,EAAG,SAASK,EAAOpB,EAAIC,GAAK,OAAOD,EAAIiB,EAAE,aAAahB,EAAI,CAACK,KAAOe,EAAOb,MAAQmB,GAAS,CAAC0B,GAAKpD,EAAIe,SAAQ,EAAM,MAAOI,EAAOL,YAAW,EAAG,SAASM,EAAOrB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,iCAAmCC,EAAEF,EAAIG,IAAI,CAAC,QAAQ,GAAOH,EAAI,KAAKC,EAAE,aAAae,EAAE,WAAWhB,EAAI,CAACkD,MAAQtC,EAAOP,KAAOgB,EAAOd,MAAQkB,GAAQ,CAAC0B,OAASnD,EAAIG,IAAI,CAAC,UAAU,KAASoC,EAAE,sBAAsBvC,EAAIA,EAAIwC,OAAOxC,EAAIG,IAAI,CAAC,UAAU,IAAQ,IAAIF,EAAE,oBAAqBmB,EAAON,YAAW,EAAG,SAASF,EAAOb,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mDAA8CC,EAAEF,EAAIe,SAAQ,EAAM,IAAIf,EAAI,IAAI,CAAC,aAAaC,EAAE,6BAAkCC,EAAEF,EAAIG,IAAI,CAAC,QAAQ,GAAOH,EAAI,KAAKC,EAAE,kBAAmBW,EAAOE,YAAW,EAAG,SAASO,EAAOtB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,4BAAuBoB,EAAOP,YAAW,EAAG,SAASW,EAAO1B,EAAIC,GAAK,OAAOD,EAAIE,EAAE,8DAA2DC,EAAEF,EAAIe,SAAQ,EAAM,IAAIf,EAAI,IAAI,CAAC,aAAaC,EAAE,mCAAqCC,EAAEF,EAAIe,SAAQ,EAAM,IAAIf,EAAI,IAAI,CAAC,aAAaC,EAAE,4DAAkEC,EAAEF,EAAIe,SAAQ,EAAM,IAAIf,EAAI,IAAI,CAAC,aAAaC,EAAE,6BAAkCC,EAAEF,EAAIG,IAAI,CAAC,QAAQ,GAAOH,EAAI,KAAKC,EAAE,kBAAmBwB,EAAOX,YAAW,EAAG,SAASY,EAAQ3B,EAAIC,GAAK,OAAOD,EAAIE,EAAE,yCAA6CC,EAAEF,EAAIG,IAAI,CAAC,QAAQ,GAAOH,EAAI,KAAKC,EAAE,4CAA8CsC,EAAE,sBAAsBvC,EAAIA,EAAIwC,OAAOxC,EAAIG,IAAI,CAAC,UAAU,IAAQ,IAAIF,EAAE,cAAeyB,EAAQZ,YAAW,EAAG,OAAOhB,GAE12FP,EAASM,SAAW,SAAUwD,GAC1B,MAAMC,EAAOnF,KAEPoF,EAASlG,GAAGC,QAAQC,MAAMiC,UAAUK,SAAS2D,KAAKF,EAAMD,GAE9DC,EAAKG,gBAELJ,EAAIK,OAAO,WACP,MAAMC,EAAWN,EAAIO,mBAAmB,oBAAoB,GACxDD,GACAL,EAAKO,kBAAkBF,EAASG,sBAIxCR,EAAKlE,YAAckE,EAAKS,QAAQ3E,aAAe/B,GAAGC,QAAQW,mBAAmBmB,YAAYxB,MACzF0F,EAAKU,eAAeV,EAAKlE,aAEzBiE,EACKD,GAAG/F,GAAGK,OAAOC,MAAME,UAAY,IAAMR,GAAGK,OAAOC,MAAMK,kBAAmB,SAAUiG,GAC/E,GAAIA,EAAE3G,UAAYgG,EAAKY,qBAAuBZ,EAAK5E,aAAc,CAC7D,GAAI4E,EAAKa,qBAAuBb,EAAKS,QAAQK,qBAAsB,CAC/Dd,EAAKe,gBAAgBf,EAAKa,oBAC1Bb,EAAKa,mBAAqB,MAEzBb,EAAKgB,UAAYL,EAAEM,SACpBjB,EAAK3E,YAAY6F,cAAcP,EAAEM,YAI5CnB,GAAG/F,GAAGK,OAAOC,MAAMK,kBAAmB,SAAUiG,GAC7CX,EAAKa,mBAAqB,OAE7Bf,GAAG/F,GAAGK,OAAOC,MAAMC,MAAQ,IAAMP,GAAGK,OAAOC,MAAMI,UAAY,IAAMV,GAAGK,OAAOC,MAAMG,UAAW,SAAUmG,GACrG,MAAM3G,EAAU2G,EAAE3G,QACdA,EAAQmH,iBAAmBnB,EAAKzE,gBAChCyE,EAAKa,mBAAqB7G,EAAQmH,gBAIlCR,EAAE3G,QAAQoH,QAAUpB,GACpBA,EAAKqB,iBAAiBrH,KAI7B8F,GAAG/F,GAAGK,OAAOC,MAAMG,UAAW,SAAUmG,GACrCW,WAAW,WACPtB,EAAKa,mBAAqBF,EAAE3G,QAAQmH,gBACrC,MAENrB,GAAG/F,GAAGK,OAAOC,MAAMkH,YAAa,WAC7B,GAAIC,OAAOC,KAAKzB,EAAKvE,cAAciG,OAAQ,CACvC,MAAMC,EAAW,GACjB3B,EAAKD,IAAI6B,WACJC,OAAO,SAAUC,GACd,OAAOA,EAAMnC,OAAS5F,GAAGK,OAAO2H,UAAUC,MAE7CC,QAAQ,SAAUH,GACf,MAAMI,EAAQP,EAASG,EAAMK,MAAQ,GACrCR,EAASG,EAAMK,KAAOD,EAAME,OAAON,EAAMO,8BAEjD,IAAIC,GAAkB,EACtB,IAAK,IAAIH,KAAOnC,EAAKvE,aAAc,CAC/B,MAAM8G,EAAiBvC,EAAKvE,aAAa0G,GACzC,GAAIR,EAASa,eAAeL,GAAM,CAC9B,MAAMM,EAAUd,EAASQ,GACzB,IAAK,IAAIO,KAAQH,EAAgB,CAC7B,MAAMI,EAAeJ,EAAeG,GACpC,GAAID,EAAQG,QAAQF,GAAQ,EAAG,CAC3BC,EAAaE,QAAQZ,QAAQrF,GAAKoD,EAAKe,gBAAgBnE,IACvD+F,EAAajB,OAAS,EACtBY,GAAkB,QAIzB,CACD,IAAK,IAAII,KAAQH,EAAgB,CACRA,EAAeG,GACvBG,QAAQZ,QAAQrF,GAAKoD,EAAKe,gBAAgBnE,IACvD0F,GAAkB,SAEftC,EAAKvE,aAAa0G,IAG7BG,GACAtC,EAAK8C,kBAIhBhD,GAAG/F,GAAGK,OAAOC,MAAM0I,WAAY,SAAUpC,GACtCX,EAAK8C,iBAGb,OAAO7C,GAGXhE,EAAS+G,OAAS,WACDnI,KAERoI,IAAIC,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQC,QACzC,OAHaxI,KAGDyI,qBAAqBC,QAAQC,YAG7CvH,EAASwH,iBAAmB,SAAUhD,GAClC,MAAMT,EAAOnF,KACbmF,EAAKgB,UAAW,EAEZhB,EAAKzE,gBACLyE,EAAKxE,KAAO,CAAEmG,SAAUlB,EAAQkB,WAGpC,GAAKlB,EAAQiD,aAIR,CACD1D,EAAK2D,uBACL3D,EAAKpE,iBAAmB6E,EAAQiD,aAChC1D,EAAKD,IAAI6D,QAAQ7J,GAAGK,OAAOC,MAAMwJ,YAAa9J,GAAG+J,KAAKC,OAAO,CAAE/J,QAASgG,GAAQS,QAPzD,CACvBT,EAAKpE,iBAAmB,EACxBoE,EAAKD,IAAI6D,QAAQ7J,GAAGK,OAAOC,MAAM2J,cAAe,CAAEhK,QAASgG,MASnE/D,EAASgI,cAAgB,SAAUxD,GAC/B,MAAMT,EAAOnF,KACU,MAAnB4F,EAAQyD,QACRlE,EAAKD,IAAIoE,MAAMnE,EAAKoE,gBAAgB,6BAA8B,CAAEzE,KAAM5F,GAAGK,OAAOiK,QAAQC,QAEhGtE,EAAKyD,iBAAiB,KAG1BxH,EAASsI,YAAc,CACnBC,SAAUzK,GAAGK,OAAOgJ,QAAQqB,MAC5BC,OAAQ,CAAC,GAAK,IACdC,MAAO,GACPC,OAAQ,GACRC,SAAS,GAGb5I,EAASyE,eAAiB,SAAUoE,GAChC,IAAI9E,EAAOnF,KACXmF,EAAKlE,YAAcgJ,EACnB,IAAI/E,EAAMC,EAAKD,IACf,OAAQ+E,GACJ,KAAK/K,GAAGC,QAAQW,mBAAmBmB,YAAYC,cACtCiE,EAAKrE,cACNoE,EAAIgF,WAAW,gBACVC,KAAK,SAAUC,GACZjF,EAAKrE,aAAesJ,EACpBA,EAAG7D,OAASpB,IAGxB,MACJ,QACIA,EAAKlE,YAAc/B,GAAGC,QAAQW,mBAAmBmB,YAAYxB,MACxD0F,EAAKtE,OACNqE,EAAIgF,WAAW,QAAS,CACpBG,aAAa,EACbC,UAAWnF,EAAKS,QAAQ0E,YACzBH,KAAK,SAAUtJ,GACdsE,EAAKtE,MAAQA,EACbA,EAAM0F,OAASpB,EACfD,EAAID,GAAG/F,GAAGK,OAAOC,MAAMC,MAAO,SAAUqG,GACpCX,EAAKoF,YAAYzE,KAGrBZ,EAAID,GAAG/F,GAAGK,OAAOC,MAAME,UAAW,SAAUoG,GACpCA,EAAE3G,UAAY0B,GAEdsE,EAAKqF,mBASjCpJ,EAAS2E,kBAAoB,WAEzB,OADW/F,KACEiB,aACT,KAAK/B,GAAGC,QAAQW,mBAAmBmB,YAAYC,cAC3C,OAHGlB,KAGSc,aAChB,QACI,OALGd,KAKSa,QAIxBO,EAASqJ,iBAAmB,SAAU7E,GAGlC,IADAA,EAAUA,GAAW,IACTzG,QACR,QAAQ,GACJ,KAAKD,GAAGC,QAAQuL,OAAS9E,EAAQzG,mBAAmBD,GAAGC,QAAQuL,MAC3D,OAAO9E,EAAQzG,QAAQwL,sBAC3B,KAAKzL,GAAGC,QAAQyL,cAAgBhF,EAAQzG,mBAAmBD,GAAGC,QAAQyL,aAClE,OAAOhF,EAAQzG,QAAQ0L,mBAC3B,QACI,OAAO,KAGnB,OAZW7K,KAYEiB,aACT,KAAK/B,GAAGC,QAAQW,mBAAmBmB,YAAYC,cAC3C,OAdGlB,KAcSc,aAAa+J,mBAC7B,QACI,OAhBG7K,KAgBSa,MAAM8J,wBAI9BvJ,EAAS0J,cAAgB,WAErB,OADW9K,KACEiB,aACT,KAAK/B,GAAGC,QAAQW,mBAAmBmB,YAAYC,cAC3C,OAHGlB,KAGSc,aAAaiK,iBAC7B,QACI,OALG/K,KAKSa,MAAMkK,mBAI9B3J,EAAS4J,eAAiB,WACtB,IAAI7F,EAAOnF,KACX,MAAMiL,EAAQ9F,EAAKiD,IAAI8C,WAAU,GACjCD,EAAM5C,UAAU8C,OAAOjM,GAAGK,OAAOgJ,QAAQC,QACzCrD,EAAKzE,cAAc0K,KAAOH,EAAMI,UAChC,OAAQlG,EAAKlE,aACT,KAAK/B,GAAGC,QAAQW,mBAAmBmB,YAAYC,cAC3C,GAAIiE,EAAKrE,aAAc,CAEqD,IAApEqE,EAAKD,IAAIO,mBAAmBvG,GAAGC,QAAQmM,kBAAkBzE,QACzD1B,EAAKD,IAAIO,mBAAmBvG,GAAGC,QAAQyL,cAAcxD,QAAQ,SAAUhD,GAC/DA,EAAEmH,aACFnH,EAAEoH,UAMCrG,EAAKD,IAAIO,mBAAmB,2BACpC2B,QAAQ,SAAUhD,GACjBA,IAAMe,EAAKrE,cAAgBsD,EAAEkC,iBAAmBlC,EAAEqH,OAClDrH,EAAEoH,UAIVrG,EAAKrE,aAAawF,eAAiBnB,EAAKzE,cACxCyE,EAAKrE,aAAa4K,KAAKvG,EAAKzE,cAAc0K,KAAMjG,EAAKrE,aAAa+J,oBAElE3L,GAAGyM,QACEzM,GAAGC,QAAQyM,MACZ,CAAC1M,GAAGI,YAAc,oBAClB,WAEI,MAAMuM,EAAW1G,EAAK2F,gBAAgBgB,iBAAiB,IAAM5M,GAAGC,QAAQyM,MAAMvK,UAAUjB,MAAQ,QAC5FyL,EAAShF,OAAS,GAClBgF,EAAS,GAAGV,SAGhBhG,EAAK4G,2BAIjB,MACJ,QACQ5G,EAAKtE,OACLsE,EAAKzE,cAAcsL,UAAU7G,EAAKtE,SAMlD,MAAMoL,EAAkB,SAAUC,GAC9B,OAAOC,MAAMC,KAAKF,EAAIG,cAAcC,UAAUvE,QAAQmE,IAGpDK,EAAmB,SAAUL,EAAKM,GACpC,IAAIpH,EAAS8G,EACb,GACI9G,EAASA,EAAOiH,oBAEbjH,GAAUA,EAAOoH,UAAYA,GACpC,OAAOpH,GAGXhE,EAASqL,kBAAoB,SAAUrG,GACnC,MAAMjB,EAAOnF,KACb,IAAIoF,EAIJD,EAAKsF,mBAAmBqB,iBAAiB3G,EAAK9E,WAAWC,WAAW8G,QAAQ,SAAUsF,GAClF,MAAMC,EAAmBD,EACnBE,EAAiBL,EAAiBG,EAAI,MACtCG,EAAmBN,EAAiBK,EAAgB,MAC/CzH,EAAK2H,WAAWb,EAAgBY,GAAmBZ,EAAgBW,GAAiBX,EAAgBU,MAClGvG,IACThB,EAASuH,KAGjB,OAAOvH,GAGXhE,EAAS2L,sBAAwB,SAAUC,GACvC,MACMC,EADOjN,KACIyK,mBAAmBqB,iBAAiB,MADxC9L,KACqDI,MAAQ,kBACpEyG,EAASoG,EAAIpG,OACnB,IAAK,IAAIqG,EAAI,EAAGA,EAAIrG,EAAQqG,IACxB,GAAID,EAAIC,GAAGC,QAAQ,IAAMjO,GAAGK,OAAOgJ,QAAQ6E,SACvC,OAAOH,GAAKC,EAAIF,EAAQnG,GAAUA,GAG1C,OAAO,MAGXzF,EAASiM,eAAiB,SAAUjH,GAChC,MAAMjB,EAAOnF,KACb,GAAImF,EAAKxE,MAAQwE,EAAKxE,KAAKmG,SACvB,IAAK,IAAIoG,EAAI,EAAGI,EAAKnI,EAAKxE,KAAKmG,SAASD,OAAQqG,EAAII,EAAIJ,IAAK,CACzD,MAAMtF,EAAUzC,EAAKxE,KAAKmG,SAASoG,GACnC,IAAK,IAAIK,EAAI,EAAGC,EAAK5F,EAAQ6F,OAAO5G,OAAQ0G,EAAIC,EAAID,IAAK,CACrD,MAAMtG,EAAQW,EAAQ6F,OAAOF,GAC7B,IAAK,IAAIG,EAAI,EAAGC,EAAK1G,EAAM2G,SAAS/G,OAAQ6G,EAAIC,EAAID,IAChD,GAAIzG,EAAM2G,SAASF,KAAOtH,EACtB,MAAO,CACHwB,QAASA,EAAQiG,OAASjG,EAAQkG,UAAUC,OAAO,SAAUC,EAAMC,GAC/D,OAAOD,GAAQC,EAAIJ,OACpB,IACH5G,MAAOA,EAAMiH,OAOrC,OAAO,MAGX9M,EAAS6G,aAAe,WAEpB,OADWjI,KACEiB,aACT,KAAK/B,GAAGC,QAAQW,mBAAmBmB,YAAYC,cAFxClB,KAGMc,cAHNd,KAG2Bc,aAAayK,aAHxCvL,KAIMc,aAAa0K,QAEtB,MACJ,QAPOxL,KAQMa,OARNb,KAQoBa,MAAM0K,aAR1BvL,KASMa,MAAMsN,SAM3B/M,EAAS2K,uBAAyB,WAC9B,IAAI5G,EAAOnF,KACX,MAAMoO,EAAUjJ,EAAKsF,mBAAmB4D,cAAc,IAAMlJ,EAAK/E,OAEjE,IAAIkO,EAxXmBC,EA0XnBC,EAAY,QAChBJ,EAAQK,iBAAiBD,EAAWtP,GAAGwP,YAAYC,mBAAmBxJ,EAAK9E,WAAWC,UAAW,SAAUwF,GACvGX,EAAKyJ,iBAAiB9I,EAAE+I,WAI5BL,EAAYtP,GAAGK,OAAOC,MAAMsP,MAC5BR,EAAW,IAAMnJ,EAAK/E,MAAQ,YAC9BgO,EAAQK,iBAAiBD,EAAWtP,GAAGwP,YAAYC,mBAAmBL,EAAU,SAAUxI,GACtFX,EAAKyJ,iBAAiBzJ,EAAK4H,sBAAsB,GAAI,GACrD,OAAO,KAIXuB,EAAW,IAAMnJ,EAAK/E,MAAQ,YAC9BgO,EAAQK,iBAAiBD,EAAWtP,GAAGwP,YAAYC,mBAAmBL,EAAU,SAAUxI,GACtFX,EAAKyJ,iBAAiBzJ,EAAK4H,uBAAuB,IAAK,GACvD,OAAO,KAIXuB,EAAW,MAAQnJ,EAAK/E,MAAQ,aAEhCgO,EAAQK,iBAAiBD,EAAWtP,GAAGwP,YAAYC,mBAAmBL,EAAU,SAAUxI,GACtF,MAAM4G,EAAKH,EAAiBzG,EAAE+I,OAAQ,MACtC,GAAInC,EAAGrE,UAAU0G,SAAS7P,GAAGK,OAAOgJ,QAAQ6E,SAAU,CAElD,MAAM4B,EAAeZ,EAAQC,cAAc,4CACvCW,GAA2D,SAA3CC,iBAAiBD,GAAcE,SAC/C/J,EAAKgK,uBAGR,CACDhK,EAAKyJ,iBAAiBlC,EAAG2B,cAAclJ,EAAK9E,WAAWC,YACnD6E,EAAKlE,cAAgB/B,GAAGC,QAAQW,mBAAmBmB,YAAYxB,OAC/D0F,EAAKtE,MAAMuO,WAAU,OAMjCd,EAAW,IAAMnJ,EAAK/E,MAAQ,WAC9BgO,EAAQK,iBAAiBD,EAAWtP,GAAGwP,YAAYC,mBAAmBL,EAAU,SAAUxI,GACtFX,EAAKgK,mBACLhK,EAAK8C,kBAGT,GAAI9C,EAAKxE,KACL,GAAIwE,EAAKxE,KAAK0O,gBAAkBlK,EAAKsH,kBAAkBtH,EAAKxE,KAAK0O,gBAAiB,CAC9ElK,EAAKsH,kBAAkBtH,EAAKxE,KAAK0O,gBAAgBhH,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ+G,SACjFnK,EAAKyJ,iBAAiBzJ,EAAKxE,KAAK0O,qBAE3BjB,EAAQC,cAAclJ,EAAK9E,WAAWC,YAC3C6E,EAAKyJ,iBAAiBR,EAAQC,cAAclJ,EAAK9E,WAAWC,YAIpE8N,EAAQtC,iBAAiB,2BAA2B1E,QAAQ,SAAUmI,GAClEA,EAAMd,iBAAiBvP,GAAGK,OAAOC,MAAMsP,MAAO,SAAUhJ,GACpD,MAAM4G,EAAK1M,KAAKqM,cAChB,IAAIK,EAAGrE,UAAU0G,SAAS7P,GAAGK,OAAOgJ,QAAQiH,UAA5C,CAGA,GAAI9C,EAAGrE,UAAU0G,SAAS7P,GAAGK,OAAOgJ,QAAQ6E,UAExC,GAAIjI,EAAK5E,aAAaqN,SAAS,IAAM6B,OAAOC,gBAAqE,IAAnDD,OAAOC,eAAeC,WAAWC,OAAO/I,OAAc,CAMhH1B,EAAKD,IAAID,GAAG/F,GAAGK,OAAOC,MAAMqQ,KAJV,SAASC,IACvB3K,EAAK4K,UAAW,EAChB5K,EAAKD,IAAI8K,IAAI9Q,GAAGK,OAAOC,MAAMqQ,KAAMC,KAGvC3K,EAAK4K,UAAW,EAGhB5K,EAAKD,IAAI+K,eAAe,CAAC9K,EAAK5E,aAAaqN,SAAS,IAAK,CAAEsC,SAAS,UAKxE/K,EAAKyJ,iBAAiBlC,GAE1B5G,EAAEqK,uBAGV/B,EAAQtC,iBAAiB,qCAAqC1E,QAAQ,SAAUgJ,GAC5EA,EAAE3B,iBAAiBvP,GAAGK,OAAOC,MAAMsP,MAAO,SAAUhJ,GAChDA,EAAEqK,sBAIV,GAAIjR,GAAGmR,gBAAgBC,SAAWnL,EAAKlE,cAAgB/B,GAAGC,QAAQW,mBAAmBmB,YAAYC,cAAe,CAC5G,MAAMqP,EAAUnC,EAAQC,cAAc,IAAMlJ,EAAK/E,MAAQ,aACzD,IAAKmQ,GAAqC,SAA1BA,EAAQC,MAAMtB,QAAoB,CAC1C/J,EAAKrE,cACL5B,GAAG+J,KAAKwH,MAAMtL,EAAKrE,aAAasH,IAAK,aAzd1BmG,EA4dApJ,GA3dZxE,MAAQ4N,EAAI5N,KAAKmG,SACxByH,EAAI5N,KAAKmG,SAASiH,OAAO,SAAU2C,EAAQ9I,GACvC,OAAO8I,EAAS9I,EAAQ6F,OAAOM,OAAO,SAAU4C,EAAQ1J,GACpD,OAAO0J,EAAS,GACjB,IACJ,GAAK,GAsdmB,GACnBzR,GAAG+J,KAAKwH,MAAMrC,EAAS,CACnBwC,KAAM,WACFzL,EAAKyJ,iBAAiBzJ,EAAK4H,sBAAsB,GAAI,IAEzD8D,MAAO,WACH1L,EAAKyJ,iBAAiBzJ,EAAK4H,uBAAuB,IAAK,SAQ/E3L,EAASmJ,YAAc,SAAUzE,GAC7B,MAAMX,EAAOnF,KACb,GAAI8F,EAAE3G,UAAYgG,EAAKtE,MAAO,CAE1BsE,EAAK4G,yBAGL5G,EAAK2L,aAIb1P,EAASsE,kBAAoB,SAAUqL,KAIvC3P,EAAS4P,YAAc,WAEnB,MAAMC,EADKjR,KACWuJ,gBAAgB,QAChC2H,EAFKlR,KAEYuJ,gBAAgB,mBAF5BvJ,KAGNoI,IAAI0D,iBAAiB,MAHf9L,KAG4BI,MAAQ,QAAQgH,QAAQ,SAAU+J,GACrE,MAAMC,EAAOD,EAAGE,YACZnS,GAAG+J,KAAKqI,MAAMF,KACdD,EAAGI,UAAY,YAAcH,EAAO,4BAA8BF,EAAY,KAAOD,EAAW,WAK5G7P,EAASwN,iBAAmB,SAAU4C,EAAkBxE,GACpD,MAAM7H,EAAOnF,KACb,IAAIoG,EACJ,IAAKjB,EAAK4K,SAAU,CAChB,IAAI0B,EAEJ,GAAID,aAA4BtS,GAAGwS,QAAS,CACxCtL,EAAUoL,EACVC,EAAYtM,EAAKsH,kBAAkBrG,OAElC,CACDqL,EAAYD,EACZ,KAAOC,GAAmC,OAAtBA,EAAUjF,SAC1BiF,EAAYA,EAAUpF,cAG9B,MAAMsF,EAAUpF,EAAiBkF,EAAW,MACtCG,EAAYrF,EAAiBoF,EAAS,MAEtCE,EAAa5F,EAAgB2F,GAC7BE,EAAW7F,EAAgB0F,GAC3BI,EAAa9F,EAAgBwF,GACnCrL,EAAUA,GAAWjB,EAAK2H,WAAW+E,EAAYC,EAAUC,GAE3D5M,EAAKgK,iBAAiB,CAAE6C,UAAW5L,IAGnC,MAAMwB,EAAUzC,EAAKxE,KAAKmG,SAAS+K,GAC9B1M,EAAKvE,aAAa+G,eAAeC,EAAQN,OAC1CnC,EAAKvE,aAAagH,EAAQN,KAAO,IAErC,MAAMI,EAAiBvC,EAAKvE,aAAagH,EAAQN,KAC3CL,EAAQW,EAAQ6F,OAAOqE,GACvBhK,EAAeJ,EAAeT,EAAMY,OAAS,GACnDH,EAAeT,EAAMY,MAAQC,EAAaP,OAAOnB,GAEjDqL,EAAUpJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ6E,SAC1CuE,EAAQtJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ6E,SACxCwE,EAAUvJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ6E,SAC1C,GAAIJ,EAAQ,EAAG,CACXyE,EAAUpJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ0J,UAC1CN,EAAQtJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ0J,UACxCL,EAAUvJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ0J,eAEzC,GAAIjF,EAAQ,EAAG,CAChByE,EAAUpJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ2J,WAC1CP,EAAQtJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ2J,WACxCN,EAAUvJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQ2J,WAG1CT,EAAUpD,cAAc,UACxBoD,EAAUpD,cAAc,SAAS8D,aAAa,QAAShN,EAAKoE,gBAAgB,kBAGhFpE,EAAKa,mBAAqBI,EAEtBjB,EAAKsF,mBAAmB4D,cAAc,IAAMlJ,EAAK/E,MAAQ,sBACzD+E,EAAKsF,mBAAmB4D,cAAc,IAAMlJ,EAAK/E,MAAQ,oBAAoBmR,UAAYpM,EAAKiN,gBAAgBP,EAAYC,EAAUC,GAAc,GAItJ,IAAInE,EAAWzI,EAAK5E,aAAaqN,SAAS5F,QACtCqK,EAA4BzE,EAAS5G,OAAO,SAAUsL,GACtD,OAAOlM,GAAWA,EAAQmM,KAAOD,EAAKC,KAI1C,GAAIF,EAA0BxL,OAAS,EAAG,CACtC1B,EAAKa,mBAAqBqM,EAA0B,GACpD,OAGClN,EAAKS,QAAQK,sBACd2H,EAASxG,QAAQrF,IACTA,IAAMoD,EAAKzE,eACXyE,EAAKe,gBAAgBnE,KAIjC,GAAIqE,GAAWA,EAAQoM,SAAU,CAC7BpM,EAAQqM,WAAatN,EAAKS,QAAQK,qBAClCd,EAAK5E,aAAamS,WAAWtM,QAG7BqL,EAAUpJ,UAAUC,IAAIpJ,GAAGK,OAAOgJ,QAAQiH,YAKtDpO,EAAS8E,gBAAkB,SAAUE,GACjC,MAAMjB,EAAOnF,KACbmF,EAAK5E,aAAa8F,cAAcD,GAChC,IAAKkB,OAAOnC,EAAKvE,aAAc,CAC3B,MAAMgH,EAAUzC,EAAKvE,aAAa0G,KAClC,IAAKO,QAAQD,EAAS,CAClB,MAAMX,EAAQW,EAAQC,MAChB8K,EAAM1L,EAAMc,QAAQ3B,GAC1B,GAAIuM,GAAO,EAAG,CACV1L,EAAM2L,OAAOD,EAAK,GACb1L,EAAMJ,eACAe,EAAQC,UAOnCzG,EAAS+N,iBAAmB,SAAUvJ,GAClC,MAAMT,EAAOnF,KACb4F,EAAUA,GAAW,GACrB,GAAIT,EAAKa,oBAAsBb,EAAKa,qBAAuBJ,EAAQoM,UAAW,CAC1E7M,EAAKe,gBAAgBf,EAAKa,oBAC1Bb,EAAKa,mBAAqB,KAE9B,MAAM6M,EAAejN,EAAQoM,UAAY7M,EAAKsH,kBAAkB7G,EAAQoM,gBAAac,EACrF,IAAIC,EAAcC,EAClB,GAAIH,EAAc,CACdE,EAAexG,EAAiBsG,EAAc,MAC9CG,EAAezG,EAAiBwG,EAAc,MAGlD,MAAMlE,EAAS1J,EAAKsF,mBACpB0B,MAAMC,KAAKyC,EAAO/C,iBAAiB,MAAQ3G,EAAK/E,MAAQ,iBACnD4G,OAAO,SAAU0F,GACd,OAAOA,IAAOmG,GAAgBnG,IAAOqG,GAAgBrG,IAAOsG,IAE/D5L,QAAQ,SAAUsF,GACfA,EAAGrE,UAAU8C,OACTjM,GAAGK,OAAOgJ,QAAQ6E,QAClBlO,GAAGK,OAAOgJ,QAAQiH,SAClBtQ,GAAGK,OAAOgJ,QAAQ0J,SAClB/S,GAAGK,OAAOgJ,QAAQ2J,aAE9BrD,EAAO/C,iBAAiB,IAAM3G,EAAK/E,MAAQ,qCAAqCgH,QAAQ,SAAUmI,GAC9FA,EAAM4C,aAAa,QAAShN,EAAKoE,gBAAgB,wBAIzDnI,EAAS0P,SAAW,WAChB,MACMjC,EADO7O,KACOyK,mBACpB,IAAIwI,EAAM,EAEVpE,EAAO/C,iBAAiB,SAAS1E,QAAQ,SAAU8L,GAAYA,EAASC,SAAU,IAClFtE,EAAO/C,iBAAiB,6BAA6B1E,QAAQ,SAAU8E,GACnE+G,EAAMG,KAAKH,IAAIA,EAAK/G,EAAImH,WAAanH,EAAIoH,eAIzCL,IACApE,EAAO2B,MAAM1G,MAAQmJ,EAAM,GAAK,MAEpCpE,EAAO/C,iBAAiB,SAAS1E,QAAQ,SAAU8L,GAAYA,EAASC,SAAU,KAGtF/R,EAASoJ,WAAa,WACLxK,KACRyK,mBAAmB+F,MAAM+C,eAAe,UAGjDnS,EAAS0L,WAAa,SAAU+E,EAAYC,EAAUC,GAElD,IAAI3M,EACJ,MAAMzE,EAFOX,KAEKW,KACdA,GAAQA,EAAKmG,WACb1B,EAASzE,EAAKmG,SAAS+K,MAEnBzM,EAASA,EAAOqI,OAAOqE,MAEnB1M,EAASA,EAAOwI,SAASmE,IAIrC,OAAO3M,GAGXhE,EAASgR,gBAAkB,SAAUP,EAAYC,EAAUC,GAEvD,IAAI3M,GAAU,EACd,MAAMzE,EAFOX,KAEKW,KAClB,GAAIA,EACA,IAAK,IAAIuM,EAAI,EAAGA,GAAK2E,EAAY3E,IAG7B,IAFA,IAAItF,EAAUjH,EAAKmG,SAASoG,GACxBsG,EAAOtG,IAAM2E,EAAaC,EAAWlK,EAAQ6F,OAAO5G,OAAS,EACxD0G,EAAI,EAAGA,GAAKiG,EAAMjG,IAGvB,IAFA,IAAItG,EAAQW,EAAQ6F,OAAOF,GACvBkG,EAAOlG,IAAMuE,EAAWC,EAAa9K,EAAM2G,SAAS/G,OAAS,EACxD6G,EAAI,EAAGA,GAAK+F,EAAM/F,IACvBtI,GAAkB,EAKlC,OAAOA,GAGXhE,EAASsS,cAAgB,SAAU9N,GAC/B,IAAIT,EAAOnF,KACXmF,EAAKgB,UAAW,EAChBhB,EAAKD,IAAI6D,QAAQ7J,GAAGK,OAAOC,MAAMmU,kBAAmB,CAChDC,GAAIhO,EAAQgO,GACZzU,QAASgG,IAEbA,EAAK8C,eACL,GAAI9C,EAAKD,KAAOC,EAAK5E,aAAc,CAC/B4E,EAAKpE,iBAAmB,KAEnBoE,EAAKS,QAAQK,sBACdd,EAAK5E,aAAaqN,SAAS5F,QAAQZ,QAAQrF,GAAKoD,EAAKe,gBAAgBnE,IAEzEoD,EAAKxE,KAAO,OAIpBS,EAASyS,SAAW,WACL7T,KACF8T,MADE9T,KAEF8T,KAAKD,WAEd3U,GAAG6U,QAAQ1S,UAAUwS,SAASxO,KAJnBrF,OAOfoB,EAAS4S,WAAa,SAAUC,GAC5B,IAAI9O,EAAOnF,KACPmF,EAAKtE,OAASsE,EAAKtE,MAAM0K,aACzBpG,EAAKtE,MAAMsN,OAEf,IAAKhJ,EAAKS,QAAQK,qBAAsB,CACpCd,EAAK5E,aAAaqN,SAAS5F,QAAQZ,QAAQrF,GAAKoD,EAAKe,gBAAgBnE,IACrEoD,EAAKxE,KAAO,KACZwE,EAAKvE,aAAe,GAExBuE,EAAK3E,aAAe2E,EAAK3E,YAAY0T,gBACrC/O,EAAKzE,cAAgB,KACjByE,EAAK2O,MACL3O,EAAK2O,KAAKE,aAEd9U,GAAG6U,QAAQ1S,UAAU2S,WAAW3O,KAAKF,EAAM8O,IAG/C7S,EAAS+S,YAAc,WACnB,MAAMhP,EAAOnF,KACb,OAAImF,EAAKnE,cAAgBmE,EAAK5E,aACnB,CACHgS,GAAIpN,EAAKoN,GACTtL,MAAO9B,EAAK5E,aAAa4T,eAG1B,MAGX/S,EAASgT,YAAc,SAAUC,GAC7B,MAAMlP,EAAOnF,KACbmF,EAAK1E,eAAe0J,KAAK,WACrBhF,EAAK5E,aAAa6T,YAAYC,EAAMpN,UAI5C7F,EAASkE,cAAgB,WACrB,MAAMH,EAAOnF,KAEb,IAAIO,EAYAC,EAVAD,EADA4E,EAAKS,QAAQrF,aACE4E,EAAKS,QAAQrF,aAEb,CACXgS,GAAIpN,EAAKmP,SACTzG,MAAO1I,EAAK/E,MAAQ,kBACpB0E,KAAM5F,GAAGK,OAAO2H,UAAUqN,OAC1BC,MAAOrP,EACPsP,SAAS,GAIjB,GAAItP,EAAKS,QAAQpF,YACbA,EAAc2E,EAAKS,QAAQpF,gBAE1B,CACD,MAAMkU,EAAS,GACXvP,EAAKwP,eAAiBzV,GAAGK,OAAOqV,KAAKC,WACrCH,EAAOI,KAAO3P,EAAKqL,OAEnBrL,EAAKwP,eAAiBzV,GAAGK,OAAOqV,KAAKG,UACrCL,EAAOM,QAAU7P,EAAKqL,OAG1BhQ,EAAc,CACV+R,GAAIpN,EAAKmP,SACTzG,MAAO1I,EAAK/E,MAAQ,iBACpBoU,MAAOrP,EACPsP,SAAS,EACT3P,KAAM5F,GAAGK,OAAO2H,UAAUqN,OAC1BG,OAAQA,GAIhB,MAAMxP,EAAMC,EAAKD,IACjBC,EAAK1E,eAAiB,IAAIiI,QAAQ,SAAUC,EAASsM,GACjD/P,EAAIK,OAAO,WACPmD,QAAQwM,IAAI,CAAChQ,EAAIiQ,SAAS5U,GAAe2E,EAAIiQ,SAAS3U,KAAe2J,KAAK,SAAUsD,GAChFtI,EAAK5E,aAAekN,EAAO,GAC3BtI,EAAK3E,YAAciN,EAAO,GAC1B9E,UAKZ,OAAOxD,EAAK1E,gBAGhBW,EAASoF,iBAAmB,SAAU+H,GAClC,MAAMpJ,EAAOnF,KAEPoV,EAAmBjQ,EAAK2F,cAAc,CAAE3L,QAASoP,IAGvDrP,GAAGyM,QACEzM,GAAGC,QAAQyM,MACZ,CAAC1M,GAAGI,YAAc,oBAClB,WAEI,IAAK8V,EAAiBtJ,iBAAiB,IAAM5M,GAAGC,QAAQyM,MAAMvK,UAAUjB,MAAQ,QAAQyG,OAAQ,CAC5F,IAAIwO,EAAalQ,EAAKoE,gBAAgB,WACtC,GAAIgF,IAAQpJ,EAAKY,oBACb,GAAI7G,GAAGkH,QAAQkP,OAASnQ,EAAKzE,yBAAyBxB,GAAGkH,QAAQkP,MAAO,CACpE,MAAMV,EAAOzP,EAAKzE,cAAc8R,SAChC6C,EAAalQ,EAAKoE,gBAAgB,aAAc,CAC5CgM,IAAKpQ,EAAKD,IAAIqQ,IACdtT,EAAG/C,GAAG+J,KAAKuM,YAAYZ,EAAK,GAAIzP,EAAKD,IAAI4O,KAAK2B,QAAUvW,GAAGK,OAAOmW,iBAAmBxW,GAAGK,OAAOoW,iBAC/FC,EAAG1W,GAAG+J,KAAKuM,YAAYZ,EAAK,GAAIzP,EAAKD,IAAI4O,KAAK2B,QAAUvW,GAAGK,OAAOmW,iBAAmBxW,GAAGK,OAAOoW,wBAInGN,EAAalQ,EAAKoE,gBAAgB,4BAGjCgF,EAAIjI,iBACT+O,EAAa9G,EAAIjI,eAAeiM,KAIhCpN,EAAKpE,kBAAqBwN,EAAIjI,iBAAoD,IAAlCiI,EAAIjI,eAAemM,aACnE,IAAIvT,GAAGC,QAAQyM,MAAM,CACjBiD,OAAQuG,EACRS,iBAAkB1Q,EAAKsF,iBAAiB,CAAEtL,QAASoP,IACnDV,MAAOwH,QAQ/BjU,EAAS0H,qBAAuB,WAC5B,MAAM3D,EAAOnF,KACP8V,EAAkB,MAAQ3Q,EAAKoE,gBAAgB,WAC/CwM,EAAgB,MAAQ5Q,EAAKoE,gBAAgB,SAE/CpE,EAAKxE,MAAQwE,EAAKxE,KAAKmG,UACvB3B,EAAKxE,KAAKmG,SAASM,QAAQ,SAAUQ,GACjCA,EAAQ6F,OAAOrG,QAAQ,SAAUH,GAC7BA,EAAM2G,SAASxG,QAAQ,SAAUhB,GAC7B,GAAIA,aAAmBlH,GAAGwS,QAAS,CAC/B,MAAMxD,EAAO/I,EAAKkI,eAAejH,GACjC,GAAI8H,EAAM,CACN,MAAM8H,EAAU,GAChBA,EAAQF,GAAmB5H,EAAKtG,QAC5BsG,EAAKjH,QACL+O,EAAQD,GAAiB7H,EAAKjH,MAAMgP,KAAK9Q,EAAK7D,kBAElD,MAAM4U,EAAUhX,GAAG+J,KAAKC,OAAO8M,EAAS5P,EAAQ+P,WAChD/P,EAAQgQ,YACRhQ,EAAQiQ,QAAQH,YA33BhD","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.Click) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/Click');\r\n}\r\n\r\nTC.Consts.event.POPUP = TC.Consts.event.POPUP || 'popup.tc';\r\nTC.Consts.event.POPUPHIDE = TC.Consts.event.POPUPHIDE || 'popuphide.tc';\r\nTC.Consts.event.DRAWCHART = TC.Consts.event.DRAWCHART || 'drawchart.tc';\r\nTC.Consts.event.DRAWTABLE = TC.Consts.event.DRAWTABLE || 'drawtable.tc';\r\nTC.Consts.event.RESULTSPANELCLOSE = TC.Consts.event.RESULTSPANELCLOSE || 'resultspanelclose.tc';\r\n\r\nTC.control.FeatureInfoCommons = function () {\r\n    const self = this;\r\n    TC.control.Click.apply(self, arguments);\r\n\r\n    const cs = self._classSelector = '.' + self.CLASS;\r\n    self._selectors = {\r\n        LIST_ITEM: 'ul' + cs + '-features li'\r\n    };\r\n\r\n    self.resultsLayer = null;\r\n    self.filterLayer = null;\r\n    self._layersPromise = null;\r\n    self.filterFeature = null;\r\n    self.info = null;\r\n    self._infoHistory = {};\r\n    self.popup = null;\r\n    self.resultsPanel = null;\r\n    self.lastFeatureCount = null;\r\n    self.exportsState = true;\r\n};\r\n\r\nTC.control.FeatureInfoCommons.displayMode = {\r\n    POPUP: 'popup',\r\n    RESULTS_PANEL: 'resultsPanel'\r\n};\r\n\r\n(function () {\r\n\r\n    var layerCount = function (ctl) {\r\n        return ctl.info && ctl.info.services ?\r\n            ctl.info.services.reduce(function (sCount, service) {\r\n                return sCount + service.layers.reduce(function (lCount, layer) {\r\n                    return lCount + 1;\r\n                }, 0);\r\n            }, 0) : 0;\r\n    };\r\n\r\n    TC.inherit(TC.control.FeatureInfoCommons, TC.control.Click);\r\n\r\n    var ctlProto = TC.control.FeatureInfoCommons.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-finfo';\r\n\r\n    ctlProto.TITLE_SEPARATOR = ' • ';\r\n    ctlProto.DEFAULT_STROKE_COLOR = '#0000ff';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/FeatureInfo.html\";\r\n    ctlProto.template[ctlProto.CLASS + \"-object\"] = TC.apiLocation + \"TC/templates/FeatureInfoObject.html\";\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        const result = TC.control.Click.prototype.register.call(self, map);\r\n\r\n        self._createLayers();\r\n\r\n        map.loaded(function () {\r\n            const shareCtl = map.getControlsByClass('TC.control.Share')[0];\r\n            if (shareCtl) {\r\n                self.loadSharedFeature(shareCtl.loadParamFeature());\r\n            }\r\n        });\r\n\r\n        self.displayMode = self.options.displayMode || TC.control.FeatureInfoCommons.displayMode.POPUP;\r\n        self.setDisplayMode(self.displayMode);\r\n\r\n        map\r\n            .on(TC.Consts.event.POPUPHIDE + ' ' + TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                if (e.control === self.getDisplayControl() && self.resultsLayer) {\r\n                    if (self.highlightedFeature && !self.options.persistentHighlights) {\r\n                        self.downplayFeature(self.highlightedFeature);\r\n                        self.highlightedFeature = null;\r\n                    }\r\n                    if (!self.querying && e.feature) {\r\n                        self.filterLayer.removeFeature(e.feature);\r\n                    }\r\n                }\r\n            })\r\n            .on(TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                self.highlightedFeature = null;\r\n            })\r\n            .on(TC.Consts.event.POPUP + ' ' + TC.Consts.event.DRAWTABLE + ' ' + TC.Consts.event.DRAWCHART, function (e) {\r\n                const control = e.control;\r\n                if (control.currentFeature !== self.filterFeature) {\r\n                    self.highlightedFeature = control.currentFeature;\r\n                }\r\n\r\n                // GLS: si la feature es resultado de GFI decoramos\r\n                if (e.control.caller == self) {\r\n                    self._decorateDisplay(control);\r\n                }\r\n\r\n            })\r\n            .on(TC.Consts.event.DRAWCHART, function (e) {\r\n                setTimeout(function () {\r\n                    self.highlightedFeature = e.control.currentFeature;\r\n                }, 50);\r\n            })\r\n            .on(TC.Consts.event.LAYERREMOVE, function () {\r\n                if (Object.keys(self._infoHistory).length) {\r\n                    const services = {};\r\n                    self.map.workLayers\r\n                        .filter(function (layer) {\r\n                            return layer.type === TC.Consts.layerType.WMS;\r\n                        })\r\n                        .forEach(function (layer) {\r\n                            const names = services[layer.url] || [];\r\n                            services[layer.url] = names.concat(layer.getDisgregatedLayerNames())\r\n                        });\r\n                    let featuresDeleted = false;\r\n                    for (let url in self._infoHistory) {\r\n                        const historyService = self._infoHistory[url];\r\n                        if (services.hasOwnProperty(url)) {\r\n                            const service = services[url];\r\n                            for (let name in historyService) {\r\n                                const historyLayer = historyService[name];\r\n                                if (service.indexOf(name) < 0) {\r\n                                    historyLayer.slice().forEach(f => self.downplayFeature(f));\r\n                                    historyLayer.length = 0;\r\n                                    featuresDeleted = true;\r\n                                }\r\n                            }\r\n                        }\r\n                        else {\r\n                            for (let name in historyService) {\r\n                                const historyLayer = historyService[name];\r\n                                historyLayer.slice().forEach(f => self.downplayFeature(f));\r\n                                featuresDeleted = true;\r\n                            }\r\n                            delete self._infoHistory[url];\r\n                        }\r\n                    }\r\n                    if (featuresDeleted) {\r\n                        self.closeResults();\r\n                    }\r\n                }\r\n            })\r\n            .on(TC.Consts.event.VIEWCHANGE, function (e) {\r\n                self.closeResults();\r\n            });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.render = function () {\r\n        const self = this;\r\n        // Este div se usa como buffer, así que no debe ser visible.\r\n        self.div.classList.add(TC.Consts.classes.HIDDEN);\r\n        return self._set1stRenderPromise(Promise.resolve());\r\n    };\r\n\r\n    ctlProto.responseCallback = function (options) {\r\n        const self = this;\r\n        self.querying = false;\r\n\r\n        if (self.filterFeature) {\r\n            self.info = { services: options.services };\r\n        }\r\n\r\n        if (!options.featureCount) {\r\n            self.lastFeatureCount = 0;\r\n            self.map.trigger(TC.Consts.event.NOFEATUREINFO, { control: self });\r\n        }\r\n        else {\r\n            self._addSourceAttributes();\r\n            self.lastFeatureCount = options.featureCount;\r\n            self.map.trigger(TC.Consts.event.FEATUREINFO, TC.Util.extend({ control: self }, options));\r\n        }\r\n    };\r\n\r\n    ctlProto.responseError = function (options) {\r\n        const self = this;\r\n        if (options.status === 404) {\r\n            self.map.toast(self.getLocaleString(\"featureInfo.tooManyLayers\"), { type: TC.Consts.msgType.ERROR });\r\n        }\r\n        self.responseCallback({});\r\n    };\r\n\r\n    ctlProto.markerStyle = {\r\n        cssClass: TC.Consts.classes.POINT,\r\n        anchor: [0.5, 0.5],\r\n        width: 15,\r\n        height: 15,\r\n        noPrint: true\r\n    };\r\n\r\n    ctlProto.setDisplayMode = function (mode) {\r\n        var self = this;\r\n        self.displayMode = mode;\r\n        var map = self.map;\r\n        switch (mode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                if (!self.resultsPanel) {\r\n                    map.addControl('resultsPanel')\r\n                        .then(function (rp) {\r\n                            self.resultsPanel = rp;\r\n                            rp.caller = self;\r\n                        });\r\n                }\r\n                break;\r\n            default:\r\n                self.displayMode = TC.control.FeatureInfoCommons.displayMode.POPUP;\r\n                if (!self.popup) {\r\n                    map.addControl('popup', {\r\n                        closeButton: true,\r\n                        draggable: self.options.draggable\r\n                    }).then(function (popup) {\r\n                        self.popup = popup;\r\n                        popup.caller = self;\r\n                        map.on(TC.Consts.event.POPUP, function (e) {\r\n                            self.onShowPopup(e);\r\n                        });\r\n\r\n                        map.on(TC.Consts.event.POPUPHIDE, function (e) {\r\n                            if (e.control === popup) {\r\n                                //restaurar el ancho automático\r\n                                self._resetSize();\r\n                            }\r\n                        });\r\n                    });\r\n                }\r\n                break;\r\n        }\r\n    };\r\n\r\n    ctlProto.getDisplayControl = function () {\r\n        var self = this;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                return self.resultsPanel;\r\n            default:\r\n                return self.popup;\r\n        }\r\n    };\r\n\r\n    ctlProto.getDisplayTarget = function (options) {\r\n        var self = this;\r\n        options = options || {};\r\n        if (options.control) {\r\n            switch (true) {\r\n                case TC.control.Popup && options.control instanceof TC.control.Popup:\r\n                    return options.control.getContainerElement();\r\n                case TC.control.ResultsPanel && options.control instanceof TC.control.ResultsPanel:\r\n                    return options.control.getInfoContainer();\r\n                default:\r\n                    return null;\r\n            }\r\n        }\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                return self.resultsPanel.getInfoContainer();\r\n            default:\r\n                return self.popup.getContainerElement();\r\n        }\r\n    };\r\n\r\n    ctlProto.getMenuTarget = function () {\r\n        var self = this;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                return self.resultsPanel.getMenuElement();\r\n            default:\r\n                return self.popup.getMenuElement();\r\n        }\r\n    };\r\n\r\n    ctlProto.displayResults = function () {\r\n        var self = this;\r\n        const clone = self.div.cloneNode(true);\r\n        clone.classList.remove(TC.Consts.classes.HIDDEN);\r\n        self.filterFeature.data = clone.outerHTML;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                if (self.resultsPanel) {\r\n                    // GLS: si contamos con el control de controles no es necesario cerrar los paneles visibles ya que no habría solape\r\n                    if (self.map.getControlsByClass(TC.control.ControlContainer).length === 0) {\r\n                        self.map.getControlsByClass(TC.control.ResultsPanel).forEach(function (p) {\r\n                            if (p.isVisible()) {\r\n                                p.close();\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    // cerramos los paneles con feature asociada\r\n                    const panels = self.map.getControlsByClass('TC.control.ResultsPanel');\r\n                    panels.forEach(function (p) {\r\n                        if (p !== self.resultsPanel && p.currentFeature && !p.chart) {\r\n                            p.close();\r\n                        }\r\n                    });\r\n\r\n                    self.resultsPanel.currentFeature = self.filterFeature;\r\n                    self.resultsPanel.open(self.filterFeature.data, self.resultsPanel.getInfoContainer());\r\n                    \r\n                    TC.loadJS(\r\n                        !TC.control.Print,\r\n                        [TC.apiLocation + 'TC/control/Print'],\r\n                        function () {\r\n                            // Eliminamos la impresora porque al pintar los resultados ya se añadirá\r\n                            const printBtn = self.getMenuTarget().querySelectorAll('.' + TC.control.Print.prototype.CLASS + '-btn');\r\n                            if (printBtn.length > 0) {\r\n                                printBtn[0].remove();\r\n                            }\r\n\r\n                            self.displayResultsCallback();\r\n                        });\r\n                }\r\n\r\n                break;\r\n            default:\r\n                if (self.popup) {\r\n                    self.filterFeature.showPopup(self.popup);\r\n                }\r\n                break;\r\n        }\r\n    };\r\n\r\n    const getElementIndex = function (elm) {\r\n        return Array.from(elm.parentElement.children).indexOf(elm);\r\n    };\r\n\r\n    const getParentElement = function (elm, tagName) {\r\n        var result = elm;\r\n        do {\r\n            result = result.parentElement;\r\n        }\r\n        while (result && result.tagName !== tagName);\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getFeatureElement = function (feature) {\r\n        const self = this;\r\n        var result;\r\n        const getIndex = function (elm) {\r\n            return Array.from(elm.parentElement.childNodes).getIndex(elm);\r\n        };\r\n        self.getDisplayTarget().querySelectorAll(self._selectors.LIST_ITEM).forEach(function (li) {\r\n            const currentFeatureLi = li;\r\n            const currentLayerLi = getParentElement(li, 'LI');\r\n            const currentServiceLi = getParentElement(currentLayerLi, 'LI');\r\n            var feat = self.getFeature(getElementIndex(currentServiceLi), getElementIndex(currentLayerLi), getElementIndex(currentFeatureLi));\r\n            if (feat === feature) {\r\n                result = currentFeatureLi;\r\n            }\r\n        });\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getNextFeatureElement = function (delta) {\r\n        const self = this;\r\n        const lis = self.getDisplayTarget().querySelectorAll('ul.' + self.CLASS + '-features > li');\r\n        const length = lis.length;\r\n        for (var i = 0; i < length; i++) {\r\n            if (lis[i].matches('.' + TC.Consts.classes.CHECKED)) {\r\n                return lis[(i + delta + length) % length]\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.getFeaturePath = function (feature) {\r\n        const self = this;\r\n        if (self.info && self.info.services) {\r\n            for (var i = 0, ii = self.info.services.length; i < ii; i++) {\r\n                const service = self.info.services[i];\r\n                for (var j = 0, jj = service.layers.length; j < jj; j++) {\r\n                    const layer = service.layers[j];\r\n                    for (var k = 0, kk = layer.features.length; k < kk; k++) {\r\n                        if (layer.features[k] === feature) {\r\n                            return {\r\n                                service: service.title || service.mapLayers.reduce(function (prev, cur) {\r\n                                    return prev || cur.title;\r\n                                }, ''),\r\n                                layer: layer.path\r\n                            };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.closeResults = function () {\r\n        var self = this;\r\n        switch (self.displayMode) {\r\n            case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:\r\n                if (self.resultsPanel && self.resultsPanel.isVisible()) {\r\n                    self.resultsPanel.close();\r\n                }\r\n                break;\r\n            default:\r\n                if (self.popup && self.popup.isVisible()) {\r\n                    self.popup.hide();\r\n                }\r\n                break;\r\n        }\r\n    };\r\n\r\n    ctlProto.displayResultsCallback = function () {\r\n        var self = this;\r\n        const content = self.getDisplayTarget().querySelector('.' + self.CLASS);\r\n\r\n        var selector;\r\n        // Evento para resaltar una feature\r\n        var eventType = 'click'; // En iPad se usa click en vez de touchstart para evitar que se resalte una feature al hacer scroll\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(self._selectors.LIST_ITEM, function (e) {\r\n            self.highlightFeature(e.target);\r\n        }));\r\n\r\n        // Evento para ir a la siguiente feature\r\n        eventType = TC.Consts.event.CLICK;\r\n        selector = '.' + self.CLASS + '-btn-next';\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            self.highlightFeature(self.getNextFeatureElement(1), 1);\r\n            return false;\r\n        }));\r\n\r\n        // Evento para ir a la feature anterior\r\n        selector = '.' + self.CLASS + '-btn-prev';\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            self.highlightFeature(self.getNextFeatureElement(-1), -1);\r\n            return false;\r\n        }));\r\n\r\n        // Evento para desplegar/replegar features de capa\r\n        selector = 'ul.' + self.CLASS + '-layers h4';\r\n\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            const li = getParentElement(e.target, 'LI');\r\n            if (li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                // Si no está en modo móvil ocultamos la capa (si hay más de una)\r\n                const anotherLayer = content.querySelector('.tc-ctl-finfo-layers li:not(.tc-checked)');\r\n                if (anotherLayer && getComputedStyle(anotherLayer).display !== 'none') {\r\n                    self.downplayFeatures();\r\n                }\r\n            }\r\n            else {\r\n                self.highlightFeature(li.querySelector(self._selectors.LIST_ITEM));\r\n                if (self.displayMode === TC.control.FeatureInfoCommons.displayMode.POPUP) {\r\n                    self.popup.fitToView(true);\r\n                }\r\n            }\r\n        }));\r\n\r\n        // Evento para borrar la feature resaltada\r\n        selector = '.' + self.CLASS + '-del-btn';\r\n        content.addEventListener(eventType, TC.EventTarget.listenerBySelector(selector, function (e) {\r\n            self.downplayFeatures();\r\n            self.closeResults();\r\n        }));\r\n\r\n        if (self.info) {\r\n            if (self.info.defaultFeature && self.getFeatureElement(self.info.defaultFeature)) {\r\n                self.getFeatureElement(self.info.defaultFeature).classList.add(TC.Consts.classes.DEFAULT);\r\n                self.highlightFeature(self.info.defaultFeature);\r\n            }\r\n            else if (content.querySelector(self._selectors.LIST_ITEM)) {\r\n                self.highlightFeature(content.querySelector(self._selectors.LIST_ITEM));\r\n            }\r\n        }\r\n\r\n        content.querySelectorAll('table:not(.complexAttr)').forEach(function (table) {\r\n            table.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                const li = this.parentElement;\r\n                if (li.classList.contains(TC.Consts.classes.DISABLED)) {\r\n                    return;\r\n                }\r\n                if (li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                    // Si ya está seleccionada hacemos zoom\r\n                    if (self.resultsLayer.features[0] && window.getSelection() && window.getSelection().toString().trim().length === 0) {\r\n                        // Proceso para desactivar highlightFeature mientras hacemos zoom\r\n                        var zoomHandler = function zoomHandler() {\r\n                            self._zooming = false;\r\n                            self.map.off(TC.Consts.event.ZOOM, zoomHandler);\r\n                        };\r\n                        self.map.on(TC.Consts.event.ZOOM, zoomHandler);\r\n                        self._zooming = true;\r\n                        ///////\r\n\r\n                        self.map.zoomToFeatures([self.resultsLayer.features[0]], { animate: true });\r\n                    }\r\n                }\r\n                else {\r\n                    // Si no está seleccionada la seleccionamos\r\n                    self.highlightFeature(li);\r\n                }\r\n                e.stopPropagation();\r\n            });\r\n        });\r\n        content.querySelectorAll('table a, table label, table input').forEach(function (a) {\r\n            a.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                e.stopPropagation();\r\n            });\r\n        });\r\n\r\n        if (TC.browserFeatures.touch() && self.displayMode === TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL) {\r\n            const prevBtn = content.querySelector('.' + self.CLASS + '-btn-prev');\r\n            if (!prevBtn || prevBtn.style.display !== 'none') { // Si los botones de anterior/siguiente están visibles, montamos el swipe\r\n                if (self.resultsPanel) {\r\n                    TC.Util.swipe(self.resultsPanel.div, 'disable');\r\n                }\r\n\r\n                if (layerCount(self) > 1) {\r\n                    TC.Util.swipe(content, {\r\n                        left: function () {\r\n                            self.highlightFeature(self.getNextFeatureElement(1), 1);\r\n                        },\r\n                        right: function () {\r\n                            self.highlightFeature(self.getNextFeatureElement(-1), -1);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.onShowPopup = function (e) {\r\n        const self = this;\r\n        if (e.control === self.popup) {\r\n\r\n            self.displayResultsCallback();\r\n\r\n            //ajustar el ancho para que no sobre a la derecha\r\n            self._fitSize();\r\n        }\r\n    };\r\n\r\n    ctlProto.loadSharedFeature = function (featureObj) {\r\n\r\n    };\r\n\r\n    ctlProto.insertLinks = function () {\r\n        var self = this;\r\n        const linkText = self.getLocaleString('open');\r\n        const titleText = self.getLocaleString('linkInNewWindow');\r\n        self.div.querySelectorAll('td.' + self.CLASS + '-val').forEach(function (td) {\r\n            const text = td.textContent;\r\n            if (TC.Util.isURL(text)) {\r\n                td.innerHTML = '<a href=\"' + text + '\" target=\"_blank\" title=\"' + titleText + '\">' + linkText + '</a>';\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.highlightFeature = function (featureOrElement, delta) {\r\n        const self = this;\r\n        var feature;\r\n        if (!self._zooming) {\r\n            var featureLi;\r\n            // this puede ser o el elemento HTML de la lista correspondiente a la feature o la feature en sí\r\n            if (featureOrElement instanceof TC.Feature) {\r\n                feature = featureOrElement;\r\n                featureLi = self.getFeatureElement(feature);\r\n            }\r\n            else {\r\n                featureLi = featureOrElement;\r\n                while (featureLi && featureLi.tagName !== 'LI') {\r\n                    featureLi = featureLi.parentElement;\r\n                }\r\n            }\r\n            const layerLi = getParentElement(featureLi, 'LI');\r\n            const serviceLi = getParentElement(layerLi, 'LI');\r\n\r\n            const serviceIdx = getElementIndex(serviceLi);\r\n            const layerIdx = getElementIndex(layerLi);\r\n            const featureIdx = getElementIndex(featureLi);\r\n            feature = feature || self.getFeature(serviceIdx, layerIdx, featureIdx);\r\n\r\n            self.downplayFeatures({ exception: feature });\r\n\r\n            // Añadimos feature al historial de features resaltadas\r\n            const service = self.info.services[serviceIdx];\r\n            if (!self._infoHistory.hasOwnProperty(service.url)) {\r\n                self._infoHistory[service.url] = {};\r\n            }\r\n            const historyService = self._infoHistory[service.url];\r\n            const layer = service.layers[layerIdx];\r\n            const historyLayer = historyService[layer.name] || [];\r\n            historyService[layer.name] = historyLayer.concat(feature);\r\n\r\n            featureLi.classList.add(TC.Consts.classes.CHECKED);\r\n            layerLi.classList.add(TC.Consts.classes.CHECKED);\r\n            serviceLi.classList.add(TC.Consts.classes.CHECKED);\r\n            if (delta > 0) {\r\n                featureLi.classList.add(TC.Consts.classes.FROMLEFT);\r\n                layerLi.classList.add(TC.Consts.classes.FROMLEFT);\r\n                serviceLi.classList.add(TC.Consts.classes.FROMLEFT);\r\n            }\r\n            else if (delta < 0) {\r\n                featureLi.classList.add(TC.Consts.classes.FROMRIGHT);\r\n                layerLi.classList.add(TC.Consts.classes.FROMRIGHT);\r\n                serviceLi.classList.add(TC.Consts.classes.FROMRIGHT);\r\n            }\r\n\r\n            if (featureLi.querySelector('table')) {\r\n                featureLi.querySelector('table').setAttribute('title', self.getLocaleString('clickToCenter'));\r\n            }\r\n\r\n            self.highlightedFeature = feature;\r\n\r\n            if (self.getDisplayTarget().querySelector('.' + self.CLASS + '-counter-current')) {\r\n                self.getDisplayTarget().querySelector('.' + self.CLASS + '-counter-current').innerHTML = self.getFeatureIndex(serviceIdx, layerIdx, featureIdx) + 1;\r\n            }\r\n\r\n\r\n            var features = self.resultsLayer.features.slice();\r\n            var featureAlreadyHighlighted = features.filter(function (item) {\r\n                return feature && feature.id === item.id;\r\n            });\r\n\r\n            //Si la feature a resaltar ya está resaltada, no hacemos nada. Así evitamos parpadeo\r\n            if (featureAlreadyHighlighted.length > 0) {\r\n                self.highlightedFeature = featureAlreadyHighlighted[0]; // Asignamos la original, la seleccionada inicialmente es un clon\r\n                return;\r\n            }\r\n\r\n            if (!self.options.persistentHighlights) {\r\n                features.forEach(f => {\r\n                    if (f !== self.filterFeature) {\r\n                        self.downplayFeature(f);\r\n                    }\r\n                });\r\n            }\r\n            if (feature && feature.geometry) {\r\n                feature.showsPopup = self.options.persistentHighlights;\r\n                self.resultsLayer.addFeature(feature);\r\n            }\r\n            else {\r\n                featureLi.classList.add(TC.Consts.classes.DISABLED);\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.downplayFeature = function (feature) {\r\n        const self = this;\r\n        self.resultsLayer.removeFeature(feature);\r\n        for (url in self._infoHistory) {\r\n            const service = self._infoHistory[url];\r\n            for (name in service) {\r\n                const layer = service[name];\r\n                const idx = layer.indexOf(feature);\r\n                if (idx >= 0) {\r\n                    layer.splice(idx, 1);\r\n                    if (!layer.length) {\r\n                        delete service[name];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.downplayFeatures = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        if (self.highlightedFeature && self.highlightedFeature !== options.exception) {\r\n            self.downplayFeature(self.highlightedFeature);\r\n            self.highlightedFeature = null;\r\n        }\r\n        const exceptionFLi = options.exception ? self.getFeatureElement(options.exception) : undefined;\r\n        var exceptionLLi, exceptionSLi;\r\n        if (exceptionFLi) {\r\n            exceptionLLi = getParentElement(exceptionFLi, 'LI');\r\n            exceptionSLi = getParentElement(exceptionLLi, 'LI');\r\n        }\r\n\r\n        const target = self.getDisplayTarget();\r\n        Array.from(target.querySelectorAll('ul.' + self.CLASS + '-services li'))\r\n            .filter(function (li) {\r\n                return li !== exceptionFLi && li !== exceptionLLi && li !== exceptionSLi;\r\n            })\r\n            .forEach(function (li) {\r\n                li.classList.remove(\r\n                    TC.Consts.classes.CHECKED,\r\n                    TC.Consts.classes.DISABLED,\r\n                    TC.Consts.classes.FROMLEFT,\r\n                    TC.Consts.classes.FROMRIGHT);\r\n            });\r\n        target.querySelectorAll('.' + self.CLASS + '-features table:not(.complexAttr)').forEach(function (table) {\r\n            table.setAttribute('title', self.getLocaleString('clickToShowOnMap'));\r\n        });\r\n    };\r\n\r\n    ctlProto._fitSize = function () {\r\n        const self = this;\r\n        const target = self.getDisplayTarget();\r\n        var max = 0;\r\n        //medir la máxima anchura de <ul>\r\n        target.querySelectorAll(\"input\").forEach(function (checkbox) { checkbox.checked = true })\r\n        target.querySelectorAll(\".tc-ctl-finfo-features li\").forEach(function (elm) {\r\n            max = Math.max(max, elm.offsetLeft + elm.offsetWidth);\r\n        });\r\n\r\n        //alert(\"max=\" + max);\r\n        if (max) {\r\n            target.style.width = max + 50 + 'px';\r\n        }\r\n        target.querySelectorAll(\"input\").forEach(function (checkbox) { checkbox.checked = false })\r\n    };\r\n\r\n    ctlProto._resetSize = function () {\r\n        const self = this;\r\n        self.getDisplayTarget().style.removeProperty('width');\r\n    };\r\n\r\n    ctlProto.getFeature = function (serviceIdx, layerIdx, featureIdx) {\r\n        const self = this;\r\n        var result;\r\n        const info = self.info;\r\n        if (info && info.services) {\r\n            result = info.services[serviceIdx];\r\n            if (result) {\r\n                result = result.layers[layerIdx];\r\n                if (result) {\r\n                    result = result.features[featureIdx];\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getFeatureIndex = function (serviceIdx, layerIdx, featureIdx) {\r\n        const self = this;\r\n        var result = -1;\r\n        const info = self.info;\r\n        if (info) {\r\n            for (var i = 0; i <= serviceIdx; i++) {\r\n                var service = info.services[i];\r\n                var maxj = i === serviceIdx ? layerIdx : service.layers.length - 1;\r\n                for (var j = 0; j <= maxj; j++) {\r\n                    var layer = service.layers[j];\r\n                    var maxk = j === layerIdx ? featureIdx : layer.features.length - 1;\r\n                    for (var k = 0; k <= maxk; k++) {\r\n                        result = result + 1;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.beforeRequest = function (options) {\r\n        var self = this;\r\n        self.querying = true;\r\n        self.map.trigger(TC.Consts.event.BEFOREFEATUREINFO, {\r\n            xy: options.xy,\r\n            control: self\r\n        });\r\n        self.closeResults();\r\n        if (self.map && self.resultsLayer) {\r\n            self.lastFeatureCount = null;\r\n\r\n            if (!self.options.persistentHighlights) {\r\n                self.resultsLayer.features.slice().forEach(f => self.downplayFeature(f));\r\n            }\r\n            self.info = null;\r\n        }\r\n    };\r\n\r\n    ctlProto.activate = function () {\r\n        var self = this;\r\n        if (self.wrap) {\r\n            self.wrap.activate();\r\n        }\r\n        TC.Control.prototype.activate.call(self);\r\n    };\r\n\r\n    ctlProto.deactivate = function (stopChain) {\r\n        var self = this;\r\n        if (self.popup && self.popup.isVisible()) {\r\n            self.popup.hide();\r\n        }\r\n        if (!self.options.persistentHighlights) {\r\n            self.resultsLayer.features.slice().forEach(f => self.downplayFeature(f));\r\n            self.info = null;\r\n            self._infoHistory = {};\r\n        }\r\n        self.filterLayer && self.filterLayer.clearFeatures();\r\n        self.filterFeature = null;\r\n        if (self.wrap) {\r\n            self.wrap.deactivate();\r\n        }\r\n        TC.Control.prototype.deactivate.call(self, stopChain);\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState && self.resultsLayer) {\r\n            return {\r\n                id: self.id,\r\n                layer: self.resultsLayer.exportState()\r\n            };\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        self._layersPromise.then(function () {\r\n            self.resultsLayer.importState(state.layer);\r\n        });\r\n    };\r\n\r\n    ctlProto._createLayers = function () {\r\n        const self = this;\r\n\r\n        var resultsLayer;\r\n        if (self.options.resultsLayer) { // En caso de que se haya indicado una capa por configuración, la utilizamos\r\n            resultsLayer = self.options.resultsLayer;\r\n        } else {\r\n            resultsLayer = {\r\n                id: self.getUID(),\r\n                title: self.CLASS + ': Results layer',\r\n                type: TC.Consts.layerType.VECTOR,\r\n                owner: self,\r\n                stealth: true\r\n            };\r\n        }\r\n        var filterLayer;\r\n        if (self.options.filterLayer) {\r\n            filterLayer = self.options.filterLayer;\r\n        }\r\n        else {\r\n            const styles = {};\r\n            if (self.geometryType === TC.Consts.geom.POLYLINE) {\r\n                styles.line = self.style;\r\n            }\r\n            if (self.geometryType === TC.Consts.geom.POLYGON) {\r\n                styles.polygon = self.style;\r\n            }\r\n\r\n            filterLayer = {\r\n                id: self.getUID(),\r\n                title: self.CLASS + ': Filter layer',\r\n                owner: self,\r\n                stealth: true,\r\n                type: TC.Consts.layerType.VECTOR,\r\n                styles: styles\r\n            };\r\n        }\r\n\r\n        const map = self.map;\r\n        self._layersPromise = new Promise(function (resolve, reject) {\r\n            map.loaded(function () {\r\n                Promise.all([map.addLayer(resultsLayer), map.addLayer(filterLayer)]).then(function (layers) {\r\n                    self.resultsLayer = layers[0];\r\n                    self.filterLayer = layers[1];\r\n                    resolve();\r\n                });\r\n            });\r\n        });\r\n\r\n        return self._layersPromise;\r\n    };\r\n\r\n    ctlProto._decorateDisplay = function (ctl) {\r\n        const self = this;\r\n\r\n        const resultsContainer = self.getMenuTarget({ control: ctl });\r\n\r\n        // Añadimos botón de imprimir\r\n        TC.loadJS(\r\n            !TC.control.Print,\r\n            [TC.apiLocation + 'TC/control/Print'],\r\n            function () {\r\n\r\n                if (!resultsContainer.querySelectorAll('.' + TC.control.Print.prototype.CLASS + '-btn').length) {\r\n                    var printTitle = self.getLocaleString(\"feature\");\r\n                    if (ctl === self.getDisplayControl()) {\r\n                        if (TC.feature.Point && self.filterFeature instanceof TC.feature.Point) {\r\n                            const geom = self.filterFeature.geometry;\r\n                            printTitle = self.getLocaleString('featuresAt', {\r\n                                crs: self.map.crs,\r\n                                x: TC.Util.formatCoord(geom[0], self.map.wrap.isGeo() ? TC.Consts.DEGREE_PRECISION : TC.Consts.METER_PRECISION),\r\n                                y: TC.Util.formatCoord(geom[1], self.map.wrap.isGeo() ? TC.Consts.DEGREE_PRECISION : TC.Consts.METER_PRECISION)\r\n                            });\r\n                        }\r\n                        else {\r\n                            printTitle = self.getLocaleString('spatialQueryResults');\r\n                        }\r\n                    }\r\n                    else if (ctl.currentFeature) {\r\n                        printTitle = ctl.currentFeature.id;\r\n                    }\r\n\r\n                    // Si hay datos porque el popup es de un GFI con éxito o es de una feature resaltada damos la opción de imprimirlos\r\n                    if (self.lastFeatureCount || (ctl.currentFeature && ctl.currentFeature.showsPopup === true)) {\r\n                        new TC.control.Print({\r\n                            target: resultsContainer,\r\n                            printableElement: self.getDisplayTarget({ control: ctl }),\r\n                            title: printTitle\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        );\r\n    };\r\n\r\n    ctlProto._addSourceAttributes = function () {\r\n        const self = this;\r\n        const serviceAttrName = 'h3_' + self.getLocaleString('service');\r\n        const layerAttrName = 'h4_' + self.getLocaleString('layer');\r\n        // Añadimos como atributos los títulos de servicio y capa\r\n        if (self.info && self.info.services) {\r\n            self.info.services.forEach(function (service) {\r\n                service.layers.forEach(function (layer) {\r\n                    layer.features.forEach(function (feature) {\r\n                        if (feature instanceof TC.Feature) {\r\n                            const path = self.getFeaturePath(feature);\r\n                            if (path) {\r\n                                const newData = {};\r\n                                newData[serviceAttrName] = path.service;\r\n                                if (path.layer) {\r\n                                    newData[layerAttrName] = path.layer.join(self.TITLE_SEPARATOR);\r\n                                }\r\n                                const allData = TC.Util.extend(newData, feature.getData());\r\n                                feature.clearData();\r\n                                feature.setData(allData);\r\n                            }\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n})();\r\n"]}