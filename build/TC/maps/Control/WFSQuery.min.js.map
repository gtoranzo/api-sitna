{"version":3,"sources":["control/WFSQuery.js"],"names":["TC","control","Object","assign","defineProperty","value","target","varArgs","TypeError","to","index","arguments","length","nextSource","nextKey","prototype","hasOwnProperty","call","writable","configurable","Control","syncLoadJS","apiLocation","filter","Feature","feature","Point","Polyline","Polygon","MultiPolyline","MultiPolygon","WFSQuery","options","apply","this","styles","highlightStyles","highLightStyles","download","cs","CLASS","_selectors","ELEVATION_CHECKBOX","INTERPOLATION_RADIO","INTERPOLATION_DISTANCE","inherit","ctlProto","modalBody","modalDialog","ctlResultsPanel","resultLayer","timer","Consts","logicalOperator","AND","timerAutocomplete","controller","locale","empty","node","children","removeChild","filterByOperation","eq","equalTo","not","notEqualTo","gt","greaterThan","lt","lessThan","ge","greaterThanOrEqualTo","le","lessThanOrEqualTo","like","contains","start","end","bw","between","map","_currentLayer","_currentLayerName","_currentLayercapabilities","_currentLayerTitle","_currentLayerURL","_getStyles","_getHighLightStyles","getLocaleString","downloadDialog","type","template","dust","register","body_0","chk","ctx","w","f","get","h","$key","block","body_1","key","getPath","__dustBody","s","body_2","else","excludedKeys","body_3","on","x","array","body_6","object","p","rebase","body_4","body_5","body_7","body_8","body_12","body_9","body_10","body_11","checkInput","input","document","createElement","setAttribute","_renderQueryForm","args","layer","dialog","capabilities","Operations","DescribeFeatureType","DCP","HTTP","Get","substring","indexOf","GetFeature","CountDefault","_maxRecordCount","DefaultValue","layers","getDisgregatedLayerNames","featureType","l","FeatureTypes","classList","remove","getElementsByClassName","addEventListener","querySelector","add","classes","HIDDEN","selectedIndex","text","describeFeatureType","then","data","entries","_manageDescribeFeature","tbody","insertAdjacentHTML","form","i","_clear","Title","Util","closeModal","toast","msgType","ERROR","dateInputMask","inputMaskNumber","_createDateMask","txtBox","Promise","resolve","reject","setTimeout","loadJS","isDebug","console","log","IMask","mask","Date","pattern","lazy","format","date","day","getDate","month","getMonth","year","getFullYear","join","parse","str","split","blocks","d","MaskedRange","from","maxLength","m","Y","_destroyDateMask","el","destroy","_internalGetDataTypes","objFiltered","isGeometry","getRenderedHtml","attributes","html","combo","removeAttribute","_changeAttributeEvent","OR","innerHTML","nextElementSibling","valueField","UI","autocomplete","masked","_validate","field","reduce","querySelectorAll","vi","va","checkeOp","op","opText","innerText","unmaskedValue","valueToShow","toLocaleDateString","dotOrComma","toLocaleString","replace","_getValueToShow","matchCase","whereObjList","push","parseInt","parseFloat","whereFilterList","isString","_renderFiltersConditions","parentElement","forEach","element","offsetTop","dataset","selectedOptions","destroyNumberMask","name","container","className","parentNode","insertBefore","nextSibling","firstElementChild","checked","detectIE","Number","scale","signed","thousandsSeparator","padFractionalZeros","normalizeZeros","radix","step","slice","_autocompleteConstructor","filters","numberSeparator","_hbs","helpers","registerHelper","whereDiv","conditions","delBtnCollection","Array","splice","number","opcion","isComplete","test","_showMessage","checkValidity","trim","_sendQuery","self","_validateQuery","filtro","filterConstructor","_createResultPanel","toolProxification","cacheHost","getAction","url","action","setVisibility","clearFeatures","off","event","LAYERUPDATE","_featuresUpdate","featurePrefix","properties","refresh","_createVectorLayer","id","layerType","WFS","version","owner","stealth","geometryName","outputFormat","JSON","RESULTSPANELCLOSE","e","browserFeatures","touch","swipe","div","_fncLoadVectorLayer","layerOptions","addLayer","condicion","newData","totalFeatures","INFO","features","zoomToFeatures","_showResultPanel","concat","_getLayerName","layerName","_layerName","ResultsPanel","save","fileName","titles","max","fncResultPanelAdded","ctl","cache","ccontainer","getControlsByClass","ControlContainer","addControl","content","main","_downloadClickHandler","position","_self","title","displayElevation","elevation","some","excludedFormats","open","layername","numero","openTable","css","trClass","tdClass","thClass","callback","tabla","maximize","col","dataTypes","j","tdNumeric","k","stopPropagation","undefined","feat","geometry","_select","celdasHoja","celda","offsetWidth","scrollWidth","td","_unselect","label","chkBox","Message","messageDiv","clearTimeout","WARNING","property","listCtrl","minLength","source","window","async","_capabilities","abort","signal","AbortController","fetchJSON","WFSQueryBuilder","contentType","method","arr","pv","cv","err","_getPossibleValues","currentTarget","buildHTML","style","maxHeight","results","cp","_highlightText","which","RegExp","_addFeature","result","addPoint","getCoords","addPolyline","addPolygon","addMultiPolygon","addMultiPolyline","getLayer","VECTOR","render","_map","LAYERERROR","reason","WFSErrors","MAX_NUM_FEATURES","limit","error","countif","chunk","context","bodies","params","body","skip","current","_count","obj","excKeys","ctrl","styleFN","geomType","Cfg","polygon","fillColor","bind","fillOpacity","strokeColor","strokeOpacity","strokeWidth","line","point","radius","height","width","fontSize","fontColor","labelOutlineColor","labelOutlineWidth","angle","_default","extend","texts","ready","addLayerTool","renderFn","layerId","button","WMS","appendChild","LOADING","getWFSCapabilities","WFSCapabilities","catch","finally","updateEvents","actionFn","renderModalDialog","capabilitiesPromise","path","getCapabilitiesPromise","renderDialogPromise","sort","a","b","modal","childNodes","firstChild","showModal","closeCallback","coef","clientWidth","clientHeight","previousElementSibling","all"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\n/*pollyfill*/\r\n\r\nif (typeof Object.assign != 'function') {\r\n    // Must be writable: true, enumerable: false, configurable: true\r\n    Object.defineProperty(Object, \"assign\", {\r\n        value: function assign(target, varArgs) { // .length of function is 2\r\n            'use strict';\r\n            if (target == null) { // TypeError if undefined or null\r\n                throw new TypeError('Cannot convert undefined or null to object');\r\n            }\r\n\r\n            var to = Object(target);\r\n\r\n            for (var index = 1; index < arguments.length; index++) {\r\n                var nextSource = arguments[index];\r\n\r\n                if (nextSource != null) { // Skip over if undefined or null\r\n                    for (var nextKey in nextSource) {\r\n                        // Avoid bugs when hasOwnProperty is shadowed\r\n                        if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {\r\n                            to[nextKey] = nextSource[nextKey];\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            return to;\r\n        },\r\n        writable: true,\r\n        configurable: true\r\n    });\r\n}\r\n\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nif (!TC.filter) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/filter');\r\n}\r\n//cargo los objetos features si no, no resaltara las geometria\r\nif (!TC.Feature) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Feature');\r\n}\r\nif (!TC.feature.Point) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/feature/Point');\r\n}\r\nif (!TC.feature.Polyline) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/feature/Polyline');\r\n}\r\nif (!TC.feature.Polygon) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/feature/Polygon');\r\n}\r\nif (!TC.feature.MultiPolyline) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/feature/MultiPolyline');\r\n}\r\nif (!TC.feature.MultiPolygon) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/feature/MultiPolygon');\r\n}\r\n\r\nTC.control.WFSQuery = function (options) {\r\n    var self = this;\r\n\r\n    TC.Control.apply(this, arguments);\r\n    self.styles = self.options.styles;\r\n    self.highlightStyles = self.options.highlightStyles || self.options.highLightStyles;\r\n    self.download = self.options.download;\r\n\r\n    const cs = '.' + self.CLASS;\r\n    self._selectors = {\r\n        ELEVATION_CHECKBOX: cs + '-dialog-elev input[type=checkbox]',\r\n        INTERPOLATION_RADIO: 'input[type=radio][name=finfo-ip-coords]',\r\n        INTERPOLATION_DISTANCE: cs + '-dialog-ip-m'\r\n    };\r\n};\r\n\r\nTC.inherit(TC.control.WFSQuery, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.WFSQuery.prototype;\r\n\r\n    var cssClassLoading = \"tc-loading\";\r\n    var modalBody = null;\r\n    var modalDialog = null;\r\n    var ctlResultsPanel = null;\r\n    var resultLayer = null;\r\n    var logicalOperator = TC.Consts.logicalOperator.AND;\r\n    var timer = null;\r\n    var timerAutocomplete = null;\r\n    var controller = null;\r\n    var locale = null;\r\n\r\n    const empty= function (node) {\r\n        if(node)\r\n            while (node.children.length) {\r\n                node.removeChild(node.children[0]);\r\n            }\r\n    };\r\n\r\n    var filterByOperation = {\r\n        eq: TC.filter.equalTo,\r\n        not: TC.filter.notEqualTo,\r\n        gt: TC.filter.greaterThan,\r\n        lt: TC.filter.lessThan,\r\n        ge: TC.filter.greaterThanOrEqualTo,\r\n        le: TC.filter.lessThanOrEqualTo,\r\n        like: TC.filter.like,\r\n        contains: TC.filter.like,\r\n        start: TC.filter.like,\r\n        end: TC.filter.like,\r\n        bw: TC.filter.between\r\n    }\r\n    var map = null;\r\n    var _currentLayer = null;\r\n    var _currentLayerName = null;\r\n    var _currentLayercapabilities = null;\r\n    var _currentLayerTitle = null;\r\n    var _currentLayerURL = null;\r\n    var _getStyles = function () { return null };\r\n    var _getHighLightStyles = function () { return null };\r\n    var getLocaleString = null;\r\n    var downloadDialog = null;\r\n    var type = null;\r\n    ctlProto.CLASS = 'tc-ctl-wfsquery';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS + \"-dialog\"] = TC.apiLocation + \"TC/templates/WFSQueryDialog.html\";\r\n    ctlProto.template[ctlProto.CLASS + \"-form\"] = TC.apiLocation + \"TC/templates/WFSQueryForm.html\";\r\n    ctlProto.template[ctlProto.CLASS + \"-filter\"] = TC.apiLocation + \"TC/templates/WFSQueryfilter.html\";\r\n    ctlProto.template[ctlProto.CLASS + \"-table-object\"] = TC.apiLocation + \"TC/templates/WFSQueryResultsTableObject.html\";\r\n\r\n\r\n    var checkInput = function (type) {\r\n        var input = document.createElement(\"input\");\r\n        input.setAttribute(\"type\", type);\r\n        return input.type == type;\r\n    };\r\n\r\n    var _loadDatePolyFill = function () {\r\n        return new Promise(function (resolve, reject) {\r\n            if (typeof (IMask) !== \"undefined\") {\r\n                setTimeout(function () {\r\n                    resolve();\r\n                }, 10);\r\n            }\r\n            else {\r\n                TC.loadJS(true,\r\n                    [TC.apiLocation + '/lib/polyfill/IMask' + (TC.isDebug ? '' : '.min') + '.js'],\r\n                    function () {\r\n                        console.log(\"Imask loaded\");\r\n                        resolve();\r\n                    });\r\n            }\r\n        });\r\n    };\r\n    var _loadNumberPolyFill = function () {\r\n        return new Promise(function (resolve, reject) {\r\n            if (typeof (IMask) !== \"undefined\") {\r\n                setTimeout(function () {\r\n                    resolve();\r\n                }, 10);\r\n            }\r\n            else {\r\n                TC.loadJS(true,\r\n                    [TC.apiLocation + '/lib/polyfill/IMask' + (TC.isDebug ? '' : '.min') + '.js'],\r\n                    function () {\r\n                        console.log(\"Imask loaded\");\r\n                        resolve();\r\n                    });\r\n            }\r\n        });\r\n    }\r\n    var _renderModalDialog = function (layer, layerName, capabilities, callback) {\r\n        const self = this;\r\n        let layers;\r\n        if (layer.getDisgregatedLayerNames) {\r\n            layers = [];\r\n            layer.getDisgregatedLayerNames().forEach(function (value, index) {\r\n                var path = layer.getPath(value);\r\n                //quitamos aquellas que no estén disponibles en el WFS\r\n                if (capabilities.FeatureTypes.hasOwnProperty(value.substring(value.indexOf(\":\") + 1)))\r\n                    layers.push({ name: value, title: path[path.length - 1] });\r\n            });\r\n            layers.sort(function (a, b) {\r\n                if (a.title < b.title) return -1;\r\n                if (a.title > b.title) return 1;\r\n                return 0;\r\n            });\r\n        }\r\n        else {\r\n            layers = layer.featureType;\r\n        }\r\n\r\n        ctlProto.getRenderedHtml(ctlProto.CLASS + \"-dialog\",\r\n            {\r\n                layerName: getLocaleString(\"query.titleDialog\", { \"layerName\": layerName }),\r\n                layers: layers\r\n            }, function (html) {                \r\n                var d = document.createElement(\"div\");\r\n                d.insertAdjacentHTML('beforeEnd',html);\r\n                var modal = null;\r\n                if (d.childNodes.length > 0) {\r\n                    modal = d.firstChild;\r\n                    document.body.appendChild(modal);\r\n                }\r\n                modalBody = modal.getElementsByClassName(\"tc-modal-body\")[0]\r\n                modalBody.classList.add(cssClassLoading);\r\n\r\n                TC.Util.showModal(modal, {\r\n                    closeCallback: function () {\r\n                        modal.parentElement.removeChild(modal);\r\n                    }\r\n                });\r\n                //IE me hace la puñeta con los estilos, no me fuciona el calc el el max-height así que lo calculo cada vez que muestro el dialogo\r\n                if (TC.Util.detectIE()) {\r\n                    var coef = 1;\r\n                    switch (true) {\r\n                        case document.body.clientWidth > 768 && document.body.clientWidth < document.body.clientHeight:\r\n                        case document.body.clientWidth > 1024:\r\n                            coef = 0.8;\r\n                        case document.body.clientWidth > 1140:\r\n                            coef = 0.7;\r\n                            break;\r\n                    }\r\n                    modalBody.style.maxHeight = (document.body.clientHeight * coef) - modalBody.nextElementSibling.clientHeight - modalBody.previousElementSibling.clientHeight;\r\n                }\r\n                modalDialog = modal;\r\n                modal.getElementsByClassName(\"tc-button tc-ctl-wlm-btn-launch\")[0].addEventListener(\"click\", function () {\r\n                    _sendQuery.apply(self, []);\r\n                })\r\n                if (callback) callback(modal);\r\n            });\r\n    };\r\n\r\n    var _renderQueryForm = function (args) {\r\n        var layer = args[0], dialog = args[1], capabilities = args[2];\r\n        _currentLayer = layer;\r\n        _currentLayercapabilities = capabilities;\r\n        _currentLayerURL = capabilities.Operations.DescribeFeatureType.DCP.HTTP.Get[\"href\"];\r\n        _currentLayerURL = _currentLayerURL.substring(_currentLayerURL.indexOf(\":\") + 1);\r\n        if (capabilities.Operations.GetFeature.CountDefault)\r\n            _maxRecordCount = capabilities.Operations.GetFeature.CountDefault.DefaultValue;\r\n        else\r\n            _maxRecordCount = null;\r\n        //analizamos si es una o varias capas, si es una agrupación la disgregamos \r\n        var layers = layer.getDisgregatedLayerNames ? layer.getDisgregatedLayerNames() : layer.featureType;\r\n        //quitamos aquellas que no estén disponibles en el WFS\r\n        layers = layers.filter(function (l) {\r\n            return capabilities.FeatureTypes.hasOwnProperty(l.substring(l.indexOf(\":\") + 1));\r\n        });\r\n        if (layers.length > 1) {\r\n            modalBody.classList.remove(cssClassLoading);\r\n            //bindeamos el onchange de combo\r\n            dialog.getElementsByClassName(\"tc-combo\")[0].addEventListener(\"change\", function () {\r\n                if (!this.value) {\r\n                    var form = dialog.getElementsByClassName(\"tc-modal-form\")[0];\r\n                    empty(form);\r\n                    for (var i = 0; i < form.children.length; i++) form.removeChild(form.children[i]);\r\n                    _clear();\r\n                    return;\r\n                }\r\n                dialog.querySelector(\".tc-modal-body .tc-ctl-wfsquery-message\", dialog).classList.add(TC.Consts.classes.HIDDEN);\r\n                _currentLayerTitle = this.options[this.selectedIndex].text;\r\n                modalBody.classList.add(cssClassLoading);\r\n                _currentLayerName = this.value;\r\n                _currentLayer.describeFeatureType(this.value).then(function (data) {\r\n                    var entries = Object.entries(data);\r\n                    _manageDescribeFeature(entries.length > 1 ? data : entries[0][1], dialog);\r\n                }, function () {\r\n                    var tbody = dialog.getElementsByClassName(\"tc-modal-body\")[0];\r\n                    tbody.classList.remove(cssClassLoading);\r\n                    tbody.insertAdjacentHTML('beforeend',\"<div class=\\\"tc-ctl-wfsquery-message tc-msg-warning\\\">\" + getLocaleString(\"query.LayerNotAvailable\") + \"</div>\");\r\n                    empty(tbody);\r\n                });\r\n            });\r\n        }\r\n        else if (layers.length === 1) {\r\n            //comprabamos que la capa existe en el capabilities\r\n            var layerCapabilities = capabilities.FeatureTypes[layers[0].substring(layers[0].indexOf(\":\") + 1)];\r\n            if (layerCapabilities) {\r\n                _currentLayerTitle = capabilities.FeatureTypes[layers[0].substring(layers[0].indexOf(\":\") + 1)].Title;\r\n                _currentLayerName = layers[0];\r\n                _currentLayer.describeFeatureType(layers[0]).then(function (data) {\r\n                    var entries = Object.entries(data);\r\n                    _manageDescribeFeature(entries.length > 1 ? data : entries[0][1], dialog);\r\n                }, function () {\r\n                    var tbody = dialog.getElementsByClassName(\"tc-modal-body\")[0];\r\n                    tbody.classList.remove(cssClassLoading);\r\n                    tbody.insertAdjacentHTML('beforeend',\"<div class=\\\"tc-ctl-wfsquery-message tc-msg-warning\\\">\" + getLocaleString(\"query.LayerNotAvailable\") + \"</div>\");\r\n                    empty(tbody);\r\n                });\r\n            }\r\n            else {\r\n                var tbody = dialog.getElementsByClassName(\"tc-modal-body\")[0];\r\n                tbody.classList.remove(cssClassLoading);\r\n                tbody.insertAdjacentHTML('beforeend',\"<div class=\\\"tc-ctl-wfsquery-message tc-msg-warning\\\">\" + getLocaleString(\"query.LayerNotAvailable\") + \"</div>\");\r\n                //TC.Util.closeModal();\r\n                //layer.map.toast(\"Mal\", { type: TC.Consts.msgType.WARNING });\r\n            }\r\n\r\n        }\r\n        else {\r\n            TC.Util.closeModal();\r\n            layer.map.toast(TC.Util.getLocaleString(layer.map.options.locale, \"query.LayerNotAvailable\"), { type: TC.Consts.msgType.ERROR });\r\n        }\r\n    }\r\n\r\n\r\n    var _getValue = function (input) {\r\n        if (inputMaskNumber) {\r\n            return inputMaskNumber.unmaskedValue;\r\n\r\n        } else if (dateInputMask) {\r\n            //si es texto con mascara de fecha convertierto la fecha de dd/mm/yyyy a yyyy-mm-dd\r\n            return dateInputMask.unmaskedValue.substring(4) + \"-\" + dateInputMask.unmaskedValue.substring(2, 4) + \"-\" + dateInputMask.unmaskedValue.substring(0, 2)\r\n        }\r\n        return input.value;//en el resto de los casos la devuelvo tal cual\r\n\r\n    }\r\n    var _getValueToShow = function (input) {\r\n        if (inputMaskNumber) {\r\n            return inputMaskNumber.value;\r\n        }\r\n        else if (dateInputMask) {\r\n            //si es de tipo date devolvemos la fecha en formato dd/mm/yyyy\r\n            return dateInputMask.value;\r\n        }\r\n        else if (input.type === \"date\") {\r\n            return new Date(input.value).toLocaleDateString(locale)\r\n        }\r\n        else if (input.type === \"number\") {\r\n            var dotOrComma = 1.1.toLocaleString(locale).substring(1, 2);\r\n            return input.value.replace(\".\", dotOrComma);\r\n        }\r\n        return input.value;//en el resto de los casos la devuelvo tal cual\r\n\r\n    }\r\n    var dateInputMask = null;\r\n    var inputMaskNumber = null;\r\n    var _createDateMask = function (txtBox) {\r\n        if (checkInput(\"date\"))\r\n            txtBox.type = \"date\";\r\n        else {\r\n            txtBox.type = \"search\";\r\n            _loadDatePolyFill().then(function () {\r\n                //construir el polyfill\r\n                dateInputMask = new IMask(txtBox, {\r\n                    mask: Date,\r\n                    pattern: ((!locale || locale === \"es-ES\") ? 'd/`m/`Y' : (locale === \"eu-ES\" ? 'Y/`m/`d' : 'm/`d/`Y')),\r\n                    lazy: false,\r\n                    format: function (date) {\r\n                        var day = date.getDate();\r\n                        var month = date.getMonth() + 1;\r\n                        var year = date.getFullYear();\r\n                        if (day < 10) day = \"0\" + day;\r\n                        if (month < 10) month = \"0\" + month;\r\n                        switch (locale) {\r\n                            case \"eu-ES\":\r\n                                return [year, month, day].join('/');\r\n                                break;\r\n                            case \"en-US\":\r\n                                return [month, day, year].join('/');\r\n                                break;\r\n                            case \"es-ES\":\r\n                            default:\r\n                                return [day, month, year].join('/');\r\n                                break;\r\n                        }\r\n\r\n                    },\r\n                    // define str -> date convertion\r\n                    parse: function (str) {\r\n                        switch (locale) {\r\n                            case \"eu-ES\":\r\n                                return new Date(str.split('/')[1] + \"/\" + str.split('/')[2] + \"/\" + str.split('/')[0])\r\n                                break;\r\n                            case \"en-US\":\r\n                                return new Date(str)\r\n                                break;\r\n                            case \"es-ES\":\r\n                            default:\r\n                                return new Date(str.split('/')[1] + \"/\" + str.split('/')[0] + \"/\" + str.split('/')[2])\r\n                                break;\r\n                        }\r\n\r\n                    },\r\n                    blocks: {\r\n                        d: {\r\n                            mask: IMask.MaskedRange,\r\n                            from: 1,\r\n                            to: 31,\r\n                            maxLength: 2,\r\n                        },\r\n                        m: {\r\n                            mask: IMask.MaskedRange,\r\n                            from: 1,\r\n                            to: 12,\r\n                            maxLength: 2,\r\n                        },\r\n                        Y: {\r\n                            mask: IMask.MaskedRange,\r\n                            from: 1900,\r\n                            to: 9999,\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    };\r\n    var _destroyDateMask = function () {\r\n        if (dateInputMask) {\r\n            var input = dateInputMask.el.input;\r\n            dateInputMask.destroy();\r\n            dateInputMask = null;\r\n            input.value = \"\";\r\n            input.type = \"search\";\r\n        }\r\n    };\r\n    var destroyNumberMask = function () {\r\n        if (inputMaskNumber) {\r\n            var input = inputMaskNumber.el.input;\r\n            inputMaskNumber.destroy();\r\n            inputMaskNumber = null;\r\n            input.value = \"\";\r\n            input.type = \"search\";\r\n        }\r\n    };\r\n    var _getDataTypes = function () {\r\n        return _internalGetDataTypes();\r\n    }\r\n    var _manageDescribeFeature = function (data, dialog) {\r\n        _clear();\r\n        _internalGetDataTypes = function () {\r\n            return data;\r\n        };\r\n        let objFiltered = {};\r\n        for (var i in data) {\r\n            if (!TC.Util.isGeometry(data[i].type)) {\r\n                objFiltered[i] = data[i];\r\n            }\r\n        }\r\n        data = objFiltered;\r\n        ctlProto.getRenderedHtml(ctlProto.CLASS + \"-form\",\r\n            {\r\n                attributes: data\r\n            }, function (html) {\r\n                var form = dialog.getElementsByClassName(\"tc-modal-form\")[0];\r\n                empty(form);\r\n                form.insertAdjacentHTML('beforeend', html);\r\n                modalBody.classList.remove(cssClassLoading);\r\n                TC.loadJS(\r\n                    true,\r\n                    [TC.apiLocation + 'TC/ui/autocomplete.js'],\r\n                    function () {\r\n                        console.log(\"autocomplete loaded\");\r\n                    });\r\n                var combo = form.getElementsByClassName(\"tc-combo\");\r\n                if (combo.length == 0)\r\n                    dialog.getElementsByClassName(\"tc-button tc-ctl-wlm-btn-launch\")[0].setAttribute(\"disabled\", \"\");\r\n                else {\r\n                    dialog.getElementsByClassName(\"tc-button tc-ctl-wlm-btn-launch\")[0].removeAttribute(\"disabled\");\r\n                    combo[0].addEventListener(\"change\", function () {\r\n                        _changeAttributeEvent.apply(this, [form, data]);\r\n                    });\r\n                    form.querySelector(\".tc-ctl-wfsquery-where  input[type='radio']\").addEventListener(\"change\", function () {\r\n                        logicalOperator = this.value === \"OR\" ? TC.Consts.logicalOperator.OR : TC.Consts.logicalOperator.AND\r\n                        //reemplazar en la lista\r\n                        form.getElementsByClassName(\"tc-ctl-wfsquery-whereList-op\")[0].innerHTML = this.nextElementSibling.innerHTML;\r\n                    });\r\n\r\n                    form.querySelector(\".tc-button\").addEventListener(\"click\", function () {\r\n                        var valueField = form.querySelector('input.tc-textbox');\r\n                        TC.UI.autocomplete.call(valueField, \"clear\");\r\n                        if (inputMaskNumber)\r\n                            inputMaskNumber.masked.remove();\r\n                        if (!_validate(form)) {\r\n                            return;\r\n                        }\r\n                        var field = [].reduce.call(form.querySelectorAll('.tc-combo'), function (vi, va) {\r\n                            return vi + (vi ? \"/\" : \"\") + va.value;\r\n                        }, '');\r\n                        var checkeOp = form.querySelector('.tc-ctl-wfsquery input[type=\"radio\"]:checked');\r\n                        var op = checkeOp.value;\r\n                        var opText = checkeOp.nextElementSibling.innerText;\r\n\r\n                        var value = _getValue(valueField);\r\n                        var valueToShow = _getValueToShow(valueField);\r\n                        var logOp = form.querySelector('.tc-ctl-wfsquery-where  input[type=\"radio\"]:checked').nextElementSibling.innerText;\r\n\r\n                        //reemplazo < y > por y &lt;&gt;\r\n                        value = value.replace(\"<\", \"&lt;\").replace(\">\", \"&gt;\");\r\n                        //escapo los caracteres no alfamericos                    \r\n                        //value = value.replace(/[^a-z\\dáéíóúü]/gi, '!' + '$&');\r\n                        //se añade asterisco al principio y/o final del valor para las busquedas: \"empieza por\", \"termina en\" o \"contiene\"\r\n                        var f;\r\n                        if (type.indexOf(\"dateTime\") >= 0) {\r\n                            if (op !== \"nbw\")\r\n                                f = new filterByOperation[op](field, value + \"T00:00:00Z\", value + \"T23:59:59Z\");\r\n                            else//el not bettween es un caso es especial por que concatena un filtro not y otro between\r\n                            {\r\n                                f = new TC.filter.not(TC.filter.between(field, value + \"T00:00:00Z\", value + \"T23:59:59Z\"));\r\n                            }\r\n                        }\r\n                        else\r\n                            f = new filterByOperation[op](\r\n                                field,\r\n                                (((op === \"end\" || op === \"contains\") ? '*' : '') + value + ((op === \"start\" || op === \"contains\") ? '*' : '')));\r\n                        f.matchCase = false;\r\n                        whereObjList.push(f);\r\n                        switch (true) {\r\n                            case type.indexOf(\"int\") >= 0:\r\n                                valueToShow = parseInt(value, 10)\r\n                                break;\r\n                            case type.indexOf(\"float\") >= 0:\r\n                            case type.indexOf(\"double\") >= 0:\r\n                            case type.indexOf(\"long\") >= 0:\r\n                            case type.indexOf(\"decimal\") >= 0:\r\n                                valueToShow = parseFloat(value, 10)\r\n                                break;\r\n                        }\r\n                        whereFilterList.push({\r\n                            \"field\": field,\r\n                            \"opText\": opText,\r\n                            \"isString\": type.indexOf(\"string\") >= 0,\r\n                            \"valueToShow\": valueToShow\r\n                        });\r\n\r\n                        _renderFiltersConditions(form);\r\n                        valueField.value = \"\";\r\n                    });\r\n                }\r\n            });\r\n    };\r\n    \r\n    var _manageComplexTypes = function (type, form) {\r\n\r\n        var html = '';\r\n        html += ('<option value=\"\">' + getLocaleString('query.chooseAttrCombo') + '</option>');\r\n        for (var key in type) {\r\n            if (!type[key].type || TC.Util.isGeometry(type[key].type)) continue;    \r\n            html += '<option value=\"' + (type[key].name || key) + '\">' + key + '</option>';\r\n        }\r\n        var container = document.createElement(\"div\")\r\n        container.insertAdjacentHTML('beforeend', '<select class=\"' + this.className + '\" name=\"' + this.name + '\">' + html + '</select>');\r\n        this.parentNode.parentNode.insertBefore(container, this.parentNode.nextSibling).firstElementChild.addEventListener(\"change\", function () {\r\n            _changeAttributeEvent.apply(this, [form, type]);\r\n        });\r\n\r\n    }\r\n    var _changeAttributeEvent = function (form, data) {\r\n        //borrar los hijos\t\t\r\n        var combo = this;\r\n        combo.parentElement.parentElement.querySelectorAll(\"select\").forEach(function (element) {\r\n            if (combo.offsetTop < element.offsetTop) {\r\n                element.parentElement.parentElement.removeChild(element.parentElement);\r\n            }\r\n        });\r\n\r\n        var valueField = form.querySelector(\".tc-ctl-wfsquery-where .tc-textbox\");\r\n        if (valueField.dataset[\"autocomplete\"])\r\n            TC.UI.autocomplete.call(valueField, \"clear\");\r\n        if (!data[this.selectedOptions[0].text]) {\r\n            form.getElementsByClassName(\"tc-ctl-wfsquery-numeric\")[0].classList.add(\"tc-hidden\");\r\n            form.getElementsByClassName(\"tc-ctl-wfsquery-date\")[0].classList.add(\"tc-hidden\");\r\n            form.getElementsByClassName(\"tc-ctl-wfsquery-text\")[0].classList.add(\"tc-hidden\");\r\n            form.getElementsByClassName(\"tc-ctl-wfsquery-where\")[0].classList.add(\"tc-hidden\");\r\n            form.getElementsByClassName(\"tc-ctl-wfsquery-operacion\")[0].classList.add(\"tc-hidden\");\r\n            return;\r\n        }\r\n        type = data[this.selectedOptions[0].text].type;\r\n        form.getElementsByClassName(\"tc-ctl-wfsquery-operacion\")[0].classList.remove(\"tc-hidden\");\r\n        TC.UI.autocomplete.call(valueField, \"clear\");\r\n        //$(valueField).unbind(\"keydown\");\r\n        destroyNumberMask();\r\n        valueField.type = \"search\";\r\n        form.querySelector(\".tc-ctl-wfsquery-numeric\").classList.add(\"tc-hidden\");\r\n        form.querySelector(\".tc-ctl-wfsquery-text\").classList.add(\"tc-hidden\");\r\n        form.querySelector(\".tc-ctl-wfsquery-date\").classList.add(\"tc-hidden\");\r\n        form.querySelector(\".tc-ctl-wfsquery-where\").classList.add(\"tc-hidden\");\r\n        switch (true) {\r\n            case !type:\r\n                console.log(\"type es nulo\");\r\n                break;\r\n            case type instanceof Object:\r\n                _manageComplexTypes.apply(this, [type, form]);                \r\n                break;\r\n            case type.indexOf(\"int\") >= 0:\r\n            case type.indexOf(\"float\") >= 0:\r\n            case type.indexOf(\"double\") >= 0:\r\n            case type.indexOf(\"long\") >= 0:\r\n            case type.indexOf(\"decimal\") >= 0:\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-numeric\")[0].classList.remove(\"tc-hidden\");\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-text\")[0].classList.add(\"tc-hidden\");\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-date\")[0].classList.add(\"tc-hidden\");\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-where\")[0].classList.remove(\"tc-hidden\");\r\n\r\n                if (form.querySelectorAll(\"tc-ctl-wfsquery-numeric input:checked\").length === 0)\r\n                    form.querySelector(\".tc-ctl-wfsquery-numeric :first-child\").checked = true;\r\n                _destroyDateMask();\r\n\r\n                if (checkInput(\"number\")) {\r\n                    if (TC.Util.detectIE()) {\r\n                        valueField.type = \"text\";\r\n                        _loadNumberPolyFill().then(function () {\r\n                            inputMaskNumber = new IMask(valueField, {\r\n                                mask: Number,  // enable number mask\r\n                                scale: (type.indexOf(\"int\") >= 0 || type.indexOf(\"long\") >= 0) ? 0 : 2,  // digits after point, 0 for integers\r\n                                signed: false,  // disallow negative\r\n                                thousandsSeparator: (locale && locale === \"en-US\") ? ',' : '.',  // any single char\r\n                                padFractionalZeros: false,  // if true, then pads zeros at end to the length of scale\r\n                                normalizeZeros: true,  // appends or removes zeros at ends\r\n                                radix: (locale && locale === \"en-US\") ? '.' : ',',  // fractional delimiter\r\n                            })\r\n                        });\r\n                    }\r\n                    else {\r\n                        valueField.type = \"number\";\r\n                        if (type.indexOf(\"int\") >= 0 || type.indexOf(\"long\") >= 0)\r\n                            valueField.step = \"1\";\r\n                        else\r\n                            valueField.step = \"0.0001\";\r\n                    }\r\n                }\r\n                break\r\n            case type.indexOf(\"dateTime\") >= 0:\r\n\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-numeric\")[0].classList.add(\"tc-hidden\");\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-text\")[0].classList.add(\"tc-hidden\");\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-date\")[0].classList.remove(\"tc-hidden\");\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-where\")[0].classList.remove(\"tc-hidden\");\r\n\r\n                if (form.querySelectorAll(\"tc-ctl-wfsquery-date input:checked\").length === 0)\r\n                    form.querySelector(\".tc-ctl-wfsquery-date :first-child\").checked = true;\r\n                _createDateMask(valueField);\r\n                break;\r\n            case type.indexOf(\"string\") >= 0:\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-numeric\")[0].classList.add(\"tc-hidden\");\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-text\")[0].classList.remove(\"tc-hidden\");\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-date\")[0].classList.add(\"tc-hidden\");\r\n                form.getElementsByClassName(\"tc-ctl-wfsquery-where\")[0].classList.remove(\"tc-hidden\");\r\n\r\n                if (form.querySelectorAll(\"tc-ctl-wfsquery-text input:checked\").length === 0)\r\n                    form.querySelector(\".tc-ctl-wfsquery-text :first-child\").checked = true;\r\n                _destroyDateMask();\r\n                const value = [].slice.call(form.querySelectorAll('select[name=' + this.name + ']')).reduce(function (vi, va) { return vi + (vi ? \"/\" : \"\") + va.value; }, \"\");\r\n                _autocompleteConstructor(valueField, value, form.getElementsByClassName(ctlProto.CLASS + \"-list tc-ctl-search-list\")[0]);\r\n                break;\r\n        }\r\n    }\r\n    var _renderFiltersConditions = function (form) {\r\n\r\n        if (!dust.filters.numberSeparator)\r\n            dust.filters.numberSeparator = function (value) {\r\n                return value.toLocaleString(locale);\r\n            };\r\n\r\n        if (TC._hbs && !TC._hbs.helpers.numberSeparator) {\r\n            TC._hbs.registerHelper(\"numberSeparator\", function (value) {\r\n                return value.toLocaleString(locale);\r\n            });\r\n        }\r\n\r\n        var whereDiv = form.getElementsByClassName(\"tc-ctl-wfsquery-whereList\")[0];\r\n        empty(whereDiv);\r\n        ctlProto.getRenderedHtml(ctlProto.CLASS + \"-filter\", {\r\n            conditions: whereFilterList\r\n        }, function (html) {\r\n            form.getElementsByClassName(\"tc-ctl-wfsquery-whereList\")[0].innerHTML = html;\r\n            var delBtnCollection = form.getElementsByClassName(\"tc-ctl-wfsquery-del-cond\");\r\n            for (var i = 0; i < delBtnCollection.length; i++) {\r\n                delBtnCollection[i].addEventListener(\"click\", function () {\r\n                    var index = Array.prototype.indexOf.call(delBtnCollection, this);\r\n                    whereObjList.splice(index, 1);\r\n                    whereFilterList.splice(index, 1);\r\n                    _renderFiltersConditions(form);\r\n                });\r\n            }\r\n        });\r\n    }\r\n    var _clear = function () {\r\n        whereObjList = [];\r\n        whereFilterList = [];\r\n    };\r\n    var _validate = function (form) {\r\n        var opcion = form.querySelector('.tc-ctl-wfsquery input[type=\"radio\"]:checked');\r\n\r\n        if (dateInputMask && !dateInputMask.masked.isComplete) {\r\n            if (/^(?=\\d)(?:(?:31(?!.(?:0?[2469]|11))|(?:30|29)(?!.0?2)|29(?=.0?2.(?:(?:(?:1[6-9]|[2-9]\\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00)))(?:\\x20|$))|(?:2[0-8]|1\\d|0?[1-9]))([-.\\/])(?:1[012]|0?[1-9])\\1(?:1[6-9]|[2-9]\\d)?\\d\\d(?:(?=\\x20\\d)\\x20|$))?(((0?[1-9]|1[012])(:[0-5]\\d){0,2}(\\x20[AP]M))|([01]\\d|2[0-3])(:[0-5]\\d){1,2})?$/.test(str) === false)\r\n                _showMessage(\"Fecha \" + str + \" inválida\", TC.Consts.msgType.ERROR);\r\n            return false;\r\n        }\r\n        if (opcion.length == 0) {\r\n            _showMessage(getLocaleString(\"query.msgNoCondition\"));\r\n            return false;\r\n        }\r\n        if (form.querySelectorAll('input[type=\\'date\\']').length && !form.querySelector('input[type=\\'date\\']').checkValidity()) {\r\n            _showMessage(getLocaleString(\"query.msgNoValidDate\"));\r\n            return false;\r\n        }\r\n        var number\r\n        if (form.querySelectorAll('input[type=\\'number\\']').length && ((number = form.querySelector('input[type=\\'number\\']')) != null) && !number.checkValidity()) {\r\n            if (number.step === \"1\")\r\n                _showMessage(getLocaleString(\"query.msgNoValidNumberMustInt\"));\r\n            else\r\n                _showMessage(getLocaleString(\"query.msgNoValidNumber\"));\r\n            return false;\r\n        }\r\n        if (form.querySelector('input.tc-textbox').value.trim() === \"\") {\r\n            _showMessage(getLocaleString(\"query.msgNoValueCondition\"));\r\n            return false;\r\n        }\r\n        return true;\r\n    };\r\n    var _sendQuery = function () {\r\n        const self = this;\r\n        if (!_validateQuery()) {\r\n            _showMessage(getLocaleString(\"query.msgNoQueryFilter\"));\r\n            return;\r\n        }\r\n        modalDialog.getElementsByClassName(\"tc-modal-body\")[0].classList.add(cssClassLoading);\r\n        var _fncLoadVectorLayer = function () {\r\n            var filtro = filterConstructor();\r\n\r\n            _createResultPanel.apply(self, [_currentLayerTitle]);\r\n\r\n            _currentLayer.toolProxification.cacheHost.getAction(_currentLayerURL).then(function (cacheHost) {\r\n                const url = cacheHost.action(_currentLayerURL);\r\n                if (!resultLayer) {\r\n                    _createVectorLayer({\r\n                        id: \"WFSQueryResults\",\r\n                        type: TC.Consts.layerType.WFS,\r\n                        url: url,\r\n                        version: \"1.1.0\",\r\n                        owner: self,\r\n                        stealth: true,\r\n                        geometryName: \"the_geom\",\r\n                        featurePrefix: _currentLayerName.substring(0, _currentLayerName.indexOf(\":\")),\r\n                        featureType: _currentLayerName.substring(_currentLayerName.indexOf(\":\") + 1),\r\n                        properties: filtro,\r\n                        outputFormat: TC.Consts.format.JSON,\r\n                        styles: _getStyles()\r\n                    });\r\n                    map.on(TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                        if (e.control !== ctlResultsPanel)\r\n                            return;\r\n                        if (TC.browserFeatures.touch()) {\r\n                            TC.Util.swipe(e.control.div, \"enable\");\r\n                        }\r\n                        resultLayer.clearFeatures();\r\n                        resultLayer.setVisibility(false);\r\n                        map.off(TC.Consts.event.LAYERUPDATE, _featuresUpdate);\r\n                    });\r\n                }\r\n                else {\r\n                    resultLayer.setVisibility(false);\r\n                    resultLayer.clearFeatures();\r\n                    //borro el evento featureUpdate por si hago una búsqueda sin cerra el panel previamente\r\n                    map.off(TC.Consts.event.LAYERUPDATE, _featuresUpdate);\r\n                    map.on(TC.Consts.event.LAYERUPDATE, _featuresUpdate);\r\n                    resultLayer.url = url;\r\n                    resultLayer.featurePrefix = _currentLayerName.substring(0, _currentLayerName.indexOf(\":\"));\r\n                    resultLayer.featureType = _currentLayerName.substring(_currentLayerName.indexOf(\":\") + 1);\r\n                    resultLayer.properties = filtro;\r\n                    resultLayer.setVisibility(true);\r\n                    resultLayer.refresh();\r\n                }\r\n            });\r\n        }\r\n        _fncLoadVectorLayer();\r\n    }\r\n    var _createVectorLayer = function (layerOptions) {\r\n        map.addLayer(layerOptions).then(function (layer) {\r\n            resultLayer = layer;\r\n            layer.map.on(TC.Consts.event.LAYERUPDATE, _featuresUpdate);\r\n        });\r\n    };\r\n    var filterConstructor = function () {\r\n        if (whereObjList.length > 1) {\r\n            var condicion = document.querySelector(\".tc-ctl-wfsquery-logOpRadio:checked\").value;\r\n            return TC.filter[TC.Consts.logicalOperator[condicion]].apply(null, whereObjList);\r\n        }\r\n        else if (whereObjList.length === 0)\r\n            return null\r\n        else\r\n            return whereObjList[0];\r\n    }\r\n    var _featuresUpdate = function (e) {        \r\n        if (e.layer == resultLayer) {\r\n            if (e.newData && e.newData.totalFeatures === 0) {\r\n                modalDialog.getElementsByClassName(\"tc-modal-body\")[0].classList.remove(cssClassLoading);\r\n                _showMessage(getLocaleString(\"query.msgNoResults\"), TC.Consts.msgType.INFO);\r\n                return;\r\n            }\r\n            var features = e.layer.features;\r\n            if (features.length > 0) {\r\n                map.zoomToFeatures(features);\r\n                _showResultPanel(\r\n                    (features.length > 1 ?\r\n                        features.reduce(function (vi, va, index) {\r\n                            return (vi instanceof Array ? vi : [vi.data]).concat([va.data])\r\n                        })\r\n                        :\r\n                        [features[0].data])\r\n                    , resultLayer, _currentLayerTitle);\r\n            }\r\n            else {\r\n                modalDialog.getElementsByClassName(\"tc-modal-body\")[0].classList.remove(cssClassLoading);\r\n                _showMessage(\"No hay resultados\", TC.Consts.msgType.INFO);\r\n            }\r\n            e.layer.map.off(TC.Consts.event.LAYERUPDATE, _featuresUpdate);\r\n        }\r\n    };\r\n    const _getLayerName = () => { return _currentLayerTitle };\r\n    var _createResultPanel = function (layerName) {\r\n        const self = this;\r\n        var _layerName = layerName;\r\n        new Promise(function (resolve, reject) {\r\n            if (!TC.control.ResultsPanel) {\r\n                TC.loadJS(true, TC.apiLocation + 'TC/control/ResultsPanel', function () {\r\n                    resolve(TC.control.ResultsPanel);\r\n                });\r\n            }\r\n            else\r\n                resolve(TC.control.ResultsPanel);\r\n        }).then(function (ResultsPanel) {\r\n            if (!ctlResultsPanel) {\r\n                var fncResultPanelAdded = function (ctl) {\r\n                    ctlResultsPanel = ctl;\r\n                    delete dust.cache[ctlResultsPanel.CLASS + \"-table\"];                    \r\n                    ctlResultsPanel.template[ctlResultsPanel.CLASS + \"-table\"] = TC.apiLocation + \"TC/templates/WFSQueryResultsTable.html\";\r\n                    ctlResultsPanel.options.titles.max = ctlResultsPanel.getLocaleString('geo.trk.chart.exp');\r\n                }\r\n                var ccontainer = map.getControlsByClass(TC.control.ControlContainer);\r\n                if (ccontainer.length == 0) {\r\n                    map.addControl(\"ResultsPanel\",\r\n                        {\r\n                            \"content\": \"table\",\r\n                            \"titles\": {\r\n                                \"main\": \"\",\r\n                                \"max\": \"\"\r\n                            },\r\n                            \"save\": {\r\n                                \"fileName\": _layerName + \".xls\"\r\n                            },\r\n                            \"download\": () => { _downloadClickHandler(self, _getLayerName) }\r\n                        }).then(fncResultPanelAdded);\r\n                }\r\n                else {\r\n                    ccontainer[0].addControl(\"ResultsPanel\", {\r\n                        \"content\": \"table\",\r\n                        \"titles\": {\r\n                            \"main\": \"\",\r\n                            \"max\": \"\"\r\n                        },\r\n                        \"save\": {\r\n                            \"fileName\": _layerName + \".xls\"\r\n                        },\r\n                        \"download\": () => { _downloadClickHandler(self, _getLayerName) }, \"position\": \"right\"\r\n                    }).then(fncResultPanelAdded);\r\n                }\r\n            }\r\n            else {\r\n                ctlResultsPanel.options.save.fileName = _layerName + \".xls\";\r\n                ctlResultsPanel.options.titles.max = ctlResultsPanel.getLocaleString('geo.trk.chart.exp');\r\n            }\r\n        });\r\n\r\n        var _downloadClickHandler = function (_self, layerName) {\r\n            const self = _self;\r\n            new Promise(function (resolve, reject) {\r\n                if (!downloadDialog) {\r\n                    self.map.addControl('FeatureDownloadDialog').then(ctl => {\r\n                        downloadDialog = ctl;\r\n                        resolve(downloadDialog);\r\n                    });\r\n                }\r\n                else {\r\n                    resolve(downloadDialog);\r\n                }\r\n            }).then(function (control) {\r\n                var options = {\r\n                    title: layerName()\r\n                };\r\n                if (self.options.displayElevation !== true)\r\n                    options = Object.assign({}, options, { elevation: Object.assign({}, self.map.elevation && self.map.elevation.options, self.options.displayElevation) });\r\n                else\r\n                    options = Object.assign({}, options, { elevation: self.map.elevation && self.map.elevation.options });\r\n\r\n                //si algún elemento de la colección es un polígono exclyo el botón GPX\r\n                if (resultLayer.features.some(function (feature) {\r\n                    return (TC.feature.Polygon && feature instanceof TC.feature.Polygon) ||\r\n                        (TC.feature.MultiPolygon && feature instanceof TC.feature.MultiPolygon);\r\n                }))\r\n                    options = Object.assign({}, options, { excludedFormats: [\"GPX\"] });\r\n\r\n                control.open(resultLayer.features, options);\r\n            });\r\n        };\r\n    };\r\n    var _showResultPanel = function (data, layer, layername) {\r\n\r\n        //map.$events.trigger(TC.Consts.event.SEARCHDONE, { data: data } );\r\n\r\n        var truthTest = function (name, test) {\r\n            return function (chunk, context, bodies, params) {\r\n                return filter(chunk, context, bodies, params, name, test);\r\n            };\r\n        }\r\n\r\n        //en funcion del número de elementos cargo un título en singular o plural\r\n\r\n        ctlResultsPanel.div.querySelector(\".prpanel-title-text\").innerText = ctlResultsPanel.getLocaleString(data.length > 1 ? 'query.titleResultPaneMany' : 'query.titleResultPanelOne', { \"numero\": data.length, \"layerName\": layername });\r\n\r\n        ctlResultsPanel.div.classList.add(\"tc-ctl-wfsquery-results\");\r\n\r\n        modalDialog.parentElement.removeChild(modalDialog);\r\n\r\n        ctlResultsPanel.openTable({\r\n            data: data,\r\n            css: {\r\n                trClass: \"trClass\",\r\n                tdClass: \"tdClass\",\r\n                thClass: \"thClass\",\r\n            },\r\n            callback: function (tabla) {\r\n\r\n                ctlResultsPanel.maximize();\r\n                console.log(\"render del panel de resultados\");\r\n                var col = tabla.querySelectorAll(\".table>tbody>tr\")\r\n                var dataTypes = _getDataTypes();\r\n                var j = 1;\r\n                for (var i in data[0]) {\r\n                    if (dataTypes.hasOwnProperty(i)) {\r\n                        if (dataTypes[i].type && !(dataTypes[i].type instanceof Object))\r\n                            if ((dataTypes[i].type.indexOf(\"int\") >= 0 ||\r\n                                dataTypes[i].type.indexOf(\"float\") >= 0 ||\r\n                                dataTypes[i].type.indexOf(\"double\") >= 0 ||\r\n                                dataTypes[i].type.indexOf(\"long\") >= 0 ||\r\n                                dataTypes[i].type.indexOf(\"decimal\") >= 0)) {\r\n                                var tdNumeric = tabla.querySelectorAll(\"td:nth-child(\" + j + \")\");\r\n                                for (var k = 0; k < tdNumeric.length; k++) {\r\n                                    tdNumeric[k].classList.add(\"tc-numeric\");\r\n                                }\r\n                            }\r\n                        if (dataTypes[i].type && (dataTypes[i].type instanceof Object)) {\r\n                            console.log(\"aki lo que sea\");\r\n                        }\r\n                    }\r\n                    j++;\r\n                }\r\n\r\n                for (var i = 0; i < col.length; i++) {\r\n                    col[i].addEventListener(\"click\", function (e) {\r\n                        e.stopPropagation();\r\n                        var index = this.dataset.index;\r\n                        if (index != undefined)\r\n                            layer.map.zoomToFeatures([layer.features[index]]);\r\n                    });\r\n                    col[i].addEventListener(\"mouseenter\", function () {\r\n                        var index = this.dataset.index;\r\n                        if (index == undefined) return;\r\n                        var feat = layer.features[index]\r\n                        if (feat && feat.geometry) {\r\n                            //feat.select();\r\n                            _select(feat);\r\n                        }\r\n                        var celdasHoja = this.querySelectorAll(\"td.value div\");\r\n                        if (celdasHoja.length > 0) {\r\n                            celdasHoja.forEach(function (celda) {\r\n                                if (celda.offsetWidth < celda.scrollWidth)\r\n                                    celda.title = celda.innerText;\r\n                            })\r\n                        }\r\n                        else\r\n                            this.querySelectorAll(\"td\").forEach(function (td) {\r\n                                if (td.offsetWidth < td.scrollWidth)\r\n                                    td.title = td.innerText;\r\n                            });\r\n\r\n                    });\r\n                    col[i].addEventListener(\"mouseleave\", function () {\r\n                        var index = this.dataset.index;\r\n                        if (index == undefined) return;\r\n                        var feat = layer.features[index]\r\n                        if (feat && feat.geometry) {\r\n                            //feat.unselect();\r\n                            _unselect(feat)\r\n                            //esto es porque el unselect no devulve al estilo por defecto\r\n                            //feat.setStyle(TC.Cfg.styles[feat.STYLETYPE]);\r\n                        }\r\n                    });\r\n                }\r\n                tabla.querySelectorAll(\".complexAttr label,.complexAttr input\").forEach(function (label) {\r\n                    label.addEventListener(\"click\", function (e) {\r\n                        e.stopPropagation();\r\n                    })\r\n                });\r\n                tabla.querySelectorAll(\".complexAttr input\").forEach(function (chkBox) {\r\n                    chkBox.addEventListener(\"change\", function (e) {\r\n                        if (this.checked) {\r\n                            this.nextElementSibling.querySelectorAll(\"td.value div\").forEach(function (div) {\r\n                                if (div.offsetWidth < div.scrollWidth)\r\n                                    div.title = div.innerText;\r\n                            });\r\n                        }\r\n                    })\r\n                });\r\n\r\n                ////se deshabilita el swipe para que se pueda hacer scroll horizontal del panel de resultados\r\n                if (TC.browserFeatures.touch()) {\r\n                    TC.Util.swipe(ctlResultsPanel.div, 'disable');\r\n                }\r\n            }\r\n        });\r\n\r\n    }\r\n    var _validateQuery = function () {\r\n        return whereObjList.length > 0;\r\n    };\r\n    var _showMessage = function (Message, type) {\r\n        var messageDiv = modalBody.getElementsByClassName(\"tc-ctl-wfsquery-message\")[0];\r\n        if (timer) {\r\n            clearTimeout(timer);\r\n        }\r\n        else {\r\n            messageDiv.innerHTML = Message;\r\n            switch (type) {\r\n                case TC.Consts.msgType.INFO:\r\n                    messageDiv.classList.add(\"tc-msg-info\")\r\n                    break;\r\n                case TC.Consts.msgType.WARNING:\r\n                    messageDiv.classList.add(\"tc-msg-warning\")\r\n                    break;\r\n                case TC.Consts.msgType.ERROR:\r\n                default:\r\n                    messageDiv.classList.add(\"tc-msg-error\")\r\n                    break;\r\n            }\r\n            messageDiv.classList.remove(TC.Consts.classes.HIDDEN);\r\n        }\r\n        timer = setTimeout(function () {\r\n            timer = null;\r\n            messageDiv.classList.add(TC.Consts.classes.HIDDEN);\r\n        }, 3000)\r\n    };\r\n    var _getPossibleValues = async function (field, value) {\r\n        var _capabilities = Object.assign({}, _currentLayercapabilities);\r\n        _capabilities.version = \"1.1.0\";\r\n        switch (document.querySelector(\".tc-ctl-wfsquery.tc-ctl-wfsquery-text input:checked\").value) {\r\n            case \"start\":\r\n                value = (value + \"*\");\r\n                break;\r\n            case \"contains\":\r\n            case \"eq\":\r\n                value = (\"*\" + value + \"*\");\r\n                break;\r\n            case \"end\":\r\n                value = (\"*\" + value);\r\n                break;\r\n        }\r\n\r\n        if (controller) {\r\n            controller.abort();\r\n        }\r\n        controller = new AbortController();\r\n        let signal = controller.signal;\r\n\r\n        try {\r\n            var data = await _currentLayer.toolProxification.fetchJSON(_currentLayerURL, {\r\n                data: TC.Util.WFSQueryBuilder([_currentLayerName], TC.filter.like(field, value, undefined, undefined, undefined, false), _capabilities, \"JSON\", false),\r\n                contentType: \"application/xml\",\r\n                method: \"POST\",\r\n                signal: signal\r\n            })\r\n            if (data.features && data.features.length > 0) {\r\n                var arr;\r\n                if (data.features.length === 1)\r\n                    arr = [field.split(\"/\").reduce(function (vi, va) { return vi[va.substring(va.indexOf(\":\") + 1)] }, data.features[0].properties)];\r\n                if (data.features.length > 1)\r\n                    arr = data.features.reduce(function (pv, cv) {\r\n                        if (pv && pv instanceof Array) {\r\n                            if (pv.indexOf(cv.properties[field]) < 0)\r\n                                return pv.concat(field.split(\"/\").reduce(function (vi, va) { return vi[va.substring(va.indexOf(\":\") + 1)] }, cv.properties));\r\n                            else\r\n                                return pv;\r\n                        }\r\n                    }, []);\r\n                //arr.sort();\r\n                return arr;\r\n            } else\r\n                return [];\r\n        }\r\n        catch (err) {\r\n            return null\r\n        }\r\n    };\r\n    var _autocompleteConstructor = function (control, property, listCtrl) {\r\n\r\n        TC.UI.autocomplete.call(control, {\r\n            minLength: 3,\r\n            target: listCtrl,\r\n            source: function (text, callback) {\r\n                var _self = this;\r\n                _self.target.innerHTML = '<li><a class=\"tc-ctl-search-li-loading\" href=\"#\">' + getLocaleString(\"searching\") + '<span class=\"tc-ctl-search-loading-spinner tc-ctl-search-loading\"></span></a></li>'\r\n                _self.target.classList.remove(\"tc-hidden\");\r\n                if (timerAutocomplete)\r\n                    window.clearTimeout(timerAutocomplete);\r\n                timerAutocomplete = window.setTimeout(async function () {\r\n                    var data = await _getPossibleValues(property, text)\r\n                    if (data) {\r\n                        if (data.length)\r\n                            callback(data);\r\n                        else\r\n                            _self.target.classList.add(\"tc-hidden\");\r\n                    }\r\n                }, 500);\r\n            },\r\n            callback: function (e) {\r\n                control.value = e.currentTarget.dataset[\"value\"];\r\n                this.target.classList.add(\"tc-hidden\");\r\n            },\r\n            buildHTML: function (data) {\r\n                var pattern = control.value;\r\n                this.target.style.maxHeight = \"\";\r\n                if (data.results.length > 1)\r\n                    return data.results.reduce(function (pv, cp, i) {\r\n                        return (i > 1 ? pv : _highlightText(pv, pattern)) + _highlightText(cp, pattern);\r\n                    });\r\n                else\r\n                    return _highlightText(data.results[0], pattern);\r\n            }\r\n        });\r\n        control.addEventListener(\"targetCleared.autocomplete\", function () {\r\n            listCtrl.classList.add(\"tc-hidden\");\r\n        });\r\n        control.addEventListener('keypress', function (e) {\r\n            if (e.which == 13) {\r\n                TC.UI.autocomplete.call(control, \"clear\");\r\n            }\r\n        });\r\n        control.addEventListener(\"search\", function (e) {\r\n            if (control.value.length === 0) {\r\n                TC.UI.autocomplete.call(control, \"clear\")\r\n            }\r\n        });\r\n        control.addEventListener(\"input\", function (e) {\r\n            if (control.value.length === 0) {\r\n                TC.UI.autocomplete.call(control, \"clear\")\r\n            }\r\n        });\r\n    };\r\n    var _highlightText = function (text, pattern) {\r\n        pattern = new RegExp(pattern, \"gi\");\r\n        return \"<li><a href=\\\"#\\\" data-value=\\\"\" + text + \"\\\">\" + text.replace(pattern, '<b>$&</b>') + \"</a></li>\";\r\n    };\r\n\r\n    var _select = function (feature) {\r\n        var _addFeature = function (layer, feature) {\r\n            var result\r\n            if (feature instanceof TC.feature.Point) {\r\n                result = layer.addPoint(feature.getCoords());\r\n            }\r\n            else if (feature instanceof TC.feature.Polyline) {\r\n                result = layer.addPolyline(feature.getCoords());\r\n            }\r\n            else if (feature instanceof TC.feature.Polygon) {\r\n                result = layer.addPolygon(feature.getCoords());\r\n            }\r\n            else if (feature instanceof TC.feature.MultiPolygon) {\r\n                result = layer.addMultiPolygon(feature.getCoords());\r\n            }\r\n            else if (feature instanceof TC.feature.MultiPolyline) {\r\n                result = layer.addMultiPolyline(feature.getCoords());\r\n            }\r\n            return result;\r\n        };\r\n        if (!feature.layer)\r\n            return;\r\n        var layer = feature.layer.map.getLayer(\"WFSQueryResultsHighlight\");\r\n        if (!layer) {\r\n            feature.layer.map.addLayer({\r\n                id: \"WFSQueryResultsHighlight\",\r\n                type: TC.Consts.layerType.VECTOR,\r\n                owner: self,\r\n                stealth: true,\r\n                styles: _getHighLightStyles()\r\n            }, function (layer) {\r\n                _addFeature(layer, feature);\r\n            });\r\n        }\r\n        else\r\n            _addFeature(layer, feature);\r\n    };\r\n    var _unselect = function (feature) {\r\n        var layer = feature.layer.map.getLayer(\"WFSQueryResultsHighlight\");\r\n        if (layer) {\r\n            layer.clearFeatures();\r\n        }\r\n    };\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.render.call(self, callback);\r\n        return result;\r\n    };\r\n\r\n    ctlProto.register = function (_map) {\r\n        const self = this;\r\n        map = _map;\r\n        return new Promise(function (resolve) {\r\n\r\n            _map.on(TC.Consts.event.LAYERERROR, (e) => {\r\n                if (e.layer === resultLayer) {\r\n                    modalDialog.getElementsByClassName(\"tc-modal-body\")[0].classList.remove(cssClassLoading)\r\n                    if (e.reason === TC.Consts.WFSErrors.MAX_NUM_FEATURES) {\r\n                        _showMessage(getLocaleString(\"query.msgTooManyResults\", { limit: e.data.limit }), TC.Consts.msgType.WARNING)\r\n                    }                    \r\n                    else {\r\n                        console.error(e.reason);\r\n                        _showMessage(getLocaleString(\"query.errorUndefined\"), TC.Consts.msgType.ERROR);\r\n                    }\r\n                }\r\n            })\r\n\r\n            //condición IF si una coleccion de atributos tiene 1 o mas elementos. Tiene una lista negra llamada excludedKeys\r\n            dust.helpers.countif = function (chunk, context, bodies, params) {\r\n                params = params || {};\r\n                var body = bodies.block, skip = bodies['else'], key = params[\"key\"] || context.current();\r\n                var excludedKeys = params.excludedKeys != null ? params.excludedKeys.split(',') : null;\r\n                var _count = 0\r\n                for (var k in key) {\r\n                    if (excludedKeys == null || excludedKeys.indexOf(k) < 0) {\r\n                        _count++;\r\n                    }\r\n                }\r\n                if (_count > 0) {\r\n                    chunk = chunk.render(body, context);\r\n                }\r\n                else if (skip) {\r\n                    chunk = chunk.render(skip, context);\r\n                }\r\n                return chunk;\r\n            }\r\n\r\n            if (TC._hbs) {\r\n                TC._hbs.registerHelper(\"countif\", function (obj, excludedKeys) {\r\n                    const excKeys = excludedKeys ? excludedKeys.split(',') : [];\r\n                    let _count = 0\r\n                    for (let k in obj) {\r\n                        if (excKeys.indexOf(k) < 0) {\r\n                            _count++;\r\n                        }\r\n                    }\r\n                    return _count > 0;\r\n                });\r\n            }\r\n\r\n            TC.Control.prototype.register.call(self, map).then(function (ctrl) {\r\n                var self = ctrl;\r\n                _getStyles = function () {\r\n                    var styleFN = function (geomType, property) {\r\n                        return this.options.styles && this.options.styles[geomType] ? (this.options.styles[geomType][property] || TC.Cfg.styles[geomType][property]) : TC.Cfg.styles[geomType][property]\r\n                    }\r\n                    return {\r\n                        polygon: {\r\n                            fillColor: styleFN.bind(self, 'polygon', 'fillColor'),\r\n                            fillOpacity: styleFN.bind(self, 'polygon', 'fillOpacity'),\r\n                            strokeColor: styleFN.bind(self, 'polygon', 'strokeColor'),\r\n                            strokeOpacity: styleFN.bind(self, 'polygon', 'strokeOpacity'),\r\n                            strokeWidth: styleFN.bind(self, 'polygon', 'strokeWidth')\r\n                        },\r\n                        line: {\r\n                            strokeColor: styleFN.bind(self, 'line', 'strokeColor'),\r\n                            strokeOpacity: styleFN.bind(self, 'line', 'strokeOpacity'),\r\n                            strokeWidth: styleFN.bind(self, 'line', 'strokeWidth')\r\n                        },\r\n                        point: {\r\n                            radius: styleFN.bind(self, 'point', 'radius'),\r\n                            height: styleFN.bind(self, 'point', 'height'),\r\n                            width: styleFN.bind(self, 'point', 'width'),\r\n                            fillColor: styleFN.bind(self, 'point', 'fillColor'),\r\n                            fillOpacity: styleFN.bind(self, 'point', 'fillOpacity'),\r\n                            strokeColor: styleFN.bind(self, 'point', 'strokeColor'),\r\n                            strokeWidth: styleFN.bind(self, 'point', 'strokeWidth'),\r\n                            fontSize: styleFN.bind(self, 'point', 'fontSize'),\r\n                            fontColor: styleFN.bind(self, 'point', 'fontColor'),\r\n                            labelOutlineColor: styleFN.bind(self, 'point', 'labelOutlineColor'),\r\n                            labelOutlineWidth: styleFN.bind(self, 'point', 'labelOutlineWidth'),\r\n                            label: styleFN.bind(self, 'point', 'label'),\r\n                            angle: styleFN.bind(self, 'point', 'angle')\r\n                        }\r\n                    }\r\n                };\r\n                _getHighLightStyles = function () {\r\n                    var _default = {\r\n                        \"polygon\": TC.Util.extend(true, {}, TC.Cfg.styles.polygon, {\r\n                            fillColor: \"#0099FF\",\r\n                            fillOpacity: 1,\r\n                            strokeColor: \"#0099FF\",\r\n                            strokeWidth: 2\r\n                        }),\r\n                        \"line\": TC.Util.extend(true, {}, TC.Cfg.styles.line, {\r\n                            strokeColor: \"#0099FF\",\r\n                            strokeWidth: 2\r\n                        }),\r\n                        \"point\": TC.Util.extend(true, {}, TC.Cfg.styles.point, {\r\n                            strokeColor: \"#0099FF\"\r\n                        })\r\n                    };\r\n                    return self.highlightStyles ? {\r\n                        \"polygon\": TC.Util.extend(true, {}, _default.polygon, self.highlightStyles.polygon ? self.highlightStyles.polygon : {}),\r\n                        \"line\": TC.Util.extend(true, {}, _default.line, self.highlightStyles.line ? self.highlightStyles.line : {}),\r\n                        \"point\": TC.Util.extend(true, {}, _default.point, self.highlightStyles.point ? self.highlightStyles.point : {})\r\n                    } : _default;\r\n                };\r\n\r\n                locale = map.options.locale;\r\n\r\n                getLocaleString = function (key, texts) {\r\n                    return TC.Util.getLocaleString(locale, key, texts);\r\n                }\r\n\r\n                map.ready(function () {\r\n                    map.getControlsByClass('TC.control.WorkLayerManager').forEach(function (ctl) {\r\n                        ctl.addLayerTool({\r\n                            renderFn: function (container, layerId) {\r\n                                const className = self.CLASS + '-btn-open';\r\n                                let button = container.querySelector('button.' + className);\r\n                                if (!button) {\r\n                                    const layer = map.getLayer(layerId);\r\n                                    if (layer.type === TC.Consts.layerType.WMS || layer.type === TC.Consts.layerType.WFS) {\r\n                                        const text = self.getLocaleString('query.tooltipMagnifBtn');\r\n                                        button = document.createElement('button');\r\n                                        button.innerHTML = text;\r\n                                        button.setAttribute('title', text);\r\n                                        button.classList.add(className);\r\n                                        button.dataset.layerId = layerId;\r\n                                        container.appendChild(button);\r\n                                        if (layer.type === TC.Consts.layerType.WMS) {\r\n                                            button.classList.add(TC.Consts.classes.LOADING);\r\n                                            layer.getWFSCapabilities().then((WFSCapabilities) => {\r\n                                                //check si tiene GetFeature Disponible\r\n                                                if (!WFSCapabilities.Operations.GetFeature) {\r\n                                                    button.classList.add(TC.Consts.classes.HIDDEN);\r\n                                                    return;\r\n                                                }\r\n                                                //check si las capas hijas están en capabilties WFS\r\n                                                var layers = layer.getDisgregatedLayerNames ? layer.getDisgregatedLayerNames() : layer.featureType;\r\n                                                layers = layers.filter(function (l) {\r\n                                                    return WFSCapabilities.FeatureTypes.hasOwnProperty(l.substring(l.indexOf(\":\") + 1));\r\n                                                });\r\n                                                if (!layers.length) {\r\n                                                    button.classList.add(TC.Consts.classes.HIDDEN);\r\n                                                    return;\r\n                                                }\r\n                                            }).catch(() => button.classList.add(TC.Consts.classes.HIDDEN))\r\n                                            .finally(() => button.classList.remove(TC.Consts.classes.LOADING));\r\n                                        }\r\n                                    }\r\n                                }\r\n                                return button;\r\n                            },\r\n                            updateEvents: [],\r\n                            actionFn: function () {\r\n                                const button = this;\r\n                                if (button.classList.contains('tc-unavailable') || button.classList.contains('tc-loading')) {\r\n                                    return;\r\n                                }\r\n                                const layer = self.map.getLayer(button.dataset.layerId);\r\n                                self.renderModalDialog(layer);\r\n                            }\r\n                        });\r\n                    });\r\n                });\r\n\r\n                resolve(self);\r\n            });\r\n        });\r\n    };\r\n    ctlProto.renderModalDialog = function (layer) {\r\n        const self = this;\r\n        let title;\r\n        let capabilitiesPromise;\r\n        if (layer.type === TC.Consts.layerType.WMS) {\r\n            const path = layer.getPath();\r\n            title = path[path.length - 1];\r\n            capabilitiesPromise = layer.getWFSCapabilities();\r\n        }\r\n        else if (layer.type === TC.Consts.layerType.WFS) {\r\n            title = layer.title;\r\n            capabilitiesPromise = layer.getCapabilitiesPromise();\r\n        }\r\n        else {\r\n            return;\r\n        }\r\n        let renderDialogPromise = new Promise(function (resolve, reject) {\r\n            capabilitiesPromise.then(function (capabilities) {\r\n                _renderModalDialog.apply(self, [\r\n                    layer,\r\n                    title,\r\n                    capabilities,\r\n                    function (modal) {\r\n                        resolve(modal);\r\n                    }]);\r\n            })\r\n        });\r\n\r\n        Promise.all([layer, renderDialogPromise, capabilitiesPromise]).then(_renderQueryForm);\r\n    };\r\n\r\n})();"]}