{"version":3,"sources":["control/TOC.js"],"names":["TC","control","MapContents","syncLoadJS","apiLocation","TOC","apply","this","arguments","inherit","ctlProto","prototype","CLASS","template","dust","register","body_0","chk","ctx","w","h","$key","s","get","block","body_1","__dustBody","p","rebase","getPath","x","else","body_2","f","body_3","body_4","body_5","map","self","result","call","on","Consts","event","EXTERNALSERVICEADDED","e","onExternalServiceAdded","layer","addLayer","then","updateLayerTree","addUIEventListeners","div","addEventListener","EventTarget","listenerBySelector","checkbox","target","ul","matches","parentElement","lis","i","len","children","length","child","tagName","push","li","contains","getLayer","dataset","layerId","parent","uid","layerUid","setNodeVisibility","checked","stopPropagation","MOUSEUP","blur","classList","toggle","classes","COLLAPSED","querySelector","update","_getCheckbox","getLayerUIElements","forEach","getVisibility","tree","querySelectorAll","l","getNodeVisibility","visibility","VISIBLE","NOT_VISIBLE_AT_RESOLUTION","indeterminate","HAS_VISIBLE","updateScale","elm","isVisibleByScale","isBase","options","stealth","add","HIDDEN","getRenderedHtml","layerTrees","id","out","newLi","DOMParser","parseFromString","body","firstChild","innerHTML","setAttribute","getAttribute","insertBefore","catch","err","error","wl","branch","node","leaf","removeLayer","updateLayerVisibility","isHidden","disabled","updateLayerOrder","oldIdx","newIdx","render","callback","Control","controlOptions","controls","ctl","newDiv","document","createElement","appendChild","addControl","name","Util","extend","isFunction"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapContents');\r\n}\r\n\r\nTC.control.TOC = function () {\r\n    var self = this;\r\n\r\n    TC.control.MapContents.apply(self, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.TOC, TC.control.MapContents);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.TOC.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-toc';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/TOC.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-branch'] = TC.apiLocation + \"TC/templates/TOCBranch.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-node'] = TC.apiLocation + \"TC/templates/TOCNode.html\";\r\n\r\n    var _dataKeys = {\r\n        layer: 'tcLayer',\r\n        layerUid: 'tcLayerUid'\r\n    };\r\n\r\n    var CLICKEVENT = 'click';\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.control.MapContents.prototype.register.call(self, map);\r\n\r\n        map.on(TC.Consts.event.EXTERNALSERVICEADDED, function (e) {\r\n            self.onExternalServiceAdded(e);\r\n        });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.onExternalServiceAdded = function (e) {\r\n        const self = this;\r\n        if (e && e.layer) {\r\n            e.layer.map = self.map;\r\n            self.map.addLayer(e.layer).then(function (layer) {\r\n                self.updateLayerTree(e.layer);\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.addUIEventListeners = function () {\r\n        const self = this;\r\n        self.div.addEventListener(CLICKEVENT, TC.EventTarget.listenerBySelector('input[type=checkbox]', function (e) { // No usamos TC.Consts.event.CLICK porque en iPad los eventos touchstart no van bien en los checkbox\r\n            const checkbox = e.target;\r\n            var ul = checkbox;\r\n            while (ul && !ul.matches('ul.' + self.CLASS + '-wl')) {\r\n                ul = ul.parentElement;\r\n            }\r\n            const lis = [];\r\n            for (var i = 0, len = ul.children.length; i < len; i++) {\r\n                child = ul.children[i];\r\n                if (child.tagName === 'LI') {\r\n                    lis.push(child);\r\n                }\r\n            }\r\n            for (var i = 0, len = lis.length; i < len; i++) {\r\n                const li = lis[i];\r\n                if (li.contains(checkbox)) {\r\n                    const layer = self.map.getLayer(li.dataset.layerId);\r\n                    var parent = checkbox;\r\n                    do {\r\n                        parent = parent.parentElement;\r\n                    }\r\n                    while (parent && parent.tagName !== 'LI');\r\n                    const uid = parent.dataset.layerUid;\r\n                    layer.setNodeVisibility(uid, checkbox.checked);\r\n                    break;\r\n                }\r\n            }\r\n\r\n            e.stopPropagation();\r\n        }));\r\n        self.div.addEventListener(TC.Consts.event.MOUSEUP, TC.EventTarget.listenerBySelector('button.' + self.CLASS + '-collapse-btn', function (e) {\r\n            e.target.blur();\r\n            const li = e.target.parentElement;\r\n            if (!li.classList.contains(self.CLASS + '-leaf')) {\r\n                li.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n                const ul = li.querySelector('ul');\r\n                ul.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n                e.stopPropagation();\r\n            }\r\n        }));\r\n    };\r\n\r\n    ctlProto.update = function () {\r\n        var self = this;\r\n\r\n        var _getCheckbox = function (li) {\r\n            for (var i = 0, len = li.children.length; i < len; i++) {\r\n                const child = li.children[i];\r\n                if (child.matches('input[type=checkbox]')) {\r\n                    return child;\r\n                }\r\n            }\r\n            return null;\r\n        };\r\n\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            if (layer) {\r\n                _getCheckbox(li).checked = layer.getVisibility();\r\n\r\n                layer.tree = null;\r\n\r\n                li.querySelectorAll('li').forEach(function (l) {\r\n                    const checkbox = _getCheckbox(l);\r\n                    const uid = l.dataset.layerUid;\r\n                    switch (layer.getNodeVisibility(uid)) {\r\n                        case TC.Consts.visibility.VISIBLE:\r\n                            checkbox.checked = true;\r\n                            checkbox.indeterminate = false;\r\n                            break;\r\n                        case TC.Consts.visibility.NOT_VISIBLE_AT_RESOLUTION:\r\n                            checkbox.checked = true;\r\n                            checkbox.indeterminate = false;\r\n                            break;\r\n                        case TC.Consts.visibility.HAS_VISIBLE:\r\n                            checkbox.checked = false;\r\n                            checkbox.indeterminate = true;\r\n                            break;\r\n                        default:\r\n                            checkbox.checked = false;\r\n                            checkbox.indeterminate = false;\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        self.updateScale();\r\n    };\r\n\r\n    ctlProto.updateScale = function () {\r\n        const self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            li.querySelectorAll('li').forEach(function (elm) {\r\n                const uid = elm.dataset.layerUid;\r\n                elm.classList.toggle(self.CLASS + '-node-notvisible', !layer.isVisibleByScale(uid));\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        var self = this;\r\n\r\n        if (!layer.isBase && !layer.options.stealth) {\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            self.div.querySelector('.' + self.CLASS + '-empty').classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n            self.getRenderedHtml(self.CLASS + '-branch', self.layerTrees[layer.id])\r\n                .then(function (out) {\r\n                    const parser = new DOMParser();\r\n                    const newLi = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                    const uid = newLi.dataset.layerUid;\r\n                    const li = self.div.querySelector('.' + self.CLASS + '-wl li[data-layer-uid=\"' + uid + '\"]');\r\n                    if (li) {\r\n                        li.innerHTML = newLi.innerHTML;\r\n                        li.setAttribute('class', newLi.getAttribute('class')); // Esto actualiza si un nodo deja de ser hoja o pasa a ser hoja\r\n                        if (!li.dataset.layerId) {\r\n                            li.dataset.layerId = layer.id;\r\n                        }\r\n                    }\r\n                    else {\r\n                        newLi.dataset.layerId = layer.id;\r\n                        const ul = self.div.querySelector('.' + self.CLASS + '-wl');\r\n                        ul.insertBefore(newLi, ul.firstChild);\r\n                    }\r\n                })\r\n                .catch(function (err) {\r\n                    TC.error(err);\r\n                });\r\n\r\n            var wl = 'ul.' + self.CLASS + '-wl';\r\n            var branch = 'ul.' + self.CLASS + '-branch';\r\n            var node = 'li.' + self.CLASS + '-node';\r\n            var leaf = 'li.' + self.CLASS + '-leaf';\r\n            self.div.querySelectorAll(wl + ' ' + branch + ' ' + branch + ',' + wl + ' ' + branch + ' ' + node).forEach(function (node) {\r\n                if (!node.matches(leaf)) {\r\n                    node.classList.add(TC.Consts.classes.COLLAPSED);\r\n                }\r\n            });\r\n            self.update();\r\n        }\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        if (!layer.isBase) {\r\n            TC.control.MapContents.prototype.removeLayer.call(this, layer);\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerVisibility = function (layer) {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            if (li.dataset.layerId === layer.id) {\r\n                var isHidden = !layer.getVisibility();\r\n                li.querySelectorAll('input[type=checkbox]').forEach(function (checkbox) {\r\n                    if (checkbox.matches('.' + self.CLASS + '-branch-cb')) {\r\n                        checkbox.checked = !isHidden;\r\n                    }\r\n                    else {\r\n                        checkbox.disabled = isHidden;\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.updateLayerOrder = function (layer, oldIdx, newIdx) {\r\n        // Este control no tiene que hacer nada\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n\r\n        return TC.Control.prototype.render.call(self, function () {\r\n\r\n            var controlOptions = self.options.controls || [];\r\n\r\n            if (controlOptions.length > 0) {\r\n                var ctl = controlOptions[0];\r\n                var newDiv = document.createElement(\"div\");\r\n                self.div.appendChild(newDiv);\r\n                self.map.addControl(ctl.name, TC.Util.extend({ 'div': newDiv }, ctl.options));\r\n            }\r\n\r\n            if (TC.Util.isFunction(callback)) {\r\n                callback();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getLayerUIElements = function () {\r\n        const self = this;\r\n        const result = [];\r\n        const children = self.div.querySelector('ul.' + self.CLASS + '-wl').children;\r\n        for (var i = 0, len = children.length; i < len; i++) {\r\n            child = children[i];\r\n            if (child.tagName === 'LI') {\r\n                result[result.length] = child;\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n})();\r\n"]}