{"version":3,"sources":["control/TOC.js"],"names":["TC","control","MapContents","syncLoadJS","apiLocation","TOC","apply","this","arguments","inherit","ctlProto","prototype","CLASS","template","isDebug","dust","register","body_0","chk","ctx","w","h","$key","s","get","block","body_1","__dustBody","p","rebase","getPath","x","else","body_2","f","body_3","body_4","body_5","_dataKeys","map","self","result","call","on","Consts","event","EXTERNALSERVICEADDED","e","onExternalServiceAdded","layer","addLayer","then","updateLayerTree","addUIEventListeners","div","addEventListener","EventTarget","listenerBySelector","checkbox","target","ul","matches","parentElement","lis","i","len","children","length","child","tagName","push","li","contains","$","data","parent","uid","setNodeVisibility","checked","stopPropagation","MOUSEUP","blur","classList","classes","COLLAPSED","remove","add","querySelector","update","_getCheckbox","getLayerUIElements","forEach","getVisibility","tree","querySelectorAll","l","getNodeVisibility","visibility","VISIBLE","NOT_VISIBLE_AT_RESOLUTION","indeterminate","HAS_VISIBLE","updateScale","$_li","toggleClass","isVisibleByScale","isBase","options","stealth","HIDDEN","loadJSInOrder","window","url","templating","render","layerTrees","id","err","out","newLi","DOMParser","parseFromString","body","firstChild","innerHTML","setAttribute","getAttribute","insertBefore","error","wl","branch","node","leaf","removeLayer","updateLayerVisibility","isHidden","disabled","updateLayerOrder","oldIdx","newIdx","callback","Control","controlOptions","controls","ctl","newDiv","document","createElement","appendChild","addControl","name","extend","isFunction"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapContents');\r\n}\r\n\r\nTC.control.TOC = function () {\r\n    var self = this;\r\n\r\n    TC.control.MapContents.apply(self, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.TOC, TC.control.MapContents);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.TOC.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-toc';\r\n\r\n    ctlProto.template = {};\r\n\r\n    if (TC.isDebug) {\r\n        ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/TOC.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-branch'] = TC.apiLocation + \"TC/templates/TOCBranch.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-node'] = TC.apiLocation + \"TC/templates/TOCNode.html\";\r\n    }\r\n    else {\r\n        ctlProto.template[ctlProto.CLASS] = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"worklayers\" }).w(\"</h2><div class=\\\"tc-ctl-toc-tree\\\"><div class=\\\"tc-ctl-toc-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noData\" }).w(\"</div><ul class=\\\"tc-ctl-toc-branch tc-ctl-toc-wl\\\">\").s(ctx.get([\"workLayers\"], false), ctx, { \"block\": body_1 }, {}).w(\"</ul></div>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.p(\"tc-ctl-toc-wlbranch\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_1.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-branch'] = function () { dust.register(ctlProto.CLASS + '-branch', body_0); function body_0(chk, ctx) { return chk.w(\"<li \").x(ctx.get([\"children\"], false), ctx, { \"else\": body_1, \"block\": body_2 }, {}).w(\" data-tc-layer-name=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\" data-tc-layer-uid=\\\"\").f(ctx.get([\"uid\"], false), ctx, \"h\").w(\"\\\"><button class=\\\"tc-ctl-toc-collapse-btn\\\"></button><input type=\\\"checkbox\\\" class=\\\"tc-ctl-toc-branch-cb\\\" name=\\\"toc\\\" value=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\"\").x(ctx.get([\"isVisible\"], false), ctx, { \"block\": body_3 }, {}).w(\" /><span>\").f(ctx.get([\"title\"], false), ctx, \"h\").w(\"</span><ul class=\\\"tc-ctl-toc-branch\\\">\").s(ctx.get([\"children\"], false), ctx, { \"block\": body_4 }, {}).w(\"</ul></li>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-toc-node tc-ctl-toc-leaf\\\"\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-toc-node\\\"\"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.w(\" checked\"); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.p(\"tc-ctl-toc-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_4.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-node'] = function () { dust.register(ctlProto.CLASS + '-node', body_0); function body_0(chk, ctx) { return chk.w(\"<li \").x(ctx.get([\"children\"], false), ctx, { \"else\": body_1, \"block\": body_2 }, {}).w(\" data-tc-layer-name=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\" data-tc-layer-uid=\\\"\").f(ctx.get([\"uid\"], false), ctx, \"h\").w(\"\\\">\").x(ctx.get([\"children\"], false), ctx, { \"block\": body_3 }, {}).w(\"<input type=\\\"checkbox\\\" name=\\\"toc\\\" value=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\"\").x(ctx.get([\"isVisible\"], false), ctx, { \"block\": body_4 }, {}).w(\" /><span>\").f(ctx.get([\"title\"], false), ctx, \"h\").w(\"</span><ul class=\\\"tc-ctl-toc-branch\\\">\").s(ctx.get([\"children\"], false), ctx, { \"block\": body_5 }, {}).w(\"</ul></li>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-toc-node tc-ctl-toc-leaf\\\"\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-toc-node\\\"\"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.w(\"<button class=\\\"tc-ctl-toc-collapse-btn\\\"></button>\"); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.w(\" checked\"); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.p(\"tc-ctl-toc-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_5.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    var _dataKeys = {\r\n        layer: 'tcLayer',\r\n        layerUid: 'tcLayerUid'\r\n    };\r\n\r\n    var CLICKEVENT = 'click';\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.control.MapContents.prototype.register.call(self, map);\r\n\r\n        map.on(TC.Consts.event.EXTERNALSERVICEADDED, function (e) {\r\n            self.onExternalServiceAdded.call(self, e, this);\r\n        });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.onExternalServiceAdded = function (e, map) {\r\n        const self = this;\r\n        if (e && e.layer) {\r\n            e.layer.map = map;\r\n            map.addLayer(e.layer).then(function (layer) {\r\n                self.updateLayerTree(e.layer);\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.addUIEventListeners = function () {\r\n        var self = this;\r\n        self.div.addEventListener(CLICKEVENT, TC.EventTarget.listenerBySelector('input[type=checkbox]', function (e) { // No usamos TC.Consts.event.CLICK porque en iPad los eventos touchstart no van bien en los checkbox\r\n            const checkbox = e.target;\r\n            var ul = checkbox;\r\n            while (ul && !ul.matches('ul.' + self.CLASS + '-wl')) {\r\n                ul = ul.parentElement;\r\n            }\r\n            const lis = [];\r\n            for (var i = 0, len = ul.children.length; i < len; i++) {\r\n                child = ul.children[i];\r\n                if (child.tagName === 'LI') {\r\n                    lis.push(child);\r\n                }\r\n            }\r\n            for (var i = 0, len = lis.length; i < len; i++) {\r\n                const li = lis[i];\r\n                if (li.contains(checkbox)) {\r\n                    const layer = $(li).data(_dataKeys.layer);\r\n                    var parent = checkbox;\r\n                    do {\r\n                        parent = parent.parentElement;\r\n                    }\r\n                    while (parent && parent.tagName !== 'LI');\r\n                    const uid = $(parent).data(_dataKeys.layerUid)\r\n                    layer.setNodeVisibility(uid, checkbox.checked);\r\n                    break;\r\n                }\r\n            }\r\n\r\n            e.stopPropagation();\r\n        }));\r\n        self.div.addEventListener(TC.Consts.event.MOUSEUP, TC.EventTarget.listenerBySelector('button.' + self.CLASS + '-collapse-btn', function (e) {\r\n            e.target.blur();\r\n            const li = e.target.parentElement;\r\n            if (!li.classList.contains(self.CLASS + '-leaf')) {\r\n                if (li.classList.contains(TC.Consts.classes.COLLAPSED)) {\r\n                    li.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                }\r\n                else {\r\n                    li.classList.add(TC.Consts.classes.COLLAPSED);\r\n                }\r\n                const ul = li.querySelector('ul');\r\n                if (ul.classList.contains(TC.Consts.classes.COLLAPSED)) {\r\n                    ul.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                }\r\n                else {\r\n                    ul.classList.add(TC.Consts.classes.COLLAPSED);\r\n                }\r\n                e.stopPropagation();\r\n            }\r\n        }));\r\n    };\r\n\r\n    ctlProto.update = function () {\r\n        var self = this;\r\n\r\n        var _getCheckbox = function (li) {\r\n            for (var i = 0, len = li.children.length; i < len; i++) {\r\n                const child = li.children[i];\r\n                if (child.matches('input[type=checkbox]')) {\r\n                    return child;\r\n                }\r\n            }\r\n            return null;\r\n        };\r\n\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            var layer = $(li).data(_dataKeys.layer);\r\n            if (layer) {\r\n                _getCheckbox(li).checked = layer.getVisibility();\r\n\r\n                layer.tree = null;\r\n\r\n                li.querySelectorAll('li').forEach(function (l) {\r\n                    const checkbox = _getCheckbox(l);\r\n                    var uid = $(l).data(_dataKeys.layerUid);\r\n                    switch (layer.getNodeVisibility(uid)) {\r\n                        case TC.Consts.visibility.VISIBLE:\r\n                            checkbox.checked = true;\r\n                            checkbox.indeterminate = false;\r\n                            break;\r\n                        case TC.Consts.visibility.NOT_VISIBLE_AT_RESOLUTION:\r\n                            checkbox.checked = true;\r\n                            checkbox.indeterminate = false;\r\n                            break;\r\n                        case TC.Consts.visibility.HAS_VISIBLE:\r\n                            checkbox.checked = false;\r\n                            checkbox.indeterminate = true;\r\n                            break;\r\n                        default:\r\n                            checkbox.checked = false;\r\n                            checkbox.indeterminate = false;\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        self.updateScale();\r\n    };\r\n\r\n    ctlProto.updateScale = function () {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            var layer = $(li).data(_dataKeys.layer);\r\n            li.querySelectorAll('li').forEach(function (i, e) {\r\n                var $_li = $(e);\r\n                $_li.toggleClass(self.CLASS + '-node-notvisible', !layer.isVisibleByScale($_li.data(_dataKeys.layerUid)));\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        var self = this;\r\n\r\n        if (!layer.isBase && !layer.options.stealth) {\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            self.div.querySelector('.' + self.CLASS + '-empty').classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n            var template = self.CLASS + '-branch';\r\n            TC.loadJSInOrder(\r\n                !window.dust,\r\n                TC.url.templating,\r\n                function () {\r\n                    dust.render(template, self.layerTrees[layer.id], function (err, out) {\r\n                        const parser = new DOMParser();\r\n                        const newLi = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                        const uid = $(newLi).data(_dataKeys.layerUid);\r\n                        const li = self.div.querySelector('.' + self.CLASS + '-wl li[data-tc-layer-uid=\"' + uid + '\"]');\r\n                        if (li) {\r\n                            li.innerHTML = newLi.innerHTML;\r\n                            li.setAttribute('class', newLi.getAttribute('class')); // Esto actualiza si un nodo deja de ser hoja o pasa a ser hoja\r\n                            if (!$(li).data(_dataKeys.layer)) {\r\n                                $(li).data(_dataKeys.layer, layer);\r\n                            }\r\n                        }\r\n                        else {\r\n                            $(newLi).data(_dataKeys.layer, layer);\r\n                            const ul = self.div.querySelector('.' + self.CLASS + '-wl');\r\n                            ul.insertBefore(newLi, ul.firstChild);\r\n                        }\r\n                        if (err) {\r\n                            TC.error(err);\r\n                        }\r\n                    });\r\n                    var wl = 'ul.' + self.CLASS + '-wl';\r\n                    var branch = 'ul.' + self.CLASS + '-branch';\r\n                    var node = 'li.' + self.CLASS + '-node';\r\n                    var leaf = 'li.' + self.CLASS + '-leaf';\r\n                    self.div.querySelectorAll(wl + ' ' + branch + ' ' + branch + ',' + wl + ' ' + branch + ' ' + node).forEach(function (node) {\r\n                        if (!node.matches(leaf)) {\r\n                            node.classList.add(TC.Consts.classes.COLLAPSED);\r\n                        }\r\n                    });\r\n                    self.update();\r\n                }\r\n            );\r\n        }\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        if (!layer.isBase) {\r\n            TC.control.MapContents.prototype.removeLayer.call(this, layer);\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerVisibility = function (layer) {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            if ($(li).data(_dataKeys.layer) === layer) {\r\n                var isHidden = !layer.getVisibility();\r\n                li.querySelectorAll('input[type=checkbox]').forEach(function (checkbox) {\r\n                    if (checkbox.matches('.' + self.CLASS + '-branch-cb')) {\r\n                        checkbox.checked = !isHidden;\r\n                    }\r\n                    else {\r\n                        checkbox.disabled = isHidden;\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.updateLayerOrder = function (layer, oldIdx, newIdx) {\r\n        // Este control no tiene que hacer nada\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n\r\n        return TC.Control.prototype.render.call(self, function () {\r\n\r\n            var controlOptions = self.options.controls || [];\r\n\r\n            if (controlOptions.length > 0) {\r\n                var ctl = controlOptions[0];\r\n                var newDiv = document.createElement(\"div\");\r\n                self.div.appendChild(newDiv);\r\n                self.map.addControl(ctl.name, $.extend({ 'div': newDiv }, ctl.options));\r\n            }\r\n\r\n            if ($.isFunction(callback)) {\r\n                callback();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getLayerUIElements = function () {\r\n        const self = this;\r\n        const result = [];\r\n        const children = self.div.querySelector('ul.' + self.CLASS + '-wl').children;\r\n        for (var i = 0, len = children.length; i < len; i++) {\r\n            child = children[i];\r\n            if (child.tagName === 'LI') {\r\n                result[result.length] = child;\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n})();\r\n"],"file":"../../control/TOC.min.js"}