{"version":3,"sources":["control/TOC.js"],"names":["TC","control","MapContents","syncLoadJS","apiLocation","TOC","apply","this","arguments","inherit","ctlProto","prototype","CLASS","template","isDebug","dust","register","body_0","chk","ctx","w","h","$key","s","get","block","body_1","__dustBody","p","rebase","getPath","x","else","body_2","f","body_3","body_4","body_5","map","self","result","call","on","Consts","event","EXTERNALSERVICEADDED","e","onExternalServiceAdded","layer","addLayer","then","updateLayerTree","addUIEventListeners","div","addEventListener","EventTarget","listenerBySelector","checkbox","target","ul","matches","parentElement","lis","i","len","children","length","child","tagName","push","li","contains","getLayer","dataset","layerId","parent","uid","layerUid","setNodeVisibility","checked","stopPropagation","MOUSEUP","blur","classList","toggle","classes","COLLAPSED","querySelector","update","_getCheckbox","getLayerUIElements","forEach","getVisibility","tree","querySelectorAll","l","getNodeVisibility","visibility","VISIBLE","NOT_VISIBLE_AT_RESOLUTION","indeterminate","HAS_VISIBLE","updateScale","elm","isVisibleByScale","isBase","options","stealth","add","HIDDEN","loadJSInOrder","window","url","templating","render","layerTrees","id","err","out","newLi","DOMParser","parseFromString","body","firstChild","innerHTML","setAttribute","getAttribute","insertBefore","error","wl","branch","node","leaf","removeLayer","updateLayerVisibility","isHidden","disabled","updateLayerOrder","oldIdx","newIdx","callback","Control","controlOptions","controls","ctl","newDiv","document","createElement","appendChild","addControl","name","Util","extend","isFunction"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapContents');\r\n}\r\n\r\nTC.control.TOC = function () {\r\n    var self = this;\r\n\r\n    TC.control.MapContents.apply(self, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.TOC, TC.control.MapContents);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.TOC.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-toc';\r\n\r\n    ctlProto.template = {};\r\n\r\n    if (TC.isDebug) {\r\n        ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/TOC.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-branch'] = TC.apiLocation + \"TC/templates/TOCBranch.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-node'] = TC.apiLocation + \"TC/templates/TOCNode.html\";\r\n    }\r\n    else {\r\n        ctlProto.template[ctlProto.CLASS] = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"worklayers\" }).w(\"</h2><div class=\\\"tc-ctl-toc-tree\\\"><div class=\\\"tc-ctl-toc-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noData\" }).w(\"</div><ul class=\\\"tc-ctl-toc-branch tc-ctl-toc-wl\\\">\").s(ctx.get([\"workLayers\"], false), ctx, { \"block\": body_1 }, {}).w(\"</ul></div>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.p(\"tc-ctl-toc-wlbranch\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_1.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-branch'] = function () { dust.register(ctlProto.CLASS + '-branch', body_0); function body_0(chk, ctx) { return chk.w(\"<li \").x(ctx.get([\"children\"], false), ctx, { \"else\": body_1, \"block\": body_2 }, {}).w(\" data-layer-name=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\" data-layer-uid=\\\"\").f(ctx.get([\"uid\"], false), ctx, \"h\").w(\"\\\"><button class=\\\"tc-ctl-toc-collapse-btn\\\"></button><input type=\\\"checkbox\\\" class=\\\"tc-ctl-toc-branch-cb\\\" name=\\\"toc\\\" value=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\"\").x(ctx.get([\"isVisible\"], false), ctx, { \"block\": body_3 }, {}).w(\" /><span>\").f(ctx.get([\"title\"], false), ctx, \"h\").w(\"</span><ul class=\\\"tc-ctl-toc-branch\\\">\").s(ctx.get([\"children\"], false), ctx, { \"block\": body_4 }, {}).w(\"</ul></li>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-toc-node tc-ctl-toc-leaf\\\"\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-toc-node\\\"\"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.w(\" checked\"); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.p(\"tc-ctl-toc-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_4.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-node'] = function () { dust.register(ctlProto.CLASS + '-node', body_0); function body_0(chk, ctx) { return chk.w(\"<li \").x(ctx.get([\"children\"], false), ctx, { \"else\": body_1, \"block\": body_2 }, {}).w(\" data-layer-name=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\" data-layer-uid=\\\"\").f(ctx.get([\"uid\"], false), ctx, \"h\").w(\"\\\">\").x(ctx.get([\"children\"], false), ctx, { \"block\": body_3 }, {}).w(\"<input type=\\\"checkbox\\\" name=\\\"toc\\\" value=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\"\").x(ctx.get([\"isVisible\"], false), ctx, { \"block\": body_4 }, {}).w(\" /><span>\").f(ctx.get([\"title\"], false), ctx, \"h\").w(\"</span><ul class=\\\"tc-ctl-toc-branch\\\">\").s(ctx.get([\"children\"], false), ctx, { \"block\": body_5 }, {}).w(\"</ul></li>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-toc-node tc-ctl-toc-leaf\\\"\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.w(\"class=\\\"tc-ctl-toc-node\\\"\"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.w(\"<button class=\\\"tc-ctl-toc-collapse-btn\\\"></button>\"); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.w(\" checked\"); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.p(\"tc-ctl-toc-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_5.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    var _dataKeys = {\r\n        layer: 'tcLayer',\r\n        layerUid: 'tcLayerUid'\r\n    };\r\n\r\n    var CLICKEVENT = 'click';\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.control.MapContents.prototype.register.call(self, map);\r\n\r\n        map.on(TC.Consts.event.EXTERNALSERVICEADDED, function (e) {\r\n            self.onExternalServiceAdded(e);\r\n        });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.onExternalServiceAdded = function (e) {\r\n        const self = this;\r\n        if (e && e.layer) {\r\n            e.layer.map = self.map;\r\n            self.map.addLayer(e.layer).then(function (layer) {\r\n                self.updateLayerTree(e.layer);\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.addUIEventListeners = function () {\r\n        const self = this;\r\n        self.div.addEventListener(CLICKEVENT, TC.EventTarget.listenerBySelector('input[type=checkbox]', function (e) { // No usamos TC.Consts.event.CLICK porque en iPad los eventos touchstart no van bien en los checkbox\r\n            const checkbox = e.target;\r\n            var ul = checkbox;\r\n            while (ul && !ul.matches('ul.' + self.CLASS + '-wl')) {\r\n                ul = ul.parentElement;\r\n            }\r\n            const lis = [];\r\n            for (var i = 0, len = ul.children.length; i < len; i++) {\r\n                child = ul.children[i];\r\n                if (child.tagName === 'LI') {\r\n                    lis.push(child);\r\n                }\r\n            }\r\n            for (var i = 0, len = lis.length; i < len; i++) {\r\n                const li = lis[i];\r\n                if (li.contains(checkbox)) {\r\n                    const layer = self.map.getLayer(li.dataset.layerId);\r\n                    var parent = checkbox;\r\n                    do {\r\n                        parent = parent.parentElement;\r\n                    }\r\n                    while (parent && parent.tagName !== 'LI');\r\n                    const uid = parent.dataset.layerUid;\r\n                    layer.setNodeVisibility(uid, checkbox.checked);\r\n                    break;\r\n                }\r\n            }\r\n\r\n            e.stopPropagation();\r\n        }));\r\n        self.div.addEventListener(TC.Consts.event.MOUSEUP, TC.EventTarget.listenerBySelector('button.' + self.CLASS + '-collapse-btn', function (e) {\r\n            e.target.blur();\r\n            const li = e.target.parentElement;\r\n            if (!li.classList.contains(self.CLASS + '-leaf')) {\r\n                li.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n                const ul = li.querySelector('ul');\r\n                ul.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n                e.stopPropagation();\r\n            }\r\n        }));\r\n    };\r\n\r\n    ctlProto.update = function () {\r\n        var self = this;\r\n\r\n        var _getCheckbox = function (li) {\r\n            for (var i = 0, len = li.children.length; i < len; i++) {\r\n                const child = li.children[i];\r\n                if (child.matches('input[type=checkbox]')) {\r\n                    return child;\r\n                }\r\n            }\r\n            return null;\r\n        };\r\n\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            if (layer) {\r\n                _getCheckbox(li).checked = layer.getVisibility();\r\n\r\n                layer.tree = null;\r\n\r\n                li.querySelectorAll('li').forEach(function (l) {\r\n                    const checkbox = _getCheckbox(l);\r\n                    const uid = l.dataset.layerUid;\r\n                    switch (layer.getNodeVisibility(uid)) {\r\n                        case TC.Consts.visibility.VISIBLE:\r\n                            checkbox.checked = true;\r\n                            checkbox.indeterminate = false;\r\n                            break;\r\n                        case TC.Consts.visibility.NOT_VISIBLE_AT_RESOLUTION:\r\n                            checkbox.checked = true;\r\n                            checkbox.indeterminate = false;\r\n                            break;\r\n                        case TC.Consts.visibility.HAS_VISIBLE:\r\n                            checkbox.checked = false;\r\n                            checkbox.indeterminate = true;\r\n                            break;\r\n                        default:\r\n                            checkbox.checked = false;\r\n                            checkbox.indeterminate = false;\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        self.updateScale();\r\n    };\r\n\r\n    ctlProto.updateScale = function () {\r\n        const self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            li.querySelectorAll('li').forEach(function (elm) {\r\n                const uid = elm.dataset.layerUid;\r\n                elm.classList.toggle(self.CLASS + '-node-notvisible', !layer.isVisibleByScale(uid));\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        var self = this;\r\n\r\n        if (!layer.isBase && !layer.options.stealth) {\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            self.div.querySelector('.' + self.CLASS + '-empty').classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n            var template = self.CLASS + '-branch';\r\n            TC.loadJSInOrder(\r\n                !window.dust,\r\n                TC.url.templating,\r\n                function () {\r\n                    dust.render(template, self.layerTrees[layer.id], function (err, out) {\r\n                        const parser = new DOMParser();\r\n                        const newLi = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                        const uid = newLi.dataset.layerUid;\r\n                        const li = self.div.querySelector('.' + self.CLASS + '-wl li[data-layer-uid=\"' + uid + '\"]');\r\n                        if (li) {\r\n                            li.innerHTML = newLi.innerHTML;\r\n                            li.setAttribute('class', newLi.getAttribute('class')); // Esto actualiza si un nodo deja de ser hoja o pasa a ser hoja\r\n                            if (!li.dataset.layerId) {\r\n                                li.dataset.layerId = layer.id;\r\n                            }\r\n                        }\r\n                        else {\r\n                            newLi.dataset.layerId = layer.id;\r\n                            const ul = self.div.querySelector('.' + self.CLASS + '-wl');\r\n                            ul.insertBefore(newLi, ul.firstChild);\r\n                        }\r\n                        if (err) {\r\n                            TC.error(err);\r\n                        }\r\n                    });\r\n                    var wl = 'ul.' + self.CLASS + '-wl';\r\n                    var branch = 'ul.' + self.CLASS + '-branch';\r\n                    var node = 'li.' + self.CLASS + '-node';\r\n                    var leaf = 'li.' + self.CLASS + '-leaf';\r\n                    self.div.querySelectorAll(wl + ' ' + branch + ' ' + branch + ',' + wl + ' ' + branch + ' ' + node).forEach(function (node) {\r\n                        if (!node.matches(leaf)) {\r\n                            node.classList.add(TC.Consts.classes.COLLAPSED);\r\n                        }\r\n                    });\r\n                    self.update();\r\n                }\r\n            );\r\n        }\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        if (!layer.isBase) {\r\n            TC.control.MapContents.prototype.removeLayer.call(this, layer);\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerVisibility = function (layer) {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            if (li.dataset.layerId === layer.id) {\r\n                var isHidden = !layer.getVisibility();\r\n                li.querySelectorAll('input[type=checkbox]').forEach(function (checkbox) {\r\n                    if (checkbox.matches('.' + self.CLASS + '-branch-cb')) {\r\n                        checkbox.checked = !isHidden;\r\n                    }\r\n                    else {\r\n                        checkbox.disabled = isHidden;\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.updateLayerOrder = function (layer, oldIdx, newIdx) {\r\n        // Este control no tiene que hacer nada\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n\r\n        return TC.Control.prototype.render.call(self, function () {\r\n\r\n            var controlOptions = self.options.controls || [];\r\n\r\n            if (controlOptions.length > 0) {\r\n                var ctl = controlOptions[0];\r\n                var newDiv = document.createElement(\"div\");\r\n                self.div.appendChild(newDiv);\r\n                self.map.addControl(ctl.name, TC.Util.extend({ 'div': newDiv }, ctl.options));\r\n            }\r\n\r\n            if (TC.Util.isFunction(callback)) {\r\n                callback();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getLayerUIElements = function () {\r\n        const self = this;\r\n        const result = [];\r\n        const children = self.div.querySelector('ul.' + self.CLASS + '-wl').children;\r\n        for (var i = 0, len = children.length; i < len; i++) {\r\n            child = children[i];\r\n            if (child.tagName === 'LI') {\r\n                result[result.length] = child;\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n})();\r\n"]}