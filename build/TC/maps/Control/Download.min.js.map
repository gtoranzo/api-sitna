{"version":3,"sources":["control/Download.js"],"names":["TC","control","MapInfo","syncLoadJS","apiLocation","filter","Download","options","this","_classSelector","CLASS","Control","apply","arguments","_hiddenElms","opts","_dialogDiv","Util","getDiv","dialogDiv","window","$","_$dialogDiv","document","body","appendChild","inherit","ctlProto","prototype","template","isDebug","dust","register","body_0","chk","ctx","w","h","$key","__dustBody","render","callback","self","getRenderedHtml","html","innerHTML","then","call","cs","_selectors","TAB","RADIOBUTTON","ELEMENT","clickHandler","e","tab","matches","parentElement","checkbox","querySelector","newValue","value","elms","div","querySelectorAll","_oldValue","deselectable","setTimeout","checked","_activeElm","forEach","elm","push","classList","add","Consts","classes","COLLAPSED","remove","span","addEventListener","event","CLICK","map","result","mustBeExportable","_showAlertMsg","error","wait","alert","errorMsg","key","WFSErrors","NumMaxFeatures","format","serviceName","params","serviceTitle","NoLayers","getLocaleString","GetCapabilities","NoFeatures","Indeterminate","toast","type","msgType","ERROR","err","descripcion","errorThrown","msgErrorMode","CONSOLE","getLoadingIndicator","removeWait","WARNING","EventTarget","listenerBySelector","addWait","indexOf","Promise","resolve","reject","canvas","wrap","getViewport","synchronous","getElementsByTagName","newCanvas","cloneCanvas","getControlsByClass","ScaleBar","drawScaleBarIntoCanvas","fill","codeContainerId","codeContainer","getElementById","createElement","setAttribute","style","top","left","position","makeQRCode","qrCodeBase64","getContext","fillStyle","fillRect","width","height","addToCanvas","x","y","mapCanvas","_canvas","res","toDataURL","downloadDataURI","location","hostname","getFormattedDate","Date","toString","split","message","extent","getExtent","arrPromises","WFSGetFeatureBuilder","bbox","getCRS","all","responseArray","responses","item","length","arrDownloads","i","errors","j","data","url","downloadFileForm","evt","stopPropagation","showModal","target","generateLink","HIDDEN","registerListeners","manageMaxLengthExceed","maxLengthExceed","toggle","qr"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapInfo) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapInfo');\r\n}\r\n\r\nif (!TC.filter) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Filter');\r\n}\r\n\r\nTC.control.Download = function (options) {\r\n    var self = this;\r\n    self._classSelector = '.' + self.CLASS;\r\n\r\n    TC.Control.apply(self, arguments);\r\n\r\n    self._hiddenElms = [];\r\n\r\n    var opts = options || {};\r\n    self._dialogDiv = TC.Util.getDiv(opts.dialogDiv);\r\n    if (window.$) {\r\n        self._$dialogDiv = $(self._dialogDiv);\r\n    }\r\n    if (!opts.dialogDiv) {\r\n        document.body.appendChild(self._dialogDiv);\r\n    }    \r\n};\r\n\r\nTC.inherit(TC.control.Download, TC.control.MapInfo);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Download.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-download';\r\n\r\n    ctlProto.template = {};\r\n\r\n    if (TC.isDebug) {\r\n        ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/Download.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/DownloadDialog.html\";\r\n    } else {\r\n        ctlProto.template[ctlProto.CLASS] = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"download\" }).w(\" </h2><div class=\\\"tc-ctl-tctr tc-ctl-tctr-select\\\"><form><label class=\\\"tc-ctl-tctr-tab tc-ctl-download-image\\\" style=\\\"width:calc(100%/2 - 1px)\\\"><input type=\\\"radio\\\" name=\\\"sctnr-sel\\\" value=\\\"image\\\" /><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"dl.export.map\" }).w(\"</span></label><label class=\\\"tc-ctl-tctr-tab tc-ctl-download-data\\\" style=\\\"width:calc(100%/2 - 1px)\\\"><input type=\\\"radio\\\" name=\\\"sctnr-sel\\\" value=\\\"data\\\" /><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"dl.export.vector\" }).w(\"</span></label></form></div><div class=\\\"tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-image tc-group tc-ctl-download-cnt tc-ctl-download-image tc-collapsed\\\"><div><label>\").h(\"i18n\", ctx, {}, { \"$key\": \"format\" }).w(\":</label><select id=\\\"download-format-image\\\" class=\\\"tc-combo\\\"><option value=\\\"image/png\\\">PNG</option><option value=\\\"image/jpeg\\\">JPEG</option></select><div class=\\\"tc-ctl-download-div\\\"><input id=\\\"tc-ctl-download-image-qr\\\" class=\\\"tc-hidden\\\" type=\\\"checkbox\\\" checked style=\\\"display:none;\\\" /><label for=\\\"tc-ctl-download-image-qr\\\" class=\\\"tc-ctl-download-image-qr-label\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"createQrCodeToImage\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"appendQRCode\" }).w(\"</label></div><div class=\\\"tc-group tc-group tc-ctl-download-cnt\\\" style=\\\"text-align:right;\\\"><button type=\\\"button\\\" class=\\\"tc-ctl-download-btn tc-button tc-icon-button\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"downloadImageFromCurrentMap\" }).w(\"\\\" name=\\\"descargar\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"download\" }).w(\"</button></div><div class=\\\"tc-ctl-download-alert tc-alert alert-warning tc-hidden\\\"><p>\").h(\"i18n\", ctx, {}, { \"$key\": \"qrAdvice|s\" }).w(\"</p></div></div></div><div class=\\\"tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-data tc-group tc-ctl-download-cnt tc-collapsed\\\"><div><label>\").h(\"i18n\", ctx, {}, { \"$key\": \"format\" }).w(\":</label><select id=\\\"download-format\\\" class=\\\"tc-combo\\\"><option value=\\\"GML32\\\">GML</option><option value=\\\"application/json\\\">GeoJSON</option><option value=\\\"application/vnd.google-earth.kml+xml\\\">KML (Google Earth)</option><option value=\\\"shape-zip\\\">Shape (ESRI)</option></select><div class=\\\"tc-ctl-download-div\\\"><i class=\\\"tc-ctl-download-help icon-question-sign\\\" data-toggle=\\\"tooltip\\\" data-placement=\\\"top\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"showDownloadHelp\" }).w(\"\\\"></i></div><div class=\\\"tc-group tc-group tc-ctl-download-cnt\\\" style=\\\"text-align:right;\\\"><button type=\\\"button\\\" class=\\\"tc-ctl-download-btn tc-button tc-icon-button\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"downloadLayersFromCurrentExtent\" }).w(\"\\\" name=\\\"descargar\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"download\" }).w(\"</button></div><div class=\\\"tc-alert alert-warning tc-hidden\\\"><p id=\\\"zoom-msg\\\"><strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"tooManyFeatures\" }).w(\": </strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"tooManyFeatures.instructions\" }).w(\"</p><p id=\\\"layers-msg\\\"><strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"noLayersLoaded\" }).w(\": </strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"noLayersLoaded.instructions\" }).w(\"</p><p id=\\\"url-msg\\\"><strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"tooManySelectedLayers\" }).w(\": </strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"tooManySelectedLayers.instructions\" }).w(\"</p><p id=\\\"noFeatures-msg\\\"><strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"noData\" }).w(\": </strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"noData.instructions\" }).w(\"</p><p id=\\\"novalid-msg\\\"><strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"noValidService\" }).w(\": </strong>\").h(\"i18n\", ctx, {}, { \"$key\": \"noValidService.instructions\" }).w(\"</p></div></div></div>\"); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-dialog'] = function () { dust.register(ctlProto.CLASS + '-dialog', body_0); function body_0(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-download-help-dialog tc-modal\\\"><div class=\\\"tc-modal-background tc-modal-close\\\"></div><div class=\\\"tc-modal-window\\\"><div class=\\\"tc-modal-header\\\"><h3>\").h(\"i18n\", ctx, {}, { \"$key\": \"downloadData\" }).w(\"</h3><div class=\\\"tc-modal-close\\\"></div></div><div class=\\\"tc-modal-body\\\"><p>\").h(\"i18n\", ctx, {}, { \"$key\": \"dl.instructions.1|s\" }).w(\"</p><ul><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"dl.instructions.2|s\" }).w(\"</li><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"dl.instructions.3|s\" }).w(\"</li><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"dl.instructions.4|s\" }).w(\"<ul><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"dl.instructions.5|s\" }).w(\"</li><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"dl.instructions.6|s\" }).w(\"</li></ul></li></ul></div><div class=\\\"tc-modal-footer\\\"><button type=\\\"button\\\" class=\\\"tc-button tc-modal-close\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"close\" }).w(\"</button></div></div></div>\"); } body_0.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        return self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n        }).then(function () {\r\n            return TC.Control.prototype.render.call(self, function () {\r\n\r\n                const cs = '.tc-ctl-tctr';\r\n                self._selectors = {\r\n                    TAB: cs + '-tab',\r\n                    RADIOBUTTON: 'input[type=radio][name=sctnr-sel]',\r\n                    ELEMENT: cs + '-elm'\r\n                };\r\n\r\n                const clickHandler = function (e) {\r\n                    var tab = this;\r\n                    while (tab && !tab.matches(self._selectors.TAB)) {\r\n                        tab = tab.parentElement;\r\n                    }\r\n                    if (tab) {\r\n                        const checkbox = tab.querySelector(self._selectors.RADIOBUTTON);\r\n                        const newValue = checkbox.value;\r\n                        const elms = self.div.querySelectorAll(self._selectors.ELEMENT);\r\n                        if (self._oldValue === newValue && self.options.deselectable) {\r\n                            setTimeout(function () {\r\n                                checkbox.checked = false;\r\n                            }, 0);\r\n                            self._oldValue = null;\r\n                            self._activeElm = null;\r\n                            elms.forEach(function (elm) {\r\n                                self._hiddenElms.push(elm);\r\n                            });\r\n                        }\r\n                        else {\r\n                            elms.forEach(function (elm) {\r\n                                if (elm.matches(self._selectors.ELEMENT + '-' + newValue)) {\r\n                                    self._activeElm = elm;\r\n                                }\r\n                                else {\r\n                                    self._hiddenElms.push(elm);\r\n                                }\r\n                            });\r\n                            self._oldValue = newValue;\r\n                        }\r\n\r\n                        self._hiddenElms.forEach(function (elm) {\r\n                            elm.classList.add(TC.Consts.classes.COLLAPSED);\r\n                        });\r\n                        if (self._activeElm) {\r\n                            self._activeElm.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                        }\r\n                        checkbox.checked = true;\r\n                    }\r\n                };\r\n\r\n                self.div.querySelectorAll('span').forEach(function (span) {\r\n                    span.addEventListener(TC.Consts.event.CLICK, clickHandler);\r\n                });\r\n                if (callback) {\r\n                    callback();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        var self = this;\r\n        const result = TC.control.MapInfo.prototype.register.call(self, map);\r\n\r\n        // GLS: Añado el flag al mapa para tenerlo en cuenta cuando se establece la función de carga de imágenes\r\n        self.map.mustBeExportable = true;\r\n\r\n        /**\r\n         * Descarga las features de las capas de trabajo actualmente seleccionadas. Comprueba que el número de features a descargar\r\n         * no excede el límite impuesto por el servidor.\r\n         */       \r\n\r\n        var _download = function () {\r\n            var wait = self.map.getLoadingIndicator().addWait();\r\n\r\n            var format = '';\r\n            if (self._activeElm) {\r\n                format = self._activeElm.querySelector('select').value;\r\n            }\r\n            if (format.indexOf('image') > -1) {\r\n                const doneQR = new Promise(function (resolve, reject) {\r\n                    var canvas = self.map.wrap.getViewport({ synchronous: true }).getElementsByTagName('canvas')[0];\r\n                    var newCanvas = TC.Util.cloneCanvas(canvas);\r\n\r\n                    var sb = self.map.getControlsByClass(TC.control.ScaleBar);\r\n                    if (sb) {\r\n                        self.drawScaleBarIntoCanvas({ canvas: newCanvas, fill: true });\r\n                    }\r\n\r\n                    if (self._activeElm.querySelector('#' + self.CLASS + '-image-qr:checked')) {\r\n                        const codeContainerId = 'qrcode';\r\n                        var codeContainer = document.getElementById(codeContainerId);\r\n                        if (codeContainer) {\r\n                            codeContainer.innerHTML = '';\r\n                        }\r\n                        else {\r\n                            codeContainer = document.createElement('div');\r\n                            codeContainer.setAttribute('id', codeContainerId);\r\n                            document.body.appendChild(codeContainer);\r\n                        }\r\n\r\n                        codeContainer.style.top = '-200px';\r\n                        codeContainer.style.left = '-200px';\r\n                        codeContainer.style.position = 'absolute';\r\n\r\n                        self.makeQRCode(codeContainer, 87, 87).then(function (qrCodeBase64) {\r\n                            if (qrCodeBase64) {\r\n                                var ctx = newCanvas.getContext(\"2d\");\r\n                                ctx.fillStyle = \"#ffffff\";\r\n                                ctx.fillRect(newCanvas.width - 91, newCanvas.height - 91, 91, 91);\r\n\r\n                                TC.Util.addToCanvas(newCanvas, qrCodeBase64, { x: newCanvas.width - 88, y: newCanvas.height - 88 }).then(function (mapCanvas) {\r\n                                    resolve(mapCanvas);\r\n                                });\r\n                            } else {\r\n                                TC.error(self.getLocaleString('dl.export.map.error') + ': ' + 'QR');\r\n                                self.map.getLoadingIndicator().removeWait(wait);\r\n                            }\r\n                        });\r\n                    } else {\r\n                        resolve(newCanvas);\r\n                    }\r\n                });\r\n\r\n                doneQR.then(function (_canvas) {\r\n                    try {\r\n                        const res = _canvas.toDataURL(format);\r\n                        TC.Util.downloadDataURI(window.location.hostname + '_' + TC.Util.getFormattedDate(new Date().toString(), true) + '.' + format.split('/')[1], format, res);\r\n                    } catch (e) {\r\n                        TC.error(self.getLocaleString('dl.export.map.error') + ': ' + e.message);\r\n                    }\r\n\r\n                    self.map.getLoadingIndicator().removeWait(wait);\r\n                });\r\n            }\r\n            else {\r\n                var extent = self.map.getExtent();\r\n                \r\n                var arrPromises = TC.WFSGetFeatureBuilder(self.map, new TC.filter.bbox(extent, self.map.getCRS()), format, true);\r\n                Promise.all(arrPromises).then(function (responseArray) {\r\n\r\n                    var responses = responseArray.filter(function (item) { return item != null });\r\n                    if (responses.length === 0) {\r\n                        _showAlertMsg({ key: TC.Consts.WFSErrors.NoLayers }, wait);\r\n                        return;\r\n                    }\r\n                    var arrDownloads = [];\r\n                    for (var i = 0; i < responses.length; i++) {\r\n                        //errores del WFS\r\n                        if (responses[i].errors && responses[i].errors.length) {\r\n                            for (var j = 0; j < responses[i].errors.length; j++) {\r\n                                var error = responses[i].errors[j];\r\n                                _showAlertMsg(error, wait);\r\n                            }\r\n                            continue;\r\n                        }\r\n                        var data = responses[i].data;\r\n                        var url = responses[i].url;\r\n                        if (data && url)\r\n                            arrDownloads.push({ url: url + \"?download=zip\", data: data });\r\n                    }\r\n\r\n                    TC.Util.downloadFileForm(arrDownloads);\r\n                    self.map.getLoadingIndicator().removeWait(wait);\r\n                });\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Comprueba si hay capas visibles en el panel de capas cargadas.\r\n         */\r\n        var _getVisibleLayers = function () {\r\n            var visibleLayers = [];\r\n            for (var i = 0; i < self.map.workLayers.length; i++) {\r\n                var layer = self.map.workLayers[i];\r\n                if (layer.type === TC.Consts.layerType.WMS) {\r\n                    if (layer.getVisibility() && layer.names.length > 0) {\r\n                        visibleLayers.push(layer);\r\n                    }\r\n                }\r\n            }\r\n            return visibleLayers;\r\n        };\r\n\r\n        var _showAlertMsg = function (error, wait) {\r\n            const alert = self.div.querySelector('.alert-warning:not(.' + self.CLASS + '-alert)');\r\n            var errorMsg;\r\n            switch (error.key) {\r\n                case TC.Consts.WFSErrors.NumMaxFeatures:\r\n                    errorMsg = alert.querySelector(\"#zoom-msg\").innerHTML.format({ serviceName: error.params.serviceTitle });\r\n                    break;\r\n                case TC.Consts.WFSErrors.NoLayers:\r\n                    errorMsg = self.getLocaleString('noLayersLoaded');\r\n                    break;\r\n                case TC.Consts.WFSErrors.GetCapabilities:\r\n                    errorMsg = alert.querySelector(\"#novalid-msg\").innerHTML.format({ serviceName: error.params.serviceTitle });\r\n                    break;\r\n                case TC.Consts.WFSErrors.NoFeatures:\r\n                    errorMsg = alert.querySelector(\"#noFeatures-msg\").innerHTML;\r\n                    break;\r\n                case TC.Consts.WFSErrors.Indeterminate:\r\n                    errorMsg = self.getLocaleString(\"wfs.IndeterminateError\");\r\n                    self.map.toast(errorMsg, { type: TC.Consts.msgType.ERROR });\r\n                    TC.error(\"Error:{error} \\r\\n Descripcion:{descripcion} \\r\\n Servicio:{serviceName}\".format({ error: error.params.err, descripcion: error.params.errorThrown, serviceName: error.params.serviceTitle }), TC.Consts.msgErrorMode.CONSOLE);\r\n                    self.map.getLoadingIndicator().removeWait(wait);\r\n                    return\r\n                    break;\r\n                default:\r\n                    errorMsg = self.getLocaleString(\"wfs.\" + error.key, error.params);\r\n                    break;\r\n            }\r\n            self.map.toast(errorMsg, { type: TC.Consts.msgType.WARNING });\r\n\r\n            self.map.getLoadingIndicator().removeWait(wait);\r\n        };\r\n\r\n        var _showHelp = function (evt) {\r\n            evt.stopPropagation();\r\n            TC.Util.showModal(self._dialogDiv.querySelector(self._classSelector + '-help-dialog'));\r\n        };\r\n\r\n        self.div.addEventListener(TC.Consts.event.CLICK, TC.EventTarget.listenerBySelector('.tc-ctl-download-btn', _download));\r\n        self.div.addEventListener(TC.Consts.event.CLICK, TC.EventTarget.listenerBySelector('.tc-ctl-download-help', _showHelp));\r\n\r\n        self.div.addEventListener('change', TC.EventTarget.listenerBySelector(\"#\" + self.CLASS + \"-image-qr\", function (e) {\r\n            if (e.target.checked) {\r\n                self.generateLink();\r\n            } else {\r\n                self.div.querySelector('.' + self.CLASS + '-alert').classList.add(TC.Consts.classes.HIDDEN);\r\n            }\r\n        }));\r\n\r\n        self.div.addEventListener('click', TC.EventTarget.listenerBySelector('h2', function (evt) {            \r\n            self.generateLink();\r\n            self.registerListeners();\r\n        }));\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.manageMaxLengthExceed = function (maxLengthExceed) {\r\n        const self = this;\r\n        const alert = self.div.querySelector('.' + self.CLASS + '-alert');\r\n        if (document.getElementById(self.CLASS + '-image-qr').checked) {\r\n            alert.classList.toggle(TC.Consts.classes.HIDDEN, !maxLengthExceed.qr);\r\n        } else {\r\n            alert.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n})();\r\n"]}