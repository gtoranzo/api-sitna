{"version":3,"sources":["control/Download.js"],"names":["TC","control","MapInfo","syncLoadJS","apiLocation","filter","Consts","DownloadError","MIMETYPE_NOT_SUPORTED","Download","options","this","_classSelector","CLASS","Control","apply","arguments","_hiddenElms","opts","_dialogDiv","Util","getDiv","dialogDiv","window","$","_$dialogDiv","document","body","appendChild","inherit","ctlProto","prototype","template","dust","register","body_0","chk","ctx","w","h","$key","f","get","__dustBody","render","callback","self","getRenderedHtml","html","innerHTML","then","renderData","call","controlId","id","cs","_selectors","TAB","RADIOBUTTON","ELEMENT","clickHandler","e","tab","matches","parentElement","checkbox","querySelector","newValue","value","elms","div","querySelectorAll","_oldValue","deselectable","setTimeout","checked","_activeElm","forEach","elm","push","classList","add","classes","COLLAPSED","remove","span","addEventListener","event","CLICK","map","result","mustBeExportable","_showAlertMsg","error","wait","alert","errorMsg","key","WFSErrors","MAX_NUM_FEATURES","format","serviceName","params","serviceTitle","NO_LAYERS","getLocaleString","GETCAPABILITIES","NO_FEATURES","INDETERMINATE","toast","type","msgType","ERROR","err","descripcion","errorThrown","msgErrorMode","CONSOLE","getLoadingIndicator","removeWait","WARNING","EventTarget","listenerBySelector","addWait","indexOf","Promise","resolve","reject","canvas","wrap","getViewport","synchronous","getElementsByTagName","newCanvas","cloneCanvas","getControlsByClass","ScaleBar","drawScaleBarIntoCanvas","fill","codeContainerId","codeContainer","getElementById","createElement","setAttribute","style","top","left","position","makeQRCode","qrCodeBase64","getContext","fillStyle","fillRect","width","height","addToCanvas","x","y","mapCanvas","_canvas","res","toDataURL","downloadDataURI","location","hostname","getFormattedDate","Date","toString","split","message","extent","getExtent","arrPromises","WFSGetFeatureBuilder","bbox","getCRS","all","async","responseArray","responses","item","length","arrDownloads","i","errors","j","data","url","downloadFileForm","service","find","response","plural","layers","layerNames","reduce","vi","va","array","Array","concat","title","join","mapLayers","evt","stopPropagation","showModal","target","generateLink","HIDDEN","registerListeners","manageMaxLengthExceed","maxLengthExceed","toggle","qr"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapInfo) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapInfo');\r\n}\r\n\r\nif (!TC.filter) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Filter');\r\n}\r\n\r\nTC.Consts.DownloadError = {\r\n    MIMETYPE_NOT_SUPORTED: \"MimeTypeNotSupported\"\r\n}\r\n\r\nTC.control.Download = function (options) {\r\n    var self = this;\r\n    self._classSelector = '.' + self.CLASS;\r\n\r\n    TC.Control.apply(self, arguments);\r\n\r\n    self._hiddenElms = [];\r\n\r\n    var opts = options || {};\r\n    self._dialogDiv = TC.Util.getDiv(opts.dialogDiv);\r\n    if (window.$) {\r\n        self._$dialogDiv = $(self._dialogDiv);\r\n    }\r\n    if (!opts.dialogDiv) {\r\n        document.body.appendChild(self._dialogDiv);\r\n    }    \r\n};\r\n\r\nTC.inherit(TC.control.Download, TC.control.MapInfo);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Download.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-download';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/Download.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/DownloadDialog.html\";\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        return self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n        }).then(function () {\r\n            return TC.Control.prototype.renderData.call(self, { controlId: self.id }, function () {\r\n\r\n                const cs = '.tc-ctl-tctr';\r\n                self._selectors = {\r\n                    TAB: cs + '-tab',\r\n                    RADIOBUTTON: 'input[type=radio][name=sctnr-sel]',\r\n                    ELEMENT: cs + '-elm'\r\n                };\r\n\r\n                const clickHandler = function (e) {\r\n                    var tab = this;\r\n                    while (tab && !tab.matches(self._selectors.TAB)) {\r\n                        tab = tab.parentElement;\r\n                    }\r\n                    if (tab) {\r\n                        const checkbox = tab.querySelector(self._selectors.RADIOBUTTON);\r\n                        const newValue = checkbox.value;\r\n                        const elms = self.div.querySelectorAll(self._selectors.ELEMENT);\r\n                        if (self._oldValue === newValue && self.options.deselectable) {\r\n                            setTimeout(function () {\r\n                                checkbox.checked = false;\r\n                            }, 0);\r\n                            self._oldValue = null;\r\n                            self._activeElm = null;\r\n                            elms.forEach(function (elm) {\r\n                                self._hiddenElms.push(elm);\r\n                            });\r\n                        }\r\n                        else {\r\n                            elms.forEach(function (elm) {\r\n                                if (elm.matches(self._selectors.ELEMENT + '-' + newValue)) {\r\n                                    self._activeElm = elm;\r\n                                }\r\n                                else {\r\n                                    self._hiddenElms.push(elm);\r\n                                }\r\n                            });\r\n                            self._oldValue = newValue;\r\n                        }\r\n\r\n                        self._hiddenElms.forEach(function (elm) {\r\n                            elm.classList.add(TC.Consts.classes.COLLAPSED);\r\n                        });\r\n                        if (self._activeElm) {\r\n                            self._activeElm.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                        }\r\n                        checkbox.checked = true;\r\n                    }\r\n                };\r\n\r\n                self.div.querySelectorAll('span').forEach(function (span) {\r\n                    span.addEventListener(TC.Consts.event.CLICK, clickHandler);\r\n                });\r\n                if (callback) {\r\n                    callback();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        var self = this;\r\n        const result = TC.control.MapInfo.prototype.register.call(self, map);\r\n\r\n        // GLS: Añado el flag al mapa para tenerlo en cuenta cuando se establece la función de carga de imágenes\r\n        self.map.mustBeExportable = true;\r\n\r\n        /**\r\n         * Descarga las features de las capas de trabajo actualmente seleccionadas. Comprueba que el número de features a descargar\r\n         * no excede el límite impuesto por el servidor.\r\n         */       \r\n\r\n        var _download = function () {\r\n            var wait = self.map.getLoadingIndicator().addWait();\r\n\r\n            var format = '';\r\n            if (self._activeElm) {\r\n                format = self._activeElm.querySelector('select').value;\r\n            }\r\n            if (format.indexOf('image') > -1) {\r\n                const doneQR = new Promise(function (resolve, reject) {\r\n                    var canvas = self.map.wrap.getViewport({ synchronous: true }).getElementsByTagName('canvas')[0];\r\n                    var newCanvas = TC.Util.cloneCanvas(canvas);\r\n\r\n                    var sb = self.map.getControlsByClass(TC.control.ScaleBar);\r\n                    if (sb) {\r\n                        self.drawScaleBarIntoCanvas({ canvas: newCanvas, fill: true });\r\n                    }\r\n\r\n                    if (self._activeElm.querySelector(`#${self.CLASS}-image-qr-${self.id}:checked`)) {\r\n                        const codeContainerId = 'qrcode';\r\n                        var codeContainer = document.getElementById(codeContainerId);\r\n                        if (codeContainer) {\r\n                            codeContainer.innerHTML = '';\r\n                        }\r\n                        else {\r\n                            codeContainer = document.createElement('div');\r\n                            codeContainer.setAttribute('id', codeContainerId);\r\n                            document.body.appendChild(codeContainer);\r\n                        }\r\n\r\n                        codeContainer.style.top = '-200px';\r\n                        codeContainer.style.left = '-200px';\r\n                        codeContainer.style.position = 'absolute';\r\n\r\n                        self.makeQRCode(codeContainer, 87, 87).then(function (qrCodeBase64) {\r\n                            if (qrCodeBase64) {\r\n                                var ctx = newCanvas.getContext(\"2d\");\r\n                                ctx.fillStyle = \"#ffffff\";\r\n                                ctx.fillRect(newCanvas.width - 91, newCanvas.height - 91, 91, 91);\r\n\r\n                                TC.Util.addToCanvas(newCanvas, qrCodeBase64, { x: newCanvas.width - 88, y: newCanvas.height - 88 }).then(function (mapCanvas) {\r\n                                    resolve(mapCanvas);\r\n                                });\r\n                            } else {\r\n                                TC.error(self.getLocaleString('dl.export.map.error') + ': ' + 'QR');\r\n                                self.map.getLoadingIndicator().removeWait(wait);\r\n                            }\r\n                        });\r\n                    } else {\r\n                        resolve(newCanvas);\r\n                    }\r\n                });\r\n\r\n                doneQR.then(function (_canvas) {\r\n                    try {\r\n                        const res = _canvas.toDataURL(format);\r\n                        TC.Util.downloadDataURI(window.location.hostname + '_' + TC.Util.getFormattedDate(new Date().toString(), true) + '.' + format.split('/')[1], format, res);\r\n                    } catch (e) {\r\n                        TC.error(self.getLocaleString('dl.export.map.error') + ': ' + e.message);\r\n                    }\r\n\r\n                    self.map.getLoadingIndicator().removeWait(wait);\r\n                });\r\n            }\r\n            else {\r\n                var extent = self.map.getExtent();\r\n                \r\n                var arrPromises = TC.WFSGetFeatureBuilder(self.map, TC.filter.bbox(extent, self.map.getCRS()), format, true);\r\n                Promise.all(arrPromises).then(async function (responseArray) {\r\n\r\n                    var responses = responseArray.filter(function (item) { return item != null });\r\n                    if (responses.length === 0) {\r\n                        _showAlertMsg({ key: TC.Consts.WFSErrors.NO_LAYERS }, wait);\r\n                        return;\r\n                    }\r\n                    var arrDownloads = [];\r\n                    for (var i = 0; i < responses.length; i++) {\r\n                        //errores del WFS\r\n                        if (responses[i].errors && responses[i].errors.length) {\r\n                            for (var j = 0; j < responses[i].errors.length; j++) {\r\n                                var error = responses[i].errors[j];\r\n                                _showAlertMsg(error, wait);\r\n                            }\r\n                            continue;\r\n                        }\r\n                        var data = responses[i].data;\r\n                        var url = responses[i].url;\r\n                        if (data && url)\r\n                            arrDownloads.push({ url: url + \"?download=zip\", data: data });\r\n                    }\r\n                    try {\r\n                        await TC.Util.downloadFileForm(arrDownloads);\r\n                    }\r\n                    catch (err) {\r\n                        if (err.key === TC.Consts.DownloadError.MIMETYPE_NOT_SUPORTED) {\r\n                            const service = responseArray.find(function (response) { return response.data === err.data }).service;\r\n                            const params = {\r\n                                plural: service.layers.length > 1 ? self.getLocaleString(\"dl.format.notSupported.plural\") : \"\",\r\n                                layerNames: service.layers.reduce(function (vi, va, i, array) {\r\n                                    return (vi instanceof Array ? vi : [vi]).concat([va.title]).join(i < array.length - 1 ? \", \" : \" \" + self.getLocaleString(\"dl.format.notSupported.conjunction\") +\" \")\r\n                                }, []),                                \r\n                                serviceTitle: service.mapLayers[0].title,\r\n                                format:format\r\n                            }\r\n                            self.map.toast(self.getLocaleString(\"dl.format.notSupported\").format(params), { type: TC.Consts.msgType.ERROR });\r\n                        }\r\n                    }\r\n\r\n                    self.map.getLoadingIndicator().removeWait(wait);\r\n                });\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Comprueba si hay capas visibles en el panel de capas cargadas.\r\n         */\r\n        var _getVisibleLayers = function () {\r\n            var visibleLayers = [];\r\n            for (var i = 0; i < self.map.workLayers.length; i++) {\r\n                var layer = self.map.workLayers[i];\r\n                if (layer.type === TC.Consts.layerType.WMS) {\r\n                    if (layer.getVisibility() && layer.names.length > 0) {\r\n                        visibleLayers.push(layer);\r\n                    }\r\n                }\r\n            }\r\n            return visibleLayers;\r\n        };\r\n\r\n        var _showAlertMsg = function (error, wait) {\r\n            const alert = self.div.querySelector('.alert-warning:not(.' + self.CLASS + '-alert)');\r\n            var errorMsg;\r\n            switch (error.key) {\r\n                case TC.Consts.WFSErrors.MAX_NUM_FEATURES:\r\n                    errorMsg = alert.querySelector(\"#zoom-msg-\" + self.id).innerHTML.format({ serviceName: error.params.serviceTitle });\r\n                    break;\r\n                case TC.Consts.WFSErrors.NO_LAYERS:\r\n                    errorMsg = self.getLocaleString('noLayersLoaded');\r\n                    break;\r\n                case TC.Consts.WFSErrors.GETCAPABILITIES:\r\n                    errorMsg = alert.querySelector(\"#novalid-msg-\" + self.id).innerHTML.format({ serviceName: error.params.serviceTitle });\r\n                    break;\r\n                case TC.Consts.WFSErrors.NO_FEATURES:\r\n                    errorMsg = alert.querySelector(\"#noFeatures-msg-\" + self.id).innerHTML;\r\n                    break;\r\n                case TC.Consts.WFSErrors.INDETERMINATE:\r\n                    errorMsg = self.getLocaleString(\"wfs.IndeterminateError\");\r\n                    self.map.toast(errorMsg, { type: TC.Consts.msgType.ERROR });\r\n                    TC.error(\"Error:{error} \\r\\n Descripcion:{descripcion} \\r\\n Servicio:{serviceName}\".format({ error: error.params.err, descripcion: error.params.errorThrown, serviceName: error.params.serviceTitle }), TC.Consts.msgErrorMode.CONSOLE);\r\n                    self.map.getLoadingIndicator().removeWait(wait);\r\n                    return\r\n                    break;\r\n                default:\r\n                    errorMsg = self.getLocaleString(\"wfs.\" + error.key, error.params);\r\n                    break;\r\n            }\r\n            self.map.toast(errorMsg, { type: TC.Consts.msgType.WARNING });\r\n\r\n            self.map.getLoadingIndicator().removeWait(wait);\r\n        };\r\n\r\n        var _showHelp = function (evt) {\r\n            evt.stopPropagation();\r\n            TC.Util.showModal(self._dialogDiv.querySelector(self._classSelector + '-help-dialog'));\r\n        };\r\n\r\n        self.div.addEventListener(TC.Consts.event.CLICK, TC.EventTarget.listenerBySelector('.tc-ctl-download-btn', _download));\r\n        self.div.addEventListener(TC.Consts.event.CLICK, TC.EventTarget.listenerBySelector('.tc-ctl-download-help', _showHelp));\r\n\r\n        self.div.addEventListener('change', TC.EventTarget.listenerBySelector(`#${self.CLASS}-image-qr-${self.id}`, function (e) {\r\n            if (e.target.checked) {\r\n                self.generateLink();\r\n            } else {\r\n                self.div.querySelector('.' + self.CLASS + '-alert').classList.add(TC.Consts.classes.HIDDEN);\r\n            }\r\n        }));\r\n\r\n        self.div.addEventListener('click', TC.EventTarget.listenerBySelector('h2', function (evt) {            \r\n            self.generateLink();\r\n            self.registerListeners();\r\n        }));\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.manageMaxLengthExceed = function (maxLengthExceed) {\r\n        const self = this;\r\n        const alert = self.div.querySelector('.' + self.CLASS + '-alert');\r\n        if (document.getElementById(`${self.CLASS}-image-qr-${self.id}`).checked) {\r\n            alert.classList.toggle(TC.Consts.classes.HIDDEN, !maxLengthExceed.qr);\r\n        } else {\r\n            alert.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n})();\r\n"]}