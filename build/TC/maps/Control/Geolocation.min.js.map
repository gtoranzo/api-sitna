{"version":3,"sources":["control/Geolocation.js"],"names":["Math","hypot","y","length","arguments","i","Infinity","sqrt","lastTime","vendors","hasPerformance","window","performance","now","x","max","requestAnimationFrame","cancelAnimationFrame","callback","element","currTime","Date","getTime","timeToCall","id","setTimeout","clearTimeout","rAF","startTime","timestamp","offset","this","TC","control","Control","syncLoadJS","apiLocation","Geolocation","options","_classSelector","CLASS","_layerPromises","Const","Classes","ACTIVE","CLOSED","SELECTEDTRACK","DRAWACTIVATED","SIMULATIONACTIVATED","Selector","SIMULATE","DRAW","EDIT","DELETE","SAVE","CANCEL","EXPORT_GPX","EXPORT_KML","STOP","PAUSE","BACKWARD","FORWARD","SPEED","LocalStorageKey","TRACKING","TRACKINGTEMP","TRACKINGSHOWADVERTISEMENT","GPSSHOWADVERTISEMENT","TEST","Message","VALIDATENAME","Event","POSITIONCHANGE","GPSPOSITIONCHANGE","GPSPOSITIONERROR","STATEUPDATED","GPSADD","TRACKSNAPPING","DRAWTRACK","CLEARTRACK","IMPORTEDTRACK","MimeMap","KML","GPX","SupportedFileExtensions","Tabs","GPS","Layers","TRACK","apply","opts","_dialogDiv","Util","getDiv","dialogDiv","_$dialogDiv","$","document","body","appendChild","delta","walkingSpeed","gapHill","snappingTolerance","exportsState","storageCRS","inherit","ctlProto","prototype","CHART_SIZE","MIN_HEIGHT","MAX_HEIGHT","MIN_WIDTH","MEDIUM_WIDTH","MAX_WIDTH","featuresToShare","Consts","event","TOOLSCLOSE","TOOLSOPEN","template","isDebug","dust","register","body_0","chk","ctx","w","h","$key","__dustBody","f","get","block","body_1","else","body_2","body_3","body_4","body_5","body_6","body_8","body_7","key","value","body_10","body_9","map","self","result","call","wrap","addLayer","getUID","type","layerType","VECTOR","stealth","title","then","layer","layerGPS","styles","point","radius","fillColor","fillOpacity","track","renderTrack","checked","bind","strokeColor","fontColor","labelOutlineColor","labelOutlineWidth","label","feature","name","getData","trim","toLowerCase","line","strokeOpacity","strokeWidth","lineDash","layerTracking","fontSize","layerTrack","on","FEATURESIMPORT","e","fileName","target","dropTarget","kmlPattern","format","gpxPattern","indexOf","clear","importTrack","test","features","forEach","Point","setStyle","Polyline","render","getRenderedHtml","html","innerHTML","isDisabled","toast","getLocaleString","msgType","WARNING","wait","getLoadingIndicator","addWait","importedFileName","addPromises","len","push","addFeature","Promise","all","processImportedFeatures","notReproject","layout","accordion","div","classList","contains","classes","COLLAPSED","controls","filter","ctl","containerControl","add","remove","querySelector","click","isShared","trigger","prepareFeaturesToShare","trackUid","resolve","reject","storageData","availableTracks","saved","uid","toString","data","precision","pow","DEGREE_PRECISION","storageFeatures","ol","GeoJSON","readFeatures","promises","Array","idx","Feature","createFeature","tcFeatures","fObj","Marker","geom","MARKER","POINT","POLYLINE","MultiPolyline","MULTIPOLYLINE","compactGeometry","geometry","visibilityTrack","renderData","sel","querySelectorAll","span","addEventListener","CLICK","tagName","parentElement","newFormat","option","matches","HIDDEN","activateButton","deactivateButton","trackSearch","trackImportFile","trackSave","trackAdd","trackContinue","trackRenew","trackClose","trackAdvertisementOK","trackList","trackToolPanelOpened","_showAlerMsg","trackName","trackWPT","detectMobile","Modernizr","mq","File","FileReader","FileList","Blob","disabled","form","createElement","parent","insertBefore","reset","insertAdjacentElement","removeChild","_cleaning","LAYERERROR","_layerError","loadFiles","files","console","log","activateTracking","_activateTrackingBtns","deactivateTracking","_deactivateTrackingBtns","_filter","searchTerm","lis","from","li","style","display","trackLis","searchIcon","visibility","r","RegExp","textContent","some","trackSearchListener","newValue","saveTrack","addWaypoint","list","_edit","edit","elm","input","focus","uiSimulate","simulate","editControls","simulateControls","cnt","parentNode","hidden","EventTarget","listenerBySelector","_loadTrack","removeWait","_drawTrack","listElement","index","animate","scrollTop","offsetHeight","_stopOtherTracks","trackLiId","listItem","dataset","btnSimulate","btnPause","setAttribute","btnDraw","trackLi","getSelectedTrack","drawTrack","simulate_paused","simulateTrack","removeTrack","alert","editTrackName","mimeType","cls","replace","toUpperCase","export","filename","regex","join","cleanFilename","downloadFile","simulateTrackEnd","simulate_speed","simulate_pausedElapse","closeModal","_tracking","sessionTracking","storage","setSessionLocalValue","undefined","localforage","removeItem","checkboxes","loadJS","url","LOCALFORAGE","setItem","getAttribute","setVisibility","bindTracks","isFunction","activate","deactivate","clearSelection","off","clearFileInput","duration","markerStyle","lineStyle","setFormatInfoNewPosition","newPosition","locale","getMapLocale","on3DView","geoCoords","crs","view3D","reproject","position","toLocaleString","mdt","round","getHeightFromMDT","isGeo","z","altitude","accuracy","speed","minimumFractionDigits","maximumFractionDigits","renderInfoNewPosition","d","pd","infoPanel","isMinimized","renderPromise","getTableContainer","isVisible","doVisible","ctlPromise","resultsPanelOptions","content","titles","main","collapsed","addResultsPanelInfo","controlContainer","side","SIDE","RIGHT","addControl","displayOn","getControlsByClass","substring","resultsPanelInfo","caller","panel","close","open","_onWindowBlurred","_onWindowFocused","_onWindowVisibility","duringTrackingToolsPanel","currentPoint","formattedToStorage","advertisement","setTracking","onWindowFocused","videoScreenOn","paused","play","fromStorageToSession","onWindowVisibility","prefixes","getHiddenProperty","addWindowEvents","fromSessionToStorage","detectSafari","touch","navigator","userAgent","match","getSessionLocalValue","JSON","stringify","getItem","showAdvertisement","registeredShowAdvertisement","dialog","checkbox","showModal","_askTracking","closeCallback","trackingAvailable","isActive","error","code","DOMException","QUOTA_EXCEEDED_ERR","media","WebM","MP4","sourceWebM","src","sourceMP4","_deactivateTracking","geopositionTracking","pause","removeEventListener","hasCoordinates","getStoredTracks","tracks","keys","k","exec","res","rej","v","results","parse","concat","tracksArray","_orderTracks","sort","a","b","localeCompare","setStoredTracks","t","getAvailableTracks","_isEmpty","currentSelectedTrack","currentSelectedTrackId","newLi","DOMParser","parseFromString","firstChild","setSelectedTrack","chartProgressInit","d3","D3C3","dataDiv","select","node","getBoundingClientRect","miDiv","width","height","miProgressDiv","miProgressTextDiv","top","left","bottom","right","zIndex","chartProgressClear","chartSetProgress","previous","current","distance","doneTime","done","progress","p","dist","measure","ele","parseInt","toFixed","_getTime","timeFrom","timeTo","diff","daysDifference","floor","hoursDifference","minutesDifference","m","s","extend","slice","activateSnapping","drawTrackingData","elevationTrack","resized","onResize","chart","coordinates","elevationChart","destroy","tool","Elevation","getTrackingData","geoJSON","minEle","maxEle","empty","elevationGain","time","getDistance","getLayout","GeometryLayout","XYZ","XYZM","utmCrs","LineString","getCoordinates","getLength","parseFloat","XYM","getLastCoordinate","getFirstCoordinate","addX","arr","prev","dx","dy","addElevation","min","getGeometry","getType","getElevationGain","coords","hillDeltaThreshold","_time","ls","getLineStrings","chartData","miny","maxy","getChartData","hasElevation","msg","minHeight","maxHeight","minWidth","mediumWidth","maxWidth","one","DRAWCHART","resultsPanelChart","c3","openOn","closeOn","onmouseout","removeElevationTooltip","tooltip","getElevationTooltip","addResultsPanelChart","getVisibility","getOpacity","deactivateSnapping","RESULTSPANELMIN","RESULTSPANELMAX","RESULTSPANELCLOSE","clearFeatures","message","_save","formatted","clean","newTrack","hex_md5","HASH","hash","sameTrackUID","savedTrack","clonedTrack","jsonFormat","explodeGeometry","setCoordinates","writeFeatures","getTrackIndex","random","waypointName","heading","trackId","newName","dataId","confirm","selectedTrack","catch","err","clearSelectedTrack","selected","showFeatures","showsPopup","first","last","addMarker","splice","cssClass","anchor","notExport","formattedFromStorage","showElevationMarker","getElevationChartTooltip","hideElevationMarker","fileInput","loading","LoadingIndicator","onGeolocateError","errorMsg","geolocation","currentPosition","clearWatch","currentPositionTrk","watch","currentPositionWaiting","PERMISSION_DENIED","POSITION_UNAVAILABLE","TIMEOUT","obj","exportState","state","layerState","importState","enable","featureOptions"],"mappings":"AACIA,KAAKC,MAAQD,KAAKC,OAAS,WAIvB,IAHA,IAAIC,EAAI,EACJC,EAASC,UAAUD,OAEdE,EAAI,EAAGA,EAAIF,EAAQE,IAAK,CAC7B,GAAID,UAAUC,KAAOC,EAAAA,GAAYF,UAAUC,MAAO,EAAA,EAC9C,OAAOC,EAAAA,EAEXJ,GAAKE,UAAUC,GAAKD,UAAUC,GAElC,OAAOL,KAAKO,KAAKL,KAGzB,WAMI,IALA,IAAIM,EAAW,EACXC,GAAW,KAAM,MAAO,SAAU,KAElCC,KAAoBC,OAAOC,cAAeD,OAAOC,YAAYC,KAExDC,EAAI,EAAGC,EAAMN,EAAQN,OAAQW,EAAIC,IAAQJ,OAAOK,sBAAuBF,GAAK,EAAG,CACpFH,OAAOK,sBAAwBL,OAAOF,EAAQK,GAAK,yBACnDH,OAAOM,qBAAuBN,OAAOF,EAAQK,GAAK,yBAC3CH,OAAOF,EAAQK,GAAK,+BAG1BH,OAAOK,wBACRL,OAAOK,sBAAwB,SAAUE,EAAUC,GAC/C,IAAIC,GAAW,IAAIC,MAAOC,UACtBC,EAAavB,KAAKe,IAAI,EAAG,IAAMK,EAAWZ,IAC1CgB,EAAKb,OAAOc,WAAW,WAAcP,EAASE,EAAWG,IACzDA,GACJf,EAAWY,EAAWG,EACtB,OAAOC,IAIVb,OAAOM,uBACRN,OAAOM,qBAAuB,SAAUO,GACpCE,aAAaF,KAKrB,IAAKd,EAAgB,CAEjB,IAAIiB,EAAMhB,OAAOK,sBACbY,GAAa,IAAIP,KAGrBV,OAAOK,sBAAwB,SAAUE,EAAUC,GAU/CQ,EARc,SAAUE,GAIpB,OAAOX,EAFqBW,EAAY,KAAQA,EAAYA,EAAYD,IAM/DT,KA9CzB,IAkDC,WAEG,GAAKR,OAAOC,aAOL,GAAID,OAAOC,cAAgBD,OAAOC,YAAYC,IAAK,CACtDF,OAAOC,YAAYkB,OAAST,KAAKR,MACjCF,OAAOC,YAAYC,IAAM,WACrB,OAAOQ,KAAKR,MAAQF,OAAOC,YAAYkB,cAT3CnB,OAAOC,aACHkB,OAAQT,KAAKR,MACbA,IAAK,WACD,OAAOQ,KAAKR,MAAQkB,KAAKD,SANzC,GAiBAE,GAAGC,QAAUD,GAAGC,YAEXD,GAAGE,SACJF,GAAGG,WAAWH,GAAGI,YAAc,cAGnCJ,GAAGC,QAAQI,YAAc,SAAUC,GACpBP,KACNQ,eAAiB,IADXR,KACsBS,MADtBT,KAGNU,kBAHMV,KAKNW,OACDC,SACIC,OAAQ,4BACRC,OAAQ,SACRC,cAAe,gBACfC,cAAe,iBACfC,oBAAqB,wBAEzBC,UACIC,SAAU,mBACVC,KAAM,WACNC,KAAM,eACNC,OAAQ,iBACRC,KAAM,eACNC,OAAQ,iBACRC,WAAY,qBACZC,WAAY,qBACZC,KAAM,eACNC,MAAO,gBACPC,SAAU,mBACVC,QAAS,kBACTC,MAAO,iBAEXC,iBACIC,SAAU,MACVC,aAAc,UACdC,0BAA2B,mBAC3BC,qBAAsB,mBACtBC,KAAM,QAEVC,SACIC,aAAc,IAElBC,OACIC,eAAgB,gCAChBC,kBAAmB,mCACnBC,iBAAkB,+BAClBC,aAAc,8BACdC,OAAQ,wBACRC,cAAe,+BACfC,UAAW,2BACXC,WAAY,4BACZC,cAAe,gCAEnBC,SACIC,IAAK,uCACLC,IAAK,uBAETC,yBACI,OACA,QAEJC,MACIC,IAAK,OAETC,QACID,IAAK,MACLE,MAAO,QACPxB,SAAU,aAIlBhC,GAAGE,QAAQuD,MAnEA1D,KAmEY3B,WAEvB,IAAIsF,EAAOpD,MArEAP,KAsEN4D,WAAa3D,GAAG4D,KAAKC,OAAOH,EAAKI,WAtE3B/D,KAuENgE,YAAcC,EAvERjE,KAuEe4D,YACrBD,EAAKI,WACNG,SAASC,KAAKC,YAzEPpE,KAyEwB4D,YAzExB5D,KA2ENqE,MAAQ,IA3EFrE,KA4ENsE,aAAe,IA5ETtE,KA6ENuE,QA7EMvE,KA6ESO,QAAQgE,SAAW,GA7E5BvE,KA+ENwE,kBA/EMxE,KA+EmBO,QAAQiE,mBAAqB,GA/EhDxE,KAiFNyE,cAAe,EAjFTzE,KAmFN0E,WAAa,aAGtBzE,GAAG0E,QAAQ1E,GAAGC,QAAQI,YAAaL,GAAGE,UAEtC,WACI,IAAIyE,EAAW3E,GAAGC,QAAQI,YAAYuE,UAEtCD,EAASnE,MAAQ,qBAEjBmE,EAASE,YACLC,WAAY,GACZC,WAAY,IAEZC,UAAW,IACXC,aAAc,IACdC,UAAW,KAGfP,EAASQ,mBAETnF,GAAGoF,OAAOC,MAAMC,WAAatF,GAAGoF,OAAOC,MAAMC,YAAc,gBAC3DtF,GAAGoF,OAAOC,MAAME,UAAYvF,GAAGoF,OAAOC,MAAME,WAAa,eAEzDZ,EAASa,YAET,GAAIxF,GAAGyF,QAAS,CACZd,EAASa,SAASb,EAASnE,OAASR,GAAGI,YAAc,gCACrDuE,EAASa,SAASb,EAASnE,MAAQ,eAAiBR,GAAGI,YAAc,yCACrEuE,EAASa,SAASb,EAASnE,MAAQ,wBAA0BR,GAAGI,YAAc,iDAC9EuE,EAASa,SAASb,EAASnE,MAAQ,WAAaR,GAAGI,YAAc,sCACjEuE,EAASa,SAASb,EAASnE,MAAQ,mBAAqBR,GAAGI,YAAc,iDAExE,CACDuE,EAASa,SAASb,EAASnE,OAAS,WAAckF,KAAKC,SAAShB,EAASnE,MAAOoF,GAAS,SAASA,EAAOC,EAAKC,GAAO,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAQF,MAAWG,KAAQ,QAASF,EAAE,2fAA0gBC,EAAE,OAAQF,MAAWG,KAAQ,yBAA0BF,EAAE,MAAOC,EAAE,OAAQF,MAAWG,KAAQ,yBAA0BF,EAAE,qFAAwFC,EAAE,OAAQF,MAAWG,KAAQ,yBAA0BF,EAAE,2JAAmKC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,qEAA4EC,EAAE,OAAQF,MAAWG,KAAQ,YAAaF,EAAE,uEAA0EC,EAAE,OAAQF,MAAWG,KAAQ,qBAAsBF,EAAE,sEAA6EC,EAAE,OAAQF,MAAWG,KAAQ,eAAgBF,EAAE,8XAA2YC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,mLAA4LC,EAAE,OAAQF,MAAWG,KAAQ,iBAAkBF,EAAE,sEAAwEC,EAAE,OAAQF,MAAWG,KAAQ,cAAeF,EAAE,6QAA8RC,EAAE,OAAQF,MAAWG,KAAQ,0BAA2BF,EAAE,MAAOC,EAAE,OAAQF,MAAWG,KAAQ,uBAAwBF,EAAE,0JAAgKC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,aAAaC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,aAAaC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,aAAaC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,aAAaC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,yRAAsSC,EAAE,OAAQF,MAAWG,KAAQ,mBAAoBF,EAAE,MAAOC,EAAE,OAAQF,MAAWG,KAAQ,mBAAoBF,EAAE,uGAA0GC,EAAE,OAAQF,MAAWG,KAAQ,6BAA8BF,EAAE,MAAOC,EAAE,OAAQF,MAAWG,KAAQ,uBAAwBF,EAAE,8GAAiHC,EAAE,OAAQF,MAAWG,KAAQ,+BAAgCF,EAAE,MAAOC,EAAE,OAAQF,MAAWG,KAAQ,yBAA0BF,EAAE,yLAAgMC,EAAE,OAAQF,MAAWG,KAAQ,sBAAuBF,EAAE,+GAAqHC,EAAE,OAAQF,MAAWG,KAAQ,sBAAuBF,EAAE,6GAAmHC,EAAE,OAAQF,MAAWG,KAAQ,qBAAsBF,EAAE,kHAAwHC,EAAE,OAAQF,MAAWG,KAAQ,qBAAsBF,EAAE,mHAAuHC,EAAE,OAAQF,MAAWG,KAAQ,mBAAoBF,EAAE,qBAAyBH,EAAOM,YAAa,EAAI,OAAON,GACh+JjB,EAASa,SAASb,EAASnE,MAAQ,eAAiB,WAAckF,KAAKC,SAAShB,EAASnE,MAAQ,cAAeoF,GAAS,SAASA,EAAOC,EAAKC,GAAO,OAAOD,EAAIE,EAAE,iBAAkBI,EAAEL,EAAIM,KAAK,OAAO,GAAQN,EAAK,KAAKC,EAAE,gBAAkBI,EAAEL,EAAIM,KAAK,QAAQ,GAAQN,EAAK,KAAKC,EAAE,iDAAqDI,EAAEL,EAAIM,KAAK,SAAS,GAAQN,EAAK,KAAKC,EAAE,MAAOI,EAAEL,EAAIM,KAAK,SAAS,GAAQN,EAAK,KAAKC,EAAE,kEAAuEI,EAAEL,EAAIM,KAAK,SAAS,GAAQN,EAAK,KAAKC,EAAE,gDAAoDC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,yDAA6DC,EAAE,OAAQF,MAAWG,KAAQ,gBAAiBF,EAAE,kDAAsDC,EAAE,OAAQF,MAAWG,KAAQ,gBAAiBF,EAAE,0DAA8DC,EAAE,OAAQF,MAAWG,KAAQ,iBAAkBF,EAAE,8DAAkEC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,yDAA6DC,EAAE,OAAQF,MAAWG,KAAQ,oBAAqBF,EAAE,2DAA+DC,EAAE,OAAQF,MAAWG,KAAQ,mBAAoBF,EAAE,6DAAiEC,EAAE,OAAQF,MAAWG,KAAQ,SAAUF,EAAE,8DAAkEC,EAAE,OAAQF,MAAWG,KAAQ,kBAAmBF,EAAE,oDAAwDC,EAAE,OAAQF,MAAWG,KAAQ,kBAAmBF,EAAE,wDAA4DC,EAAE,OAAQF,MAAWG,KAAQ,qBAAsBF,EAAE,wDAA4DC,EAAE,OAAQF,MAAWG,KAAQ,qBAAsBF,EAAE,qBAAyBH,EAAOM,YAAa,EAAI,OAAON,GACn3DjB,EAASa,SAASb,EAASnE,MAAQ,wBAA0B,WAAckF,KAAKC,SAAShB,EAASnE,MAAQ,uBAAwBoF,GAAS,SAASA,EAAOC,EAAKC,GAAO,OAAOD,EAAIE,EAAE,QAAQjH,EAAEgH,EAAIM,KAAK,MAAM,GAAQN,GAAOO,MAASC,OAAcP,EAAE,eAAejH,EAAEgH,EAAIM,KAAK,UAAU,GAAQN,GAAOS,KAAQC,EAAQH,MAASI,OAAcV,EAAE,aAAaI,EAAEL,EAAIM,KAAK,MAAM,GAAQN,EAAK,KAAKC,EAAE,oBAAoBjH,EAAEgH,EAAIM,KAAK,UAAU,GAAQN,GAAOS,KAAQG,EAAQL,MAASM,OAAcZ,EAAE,aAAaI,EAAEL,EAAIM,KAAK,MAAM,GAAQN,EAAK,KAAKC,EAAE,UAAUjH,EAAEgH,EAAIM,KAAK,MAAM,GAAQN,GAAOO,MAASO,OAAc9H,EAAEgH,EAAIM,KAAK,MAAM,GAAQN,GAAOO,MAASQ,OAAcd,EAAE,SAAYH,EAAOM,YAAa,EAAI,SAASI,EAAOT,EAAKC,GAAO,OAAOD,EAAIE,EAAE,cAAcC,EAAE,OAAQF,MAAWG,KAAQ,0BAA2BF,EAAE,aAAaI,EAAEL,EAAIM,KAAK,MAAM,GAAQN,EAAK,KAAKC,EAAE,SAAYO,EAAOJ,YAAa,EAAI,SAASM,EAAOX,EAAKC,GAAO,OAAOD,EAAIE,EAAE,KAAQS,EAAON,YAAa,EAAI,SAASO,EAAOZ,EAAKC,GAAO,OAAOD,EAAIG,EAAE,OAAQF,MAAWG,KAAQ,QAAYQ,EAAOP,YAAa,EAAI,SAASQ,EAAOb,EAAKC,GAAO,OAAOD,EAAIE,EAAE,KAAQW,EAAOR,YAAa,EAAI,SAASS,EAAOd,EAAKC,GAAO,OAAOD,EAAIG,EAAE,OAAQF,MAAWG,KAAQ,QAAYU,EAAOT,YAAa,EAAI,SAASU,EAAOf,EAAKC,GAAO,OAAOD,EAAIG,EAAE,KAAMF,GAAOO,MAASS,IAAYC,IAAOjB,EAAIM,KAAK,MAAM,GAAQY,MAAS,IAAQJ,EAAOV,YAAa,EAAI,SAASY,EAAOjB,EAAKC,GAAO,OAAOD,EAAIE,EAAE,yBAAyBI,EAAEL,EAAIM,KAAK,MAAM,GAAQN,EAAK,KAAKC,EAAE,UAAae,EAAOZ,YAAa,EAAI,SAASW,EAAOhB,EAAKC,GAAO,OAAOD,EAAIE,EAAE,SAASI,EAAEL,EAAIM,KAAK,MAAM,GAAQN,EAAK,KAAKC,EAAE,UAAac,EAAOX,YAAa,EAAI,OAAON,GAC9nDjB,EAASa,SAASb,EAASnE,MAAQ,WAAa,WAAckF,KAAKC,SAAShB,EAASnE,MAAQ,UAAWoF,GAAS,SAASA,EAAOC,EAAKC,GAAO,OAAOD,EAAIE,EAAE,wLAAgMC,EAAE,OAAQF,MAAWG,KAAQ,YAAaF,EAAE,yIAA+IC,EAAE,OAAQF,MAAWG,KAAQ,uBAAwBF,EAAE,sEAAwEC,EAAE,OAAQF,MAAWG,KAAQ,uBAAwBF,EAAE,yDAA2DC,EAAE,OAAQF,MAAWG,KAAQ,0BAA2BF,EAAE,kNAA0NC,EAAE,OAAQF,MAAWG,KAAQ,6BAA8BF,EAAE,gGAAsGC,EAAE,OAAQF,MAAWG,KAAQ,sBAAuBF,EAAE,gIAAwIC,EAAE,OAAQF,MAAWG,KAAQ,iCAAkCF,EAAE,mHAAuHC,EAAE,OAAQF,MAAWG,KAAQ,OAAQF,EAAE,gCAAmCH,EAAOM,YAAa,EAAI,OAAON,GAC5pDjB,EAASa,SAASb,EAASnE,MAAQ,mBAAqB,WAAckF,KAAKC,SAAShB,EAASnE,MAAQ,kBAAmBoF,GAAS,SAASA,EAAOC,EAAKC,GAAO,OAAOD,EAAIE,EAAE,4DAA8DjH,EAAEgH,EAAIM,KAAK,UAAU,GAAQN,GAAOS,KAAQD,EAAQD,MAASG,OAAcT,EAAE,eAAeI,EAAEL,EAAIM,KAAK,MAAM,GAAQN,EAAK,KAAKC,EAAE,UAAUjH,EAAEgH,EAAIM,KAAK,aAAa,GAAQN,GAAOO,MAASI,OAAcV,EAAE,iBAAiBjH,EAAEgH,EAAIM,KAAK,UAAU,GAAQN,GAAOS,KAAQG,EAAQL,MAASM,OAAcZ,EAAE,eAAeI,EAAEL,EAAIM,KAAK,MAAM,GAAQN,EAAK,KAAKC,EAAE,UAAUjH,EAAEgH,EAAIM,KAAK,UAAU,GAAQN,GAAOO,MAASO,OAAcb,EAAE,aAAajH,EAAEgH,EAAIM,KAAK,MAAM,GAAQN,GAAOO,MAASS,OAAchI,EAAEgH,EAAIM,KAAK,QAAQ,GAAQN,GAAOO,MAASY,OAAelB,EAAE,kBAAqBH,EAAOM,YAAa,EAAI,SAASI,EAAOT,EAAKC,GAAO,OAAOD,EAAIE,EAAE,KAAQO,EAAOJ,YAAa,EAAI,SAASM,EAAOX,EAAKC,GAAO,OAAOD,EAAIG,EAAE,OAAQF,MAAWG,KAAQ,QAAYO,EAAON,YAAa,EAAI,SAASO,EAAOZ,EAAKC,GAAO,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAQF,MAAWG,KAAQ,qBAAsBF,EAAE,eAAeI,EAAEL,EAAIM,KAAK,aAAa,GAAQN,EAAK,KAAKC,EAAE,YAAeU,EAAOP,YAAa,EAAI,SAASQ,EAAOb,EAAKC,GAAO,OAAOD,EAAIE,EAAE,KAAQW,EAAOR,YAAa,EAAI,SAASS,EAAOd,EAAKC,GAAO,OAAOD,EAAIG,EAAE,OAAQF,MAAWG,KAAQ,QAAYU,EAAOT,YAAa,EAAI,SAASU,EAAOf,EAAKC,GAAO,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAQF,MAAWG,KAAQ,kBAAmBF,EAAE,cAAcI,EAAEL,EAAIM,KAAK,UAAU,GAAQN,EAAK,KAAKC,EAAE,cAAiBa,EAAOV,YAAa,EAAI,SAASY,EAAOjB,EAAKC,GAAO,OAAOD,EAAIE,EAAE,QAAQjH,EAAEgH,EAAIM,KAAK,UAAU,GAAQN,GAAOS,KAAQM,EAAQR,MAASa,OAAcnB,EAAE,eAAeI,EAAEL,EAAIM,KAAK,MAAM,GAAQN,EAAK,KAAKC,EAAE,YAAee,EAAOZ,YAAa,EAAI,SAASW,EAAOhB,EAAKC,GAAO,OAAOD,EAAIE,EAAE,KAAQc,EAAOX,YAAa,EAAI,SAASgB,EAAOrB,EAAKC,GAAO,OAAOD,EAAIG,EAAE,OAAQF,MAAWG,KAAQ,QAAYiB,EAAOhB,YAAa,EAAI,SAASe,EAAQpB,EAAKC,GAAO,OAAOD,EAAIE,EAAE,eAAgBC,EAAE,OAAQF,MAAWG,KAAQ,eAAgBF,EAAE,MAAOC,EAAE,OAAQF,MAAWG,KAAQ,QAASF,EAAE,MAAMC,EAAE,OAAQF,MAAWG,KAAQ,QAASF,EAAE,eAAeI,EAAEL,EAAIM,KAAK,QAAQ,GAAQN,EAAK,KAAKC,EAAE,YAAekB,EAAQf,YAAa,EAAI,OAAON,GAG/tEjB,EAASgB,SAAW,SAAUwB,GAC1B,MAAMC,EAAOrH,KACPsH,EAASrH,GAAGE,QAAQ0E,UAAUe,SAAS2B,KAAKF,EAAMD,GAExDC,EAAKG,KAAO,IAAIvH,GAAGuH,KAAKtH,QAAQI,YAAY+G,GAC5CA,EAAKG,KAAK5B,SAASwB,GAEnBA,EAAIK,UACAhI,GAAI4H,EAAKK,SACTC,KAAM1H,GAAGoF,OAAOuC,UAAUC,OAC1BC,SAAS,EACTC,MAAO,mBACRC,KAAK,SAAUC,GACdZ,EAAKa,SAAWD,IAEpBb,EAAIK,UACAhI,GAAI4H,EAAKK,SACTC,KAAM1H,GAAGoF,OAAOuC,UAAUC,OAC1BC,SAAS,EACTC,MAAO,sBACPI,QACIC,OACIC,OAAQ,EACRC,UAAW,UACXC,YAAa,WACT,OAAOvI,KAAKwI,MAAMC,YAAYC,QAAU,EAAI,GAC9CC,KAAKtB,GACPuB,YAAa,UACbC,UAAW,UACXC,kBAAmB,UACnBC,kBAAmB,EACnBC,MAAO,SAAUC,GACb,IAAIC,EAAOD,EAAQE,UAAgB,KAOnC,OALID,EADAA,IAASA,EAAO,IAAIE,OAAOhL,OAAS,GAC5B8K,EAAO,IAAIE,OAAOC,cAEnB,KAMnBC,MACIC,cAAe,WACX,OAAOvJ,KAAKwI,MAAMC,YAAYC,QAAU,EAAI,GAC9CC,KAAKtB,GACPmC,YAAa,EACbZ,YAAa,UACba,UAAW,GAAI,OAGxBzB,KAAK,SAAUC,GACdZ,EAAKqC,cAAgBzB,IAEzBb,EAAIK,UACAhI,GAAI4H,EAAKK,SACTC,KAAM1H,GAAGoF,OAAOuC,UAAUC,OAC1BC,SAAS,EACTC,MAAO,mBACPI,QACImB,MACIE,YAAa,EACbZ,YAAa,WAEjBR,OACIC,OAAQ,SAAUY,GACd,IAAIC,EAAOD,EAAQE,UAAgB,KACnC,OAAID,IAASA,EAAO,IAAIE,OAAOhL,OAAS,EAC7B,EAEA,GAKfkK,UAAW,UACXM,YAAa,UACbC,UAAW,UACXc,SAAU,GACVb,kBAAmB,UACnBC,kBAAmB,EACnBC,MAAO,SAAUC,GACb,IAAIC,EAAOD,EAAQE,UAAgB,KAOnC,OALID,EADAA,IAASA,EAAO,IAAIE,OAAOhL,OAAS,GAC5B8K,EAAO,IAAIE,OAAOC,cAEnB,QAOxBrB,KAAK,SAAUC,GACdZ,EAAKuC,WAAa3B,IAGtBb,EAAIyC,GAAG5J,GAAGoF,OAAOC,MAAMwE,eAAgB,SAAUC,GAC7C,MAAM1C,EAAOrH,KACPgK,EAAWD,EAAEC,SACbC,EAASF,EAAEG,WACjB,IAAIC,EAAa,IAAMlK,GAAGoF,OAAO+E,OAAOjH,IAAIkG,cACxCgB,EAAa,IAAMpK,GAAGoF,OAAO+E,OAAOhH,IAAIiG,cAG5C,GAAIW,EAASX,cAAciB,QAAQD,KAAgBL,EAAS5L,OAASiM,EAAWjM,QAE3E4L,EAASX,cAAciB,QAAQH,KAAgBH,EAAS5L,OAAS+L,EAAW/L,QAAU6L,IAAW5C,EAFtG,CAIIA,EAAKkD,MAAMlD,EAAK1G,MAAM6C,OAAOC,OAC7B4D,EAAKmD,YAAYT,GAEb,SAASU,KAAKT,EAASX,gBAAkBhC,EAAKuC,YAC1CvC,EAAKuC,WAAWzB,QAChBd,EAAKuC,WAAWc,SAASC,QAAQ,SAAU1B,GACnCA,aAAmBhJ,GAAGgJ,QAAQ2B,OAASvD,EAAKuC,WAAWzB,OAAOC,MAC9Da,EAAQ4B,SAASxD,EAAKuC,WAAWzB,OAAOC,OACjCa,aAAmBhJ,GAAGgJ,QAAQ6B,UAAYzD,EAAKuC,WAAWzB,OAAOmB,MACxEL,EAAQ4B,SAASxD,EAAKuC,WAAWzB,OAAOmB,UAS9DX,KAAKtB,IAEP,OAAOC,GAGX1C,EAASmG,OAAS,SAAU5L,GACxB,MAAMkI,EAAOrH,KACb,OAAOqH,EAAK2D,gBAAgB3D,EAAK5G,MAAQ,UAAW,KAAM,SAAUwK,GAChE5D,EAAKzD,WAAWsH,UAAYD,IAC7BjD,KAAK,WACJ,OAAO/H,GAAGE,QAAQ0E,UAAUkG,OAAOxD,KAAKF,EAAMlI,MAItDyF,EAAS4F,YAAc,SAAUjK,GAC7B,IAAI8G,EAAOrH,KAEX,GAAKqH,EAAK8D,WAqCC,SAASV,KAAKlK,EAAQyJ,SAASX,gBACtChC,EAAKD,IAAIgE,MAAM/D,EAAKgE,gBAAgB,4BAA8B1D,KAAM1H,GAAGoF,OAAOiG,QAAQC,eArC1F,GAAIhL,EAAQyJ,UAAYzJ,EAAQmK,UAAYnK,EAAQmK,SAAStM,OAAS,EAAG,CAErE,IAAIoN,EAAOnE,EAAKoE,sBAAsBC,UACtCrE,EAAKsE,iBAAmBpL,EAAQyJ,SAChC,MAAM4B,KACN,IAAK,IAAItN,EAAI,EAAGuN,EAAMtL,EAAQmK,SAAStM,OAAQE,EAAIuN,EAAKvN,IACpDsN,EAAYE,KAAKzE,EAAKuC,WAAWmC,WAAWxL,EAAQmK,SAASpM,KAEjE0N,QAAQC,IAAIL,GAAa5D,KAAK,WAC1BX,EAAKG,KAAK0E,yBAA0BV,KAAMA,EAAMW,aAAc5L,EAAQ4L,eAEtE,GAAI9E,EAAKuC,WAAY,CAEbvC,EAAKD,KAAOC,EAAKD,IAAIgF,QAAU/E,EAAKD,IAAIgF,OAAOC,WAC3ChF,EAAKiF,IAAIC,UAAUC,SAASvM,GAAGoF,OAAOoH,QAAQC,YAC9CrF,EAAKD,IAAIuF,SACJC,OAAO,SAAUC,GAEd,OAAOA,IAAQxF,IAASwF,EAAIC,mBAE/BnC,QAAQ,SAAUkC,GACfA,EAAIP,IAAIC,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQC,aAKxDrF,EAAKiF,IAAIC,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQC,WAC5CrF,EAAKiF,IAAIW,cAAc,IAAM5F,EAAK5G,MAAQ,sBAAsByM,QAE3D3M,EAAQ4M,UAET9F,EAAKD,IAAIgG,QAAQnN,GAAGoF,OAAOC,MAAME,gBAUzDZ,EAASyI,uBAAyB,SAAUC,GACxC,MAAMjG,EAAOrH,KAEb,OAAO,IAAIgM,QAAQ,SAAUuB,EAASC,GAClC,GAAIF,EAAU,CAEV,IAAIG,EAAcpG,EAAKqG,gBAAgBd,OAAO,SAAUe,GACpD,OAAOA,EAAMC,IAAIC,aAAeP,EAASO,aAC1C,GAAGC,KAGFC,EAAY9P,KAAK+P,IAAI,GAAI/N,GAAGoF,OAAO4I,iBAAmB,GAEtDC,GAAkB,IAAIC,GAAG/D,OAAOgE,SAAUC,aAAaZ,GAC3D,MAAMa,EAAW,IAAIC,MAAML,EAAgB9P,QAC3C8P,EAAgBvD,QAAQ,SAAUvE,EAAGoI,GACjCF,EAASE,GAAOvO,GAAGuH,KAAKiH,QAAQC,cAActI,KAGlD4F,QAAQC,IAAIqC,GAAUtG,KAAK,SAAU2G,GACjCtH,EAAKjC,gBAAkBuJ,EAAWvH,IAAI,SAAUhB,GAC5C,MAAMwI,KAEN,QAAQ,GACJ,KAAK3O,GAAGgJ,QAAQ4F,QAAUzI,aAAanG,GAAGgJ,QAAQ4F,OAC9CD,EAAKjH,KAAO1H,GAAGoF,OAAOyJ,KAAKC,OAC3B,MACJ,KAAK9O,GAAGgJ,QAAQ2B,OAASxE,aAAanG,GAAGgJ,QAAQ2B,MAC7CgE,EAAKjH,KAAO1H,GAAGoF,OAAOyJ,KAAKE,MAC3B,MACJ,KAAK/O,GAAGgJ,QAAQ6B,UAAY1E,aAAanG,GAAGgJ,QAAQ6B,SAChD8D,EAAKjH,KAAO1H,GAAGoF,OAAOyJ,KAAKG,SAC3B,MACJ,KAAKhP,GAAGgJ,QAAQiG,eAAiB9I,aAAanG,GAAGgJ,QAAQiG,cACrDN,EAAKjH,KAAO1H,GAAGoF,OAAOyJ,KAAKK,cAGnCP,EAAKnP,GAAK2G,EAAE3G,GACZmP,EAAKE,KAAO7O,GAAG4D,KAAKuL,gBAAgBhJ,EAAEiJ,SAAUtB,GAChDa,EAAKd,KAAO1H,EAAE+C,UAEd,OAAOyF,IAGXrB,WAGJA,OAOZ,IAAI+B,GAAkB,EACtB1K,EAAS2K,WAAa,SAAUzB,EAAM3O,GAClC,MAAMkI,EAAOrH,KAEb,IAAIwP,EAAMnI,EAAK1G,MAAMO,SAErB,OAAOjB,GAAGE,QAAQ0E,UAAU0K,WAAWhI,KAAKF,EAAMyG,EAAM,WAEpD,MAAMvN,EAAU8G,EAAKiF,IAAImD,iBAAiBpI,EAAK7G,eAAiB,UAChE6G,EAAKiF,IAAImD,iBAAiB,IAAMpI,EAAK5G,MAAQ,gBAAgBkK,QAAQ,SAAU+E,GAC3EA,EAAKC,iBAAiB1P,GAAGoF,OAAOC,MAAMsK,MAAO,SAAU7F,GAEnD,IADA,IAAIf,EAAQe,EAAEE,OACPjB,GAA2B,UAAlBA,EAAM6G,SAClB7G,EAAQA,EAAM8G,cAElB,MAAMC,EAAY/G,EAAMiE,cAAc,gCAAgChG,MAEtE1G,EAAQoK,QAAQ,SAAUqF,GAClBA,EAAOC,QAAQ,IAAM5I,EAAK5G,MAAQ,IAAMsP,GACxCC,EAAOzD,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QAG1CF,EAAOzD,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,cAMvD7I,EAAKmB,OACD2H,eAAgB9I,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,sBAC7D4P,iBAAkB/I,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,wBAC/D6P,YAAahJ,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,yBAC1D8P,gBAAiBjJ,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,iBAC9D+P,UAAWlJ,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,eACxDgQ,SAAUnJ,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,kBACvDiQ,cAAepJ,EAAKzD,WAAWqJ,cAAc,sCAC7CyD,WAAYrJ,EAAKzD,WAAWqJ,cAAc,iCAC1C0D,WAAYtJ,EAAKzD,WAAWqJ,cAAc,mEAE1C2D,qBAAsBvJ,EAAKzD,WAAWqJ,cAAc,wCAGxD5F,EAAKmB,MAAMqI,UAAYxJ,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,wBAEpE6G,EAAKmB,MAAMsI,qBAAuBzJ,EAAKiF,IAAIW,cAAc,0CAEzD5F,EAAKiF,IAAIW,cAAc,IAAMrI,EAASnE,MAAQ,qBAAqBkP,iBAAiB,QAAS,WACzFoB,EAAaxJ,KAAKF,KAGtBA,EAAKmB,MAAMwI,UAAY3J,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,gBAEpE6G,EAAKmB,MAAMyI,SAAW5J,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,mBAE/DP,GAAG4D,KAAKqN,gBACJC,UAAUC,GAAG,yDACb/J,EAAKmB,MAAMsI,qBAAqBpI,SAAU,GAGlD,GAAI9J,OAAOyS,MAAQzS,OAAO0S,YAAc1S,OAAO2S,UAAY3S,OAAO4S,KAAM,CACpEnK,EAAKmB,MAAM8H,gBAAgBmB,UAAW,EAEtCpK,EAAKmB,MAAM8H,gBAAgBX,iBAAiB1P,GAAGoF,OAAOC,MAAMsK,MAAO,SAAU7F,GAEzE,MACM2H,EAAOxN,SAASyN,cAAc,QAC9BC,EAFQ5R,KAEO8P,cACrB8B,EAAOC,aAAaH,EAHN1R,MAId0R,EAAKtN,YAJSpE,MAKd0R,EAAKI,QAELJ,EAAKK,sBAAsB,WAPb/R,MAQd4R,EAAOI,YAAYN,KAEvBrK,EAAKmB,MAAM8H,gBAAgBX,iBAAiB,SAAU,SAAU5F,GAC5D,IAAK1C,EAAK4K,UAAW,CACjB5K,EAAKkD,MAAMlD,EAAK1G,MAAM6C,OAAOC,OAE7B,GAAI4D,EAAKD,IAAK,CACVC,EAAKD,IAAIyC,GAAG5J,GAAGoF,OAAOC,MAAM4M,WAAYC,GACxC9K,EAAKD,IAAII,KAAK4K,UAAUrI,EAAEE,OAAOoI,OAASnS,QAASmH,aAK/DiL,QAAQC,IAAI,mCAGhBlL,EAAKmB,MAAM2H,eAAeR,iBAAiB,QAAS,WAChDtI,EAAKmL,mBACLC,EAAsBlL,KAAKF,KAG/BA,EAAKmB,MAAM4H,iBAAiBT,iBAAiB,QAAS,WAClDtI,EAAKqL,qBACLC,EAAwBpL,KAAKF,KAGjC,IAAIuL,EAAU,SAAUC,GACpBA,EAAaA,EAAWxJ,cAExB,MAAMyJ,EAAMvE,MAAMwE,KAAK1L,EAAKmB,MAAMqI,UAAUpB,iBAAiB,OAC7DqD,EAAInI,QAAQ,SAAUqI,GAClBA,EAAGC,MAAMC,QAAU,SAEvB,MAAMC,EAAWL,EAAIlG,OAAO,SAAUoG,GAClC,OAAOA,EAAG/C,QAAQ,sBAAwB5I,EAAK1G,MAAMC,QAAQG,iBAG3DqS,EAAa/L,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,sBAChE,GAA0B,IAAtBqS,EAAWzU,OAAc,CACzB+U,EAASxI,QAAQ,SAAUqI,GACvBA,EAAGC,MAAMC,QAAU,KAEvBE,EAAWH,MAAMI,WAAa,cAC3B,CACHD,EAAWH,MAAMI,WAAa,SAC9B,IAAIC,EAAI,IAAIC,OAAOV,EAAY,KAC/BM,EAASxI,QAAQ,SAAUqI,GACvBA,EAAGC,MAAMC,QAAUI,EAAE7I,KAAKuI,EAAG/F,cAAc,QAAQuG,aAAe,GAAK,SAGtEL,EAASM,KAAK,SAAUT,GACzB,MAA4B,KAArBA,EAAGC,MAAMC,WAEhBJ,EAAInI,QAAQ,SAAUqI,GACdA,EAAG/C,QAAQ,6CACX+C,EAAGC,MAAMC,QAAU,QAMvC,MAAMQ,EAAsB,WACxBd,EAAQ5S,KAAKiH,MAAMoC,cAAcD,SAErC/B,EAAKmB,MAAM6H,YAAYV,iBAAiB,QAAS+D,GACjDrM,EAAKmB,MAAM6H,YAAYV,iBAAiB,SAAU+D,GAGlD,IACI,GAAIrM,EAAKmB,MAAM6H,YAAYpD,cAAc,eAAgB,CAErD5F,EAAKmB,MAAM6H,YAAYV,iBAAiB,UAAW,SAAU5F,GAGxC,KAFN1C,EAAKmB,MAAM6H,YAAYpJ,OAQlCvH,WAAW,WACP,IAAIiU,EAAWtM,EAAKmB,MAAM6H,YAAYpJ,MAErB,KAAb0M,GACAf,EAAQe,IAEb,MAIf,MAAO5J,IAGP1C,EAAKmB,MAAM+H,UAAUZ,iBAAiB,QAAStI,EAAKuM,UAAUjL,KAAKtB,IACnEA,EAAKmB,MAAMgI,SAASb,iBAAiB,QAAStI,EAAKwM,YAAYlL,KAAKtB,IAEpE,MAAMyM,EAAOzM,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,wBAG1D,IAAIuT,EAAQ,SAAUC,EAAMC,GACJ,OAAhBA,EAAIpE,UACJoE,EAAMA,EAAInE,eAGd,MAAMoE,EAAQD,EAAIhH,cAAc,SAC1ByC,EAAOuE,EAAIhH,cAAc,QAE/B,GAAI+G,EAAM,CAENE,EAAM3H,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QACzCgE,EAAMC,QACND,EAAMjN,MAAQyI,EAAK8D,YACnB9D,EAAKnD,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAErC+D,EAAIhH,cAAcuC,EAAIrO,UAAUoL,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAChE+D,EAAIhH,cAAcuC,EAAInO,MAAMkL,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAC5D+D,EAAIhH,cAAcuC,EAAIlO,QAAQiL,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAC9D+D,EAAIhH,cAAcuC,EAAIpO,MAAMmL,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAC5D+D,EAAIhH,cAAcuC,EAAI/N,YAAY8K,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAClE+D,EAAIhH,cAAcuC,EAAI9N,YAAY6K,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAElE+D,EAAIhH,cAAcuC,EAAIjO,MAAMgL,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QAC/D+D,EAAIhH,cAAcuC,EAAIhO,QAAQ+K,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,YAC9D,CAEHgE,EAAM3H,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QACtCR,EAAKnD,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QAExC+D,EAAIhH,cAAcuC,EAAIrO,UAAUoL,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QACnE+D,EAAIhH,cAAcuC,EAAInO,MAAMkL,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QAC/D+D,EAAIhH,cAAcuC,EAAIlO,QAAQiL,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QACjE+D,EAAIhH,cAAcuC,EAAIpO,MAAMmL,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QAC/D+D,EAAIhH,cAAcuC,EAAI/N,YAAY8K,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QACrE+D,EAAIhH,cAAcuC,EAAI9N,YAAY6K,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QAErE+D,EAAIhH,cAAcuC,EAAIjO,MAAMgL,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAC5D+D,EAAIhH,cAAcuC,EAAIhO,QAAQ+K,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,UAItE7I,EAAK+M,WAAa,SAAUC,EAAUJ,GAClC,GAAIA,EAAK,CACL,IAAIK,GACA9E,EAAIrO,SACJqO,EAAInO,KACJmO,EAAIlO,OACJkO,EAAI/N,WACJ+N,EAAI9N,YAEJ6S,GACA/E,EAAI7N,KACJ6N,EAAI5N,MACJ4N,EAAI3N,SACJ2N,EAAI1N,QACJ0N,EAAIzN,OAEJyS,EAAsB,OAAhBP,EAAIpE,QAAmBoE,EAAMA,EAAIQ,WAE3CH,EAAa3J,QAAQ,SAAUkC,GAC3B2H,EAAIvH,cAAcJ,GAAK6H,OAASL,IAGpCE,EAAiB5J,QAAQ,SAAUkC,GAC/B2H,EAAIvH,cAAcJ,GAAK6H,QAAUL,MAK7CP,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBpF,EAAIrO,SAAU,SAAU4I,GACrF,IAAIyB,EAAOnE,EAAKoE,sBAAsBC,UAEtC3B,EAAEE,OAAO6F,cAAc7C,cAAcuC,EAAIzN,OAAOyR,YAAc,MAE9DqB,EAAWxN,EAAM0C,EAAEE,QAAQjC,KAAK,WAC5BX,EAAKoE,sBAAsBqJ,WAAWtJ,QAG9CsI,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBpF,EAAIpO,KAAM,SAAU2I,GACjF,IAAIyB,EAAOnE,EAAKoE,sBAAsBC,UAEtCqJ,EAAW1N,EAAM0C,EAAEE,QAAQjC,KAAK,WAC5BX,EAAKoE,sBAAsBqJ,WAAWtJ,QAI9CnE,EAAKwC,GAAGxC,EAAK1G,MAAM6B,MAAMS,cAAe,SAAU8G,GAC9C,GAAK1C,EAAK8D,WAON9D,EAAKD,IAAIgE,MAAM/D,EAAKgE,gBAAgB,4BAA8B1D,KAAM1H,GAAGoF,OAAOiG,QAAQC,cAPxE,CAClB,MAAMyJ,EAAc3N,EAAKmB,MAAMqI,UAAU5D,cAAc,eAAiBlD,EAAEkL,MAAQ,MAClFF,EAAW1N,EAAM2N,EAAY/H,cAAcuC,EAAIpO,OAC/C6C,EAAEoD,EAAKmB,MAAMqI,WAAWqE,SACpBC,UAAWpL,EAAEkL,MAAQD,EAAYI,cAClC,WAMX,MAAMC,EAAmB,SAAUhO,EAAMiO,GACrCjO,EAAKmB,MAAMqI,UAAUpB,iBAAiB,eAAe9E,QAAQ,SAAU4K,GACnE,GAAIA,EAASC,QAAQ/V,KAAO6V,EAAW,CACnC,MAAMG,EAAcF,EAAStI,cAAcuC,EAAIrO,UACzCuU,EAAWH,EAAStI,cAAcuC,EAAI5N,OAE5C6T,EAAYlJ,UAAUS,OAAO3F,EAAK1G,MAAMC,QAAQK,qBAChDwU,EAAYE,aAAa,QAAStO,EAAKgE,gBAAgB,oBACvDqK,EAASnJ,UAAUS,OAAO,QAC1B0I,EAASC,aAAa,QAAStO,EAAKgE,gBAAgB,iBAEpDhE,EAAK+M,YAAW,EAAOmB,GACvBxB,GAAM,EAAOwB,MAIrBlO,EAAKkD,MAAMlD,EAAK1G,MAAM6C,OAAOC,QAGjC,IAAIsR,EAAa,SAAU1N,EAAMuO,GAC7B,OAAO,IAAI5J,QAAQ,SAAUuB,EAASC,GAElC,MAAMqI,EAAUD,EAAQ9F,cAExBpQ,WAAW,WACP,GAAImW,EAAQtJ,UAAUC,SAASnF,EAAK1G,MAAMC,QAAQG,eAAgB,CAC9DsG,EAAK+M,YAAW,EAAOwB,GAEvBvO,EAAKkD,MAAMlD,EAAK1G,MAAM6C,OAAOC,OAE7BmS,EAAQD,aAAa,QAASC,EAAQpC,kBAErC,GAAInM,EAAKyO,mBAAoB,CAC9BT,EAAiBhO,EAAMwO,EAAQL,QAAQ/V,IACvC4H,EAAK0O,UAAUF,QAEfxO,EAAK0O,UAAUF,GAKfA,EAAQtJ,UAAUC,SAASnF,EAAK1G,MAAMC,QAAQG,eAC9CsG,EAAKgG,uBAAuBwI,EAAQL,QAAQ5H,KAAK5F,KAAK,WAClDuF,MAGJA,KAEL,MAIPsH,EAAa,SAAUxN,EAAMoO,GAC7B,OAAO,IAAIzJ,QAAQ,SAAUuB,EAASC,GAClC9N,WAAW,WACP,MAAMmW,EAAUJ,EAAY3F,cAE5BuF,EAAiBhO,EAAMwO,EAAQL,QAAQ/V,IACvC4H,EAAK+M,YAAW,EAAO/M,EAAKyO,oBAC5BzO,EAAK+M,YAAW,EAAMqB,GAEtBpO,EAAK2O,iBAAkB,EACvB3O,EAAK4O,cAAcJ,GAEnBtI,KACD,MAIXuG,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBvN,EAAK7G,eAAiB,IAAMgP,EAAInO,KAAM,SAAU0I,GAC7GgK,GAAM,EAAMhK,EAAEE,WAElB6J,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBvN,EAAK7G,eAAiB,IAAMgP,EAAIlO,OAAQ,SAAUyI,GAC/G1C,EAAK6O,YAAYnM,EAAEE,OAAO6F,kBAE9BgE,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBvN,EAAK7G,eAAiB,IAAMgP,EAAIjO,KAAM,SAAUwI,GAE7G,GAA8B,IADhBA,EAAEE,OAAO6F,cAAc7C,cAAc,SAAShG,MAChDmC,OAAOhL,OACf6B,GAAGkW,MAAM9O,EAAKgE,gBAAgB,2BAE7B,CACDhE,EAAK+O,cAAcrM,EAAEE,OAAO6F,cAAc0F,QAAQ/V,GAAIsK,EAAEE,OAAO6F,cAAc7C,cAAc,SAAShG,OACpG8M,GAAM,EAAOhK,EAAEE,YAGvB6J,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBvN,EAAK7G,eAAiB,IAAMgP,EAAIhO,OAAQ,SAAUuI,GAC/GgK,GAAM,EAAOhK,EAAEE,WAGnB6J,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBvN,EAAK7G,eAAiB,IAAMgP,EAAI/N,WAAa,IAAM4F,EAAK7G,eAAiB,IAAMgP,EAAI9N,WAAY,SAAUqI,GACtK,MAAM6H,EAAS7H,EAAEE,OAAO6F,cACxB,IAIIuG,EAHY9H,MAAMwE,KAAKhJ,EAAEE,OAAOsC,WAAWK,OAAO,SAAU0J,GAC5D,OAA+B,IAAxBA,EAAIhM,QAFF,oBAGV,GACsBiM,QAJZ,iBAI4B,IAAIC,cAE7CnP,EAAKoP,OAAOJ,EAAUzE,GAAQ5J,KAAK,SAAU8F,GACzC,GAAIA,EAAM,CACN,IAAI4I,EAAW9E,EAAO3E,cAAc,QAAQuG,YACxCmD,EAAQ,IAAIpD,OAAOlM,EAAK1G,MAAM0C,wBAAwBuT,KAAK,KAAM,MACjEC,EAAgBH,EAASH,QAAQI,EAAO,IAC5C1W,GAAG4D,KAAKiT,aAAaD,EAAgB,IAAMR,EAAShN,cAAehC,EAAK1G,MAAMuC,QAAQmT,GAAWvI,QAEjG7N,GAAGkW,MAAM9O,EAAKgE,gBAAgB,0BAK1CyI,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBvN,EAAK7G,eAAiB,IAAMgP,EAAI7N,KAAM,SAAUoI,GAC7G1C,EAAK+M,YAAW,EAAOrK,EAAEE,QACzB5C,EAAKG,KAAKuP,mBACV,MAAMrB,EAAW3L,EAAEE,OAAO6F,cAAc7C,cAAcuC,EAAI5N,OAC1D8T,EAASnJ,UAAUS,OAAO,QAC1B0I,EAASC,aAAa,QAAStO,EAAKgE,gBAAgB,iBAEpDtB,EAAEE,OAAO6F,cAAc7C,cAAcuC,EAAIzN,OAAOyR,YAAc,MAC9DnM,EAAK2P,eAAiB,KAG1BlD,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBvN,EAAK7G,eAAiB,IAAMgP,EAAI5N,MAAO,SAAUmI,GAC9G1C,EAAK2O,iBAAmBjM,EAAEE,OAAOsC,UAAUC,SAAS,QAChDnF,EAAK2O,kBACL3O,EAAK4P,uBAAyB,GAElClN,EAAEE,OAAO0L,aAAa,QAAStO,EAAKgE,gBAAgBhE,EAAK2O,gBAAkB,cAAgB,iBACvF3O,EAAK2O,gBACLjM,EAAEE,OAAOsC,UAAUQ,IAAI,QAGvBhD,EAAEE,OAAOsC,UAAUS,OAAO,WAKlC8G,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBvN,EAAK7G,eAAiB,IAAMgP,EAAI3N,SAAU,SAAUkI,GACtF,GAAvB1C,EAAK2P,eACL3P,EAAK2P,eAHD,GAIH3P,EAAK2P,eAAiB3P,EAAK2P,eAAiB,EAEjDjN,EAAEE,OAAO6F,cAAc7C,cAAc5F,EAAK7G,eAAiB,IAAMgP,EAAI1N,SAAS2P,UAAW,EAEzF1H,EAAEE,OAAO6F,cAAc7C,cAAcuC,EAAIzN,OAAOyR,YAAcnM,EAAK2P,eAAiB,EAAI,KAAQ,EAAI3P,EAAK2P,eAAkB,KAAO3P,EAAK2P,eAE5G,eAAvB3P,EAAK2P,iBACLjN,EAAEE,OAAOwH,UAAW,MAI5BqC,EAAKnE,iBAAiB,QAAS1P,GAAG0U,YAAYC,mBAAmBvN,EAAK7G,eAAiB,IAAMgP,EAAI1N,QAAS,SAAUiI,GAChH1C,EAAK2P,eAAiB3P,EAAK2P,eAhBnB,GAkBRjN,EAAEE,OAAO6F,cAAc7C,cAAcuC,EAAIzN,OAAOyR,YAAcnM,EAAK2P,eAAiB,EAAI,KAAQ,EAAI3P,EAAK2P,eAAkB,KAAO3P,EAAK2P,eAEvIjN,EAAEE,OAAO6F,cAAc7C,cAAc5F,EAAK7G,eAAiB,IAAMgP,EAAI3N,UAAU4P,UAAW,EAE/D,MAAvBpK,EAAK2P,iBACLjN,EAAEE,OAAOwH,UAAW,MAM5BpK,EAAKmB,MAAMiI,cAAcd,iBAAiB,QAAS,WAE/C1P,GAAG4D,KAAKqT,aAERC,EAAU5P,KAAKF,KAEnBA,EAAKmB,MAAMkI,WAAWf,iBAAiB,QAAS,kBAErCtI,EAAK+P,gBACZnX,GAAG4D,KAAKwT,QAAQC,qBAAqBjQ,EAAK1G,MAAMqB,gBAAgBE,kBAAcqV,GAC9EC,YAAYC,WAAWpQ,EAAK1G,MAAMqB,gBAAgBE,cAElDjC,GAAG4D,KAAKqT,aAERC,EAAU5P,KAAKF,KAEnBA,EAAKmB,MAAMmI,WAAWhB,iBAAiB,QAAS,WAC5CgD,EAAwBpL,KAAKF,KASjCA,EAAKmB,MAAMoI,qBAAqBjB,iBAAiB,QAAS,WAEtD,MAAM+H,EAAaxT,SAASC,KAAKsL,iBAAiB,wCAElD,GAAIiI,EAAWtZ,OAAS,EAAG,CACP,IAAI4N,QAAQ,SAAUuB,EAASC,GACvC5O,OAAO4Y,YACPjK,IAEAtN,GAAG0X,QAAQ/Y,OAAO4Y,aAAcvX,GAAGoF,OAAOuS,IAAIC,aAAc,WACxDtK,QAKJvF,KAAK,WACTwP,YAAYM,QAAQJ,EAAW,GAAGK,aAAa,SAAS,KAIhE9X,GAAG4D,KAAKqT,eAGZ7P,EAAKmB,MAAMC,YAAcvE,SAAS+I,cAAc,oCAChD5F,EAAKmB,MAAMC,YAAYkH,iBAAiB,SAAU,WAC1CtI,EAAKmB,MAAM2H,eAAe5D,UAAUC,SAASvM,GAAGoF,OAAOoH,QAAQyD,SAC/D7I,EAAKqC,cAAcsO,cAAchY,KAAK0I,SAG1C4G,EAAkBtP,KAAK0I,UAGvB9J,OAAO4Y,YACPnQ,EAAK4Q,aAELhY,GAAG0X,QAAQ/Y,OAAO4Y,aAAcvX,GAAGoF,OAAOuS,IAAIC,aAAc,WACxDxQ,EAAK4Q,eAIThU,EAAEiU,WAAW/Y,IACbA,OAKZyF,EAASuT,SAAW,aAKpBvT,EAASwT,WAAa,WAGlBnY,GAAG4D,KAAKqT,aAFGlX,KAGNqY,iBAHMrY,KAIN0S,sBAIT,IAAIP,EAAc,WACHnS,KAENoH,IAAIkR,IAAIrY,GAAGoF,OAAOC,MAAM4M,WAAYC,GAF9BnS,KAGNuY,eAHMvY,KAGcwI,MAAM8H,iBAE/BrQ,GAAGkW,MALQnW,KAKGqL,gBAAgB,2BAE9BoH,EAAwB,WACbzS,KAENwI,MAAM2H,eAAe5D,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAF/ClQ,KAGNwI,MAAM4H,iBAAiB7D,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,SAG/DyC,EAA0B,WACf3S,KAENwI,MAAM2H,eAAe5D,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QAFlDlQ,KAGNwI,MAAM4H,iBAAiB7D,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,SAG5Da,EAAe,WACJ/Q,KACNoH,IAAIgE,MADEpL,KACSsM,IAAIW,cAAc,kBAAkB/B,WACpDsN,SAAU,OAIlB5T,EAAS6T,aACLpQ,OAAQ,EACRC,WAAY,IAAK,EAAG,EAAG,KACvBM,aAAc,IAAK,IAAK,IAAK,KAC7BY,YAAa,GAGjB5E,EAAS8T,WACLlP,YAAa,EACbZ,aAAc,EAAG,IAAK,IAAK,MAG/BhE,EAAS+T,yBAA2B,SAAUC,GAC1C,IAEI9K,KACA+K,EAAS5Y,GAAG4D,KAAKiV,aAHV9Y,KAG4BoH,KAEvC,GALWpH,KAKFoH,IAAI2R,SAAU,CACnB,IAAIC,EANGhZ,KAMcoH,IAAI6R,MANlBjZ,KAM+BoH,IAAI8R,OAAOD,IAAMhZ,GAAG4D,KAAKsV,UAAUP,EAAYQ,SAN9EpZ,KAM6FoH,IAAI6R,IANjGjZ,KAM2GoH,IAAI8R,OAAOD,KAAOL,EAAYQ,SAChJtL,EAAK/O,EAAIia,EAAU,GAAGK,eAAeR,GACrC/K,EAAK3P,EAAI6a,EAAU,GAAGK,eAAeR,GAErC/K,EAAKwL,IAAMrb,KAAKsb,MAVTvZ,KAUoBoH,IAAI8R,OAAOM,iBAAiBR,IAAYK,eAAeR,GAElF/K,EAAK2L,OAAQ,MAEV,CACH3L,EAAK/O,EAAId,KAAKsb,MAAMX,EAAYQ,SAAS,IAAIC,eAAeR,GAC5D/K,EAAK3P,EAAIF,KAAKsb,MAAMX,EAAYQ,SAAS,IAAIC,eAAeR,GAGhE/K,EAAK4L,EAAKzb,KAAKsb,MAAMX,EAAYe,UAAUN,eAAeR,GAC1D/K,EAAK8L,SAAY3b,KAAKsb,MAAMX,EAAYgB,UAAUP,eAAeR,GACjE/K,EAAK+L,MAAQjB,EAAYiB,MAAMR,eAAeR,GAAUiB,sBAAuB,EAAGC,sBAAuB,IAEzG,OAAOjM,GAGXlJ,EAASoV,sBAAwB,SAAUC,GACvC,IAAI5S,EAAOrH,KAEXqH,EAAK2D,gBAAgB3D,EAAK5G,MAAQ,kBAAmB4G,EAAKsR,yBAAyBsB,EAAEC,IAAK,SAAUjP,GAEhG,GAAK5D,EAAKmB,MAAM2R,UA+C6B,kBAA1B9S,EAAKmB,MAAe,WAAoBnB,EAAKmB,MAAM2R,UAAUC,eAC5E/S,EAAKmB,MAAM2R,UAAUE,gBAAgBrS,KAAK,WACtCX,EAAKmB,MAAM2R,UAAUG,oBAAoBpP,UAAYD,EAChD5D,EAAKmB,MAAM2R,UAAUI,aACtBlT,EAAKmB,MAAM2R,UAAUK,kBAnDN,CACvBnT,EAAKmB,MAAM2R,WAAY,EAEvB,IAWIM,EAXAC,GACAC,QAAS,QACTC,QACIC,KAAMxT,EAAKgE,gBAAgB,kBAC3BrM,IAAKqI,EAAKgE,gBAAgB,wBAE9BoB,SACIqO,UAAW,aAKnB,MAAMC,EAAsB,SAAUC,GAClCN,EAAoBO,KAAOD,EAAiBE,KAAKC,MACjDV,EAAaO,EAAiBI,WAAW,eAAgBV,IAG7D,GAAIrT,EAAK9G,QAAQ8a,UAAW,CACxB,IAAIL,EAAmB3T,EAAKD,IAAIkU,mBAAmB,cAAgBjU,EAAK9G,QAAQ8a,UAAU,GAAG7E,cAAgBnP,EAAK9G,QAAQ8a,UAAUE,UAAU,IAAI,GAC7IP,EAGDD,EAAoBC,GAFpB3T,EAAKD,IAAIgU,WAAW/T,EAAK9G,QAAQ8a,WAAWrT,KAAK+S,OAIlD,CACHL,EAAoBpO,IAAMpI,SAASyN,cAAc,OACjDtK,EAAKD,IAAIkF,IAAIlI,YAAYsW,EAAoBpO,KAC7CmO,EAAapT,EAAKD,IAAIgU,WAAW,eAAgBV,GAGrDD,EAAWzS,KAAK,SAAUwT,GACtBA,EAAiBC,OAASpU,EAC1BA,EAAKD,IAAIkU,mBAAmB,2BAA2B1O,OAAO,SAAU8O,GACpE,MAAyB,UAAlBA,EAAMf,SAAuBe,IAAUF,IAC/C7Q,QAAQ,SAAU+Q,GACjBA,EAAMC,UAGVtU,EAAKmB,MAAM2R,UAAYqB,EAEvBA,EAAiBnB,gBAAgBrS,KAAK,WAClCwT,EAAiBI,KAAK3Q,WAe1C,IA+EI4Q,EAOAC,EAsBAC,EA5GAC,EAA2B,WAChBhc,KAEDwI,MAAMsI,qBAAqBpI,SAF1B1I,KAGFoH,IAAIgG,QAAQnN,GAAGoF,OAAOC,MAAMC,aAIrC4R,EAAY,WACZ,IAAI9P,EAAOrH,KAEXqH,EAAK8Q,WAEL1F,EAAsBlL,KAAKF,GAC3B2U,EAAyBzU,KAAKF,GAE9BA,EAAKwC,GAAGxC,EAAK1G,MAAM6B,MAAMC,eAAgB,SAAUwX,GAE/C5S,EAAK4U,aAAehC,EAAEC,GACtB7S,EAAK2S,sBAAsBC,GAE3B5S,EAAKmB,MAAMwI,UAAUS,UAAW,EAChCpK,EAAKmB,MAAM+H,UAAUkB,UAAW,EAEhCpK,EAAKmB,MAAMyI,SAASQ,UAAW,EAC/BpK,EAAKmB,MAAMgI,SAASiB,UAAW,EAG/BxR,GAAG4D,KAAKwT,QAAQC,qBAAqBjQ,EAAK1G,MAAMqB,gBAAgBE,aAAcmF,EAAKG,KAAK0U,mBAAmB7U,EAAKqC,eAAegB,YAEnIrD,EAAKwC,GAAGxC,EAAK1G,MAAM6B,MAAMI,aAAc,SAAUkL,MAIjDzG,EAAKkD,MAAMlD,EAAK1G,MAAM6C,OAAOvB,UAE7Bka,EAAc5U,KAAKF,EAAMA,EAAK1G,MAAMqB,gBAAgBG,2BAEpDkF,EAAKG,KAAK4U,aAAY,IAiDtBC,EAAkB,WACPrc,KAEFsc,cAAcC,QAFZvc,KAGFsc,cAAcE,OAEvBC,EAAqB/Y,MALV1D,OAqBX0c,EAAqB,WACrB,IAEIhI,EAhBgB,WACpB,IAAIiI,GAAY,SAAU,MAAO,KAAM,KAEvC,GAAI,WAAYzY,SAAU,MAAO,SAEjC,IAAK,IAAI5F,EAAI,EAAGA,EAAIqe,EAASve,OAAQE,IACjC,GAAKqe,EAASre,GAAK,WAAa4F,SAC5B,OAAOyY,EAASre,GAAK,SAG7B,OAAO,KAMMse,GAER1Y,SAASwQ,IACV2H,EAAgB3Y,MALT1D,MAOXsS,QAAQC,IAAI,aAPDvS,KAOqBsc,cAAcC,SAE9CM,EAAkB,WAGbd,IACDA,EAAsBW,EAAmB/T,KAHlC3I,OAKN6b,IACDA,EA9Cc,WAGlBiB,EAAqBpZ,MAFV1D,OA6C4B2I,KAN5B3I,OAQN8b,IACDA,EAAmBO,EAAgB1T,KAT5B3I,OAWXpB,OAAO+Q,iBAAiB,mBAAoBoM,GAAqB,GAGjE,GAAI9b,GAAG4D,KAAKkZ,gBAAkB5L,UAAU6L,QAAUC,UAAUC,UAAUC,MAAM,cAAgBF,UAAUC,UAAUC,MAAM,UAAW,CAC7Hve,OAAO+Q,iBAAiB,WAAYkM,GAAkB,GACtDjd,OAAO+Q,iBAAiB,WAAYmM,GAAkB,OACnD,CACHld,OAAO+Q,iBAAiB,OAAQkM,GAAkB,GAClDjd,OAAO+Q,iBAAiB,QAASmM,GAAkB,KAiBvDgB,EAAuB,WACvB,IAEI1F,EAAkBnX,GAAG4D,KAAKwT,QAAQ+F,qBAF3Bpd,KAEqDW,MAAMqB,gBAAgBE,cAClFkV,GAAmBA,EAAgBhZ,OAAS,GAC5CoZ,YAAYM,QAJL9X,KAIkBW,MAAMqB,gBAAgBE,aAA2C,iBAAtB,EAAiCkV,EAAkBiG,KAAKC,UAAUlG,KAE1IqF,EAAuB,WACvB,IAAIpV,EAAOrH,KAEXwX,YAAY+F,QAAQlW,EAAK1G,MAAMqB,gBAAgBE,cAAc8F,KAAK,SAAUyF,GACpD,OAAhBA,GAAwC,SAAhBA,GAA0BA,EAAYrP,OAAS,GACvE6B,GAAG4D,KAAKwT,QAAQC,qBAAqBjQ,EAAK1G,MAAMqB,gBAAgBE,aAAcuL,MAMtF0O,EAAgB,SAAUqB,GAC1B,IAAInW,EAAOrH,KAEA,IAAIgM,QAAQ,SAAUuB,EAASC,GAClC5O,OAAO4Y,YACPjK,IAEAtN,GAAG0X,QAAQ/Y,OAAO4Y,aAAcvX,GAAGoF,OAAOuS,IAAIC,aAAc,WACxDtK,QAKPvF,KAAK,WACNwP,YAAY+F,QAAQC,GAAmBxV,KAAK,SAAUyV,GAClD,GAAmC,MAA/BA,EAAqC,CACrC,MAAMC,EAASrW,EAAKzD,WAAWqJ,cAAc,2CACvC0Q,EAAWD,EAAOzQ,cAAc,0BACtC0Q,EAAShI,aAAa,OAAQ6H,GAC9BG,EAASjV,SAAU,EAEnBxE,SAAS+I,cAAc,gBAAgBuG,YAAcvT,GAAG4D,KAAKqN,eAAiB7J,EAAKgE,gBAAgB,qBAAsBhE,EAAKgE,gBAAgB,6BAE9IqS,EAAOzQ,cAAc,MAAMuG,YAAcgK,GAAqBnW,EAAK1G,MAAMqB,gBAAgBI,qBACrFiF,EAAKgE,gBAAgB,sBAAwB,IAAMhE,EAAKgE,gBAAgB,WACxEhE,EAAKgE,gBAAgB,4BAEzBpL,GAAG4D,KAAK+Z,UAAUvW,EAAKzD,WAAWqJ,cAAc,iDAK5D5F,EAAKD,IAAIgE,MAAOnL,GAAG4D,KAAKqN,eAAqE7J,EAAKgE,gBAAgB,qBAAzEhE,EAAKgE,gBAAgB,8BAC1D1D,KAAM1H,GAAGoF,OAAOiG,QAAQC,WAIhC3G,EAASiZ,aAAe,SAAU1e,GAG9Bc,GAAG4D,KAAK+Z,UAFG5d,KAEY4D,WAAWqJ,cAAc,8CAC5C6Q,cAAe,WAEP7Z,EAAEiU,WAAW/Y,IACbA,OAKZ,OAAO,GAGXyF,EAAS4N,iBAAmB,WACxB,IAAInL,EAAOrH,KACP+d,GAAoB,EAEnB1W,EAAK2W,UACN3W,EAAK8Q,WAGT9Q,EAAKkD,MAAMlD,EAAK1G,MAAM6C,OAAOvB,UAE7B,IACIhC,GAAG4D,KAAKwT,QAAQC,qBAAqBjQ,EAAK1G,MAAMqB,gBAAgBK,KAAMgF,EAAK1G,MAAMqB,gBAAgBK,MACnG,MAAO4b,GACDA,EAAMC,OAASC,aAAaC,mBAC5Bne,GAAGkW,MAAM9O,EAAKgE,gBAAgB,mCAC7BpL,GAAGge,MAAMA,GAEdF,GAAoB,EAGxB,GAAIA,EAAmB,EA3MA,WAGvB,IAFW/d,KAEDsc,cAAe,CACrB,IAAI+B,GACAC,KAAM,kRACNC,IAAK,klCALFve,KAQFsc,cAAgBpY,SAASyN,cAAc,SARrC3R,KASFsc,cAAc3G,aAAa,OAAQ,IATjC3V,KAUFsc,cAAc3G,aAAa,QAAS,IAVlC3V,KAWFsc,cAAc3G,aAAa,qBAAsB,IAX/C3V,KAYFsc,cAAc3G,aAAa,cAAe,IAZxC3V,KAaFsc,cAAc3G,aAAa,QAAS,+BAEzC,IAAI6I,EAAata,SAASyN,cAAc,UACxC6M,EAAWC,IAAMJ,EAAMC,KACvBE,EAAW7W,KAAO,aAjBX3H,KAkBFsc,cAAclY,YAAYoa,GAE/B,IAAIE,EAAYxa,SAASyN,cAAc,UACvC+M,EAAUD,IAAMJ,EAAME,IACtBG,EAAU/W,KAAO,YAtBV3H,KAuBFsc,cAAclY,YAAYsa,GAvBxB1e,KA0BNsc,cAAcE,SAiLM9Y,MAAM2D,GAC3BwV,EAAgBnZ,MAAM2D,GAEtBA,EAAK+P,gBAAkBnX,GAAG4D,KAAKwT,QAAQ+F,qBAAqB/V,EAAK1G,MAAMqB,gBAAgBE,cACvF,GAAImF,EAAK+P,gBAAiB,CACV/P,EAAKwW,aAAa,WAC1BlL,EAAwBpL,KAAKF,MAI7BA,EAAKmB,MAAMkI,WAAWxD,aAEvBiK,EAAU5P,KAAKF,QACjBsL,EAAwBpL,KAAKF,IAG1CzC,EAAS8N,mBAAqB,WAC1B,IAAIrL,EAAOrH,KAEP2e,EAAsB,WAEtBtX,EAAKmB,MAAM2R,UAAUwB,QAErBmB,EAAqBpZ,MAAM2D,GAE3BA,EAAKG,KAAK4U,aAAY,UAGf/U,EAAKuX,oBAEPtP,GACDjI,EAAKiF,IAAIW,cAAc5F,EAAK7G,eAAiB,iBAAiByM,cAAc,SAASC,SA9MnE,WACflN,KACFsc,eADEtc,KAEFsc,cAAcuC,UA8MKnb,MAAM2D,IA3Ib,WAErBzI,OAAOkgB,oBAAoB,mBAAoB/C,GAAqB,GAGpE,GAAI9b,GAAG4D,KAAKkZ,gBAAkB5L,UAAU6L,QAAUC,UAAUC,UAAUC,MAAM,cAAgBF,UAAUC,UAAUC,MAAM,UAAW,CAC7Hve,OAAOkgB,oBAAoB,WAAYjD,GAAkB,GACzDjd,OAAOkgB,oBAAoB,WAAYhD,GAAkB,OACtD,CACHld,OAAOkgB,oBAAoB,OAAQjD,GAAkB,GACrDjd,OAAOkgB,oBAAoB,QAAShD,GAAkB,MAkInCpY,MAAM2D,GAEzBA,EAAKiR,IAAIjR,EAAK1G,MAAM6B,MAAMC,gBAC1B4E,EAAKiR,IAAIjR,EAAK1G,MAAM6B,MAAMI,cAE1B+P,EAAwBpL,KAAKF,GAE7BA,EAAKmB,MAAMwI,UAAU/J,MAAQ,GAC7BI,EAAKmB,MAAMwI,UAAUS,UAAW,EAChCpK,EAAKmB,MAAM+H,UAAUkB,UAAW,EAEhCpK,EAAKmB,MAAMyI,SAAShK,MAAQ,GAC5BI,EAAKmB,MAAMyI,SAASQ,UAAW,EAC/BpK,EAAKmB,MAAMgI,SAASiB,UAAW,EAE/BpK,EAAKkD,MAAMlD,EAAK1G,MAAM6C,OAAOvB,UAC7BoF,EAAKkD,MAAMlD,EAAK1G,MAAM6C,OAAOD,KAI7B,OAAO,GAGX,GAAI8D,EAAKG,KAAKuX,iBAAkB,CAC5B1X,EAAKD,IAAIgE,MAAM/D,EAAKgE,gBAAgB,6BAChCmN,SAAU,MAGd,OAAOmG,IACJ,OAAOA,KAIlB/Z,EAASoa,gBAAkB,WACvB,MAAM3X,EAAOrH,KACb,OAAO,IAAIgM,QAAQ,SAAUuB,EAASC,GAClC,IAAIyR,KAEJzH,YAAY0H,OAAOlX,KAAK,SAAUkX,GAQ9B,GAAmB,IAPnBA,EAAOA,EAAKtS,OAAO,SAAUuS,GACzB,OAA6D,IAAvDA,EAAE7U,QAAQjD,EAAK1G,MAAMqB,gBAAgBE,eAA2E,IAAnDid,EAAE7U,QAAQjD,EAAK1G,MAAMqB,gBAAgBC,WAC7F,UAAUmd,KAAKD,MAKrB/gB,OAAa,CAClBiJ,EAAKqG,gBAAkBuR,EACvB1R,EAAQ0R,GAGZ,MAAM3Q,EAAW,IAAIC,MAAM2Q,EAAK9gB,QAChC8gB,EAAKvU,QAAQ,SAAU3D,EAAKwH,GACxBF,EAASE,GAAO,IAAIxC,QAAQ,SAAUqT,EAAKC,GACvC9H,YAAY+F,QAAQvW,EAAK,SAAU+C,EAAGwV,GAClCF,EAAIE,SAKhBvT,QAAQC,IAAIqC,GAAUtG,KAAK,SAAUwX,GACjC,GAAIA,GAAWA,EAAQphB,OAAQ,CAC3BohB,EAAQ7U,QAAQ,SAAU2I,IAClBA,EAAI+J,KAAKoC,MAAMnM,cACF/E,MACb0Q,EAASA,EAAOS,OAAOpM,GAEvB2L,EAAOnT,KAAKwH,KAIpB,IAAIqM,EAAcV,EAAO7gB,OAAS,EAAIwhB,EAAaX,GAAUA,EAC7D5X,EAAKqG,gBAAkBiS,EACvBpS,EAAQoS,WAU5B,IAAIC,EAAe,SAAUX,GACzB,IAAIU,KAEJ,IAAK,IAAI1K,KAASgK,EACd,GAAIA,EAAOhK,IAAqC,iBAAnBgK,EAAOhK,GAAsB,CACtD0K,EAAY7T,KAAKmT,EAAOhK,IACxB0K,EAAYE,KAAK,SAAUC,EAAGC,GAC1B,MAAwB,iBAAZD,EAAM,MACP7b,EAAEiU,WAAW4H,EAAE5W,KAAK8W,eAAiBF,EAAE5W,KAAK8W,cAAcD,EAAE7W,MACvD,IAK5B,OAAOyW,GAIX/a,EAASqb,gBAAkB,SAAUhB,GACjC,MAAM5X,EAAOrH,KACb,OAAO,IAAIgM,QAAQ,SAAUuB,EAASC,GAClC,MAAMc,KACN2Q,EAAOtU,QAAQ,SAAUuV,GACrB5R,EAASxC,KAAK,IAAIE,QAAQ,SAAUqT,EAAKC,GACrC9H,YAAYM,QAAQzQ,EAAK1G,MAAMqB,gBAAgBC,SAAW,IAAMie,EAAEtS,IAAKyP,KAAKC,UAAU4C,GAAI,SAAUnW,EAAGwV,GACnGF,EAAIE,UAKhBvT,QAAQC,IAAIqC,GAAUtG,KAAK,WACvBX,EAAK2X,kBAAkBhX,KAAK,WACxBX,EAAK4Q,aACL1K,WAOhB3I,EAASub,mBAAqB,WAC1B,MAAM9Y,EAAOrH,KACb,OAAO,IAAIgM,QAAQ,SAAUuB,EAASC,GAC7BnG,EAAKqG,gBAMNH,EAAQlG,EAAKqG,iBALbrG,EAAK2X,kBAAkBhX,KAAK,SAAU0F,GAClCH,EAAQG,QASxB9I,EAASqT,WAAa,WAClB,IAAI5Q,EAAOrH,KAEOqH,EAAKmB,MAAMqI,UAAUpB,iBAAiB,MAC9C9E,QAAQ,SAAUqI,GACxBA,EAAGC,MAAMC,QAAU,SAGvB7L,EAAK8Y,qBAAqBnY,KAAK,SAAUiX,GAErC,GAAImB,EAASnB,GAAS,CAClB5X,EAAKmB,MAAMqI,UAAUpB,iBAAiB,yDAAyD9E,QAAQ,SAAUqI,GAC7GA,EAAGC,MAAMC,QAAU,KAEvB7L,EAAKmB,MAAM6H,YAAYoB,UAAW,MAEjC,CACD,MAAM4O,EAAuBhZ,EAAKyO,mBAClC,IAAIwK,EACAD,IACAC,EAAyBD,EAAqB7K,QAAQ5H,KAE1DvG,EAAKmB,MAAMqI,UAAUpB,iBAAiB,eAAe9E,QAAQ,SAAUqI,GACnE3L,EAAKmB,MAAMqI,UAAUmB,YAAYgB,KAGrC,IAAK,IAAI1U,EAAI,EAAGA,EAAI2gB,EAAO7gB,OAAQE,IAAK,CACpC,IAAI4hB,EAAIjB,EAAO3gB,GACI,iBAAR,GACP+I,EAAK2D,gBAAgB3D,EAAK5G,MAAQ,eAC9BhB,GAAInB,EAAGsP,IAAKsS,EAAEtS,IAAK1E,KAAMgX,EAAEhX,KAAOgX,EAAEhX,KAAKE,OAAS,IACnD,SAAU6B,GACT,MACMsV,GADS,IAAIC,WACEC,gBAAgBxV,EAAM,aAAa9G,KAAKuc,WAC7DrZ,EAAKmB,MAAMqI,UAAUzM,YAAYmc,KAKzCD,GACAjZ,EAAKsZ,iBAAiBtZ,EAAKmB,MAAMqI,UAAU5D,cAAc,gBAAkBqT,EAAyB,OAGxGjZ,EAAKmB,MAAM6H,YAAYoB,UAAW,MAK9C7M,EAASgc,kBAAoB,WAGpBhiB,OAAOiiB,IACR5gB,GAAGG,WAAWH,GAAGoF,OAAOuS,IAAIkJ,MAGhC,MAAMC,EAAUF,GAAGG,OAAO,0CAA0CC,OAAOC,wBAN9DlhB,KAORmhB,MAAQjd,SAASyN,cAAc,OAPvB3R,KAQRmhB,MAAM5U,UAAUQ,IAAI,SARZ/M,KASRmhB,MAAMlO,MAAMmO,MAAQL,EAAQK,MAAQ,KAT5BphB,KAURmhB,MAAMlO,MAAMoO,OAASN,EAAQM,OAAS,KAV9BrhB,KAYRshB,cAAgBpd,SAASyN,cAAc,OAZ/B3R,KAaRshB,cAAc/U,UAAUQ,IAAI,iBAbpB/M,KAcRshB,cAAc/U,UAAUQ,IAdhB/M,KAcyBS,MAAQ,mCAdjCT,KAeRshB,cAAc/U,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,QAftClQ,KAgBRshB,cAAcrO,MAAMmO,MAAQ,KAhBpBphB,KAiBRshB,cAAcrO,MAAMoO,OAASN,EAAQM,OAAS,KAjBtCrhB,KAmBRuhB,kBAAoBrd,SAASyN,cAAc,OAnBnC3R,KAoBRuhB,kBAAkBhV,UAAUQ,IAAI,qBApBxB/M,KAqBRuhB,kBAAkBhV,UAAUQ,IAAI,qDArBxB/M,KAsBRuhB,kBAAkBhV,UAAUQ,IAAI,QAtBxB/M,KAuBRuhB,kBAAkBtO,MAAMmO,MAAQL,EAAQK,MAAQ,KAvBxCphB,KAwBRuhB,kBAAkBtO,MAAMoO,OAASN,EAAQM,OAAS,KAxB1CrhB,KA0BRmhB,MAAMlO,MAAMuO,IAAMT,EAAQS,IAAM,KA1BxBxhB,KA2BRmhB,MAAMlO,MAAMwO,KAAOV,EAAQU,KAAO,KA3B1BzhB,KA4BRmhB,MAAMlO,MAAMyO,OAASX,EAAQW,OAAS,KA5B9B1hB,KA6BRmhB,MAAMlO,MAAM0O,MAAQZ,EAAQY,MAAQ,KA7B5B3hB,KA8BRmhB,MAAMlO,MAAMmG,SAAW,WA9BfpZ,KA+BRmhB,MAAMlO,MAAM2O,OAAS,MA/Bb5hB,KAgCRmhB,MAAMlO,MAAMC,QAAU,OAhCdlT,KAkCRshB,cAAcld,YAlCNpE,KAkCuBuhB,mBAlCvBvhB,KAmCRmhB,MAAM/c,YAnCEpE,KAmCeshB,eAC5Bpd,SAASC,KAAKC,YApCDpE,KAoCkBmhB,QAInCvc,EAASid,mBAAqB,WAC1B,MAAMxa,EAAOrH,KACb,GAAIqH,EAAK8Z,MAAO,CACZ9Z,EAAK8Z,MAAMrR,cAAckC,YAAY3K,EAAK8Z,OAC1C9Z,EAAK8Z,MAAQ,KACb9Z,EAAKia,cAAgB,KACrBja,EAAKka,kBAAoB,OAIjC3c,EAASkd,iBAAmB,SAAUC,EAAUC,EAASC,EAAUC,GAG/D,GAFWliB,KAEFmhB,MAAO,CACqB,SAH1BnhB,KAGEmhB,MAAMlO,MAAMC,UAHdlT,KAIEmhB,MAAMlO,MAAMC,QAAU,IAJxBlT,KAOFshB,cAAc/U,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QAEtD,IAAIiS,EAAOJ,EAAS9H,EAChBmI,GAAYD,EAAOlkB,KAAKC,MAAM6jB,EAASM,EAAE,GAAKL,EAAQ,GAAID,EAASM,EAAE,GAAKL,EAAQ,KAAOC,EAAW,IAVjGjiB,KAYFshB,cAAcrO,MAAMmO,MAAQgB,EAAW,IAE5C,IAEIE,EACAC,EAHA1J,EAdG7Y,KAcWoH,IAAI7G,QAAQsY,QAdvB7Y,KAcsCoH,IAAI7G,QAAQsY,OAAOtC,QAAQ,IAAK,WAAQgB,EACjFiL,EAAMC,SAAST,EAAQ,GAAGU,QAAQ,IAAIrJ,eAAeR,GAGzD,GAAKsJ,EAAO,IAAQ,EAAG,CACnBG,EAAOrkB,KAAKsb,MAAO4I,EAAO,IAAQ,KAClCI,EAAU,SACP,CACHD,EAAOrkB,KAAKsb,MAAO4I,EAAO,IAAQ,KAAO,IACzCI,EAAU,MAGdD,EAAOA,EAAKjJ,eAAeR,GA1BpB7Y,KA4BFuhB,kBAAkBrW,UAAY,cAAgBsX,EAAM,sBAAuCF,EAAOC,EAAU,iBAAmBL,EAAW,aAAeA,EAASrU,SAAW,UAAY,MAItMjJ,EAAS+d,SAAW,SAAUC,EAAUC,GACpC,IAAIC,EAAOD,EAASD,EAChB3I,KACA8I,EAAiB9kB,KAAK+kB,MAAMF,EAAO,IAAO,GAAK,GAAK,IACxDA,GAAyB,IAAjBC,EAAwB,GAAK,GAAK,GAE1C,IAAIE,EAAkBhlB,KAAK+kB,MAAMF,EAAO,IAAO,GAAK,IACpDA,GAA0B,IAAlBG,EAAyB,GAAK,GAEtChJ,EAAEhU,EAAIgd,EAAoC,GAAjBF,EAEzB,IAAIG,EAAoBjlB,KAAK+kB,MAAMF,EAAO,IAAO,IACjDA,GAA4B,IAApBI,EAA2B,GAEnCjJ,EAAEkJ,EAAID,EAENjJ,EAAEmJ,EAAInlB,KAAK+kB,MAAMF,EAAO,KAExB,OAAO7e,EAAEof,UAAWpJ,GAAKpM,UAAW,QAAUoM,EAAEhU,GAAGqd,OAAO,GAAK,KAAO,QAAUrJ,EAAEkJ,GAAGG,OAAO,GAAK,KAAO,QAAUrJ,EAAEmJ,GAAGE,OAAO,MAGlI1e,EAASqR,cAAgB,SAAUjD,GAC/B,IAAI3L,EAAOrH,KAEXqH,EAAK2P,eAAiB,EAEtB3P,EAAK0O,UAAU/C,GAAI,GAAOhL,KAAK,WAC3BX,EAAKG,KAAKyO,mBAIlBrR,EAASmR,UAAY,SAAU/C,EAAIuQ,GAC/B,IAAIlc,EAAOrH,KAEXgc,EAAyBzU,KAAKF,GAC9B,OAAO,IAAI2E,QAAQ,SAAUuB,EAASC,GAClCnG,EAAKsZ,iBAAiB3N,GACtB3L,EAAKmc,iBAAiBxQ,GAAIhL,KAAK,WAC3BX,EAAKoc,eAAezQ,GAEpB3L,EAAK8Q,WACL5K,SAMZ3I,EAAS6e,eAAiB,SAAUzQ,EAAI0Q,GACpC,IAAIrc,EAAOrH,KAEX,GAAI0jB,EAAJ,CAEIrc,EAAKG,KAAKuP,mBACV1P,EAAK+M,YAAW,EAAOpB,OAH3B,CAOA,IAAK3L,EAAKsc,SAAU,CAChBtc,EAAKsc,SAAWtc,EAAKoc,eAAe9a,KAAKtB,EAAM2L,GAAI,GACnDpU,OAAO+Q,iBAAiB,SAAUtI,EAAKsc,UAAU,GAGrDtc,EAAKuc,OACDC,gBAGAxc,EAAKmB,MAAMsb,iBACXzc,EAAKmB,MAAMsb,eAAiBzc,EAAKmB,MAAMsb,eAAeC,YAEvC,SAAU/Q,GACzB,OAAO,IAAIhH,QAAQ,SAAUuB,EAASC,GAClCvN,GAAG0X,QACE1X,GAAG+jB,OAAS/jB,GAAG+jB,KAAKC,UACrBhkB,GAAGI,YAAc,oBACjB,WACIgH,EAAK6c,gBAAgBlR,GAAIhL,KAAK,SAAUQ,GACpC,IAAI2b,EAAU3b,EAAMsF,KACpB,GAAIqW,EAAJ,CACI,IAAIplB,EAAGyjB,EAAKzjB,KAAQyjB,KACpB,IACI4B,EAAQC,EAIRvV,EALAwV,GAAQ,EAERC,KACAC,KAMAC,EAAc,WACd,GAAI3V,EAAK4V,aAAevW,GAAGW,KAAK6V,eAAeC,KAC3C9V,EAAK4V,aAAevW,GAAGW,KAAK6V,eAAeE,KAAM,CACjD,IAAI5C,EAAW,EACf,GAAI5a,EAAKD,IAAI6R,MAAQ5R,EAAKD,IAAI7G,QAAQukB,OAAQ,CAC1Cxb,KAAO,IAAI6E,GAAGW,KAAKiW,WAAW9kB,GAAG4D,KAAKsV,UAAUrK,EAAKkW,iBAAkB3d,EAAKD,IAAI6R,IAAK5R,EAAKD,IAAI7G,QAAQukB,SACtG7C,EAAW3Y,KAAK2b,iBAEhBhD,EAAWnT,EAAKmW,YAEpB,OAAOC,YAAYjD,EAAW,KAAMS,QAAQ,IAGhD,OAAO,MAEPnjB,EAAU,WACV,GAAIuP,EAAK4V,aAAevW,GAAGW,KAAK6V,eAAeE,MAC3C/V,EAAK4V,aAAevW,GAAGW,KAAK6V,eAAeQ,IAAK,CAChD,IAAIrC,EAAOhU,EAAKsW,oBAAoB,GAAKtW,EAAKuW,qBAAqB,GACnE,OACIjC,EAAGnlB,KAAK+kB,MAAOF,EAAO,IAAQ,IAC9BK,EAAGllB,KAAK+kB,MAAQF,EAAO,IAAe,IACtC7c,EAAGhI,KAAK+kB,MAAQF,EAAO,KAAoB,KAInD,OAAO,MAGPwC,EAAO,SAAUvmB,GACjB,GAAIsI,EAAKuc,MAAMC,YAAYzlB,OAAS,EAAG,CACnC,IAAI6jB,EAAW,EACf5a,EAAKuc,MAAMC,YACNlZ,QAAQ,SAAUvC,EAAOoG,EAAK+W,GAC3B,IAAIC,EAAe,IAARhX,EAAYpG,EAAQmd,EAAI/W,EAAM,GAEzC,GAAInH,EAAKD,IAAI6R,MAAQ5R,EAAKD,IAAI7G,QAAQukB,OAAQ,CAC1C1c,EAAQnI,GAAG4D,KAAKsV,UAAU/Q,EAAOf,EAAKD,IAAI6R,IAAK5R,EAAKD,IAAI7G,QAAQukB,QAChEU,EAAOvlB,GAAG4D,KAAKsV,UAAUqM,EAAMne,EAAKD,IAAI6R,IAAK5R,EAAKD,IAAI7G,QAAQukB,QAGlE,MAAMW,EAAKrd,EAAM,GAAKod,EAAK,GACrBE,EAAKtd,EAAM,GAAKod,EAAK,GAC3BvD,GAAYhkB,KAAKO,KAAKinB,EAAKA,EAAKC,EAAKA,GAErC3mB,EAAE+M,KAAKoZ,WAAWjD,EAASS,QAAQ,SAK/CiD,EAAe,SAAUnD,GAEzB,IADA,IACSlkB,EAAI,EAAGA,EAAI+I,EAAKuc,MAAMC,YAAYzlB,OAAQE,IAAK,CACpD,KAAI+I,EAAKuc,MAAMC,YAAYvlB,GAAGF,OAAS,GAclC,CACDmP,EAAQ,MACR,OAfA,IAAIgS,EAAKthB,KAAKsb,MAAqC,GAA/BlS,EAAKuc,MAAMC,YAAYvlB,GAAG,IAAW,GACrDgmB,GAAS/E,EAAI,IACb+E,GAAQ,GAEZ9B,EAAI1W,KAAKyT,GAEA,GAALjhB,IACA8lB,EAASC,EAAS9E,GAEtB6E,EAASnmB,KAAK2nB,IAAIxB,EAAQ7E,GAC1B8E,EAASpmB,KAAKe,IAAIqlB,EAAQ9E,MAlE9B,IAAKpR,GAAG/D,OAAOgE,SAAWC,aAAa8V,GA4E7CvX,OAAO,SAAU3D,GACf,MAAyD,eAAlDA,EAAQ4c,cAAcC,UAAUzc,eAAoF,oBAAlDJ,EAAQ4c,cAAcC,UAAUzc,gBAC1GsB,QAAQ,SAAU1B,GAGjB,QAFA6F,EAAO7F,EAAQ4c,eAEFC,UAAUzc,eACnB,IAAK,aAED,GAAIb,EAAM4D,SAAW+B,GAAGW,KAAK6V,eAAeE,MACxCrc,EAAM4D,SAAW+B,GAAGW,KAAK6V,eAAeC,IAAK,CAE7CJ,EAAOjlB,IACFklB,IACLF,EAAgBtkB,GAAG+jB,KAAKC,UAAU8B,kBAAmBC,OAAQlX,EAAKkW,iBAAkBiB,mBAAoB5e,EAAK9C,UAC7G8C,EAAKuc,MAAMC,YAAcxc,EAAKuc,MAAMC,YAAYnE,OAAO5Q,EAAKkW,kBAE5DM,EAAKvmB,GACL4mB,EAAanD,GAEjB,MACJ,IAAK,kBAED,GAAIha,EAAM4D,SAAW+B,GAAGW,KAAK6V,eAAeE,MACxCrc,EAAM4D,SAAW+B,GAAGW,KAAK6V,eAAeC,IAIxC,IAFA,IAAIsB,EACAC,EAAKrX,EAAKsX,iBACL9nB,EAAI,EAAGA,EAAI6nB,EAAG/nB,OAAQE,IAAK,CACtBmmB,EAAY0B,EAAG7nB,IAErB6nB,EAAG7nB,GAAGomB,aAAevW,GAAGW,KAAK6V,eAAeE,OAC5CqB,GAAiBC,EAAG7nB,GAAG8mB,oBAAoB,GAAKe,EAAG7nB,GAAG+mB,qBAAqB,IAE/Ehe,EAAKuc,MAAMC,YAAcxc,EAAKuc,MAAMC,YAAYnE,OAAOyG,EAAG7nB,GAAG0mB,kBAEzDkB,IAAS1B,EAAOjlB,KAEpB+lB,EAAKvmB,GACL4mB,EAAanD,GAIrB,MACJ,QACI,OAAO,QAKfA,aAAejU,OAAuB,GAAdiU,EAAIpkB,SAC5BkmB,GAAQ,GAGZjd,EAAKgf,UAAa/B,EAAkG,KAA1FrgB,EAAEof,WAAamB,KAAMA,EAAMhC,IAAKA,EAAKzjB,EAAGA,EAAGunB,KAAMlC,EAAQmC,KAAMlC,GAAUE,GAEnGhX,EAAQlG,EAAKgf,gBAIjB9Y,EAAQ,aAQ5BiZ,CAAaxT,GAAIhL,KAAK,SAAU8F,GACf7N,GAAG4D,KAAKiV,aAAazR,EAAKD,KACvC,GAAY,MAAR0G,EAAc,CACVA,EAAK0W,OAAM1W,EAAK0W,MAAQ,QAAU1W,EAAK0W,KAAKve,GAAGqd,OAAO,GAAK,KAAO,QAAUxV,EAAK0W,KAAKrB,GAAGG,OAAO,GAAK,KAAO,QAAUxV,EAAK0W,KAAKpB,GAAGE,OAAO,IAC9IxV,EAAKkY,OAAS3e,EAAKuc,MAAMC,YACzBxc,EAAKof,cAAe,MAEnB,CACDpf,EAAKof,cAAe,EACpB3Y,GACI4Y,IAAKrf,EAAKgE,gBAAgB,6BAIlCyC,EAAK6Y,UAAYtf,EAAKvC,WAAWC,WACjC+I,EAAK8Y,UAAYvf,EAAKvC,WAAWE,WAEjC8I,EAAK+Y,SAAWxf,EAAKvC,WAAWG,UAChC6I,EAAKgZ,YAAczf,EAAKvC,WAAWI,aACnC4I,EAAKiZ,SAAW1f,EAAKvC,WAAWK,UAEhCkC,EAAKD,IAAI4f,IAAI/mB,GAAGoF,OAAOC,MAAM2hB,UAAW,SAAUld,GAC9C1C,EAAKuZ,sBAGT,GAAKvZ,EAAK6f,kBA6EH,CACH7f,EAAK6f,kBAAkBtL,OACvBvU,EAAKD,IAAIgG,QAAQ/F,EAAK1G,MAAM6B,MAAMO,WAAa+K,KAAMA,QA/E5B,CAEpBlP,OAAOuoB,IACRlnB,GAAGG,WAAWH,GAAGoF,OAAOuS,IAAIkJ,MAAQ7gB,GAAGI,YAAc,wBAGzD,IAeIoa,EAfAC,GACAC,QAAS,QACTC,QACIC,KAAMxT,EAAKgE,gBAAgB,sBAC3BrM,IAAKqI,EAAKgE,gBAAgB,uBAE9B+b,OAAQ/f,EAAK1G,MAAM6B,MAAMO,UACzBskB,QAAShgB,EAAK1G,MAAM6B,MAAMQ,WAC1B4gB,OACI7d,IAAKsB,EACLigB,WAAY1iB,EAAS2iB,uBACrBC,QAAS5iB,EAAS6iB,sBAK1B,MAAMC,EAAuB,SAAU1M,GACnCN,EAAoBO,KAAOD,EAAiBE,KAAKC,MACjDV,EAAaO,EAAiBI,WAAW,eAAgBV,IAG7D,GAAIrT,EAAK9G,QAAQ8a,UAAW,CACxB,IAAIL,EAAmB3T,EAAKD,IAAIkU,mBAAmB,cAAgBjU,EAAK9G,QAAQ8a,UAAU,GAAG7E,cAAgBnP,EAAK9G,QAAQ8a,UAAUE,UAAU,IAAI,GAC7IP,EAGD0M,EAAqB1M,GAFrB3T,EAAKD,IAAIgU,WAAW/T,EAAK9G,QAAQ8a,WAAWrT,KAAK0f,OAIlD,CACHhN,EAAoBpO,IAAMpI,SAASyN,cAAc,OACjDtK,EAAKD,IAAIkF,IAAIlI,YAAYsW,EAAoBpO,KAC7CmO,EAAapT,EAAKD,IAAIgU,WAAW,eAAgBV,GAGrDD,EAAWzS,KAAK,SAAUkf,GACtBA,EAAkBzL,OAASpU,EAC3BA,EAAK6f,kBAAoBA,EACzBA,EAAkB7M,gBAAgBrS,KAAK,WAEnCkf,EAAkB3D,iBAAmB,SAAUxZ,GACvC1C,EAAKuC,aAAgBvC,EAAKuC,WAAW+d,iBAAmD,GAAhCtgB,EAAKuC,WAAWge,cACxEvgB,EAAKG,KAAKqgB,mBAAmBtgB,KAAKF,EAAKG,OAE/C0f,EAAkBW,mBAAqB,SAAU9d,GACzC1C,EAAKuC,YAAcvC,EAAKuC,WAAW+d,iBAAmBtgB,EAAKuC,WAAWge,aAAe,GACrFvgB,EAAKG,KAAK+b,iBAAiBhc,KAAKF,EAAKG,OAG7C0f,EAAkB5a,IAAIqD,iBAAiB,YAAauX,EAAkBW,oBACtEX,EAAkB5a,IAAIqD,iBAAiB,WAAYuX,EAAkB3D,kBAErElc,EAAKD,IACAyC,GAAG5J,GAAGoF,OAAOC,MAAMwiB,gBAAiB,WAC7BzgB,EAAK8Z,QACL9Z,EAAK8Z,MAAMlO,MAAMC,QAAU,UAGlCrJ,GAAG5J,GAAGoF,OAAOC,MAAMyiB,gBAAiB,WAC7B1gB,EAAK8Z,QACL9Z,EAAK8Z,MAAMlO,MAAMC,QAAU,MAGlCrJ,GAAG5J,GAAGoF,OAAOC,MAAM0iB,kBAAmB,WAC/B3gB,EAAK8Z,QACL9Z,EAAK8Z,MAAMlO,MAAMC,QAAU,UAIvC7L,EAAKD,IAAIgG,QAAQ/F,EAAK1G,MAAM6B,MAAMO,WAAa+K,KAAMA,aAUzElJ,EAAS2F,MAAQ,SAAU3C,GACvB,IAAIP,EAAOrH,KAEX,GAAIqH,EAAKsc,SAAU,CACf/kB,OAAOkgB,oBAAoB,SAAUzX,EAAKsc,UAAU,GACpDtc,EAAKsc,cAAWpM,EAGpB,GAAI3P,GAAaP,EAAK1G,MAAM6C,OAAOC,MAAO,CAEtC4D,EAAKuC,WAAWqe,gBAGZ5gB,EAAK6f,mBACL7f,EAAK6f,kBAAkBvL,eACpBtU,EAAKgf,UAGZhf,EAAKG,KAAKuP,mBAEV1P,EAAKG,KAAK+C,QAGVlD,EAAKmB,MAAMqI,UAAUpB,iBAAiB,MAAM9E,QAAQ,SAAUqI,GAC1DA,EAAGzG,UAAUS,OAAO3F,EAAK1G,MAAMC,QAAQG,iBAG3CsG,EAAKD,IAAIgG,QAAQ/F,EAAK1G,MAAM6B,MAAMQ,YAElCqE,EAAKjC,uBAIF,CACHiC,EAAKqC,cAAcue,gBACnB5gB,EAAKa,SAAS+f,kBAItBrjB,EAASgP,UAAY,SAAUrT,GAC3B,MAAM8G,EAAOrH,KACb,OAAO,IAAIgM,QAAQ,SAAUuB,EAASC,GAElC,IAAI0a,EAAU3nB,EAAQ2nB,SAAW7gB,EAAKgE,gBAAgB,sBAElD8c,EAAQ,SAAUlgB,GAClB,IAAIuD,EACJA,EAAOnE,EAAKoE,sBAAsBC,UAElC,IAAIsF,EAAYzQ,EAAQoL,kBAAoBtE,EAAKmB,MAAMwI,UAAU/J,MAAMmC,OAEnE6V,EAAS5X,EAAKqG,gBACbuR,IACDA,MAGJ,IAAImJ,EAAY/gB,EAAKG,KAAK0U,mBAAmBjU,GAAO,EAAM1H,EAAQ4L,cAE9Dkc,EAAQ,SAAU7c,GAClBnE,EAAKmB,MAAMwI,UAAU/J,MAAQ,GAC7BI,EAAKmB,MAAMwI,UAAUS,UAAW,EAChCpK,EAAKmB,MAAM+H,UAAUkB,UAAW,EAEhCpK,EAAKmB,MAAMyI,SAAShK,MAAQ,GAC5BI,EAAKmB,MAAMyI,SAASQ,UAAW,EAC/BpK,EAAKmB,MAAMgI,SAASiB,UAAW,EAE/BpK,EAAKoE,sBAAsBqJ,WAAWtJ,GAEtCwQ,EAAyBzU,KAAKF,IAG9BihB,GACApf,KAAM8H,EACNlD,KAAMsa,EAAU1d,SAChB0B,OAAQgc,EAAUhc,OAClB6M,IAAK5R,EAAK3C,YAGdzE,GAAG0X,QACE/Y,OAAO2pB,SACPtoB,GAAGI,YAAcJ,GAAGoF,OAAOuS,IAAI4Q,MAChC,WACI,IAAIC,EAAOF,QAAQlL,KAAKC,UAAUgL,IAE9BI,EAAezJ,EAAO7X,IAAI,SAAUuhB,GACpC,IAAIC,EAAcvL,KAAKoC,MAAMpC,KAAKC,UAAUqL,WACrCC,EAAYhb,IACnB,GAAI6a,IAASF,QAAQlL,KAAKC,UAAUsL,IAChC,OAAOD,EAAW/a,IACf,CACH,MAAMib,EAAa,IAAI1a,GAAG/D,OAAOgE,QAEjC,IAAI1D,EAAWme,EAAWxa,aAAaua,EAAY9a,MAE/CC,EAAY9P,KAAK+P,IAAI,GAAI/N,GAAGoF,OAAO4I,iBAAmB,GAE1DvD,EAASC,QAAQ,SAAU1B,GACvB,IAAI6F,EAAO7O,GAAG4D,KAAKilB,gBAAgB7oB,GAAG4D,KAAKuL,gBAAgBnG,EAAQ4c,cAAcb,iBAAkBjX,IACnG9E,EAAQ4c,cAAckD,eAAeja,KAGzC8Z,EAAY9a,KAAO+a,EAAWG,cAActe,GAE5C,OAAI+d,IAASF,QAAQlL,KAAKC,UAAUsL,IACzBD,EAAW/a,IAEX,QAIhBhB,OAAO,SAAUgB,GAChB,OAAe,OAARA,IAGX,MAAMqb,EAAgB,SAAUrb,GAC5B,OAAOvG,EAAK2X,kBAAkBhX,KAAK,WAC/BX,EAAK4Q,aAGL,IADA,IAAIhD,EACK3W,EAAI,EAAGA,EAAI+I,EAAKqG,gBAAgBtP,OAAQE,IAC7C,GAAI+I,EAAKqG,gBAAgBpP,GAAGsP,MAAQA,EAAK,CACrCqH,EAAQ3W,EACR,MAIR,OAAO2W,KAIf,GAA4B,IAAxByT,EAAatqB,OAAc,CAE3BkqB,EAAS1a,IAAMtO,KAAKR,MAAQb,KAAKirB,SACjCjK,EAAOnT,KAAKwc,GACZrJ,EAASW,EAAaX,GAEtB,IACI5X,EAAK4Y,gBAAgBhB,GAAQjX,KAAK,WAC9BX,EAAKD,IAAIgE,MAAM8c,GAAW1P,SAAU,MAEpC6P,EAAM7c,GAENyd,EAAcX,EAAS1a,KAAK5F,KAAK,SAAUiN,GACvC1H,EAAQ0H,OAIlB,MAAOgJ,GACLhe,GAAGkW,MAAM9O,EAAKgE,gBAAgB,8BAAgC,KAAO4S,EAAMiK,SAC3EG,EAAM7c,GACNgC,SAED,CACH8E,QAAQC,IAAI,yCAEZ8V,EAAM7c,GAENyd,EAAcP,EAAa,IAAI1gB,KAAK,SAAUiN,GAC1C1H,EAAQ0H,SAqB5B,GAAI5N,EAAKsE,iBACLwc,EAAM9gB,EAAKuC,iBACV,GAAgD,GAA5CvC,EAAKmB,MAAMwI,UAAU/J,MAAMmC,OAAOhL,OAAa,CACpDiJ,EAAKmB,MAAMwI,UAAU/J,OAAQ,IAAI3H,MAAO+Z,iBACxC8O,EAAM9gB,EAAKqC,oBAGXye,EAAM9gB,EAAKqC,kBAKvB9E,EAASiP,YAAc,WACnB,IAEIsV,EAFOnpB,KAEawI,MAAMyI,SAAShK,MAAMmC,OACxC+f,IACDA,GAAe,IAAI7pB,MAAO+Z,kBAG9B,IAAI7N,EAPOxL,KAOKyL,sBAAsBC,UAEtCsQ,EAAyBzU,KATdvH,MAAAA,KAWNwH,KAAKqM,YAXC7T,KAWgBic,aAAa7C,UACpClQ,KAAMigB,EACN3G,IAbOxiB,KAaGic,aAAamN,QACvB5E,MAAM,IAAIllB,MAAOC,YAdVS,KAiBNwI,MAAMyI,SAAShK,MAAQ,GAjBjBjH,KAkBNwI,MAAMyI,SAASQ,UAAW,EAlBpBzR,KAmBNwI,MAAMgI,SAASiB,UAAW,EAG/BxR,GAAG4D,KAAKwT,QAAQC,qBAtBLtX,KAsB+BW,MAAMqB,gBAAgBE,aAtBrDlC,KAsBwEwH,KAAK0U,mBAtB7Elc,KAsBqG0J,eAAegB,UAtBpH1K,KAwBNyL,sBAAsBqJ,WAAWtJ,IAG1C5G,EAASwR,cAAgB,SAAUiT,EAASC,GACxC,IAAIjiB,EAAOrH,KAEXqH,EAAK8Y,qBAAqBnY,KAAK,SAAUiX,GACrC,GAAIA,GACIA,EAAOoK,GAAU,CACjBpK,EAAOoK,GAASngB,KAAOogB,EAEvBjiB,EAAK4Y,gBAAgBhB,OAMrCra,EAASsR,YAAc,SAAUlD,GAC7B,IAAI3L,EAAOrH,KAEXqH,EAAK8Y,qBAAqBnY,KAAK,SAAUiX,GACrC,GAAIA,EAAQ,CACR,IAAIsK,EAASvW,EAAGwC,QAAQ/V,GACxB,GAAIwf,EAAOsK,GAAS,CAChB,IAAI3b,EAAMqR,EAAOsK,GAAQ3b,IAEzB3N,GAAGupB,QAAQniB,EAAKgE,gBAAgB,wBAAyB,WAErD,MAAMoe,EAAgBpiB,EAAKyO,mBACvB2T,GAAiBA,EAAcjU,QAAQ/V,KAAO8pB,GAC9CliB,EAAKkD,MAAMlD,EAAK1G,MAAM6C,OAAOC,OAGjC+T,YAAYC,WAAWpQ,EAAK1G,MAAMqB,gBAAgBC,SAAW,IAAM2L,GAAK5F,KAAK,WACzEX,EAAK2X,kBAAkBhX,KAAK,WACxBX,EAAK4Q,iBAEVyR,MAAM,SAAUC,GACfrX,QAAQC,IAAIoX,MAGjB,mBAMnB/kB,EAAS+b,iBAAmB,SAAU3N,GAClC,IAAI3L,EAAOrH,KAENqH,EAAK2W,UACN3W,EAAK8Q,WAGT9Q,EAAKmB,MAAMqI,UAAUpB,iBAAiB,sBAAsB9E,QAAQ,SAAU+E,GAC1EA,EAAKiG,aAAa,QAASjG,EAAK8D,eAEpCnM,EAAKmB,MAAMqI,UAAUpB,iBAAiB,MAAM9E,QAAQ,SAAUqI,GAC1DA,EAAGzG,UAAUS,OAAO3F,EAAK1G,MAAMC,QAAQG,iBAG3CiS,EAAGzG,UAAUQ,IAAI1F,EAAK1G,MAAMC,QAAQG,eAEpCiS,EAAG2C,aAAa,QAAStO,EAAKgE,gBAAgB,gBAAkB,IAAM2H,EAAG/F,cAAc,QAAQuG,aAC/FR,EAAG/F,cAAc5F,EAAK1G,MAAMO,SAASE,MAAMuU,aAAa,QAAS3C,EAAG+E,aAAa,WAGrFnT,EAASkR,iBAAmB,WAGxB,OAFW9V,KAECwI,MAAMqI,UAAU5D,cAAc,MAF/BjN,KAE4CW,MAAMC,QAAQG,gBAGzE6D,EAASglB,mBAAqB,WAC1B,MAAMviB,EAAOrH,KAEP6pB,EAAWxiB,EAAKyO,mBACtB,GAAI+T,EAAU,CAEV,GAAIxiB,EAAKsc,SAAU,CACf/kB,OAAOkgB,oBAAoB,SAAUzX,EAAKsc,UAAU,GACpDtc,EAAKsc,cAAWpM,EAGpBsS,EAAStd,UAAUS,OAAO3F,EAAK1G,MAAMC,QAAQG,eAC7C8oB,EAASlU,aAAa,QAASkU,EAASrW,aACxCqW,EAAS5c,cAAc5F,EAAK1G,MAAMO,SAASE,MAAMuU,aAAa,QAASkU,EAAS9R,aAAa,YAIrGnT,EAASyT,eAAiB,WACXrY,KAENwH,KAAKqgB,qBAFC7nB,KAGS8V,oBAHT9V,KAKF4pB,qBAET,GAPW5pB,KAOFknB,kBAAmB,CAPjBlnB,KASFknB,kBAAkB5a,IAAIwS,oBAAoB,YATxC9e,KAS0DknB,kBAAkBW,oBAT5E7nB,KAUFknB,kBAAkB5a,IAAIwS,oBAAoB,WAVxC9e,KAUyDknB,kBAAkB3D,kBAV3EvjB,KAYFknB,kBAAkBvL,QAZhB3b,KAeNuK,MAfMvK,KAeKW,MAAM6C,OAAOC,QAGjCmB,EAAS4e,iBAAmB,SAAUxQ,GAClC,MAAM3L,EAAOrH,KAEb,OAAO,IAAIgM,QAAQ,SAAUuB,EAASC,GAClCnG,EAAKG,KAAK+C,QAEVlD,EAAK6c,gBAAgBlR,GAAIhL,KAAK,SAAUQ,GACzBA,EAAMsF,KACbtF,EAAMsF,MACNzG,EAAKG,KAAKgc,iBAAiBhb,GAAOR,KAAK,WACnC,IAAI8hB,EAAeziB,EAAKuC,WAAWc,SACnC,GAAIof,GAAgBA,EAAa1rB,OAAS,EAAG,CAEzC,IAAIylB,EAAciG,EAAald,OAAO,SAAU3D,GAC5CA,EAAQ8gB,YAAa,EACrB,SAAI9pB,GAAGgJ,QAAQiG,eAAiBjG,aAAmBhJ,GAAGgJ,QAAQiG,gBAEnDjG,aAAmBhJ,GAAGgJ,QAAQ6B,WAI1C1D,IAAI,SAAU6B,GACb,OAAIhJ,GAAGgJ,QAAQiG,eAAiBjG,aAAmBhJ,GAAGgJ,QAAQiG,cACnDjG,EAAQoG,SAAS,GACjBpG,aAAmBhJ,GAAGgJ,QAAQ6B,SAC9B7B,EAAQoG,cADZ,IAGR,GAEH,GAAIwU,EAAa,CACb,IAAImG,EAAQnG,EAAY,GACpBoG,EAAOpG,EAAYA,EAAYzlB,OAAS,GAExC4rB,GAAWA,IAAUC,GACrB5iB,EAAKuC,WAAWsgB,UAAUF,EAAM1G,QAAQ6G,OAAO,EAAG,IAC9CJ,YAAY,EAAOK,SAAU/iB,EAAK5G,MAAQ,yBAA0B4pB,QAAS,GAAK,GAAIC,WAAW,IAIrGL,GACA5iB,EAAKuC,WAAWsgB,UAAUD,EAAK3G,QAAQ6G,OAAO,EAAG,IAC7CJ,YAAY,EAAOK,SAAU/iB,EAAK5G,MAAQ,qBAAsB4pB,QAAS,GAAK,GAAIC,WAAW,KAK7GjjB,EAAKuC,WAAWoO,eAAc,GAC9BzK,WAMpB3I,EAASsf,gBAAkB,SAAUlR,GACjC,MAAM3L,EAAOrH,KACb,OAAO,IAAIgM,QAAQ,SAAUuB,EAASC,GAClCnG,EAAK8Y,qBAAqBnY,KAAK,SAAUiX,GACrC,GAAIA,EAAQ,CACR,MAAMsK,EAASvW,EAAGwC,QAAQ/V,GAC1B,GAAIwf,EAAOsK,GAAS,CAChB,IAAI/gB,EAAQyW,EAAOsK,GAAQzb,KAI3BtF,EAAQnB,EAAKG,KAAK+iB,qBAAqB/hB,GAEvC+E,GAAUO,KAAMtF,EAAO4D,OAAQ6S,EAAOsK,GAAQnd,eAGlDmB,SAMhB3I,EAAS6R,OAAS,SAAU9O,EAAMqL,GAG9B,OAFWhT,KAECwH,KAAKiP,OAAO9O,EAAMqL,IAGlCpO,EAAS6iB,oBAAsB,SAAUxN,GACxBja,KACRwH,KAAKgjB,oBAAoBvQ,GAE9B,OAHaja,KAGDknB,kBAAkBuD,yBAAyBxQ,IAG3DrV,EAAS2iB,uBAAyB,WACnBvnB,KACNwH,KAAKkjB,uBAGd9lB,EAAS2T,eAAiB,SAAUoS,GAChC,MAAMjZ,EAAOxN,SAASyN,cAAc,QAC9BC,EAAS+Y,EAAU7a,cACzB8B,EAAOC,aAAaH,EAAMiZ,GAC1BjZ,EAAKtN,YAAYumB,GACjBjZ,EAAKI,QAELJ,EAAKK,sBAAsB,WAAY4Y,GACvC/Y,EAAOI,YAAYN,IAGvB9M,EAAS6G,oBAAsB,WAG3B,IAFWzL,KAED4qB,QAAS,CAFR5qB,KAGF4qB,QAHE5qB,KAGaoH,IAAIkU,mBAAmBrb,GAAGC,QAAQ2qB,kBAH/C7qB,KAIE4qB,SAJF5qB,KAIkB4qB,QAAQxsB,OAAS,IAJnC4B,KAKE4qB,QALF5qB,KAKiB4qB,QAAQ,IAGpC,OARW5qB,KAQC4qB,SAGhBhmB,EAASkmB,iBAAmB,SAAU7M,GAClC,IAmBI8M,EAjBJ,GAAI9N,UAAU+N,YAAa,CAFhBhrB,KAGEirB,iBACLhO,UAAU+N,YAAYE,WAJnBlrB,KAImCirB,iBAC1C,GALOjrB,KAKEmrB,mBAAoB,CALtBnrB,KAMEmrB,mBANFnrB,KAM4BmrB,8BAA8B5c,MAN1DvO,KAMuEmrB,oBANvEnrB,KAMkGmrB,oBANlGnrB,KAQEmrB,mBAAmBxgB,QAAQ,SAAUygB,GACtCnO,UAAU+N,YAAYE,WAAWE,KATlCprB,KAYEmrB,uBAZFnrB,KAgBFqrB,wBAhBErrB,KAiBFyL,sBAAsBqJ,WAjBpB9U,KAiBoCqrB,wBAG/C,OAAQpN,EAAMC,MACV,KAAKD,EAAMqN,kBACPP,EAtBG/qB,KAsBaqL,gBAAgB,+BAChC,MACJ,KAAK4S,EAAMsN,qBACPR,EAzBG/qB,KAyBaqL,gBAAgB,kCAChC,MACJ,KAAK4S,EAAMuN,QACPT,EA5BG/qB,KA4BaqL,gBAAgB,qBAChC,MACJ,QACI0f,EA/BG/qB,KA+BaqL,gBAAgB,qBA/B7BrL,KAmCNoH,IAAIgE,MAAM2f,GAAYpjB,KAAM1H,GAAGoF,OAAOiG,QAAQC,UAEnD,IArCWvL,KAqCD4e,qBArCC5e,KAqC2BwI,MAAO,CArClCxI,KAsCFwI,MAAM2H,eAAe5D,UAAUS,OAAO/M,GAAGoF,OAAOoH,QAAQyD,QAtCtDlQ,KAuCFwI,MAAM4H,iBAAiB7D,UAAUQ,IAAI9M,GAAGoF,OAAOoH,QAAQyD,UAIpE,IAAIkQ,EAAW,SAAUqL,GACrB,OAAQA,GAAsB,IAAfA,EAAIrtB,QAGvBwG,EAAS8mB,YAAc,WACnB,MAAMrkB,EAAOrH,KACb,GAAIqH,EAAK5C,aAAc,CACnB,MAAMknB,KACN,GAAItkB,EAAKuC,WAAY,CACjB,IAAIc,EAAWrD,EAAKuC,WAAWc,SAE/B,GAAIA,EAAStM,OAAS,GAAKiJ,EAAKjC,iBAAmBiC,EAAKjC,gBAAgBhH,OAAS,EAC7EutB,EAAMjhB,SAAWrD,EAAKjC,oBACnB,CACH,MAAMwmB,EAAavkB,EAAKuC,WAAW8hB,aAC/BhhB,SAAUA,IAGdihB,EAAMjhB,SAAWkhB,EAAWlhB,SAGhCihB,EAAMlsB,GAAK4H,EAAK5H,GAChB,MAAMgqB,EAAgBpiB,EAAKyO,mBACvB2T,IACAkC,EAAM3a,UAAYyY,EAAcxc,cAAc,QAAQ/B,WAE1D,OAAOygB,GAGf,OAAO,MAGX/mB,EAASinB,YAAc,SAAUF,GAC7B,MAAMtkB,EAAOrH,KACb,GAAIqH,EAAKD,KACDukB,EAAMjhB,UAAYihB,EAAMjhB,SAAStM,OAAQ,CACzCiJ,EAAKykB,SAEL,GAAIH,EAAMjhB,SAAStM,OAAS,EAAG,CAC3B,MAAMkQ,EAAW,IAAIC,MAAMod,EAAMjhB,SAAStM,QAC1CutB,EAAMjhB,SAASC,QAAQ,SAAUvE,EAAGoI,GAChC,MAAMud,GAAmBje,KAAM1H,EAAE0H,KAAMrO,GAAI2G,EAAE3G,GAAIsqB,WAAY3jB,EAAE2jB,YAC/D,IACIjb,EAAO7O,GAAG4D,KAAKilB,gBAAgB1iB,EAAE0I,MACrC,OAAQ1I,EAAEuB,MACN,KAAK1H,GAAGoF,OAAOyJ,KAAKG,SAChBX,EAASE,GAAO,IAAIvO,GAAGgJ,QAAQ6B,SAASgE,EAAMid,GAC9C,MACJ,KAAK9rB,GAAGoF,OAAOyJ,KAAKK,cAChBb,EAASE,GAAO,IAAIvO,GAAGgJ,QAAQiG,cAAcJ,EAAMid,GACnD,MACJ,KAAK9rB,GAAGoF,OAAOyJ,KAAKC,OAChBT,EAASE,GAAO,IAAIvO,GAAGgJ,QAAQ4F,OAAOC,EAAMid,GAC5C,MACJ,KAAK9rB,GAAGoF,OAAOyJ,KAAKE,MAChBV,EAASE,GAAO,IAAIvO,GAAGgJ,QAAQ2B,MAAMkE,EAAMid,MAKvD/f,QAAQC,IAAIqC,GAAUtG,KAAK,SAAU2G,GACjC,IAAIpO,GAAYmK,SAAUiE,EAAY3E,SAAU2hB,EAAM3a,UAAW7E,cAAc,EAAMgB,UAAU,GAC1F9F,EAAKqG,gBAKNrG,EAAKmD,YAAYjK,GAJjB8G,EAAK2X,kBAAkBhX,KAAK,WACxBX,EAAKmD,YAAYjK,UA7zEjD","sourcesContent":["(function () {\r\n    Math.hypot = Math.hypot || function () {\r\n        var y = 0;\r\n        var length = arguments.length;\r\n\r\n        for (var i = 0; i < length; i++) {\r\n            if (arguments[i] === Infinity || arguments[i] === -Infinity) {\r\n                return Infinity;\r\n            }\r\n            y += arguments[i] * arguments[i];\r\n        }\r\n        return Math.sqrt(y);\r\n    };\r\n}());\r\n(function () {\r\n    var lastTime = 0,\r\n        vendors = ['ms', 'moz', 'webkit', 'o'],\r\n        // Feature check for performance (high-resolution timers)\r\n        hasPerformance = !!(window.performance && window.performance.now);\r\n\r\n    for (var x = 0, max = vendors.length; x < max && !window.requestAnimationFrame; x += 1) {\r\n        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];\r\n        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']\r\n            || window[vendors[x] + 'CancelRequestAnimationFrame'];\r\n    }\r\n\r\n    if (!window.requestAnimationFrame) {\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            var currTime = new Date().getTime();\r\n            var timeToCall = Math.max(0, 16 - (currTime - lastTime));\r\n            var id = window.setTimeout(function () { callback(currTime + timeToCall); },\r\n                timeToCall);\r\n            lastTime = currTime + timeToCall;\r\n            return id;\r\n        };\r\n    }\r\n\r\n    if (!window.cancelAnimationFrame) {\r\n        window.cancelAnimationFrame = function (id) {\r\n            clearTimeout(id);\r\n        };\r\n    }\r\n\r\n    // Add new wrapper for browsers that don't have performance\r\n    if (!hasPerformance) {\r\n        // Store reference to existing rAF and initial startTime\r\n        var rAF = window.requestAnimationFrame,\r\n            startTime = +new Date;\r\n\r\n        // Override window rAF to include wrapped callback\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            // Wrap the given callback to pass in performance timestamp\r\n            var wrapped = function (timestamp) {\r\n                // Get performance-style timestamp\r\n                var performanceTimestamp = (timestamp < 1e12) ? timestamp : timestamp - startTime;\r\n\r\n                return callback(performanceTimestamp);\r\n            };\r\n\r\n            // Call original rAF with wrapped callback\r\n            rAF(wrapped, element);\r\n        }\r\n    }\r\n})();\r\n(function () {\r\n    // Polyfill window.performance.now\r\n    if (!window.performance) {\r\n        window.performance = {\r\n            offset: Date.now(),\r\n            now: function () {\r\n                return Date.now() - this.offset;\r\n            }\r\n        };\r\n    } else if (window.performance && !window.performance.now) {\r\n        window.performance.offset = Date.now();\r\n        window.performance.now = function () {\r\n            return Date.now() - window.performance.offset;\r\n        };\r\n    }\r\n}());\r\n\r\nTC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.control.Geolocation = function (options) {\r\n    var self = this;\r\n    self._classSelector = '.' + self.CLASS;\r\n\r\n    self._layerPromises = {};\r\n\r\n    self.Const = {\r\n        Classes: {\r\n            ACTIVE: 'tc-ctl-geolocation-active',\r\n            CLOSED: 'closed',\r\n            SELECTEDTRACK: 'selectedTrack',\r\n            DRAWACTIVATED: 'draw-activated',\r\n            SIMULATIONACTIVATED: 'simulation-activated'\r\n        },\r\n        Selector: {\r\n            SIMULATE: '.tc-btn-simulate',\r\n            DRAW: '.tc-draw',\r\n            EDIT: '.tc-btn-edit',\r\n            DELETE: '.tc-btn-delete',\r\n            SAVE: '.tc-btn-save',\r\n            CANCEL: '.tc-btn-cancel',\r\n            EXPORT_GPX: '.tc-btn-export-gpx',\r\n            EXPORT_KML: '.tc-btn-export-kml',\r\n            STOP: '.tc-btn-stop',\r\n            PAUSE: '.tc-btn-pause',\r\n            BACKWARD: '.tc-btn-backward',\r\n            FORWARD: '.tc-btn-forward',\r\n            SPEED: '.tc-spn-speed'\r\n        },\r\n        LocalStorageKey: {\r\n            TRACKING: 'trk',\r\n            TRACKINGTEMP: 'trktemp',\r\n            TRACKINGSHOWADVERTISEMENT: 'trkAdvertisement',\r\n            GPSSHOWADVERTISEMENT: 'gpsAdvertisement',\r\n            TEST: 'test'\r\n        },\r\n        Message: {\r\n            VALIDATENAME: '',\r\n        },\r\n        Event: {\r\n            POSITIONCHANGE: 'positionchange.tc.geolocation',\r\n            GPSPOSITIONCHANGE: 'gpspositionchange.tc.geolocation',\r\n            GPSPOSITIONERROR: 'positionerror.tc.geolocation',\r\n            STATEUPDATED: 'stateupdated.tc.geolocation',\r\n            GPSADD: 'gpsadd.tc.geolocation',\r\n            TRACKSNAPPING: 'tracksnapping.tc.geolocation',\r\n            DRAWTRACK: 'drawtrack.tc.geolocation',\r\n            CLEARTRACK: 'cleartrack.tc.geolocation',\r\n            IMPORTEDTRACK: 'importedtrack.tc.geolocation'\r\n        },\r\n        MimeMap: {\r\n            KML: 'application/vnd.google-earth.kml+xml',\r\n            GPX: 'application/gpx+xml'\r\n        },\r\n        SupportedFileExtensions: [\r\n            '.kml',\r\n            '.gpx'\r\n        ],\r\n        Tabs: {\r\n            GPS: \"gps\"\r\n        },\r\n        Layers: {\r\n            GPS: \"gps\",\r\n            TRACK: \"track\",\r\n            TRACKING: \"tracking\"\r\n        }\r\n    };\r\n\r\n    TC.Control.apply(self, arguments);\r\n\r\n    var opts = options || {};\r\n    self._dialogDiv = TC.Util.getDiv(opts.dialogDiv);\r\n    self._$dialogDiv = $(self._dialogDiv);\r\n    if (!opts.dialogDiv) {\r\n        document.body.appendChild(self._dialogDiv);\r\n    }\r\n    self.delta = 500;\r\n    self.walkingSpeed = 5000;\r\n    self.gapHill = self.options.gapHill || 20;\r\n\r\n    self.snappingTolerance = self.options.snappingTolerance || 50;\r\n\r\n    self.exportsState = true;\r\n\r\n    self.storageCRS = 'EPSG:4326';\r\n};\r\n\r\nTC.inherit(TC.control.Geolocation, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Geolocation.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-geolocation';\r\n\r\n    ctlProto.CHART_SIZE = {\r\n        MIN_HEIGHT: 75,\r\n        MAX_HEIGHT: 128,\r\n\r\n        MIN_WIDTH: 300,\r\n        MEDIUM_WIDTH: 310,\r\n        MAX_WIDTH: 445\r\n    };\r\n\r\n    ctlProto.featuresToShare = [];\r\n\r\n    TC.Consts.event.TOOLSCLOSE = TC.Consts.event.TOOLSCLOSE || 'toolsclose.tc';\r\n    TC.Consts.event.TOOLSOPEN = TC.Consts.event.TOOLSOPEN || 'toolsopen.tc';\r\n\r\n    ctlProto.template = {};\r\n\r\n    if (TC.isDebug) {\r\n        ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/Geolocation.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-track-node'] = TC.apiLocation + \"TC/templates/GeolocationTrackNode.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-track-snapping-node'] = TC.apiLocation + \"TC/templates/GeolocationTrackSnappingNode.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/GeolocationDialog.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-tracking-toast'] = TC.apiLocation + \"TC/templates/GeolocationTrackingToast.html\";\r\n    }\r\n    else {\r\n        ctlProto.template[ctlProto.CLASS] = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo\" }).w(\"</h2><div class=\\\"tc-ctl-geolocation-content\\\"> <div class=\\\"tc-ctl-geolocation-track\\\"><div class=\\\"tc-ctl-geolocation-track-snap-info\\\"></div> <!-- img se insertan en el div del mapa--> <div id=\\\"tc-ctl-geolocation-track-elevation-marker\\\" class=\\\"tc-ctl-geolocation-trackMarker elevation\\\" style=\\\"display: none;\\\"></div> <div class=\\\"tc-ctl-geolocation-track-panel-block\\\" ><input id=\\\"tc-ctl-geolocation-track-panel-opened\\\" type=\\\"checkbox\\\" checked/><label for=\\\"tc-ctl-geolocation-track-panel-opened\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.help.1\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.help.2\" }).w(\"</label><i class=\\\"tc-ctl-geolocation-track-panel-help icon-question-sign\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.help.3\" }).w(\"\\\"></i></div><div class=\\\"tc-ctl-geolocation-track-mng\\\"><div class=\\\"tc-ctl-geolocation-select\\\"><form> <label class=\\\"tc-ctl-geolocation-btn-track\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.title\" }).w(\"\\\"><input type=\\\"radio\\\" name=\\\"mode\\\" checked value=\\\"tracks\\\" /><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.gps\" }).w(\"</span></label><label class=\\\"tc-ctl-geolocation-btn-tracks\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.tracks.title\" }).w(\"\\\"><input type=\\\"radio\\\" name=\\\"mode\\\" value=\\\"track-available\\\" /><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.tracks\" }).w(\"</span></label> </form></div> <div class=\\\"tc-ctl-geolocation-track-available tc-ctl-geolocation-track-cnt tc-ctl-geolocation-panel tc-hidden\\\"><i class=\\\"tc-ctl-geolocation-track-search-icon\\\"></i><input id=\\\"tc-ctl-geolocation-track-available-srch\\\" type=\\\"search\\\" list=\\\"tc-ctl-geolocation-track-available-lst\\\" class=\\\"tc-ctl-geolocation-track-available-srch tc-textbox\\\" placeholder=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.filter.plhr\" }).w(\"\\\" maxlength=\\\"200\\\" /> <ol id=\\\"tc-ctl-geolocation-track-available-lst\\\" class=\\\"tc-ctl-geolocation-track-available-lst\\\"><li class=\\\"tc-ctl-geolocation-track-available-empty\\\"><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.noTracks\" }).w(\"</span></li><li class=\\\"tc-ctl-geolocation-track-not\\\" hidden><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"noMatches\" }).w(\"</span></li></ol><div class=\\\"tc-ctl-geolocation-track-cnt\\\"><input name=\\\"uploaded-file\\\" id=\\\"uploaded-file\\\" type=\\\"file\\\" class=\\\"tc-ctl-geolocation-track-import tc-button\\\" accept=\\\".gpx,.kml\\\" disabled /><label class=\\\"tc-button tc-icon-button\\\" for=\\\"uploaded-file\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.import.upload\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.import.lbl\" }).w(\"</label></div></div><div class=\\\"tc-ctl-geolocation-tracks tc-ctl-geolocation-panel\\\"> <div class=\\\"tc-alert alert-warning tc-hidden\\\" ><p id=\\\"panel-msg\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.1\" }).w(\" <ul><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.2\" }).w(\"</li><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.3\" }).w(\"</li><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.4\" }).w(\"</li><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.5\" }).w(\"</li></ul></p></div> <div class=\\\"tc-ctl-geolocation-track-ui\\\"> <div class=\\\"tc-ctl-geolocation-track-render\\\"><input id=\\\"tc-ctl-geolocation-track-render\\\" type=\\\"checkbox\\\" hidden checked /><label for=\\\"tc-ctl-geolocation-track-render\\\" class=\\\"tc-ctl-geolocation-track-render\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.render\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.render\" }).w(\"</label></div><button class=\\\"tc-button tc-icon-button tc-ctl-geolocation-track-ui-activate\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.activate.title\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.activate\" }).w(\"</button><button class=\\\"tc-button tc-icon-button tc-ctl-geolocation-track-ui-deactivate tc-hidden\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.deactivate.title\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.deactivate\" }).w(\"</button></div><div class=\\\"tc-ctl-geolocation-track-current tc-ctl-geolocation-track-cnt\\\"><input type=\\\"text\\\" class=\\\"tc-ctl-geolocation-track-title tc-textbox\\\" disabled placeholder=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.name.plhr\" }).w(\"\\\" maxlength=\\\"200\\\" /><button class=\\\"tc-button tc-icon-button tc-ctl-geolocation-track-save\\\" disabled title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.name.save\" }).w(\"\\\"></button><input type=\\\"text\\\" class=\\\"tc-ctl-geolocation-track-waypoint tc-textbox\\\" disabled placeholder=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.wyp.plhr\" }).w(\"\\\" maxlength=\\\"200\\\" /><button class=\\\"tc-button tc-icon-button tc-ctl-geolocation-track-add-wpt\\\" disabled title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.wyp.save\" }).w(\"\\\"></button></div></div></div></div></div><div class=\\\"tc-ctl-geolocation-track-center tc-hidden\\\"><button title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.center\" }).w(\"\\\"></button></div>\"); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-track-node'] = function () { dust.register(ctlProto.CLASS + '-track-node', body_0); function body_0(chk, ctx) { return chk.w(\"<li data-id=\\\"\").f(ctx.get([\"id\"], false), ctx, \"h\").w(\"\\\" data-uid=\\\"\").f(ctx.get([\"uid\"], false), ctx, \"h\").w(\"\\\"><span class=\\\"tc-draw tc-selectable\\\" title=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\">\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"</span><input class=\\\"tc-textbox tc-hidden\\\" type=\\\"text\\\" value=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\" /> <button class=\\\"tc-btn-simulate\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.simulate\" }).w(\"\\\"></button><button hidden class=\\\"tc-btn-stop\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.stop\" }).w(\"\\\"></button><button class=\\\"tc-btn-edit\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.edit\" }).w(\"\\\"></button><button hidden class=\\\"tc-btn-pause\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.pause\" }).w(\"\\\"></button> <button hidden class=\\\"tc-btn-backward\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.backward\" }).w(\"\\\"></button><label hidden class=\\\"tc-spn-speed\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.velocity\" }).w(\"\\\"></label><button hidden class=\\\"tc-btn-forward\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.forward\" }).w(\"\\\"></button> <button class=\\\"tc-btn-save tc-hidden\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"save\" }).w(\"\\\"></button><button class=\\\"tc-btn-cancel tc-hidden\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.cancel\" }).w(\"\\\"></button><button class=\\\"tc-btn-delete\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.delete\" }).w(\"\\\"></button><button class=\\\"tc-btn-export-gpx\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.exportGPX\" }).w(\"\\\"></button><button class=\\\"tc-btn-export-kml\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.exportKML\" }).w(\"\\\"></button> </li>\"); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-track-snapping-node'] = function () { dust.register(ctlProto.CLASS + '-track-snapping-node', body_0); function body_0(chk, ctx) { return chk.w(\"<ul>\").x(ctx.get([\"n\"], false), ctx, { \"block\": body_1 }, {}).w(\"<li> <span>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_2, \"block\": body_3 }, {}).w(\":</span> \").f(ctx.get([\"x\"], false), ctx, \"h\").w(\"</li><li> <span>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_4, \"block\": body_5 }, {}).w(\":</span> \").f(ctx.get([\"y\"], false), ctx, \"h\").w(\" </li>\").x(ctx.get([\"z\"], false), ctx, { \"block\": body_6 }, {}).x(ctx.get([\"m\"], false), ctx, { \"block\": body_8 }, {}).w(\"</ul>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"<li><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.snapping.name\" }).w(\":</span> \").f(ctx.get([\"n\"], false), ctx, \"h\").w(\"</li>\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.w(\"X\"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"lon\" }); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.w(\"Y\"); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"lat\" }); } body_5.__dustBody = !0; function body_6(chk, ctx) { return chk.h(\"ne\", ctx, { \"block\": body_7 }, { \"key\": ctx.get([\"z\"], false), \"value\": 0 }); } body_6.__dustBody = !0; function body_7(chk, ctx) { return chk.w(\"<li> <span>Z:</span> \").f(ctx.get([\"z\"], false), ctx, \"h\").w(\" </li>\"); } body_7.__dustBody = !0; function body_8(chk, ctx) { return chk.w(\"<li> \").f(ctx.get([\"m\"], false), ctx, \"h\").w(\" </li>\"); } body_8.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-dialog'] = function () { dust.register(ctlProto.CLASS + '-dialog', body_0); function body_0(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-geolocation-continue-track-dialog tc-modal\\\" ><div class=\\\"tc-modal-background tc-modal-close\\\"></div><div class=\\\"tc-modal-window\\\"><div class=\\\"tc-modal-header\\\"><h3>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.gps\" }).w(\"</h3><div class=\\\"tc-modal-close\\\"></div></div><div class=\\\"tc-modal-body\\\"><button class=\\\"tc-button tc-ctl-geolocation-track-continue\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.dialog.cnt\" }).w(\" </button><button class=\\\"tc-button tc-ctl-geolocation-track-new\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.dialog.new\" }).w(\" </button> <button class=\\\"tc-button tc-modal-close\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.dialog.cancel\" }).w(\" </button></div></div></div><div class=\\\"tc-ctl-geolocation-track-advert-dialog tc-modal\\\" ><div class=\\\"tc-modal-background tc-modal-close\\\"></div><div class=\\\"tc-modal-window\\\"><div class=\\\"tc-modal-header\\\"><h3>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.activate.title\" }).w(\"</h3><div class=\\\"tc-modal-close\\\"></div></div><div class=\\\"tc-modal-body\\\"><p id=\\\"pageBlurMsg\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.page.blur\" }).w(\"</p><p class=\\\"tc-ctl-geolocation-track-advertisement p\\\"> <label> <input type=\\\"checkbox\\\" name=\\\"checkbox\\\" id=\\\"advertisement\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.dialog.advertisement\" }).w(\" </label> </p></div><div class=\\\"tc-modal-footer\\\"><button class=\\\"tc-button tc-ctl-geolocation-track-advert-ok\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"ok\" }).w(\" </button></div></div></div>\"); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-tracking-toast'] = function () { dust.register(ctlProto.CLASS + '-tracking-toast', body_0); function body_0(chk, ctx) { return chk.w(\"<table class=\\\"tc-ctl-geolocation-info-tracking\\\"><tr><th>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_1, \"block\": body_2 }, {}).w(\":</th><td> \").f(ctx.get([\"x\"], false), ctx, \"h\").w(\" </td>\").x(ctx.get([\"accuracy\"], false), ctx, { \"block\": body_3 }, {}).w(\"</tr><tr><th>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_4, \"block\": body_5 }, {}).w(\":</th><td> \").f(ctx.get([\"y\"], false), ctx, \"h\").w(\" </td>\").x(ctx.get([\"speed\"], false), ctx, { \"block\": body_6 }, {}).w(\"</tr><tr>\").x(ctx.get([\"z\"], false), ctx, { \"block\": body_7 }, {}).x(ctx.get([\"mdt\"], false), ctx, { \"block\": body_10 }, {}).w(\"</tr> </table>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"X\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"lon\" }); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.w(\"<th>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.accuracy\" }).w(\":</th><td> \").f(ctx.get([\"accuracy\"], false), ctx, \"h\").w(\" m </td>\"); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.w(\"Y\"); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"lat\" }); } body_5.__dustBody = !0; function body_6(chk, ctx) { return chk.w(\"<th>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.speed\" }).w(\":</th><td>\").f(ctx.get([\"speed\"], false), ctx, \"h\").w(\" km/h</td>\"); } body_6.__dustBody = !0; function body_7(chk, ctx) { return chk.w(\"<th>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_8, \"block\": body_9 }, {}).w(\":</th><td> \").f(ctx.get([\"z\"], false), ctx, \"h\").w(\" m </td>\"); } body_7.__dustBody = !0; function body_8(chk, ctx) { return chk.w(\"Z\"); } body_8.__dustBody = !0; function body_9(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"ele\" }); } body_9.__dustBody = !0; function body_10(chk, ctx) { return chk.w(\"<th title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \" mdt.title\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"ele\" }).w(\" (\").h(\"i18n\", ctx, {}, { \"$key\": \"mdt\" }).w(\"):</th><td>\").f(ctx.get([\"mdt\"], false), ctx, \"h\").w(\" m </td>\"); } body_10.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self.wrap = new TC.wrap.control.Geolocation(self);\r\n        self.wrap.register(map);\r\n\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            stealth: true,\r\n            title: 'Posicionar.GPS',\r\n        }).then(function (layer) {\r\n            self.layerGPS = layer;\r\n        });\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            stealth: true,\r\n            title: 'Posicionar.Tracking',\r\n            styles: {\r\n                point: {\r\n                    radius: 3,\r\n                    fillColor: \"#00ced1\",\r\n                    fillOpacity: function () {\r\n                        return this.track.renderTrack.checked ? 1 : 0;\r\n                    }.bind(self),\r\n                    strokeColor: \"#ffffff\",\r\n                    fontColor: \"#00ced1\",\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 1,\r\n                    label: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            name = (name + '').trim().toLowerCase();\r\n                        } else {\r\n                            name = '';\r\n                        }\r\n\r\n                        return name;\r\n                    }\r\n                },\r\n                line: {\r\n                    strokeOpacity: function () {\r\n                        return this.track.renderTrack.checked ? 1 : 0;\r\n                    }.bind(self),\r\n                    strokeWidth: 2,\r\n                    strokeColor: \"#00ced1\",\r\n                    lineDash: [.1, 6]\r\n                }\r\n            }\r\n        }).then(function (layer) {\r\n            self.layerTracking = layer;\r\n        });\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            stealth: true,\r\n            title: 'Posicionar.Track',\r\n            styles: {\r\n                line: {\r\n                    strokeWidth: 2,\r\n                    strokeColor: \"#C52737\"\r\n                },\r\n                point: {\r\n                    radius: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            return 3;\r\n                        } else {\r\n                            return 6;\r\n                        }\r\n\r\n                        return 3;\r\n                    },\r\n                    fillColor: \"#C52737\",\r\n                    strokeColor: \"#ffffff\",\r\n                    fontColor: \"#C52737\",\r\n                    fontSize: 10,\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 2,\r\n                    label: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            name = (name + '').trim().toLowerCase();\r\n                        } else {\r\n                            name = '';\r\n                        }\r\n\r\n                        return name;\r\n                    }\r\n                }\r\n            }\r\n        }).then(function (layer) {\r\n            self.layerTrack = layer;\r\n        });\r\n\r\n        map.on(TC.Consts.event.FEATURESIMPORT, function (e) {\r\n            const self = this;\r\n            const fileName = e.fileName;\r\n            const target = e.dropTarget;\r\n            var kmlPattern = '.' + TC.Consts.format.KML.toLowerCase();\r\n            var gpxPattern = '.' + TC.Consts.format.GPX.toLowerCase();\r\n\r\n            // GLS: ¿es un GPX?\r\n            if (fileName.toLowerCase().indexOf(gpxPattern) === fileName.length - gpxPattern.length ||\r\n                // GLS: ¿es un KML y viene desde el upload de Geolocation?\r\n                (fileName.toLowerCase().indexOf(kmlPattern) === fileName.length - kmlPattern.length && target === self)) {\r\n\r\n                self.clear(self.Const.Layers.TRACK);\r\n                self.importTrack(e);\r\n\r\n                if (/.kml$/g.test(fileName.toLowerCase()) && self.layerTrack) {\r\n                    if (self.layerTrack.styles) {\r\n                        self.layerTrack.features.forEach(function (feature) {\r\n                            if (feature instanceof TC.feature.Point && self.layerTrack.styles.point) {\r\n                                feature.setStyle(self.layerTrack.styles.point);\r\n                            } else if (feature instanceof TC.feature.Polyline && self.layerTrack.styles.line) {\r\n                                feature.setStyle(self.layerTrack.styles.line);\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            } else {\r\n                //GLS: si es un KML pero viene desde el mapa o es otro tipo de archivo que no es ni GPX ni KML, lo ignoramos\r\n                return;\r\n            }\r\n        }.bind(self));\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        return self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n        }).then(function () {\r\n            return TC.Control.prototype.render.call(self, callback);\r\n        });\r\n    };\r\n\r\n    ctlProto.importTrack = function (options) {\r\n        var self = this;\r\n\r\n        if (!self.isDisabled) {\r\n            if (options.fileName && options.features && options.features.length > 0) {\r\n\r\n                var wait = self.getLoadingIndicator().addWait();\r\n                self.importedFileName = options.fileName;\r\n                const addPromises = [];\r\n                for (var i = 0, len = options.features.length; i < len; i++) {\r\n                    addPromises.push(self.layerTrack.addFeature(options.features[i]));\r\n                }\r\n                Promise.all(addPromises).then(function () {\r\n                    self.wrap.processImportedFeatures({ wait: wait, notReproject: options.notReproject });\r\n\r\n                    if (self.layerTrack) { // Si tenemos capa es que todo ha ido bien y gestionamos el despliegue del control\r\n                        // Desplegamos el control \"ubicar\" al importar mediante drag&drop\r\n                        if (self.map && self.map.layout && self.map.layout.accordion) {\r\n                            if (self.div.classList.contains(TC.Consts.classes.COLLAPSED)) {\r\n                                self.map.controls\r\n                                    .filter(function (ctl) {\r\n                                        // Todos los otros controles que no cuelgan de otro control\r\n                                        return ctl !== self && !ctl.containerControl;\r\n                                    })\r\n                                    .forEach(function (ctl) {\r\n                                        ctl.div.classList.add(TC.Consts.classes.COLLAPSED);\r\n                                    });\r\n                            }\r\n                        }\r\n\r\n                        self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                        self.div.querySelector('.' + self.CLASS + '-btn-tracks > span').click();\r\n\r\n                        if (!options.isShared) {\r\n                            // abrimos el panel de herramientas\r\n                            self.map.trigger(TC.Consts.event.TOOLSOPEN);\r\n                        }                        \r\n                    }\r\n                });\r\n            }\r\n        } else if (/.gpx$/g.test(options.fileName.toLowerCase())) {\r\n            self.map.toast(self.getLocaleString(\"geo.trk.import.disabled\"), { type: TC.Consts.msgType.WARNING });\r\n        }\r\n    };\r\n\r\n    ctlProto.prepareFeaturesToShare = function (trackUid) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            if (trackUid) {\r\n\r\n                var storageData = self.availableTracks.filter(function (saved) {\r\n                    return saved.uid.toString() === trackUid.toString();\r\n                })[0].data;\r\n\r\n                // Aplicamos una precisión un dígito mayor que la del mapa, si no, al compartir algunas parcelas se deforman demasiado\r\n                var precision = Math.pow(10, TC.Consts.DEGREE_PRECISION + 1);\r\n\r\n                var storageFeatures = new ol.format.GeoJSON().readFeatures(storageData);\r\n                const promises = new Array(storageFeatures.length);\r\n                storageFeatures.forEach(function (f, idx) {\r\n                    promises[idx] = TC.wrap.Feature.createFeature(f);\r\n                });\r\n\r\n                Promise.all(promises).then(function (tcFeatures) {\r\n                    self.featuresToShare = tcFeatures.map(function (f) {\r\n                        const fObj = {};\r\n                        var layerStyle;\r\n                        switch (true) {\r\n                            case TC.feature.Marker && f instanceof TC.feature.Marker:\r\n                                fObj.type = TC.Consts.geom.MARKER;\r\n                                break;\r\n                            case TC.feature.Point && f instanceof TC.feature.Point:\r\n                                fObj.type = TC.Consts.geom.POINT;\r\n                                break;\r\n                            case TC.feature.Polyline && f instanceof TC.feature.Polyline:\r\n                                fObj.type = TC.Consts.geom.POLYLINE;\r\n                                break;\r\n                            case TC.feature.MultiPolyline && f instanceof TC.feature.MultiPolyline:\r\n                                fObj.type = TC.Consts.geom.MULTIPOLYLINE;\r\n                                break;\r\n                        }\r\n                        fObj.id = f.id;\r\n                        fObj.geom = TC.Util.compactGeometry(f.geometry, precision);\r\n                        fObj.data = f.getData();\r\n\r\n                        return fObj;\r\n                    });\r\n\r\n                    resolve();\r\n                });\r\n            } else {\r\n                resolve();\r\n            }\r\n        });\r\n\r\n\r\n    };\r\n\r\n    var visibilityTrack = true;\r\n    ctlProto.renderData = function (data, callback) {\r\n        const self = this;\r\n\r\n        var sel = self.Const.Selector;\r\n\r\n        return TC.Control.prototype.renderData.call(self, data, function () {\r\n\r\n            const options = self.div.querySelectorAll(self._classSelector + '-panel');\r\n            self.div.querySelectorAll('.' + self.CLASS + '-select span').forEach(function (span) {\r\n                span.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    var label = e.target;\r\n                    while (label && label.tagName !== 'LABEL') {\r\n                        label = label.parentElement;\r\n                    }\r\n                    const newFormat = label.querySelector('input[type=radio][name=mode]').value;\r\n\r\n                    options.forEach(function (option) {\r\n                        if (option.matches('.' + self.CLASS + '-' + newFormat)) {\r\n                            option.classList.remove(TC.Consts.classes.HIDDEN);\r\n                        }\r\n                        else {\r\n                            option.classList.add(TC.Consts.classes.HIDDEN);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n\r\n            self.track = {\r\n                activateButton: self.div.querySelector(self._classSelector + '-track-ui-activate'),\r\n                deactivateButton: self.div.querySelector(self._classSelector + '-track-ui-deactivate'),\r\n                trackSearch: self.div.querySelector(self._classSelector + '-track-available-srch'),\r\n                trackImportFile: self.div.querySelector(self._classSelector + '-track-import'),\r\n                trackSave: self.div.querySelector(self._classSelector + '-track-save'),\r\n                trackAdd: self.div.querySelector(self._classSelector + '-track-add-wpt'),\r\n                trackContinue: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-continue'),\r\n                trackRenew: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-new'),\r\n                trackClose: self._dialogDiv.querySelector('.tc-ctl-geolocation-continue-track-dialog button.tc-modal-close'),\r\n                //trackAddSegment: self.div.querySelector('#tc-ctl-geolocation-track-segment'),\r\n                trackAdvertisementOK: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-ok')\r\n            };\r\n\r\n            self.track.trackList = self.div.querySelector(self._classSelector + '-track-available-lst');\r\n\r\n            self.track.trackToolPanelOpened = self.div.querySelector('#tc-ctl-geolocation-track-panel-opened');\r\n\r\n            self.div.querySelector('.' + ctlProto.CLASS + '-track-panel-help').addEventListener('click', function () {\r\n                _showAlerMsg.call(self);\r\n            });\r\n\r\n            self.track.trackName = self.div.querySelector(self._classSelector + '-track-title');\r\n\r\n            self.track.trackWPT = self.div.querySelector(self._classSelector + '-track-waypoint');\r\n\r\n            if (TC.Util.detectMobile()) {\r\n                if (Modernizr.mq('screen and (max-height: 50em) and (max-width: 50em)'))\r\n                    self.track.trackToolPanelOpened.checked = false;\r\n            }\r\n\r\n            if (window.File && window.FileReader && window.FileList && window.Blob) {\r\n                self.track.trackImportFile.disabled = false;\r\n                // GLS: Eliminamos el archivo subido, sin ello no podemos subir el mismo archivo seguido varias veces\r\n                self.track.trackImportFile.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    // Envolvemos el input en un form\r\n                    const input = this;\r\n                    const form = document.createElement('form');\r\n                    const parent = input.parentElement;\r\n                    parent.insertBefore(form, input);\r\n                    form.appendChild(input);\r\n                    form.reset();\r\n                    // Desenvolvemos el input del form\r\n                    form.insertAdjacentElement('afterend', input);\r\n                    parent.removeChild(form);\r\n                });\r\n                self.track.trackImportFile.addEventListener('change', function (e) {\r\n                    if (!self._cleaning) { // Valido que el evento import no lo provoco yo al limpiar el fileinput (al limpiar se lanza el change)                        \r\n                        self.clear(self.Const.Layers.TRACK);\r\n\r\n                        if (self.map) {\r\n                            self.map.on(TC.Consts.event.LAYERERROR, _layerError);\r\n                            self.map.wrap.loadFiles(e.target.files, { control: self });\r\n                        }\r\n                    }\r\n                });\r\n            } else {\r\n                console.log('no es posible la importación');\r\n            }\r\n\r\n            self.track.activateButton.addEventListener('click', function () {\r\n                self.activateTracking();\r\n                _activateTrackingBtns.call(self);\r\n\r\n            });\r\n            self.track.deactivateButton.addEventListener('click', function () {\r\n                self.deactivateTracking();\r\n                _deactivateTrackingBtns.call(self);\r\n            });\r\n\r\n            var _filter = function (searchTerm) {\r\n                searchTerm = searchTerm.toLowerCase();\r\n                //tc-ctl-geolocation-track-available-empty\r\n                const lis = Array.from(self.track.trackList.querySelectorAll('li'));\r\n                lis.forEach(function (li) {\r\n                    li.style.display = 'none';\r\n                });\r\n                const trackLis = lis.filter(function (li) {\r\n                    return li.matches('li:not([class]),li.' + self.Const.Classes.SELECTEDTRACK);\r\n                });\r\n\r\n                const searchIcon = self.div.querySelector(self._classSelector + '-track-search-icon');\r\n                if (searchTerm.length === 0) {\r\n                    trackLis.forEach(function (li) {\r\n                        li.style.display = '';\r\n                    });\r\n                    searchIcon.style.visibility = 'visible';\r\n                } else {\r\n                    searchIcon.style.visibility = 'hidden';\r\n                    var r = new RegExp(searchTerm, 'i');\r\n                    trackLis.forEach(function (li) {\r\n                        li.style.display = r.test(li.querySelector('span').textContent) ? '' : 'none';\r\n                    });\r\n\r\n                    if (!trackLis.some(function (li) {\r\n                        return li.style.display === '';\r\n                    })) {\r\n                        lis.forEach(function (li) {\r\n                            if (li.matches('[class^=\"tc-ctl-geolocation-track-not\"]')) {\r\n                                li.style.display = '';\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            };\r\n            const trackSearchListener = function () {\r\n                _filter(this.value.toLowerCase().trim());\r\n            };\r\n            self.track.trackSearch.addEventListener(\"keyup\", trackSearchListener);\r\n            self.track.trackSearch.addEventListener(\"search\", trackSearchListener);\r\n\r\n            // IE10 polyfill\r\n            try {\r\n                if (self.track.trackSearch.querySelector('::-ms-clear')) {\r\n                    var oldValue;\r\n                    self.track.trackSearch.addEventListener('mouseup', function (e) {\r\n                        oldValue = self.track.trackSearch.value;\r\n\r\n                        if (oldValue === '') {\r\n                            return;\r\n                        }\r\n\r\n                        // When this event is fired after clicking on the clear button\r\n                        // the value is not cleared yet. We have to wait for it.\r\n                        setTimeout(function () {\r\n                            var newValue = self.track.trackSearch.value;\r\n\r\n                            if (newValue === '') {\r\n                                _filter(newValue);\r\n                            }\r\n                        }, 1);\r\n                    });\r\n                }\r\n            }\r\n            catch (e) { }\r\n\r\n            // en el panel\r\n            self.track.trackSave.addEventListener('click', self.saveTrack.bind(self));\r\n            self.track.trackAdd.addEventListener('click', self.addWaypoint.bind(self));\r\n\r\n            const list = self.div.querySelector(self._classSelector + '-track-available-lst');\r\n\r\n            // en lista\r\n            var _edit = function (edit, elm) {\r\n                if (elm.tagName !== 'LI') {\r\n                    elm = elm.parentElement;\r\n                }\r\n\r\n                const input = elm.querySelector('input');\r\n                const span = elm.querySelector('span');\r\n\r\n                if (edit) {\r\n\r\n                    input.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    input.focus();\r\n                    input.value = span.textContent;\r\n                    span.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SIMULATE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EDIT).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DELETE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DRAW).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT_GPX).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT_KML).classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SAVE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.CANCEL).classList.remove(TC.Consts.classes.HIDDEN);\r\n                } else {\r\n\r\n                    input.classList.add(TC.Consts.classes.HIDDEN);\r\n                    span.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SIMULATE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EDIT).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DELETE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DRAW).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT_GPX).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT_KML).classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SAVE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.CANCEL).classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            };\r\n\r\n            self.uiSimulate = function (simulate, elm) {\r\n                if (elm) {\r\n                    var editControls = [\r\n                        sel.SIMULATE,\r\n                        sel.EDIT,\r\n                        sel.DELETE,\r\n                        sel.EXPORT_GPX,\r\n                        sel.EXPORT_KML\r\n                    ];\r\n                    var simulateControls = [\r\n                        sel.STOP,\r\n                        sel.PAUSE,\r\n                        sel.BACKWARD,\r\n                        sel.FORWARD,\r\n                        sel.SPEED\r\n                    ];\r\n                    var cnt = elm.tagName === 'LI' ? elm : elm.parentNode;\r\n\r\n                    editControls.forEach(function (ctl) {\r\n                        cnt.querySelector(ctl).hidden = simulate;\r\n                    });\r\n\r\n                    simulateControls.forEach(function (ctl) {\r\n                        cnt.querySelector(ctl).hidden = !simulate;\r\n                    });\r\n                }\r\n            };\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(sel.SIMULATE, function (e) {\r\n                var wait = self.getLoadingIndicator().addWait();\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = 'x 1';\r\n\r\n                _loadTrack(self, e.target).then(function () { //Para evitar el bloqueo de la interfaz en móviles\r\n                    self.getLoadingIndicator().removeWait(wait)\r\n                });\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(sel.DRAW, function (e) {\r\n                var wait = self.getLoadingIndicator().addWait();\r\n\r\n                _drawTrack(self, e.target).then(function () {\r\n                    self.getLoadingIndicator().removeWait(wait);\r\n                });\r\n            }));\r\n\r\n            self.on(self.Const.Event.IMPORTEDTRACK, function (e) {\r\n                if (!self.isDisabled) {\r\n                    const listElement = self.track.trackList.querySelector('li[data-id=\"' + e.index + '\"]');\r\n                    _drawTrack(self, listElement.querySelector(sel.DRAW));\r\n                    $(self.track.trackList).animate({\r\n                        scrollTop: e.index * listElement.offsetHeight\r\n                    }, 'slow');\r\n                } else {\r\n                    self.map.toast(self.getLocaleString(\"geo.trk.import.disabled\"), { type: TC.Consts.msgType.WARNING });\r\n                }\r\n            });\r\n\r\n            const _stopOtherTracks = function (self, trackLiId) {\r\n                self.track.trackList.querySelectorAll('li[data-id]').forEach(function (listItem) {\r\n                    if (listItem.dataset.id !== trackLiId) {\r\n                        const btnSimulate = listItem.querySelector(sel.SIMULATE);\r\n                        const btnPause = listItem.querySelector(sel.PAUSE);\r\n\r\n                        btnSimulate.classList.remove(self.Const.Classes.SIMULATIONACTIVATED);\r\n                        btnSimulate.setAttribute('title', self.getLocaleString(\"tr.lst.simulate\"));\r\n                        btnPause.classList.remove('play');\r\n                        btnPause.setAttribute('title', self.getLocaleString(\"tr.lst.pause\"));\r\n\r\n                        self.uiSimulate(false, listItem);\r\n                        _edit(false, listItem);\r\n                    }\r\n                });\r\n\r\n                self.clear(self.Const.Layers.TRACK);\r\n            };\r\n\r\n            var _drawTrack = function (self, btnDraw) {\r\n                return new Promise(function (resolve, reject) {\r\n\r\n                    const trackLi = btnDraw.parentElement;\r\n\r\n                    setTimeout(function () {\r\n                        if (trackLi.classList.contains(self.Const.Classes.SELECTEDTRACK)) {\r\n                            self.uiSimulate(false, btnDraw);\r\n\r\n                            self.clear(self.Const.Layers.TRACK);\r\n\r\n                            btnDraw.setAttribute('title', btnDraw.textContent);\r\n                        }\r\n                        else if (self.getSelectedTrack()) { // GLS: si hay elemento seleccionado actuamos\r\n                            _stopOtherTracks(self, trackLi.dataset.id);\r\n                            self.drawTrack(trackLi);\r\n                        } else {\r\n                            self.drawTrack(trackLi);\r\n                        }\r\n\r\n                        /* GLS: 15/02/2019 Preparamos la feature por si se comparte, necesito hacerlo aquí \r\n                           porque la gestión en asíncrona y todo el flujo de exportación es síncrono */\r\n                        if (trackLi.classList.contains(self.Const.Classes.SELECTEDTRACK)) {\r\n                            self.prepareFeaturesToShare(trackLi.dataset.uid).then(function () {\r\n                                resolve();\r\n                            });\r\n                        } else {\r\n                            resolve();\r\n                        }\r\n                    }, 0);\r\n                });\r\n            };\r\n\r\n            var _loadTrack = function (self, btnSimulate) {\r\n                return new Promise(function (resolve, reject) {\r\n                    setTimeout(function () {\r\n                        const trackLi = btnSimulate.parentElement;\r\n\r\n                        _stopOtherTracks(self, trackLi.dataset.id);\r\n                        self.uiSimulate(false, self.getSelectedTrack());\r\n                        self.uiSimulate(true, btnSimulate);\r\n\r\n                        self.simulate_paused = false;\r\n                        self.simulateTrack(trackLi);\r\n\r\n                        resolve();\r\n                    }, 0);\r\n                });\r\n            };\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.EDIT, function (e) {\r\n                _edit(true, e.target);\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.DELETE, function (e) {\r\n                self.removeTrack(e.target.parentElement);\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.SAVE, function (e) {\r\n                var newName = e.target.parentElement.querySelector('input').value;\r\n                if (newName.trim().length === 0) {\r\n                    TC.alert(self.getLocaleString('geo.trk.edit.alert'));\r\n                }\r\n                else {\r\n                    self.editTrackName(e.target.parentElement.dataset.id, e.target.parentElement.querySelector('input').value);\r\n                    _edit(false, e.target);\r\n                }\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.CANCEL, function (e) {\r\n                _edit(false, e.target);\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.EXPORT_GPX + ',' + self._classSelector + ' ' + sel.EXPORT_KML, function (e) {\r\n                const parent = e.target.parentElement;\r\n                var prefix = 'tc-btn-export-';\r\n                var className = Array.from(e.target.classList).filter(function (cls) {\r\n                    return cls.indexOf(prefix) === 0;\r\n                })[0];\r\n                var mimeType = className.replace(prefix, '').toUpperCase();\r\n\r\n                self.export(mimeType, parent).then(function (data) {\r\n                    if (data) {\r\n                        var filename = parent.querySelector('span').textContent;\r\n                        var regex = new RegExp(self.Const.SupportedFileExtensions.join('|'), 'gi');\r\n                        var cleanFilename = filename.replace(regex, '');\r\n                        TC.Util.downloadFile(cleanFilename + '.' + mimeType.toLowerCase(), self.Const.MimeMap[mimeType], data);\r\n                    } else {\r\n                        TC.alert(self.getLocaleString('geo.error.export'));\r\n                    }\r\n                });\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.STOP, function (e) {\r\n                self.uiSimulate(false, e.target);\r\n                self.wrap.simulateTrackEnd();\r\n                const btnPause = e.target.parentElement.querySelector(sel.PAUSE);\r\n                btnPause.classList.remove('play');\r\n                btnPause.setAttribute('title', self.getLocaleString('tr.lst.pause'));\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = 'x 1';\r\n                self.simulate_speed = 1;\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.PAUSE, function (e) {\r\n                self.simulate_paused = !e.target.classList.contains('play');\r\n                if (self.simulate_paused)\r\n                    self.simulate_pausedElapse = -1;\r\n\r\n                e.target.setAttribute('title', self.getLocaleString(self.simulate_paused ? 'tr.lst.play' : 'tr.lst.pause'));\r\n                if (self.simulate_paused) {\r\n                    e.target.classList.add('play');\r\n                }\r\n                else {\r\n                    e.target.classList.remove('play');\r\n                }\r\n            }));\r\n\r\n            var lapse = 0.5;\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.BACKWARD, function (e) {\r\n                if (self.simulate_speed == 1)\r\n                    self.simulate_speed = lapse;\r\n                else self.simulate_speed = self.simulate_speed / 2;\r\n\r\n                e.target.parentElement.querySelector(self._classSelector + \" \" + sel.FORWARD).disabled = false;\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = self.simulate_speed < 1 ? '/ ' + (1 / self.simulate_speed) : 'x ' + self.simulate_speed;\r\n\r\n                if (self.simulate_speed == 0.000244140625) {\r\n                    e.target.disabled = true;\r\n                }\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.FORWARD, function (e) {\r\n                self.simulate_speed = self.simulate_speed / lapse;\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = self.simulate_speed < 1 ? '/ ' + (1 / self.simulate_speed) : 'x ' + self.simulate_speed;\r\n\r\n                e.target.parentElement.querySelector(self._classSelector + \" \" + sel.BACKWARD).disabled = false;\r\n\r\n                if (self.simulate_speed == 4096) {\r\n                    e.target.disabled = true;\r\n                }\r\n            }));\r\n\r\n\r\n            // popup\r\n            self.track.trackContinue.addEventListener('click', function () {\r\n                // cerramos popup y continuamos con el track de session y almacenando en session\r\n                TC.Util.closeModal();\r\n                // al obtener la posición se almacena en session y continuamos almacenando en session mientras se mueve\r\n                _tracking.call(self);\r\n            });\r\n            self.track.trackRenew.addEventListener('click', function () {\r\n                // eliminamos el track actual de session - restablecemos el tracking\r\n                delete self.sessionTracking;\r\n                TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, undefined);\r\n                localforage.removeItem(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n                // cerramos el popup\r\n                TC.Util.closeModal();\r\n                // al obtener la posición se almacena en session y continuamos almacenando en session mientras se mueve\r\n                _tracking.call(self);\r\n            });\r\n            self.track.trackClose.addEventListener('click', function () {\r\n                _deactivateTrackingBtns.call(self);\r\n            });\r\n            //self.track.trackAddSegment.addEventListener('click', function () {\r\n            //    TC.alert('pendiente');\r\n            //    // cerramos el popup\r\n            //    TC.Util.closeModal();\r\n            //});\r\n\r\n            // popup advertencia\r\n            self.track.trackAdvertisementOK.addEventListener('click', function () {\r\n\r\n                const checkboxes = document.body.querySelectorAll('input[name*=\"Advertisement\"]:checked');\r\n\r\n                if (checkboxes.length > 0) {\r\n                    const promise = new Promise(function (resolve, reject) {\r\n                        if (window.localforage)\r\n                            resolve();\r\n                        else {\r\n                            TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                                resolve();\r\n                            });\r\n                        }\r\n                    });\r\n\r\n                    promise.then(function () {\r\n                        localforage.setItem(checkboxes[0].getAttribute('name'), false);\r\n                    });\r\n                }\r\n\r\n                TC.Util.closeModal();\r\n            });\r\n\r\n            self.track.renderTrack = document.querySelector('#tc-ctl-geolocation-track-render');\r\n            self.track.renderTrack.addEventListener('change', function () {\r\n                if (self.track.activateButton.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                    self.layerTracking.setVisibility(this.checked);\r\n                }\r\n\r\n                visibilityTrack = this.checked;\r\n            });\r\n\r\n            if (window.localforage)\r\n                self.bindTracks();\r\n            else {\r\n                TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                    self.bindTracks();\r\n                });\r\n            }\r\n\r\n            if ($.isFunction(callback)) {\r\n                callback();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.activate = function () {\r\n        var self = this;\r\n        //TC.Control.prototype.activate.call(self);\r\n    };\r\n\r\n    ctlProto.deactivate = function () {\r\n        var self = this;\r\n\r\n        TC.Util.closeModal();\r\n        self.clearSelection();\r\n        self.deactivateTracking();\r\n        //TC.Control.prototype.deactivate.call(self);\r\n    };\r\n\r\n    var _layerError = function () {\r\n        var self = this;\r\n\r\n        self.map.off(TC.Consts.event.LAYERERROR, _layerError);\r\n        self.clearFileInput(self.track.trackImportFile);\r\n\r\n        TC.alert(self.getLocaleString(\"geo.trk.upload.error3\"));\r\n    };\r\n    var _activateTrackingBtns = function () {\r\n        var self = this;\r\n\r\n        self.track.activateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        self.track.deactivateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    var _deactivateTrackingBtns = function () {\r\n        var self = this;\r\n\r\n        self.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n        self.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    var _showAlerMsg = function () {\r\n        var self = this;\r\n        self.map.toast(self.div.querySelector(\".alert-warning\").innerHTML, {\r\n            duration: 10000\r\n        });\r\n    };\r\n\r\n    ctlProto.markerStyle = {\r\n        radius: 7,\r\n        fillColor: [255, 0, 0, 100],\r\n        strokeColor: [255, 255, 255, 255],\r\n        strokeWidth: 2\r\n    };\r\n\r\n    ctlProto.lineStyle = {\r\n        strokeWidth: 2,\r\n        strokeColor: [0, 206, 209, 255]\r\n    };\r\n\r\n    ctlProto.setFormatInfoNewPosition = function (newPosition) {\r\n        var self = this;\r\n\r\n        var data = {};\r\n        var locale = TC.Util.getMapLocale(self.map);\r\n\r\n        if (self.map.on3DView) {\r\n            var geoCoords = self.map.crs !== self.map.view3D.crs ? TC.Util.reproject(newPosition.position, self.map.crs, self.map.view3D.crs) : newPosition.position;\r\n            data.x = geoCoords[0].toLocaleString(locale);\r\n            data.y = geoCoords[1].toLocaleString(locale);\r\n\r\n            data.mdt = Math.round(self.map.view3D.getHeightFromMDT(geoCoords)).toLocaleString(locale);\r\n\r\n            data.isGeo = true;\r\n\r\n        } else {\r\n            data.x = Math.round(newPosition.position[0]).toLocaleString(locale);\r\n            data.y = Math.round(newPosition.position[1]).toLocaleString(locale);\r\n        }\r\n\r\n        data.z = (Math.round(newPosition.altitude).toLocaleString(locale));\r\n        data.accuracy = (Math.round(newPosition.accuracy).toLocaleString(locale));\r\n        data.speed = newPosition.speed.toLocaleString(locale, { minimumFractionDigits: 1, maximumFractionDigits: 1 });\r\n\r\n        return data;\r\n    };\r\n\r\n    ctlProto.renderInfoNewPosition = function (d) {\r\n        var self = this;\r\n\r\n        self.getRenderedHtml(self.CLASS + '-tracking-toast', self.setFormatInfoNewPosition(d.pd), function (html) {\r\n\r\n            if (!self.track.infoPanel) {\r\n                self.track.infoPanel = true;\r\n\r\n                var resultsPanelOptions = {\r\n                    content: \"table\",\r\n                    titles: {\r\n                        main: self.getLocaleString(\"geo.mylocation\"),\r\n                        max: self.getLocaleString(\"geo.mylocation.show\")\r\n                    },\r\n                    classes: {\r\n                        collapsed: \"tracking\"\r\n                    }\r\n                };\r\n\r\n                var ctlPromise;\r\n                const addResultsPanelInfo = function (controlContainer) {\r\n                    resultsPanelOptions.side = controlContainer.SIDE.RIGHT;\r\n                    ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                };\r\n\r\n                if (self.options.displayOn) {\r\n                    var controlContainer = self.map.getControlsByClass('TC.control.' + self.options.displayOn[0].toUpperCase() + self.options.displayOn.substring(1))[0];\r\n                    if (!controlContainer) {\r\n                        self.map.addControl(self.options.displayOn).then(addResultsPanelInfo);\r\n                    } else {\r\n                        addResultsPanelInfo(controlContainer);\r\n                    }\r\n                } else {\r\n                    resultsPanelOptions.div = document.createElement('div');\r\n                    self.map.div.appendChild(resultsPanelOptions.div);\r\n                    ctlPromise = self.map.addControl('resultsPanel', resultsPanelOptions);\r\n                }\r\n\r\n                ctlPromise.then(function (resultsPanelInfo) {\r\n                    resultsPanelInfo.caller = self;\r\n                    self.map.getControlsByClass('TC.control.ResultsPanel').filter(function (panel) {\r\n                        return panel.content === \"table\" && panel !== resultsPanelInfo;\r\n                    }).forEach(function (panel) {\r\n                        panel.close();\r\n                    });\r\n\r\n                    self.track.infoPanel = resultsPanelInfo;\r\n\r\n                    resultsPanelInfo.renderPromise().then(function () {\r\n                        resultsPanelInfo.open(html);\r\n                    });\r\n                });\r\n            } else if (typeof (self.track.infoPanel) !== \"boolean\" && !self.track.infoPanel.isMinimized()) {\r\n                self.track.infoPanel.renderPromise().then(function () {\r\n                    self.track.infoPanel.getTableContainer().innerHTML = html;\r\n                    if (!self.track.infoPanel.isVisible()) {\r\n                        self.track.infoPanel.doVisible();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n\r\n    var duringTrackingToolsPanel = function () {\r\n        var self = this;\r\n\r\n        if (!self.track.trackToolPanelOpened.checked) {\r\n            self.map.trigger(TC.Consts.event.TOOLSCLOSE);\r\n        }\r\n    };\r\n\r\n    var _tracking = function () {\r\n        var self = this;\r\n\r\n        self.activate();\r\n\r\n        _activateTrackingBtns.call(self);\r\n        duringTrackingToolsPanel.call(self);\r\n\r\n        self.on(self.Const.Event.POSITIONCHANGE, function (d) {\r\n\r\n            self.currentPoint = d.pd;\r\n            self.renderInfoNewPosition(d);\r\n\r\n            self.track.trackName.disabled = false;\r\n            self.track.trackSave.disabled = false;\r\n\r\n            self.track.trackWPT.disabled = false;\r\n            self.track.trackAdd.disabled = false;\r\n\r\n            // cada vez que se registra una nueva posición almacenamos en sessionStorage\r\n            TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, self.wrap.formattedToStorage(self.layerTracking).features);\r\n        });\r\n        self.on(self.Const.Event.STATEUPDATED, function (data) {\r\n            //self.track.htmlMarker.setAttribute('src', data.moving ? 'layout/idena/img/geo-marker-heading.png' : 'layout/idena/img/geo-marker.png');\r\n        });\r\n\r\n        self.clear(self.Const.Layers.TRACKING);\r\n\r\n        advertisement.call(self, self.Const.LocalStorageKey.TRACKINGSHOWADVERTISEMENT);\r\n\r\n        self.wrap.setTracking(true);\r\n    };\r\n\r\n    /* inicio gestión suspensión de la pantalla en móviles */\r\n    var _onpauseVideo;\r\n    var addVideoKeepScreenOn = function () {\r\n        var self = this;\r\n\r\n        if (!self.videoScreenOn) {\r\n            var media = {\r\n                WebM: \"data:video/webm;base64,GkXfo0AgQoaBAUL3gQFC8oEEQvOBCEKCQAR3ZWJtQoeBAkKFgQIYU4BnQI0VSalmQCgq17FAAw9CQE2AQAZ3aGFtbXlXQUAGd2hhbW15RIlACECPQAAAAAAAFlSua0AxrkAu14EBY8WBAZyBACK1nEADdW5khkAFVl9WUDglhohAA1ZQOIOBAeBABrCBCLqBCB9DtnVAIueBAKNAHIEAAIAwAQCdASoIAAgAAUAmJaQAA3AA/vz0AAA=\",\r\n                MP4: \"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAB8JbCAfCWwgAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAD3wlsIB8JbCAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAIAAAACAAAAAABsW1kaWEAAAAgbWRoZAAAAAB8JbCAfCWwgAAAA+gAAAAAVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW9IYW5kbGVyAAAAAVxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEcc3RibAAAALhzdHNkAAAAAAAAAAEAAACobXA0dgAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAIAAgASAAAAEgAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABj//wAAAFJlc2RzAAAAAANEAAEABDwgEQAAAAADDUAAAAAABS0AAAGwAQAAAbWJEwAAAQAAAAEgAMSNiB9FAEQBFGMAAAGyTGF2YzUyLjg3LjQGAQIAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAK2lsc3QAAAAjqXRvbwAAABtkYXRhAAAAAQAAAABMYXZmNTIuNzguMw==\"\r\n            };\r\n\r\n            self.videoScreenOn = document.createElement('video');\r\n            self.videoScreenOn.setAttribute(\"loop\", \"\");\r\n            self.videoScreenOn.setAttribute(\"muted\", \"\");\r\n            self.videoScreenOn.setAttribute(\"webkit-playsinline\", \"\");\r\n            self.videoScreenOn.setAttribute(\"playsinline\", \"\");\r\n            self.videoScreenOn.setAttribute(\"style\", \"transform: translateZ(0px);\");\r\n\r\n            var sourceWebM = document.createElement('source');\r\n            sourceWebM.src = media.WebM;\r\n            sourceWebM.type = \"video/webm\";\r\n            self.videoScreenOn.appendChild(sourceWebM);\r\n\r\n            var sourceMP4 = document.createElement('source');\r\n            sourceMP4.src = media.MP4;\r\n            sourceMP4.type = \"video/mp4\";\r\n            self.videoScreenOn.appendChild(sourceMP4);\r\n        }\r\n\r\n        self.videoScreenOn.play();\r\n    };\r\n    var removeVideoKeepScreenOn = function () {\r\n        var self = this;\r\n        if (self.videoScreenOn) {\r\n            self.videoScreenOn.pause();\r\n        }\r\n    };\r\n\r\n    var _onWindowBlurred;\r\n    var onWindowBlurred = function () {\r\n        var self = this;\r\n\r\n        fromSessionToStorage.apply(self);\r\n    };\r\n\r\n    var _onWindowFocused;\r\n    var onWindowFocused = function () {\r\n        var self = this;\r\n\r\n        if (self.videoScreenOn.paused)\r\n            self.videoScreenOn.play();\r\n\r\n        fromStorageToSession.apply(self);\r\n    };\r\n\r\n    var getHiddenProperty = function () {\r\n        var prefixes = ['webkit', 'moz', 'ms', 'o'];\r\n\r\n        if ('hidden' in document) return 'hidden';\r\n\r\n        for (var i = 0; i < prefixes.length; i++) {\r\n            if ((prefixes[i] + 'Hidden') in document)\r\n                return prefixes[i] + 'Hidden';\r\n        }\r\n\r\n        return null;\r\n    };\r\n    var _onWindowVisibility;\r\n    var onWindowVisibility = function () {\r\n        var self = this;\r\n\r\n        var hidden = getHiddenProperty();\r\n\r\n        if (!document[hidden])\r\n            onWindowFocused.apply(self);\r\n\r\n        console.log('video is: ' + self.videoScreenOn.paused);\r\n    };\r\n    var addWindowEvents = function () {\r\n        var self = this;\r\n\r\n        if (!_onWindowVisibility)\r\n            _onWindowVisibility = onWindowVisibility.bind(self);\r\n\r\n        if (!_onWindowBlurred)\r\n            _onWindowBlurred = onWindowBlurred.bind(self);\r\n\r\n        if (!_onWindowFocused)\r\n            _onWindowFocused = onWindowFocused.bind(self);\r\n\r\n        window.addEventListener('visibilitychange', _onWindowVisibility, false);\r\n\r\n        // ipad / iphone / ipod (Safari mobile, not Android default browsers not Chrome Mobile that is)\r\n        if (TC.Util.detectSafari() && Modernizr.touch && !navigator.userAgent.match(/Android/i) && !navigator.userAgent.match(/CriOS/i)) {\r\n            window.addEventListener('pagehide', _onWindowBlurred, false);\r\n            window.addEventListener('pageshow', _onWindowFocused, false);\r\n        } else { // the rest            \r\n            window.addEventListener('blur', _onWindowBlurred, false);\r\n            window.addEventListener('focus', _onWindowFocused, false);\r\n        }\r\n    }\r\n    var removeWindowEvents = function () {\r\n\r\n        window.removeEventListener('visibilitychange', _onWindowVisibility, false);\r\n\r\n        // ipad / iphone / ipod (Safari mobile, not Android default browsers not Chrome Mobile that is)\r\n        if (TC.Util.detectSafari() && Modernizr.touch && !navigator.userAgent.match(/Android/i) && !navigator.userAgent.match(/CriOS/i)) {\r\n            window.removeEventListener('pagehide', _onWindowBlurred, false);\r\n            window.removeEventListener('pageshow', _onWindowFocused, false);\r\n        } else { // the rest            \r\n            window.removeEventListener('blur', _onWindowBlurred, false);\r\n            window.removeEventListener('focus', _onWindowFocused, false);\r\n        }\r\n    };\r\n\r\n    var fromSessionToStorage = function () {\r\n        var self = this;\r\n\r\n        var sessionTracking = TC.Util.storage.getSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n        if (sessionTracking && sessionTracking.length > 0)\r\n            localforage.setItem(self.Const.LocalStorageKey.TRACKINGTEMP, typeof (sessionTracking) === \"string\" ? sessionTracking : JSON.stringify(sessionTracking));\r\n    };\r\n    var fromStorageToSession = function () {\r\n        var self = this;\r\n\r\n        localforage.getItem(self.Const.LocalStorageKey.TRACKINGTEMP).then(function (storageData) {\r\n            if (storageData !== null && storageData !== \"null\" && storageData.length > 0) {\r\n                TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, storageData);\r\n            }\r\n        });\r\n    };\r\n    /* final gestión suspensión de la pantalla en móviles */\r\n\r\n    var advertisement = function (showAdvertisement) {\r\n        var self = this;\r\n\r\n        var done = new Promise(function (resolve, reject) {\r\n            if (window.localforage)\r\n                resolve();\r\n            else {\r\n                TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                    resolve();\r\n                });\r\n            }\r\n        });\r\n\r\n        done.then(function () {\r\n            localforage.getItem(showAdvertisement).then(function (registeredShowAdvertisement) {\r\n                if (registeredShowAdvertisement == null) {\r\n                    const dialog = self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-dialog');\r\n                    const checkbox = dialog.querySelector('input[type=\"checkbox\"]');\r\n                    checkbox.setAttribute('name', showAdvertisement);\r\n                    checkbox.checked = false;\r\n\r\n                    document.querySelector('#pageBlurMsg').textContent = TC.Util.detectMobile() ? self.getLocaleString('geo.trk.page.blur'): self.getLocaleString('geo.trk.page.blur.desktop');\r\n\r\n                    dialog.querySelector('h3').textContent = showAdvertisement == self.Const.LocalStorageKey.GPSSHOWADVERTISEMENT ?\r\n                        self.getLocaleString(\"geo.track.activate\") + \" \" + self.getLocaleString(\"geo.gps\") :\r\n                        self.getLocaleString('geo.track.activate.title');\r\n\r\n                    TC.Util.showModal(self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-dialog'));\r\n                }\r\n            });\r\n        });\r\n\r\n        self.map.toast(!TC.Util.detectMobile() ? self.getLocaleString('geo.trk.page.blur.desktop') : self.getLocaleString('geo.trk.page.blur'), {\r\n            type: TC.Consts.msgType.WARNING\r\n        });\r\n    };\r\n\r\n    ctlProto._askTracking = function (callback) {\r\n        var self = this;\r\n\r\n        TC.Util.showModal(self._dialogDiv.querySelector('.tc-ctl-geolocation-continue-track-dialog'), {\r\n            closeCallback: function () {\r\n\r\n                if ($.isFunction(callback)) {\r\n                    callback();\r\n                }\r\n            }\r\n        });\r\n\r\n        return true;\r\n    };\r\n\r\n    ctlProto.activateTracking = function () {\r\n        var self = this;\r\n        var trackingAvailable = true;\r\n\r\n        if (!self.isActive) {\r\n            self.activate();\r\n        }\r\n\r\n        self.clear(self.Const.Layers.TRACKING);\r\n\r\n        try {\r\n            TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TEST, self.Const.LocalStorageKey.TEST);\r\n        } catch (error) {\r\n            if (error.code === DOMException.QUOTA_EXCEEDED_ERR)\r\n                TC.alert(self.getLocaleString(\"geo.error.trackinglocalstorage\"));\r\n            else TC.error(error);\r\n\r\n            trackingAvailable = false;\r\n        }\r\n\r\n        if (trackingAvailable) {\r\n            addVideoKeepScreenOn.apply(self);\r\n            addWindowEvents.apply(self);\r\n\r\n            self.sessionTracking = TC.Util.storage.getSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n            if (self.sessionTracking) {\r\n                var asked = self._askTracking(function () {\r\n                    _deactivateTrackingBtns.call(self);\r\n                });\r\n\r\n                if (!asked) {\r\n                    self.track.trackRenew.click();\r\n                }\r\n            } else _tracking.call(self);\r\n        } else { _deactivateTrackingBtns.call(self); }\r\n    };\r\n\r\n    ctlProto.deactivateTracking = function () {\r\n        var self = this;\r\n\r\n        var _deactivateTracking = function () {\r\n\r\n            self.track.infoPanel.close();\r\n\r\n            fromSessionToStorage.apply(self);\r\n\r\n            self.wrap.setTracking(false);\r\n\r\n\r\n            delete self.geopositionTracking;\r\n\r\n            if (!visibilityTrack) {\r\n                self.div.querySelector(self._classSelector + '-track-render').querySelector('label').click();\r\n            }\r\n\r\n            removeVideoKeepScreenOn.apply(self);\r\n            removeWindowEvents.apply(self);\r\n\r\n            self.off(self.Const.Event.POSITIONCHANGE);\r\n            self.off(self.Const.Event.STATEUPDATED);\r\n\r\n            _deactivateTrackingBtns.call(self);\r\n\r\n            self.track.trackName.value = '';\r\n            self.track.trackName.disabled = true;\r\n            self.track.trackSave.disabled = true;\r\n\r\n            self.track.trackWPT.value = '';\r\n            self.track.trackWPT.disabled = true;\r\n            self.track.trackAdd.disabled = true;\r\n\r\n            self.clear(self.Const.Layers.TRACKING);\r\n            self.clear(self.Const.Layers.GPS);\r\n\r\n            //TC.Control.prototype.deactivate.call(self);\r\n\r\n            return true;\r\n        };\r\n\r\n        if (self.wrap.hasCoordinates()) {\r\n            self.map.toast(self.getLocaleString(\"geo.trk.deactivate.alert\"), {\r\n                duration: 10000\r\n            });\r\n            //TC.alert(self.getLocaleString(\"geo.trk.deactivate.alert\"));\r\n            return _deactivateTracking();\r\n        } else return _deactivateTracking();\r\n    };\r\n\r\n    /* Obtengo los tracks desde localForage */\r\n    ctlProto.getStoredTracks = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var tracks = [];\r\n\r\n            localforage.keys().then(function (keys) {\r\n                keys = keys.filter(function (k) {\r\n                    if (!(k.indexOf(self.Const.LocalStorageKey.TRACKINGTEMP) === 0) && k.indexOf(self.Const.LocalStorageKey.TRACKING) === 0) {\r\n                        return /trk#\\d/i.exec(k);\r\n                    }\r\n                    return false;\r\n                });\r\n\r\n                if (keys.length == 0) {\r\n                    self.availableTracks = tracks;\r\n                    resolve(tracks);\r\n                }\r\n\r\n                const promises = new Array(keys.length);\r\n                keys.forEach(function (key, idx) {\r\n                    promises[idx] = new Promise(function (res, rej) {\r\n                        localforage.getItem(key, function (e, v) {\r\n                            res(v);\r\n                        });\r\n                    });\r\n                });\r\n\r\n                Promise.all(promises).then(function (results) {\r\n                    if (results && results.length) {\r\n                        results.forEach(function (r) {\r\n                            var r = JSON.parse(r);\r\n                            if (r instanceof Array) {\r\n                                tracks = tracks.concat(r);\r\n                            } else {\r\n                                tracks.push(r);\r\n                            }\r\n                        });\r\n\r\n                        var tracksArray = tracks.length > 1 ? _orderTracks(tracks) : tracks;\r\n                        self.availableTracks = tracksArray;\r\n                        resolve(tracksArray);\r\n                    }\r\n                });\r\n            });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Recibe una sucesión de tracks y la ordena por nombre.\r\n     */\r\n    var _orderTracks = function (tracks) {\r\n        var tracksArray = [];\r\n\r\n        for (var index in tracks) {\r\n            if (tracks[index] && typeof (tracks[index]) === \"object\") {\r\n                tracksArray.push(tracks[index]);\r\n                tracksArray.sort(function (a, b) {\r\n                    if (typeof (a.name) === \"string\") {\r\n                        return $.isFunction(a.name.localeCompare) ? a.name.localeCompare(b.name) : 0;\r\n                    } else { return 0; }\r\n                });\r\n            }\r\n        }\r\n\r\n        return tracksArray;\r\n    };\r\n\r\n    /* Almaceno los tracks mediante localForage, actualizo la vble availableTracks y actualizo la lista de tracks */\r\n    ctlProto.setStoredTracks = function (tracks) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const promises = [];\r\n            tracks.forEach(function (t) {\r\n                promises.push(new Promise(function (res, rej) {\r\n                    localforage.setItem(self.Const.LocalStorageKey.TRACKING + \"#\" + t.uid, JSON.stringify(t), function (e, v) {\r\n                        res(v);\r\n                    });\r\n                }));\r\n            });\r\n\r\n            Promise.all(promises).then(function () {\r\n                self.getStoredTracks().then(function () {\r\n                    self.bindTracks();\r\n                    resolve();\r\n                });\r\n            });\r\n        });\r\n    };\r\n\r\n    /* Obtengo los tracks desde vble local */\r\n    ctlProto.getAvailableTracks = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            if (!self.availableTracks) {\r\n                self.getStoredTracks().then(function (availableTracks) {\r\n                    resolve(availableTracks);\r\n                });\r\n            }\r\n            else {\r\n                resolve(self.availableTracks);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.bindTracks = function () {\r\n        var self = this;\r\n\r\n        const listItems = self.track.trackList.querySelectorAll('li');\r\n        listItems.forEach(function (li) {\r\n            li.style.display = 'none';\r\n        });\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n\r\n            if (_isEmpty(tracks)) {\r\n                self.track.trackList.querySelectorAll('li[class^=\"tc-ctl-geolocation-track-available-empty\"]').forEach(function (li) {\r\n                    li.style.display = '';\r\n                });\r\n                self.track.trackSearch.disabled = true;\r\n            }\r\n            else {\r\n                const currentSelectedTrack = self.getSelectedTrack();\r\n                var currentSelectedTrackId;\r\n                if (currentSelectedTrack) {\r\n                    currentSelectedTrackId = currentSelectedTrack.dataset.uid\r\n                }\r\n                self.track.trackList.querySelectorAll('li[data-id]').forEach(function (li) {\r\n                    self.track.trackList.removeChild(li);\r\n                });\r\n\r\n                for (var i = 0; i < tracks.length; i++) {\r\n                    var t = tracks[i];\r\n                    if (typeof (t) === \"object\") {\r\n                        self.getRenderedHtml(self.CLASS + '-track-node', {\r\n                            id: i, uid: t.uid, name: t.name ? t.name.trim() : ''\r\n                        }, function (html) {\r\n                            const parser = new DOMParser();\r\n                            const newLi = parser.parseFromString(html, 'text/html').body.firstChild;\r\n                            self.track.trackList.appendChild(newLi);\r\n                        });\r\n                    }\r\n                }\r\n\r\n                if (currentSelectedTrackId) {\r\n                    self.setSelectedTrack(self.track.trackList.querySelector('li[data-uid=\"' + currentSelectedTrackId + '\"]'));\r\n                }\r\n\r\n                self.track.trackSearch.disabled = false;\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.chartProgressInit = function () {\r\n        const self = this;\r\n\r\n        if (!window.d3) {\r\n            TC.syncLoadJS(TC.Consts.url.D3C3);\r\n        }\r\n\r\n        const dataDiv = d3.select(\".c3-event-rects,.c3-event-rects-single\").node().getBoundingClientRect();\r\n        self.miDiv = document.createElement('div');\r\n        self.miDiv.classList.add('miDiv');\r\n        self.miDiv.style.width = dataDiv.width + 'px';\r\n        self.miDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miProgressDiv = document.createElement('div');\r\n        self.miProgressDiv.classList.add('miProgressDiv');\r\n        self.miProgressDiv.classList.add(self.CLASS + '-track-elevation-chart-progress');\r\n        self.miProgressDiv.classList.add(TC.Consts.classes.HIDDEN);\r\n        self.miProgressDiv.style.width = '0%';\r\n        self.miProgressDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miProgressTextDiv = document.createElement('div');\r\n        self.miProgressTextDiv.classList.add('miProgressTextDiv');\r\n        self.miProgressTextDiv.classList.add('tc-ctl-geolocation-track-elevation-chart-progress');\r\n        self.miProgressTextDiv.classList.add('text');\r\n        self.miProgressTextDiv.style.width = dataDiv.width + 'px';\r\n        self.miProgressTextDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miDiv.style.top = dataDiv.top + 'px';\r\n        self.miDiv.style.left = dataDiv.left + 'px';\r\n        self.miDiv.style.bottom = dataDiv.bottom + 'px';\r\n        self.miDiv.style.right = dataDiv.right + 'px';\r\n        self.miDiv.style.position = 'absolute';\r\n        self.miDiv.style.zIndex = 10008;\r\n        self.miDiv.style.display = 'none';\r\n\r\n        self.miProgressDiv.appendChild(self.miProgressTextDiv);\r\n        self.miDiv.appendChild(self.miProgressDiv);\r\n        document.body.appendChild(self.miDiv);\r\n\r\n    };\r\n\r\n    ctlProto.chartProgressClear = function () {\r\n        const self = this;\r\n        if (self.miDiv) {\r\n            self.miDiv.parentElement.removeChild(self.miDiv);\r\n            self.miDiv = null;\r\n            self.miProgressDiv = null;\r\n            self.miProgressTextDiv = null;\r\n        }\r\n    };\r\n\r\n    ctlProto.chartSetProgress = function (previous, current, distance, doneTime) {\r\n        var self = this;\r\n\r\n        if (self.miDiv) {\r\n            if (self.miDiv.style.display === 'none') {\r\n                self.miDiv.style.display = '';\r\n            }\r\n\r\n            self.miProgressDiv.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n            var done = previous.d;\r\n            var progress = (done + Math.hypot(previous.p[0] - current[0], previous.p[1] - current[1])) / distance * 100;\r\n\r\n            self.miProgressDiv.style.width = progress + '%';\r\n\r\n            var locale = self.map.options.locale && self.map.options.locale.replace('_', '-') || undefined;\r\n            var ele = parseInt(current[2].toFixed(0)).toLocaleString(locale);\r\n            var dist;\r\n            var measure;\r\n            if ((done / 1000) < 1) {\r\n                dist = Math.round((done / 1000) * 1000);\r\n                measure = ' m';\r\n            } else {\r\n                dist = Math.round((done / 1000) * 100) / 100;\r\n                measure = ' km';\r\n            }\r\n\r\n            dist = dist.toLocaleString(locale);\r\n\r\n            self.miProgressTextDiv.innerHTML = '<div><span>' + ele + ' m' + '</span>' + '<br>' + '<span>' + dist + measure + '</span></div>' + (doneTime ? '<br><span>' + doneTime.toString + '</span>' : '');\r\n        }\r\n    };\r\n\r\n    ctlProto._getTime = function (timeFrom, timeTo) {\r\n        var diff = timeTo - timeFrom;\r\n        var d = {};\r\n        var daysDifference = Math.floor(diff / 1000 / 60 / 60 / 24);\r\n        diff -= daysDifference * 1000 * 60 * 60 * 24;\r\n\r\n        var hoursDifference = Math.floor(diff / 1000 / 60 / 60);\r\n        diff -= hoursDifference * 1000 * 60 * 60;\r\n\r\n        d.h = hoursDifference + (daysDifference * 24);\r\n\r\n        var minutesDifference = Math.floor(diff / 1000 / 60);\r\n        diff -= minutesDifference * 1000 * 60;\r\n\r\n        d.m = minutesDifference;\r\n\r\n        d.s = Math.floor(diff / 1000);\r\n\r\n        return $.extend({}, d, { toString: (\"00000\" + d.h).slice(-2) + ':' + (\"00000\" + d.m).slice(-2) + ':' + (\"00000\" + d.s).slice(-2) });\r\n    };\r\n\r\n    ctlProto.simulateTrack = function (li) {\r\n        var self = this;\r\n\r\n        self.simulate_speed = 1;\r\n\r\n        self.drawTrack(li, false).then(function () {\r\n            self.wrap.simulateTrack();\r\n        });\r\n    };\r\n\r\n    ctlProto.drawTrack = function (li, activateSnapping) {\r\n        var self = this;\r\n\r\n        duringTrackingToolsPanel.call(self);\r\n        return new Promise(function (resolve, reject) {\r\n            self.setSelectedTrack(li);\r\n            self.drawTrackingData(li).then(function () {\r\n                self.elevationTrack(li);\r\n\r\n                self.activate();\r\n                resolve();\r\n            });\r\n        });\r\n    };\r\n\r\n\r\n    ctlProto.elevationTrack = function (li, resized) {\r\n        var self = this;\r\n\r\n        if (resized) {            \r\n\r\n            self.wrap.simulateTrackEnd();\r\n            self.uiSimulate(false, li);\r\n            return;\r\n        }\r\n\r\n        if (!self.onResize) {\r\n            self.onResize = self.elevationTrack.bind(self, li, true);\r\n            window.addEventListener(\"resize\", self.onResize, false);\r\n        }\r\n\r\n        self.chart = {\r\n            coordinates: []\r\n        };\r\n\r\n        if (self.track.elevationChart)\r\n            self.track.elevationChart = self.track.elevationChart.destroy();\r\n\r\n        var getChartData = function (li) {\r\n            return new Promise(function (resolve, reject) {\r\n                TC.loadJS(\r\n                    !TC.tool || !TC.tool.Elevation,\r\n                    TC.apiLocation + 'TC/tool/Elevation',\r\n                    function () {\r\n                        self.getTrackingData(li).then(function (track) {\r\n                            var geoJSON = track.data;\r\n                            if (geoJSON) {\r\n                                var x, ele; x = []; ele = [];\r\n                                var empty = true;\r\n                                var minEle, maxEle;\r\n                                var elevationGain = {};\r\n                                var time = {};\r\n                                var km = 0;\r\n                                var geom;\r\n\r\n                                var f = (new ol.format.GeoJSON()).readFeatures(geoJSON);\r\n\r\n                                var getDistance = function () {\r\n                                    if (geom.getLayout() == ol.geom.GeometryLayout.XYZ ||\r\n                                        geom.getLayout() == ol.geom.GeometryLayout.XYZM) {\r\n                                        var distance = 0;\r\n                                        if (self.map.crs !== self.map.options.utmCrs) {\r\n                                            line = new ol.geom.LineString(TC.Util.reproject(geom.getCoordinates(), self.map.crs, self.map.options.utmCrs));\r\n                                            distance = line.getLength();\r\n                                        } else {\r\n                                            distance = geom.getLength();\r\n                                        }\r\n                                        return parseFloat((distance / 1000).toFixed(2));\r\n                                    }\r\n\r\n                                    return null;\r\n                                };\r\n                                var getTime = function () {\r\n                                    if (geom.getLayout() == ol.geom.GeometryLayout.XYZM ||\r\n                                        geom.getLayout() == ol.geom.GeometryLayout.XYM) {\r\n                                        var diff = geom.getLastCoordinate()[3] - geom.getFirstCoordinate()[3];\r\n                                        return {\r\n                                            s: Math.floor((diff / 1000) % 60),\r\n                                            m: Math.floor(((diff / (1000 * 60)) % 60)),\r\n                                            h: Math.floor(((diff / (1000 * 60 * 60)) % 24))\r\n                                        };\r\n                                    }\r\n\r\n                                    return null;\r\n                                };\r\n\r\n                                var addX = function (x) {\r\n                                    if (self.chart.coordinates.length > 0) {\r\n                                        var distance = 0;\r\n                                        self.chart.coordinates\r\n                                            .forEach(function (point, idx, arr) {\r\n                                                var prev = idx === 0 ? point : arr[idx - 1];\r\n\r\n                                                if (self.map.crs !== self.map.options.utmCrs) {\r\n                                                    point = TC.Util.reproject(point, self.map.crs, self.map.options.utmCrs);\r\n                                                    prev = TC.Util.reproject(prev, self.map.crs, self.map.options.utmCrs);\r\n                                                }\r\n\r\n                                                const dx = point[0] - prev[0];\r\n                                                const dy = point[1] - prev[1];\r\n                                                distance += Math.sqrt(dx * dx + dy * dy);\r\n\r\n                                                x.push(parseFloat(distance.toFixed(2)));\r\n                                            });\r\n                                    }\r\n                                };\r\n\r\n                                var addElevation = function (ele) {\r\n                                    var y = [];\r\n                                    for (var i = 0; i < self.chart.coordinates.length; i++) {\r\n                                        if (self.chart.coordinates[i].length > 2) {\r\n                                            var v = (Math.round(self.chart.coordinates[i][2] * 10) / 10);\r\n                                            if (empty && v > 0)\r\n                                                empty = false;\r\n\r\n                                            ele.push(v);\r\n\r\n                                            if (i == 0)\r\n                                                minEle = maxEle = v;\r\n\r\n                                            minEle = Math.min(minEle, v);\r\n                                            maxEle = Math.max(maxEle, v);\r\n\r\n                                        }\r\n                                        else {\r\n                                            resolve(null);\r\n                                            return;\r\n                                        }\r\n                                    }\r\n                                };\r\n\r\n                                f.filter(function (feature) {\r\n                                    return feature.getGeometry().getType().toLowerCase() === 'linestring' || feature.getGeometry().getType().toLowerCase() === 'multilinestring';\r\n                                }).forEach(function (feature) {\r\n                                    geom = feature.getGeometry();\r\n\r\n                                    switch (geom.getType().toLowerCase()) {\r\n                                        case 'linestring':\r\n\r\n                                            if (track.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                track.layout === ol.geom.GeometryLayout.XYZ) {\r\n\r\n                                                time = getTime(geom);\r\n                                                km = getDistance(geom);\r\n                                                elevationGain = TC.tool.Elevation.getElevationGain({ coords: geom.getCoordinates(), hillDeltaThreshold: self.gapHill });\r\n                                                self.chart.coordinates = self.chart.coordinates.concat(geom.getCoordinates());\r\n\r\n                                                addX(x);\r\n                                                addElevation(ele);\r\n                                            }\r\n                                            break;\r\n                                        case 'multilinestring':\r\n\r\n                                            if (track.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                track.layout === ol.geom.GeometryLayout.XYZ) {\r\n\r\n                                                var _time;\r\n                                                var ls = geom.getLineStrings();\r\n                                                for (var i = 0; i < ls.length; i++) {\r\n                                                    km = km + getDistance(ls[i]);\r\n\r\n                                                    if (ls[i].getLayout() == ol.geom.GeometryLayout.XYZM)\r\n                                                        _time = _time + (ls[i].getLastCoordinate()[3] - ls[i].getFirstCoordinate()[3]);\r\n\r\n                                                    self.chart.coordinates = self.chart.coordinates.concat(ls[i].getCoordinates());\r\n\r\n                                                    if (_time) { time = getTime(_time); }\r\n\r\n                                                    addX(x);\r\n                                                    addElevation(ele);\r\n                                                }\r\n                                            }\r\n\r\n                                            break;\r\n                                        default:\r\n                                            return null;\r\n                                            break;\r\n                                    }\r\n                                });\r\n\r\n                                if (ele instanceof Array && ele.length == 0) {\r\n                                    empty = true;\r\n                                }\r\n\r\n                                self.chartData = !empty ? $.extend({}, { time: time, ele: ele, x: x, miny: minEle, maxy: maxEle }, elevationGain) : null;\r\n\r\n                                resolve(self.chartData);\r\n                                return;\r\n                            }\r\n\r\n                            resolve(null);\r\n                            return;\r\n                        });\r\n                    }\r\n                );\r\n            });\r\n        };\r\n\r\n        getChartData(li).then(function (data) {\r\n            var locale = TC.Util.getMapLocale(self.map);\r\n            if (data != null) {\r\n                if (data.time) data.time = (\"00000\" + data.time.h).slice(-2) + ':' + (\"00000\" + data.time.m).slice(-2) + ':' + (\"00000\" + data.time.s).slice(-2);\r\n                data.coords = self.chart.coordinates;\r\n                self.hasElevation = true;\r\n            }\r\n            else {\r\n                self.hasElevation = false;\r\n                data = {\r\n                    msg: self.getLocaleString(\"geo.trk.chart.chpe.empty\")\r\n                };\r\n            }\r\n\r\n            data.minHeight = self.CHART_SIZE.MIN_HEIGHT;\r\n            data.maxHeight = self.CHART_SIZE.MAX_HEIGHT;\r\n\r\n            data.minWidth = self.CHART_SIZE.MIN_WIDTH;\r\n            data.mediumWidth = self.CHART_SIZE.MEDIUM_WIDTH;\r\n            data.maxWidth = self.CHART_SIZE.MAX_WIDTH;\r\n\r\n            self.map.one(TC.Consts.event.DRAWCHART, function (e) {\r\n                self.chartProgressInit();\r\n            });\r\n\r\n            if (!self.resultsPanelChart) {\r\n\r\n                if (!window.c3) {\r\n                    TC.syncLoadJS(TC.Consts.url.D3C3 || TC.apiLocation + 'lib/d3c3/d3c3.min.js');\r\n                }\r\n\r\n                var resultsPanelOptions = {\r\n                    content: \"chart\",\r\n                    titles: {\r\n                        main: self.getLocaleString(\"geo.trk.chart.chpe\"),\r\n                        max: self.getLocaleString(\"geo.trk.chart.chpe\")\r\n                    },\r\n                    openOn: self.Const.Event.DRAWTRACK,\r\n                    closeOn: self.Const.Event.CLEARTRACK,\r\n                    chart: {\r\n                        ctx: self,\r\n                        onmouseout: ctlProto.removeElevationTooltip,\r\n                        tooltip: ctlProto.getElevationTooltip\r\n                    }\r\n                };\r\n\r\n                var ctlPromise;\r\n                const addResultsPanelChart = function (controlContainer) {\r\n                    resultsPanelOptions.side = controlContainer.SIDE.RIGHT;\r\n                    ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                };\r\n\r\n                if (self.options.displayOn) {\r\n                    var controlContainer = self.map.getControlsByClass('TC.control.' + self.options.displayOn[0].toUpperCase() + self.options.displayOn.substring(1))[0];\r\n                    if (!controlContainer) {\r\n                        self.map.addControl(self.options.displayOn).then(addResultsPanelChart);\r\n                    } else {\r\n                        addResultsPanelChart(controlContainer);\r\n                    }\r\n                } else {\r\n                    resultsPanelOptions.div = document.createElement('div');\r\n                    self.map.div.appendChild(resultsPanelOptions.div);\r\n                    ctlPromise = self.map.addControl('resultsPanel', resultsPanelOptions);\r\n                }\r\n\r\n                ctlPromise.then(function (resultsPanelChart) {\r\n                    resultsPanelChart.caller = self;\r\n                    self.resultsPanelChart = resultsPanelChart;\r\n                    resultsPanelChart.renderPromise().then(function () {\r\n\r\n                        resultsPanelChart.activateSnapping = function (e) {\r\n                            if (self.layerTrack && (!self.layerTrack.getVisibility() && self.layerTrack.getOpacity() == 0))\r\n                                self.wrap.deactivateSnapping.call(self.wrap);\r\n                        };\r\n                        resultsPanelChart.deactivateSnapping = function (e) {\r\n                            if (self.layerTrack && self.layerTrack.getVisibility() && self.layerTrack.getOpacity() > 0)\r\n                                self.wrap.activateSnapping.call(self.wrap);\r\n                        };\r\n\r\n                        resultsPanelChart.div.addEventListener('mouseover', resultsPanelChart.deactivateSnapping);\r\n                        resultsPanelChart.div.addEventListener('mouseout', resultsPanelChart.activateSnapping);\r\n\r\n                        self.map\r\n                            .on(TC.Consts.event.RESULTSPANELMIN, function () {\r\n                                if (self.miDiv) {\r\n                                    self.miDiv.style.display = 'none';\r\n                                }\r\n                            })\r\n                            .on(TC.Consts.event.RESULTSPANELMAX, function () {\r\n                                if (self.miDiv) {\r\n                                    self.miDiv.style.display = '';\r\n                                }\r\n                            })\r\n                            .on(TC.Consts.event.RESULTSPANELCLOSE, function () {\r\n                                if (self.miDiv) {\r\n                                    self.miDiv.style.display = 'none';\r\n                                }\r\n                            });\r\n\r\n                        self.map.trigger(self.Const.Event.DRAWTRACK, { data: data });\r\n                    });\r\n                });\r\n            } else {\r\n                self.resultsPanelChart.open();\r\n                self.map.trigger(self.Const.Event.DRAWTRACK, { data: data });\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.clear = function (layerType) {\r\n        var self = this;\r\n\r\n        if (self.onResize) {\r\n            window.removeEventListener(\"resize\", self.onResize, false);\r\n            self.onResize = undefined;\r\n        }\r\n\r\n        if (layerType == self.Const.Layers.TRACK) {\r\n\r\n            self.layerTrack.clearFeatures();\r\n\r\n            // gráfico perfil de elevación\r\n            if (self.resultsPanelChart)\r\n                self.resultsPanelChart.close();\r\n            delete self.chartData;\r\n\r\n            // overlay de la simulación\r\n            self.wrap.simulateTrackEnd();\r\n\r\n            self.wrap.clear();\r\n\r\n            // eliminamos la selección en la lista de tracks\r\n            self.track.trackList.querySelectorAll('li').forEach(function (li) {\r\n                li.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n            });\r\n\r\n            self.map.trigger(self.Const.Event.CLEARTRACK);\r\n\r\n            self.featuresToShare = [];\r\n\r\n            //TC.Control.prototype.deactivate.call(self);\r\n\r\n        } else {\r\n            self.layerTracking.clearFeatures();\r\n            self.layerGPS.clearFeatures();\r\n        }\r\n    };\r\n\r\n    ctlProto.saveTrack = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            var message = options.message || self.getLocaleString(\"geo.trk.save.alert\");\r\n\r\n            var _save = function (layer) {\r\n                var wait;\r\n                wait = self.getLoadingIndicator().addWait();\r\n\r\n                var trackName = options.importedFileName || self.track.trackName.value.trim();\r\n\r\n                var tracks = self.availableTracks;\r\n                if (!tracks) {\r\n                    tracks = [];\r\n                }\r\n\r\n                var formatted = self.wrap.formattedToStorage(layer, true, options.notReproject);\r\n\r\n                var clean = function (wait) {\r\n                    self.track.trackName.value = '';\r\n                    self.track.trackName.disabled = true;\r\n                    self.track.trackSave.disabled = true;\r\n\r\n                    self.track.trackWPT.value = '';\r\n                    self.track.trackWPT.disabled = true;\r\n                    self.track.trackAdd.disabled = true;\r\n\r\n                    self.getLoadingIndicator().removeWait(wait);\r\n\r\n                    duringTrackingToolsPanel.call(self);\r\n                };\r\n\r\n                var newTrack = {\r\n                    name: trackName,\r\n                    data: formatted.features,\r\n                    layout: formatted.layout,\r\n                    crs: self.storageCRS\r\n                };\r\n\r\n                TC.loadJS(\r\n                    !window.hex_md5,\r\n                    [TC.apiLocation + TC.Consts.url.HASH],\r\n                    function () {\r\n                        var hash = hex_md5(JSON.stringify(newTrack));\r\n\r\n                        var sameTrackUID = tracks.map(function (savedTrack) {\r\n                            var clonedTrack = JSON.parse(JSON.stringify(savedTrack));\r\n                            delete clonedTrack.uid;\r\n                            if (hash === hex_md5(JSON.stringify(clonedTrack))) {\r\n                                return savedTrack.uid;\r\n                            } else {\r\n                                const jsonFormat = new ol.format.GeoJSON();\r\n                                // validamos si se trata de un track exportado/importado ya que se compacta la geometría\r\n                                var features = jsonFormat.readFeatures(clonedTrack.data);\r\n                                // Aplicamos una precisión un dígito mayor que la del mapa, si no, al compartir algunas parcelas se deforman demasiado\r\n                                var precision = Math.pow(10, TC.Consts.DEGREE_PRECISION + 1);\r\n\r\n                                features.forEach(function (feature) {\r\n                                    var geom = TC.Util.explodeGeometry(TC.Util.compactGeometry(feature.getGeometry().getCoordinates(), precision));\r\n                                    feature.getGeometry().setCoordinates(geom);\r\n                                });\r\n\r\n                                clonedTrack.data = jsonFormat.writeFeatures(features);\r\n\r\n                                if (hash === hex_md5(JSON.stringify(clonedTrack))) {\r\n                                    return savedTrack.uid;\r\n                                } else {\r\n                                    return null;\r\n                                }\r\n                            }\r\n\r\n                        }).filter(function (uid) {\r\n                            return uid !== null\r\n                        });\r\n\r\n                        const getTrackIndex = function (uid) {\r\n                            return self.getStoredTracks().then(function () {\r\n                                self.bindTracks();\r\n\r\n                                var index;\r\n                                for (var i = 0; i < self.availableTracks.length; i++) {\r\n                                    if (self.availableTracks[i].uid === uid) {\r\n                                        index = i;\r\n                                        break;\r\n                                    }\r\n                                }\r\n\r\n                                return index;\r\n                            });\r\n                        };\r\n\r\n                        if (sameTrackUID.length === 0) {\r\n\r\n                            newTrack.uid = Date.now() + Math.random();\r\n                            tracks.push(newTrack);\r\n                            tracks = _orderTracks(tracks);\r\n\r\n                            try {\r\n                                self.setStoredTracks(tracks).then(function () {\r\n                                    self.map.toast(message, { duration: 3000 });\r\n\r\n                                    clean(wait);\r\n\r\n                                    getTrackIndex(newTrack.uid).then(function (index) {\r\n                                        resolve(index);\r\n                                    });\r\n                                });\r\n\r\n                            } catch (error) {\r\n                                TC.alert(self.getLocaleString(\"geo.error.savelocalstorage\") + ': ' + error.message);\r\n                                clean(wait);\r\n                                reject();\r\n                            }\r\n                        } else {\r\n                            console.log('Ya existe un track con ese mismo hash');\r\n\r\n                            clean(wait);\r\n\r\n                            getTrackIndex(sameTrackUID[0]).then(function (index) {\r\n                                resolve(index);\r\n                            });\r\n                        }\r\n                    });\r\n\r\n            };\r\n\r\n            const createTCFeatures = function (features) {\r\n                return new Promise(function (resolve, reject) {\r\n                    var featurePromises = features.filter(function (feature) {\r\n                        return !feature._wrap;\r\n                    }).forEach(function (elm) {\r\n                        return TC.wrap.Feature.createFeature(elm);\r\n                    });\r\n\r\n                    Promise.all(featurePromises).then(function (tcFeatures) {\r\n                        resolve();\r\n                    });\r\n                });\r\n            };\r\n\r\n            if (self.importedFileName)\r\n                _save(self.layerTrack);\r\n            else if (self.track.trackName.value.trim().length == 0) {\r\n                self.track.trackName.value = new Date().toLocaleString();\r\n                _save(self.layerTracking);\r\n            }\r\n            else {\r\n                _save(self.layerTracking);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.addWaypoint = function () {\r\n        var self = this;\r\n\r\n        var waypointName = self.track.trackWPT.value.trim();\r\n        if (!waypointName) {\r\n            waypointName = new Date().toLocaleString();\r\n        }\r\n\r\n        var wait = self.getLoadingIndicator().addWait();\r\n\r\n        duringTrackingToolsPanel.call(self);\r\n\r\n        self.wrap.addWaypoint(self.currentPoint.position, {\r\n            name: waypointName,\r\n            ele: self.currentPoint.heading,\r\n            time: new Date().getTime() // GLS: lo quito ya que hemos actualizado la función que gestiona la fechas para la exportación a GPX - espera la fecha en segundos -> / 1000 // para la exportación a GPX - espera la fecha en segundos\r\n        });\r\n\r\n        self.track.trackWPT.value = '';\r\n        self.track.trackWPT.disabled = true;\r\n        self.track.trackAdd.disabled = true;\r\n\r\n        // cada vez que se añade un waypoint almacenamos en sessionStorage\r\n        TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, self.wrap.formattedToStorage(self.layerTracking).features);\r\n\r\n        self.getLoadingIndicator().removeWait(wait);\r\n    };\r\n\r\n    ctlProto.editTrackName = function (trackId, newName) {\r\n        var self = this;\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n            if (tracks) {\r\n                if (tracks[trackId]) {\r\n                    tracks[trackId].name = newName;\r\n\r\n                    self.setStoredTracks(tracks);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.removeTrack = function (li) {\r\n        var self = this;\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n            if (tracks) {\r\n                var dataId = li.dataset.id;\r\n                if (tracks[dataId]) {\r\n                    var uid = tracks[dataId].uid;\r\n\r\n                    TC.confirm(self.getLocaleString(\"geo.trk.delete.alert\"), function () {\r\n\r\n                        const selectedTrack = self.getSelectedTrack();\r\n                        if (selectedTrack && selectedTrack.dataset.id === dataId) {\r\n                            self.clear(self.Const.Layers.TRACK);\r\n                        }\r\n\r\n                        localforage.removeItem(self.Const.LocalStorageKey.TRACKING + '#' + uid).then(function () {\r\n                            self.getStoredTracks().then(function () {\r\n                                self.bindTracks();\r\n                            });\r\n                        }).catch(function (err) {\r\n                            console.log(err);\r\n                        });\r\n\r\n                    }, function () { });\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.setSelectedTrack = function (li) {\r\n        var self = this;\r\n\r\n        if (!self.isActive) {\r\n            self.activate();\r\n        }\r\n\r\n        self.track.trackList.querySelectorAll('li[data-id] > span').forEach(function (span) {\r\n            span.setAttribute('title', span.textContent);\r\n        });\r\n        self.track.trackList.querySelectorAll('li').forEach(function (li) {\r\n            li.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n        });\r\n\r\n        li.classList.add(self.Const.Classes.SELECTEDTRACK);\r\n\r\n        li.setAttribute('title', self.getLocaleString(\"tr.lst.clear\") + \" \" + li.querySelector('span').textContent);\r\n        li.querySelector(self.Const.Selector.DRAW).setAttribute('title', li.getAttribute('title'));\r\n    };\r\n\r\n    ctlProto.getSelectedTrack = function () {\r\n        var self = this;\r\n\r\n        return self.track.trackList.querySelector('li.' + self.Const.Classes.SELECTEDTRACK);\r\n    };\r\n\r\n    ctlProto.clearSelectedTrack = function () {\r\n        const self = this;\r\n\r\n        const selected = self.getSelectedTrack();\r\n        if (selected) {\r\n\r\n            if (self.onResize) {\r\n                window.removeEventListener('resize', self.onResize, false);\r\n                self.onResize = undefined;\r\n            }\r\n\r\n            selected.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n            selected.setAttribute('title', selected.textContent);\r\n            selected.querySelector(self.Const.Selector.DRAW).setAttribute('title', selected.getAttribute('title'));\r\n        }\r\n    };\r\n\r\n    ctlProto.clearSelection = function () {\r\n        var self = this;\r\n\r\n        self.wrap.deactivateSnapping();\r\n        var selected = self.getSelectedTrack();\r\n        if (selected) {\r\n            self.clearSelectedTrack();\r\n        }\r\n        if (self.resultsPanelChart) {\r\n\r\n            self.resultsPanelChart.div.removeEventListener('mouseover', self.resultsPanelChart.deactivateSnapping);\r\n            self.resultsPanelChart.div.removeEventListener('mouseout', self.resultsPanelChart.activateSnapping);\r\n\r\n            self.resultsPanelChart.close();\r\n        }\r\n\r\n        self.clear(self.Const.Layers.TRACK);\r\n    };\r\n\r\n    ctlProto.drawTrackingData = function (li) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            self.wrap.clear();\r\n\r\n            self.getTrackingData(li).then(function (track) {\r\n                var data = track.data;\r\n                if (track.data)\r\n                    self.wrap.drawTrackingData(track).then(function () {\r\n                        var showFeatures = self.layerTrack.features;\r\n                        if (showFeatures && showFeatures.length > 0) {\r\n\r\n                            var coordinates = showFeatures.filter(function (feature) {\r\n                                feature.showsPopup = false;\r\n                                if (TC.feature.MultiPolyline && feature instanceof TC.feature.MultiPolyline) {\r\n                                    return true;\r\n                                } else if (feature instanceof TC.feature.Polyline) {\r\n                                    return true;\r\n                                }\r\n                                return false;\r\n                            }).map(function (feature) {\r\n                                if (TC.feature.MultiPolyline && feature instanceof TC.feature.MultiPolyline) {\r\n                                    return feature.geometry[0];\r\n                                } else if (feature instanceof TC.feature.Polyline) {\r\n                                    return feature.geometry;\r\n                                }\r\n                            })[0];\r\n\r\n                            if (coordinates) {\r\n                                var first = coordinates[0];\r\n                                var last = coordinates[coordinates.length - 1];\r\n\r\n                                if (first && !(first === last)) {\r\n                                    self.layerTrack.addMarker(first.slice().splice(0, 2), {\r\n                                        showsPopup: false, cssClass: self.CLASS + '-track-marker-icon-end', anchor: [0.5, 1], notExport: true\r\n                                    });\r\n                                }\r\n\r\n                                if (last) {\r\n                                    self.layerTrack.addMarker(last.slice().splice(0, 2), {\r\n                                        showsPopup: false, cssClass: self.CLASS + '-track-marker-icon', anchor: [0.5, 1], notExport: true\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                        self.layerTrack.setVisibility(true);\r\n                        resolve();\r\n                    });\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.getTrackingData = function (li) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            self.getAvailableTracks().then(function (tracks) {\r\n                if (tracks) {\r\n                    const dataId = li.dataset.id;\r\n                    if (tracks[dataId]) {\r\n                        var track = tracks[dataId].data;\r\n\r\n                        // GLS: tengo que transformar de 4326 al crs del mapa en el momento de pintar, porque si lo hacemos al cargar la lista\r\n                        // y después hay cambio de crs, en el momento de pintar no sé desde qué crs debo tranformar\r\n                        track = self.wrap.formattedFromStorage(track);\r\n\r\n                        resolve({ data: track, layout: tracks[dataId].layout });\r\n                    }\r\n                } else {\r\n                    resolve();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.export = function (type, li) {\r\n        var self = this;\r\n\r\n        return self.wrap.export(type, li);\r\n    };\r\n\r\n    ctlProto.getElevationTooltip = function (d) {\r\n        const self = this;\r\n        self.wrap.showElevationMarker(d);\r\n\r\n        return self.resultsPanelChart.getElevationChartTooltip(d);\r\n    };\r\n\r\n    ctlProto.removeElevationTooltip = function () {\r\n        var self = this;\r\n        self.wrap.hideElevationMarker();\r\n    }\r\n\r\n    ctlProto.clearFileInput = function (fileInput) {\r\n        const form = document.createElement('form');\r\n        const parent = fileInput.parentElement;\r\n        parent.insertBefore(form, fileInput);\r\n        form.appendChild(fileInput);\r\n        form.reset();\r\n        // Desenvolvemos el input del form\r\n        form.insertAdjacentElement('afterend', fileInput);\r\n        parent.removeChild(form);\r\n    };\r\n\r\n    ctlProto.getLoadingIndicator = function () {\r\n        var self = this;\r\n\r\n        if (!self.loading) {\r\n            self.loading = self.map.getControlsByClass(TC.control.LoadingIndicator);\r\n            if (self.loading && self.loading.length > 0)\r\n                self.loading = self.loading[0];\r\n        }\r\n\r\n        return self.loading;\r\n    };\r\n\r\n    ctlProto.onGeolocateError = function (error) {\r\n        var self = this;\r\n\r\n        if (navigator.geolocation) {\r\n            if (self.currentPosition)\r\n                navigator.geolocation.clearWatch(self.currentPosition);\r\n            if (self.currentPositionTrk) {\r\n                self.currentPositionTrk = self.currentPositionTrk instanceof Array ? self.currentPositionTrk : [self.currentPositionTrk];\r\n\r\n                self.currentPositionTrk.forEach(function (watch) {\r\n                    navigator.geolocation.clearWatch(watch);\r\n                });\r\n\r\n                self.currentPositionTrk = [];\r\n            }\r\n        }\r\n\r\n        if (self.currentPositionWaiting)\r\n            self.getLoadingIndicator().removeWait(self.currentPositionWaiting);\r\n\r\n        var errorMsg;\r\n        switch (error.code) {\r\n            case error.PERMISSION_DENIED:\r\n                errorMsg = self.getLocaleString(\"geo.error.permission_denied\");\r\n                break;\r\n            case error.POSITION_UNAVAILABLE:\r\n                errorMsg = self.getLocaleString(\"geo.error.position_unavailable\");\r\n                break;\r\n            case error.TIMEOUT:\r\n                errorMsg = self.getLocaleString(\"geo.error.timeout\");\r\n                break;\r\n            default:\r\n                errorMsg = self.getLocaleString(\"geo.error.default\");\r\n                break;\r\n        }\r\n\r\n        self.map.toast(errorMsg, { type: TC.Consts.msgType.WARNING });\r\n\r\n        if (!self.geopositionTracking && self.track) {\r\n            self.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n            self.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n    var _isEmpty = function (obj) {\r\n        return !obj || obj.length === 0;\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState) {\r\n            const state = {};\r\n            if (self.layerTrack) {\r\n                var features = self.layerTrack.features;\r\n\r\n                if (features.length > 0 && self.featuresToShare && self.featuresToShare.length > 0) {\r\n                    state.features = self.featuresToShare;\r\n                } else {\r\n                    const layerState = self.layerTrack.exportState({\r\n                        features: features\r\n                    });\r\n\r\n                    state.features = layerState.features;\r\n                }\r\n\r\n                state.id = self.id;\r\n                const selectedTrack = self.getSelectedTrack();\r\n                if (selectedTrack) {\r\n                    state.trackName = selectedTrack.querySelector('span').innerHTML;\r\n                }\r\n                return state;\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        if (self.map) {\r\n            if (state.features && state.features.length) {\r\n                self.enable();\r\n\r\n                if (state.features.length > 0) {\r\n                    const promises = new Array(state.features.length);\r\n                    state.features.forEach(function (f, idx) {\r\n                        const featureOptions = { data: f.data, id: f.id, showsPopup: f.showsPopup };\r\n                        var addFn;\r\n                        var geom = TC.Util.explodeGeometry(f.geom);\r\n                        switch (f.type) {\r\n                            case TC.Consts.geom.POLYLINE:\r\n                                promises[idx] = new TC.feature.Polyline(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.MULTIPOLYLINE:\r\n                                promises[idx] = new TC.feature.MultiPolyline(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.MARKER:\r\n                                promises[idx] = new TC.feature.Marker(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.POINT:\r\n                                promises[idx] = new TC.feature.Point(geom, featureOptions);\r\n                                break;\r\n                        }\r\n                    });\r\n\r\n                    Promise.all(promises).then(function (tcFeatures) {\r\n                        var options = { features: tcFeatures, fileName: state.trackName, notReproject: true, isShared: true };\r\n                        if (!self.availableTracks) {\r\n                            self.getStoredTracks().then(function () {\r\n                                self.importTrack(options);\r\n                            });\r\n                        } else {\r\n                            self.importTrack(options);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n})();"],"file":"../../control/Geolocation.min.js"}