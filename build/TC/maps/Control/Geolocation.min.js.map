{"version":3,"sources":["control/Geolocation.js"],"names":["Math","hypot","y","length","arguments","i","Infinity","sqrt","lastTime","vendors","hasPerformance","window","performance","now","x","max","requestAnimationFrame","cancelAnimationFrame","callback","element","currTime","Date","getTime","timeToCall","id","setTimeout","clearTimeout","rAF","startTime","timestamp","offset","this","TC","control","Control","syncLoadJS","apiLocation","Geolocation","options","_classSelector","CLASS","_layerPromises","Const","Classes","ACTIVE","CLOSED","SELECTEDTRACK","DRAWACTIVATED","SIMULATIONACTIVATED","Selector","SIMULATE","DRAW","EDIT","DELETE","SAVE","CANCEL","EXPORT_GPX","EXPORT_KML","STOP","PAUSE","BACKWARD","FORWARD","SPEED","LocalStorageKey","TRACKING","TRACKINGTEMP","TRACKINGSHOWADVERTISEMENT","GPSSHOWADVERTISEMENT","TEST","Message","VALIDATENAME","Event","POSITIONCHANGE","GPSPOSITIONCHANGE","GPSPOSITIONERROR","STATEUPDATED","GPSADD","TRACKSNAPPING","DRAWTRACK","CLEARTRACK","IMPORTEDTRACK","MimeMap","KML","GPX","SupportedFileExtensions","Tabs","GPS","Layers","TRACK","apply","opts","_dialogDiv","Util","getDiv","dialogDiv","$","_$dialogDiv","document","body","appendChild","delta","walkingSpeed","gapHill","snappingTolerance","exportsState","storageCRS","inherit","ctlProto","prototype","CHART_SIZE","MIN_HEIGHT","MAX_HEIGHT","MIN_WIDTH","MEDIUM_WIDTH","MAX_WIDTH","featuresToShare","Consts","event","TOOLSCLOSE","TOOLSOPEN","template","isDebug","dust","register","body_0","chk","ctx","w","h","$key","__dustBody","f","get","block","body_1","else","body_2","body_3","body_4","body_5","body_6","body_8","body_7","key","value","body_10","body_9","map","self","result","call","wrap","addLayer","getUID","type","layerType","VECTOR","stealth","title","then","layer","layerGPS","styles","point","radius","fillColor","fillOpacity","track","renderTrack","checked","bind","strokeColor","fontColor","labelOutlineColor","labelOutlineWidth","label","feature","name","getData","trim","toLowerCase","line","strokeOpacity","strokeWidth","lineDash","layerTracking","fontSize","layerTrack","on","FEATURESIMPORT","e","fileName","target","dropTarget","kmlPattern","format","gpxPattern","indexOf","clear","importTrack","test","features","forEach","Point","setStyle","Polyline","render","getRenderedHtml","html","innerHTML","isDisabled","toast","getLocaleString","msgType","WARNING","wait","getLoadingIndicator","addWait","importedFileName","addPromises","len","push","addFeature","Promise","all","processImportedFeatures","notReproject","layout","accordion","div","classList","contains","classes","COLLAPSED","controls","filter","ctl","containerControl","add","remove","querySelector","click","isShared","trigger","prepareFeaturesToShare","trackUid","resolve","reject","storageData","availableTracks","saved","uid","toString","data","precision","pow","DEGREE_PRECISION","storageFeatures","ol","GeoJSON","readFeatures","promises","Array","idx","Feature","createFeature","tcFeatures","fObj","Marker","geom","MARKER","POINT","POLYLINE","MultiPolyline","MULTIPOLYLINE","compactGeometry","geometry","visibilityTrack","renderData","sel","querySelectorAll","span","addEventListener","CLICK","tagName","parentElement","newFormat","option","toggle","HIDDEN","matches","activateButton","deactivateButton","trackSearch","trackImportFile","trackSave","trackAdd","trackContinue","trackRenew","trackClose","trackAdvertisementOK","trackList","trackToolPanelOpened","_showAlerMsg","trackName","trackWPT","detectMobile","matchMedia","File","FileReader","FileList","Blob","disabled","form","createElement","parent","insertBefore","reset","insertAdjacentElement","removeChild","_cleaning","LAYERERROR","_layerError","loadFiles","files","console","log","activateTracking","_activateTrackingBtns","deactivateTracking","_deactivateTrackingBtns","trackSearchListener","searchTerm","lis","from","li","style","display","trackLis","searchIcon","visibility","r","RegExp","textContent","some","_filter","saveTrack","addWaypoint","list","_edit","edit","elm","input","focus","uiSimulate","simulate","editControls","simulateControls","cnt","parentNode","hidden","EventTarget","listenerBySelector","_loadTrack","removeWait","_drawTrack","listElement","index","scrollTop","offsetHeight","_stopOtherTracks","trackLiId","listItem","dataset","btnSimulate","btnPause","setAttribute","btnDraw","trackLi","getSelectedTrack","drawTrack","simulate_paused","simulateTrack","removeTrack","alert","editTrackName","mimeType","cls","replace","toUpperCase","export","filename","regex","join","cleanFilename","downloadFile","simulateTrackEnd","simulate_speed","simulate_pausedElapse","closeModal","_tracking","sessionTracking","storage","setSessionLocalValue","undefined","localforage","removeItem","checkboxes","loadJS","url","LOCALFORAGE","setItem","getAttribute","setVisibility","bindTracks","isFunction","activate","deactivate","clearSelection","off","clearFileInput","duration","markerStyle","lineStyle","setFormatInfoNewPosition","newPosition","locale","getMapLocale","on3DView","geoCoords","crs","view3D","reproject","position","toLocaleString","mdt","round","getHeightFromMDT","isGeo","z","altitude","accuracy","speed","minimumFractionDigits","maximumFractionDigits","renderInfoNewPosition","d","pd","infoPanel","isMinimized","renderPromise","getTableContainer","isVisible","doVisible","ctlPromise","resultsPanelOptions","content","titles","main","collapsed","addResultsPanelInfo","controlContainer","side","SIDE","RIGHT","addControl","displayOn","getControlsByClass","substring","resultsPanelInfo","caller","panel","close","open","_onWindowBlurred","_onWindowFocused","_onWindowVisibility","duringTrackingToolsPanel","currentPoint","formattedToStorage","advertisement","setTracking","onWindowFocused","videoScreenOn","paused","play","fromStorageToSession","onWindowVisibility","prefixes","getHiddenProperty","addWindowEvents","fromSessionToStorage","detectSafari","browserFeatures","touch","navigator","userAgent","match","getSessionLocalValue","JSON","stringify","getItem","showAdvertisement","registeredShowAdvertisement","dialog","checkbox","showModal","_askTracking","closeCallback","trackingAvailable","isActive","error","code","DOMException","QUOTA_EXCEEDED_ERR","media","WebM","MP4","sourceWebM","src","sourceMP4","_deactivateTracking","geopositionTracking","pause","removeEventListener","hasCoordinates","getStoredTracks","tracks","keys","k","exec","res","rej","v","results","parse","concat","tracksArray","_orderTracks","sort","a","b","localeCompare","setStoredTracks","t","getAvailableTracks","_isEmpty","currentSelectedTrack","currentSelectedTrackId","newLi","DOMParser","parseFromString","firstChild","setSelectedTrack","chartProgressInit","d3","D3C3","dataDiv","select","node","getBoundingClientRect","miDiv","width","height","miProgressDiv","miProgressTextDiv","top","left","bottom","right","zIndex","chartProgressClear","chartSetProgress","previous","current","distance","doneTime","done","progress","p","dist","measure","ele","parseInt","toFixed","_getTime","timeFrom","timeTo","diff","daysDifference","floor","hoursDifference","minutesDifference","m","s","extend","slice","activateSnapping","drawTrackingData","elevationTrack","resized","onResize","chart","coordinates","elevationChart","destroy","tool","Elevation","getTrackingData","geoJSON","minEle","maxEle","empty","elevationGain","time","getDistance","getLayout","GeometryLayout","XYZ","XYZM","utmCrs","LineString","getCoordinates","getLength","parseFloat","XYM","getLastCoordinate","getFirstCoordinate","addX","arr","prev","dx","dy","addElevation","min","getGeometry","getType","getElevationGain","coords","hillDeltaThreshold","_time","ls","getLineStrings","chartData","miny","maxy","getChartData","hasElevation","msg","minHeight","maxHeight","minWidth","mediumWidth","maxWidth","one","DRAWCHART","resultsPanelChart","c3","openOn","closeOn","onmouseout","removeElevationTooltip","tooltip","getElevationTooltip","addResultsPanelChart","getVisibility","getOpacity","deactivateSnapping","RESULTSPANELMIN","RESULTSPANELMAX","RESULTSPANELCLOSE","clearFeatures","message","_save","formatted","clean","newTrack","hex_md5","HASH","hash","sameTrackUID","savedTrack","clonedTrack","jsonFormat","explodeGeometry","setCoordinates","writeFeatures","getTrackIndex","random","waypointName","heading","trackId","newName","dataId","confirm","selectedTrack","catch","err","clearSelectedTrack","selected","showFeatures","showsPopup","first","last","addMarker","splice","cssClass","anchor","notExport","formattedFromStorage","showElevationMarker","getElevationChartTooltip","hideElevationMarker","fileInput","loading","LoadingIndicator","onGeolocateError","errorMsg","geolocation","currentPosition","clearWatch","currentPositionTrk","watch","currentPositionWaiting","PERMISSION_DENIED","POSITION_UNAVAILABLE","TIMEOUT","obj","exportState","state","layerState","importState","enable","featureOptions"],"mappings":"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","sourcesContent":["(function () {\r\n    Math.hypot = Math.hypot || function () {\r\n        var y = 0;\r\n        var length = arguments.length;\r\n\r\n        for (var i = 0; i < length; i++) {\r\n            if (arguments[i] === Infinity || arguments[i] === -Infinity) {\r\n                return Infinity;\r\n            }\r\n            y += arguments[i] * arguments[i];\r\n        }\r\n        return Math.sqrt(y);\r\n    };\r\n}());\r\n(function () {\r\n    var lastTime = 0,\r\n        vendors = ['ms', 'moz', 'webkit', 'o'],\r\n        // Feature check for performance (high-resolution timers)\r\n        hasPerformance = !!(window.performance && window.performance.now);\r\n\r\n    for (var x = 0, max = vendors.length; x < max && !window.requestAnimationFrame; x += 1) {\r\n        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];\r\n        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']\r\n            || window[vendors[x] + 'CancelRequestAnimationFrame'];\r\n    }\r\n\r\n    if (!window.requestAnimationFrame) {\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            var currTime = new Date().getTime();\r\n            var timeToCall = Math.max(0, 16 - (currTime - lastTime));\r\n            var id = window.setTimeout(function () { callback(currTime + timeToCall); },\r\n                timeToCall);\r\n            lastTime = currTime + timeToCall;\r\n            return id;\r\n        };\r\n    }\r\n\r\n    if (!window.cancelAnimationFrame) {\r\n        window.cancelAnimationFrame = function (id) {\r\n            clearTimeout(id);\r\n        };\r\n    }\r\n\r\n    // Add new wrapper for browsers that don't have performance\r\n    if (!hasPerformance) {\r\n        // Store reference to existing rAF and initial startTime\r\n        var rAF = window.requestAnimationFrame,\r\n            startTime = +new Date;\r\n\r\n        // Override window rAF to include wrapped callback\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            // Wrap the given callback to pass in performance timestamp\r\n            var wrapped = function (timestamp) {\r\n                // Get performance-style timestamp\r\n                var performanceTimestamp = (timestamp < 1e12) ? timestamp : timestamp - startTime;\r\n\r\n                return callback(performanceTimestamp);\r\n            };\r\n\r\n            // Call original rAF with wrapped callback\r\n            rAF(wrapped, element);\r\n        }\r\n    }\r\n})();\r\n(function () {\r\n    // Polyfill window.performance.now\r\n    if (!window.performance) {\r\n        window.performance = {\r\n            offset: Date.now(),\r\n            now: function () {\r\n                return Date.now() - this.offset;\r\n            }\r\n        };\r\n    } else if (window.performance && !window.performance.now) {\r\n        window.performance.offset = Date.now();\r\n        window.performance.now = function () {\r\n            return Date.now() - window.performance.offset;\r\n        };\r\n    }\r\n}());\r\n\r\nTC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.control.Geolocation = function (options) {\r\n    var self = this;\r\n    self._classSelector = '.' + self.CLASS;\r\n\r\n    self._layerPromises = {};\r\n\r\n    self.Const = {\r\n        Classes: {\r\n            ACTIVE: 'tc-ctl-geolocation-active',\r\n            CLOSED: 'closed',\r\n            SELECTEDTRACK: 'selectedTrack',\r\n            DRAWACTIVATED: 'draw-activated',\r\n            SIMULATIONACTIVATED: 'simulation-activated'\r\n        },\r\n        Selector: {\r\n            SIMULATE: '.tc-btn-simulate',\r\n            DRAW: '.tc-draw',\r\n            EDIT: '.tc-btn-edit',\r\n            DELETE: '.tc-btn-delete',\r\n            SAVE: '.tc-btn-save',\r\n            CANCEL: '.tc-btn-cancel',\r\n            EXPORT_GPX: '.tc-btn-export-gpx',\r\n            EXPORT_KML: '.tc-btn-export-kml',\r\n            STOP: '.tc-btn-stop',\r\n            PAUSE: '.tc-btn-pause',\r\n            BACKWARD: '.tc-btn-backward',\r\n            FORWARD: '.tc-btn-forward',\r\n            SPEED: '.tc-spn-speed'\r\n        },\r\n        LocalStorageKey: {\r\n            TRACKING: 'trk',\r\n            TRACKINGTEMP: 'trktemp',\r\n            TRACKINGSHOWADVERTISEMENT: 'trkAdvertisement',\r\n            GPSSHOWADVERTISEMENT: 'gpsAdvertisement',\r\n            TEST: 'test'\r\n        },\r\n        Message: {\r\n            VALIDATENAME: '',\r\n        },\r\n        Event: {\r\n            POSITIONCHANGE: 'positionchange.tc.geolocation',\r\n            GPSPOSITIONCHANGE: 'gpspositionchange.tc.geolocation',\r\n            GPSPOSITIONERROR: 'positionerror.tc.geolocation',\r\n            STATEUPDATED: 'stateupdated.tc.geolocation',\r\n            GPSADD: 'gpsadd.tc.geolocation',\r\n            TRACKSNAPPING: 'tracksnapping.tc.geolocation',\r\n            DRAWTRACK: 'drawtrack.tc.geolocation',\r\n            CLEARTRACK: 'cleartrack.tc.geolocation',\r\n            IMPORTEDTRACK: 'importedtrack.tc.geolocation'\r\n        },\r\n        MimeMap: {\r\n            KML: 'application/vnd.google-earth.kml+xml',\r\n            GPX: 'application/gpx+xml'\r\n        },\r\n        SupportedFileExtensions: [\r\n            '.kml',\r\n            '.gpx'\r\n        ],\r\n        Tabs: {\r\n            GPS: \"gps\"\r\n        },\r\n        Layers: {\r\n            GPS: \"gps\",\r\n            TRACK: \"track\",\r\n            TRACKING: \"tracking\"\r\n        }\r\n    };\r\n\r\n    TC.Control.apply(self, arguments);\r\n\r\n    var opts = options || {};\r\n    self._dialogDiv = TC.Util.getDiv(opts.dialogDiv);\r\n    if (window.$) {\r\n        self._$dialogDiv = $(self._dialogDiv);\r\n    }\r\n    if (!opts.dialogDiv) {\r\n        document.body.appendChild(self._dialogDiv);\r\n    }\r\n    self.delta = 500;\r\n    self.walkingSpeed = 5000;\r\n    self.gapHill = self.options.gapHill || 20;\r\n\r\n    self.snappingTolerance = self.options.snappingTolerance || 50;\r\n\r\n    self.exportsState = true;\r\n\r\n    self.storageCRS = 'EPSG:4326';\r\n};\r\n\r\nTC.inherit(TC.control.Geolocation, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Geolocation.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-geolocation';\r\n\r\n    ctlProto.CHART_SIZE = {\r\n        MIN_HEIGHT: 75,\r\n        MAX_HEIGHT: 128,\r\n\r\n        MIN_WIDTH: 300,\r\n        MEDIUM_WIDTH: 310,\r\n        MAX_WIDTH: 445\r\n    };\r\n\r\n    ctlProto.featuresToShare = [];\r\n\r\n    TC.Consts.event.TOOLSCLOSE = TC.Consts.event.TOOLSCLOSE || 'toolsclose.tc';\r\n    TC.Consts.event.TOOLSOPEN = TC.Consts.event.TOOLSOPEN || 'toolsopen.tc';\r\n\r\n    ctlProto.template = {};\r\n\r\n    if (TC.isDebug) {\r\n        ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/Geolocation.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-track-node'] = TC.apiLocation + \"TC/templates/GeolocationTrackNode.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-track-snapping-node'] = TC.apiLocation + \"TC/templates/GeolocationTrackSnappingNode.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/GeolocationDialog.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-tracking-toast'] = TC.apiLocation + \"TC/templates/GeolocationTrackingToast.html\";\r\n    }\r\n    else {\r\n        ctlProto.template[ctlProto.CLASS] = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo\" }).w(\"</h2><div class=\\\"tc-ctl-geolocation-content\\\"> <div class=\\\"tc-ctl-geolocation-track\\\"><div class=\\\"tc-ctl-geolocation-track-snap-info\\\"></div> <!-- img se insertan en el div del mapa--> <div id=\\\"tc-ctl-geolocation-track-elevation-marker\\\" class=\\\"tc-ctl-geolocation-trackMarker elevation\\\" style=\\\"display: none;\\\"></div> <div class=\\\"tc-ctl-geolocation-track-panel-block\\\" ><input id=\\\"tc-ctl-geolocation-track-panel-opened\\\" type=\\\"checkbox\\\" checked/><label for=\\\"tc-ctl-geolocation-track-panel-opened\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.help.1\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.help.2\" }).w(\"</label><i class=\\\"tc-ctl-geolocation-track-panel-help icon-question-sign\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.help.3\" }).w(\"\\\"></i></div><div class=\\\"tc-ctl-geolocation-track-mng\\\"><div class=\\\"tc-ctl-geolocation-select\\\"><form> <label class=\\\"tc-ctl-geolocation-btn-track\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.title\" }).w(\"\\\"><input type=\\\"radio\\\" name=\\\"mode\\\" checked value=\\\"tracks\\\" /><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.gps\" }).w(\"</span></label><label class=\\\"tc-ctl-geolocation-btn-tracks\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.tracks.title\" }).w(\"\\\"><input type=\\\"radio\\\" name=\\\"mode\\\" value=\\\"track-available\\\" /><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.tracks\" }).w(\"</span></label> </form></div> <div class=\\\"tc-ctl-geolocation-track-available tc-ctl-geolocation-track-cnt tc-ctl-geolocation-panel tc-hidden\\\"><i class=\\\"tc-ctl-geolocation-track-search-icon\\\"></i><input id=\\\"tc-ctl-geolocation-track-available-srch\\\" type=\\\"search\\\" list=\\\"tc-ctl-geolocation-track-available-lst\\\" class=\\\"tc-ctl-geolocation-track-available-srch tc-textbox\\\" placeholder=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.filter.plhr\" }).w(\"\\\" maxlength=\\\"200\\\" /> <ol id=\\\"tc-ctl-geolocation-track-available-lst\\\" class=\\\"tc-ctl-geolocation-track-available-lst\\\"><li class=\\\"tc-ctl-geolocation-track-available-empty\\\"><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.noTracks\" }).w(\"</span></li><li class=\\\"tc-ctl-geolocation-track-not\\\" hidden><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"noMatches\" }).w(\"</span></li></ol><div class=\\\"tc-ctl-geolocation-track-cnt\\\"><input name=\\\"uploaded-file\\\" id=\\\"uploaded-file\\\" type=\\\"file\\\" class=\\\"tc-ctl-geolocation-track-import tc-button\\\" accept=\\\".gpx,.kml\\\" disabled /><label class=\\\"tc-button tc-icon-button\\\" for=\\\"uploaded-file\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.import.upload\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.import.lbl\" }).w(\"</label></div></div><div class=\\\"tc-ctl-geolocation-tracks tc-ctl-geolocation-panel\\\"> <div class=\\\"tc-alert alert-warning tc-hidden\\\" ><p id=\\\"panel-msg\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.1\" }).w(\" <ul><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.2\" }).w(\"</li><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.3\" }).w(\"</li><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.4\" }).w(\"</li><li>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.panel.5\" }).w(\"</li></ul></p></div> <div class=\\\"tc-ctl-geolocation-track-ui\\\"> <div class=\\\"tc-ctl-geolocation-track-render\\\"><input id=\\\"tc-ctl-geolocation-track-render\\\" type=\\\"checkbox\\\" hidden checked /><label for=\\\"tc-ctl-geolocation-track-render\\\" class=\\\"tc-ctl-geolocation-track-render\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.render\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.render\" }).w(\"</label></div><button class=\\\"tc-button tc-icon-button tc-ctl-geolocation-track-ui-activate\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.activate.title\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.activate\" }).w(\"</button><button class=\\\"tc-button tc-icon-button tc-ctl-geolocation-track-ui-deactivate tc-hidden\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.deactivate.title\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.deactivate\" }).w(\"</button></div><div class=\\\"tc-ctl-geolocation-track-current tc-ctl-geolocation-track-cnt\\\"><input type=\\\"text\\\" class=\\\"tc-ctl-geolocation-track-title tc-textbox\\\" disabled placeholder=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.name.plhr\" }).w(\"\\\" maxlength=\\\"200\\\" /><button class=\\\"tc-button tc-icon-button tc-ctl-geolocation-track-save\\\" disabled title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.name.save\" }).w(\"\\\"></button><input type=\\\"text\\\" class=\\\"tc-ctl-geolocation-track-waypoint tc-textbox\\\" disabled placeholder=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.wyp.plhr\" }).w(\"\\\" maxlength=\\\"200\\\" /><button class=\\\"tc-button tc-icon-button tc-ctl-geolocation-track-add-wpt\\\" disabled title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.wyp.save\" }).w(\"\\\"></button></div></div></div></div></div><div class=\\\"tc-ctl-geolocation-track-center tc-hidden\\\"><button title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.center\" }).w(\"\\\"></button></div>\"); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-track-node'] = function () { dust.register(ctlProto.CLASS + '-track-node', body_0); function body_0(chk, ctx) { return chk.w(\"<li data-id=\\\"\").f(ctx.get([\"id\"], false), ctx, \"h\").w(\"\\\" data-uid=\\\"\").f(ctx.get([\"uid\"], false), ctx, \"h\").w(\"\\\"><span class=\\\"tc-draw tc-selectable\\\" title=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\">\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"</span><input class=\\\"tc-textbox tc-hidden\\\" type=\\\"text\\\" value=\\\"\").f(ctx.get([\"name\"], false), ctx, \"h\").w(\"\\\" /> <button class=\\\"tc-btn-simulate\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.simulate\" }).w(\"\\\"></button><button hidden class=\\\"tc-btn-stop\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.stop\" }).w(\"\\\"></button><button class=\\\"tc-btn-edit\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.edit\" }).w(\"\\\"></button><button hidden class=\\\"tc-btn-pause\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.pause\" }).w(\"\\\"></button> <button hidden class=\\\"tc-btn-backward\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.backward\" }).w(\"\\\"></button><label hidden class=\\\"tc-spn-speed\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.velocity\" }).w(\"\\\"></label><button hidden class=\\\"tc-btn-forward\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.forward\" }).w(\"\\\"></button> <button class=\\\"tc-btn-save tc-hidden\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"save\" }).w(\"\\\"></button><button class=\\\"tc-btn-cancel tc-hidden\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.cancel\" }).w(\"\\\"></button><button class=\\\"tc-btn-delete\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.delete\" }).w(\"\\\"></button><button class=\\\"tc-btn-export-gpx\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.exportGPX\" }).w(\"\\\"></button><button class=\\\"tc-btn-export-kml\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"tr.lst.exportKML\" }).w(\"\\\"></button> </li>\"); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-track-snapping-node'] = function () { dust.register(ctlProto.CLASS + '-track-snapping-node', body_0); function body_0(chk, ctx) { return chk.w(\"<ul>\").x(ctx.get([\"n\"], false), ctx, { \"block\": body_1 }, {}).w(\"<li> <span>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_2, \"block\": body_3 }, {}).w(\":</span> \").f(ctx.get([\"x\"], false), ctx, \"h\").w(\"</li><li> <span>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_4, \"block\": body_5 }, {}).w(\":</span> \").f(ctx.get([\"y\"], false), ctx, \"h\").w(\" </li>\").x(ctx.get([\"z\"], false), ctx, { \"block\": body_6 }, {}).x(ctx.get([\"m\"], false), ctx, { \"block\": body_8 }, {}).w(\"</ul>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"<li><span>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.snapping.name\" }).w(\":</span> \").f(ctx.get([\"n\"], false), ctx, \"h\").w(\"</li>\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.w(\"X\"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"lon\" }); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.w(\"Y\"); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"lat\" }); } body_5.__dustBody = !0; function body_6(chk, ctx) { return chk.h(\"ne\", ctx, { \"block\": body_7 }, { \"key\": ctx.get([\"z\"], false), \"value\": 0 }); } body_6.__dustBody = !0; function body_7(chk, ctx) { return chk.w(\"<li> <span>Z:</span> \").f(ctx.get([\"z\"], false), ctx, \"h\").w(\" </li>\"); } body_7.__dustBody = !0; function body_8(chk, ctx) { return chk.w(\"<li> \").f(ctx.get([\"m\"], false), ctx, \"h\").w(\" </li>\"); } body_8.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-dialog'] = function () { dust.register(ctlProto.CLASS + '-dialog', body_0); function body_0(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-geolocation-continue-track-dialog tc-modal\\\" ><div class=\\\"tc-modal-background tc-modal-close\\\"></div><div class=\\\"tc-modal-window\\\"><div class=\\\"tc-modal-header\\\"><h3>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.gps\" }).w(\"</h3><div class=\\\"tc-modal-close\\\"></div></div><div class=\\\"tc-modal-body\\\"><button class=\\\"tc-button tc-ctl-geolocation-track-continue\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.dialog.cnt\" }).w(\" </button><button class=\\\"tc-button tc-ctl-geolocation-track-new\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.dialog.new\" }).w(\" </button> <button class=\\\"tc-button tc-modal-close\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.dialog.cancel\" }).w(\" </button></div></div></div><div class=\\\"tc-ctl-geolocation-track-advert-dialog tc-modal\\\" ><div class=\\\"tc-modal-background tc-modal-close\\\"></div><div class=\\\"tc-modal-window\\\"><div class=\\\"tc-modal-header\\\"><h3>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.track.activate.title\" }).w(\"</h3><div class=\\\"tc-modal-close\\\"></div></div><div class=\\\"tc-modal-body\\\"><p id=\\\"pageBlurMsg\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.page.blur\" }).w(\"</p><p class=\\\"tc-ctl-geolocation-track-advertisement p\\\"> <label> <input type=\\\"checkbox\\\" name=\\\"checkbox\\\" id=\\\"advertisement\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.dialog.advertisement\" }).w(\" </label> </p></div><div class=\\\"tc-modal-footer\\\"><button class=\\\"tc-button tc-ctl-geolocation-track-advert-ok\\\"> \").h(\"i18n\", ctx, {}, { \"$key\": \"ok\" }).w(\" </button></div></div></div>\"); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-tracking-toast'] = function () { dust.register(ctlProto.CLASS + '-tracking-toast', body_0); function body_0(chk, ctx) { return chk.w(\"<table class=\\\"tc-ctl-geolocation-info-tracking\\\"><tr><th>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_1, \"block\": body_2 }, {}).w(\":</th><td> \").f(ctx.get([\"x\"], false), ctx, \"h\").w(\" </td>\").x(ctx.get([\"accuracy\"], false), ctx, { \"block\": body_3 }, {}).w(\"</tr><tr><th>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_4, \"block\": body_5 }, {}).w(\":</th><td> \").f(ctx.get([\"y\"], false), ctx, \"h\").w(\" </td>\").x(ctx.get([\"speed\"], false), ctx, { \"block\": body_6 }, {}).w(\"</tr><tr>\").x(ctx.get([\"z\"], false), ctx, { \"block\": body_7 }, {}).x(ctx.get([\"mdt\"], false), ctx, { \"block\": body_10 }, {}).w(\"</tr> </table>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.w(\"X\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"lon\" }); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.w(\"<th>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.accuracy\" }).w(\":</th><td> \").f(ctx.get([\"accuracy\"], false), ctx, \"h\").w(\" m </td>\"); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.w(\"Y\"); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"lat\" }); } body_5.__dustBody = !0; function body_6(chk, ctx) { return chk.w(\"<th>\").h(\"i18n\", ctx, {}, { \"$key\": \"geo.trk.speed\" }).w(\":</th><td>\").f(ctx.get([\"speed\"], false), ctx, \"h\").w(\" km/h</td>\"); } body_6.__dustBody = !0; function body_7(chk, ctx) { return chk.w(\"<th>\").x(ctx.get([\"isGeo\"], false), ctx, { \"else\": body_8, \"block\": body_9 }, {}).w(\":</th><td> \").f(ctx.get([\"z\"], false), ctx, \"h\").w(\" m </td>\"); } body_7.__dustBody = !0; function body_8(chk, ctx) { return chk.w(\"Z\"); } body_8.__dustBody = !0; function body_9(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"ele\" }); } body_9.__dustBody = !0; function body_10(chk, ctx) { return chk.w(\"<th title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \" mdt.title\" }).w(\"\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"ele\" }).w(\" (\").h(\"i18n\", ctx, {}, { \"$key\": \"mdt\" }).w(\"):</th><td>\").f(ctx.get([\"mdt\"], false), ctx, \"h\").w(\" m </td>\"); } body_10.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self.wrap = new TC.wrap.control.Geolocation(self);\r\n        self.wrap.register(map);\r\n\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            stealth: true,\r\n            title: 'Posicionar.GPS',\r\n        }).then(function (layer) {\r\n            self.layerGPS = layer;\r\n        });\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            stealth: true,\r\n            title: 'Posicionar.Tracking',\r\n            styles: {\r\n                point: {\r\n                    radius: 3,\r\n                    fillColor: \"#00ced1\",\r\n                    fillOpacity: function () {\r\n                        return this.track.renderTrack.checked ? 1 : 0;\r\n                    }.bind(self),\r\n                    strokeColor: \"#ffffff\",\r\n                    fontColor: \"#00ced1\",\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 1,\r\n                    label: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            name = (name + '').trim().toLowerCase();\r\n                        } else {\r\n                            name = '';\r\n                        }\r\n\r\n                        return name;\r\n                    }\r\n                },\r\n                line: {\r\n                    strokeOpacity: function () {\r\n                        return this.track.renderTrack.checked ? 1 : 0;\r\n                    }.bind(self),\r\n                    strokeWidth: 2,\r\n                    strokeColor: \"#00ced1\",\r\n                    lineDash: [.1, 6]\r\n                }\r\n            }\r\n        }).then(function (layer) {\r\n            self.layerTracking = layer;\r\n        });\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            stealth: true,\r\n            title: 'Posicionar.Track',\r\n            styles: {\r\n                line: {\r\n                    strokeWidth: 2,\r\n                    strokeColor: \"#C52737\"\r\n                },\r\n                point: {\r\n                    radius: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            return 3;\r\n                        } else {\r\n                            return 6;\r\n                        }\r\n\r\n                        return 3;\r\n                    },\r\n                    fillColor: \"#C52737\",\r\n                    strokeColor: \"#ffffff\",\r\n                    fontColor: \"#C52737\",\r\n                    fontSize: 10,\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 2,\r\n                    label: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            name = (name + '').trim().toLowerCase();\r\n                        } else {\r\n                            name = '';\r\n                        }\r\n\r\n                        return name;\r\n                    }\r\n                }\r\n            }\r\n        }).then(function (layer) {\r\n            self.layerTrack = layer;\r\n        });\r\n\r\n        map.on(TC.Consts.event.FEATURESIMPORT, function (e) {\r\n            const self = this;\r\n            const fileName = e.fileName;\r\n            const target = e.dropTarget;\r\n            var kmlPattern = '.' + TC.Consts.format.KML.toLowerCase();\r\n            var gpxPattern = '.' + TC.Consts.format.GPX.toLowerCase();\r\n\r\n            // GLS: ¿es un GPX?\r\n            if (fileName.toLowerCase().indexOf(gpxPattern) === fileName.length - gpxPattern.length ||\r\n                // GLS: ¿es un KML y viene desde el upload de Geolocation?\r\n                (fileName.toLowerCase().indexOf(kmlPattern) === fileName.length - kmlPattern.length && target === self)) {\r\n\r\n                self.clear(self.Const.Layers.TRACK);\r\n                self.importTrack(e);\r\n\r\n                if (/.kml$/g.test(fileName.toLowerCase()) && self.layerTrack) {\r\n                    if (self.layerTrack.styles) {\r\n                        self.layerTrack.features.forEach(function (feature) {\r\n                            if (feature instanceof TC.feature.Point && self.layerTrack.styles.point) {\r\n                                feature.setStyle(self.layerTrack.styles.point);\r\n                            } else if (feature instanceof TC.feature.Polyline && self.layerTrack.styles.line) {\r\n                                feature.setStyle(self.layerTrack.styles.line);\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            } else {\r\n                //GLS: si es un KML pero viene desde el mapa o es otro tipo de archivo que no es ni GPX ni KML, lo ignoramos\r\n                return;\r\n            }\r\n        }.bind(self));\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        return self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n        }).then(function () {\r\n            return TC.Control.prototype.render.call(self, callback);\r\n        });\r\n    };\r\n\r\n    ctlProto.importTrack = function (options) {\r\n        var self = this;\r\n\r\n        if (!self.isDisabled) {\r\n            if (options.fileName && options.features && options.features.length > 0) {\r\n\r\n                var wait = self.getLoadingIndicator().addWait();\r\n                self.importedFileName = options.fileName;\r\n                const addPromises = [];\r\n                for (var i = 0, len = options.features.length; i < len; i++) {\r\n                    addPromises.push(self.layerTrack.addFeature(options.features[i]));\r\n                }\r\n                Promise.all(addPromises).then(function () {\r\n                    self.wrap.processImportedFeatures({ wait: wait, notReproject: options.notReproject });\r\n\r\n                    if (self.layerTrack) { // Si tenemos capa es que todo ha ido bien y gestionamos el despliegue del control\r\n                        // Desplegamos el control \"ubicar\" al importar mediante drag&drop\r\n                        if (self.map && self.map.layout && self.map.layout.accordion) {\r\n                            if (self.div.classList.contains(TC.Consts.classes.COLLAPSED)) {\r\n                                self.map.controls\r\n                                    .filter(function (ctl) {\r\n                                        // Todos los otros controles que no cuelgan de otro control\r\n                                        return ctl !== self && !ctl.containerControl;\r\n                                    })\r\n                                    .forEach(function (ctl) {\r\n                                        ctl.div.classList.add(TC.Consts.classes.COLLAPSED);\r\n                                    });\r\n                            }\r\n                        }\r\n\r\n                        self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                        self.div.querySelector('.' + self.CLASS + '-btn-tracks > span').click();\r\n\r\n                        if (!options.isShared) {\r\n                            // abrimos el panel de herramientas\r\n                            self.map.trigger(TC.Consts.event.TOOLSOPEN);\r\n                        }                        \r\n                    }\r\n                });\r\n            }\r\n        } else if (/.gpx$/g.test(options.fileName.toLowerCase())) {\r\n            self.map.toast(self.getLocaleString(\"geo.trk.import.disabled\"), { type: TC.Consts.msgType.WARNING });\r\n        }\r\n    };\r\n\r\n    ctlProto.prepareFeaturesToShare = function (trackUid) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            if (trackUid) {\r\n\r\n                var storageData = self.availableTracks.filter(function (saved) {\r\n                    return saved.uid.toString() === trackUid.toString();\r\n                })[0].data;\r\n\r\n                // Aplicamos una precisión un dígito mayor que la del mapa, si no, al compartir algunas parcelas se deforman demasiado\r\n                var precision = Math.pow(10, TC.Consts.DEGREE_PRECISION + 1);\r\n\r\n                var storageFeatures = new ol.format.GeoJSON().readFeatures(storageData);\r\n                const promises = new Array(storageFeatures.length);\r\n                storageFeatures.forEach(function (f, idx) {\r\n                    promises[idx] = TC.wrap.Feature.createFeature(f);\r\n                });\r\n\r\n                Promise.all(promises).then(function (tcFeatures) {\r\n                    self.featuresToShare = tcFeatures.map(function (f) {\r\n                        const fObj = {};\r\n                        var layerStyle;\r\n                        switch (true) {\r\n                            case TC.feature.Marker && f instanceof TC.feature.Marker:\r\n                                fObj.type = TC.Consts.geom.MARKER;\r\n                                break;\r\n                            case TC.feature.Point && f instanceof TC.feature.Point:\r\n                                fObj.type = TC.Consts.geom.POINT;\r\n                                break;\r\n                            case TC.feature.Polyline && f instanceof TC.feature.Polyline:\r\n                                fObj.type = TC.Consts.geom.POLYLINE;\r\n                                break;\r\n                            case TC.feature.MultiPolyline && f instanceof TC.feature.MultiPolyline:\r\n                                fObj.type = TC.Consts.geom.MULTIPOLYLINE;\r\n                                break;\r\n                        }\r\n                        fObj.id = f.id;\r\n                        fObj.geom = TC.Util.compactGeometry(f.geometry, precision);\r\n                        fObj.data = f.getData();\r\n\r\n                        return fObj;\r\n                    });\r\n\r\n                    resolve();\r\n                });\r\n            } else {\r\n                resolve();\r\n            }\r\n        });\r\n\r\n\r\n    };\r\n\r\n    var visibilityTrack = true;\r\n    ctlProto.renderData = function (data, callback) {\r\n        const self = this;\r\n\r\n        var sel = self.Const.Selector;\r\n\r\n        return TC.Control.prototype.renderData.call(self, data, function () {\r\n\r\n            const options = self.div.querySelectorAll(self._classSelector + '-panel');\r\n            self.div.querySelectorAll('.' + self.CLASS + '-select span').forEach(function (span) {\r\n                span.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    var label = e.target;\r\n                    while (label && label.tagName !== 'LABEL') {\r\n                        label = label.parentElement;\r\n                    }\r\n                    const newFormat = label.querySelector('input[type=radio][name=mode]').value;\r\n\r\n                    options.forEach(function (option) {\r\n                        option.classList.toggle(TC.Consts.classes.HIDDEN, !option.matches('.' + self.CLASS + '-' + newFormat));\r\n                    });\r\n                });\r\n            });\r\n\r\n            self.track = {\r\n                activateButton: self.div.querySelector(self._classSelector + '-track-ui-activate'),\r\n                deactivateButton: self.div.querySelector(self._classSelector + '-track-ui-deactivate'),\r\n                trackSearch: self.div.querySelector(self._classSelector + '-track-available-srch'),\r\n                trackImportFile: self.div.querySelector(self._classSelector + '-track-import'),\r\n                trackSave: self.div.querySelector(self._classSelector + '-track-save'),\r\n                trackAdd: self.div.querySelector(self._classSelector + '-track-add-wpt'),\r\n                trackContinue: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-continue'),\r\n                trackRenew: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-new'),\r\n                trackClose: self._dialogDiv.querySelector('.tc-ctl-geolocation-continue-track-dialog button.tc-modal-close'),\r\n                //trackAddSegment: self.div.querySelector('#tc-ctl-geolocation-track-segment'),\r\n                trackAdvertisementOK: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-ok')\r\n            };\r\n\r\n            self.track.trackList = self.div.querySelector(self._classSelector + '-track-available-lst');\r\n\r\n            self.track.trackToolPanelOpened = self.div.querySelector('#tc-ctl-geolocation-track-panel-opened');\r\n\r\n            self.div.querySelector('.' + ctlProto.CLASS + '-track-panel-help').addEventListener('click', function () {\r\n                _showAlerMsg.call(self);\r\n            });\r\n\r\n            self.track.trackName = self.div.querySelector(self._classSelector + '-track-title');\r\n\r\n            self.track.trackWPT = self.div.querySelector(self._classSelector + '-track-waypoint');\r\n\r\n            if (TC.Util.detectMobile()) {\r\n                if (matchMedia('screen and (max-height: 50em) and (max-width: 50em)').matches)\r\n                    self.track.trackToolPanelOpened.checked = false;\r\n            }\r\n\r\n            if (window.File && window.FileReader && window.FileList && window.Blob) {\r\n                self.track.trackImportFile.disabled = false;\r\n                // GLS: Eliminamos el archivo subido, sin ello no podemos subir el mismo archivo seguido varias veces\r\n                self.track.trackImportFile.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    // Envolvemos el input en un form\r\n                    const input = this;\r\n                    const form = document.createElement('form');\r\n                    const parent = input.parentElement;\r\n                    parent.insertBefore(form, input);\r\n                    form.appendChild(input);\r\n                    form.reset();\r\n                    // Desenvolvemos el input del form\r\n                    form.insertAdjacentElement('afterend', input);\r\n                    parent.removeChild(form);\r\n                });\r\n                self.track.trackImportFile.addEventListener('change', function (e) {\r\n                    if (!self._cleaning) { // Valido que el evento import no lo provoco yo al limpiar el fileinput (al limpiar se lanza el change)                        \r\n                        self.clear(self.Const.Layers.TRACK);\r\n\r\n                        if (self.map) {\r\n                            self.map.on(TC.Consts.event.LAYERERROR, _layerError);\r\n                            self.map.wrap.loadFiles(e.target.files, { control: self });\r\n                        }\r\n                    }\r\n                });\r\n            } else {\r\n                console.log('no es posible la importación');\r\n            }\r\n\r\n            self.track.activateButton.addEventListener('click', function () {\r\n                self.activateTracking();\r\n                _activateTrackingBtns.call(self);\r\n\r\n            });\r\n            self.track.deactivateButton.addEventListener('click', function () {\r\n                self.deactivateTracking();\r\n                _deactivateTrackingBtns.call(self);\r\n            });\r\n\r\n            var _filter = function (searchTerm) {\r\n                searchTerm = searchTerm.toLowerCase();\r\n                //tc-ctl-geolocation-track-available-empty\r\n                const lis = Array.from(self.track.trackList.querySelectorAll('li'));\r\n                lis.forEach(function (li) {\r\n                    li.style.display = 'none';\r\n                });\r\n                const trackLis = lis.filter(function (li) {\r\n                    return li.matches('li:not([class]),li.' + self.Const.Classes.SELECTEDTRACK);\r\n                });\r\n\r\n                const searchIcon = self.div.querySelector(self._classSelector + '-track-search-icon');\r\n                if (searchTerm.length === 0) {\r\n                    trackLis.forEach(function (li) {\r\n                        li.style.display = '';\r\n                    });\r\n                    searchIcon.style.visibility = 'visible';\r\n                } else {\r\n                    searchIcon.style.visibility = 'hidden';\r\n                    var r = new RegExp(searchTerm, 'i');\r\n                    trackLis.forEach(function (li) {\r\n                        li.style.display = r.test(li.querySelector('span').textContent) ? '' : 'none';\r\n                    });\r\n\r\n                    if (!trackLis.some(function (li) {\r\n                        return li.style.display === '';\r\n                    })) {\r\n                        lis.forEach(function (li) {\r\n                            if (li.matches('[class^=\"tc-ctl-geolocation-track-not\"]')) {\r\n                                li.style.display = '';\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            };\r\n            const trackSearchListener = function () {\r\n                _filter(this.value.toLowerCase().trim());\r\n            };\r\n            self.track.trackSearch.addEventListener(\"keyup\", trackSearchListener);\r\n            self.track.trackSearch.addEventListener(\"search\", trackSearchListener);\r\n\r\n            // en el panel\r\n            self.track.trackSave.addEventListener('click', self.saveTrack.bind(self));\r\n            self.track.trackAdd.addEventListener('click', self.addWaypoint.bind(self));\r\n\r\n            const list = self.div.querySelector(self._classSelector + '-track-available-lst');\r\n\r\n            // en lista\r\n            var _edit = function (edit, elm) {\r\n                if (elm.tagName !== 'LI') {\r\n                    elm = elm.parentElement;\r\n                }\r\n\r\n                const input = elm.querySelector('input');\r\n                const span = elm.querySelector('span');\r\n\r\n                if (edit) {\r\n\r\n                    input.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    input.focus();\r\n                    input.value = span.textContent;\r\n                    span.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SIMULATE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EDIT).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DELETE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DRAW).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT_GPX).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT_KML).classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SAVE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.CANCEL).classList.remove(TC.Consts.classes.HIDDEN);\r\n                } else {\r\n\r\n                    input.classList.add(TC.Consts.classes.HIDDEN);\r\n                    span.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SIMULATE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EDIT).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DELETE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DRAW).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT_GPX).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT_KML).classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SAVE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.CANCEL).classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            };\r\n\r\n            self.uiSimulate = function (simulate, elm) {\r\n                if (elm) {\r\n                    var editControls = [\r\n                        sel.SIMULATE,\r\n                        sel.EDIT,\r\n                        sel.DELETE,\r\n                        sel.EXPORT_GPX,\r\n                        sel.EXPORT_KML\r\n                    ];\r\n                    var simulateControls = [\r\n                        sel.STOP,\r\n                        sel.PAUSE,\r\n                        sel.BACKWARD,\r\n                        sel.FORWARD,\r\n                        sel.SPEED\r\n                    ];\r\n                    var cnt = elm.tagName === 'LI' ? elm : elm.parentNode;\r\n\r\n                    editControls.forEach(function (ctl) {\r\n                        cnt.querySelector(ctl).hidden = simulate;\r\n                    });\r\n\r\n                    simulateControls.forEach(function (ctl) {\r\n                        cnt.querySelector(ctl).hidden = !simulate;\r\n                    });\r\n                }\r\n            };\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(sel.SIMULATE, function (e) {\r\n                var wait = self.getLoadingIndicator().addWait();\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = 'x 1';\r\n\r\n                _loadTrack(self, e.target).then(function () { //Para evitar el bloqueo de la interfaz en móviles\r\n                    self.getLoadingIndicator().removeWait(wait)\r\n                });\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(sel.DRAW, function (e) {\r\n                var wait = self.getLoadingIndicator().addWait();\r\n\r\n                _drawTrack(self, e.target).then(function () {\r\n                    self.getLoadingIndicator().removeWait(wait);\r\n                });\r\n            }));\r\n\r\n            self.on(self.Const.Event.IMPORTEDTRACK, function (e) {\r\n                if (!self.isDisabled) {\r\n                    const listElement = self.track.trackList.querySelector('li[data-id=\"' + e.index + '\"]');\r\n                    _drawTrack(self, listElement.querySelector(sel.DRAW));\r\n                    setTimeout(function () {\r\n                        self.track.trackList.scrollTop = e.index * listElement.offsetHeight;\r\n                    }, 100);\r\n                } else {\r\n                    self.map.toast(self.getLocaleString(\"geo.trk.import.disabled\"), { type: TC.Consts.msgType.WARNING });\r\n                }\r\n            });\r\n\r\n            const _stopOtherTracks = function (self, trackLiId) {\r\n                self.track.trackList.querySelectorAll('li[data-id]').forEach(function (listItem) {\r\n                    if (listItem.dataset.id !== trackLiId) {\r\n                        const btnSimulate = listItem.querySelector(sel.SIMULATE);\r\n                        const btnPause = listItem.querySelector(sel.PAUSE);\r\n\r\n                        btnSimulate.classList.remove(self.Const.Classes.SIMULATIONACTIVATED);\r\n                        btnSimulate.setAttribute('title', self.getLocaleString(\"tr.lst.simulate\"));\r\n                        btnPause.classList.remove('play');\r\n                        btnPause.setAttribute('title', self.getLocaleString(\"tr.lst.pause\"));\r\n\r\n                        self.uiSimulate(false, listItem);\r\n                        _edit(false, listItem);\r\n                    }\r\n                });\r\n\r\n                self.clear(self.Const.Layers.TRACK);\r\n            };\r\n\r\n            var _drawTrack = function (self, btnDraw) {\r\n                return new Promise(function (resolve, reject) {\r\n\r\n                    const trackLi = btnDraw.parentElement;\r\n\r\n                    setTimeout(function () {\r\n                        if (trackLi.classList.contains(self.Const.Classes.SELECTEDTRACK)) {\r\n                            self.uiSimulate(false, btnDraw);\r\n\r\n                            self.clear(self.Const.Layers.TRACK);\r\n\r\n                            btnDraw.setAttribute('title', btnDraw.textContent);\r\n                        }\r\n                        else if (self.getSelectedTrack()) { // GLS: si hay elemento seleccionado actuamos\r\n                            _stopOtherTracks(self, trackLi.dataset.id);\r\n                            self.drawTrack(trackLi);\r\n                        } else {\r\n                            self.drawTrack(trackLi);\r\n                        }\r\n\r\n                        /* GLS: 15/02/2019 Preparamos la feature por si se comparte, necesito hacerlo aquí \r\n                           porque la gestión en asíncrona y todo el flujo de exportación es síncrono */\r\n                        if (trackLi.classList.contains(self.Const.Classes.SELECTEDTRACK)) {\r\n                            self.prepareFeaturesToShare(trackLi.dataset.uid).then(function () {\r\n                                resolve();\r\n                            });\r\n                        } else {\r\n                            resolve();\r\n                        }\r\n                    }, 0);\r\n                });\r\n            };\r\n\r\n            var _loadTrack = function (self, btnSimulate) {\r\n                return new Promise(function (resolve, reject) {\r\n                    setTimeout(function () {\r\n                        const trackLi = btnSimulate.parentElement;\r\n\r\n                        _stopOtherTracks(self, trackLi.dataset.id);\r\n                        self.uiSimulate(false, self.getSelectedTrack());\r\n                        self.uiSimulate(true, btnSimulate);\r\n\r\n                        self.simulate_paused = false;\r\n                        self.simulateTrack(trackLi);\r\n\r\n                        resolve();\r\n                    }, 0);\r\n                });\r\n            };\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.EDIT, function (e) {\r\n                _edit(true, e.target);\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.DELETE, function (e) {\r\n                self.removeTrack(e.target.parentElement);\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.SAVE, function (e) {\r\n                var newName = e.target.parentElement.querySelector('input').value;\r\n                if (newName.trim().length === 0) {\r\n                    TC.alert(self.getLocaleString('geo.trk.edit.alert'));\r\n                }\r\n                else {\r\n                    self.editTrackName(e.target.parentElement.dataset.id, e.target.parentElement.querySelector('input').value);\r\n                    _edit(false, e.target);\r\n                }\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.CANCEL, function (e) {\r\n                _edit(false, e.target);\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.EXPORT_GPX + ',' + self._classSelector + ' ' + sel.EXPORT_KML, function (e) {\r\n                const parent = e.target.parentElement;\r\n                var prefix = 'tc-btn-export-';\r\n                var className = Array.from(e.target.classList).filter(function (cls) {\r\n                    return cls.indexOf(prefix) === 0;\r\n                })[0];\r\n                var mimeType = className.replace(prefix, '').toUpperCase();\r\n\r\n                self.export(mimeType, parent).then(function (data) {\r\n                    if (data) {\r\n                        var filename = parent.querySelector('span').textContent;\r\n                        var regex = new RegExp(self.Const.SupportedFileExtensions.join('|'), 'gi');\r\n                        var cleanFilename = filename.replace(regex, '');\r\n                        TC.Util.downloadFile(cleanFilename + '.' + mimeType.toLowerCase(), self.Const.MimeMap[mimeType], data);\r\n                    } else {\r\n                        TC.alert(self.getLocaleString('geo.error.export'));\r\n                    }\r\n                });\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.STOP, function (e) {\r\n                self.uiSimulate(false, e.target);\r\n                self.wrap.simulateTrackEnd();\r\n                const btnPause = e.target.parentElement.querySelector(sel.PAUSE);\r\n                btnPause.classList.remove('play');\r\n                btnPause.setAttribute('title', self.getLocaleString('tr.lst.pause'));\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = 'x 1';\r\n                self.simulate_speed = 1;\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.PAUSE, function (e) {\r\n                self.simulate_paused = !e.target.classList.contains('play');\r\n                if (self.simulate_paused)\r\n                    self.simulate_pausedElapse = -1;\r\n\r\n                e.target.setAttribute('title', self.getLocaleString(self.simulate_paused ? 'tr.lst.play' : 'tr.lst.pause'));\r\n                e.target.classList.toggle('play', !!self.simulate_paused);\r\n            }));\r\n\r\n            var lapse = 0.5;\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.BACKWARD, function (e) {\r\n                if (self.simulate_speed == 1)\r\n                    self.simulate_speed = lapse;\r\n                else self.simulate_speed = self.simulate_speed / 2;\r\n\r\n                e.target.parentElement.querySelector(self._classSelector + \" \" + sel.FORWARD).disabled = false;\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = self.simulate_speed < 1 ? '/ ' + (1 / self.simulate_speed) : 'x ' + self.simulate_speed;\r\n\r\n                if (self.simulate_speed == 0.000244140625) {\r\n                    e.target.disabled = true;\r\n                }\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.FORWARD, function (e) {\r\n                self.simulate_speed = self.simulate_speed / lapse;\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = self.simulate_speed < 1 ? '/ ' + (1 / self.simulate_speed) : 'x ' + self.simulate_speed;\r\n\r\n                e.target.parentElement.querySelector(self._classSelector + \" \" + sel.BACKWARD).disabled = false;\r\n\r\n                if (self.simulate_speed == 4096) {\r\n                    e.target.disabled = true;\r\n                }\r\n            }));\r\n\r\n\r\n            // popup\r\n            self.track.trackContinue.addEventListener('click', function () {\r\n                // cerramos popup y continuamos con el track de session y almacenando en session\r\n                TC.Util.closeModal();\r\n                // al obtener la posición se almacena en session y continuamos almacenando en session mientras se mueve\r\n                _tracking.call(self);\r\n            });\r\n            self.track.trackRenew.addEventListener('click', function () {\r\n                // eliminamos el track actual de session - restablecemos el tracking\r\n                delete self.sessionTracking;\r\n                TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, undefined);\r\n                localforage.removeItem(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n                // cerramos el popup\r\n                TC.Util.closeModal();\r\n                // al obtener la posición se almacena en session y continuamos almacenando en session mientras se mueve\r\n                _tracking.call(self);\r\n            });\r\n            self.track.trackClose.addEventListener('click', function () {\r\n                _deactivateTrackingBtns.call(self);\r\n            });\r\n            //self.track.trackAddSegment.addEventListener('click', function () {\r\n            //    TC.alert('pendiente');\r\n            //    // cerramos el popup\r\n            //    TC.Util.closeModal();\r\n            //});\r\n\r\n            // popup advertencia\r\n            self.track.trackAdvertisementOK.addEventListener('click', function () {\r\n\r\n                const checkboxes = document.body.querySelectorAll('input[name*=\"Advertisement\"]:checked');\r\n\r\n                if (checkboxes.length > 0) {\r\n                    const promise = new Promise(function (resolve, reject) {\r\n                        if (window.localforage)\r\n                            resolve();\r\n                        else {\r\n                            TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                                resolve();\r\n                            });\r\n                        }\r\n                    });\r\n\r\n                    promise.then(function () {\r\n                        localforage.setItem(checkboxes[0].getAttribute('name'), false);\r\n                    });\r\n                }\r\n\r\n                TC.Util.closeModal();\r\n            });\r\n\r\n            self.track.renderTrack = document.querySelector('#tc-ctl-geolocation-track-render');\r\n            self.track.renderTrack.addEventListener('change', function () {\r\n                if (self.track.activateButton.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                    self.layerTracking.setVisibility(this.checked);\r\n                }\r\n\r\n                visibilityTrack = this.checked;\r\n            });\r\n\r\n            if (window.localforage)\r\n                self.bindTracks();\r\n            else {\r\n                TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                    self.bindTracks();\r\n                });\r\n            }\r\n\r\n            if (TC.Util.isFunction(callback)) {\r\n                callback();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.activate = function () {\r\n        var self = this;\r\n        //TC.Control.prototype.activate.call(self);\r\n    };\r\n\r\n    ctlProto.deactivate = function () {\r\n        var self = this;\r\n\r\n        TC.Util.closeModal();\r\n        self.clearSelection();\r\n        self.deactivateTracking();\r\n        //TC.Control.prototype.deactivate.call(self);\r\n    };\r\n\r\n    var _layerError = function () {\r\n        var self = this;\r\n\r\n        self.map.off(TC.Consts.event.LAYERERROR, _layerError);\r\n        self.clearFileInput(self.track.trackImportFile);\r\n\r\n        TC.alert(self.getLocaleString(\"geo.trk.upload.error3\"));\r\n    };\r\n    var _activateTrackingBtns = function () {\r\n        var self = this;\r\n\r\n        self.track.activateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        self.track.deactivateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    var _deactivateTrackingBtns = function () {\r\n        var self = this;\r\n\r\n        self.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n        self.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    var _showAlerMsg = function () {\r\n        var self = this;\r\n        self.map.toast(self.div.querySelector(\".alert-warning\").innerHTML, {\r\n            duration: 10000\r\n        });\r\n    };\r\n\r\n    ctlProto.markerStyle = {\r\n        radius: 7,\r\n        fillColor: [255, 0, 0, 100],\r\n        strokeColor: [255, 255, 255, 255],\r\n        strokeWidth: 2\r\n    };\r\n\r\n    ctlProto.lineStyle = {\r\n        strokeWidth: 2,\r\n        strokeColor: [0, 206, 209, 255]\r\n    };\r\n\r\n    ctlProto.setFormatInfoNewPosition = function (newPosition) {\r\n        var self = this;\r\n\r\n        var data = {};\r\n        var locale = TC.Util.getMapLocale(self.map);\r\n\r\n        if (self.map.on3DView) {\r\n            var geoCoords = self.map.crs !== self.map.view3D.crs ? TC.Util.reproject(newPosition.position, self.map.crs, self.map.view3D.crs) : newPosition.position;\r\n            data.x = geoCoords[0].toLocaleString(locale);\r\n            data.y = geoCoords[1].toLocaleString(locale);\r\n\r\n            data.mdt = Math.round(self.map.view3D.getHeightFromMDT(geoCoords)).toLocaleString(locale);\r\n\r\n            data.isGeo = true;\r\n\r\n        } else {\r\n            data.x = Math.round(newPosition.position[0]).toLocaleString(locale);\r\n            data.y = Math.round(newPosition.position[1]).toLocaleString(locale);\r\n        }\r\n\r\n        data.z = (Math.round(newPosition.altitude).toLocaleString(locale));\r\n        data.accuracy = (Math.round(newPosition.accuracy).toLocaleString(locale));\r\n        data.speed = newPosition.speed.toLocaleString(locale, { minimumFractionDigits: 1, maximumFractionDigits: 1 });\r\n\r\n        return data;\r\n    };\r\n\r\n    ctlProto.renderInfoNewPosition = function (d) {\r\n        var self = this;\r\n\r\n        self.getRenderedHtml(self.CLASS + '-tracking-toast', self.setFormatInfoNewPosition(d.pd), function (html) {\r\n\r\n            if (!self.track.infoPanel) {\r\n                self.track.infoPanel = true;\r\n\r\n                var resultsPanelOptions = {\r\n                    content: \"table\",\r\n                    titles: {\r\n                        main: self.getLocaleString(\"geo.mylocation\"),\r\n                        max: self.getLocaleString(\"geo.mylocation.show\")\r\n                    },\r\n                    classes: {\r\n                        collapsed: \"tracking\"\r\n                    }\r\n                };\r\n\r\n                var ctlPromise;\r\n                const addResultsPanelInfo = function (controlContainer) {\r\n                    resultsPanelOptions.side = controlContainer.SIDE.RIGHT;\r\n                    ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                };\r\n\r\n                if (self.options.displayOn) {\r\n                    var controlContainer = self.map.getControlsByClass('TC.control.' + self.options.displayOn[0].toUpperCase() + self.options.displayOn.substring(1))[0];\r\n                    if (!controlContainer) {\r\n                        self.map.addControl(self.options.displayOn).then(addResultsPanelInfo);\r\n                    } else {\r\n                        addResultsPanelInfo(controlContainer);\r\n                    }\r\n                } else {\r\n                    resultsPanelOptions.div = document.createElement('div');\r\n                    self.map.div.appendChild(resultsPanelOptions.div);\r\n                    ctlPromise = self.map.addControl('resultsPanel', resultsPanelOptions);\r\n                }\r\n\r\n                ctlPromise.then(function (resultsPanelInfo) {\r\n                    resultsPanelInfo.caller = self;\r\n                    self.map.getControlsByClass('TC.control.ResultsPanel').filter(function (panel) {\r\n                        return panel.content === \"table\" && panel !== resultsPanelInfo;\r\n                    }).forEach(function (panel) {\r\n                        panel.close();\r\n                    });\r\n\r\n                    self.track.infoPanel = resultsPanelInfo;\r\n\r\n                    resultsPanelInfo.renderPromise().then(function () {\r\n                        resultsPanelInfo.open(html);\r\n                    });\r\n                });\r\n            } else if (typeof (self.track.infoPanel) !== \"boolean\" && !self.track.infoPanel.isMinimized()) {\r\n                self.track.infoPanel.renderPromise().then(function () {\r\n                    self.track.infoPanel.getTableContainer().innerHTML = html;\r\n                    if (!self.track.infoPanel.isVisible()) {\r\n                        self.track.infoPanel.doVisible();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n\r\n    var duringTrackingToolsPanel = function () {\r\n        var self = this;\r\n\r\n        if (!self.track.trackToolPanelOpened.checked) {\r\n            self.map.trigger(TC.Consts.event.TOOLSCLOSE);\r\n        }\r\n    };\r\n\r\n    var _tracking = function () {\r\n        var self = this;\r\n\r\n        self.activate();\r\n\r\n        _activateTrackingBtns.call(self);\r\n        duringTrackingToolsPanel.call(self);\r\n\r\n        self.on(self.Const.Event.POSITIONCHANGE, function (d) {\r\n\r\n            self.currentPoint = d.pd;\r\n            self.renderInfoNewPosition(d);\r\n\r\n            self.track.trackName.disabled = false;\r\n            self.track.trackSave.disabled = false;\r\n\r\n            self.track.trackWPT.disabled = false;\r\n            self.track.trackAdd.disabled = false;\r\n\r\n            // cada vez que se registra una nueva posición almacenamos en sessionStorage\r\n            TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, self.wrap.formattedToStorage(self.layerTracking).features);\r\n        });\r\n        self.on(self.Const.Event.STATEUPDATED, function (data) {\r\n            //self.track.htmlMarker.setAttribute('src', data.moving ? 'layout/idena/img/geo-marker-heading.png' : 'layout/idena/img/geo-marker.png');\r\n        });\r\n\r\n        self.clear(self.Const.Layers.TRACKING);\r\n\r\n        advertisement.call(self, self.Const.LocalStorageKey.TRACKINGSHOWADVERTISEMENT);\r\n\r\n        self.wrap.setTracking(true);\r\n    };\r\n\r\n    /* inicio gestión suspensión de la pantalla en móviles */\r\n    var _onpauseVideo;\r\n    var addVideoKeepScreenOn = function () {\r\n        var self = this;\r\n\r\n        if (!self.videoScreenOn) {\r\n            var media = {\r\n                WebM: \"data:video/webm;base64,GkXfo0AgQoaBAUL3gQFC8oEEQvOBCEKCQAR3ZWJtQoeBAkKFgQIYU4BnQI0VSalmQCgq17FAAw9CQE2AQAZ3aGFtbXlXQUAGd2hhbW15RIlACECPQAAAAAAAFlSua0AxrkAu14EBY8WBAZyBACK1nEADdW5khkAFVl9WUDglhohAA1ZQOIOBAeBABrCBCLqBCB9DtnVAIueBAKNAHIEAAIAwAQCdASoIAAgAAUAmJaQAA3AA/vz0AAA=\",\r\n                MP4: \"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAB8JbCAfCWwgAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAD3wlsIB8JbCAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAIAAAACAAAAAABsW1kaWEAAAAgbWRoZAAAAAB8JbCAfCWwgAAAA+gAAAAAVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW9IYW5kbGVyAAAAAVxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEcc3RibAAAALhzdHNkAAAAAAAAAAEAAACobXA0dgAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAIAAgASAAAAEgAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABj//wAAAFJlc2RzAAAAAANEAAEABDwgEQAAAAADDUAAAAAABS0AAAGwAQAAAbWJEwAAAQAAAAEgAMSNiB9FAEQBFGMAAAGyTGF2YzUyLjg3LjQGAQIAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAK2lsc3QAAAAjqXRvbwAAABtkYXRhAAAAAQAAAABMYXZmNTIuNzguMw==\"\r\n            };\r\n\r\n            self.videoScreenOn = document.createElement('video');\r\n            self.videoScreenOn.setAttribute(\"loop\", \"\");\r\n            self.videoScreenOn.setAttribute(\"muted\", \"\");\r\n            self.videoScreenOn.setAttribute(\"webkit-playsinline\", \"\");\r\n            self.videoScreenOn.setAttribute(\"playsinline\", \"\");\r\n            self.videoScreenOn.setAttribute(\"style\", \"transform: translateZ(0px);\");\r\n\r\n            var sourceWebM = document.createElement('source');\r\n            sourceWebM.src = media.WebM;\r\n            sourceWebM.type = \"video/webm\";\r\n            self.videoScreenOn.appendChild(sourceWebM);\r\n\r\n            var sourceMP4 = document.createElement('source');\r\n            sourceMP4.src = media.MP4;\r\n            sourceMP4.type = \"video/mp4\";\r\n            self.videoScreenOn.appendChild(sourceMP4);\r\n        }\r\n\r\n        self.videoScreenOn.play();\r\n    };\r\n    var removeVideoKeepScreenOn = function () {\r\n        var self = this;\r\n        if (self.videoScreenOn) {\r\n            self.videoScreenOn.pause();\r\n        }\r\n    };\r\n\r\n    var _onWindowBlurred;\r\n    var onWindowBlurred = function () {\r\n        var self = this;\r\n\r\n        fromSessionToStorage.apply(self);\r\n    };\r\n\r\n    var _onWindowFocused;\r\n    var onWindowFocused = function () {\r\n        var self = this;\r\n\r\n        if (self.videoScreenOn.paused)\r\n            self.videoScreenOn.play();\r\n\r\n        fromStorageToSession.apply(self);\r\n    };\r\n\r\n    var getHiddenProperty = function () {\r\n        var prefixes = ['webkit', 'moz', 'ms', 'o'];\r\n\r\n        if ('hidden' in document) return 'hidden';\r\n\r\n        for (var i = 0; i < prefixes.length; i++) {\r\n            if ((prefixes[i] + 'Hidden') in document)\r\n                return prefixes[i] + 'Hidden';\r\n        }\r\n\r\n        return null;\r\n    };\r\n    var _onWindowVisibility;\r\n    var onWindowVisibility = function () {\r\n        var self = this;\r\n\r\n        var hidden = getHiddenProperty();\r\n\r\n        if (!document[hidden])\r\n            onWindowFocused.apply(self);\r\n\r\n        console.log('video is: ' + self.videoScreenOn.paused);\r\n    };\r\n    var addWindowEvents = function () {\r\n        var self = this;\r\n\r\n        if (!_onWindowVisibility)\r\n            _onWindowVisibility = onWindowVisibility.bind(self);\r\n\r\n        if (!_onWindowBlurred)\r\n            _onWindowBlurred = onWindowBlurred.bind(self);\r\n\r\n        if (!_onWindowFocused)\r\n            _onWindowFocused = onWindowFocused.bind(self);\r\n\r\n        window.addEventListener('visibilitychange', _onWindowVisibility, false);\r\n\r\n        // ipad / iphone / ipod (Safari mobile, not Android default browsers not Chrome Mobile that is)\r\n        if (TC.Util.detectSafari() && TC.browserFeatures.touch() && !navigator.userAgent.match(/Android/i) && !navigator.userAgent.match(/CriOS/i)) {\r\n            window.addEventListener('pagehide', _onWindowBlurred, false);\r\n            window.addEventListener('pageshow', _onWindowFocused, false);\r\n        } else { // the rest            \r\n            window.addEventListener('blur', _onWindowBlurred, false);\r\n            window.addEventListener('focus', _onWindowFocused, false);\r\n        }\r\n    }\r\n    var removeWindowEvents = function () {\r\n\r\n        window.removeEventListener('visibilitychange', _onWindowVisibility, false);\r\n\r\n        // ipad / iphone / ipod (Safari mobile, not Android default browsers not Chrome Mobile that is)\r\n        if (TC.Util.detectSafari() && TC.browserFeatures.touch() && !navigator.userAgent.match(/Android/i) && !navigator.userAgent.match(/CriOS/i)) {\r\n            window.removeEventListener('pagehide', _onWindowBlurred, false);\r\n            window.removeEventListener('pageshow', _onWindowFocused, false);\r\n        } else { // the rest            \r\n            window.removeEventListener('blur', _onWindowBlurred, false);\r\n            window.removeEventListener('focus', _onWindowFocused, false);\r\n        }\r\n    };\r\n\r\n    var fromSessionToStorage = function () {\r\n        var self = this;\r\n\r\n        var sessionTracking = TC.Util.storage.getSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n        if (sessionTracking && sessionTracking.length > 0)\r\n            localforage.setItem(self.Const.LocalStorageKey.TRACKINGTEMP, typeof (sessionTracking) === \"string\" ? sessionTracking : JSON.stringify(sessionTracking));\r\n    };\r\n    var fromStorageToSession = function () {\r\n        var self = this;\r\n\r\n        localforage.getItem(self.Const.LocalStorageKey.TRACKINGTEMP).then(function (storageData) {\r\n            if (storageData !== null && storageData !== \"null\" && storageData.length > 0) {\r\n                TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, storageData);\r\n            }\r\n        });\r\n    };\r\n    /* final gestión suspensión de la pantalla en móviles */\r\n\r\n    var advertisement = function (showAdvertisement) {\r\n        var self = this;\r\n\r\n        var done = new Promise(function (resolve, reject) {\r\n            if (window.localforage)\r\n                resolve();\r\n            else {\r\n                TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                    resolve();\r\n                });\r\n            }\r\n        });\r\n\r\n        done.then(function () {\r\n            localforage.getItem(showAdvertisement).then(function (registeredShowAdvertisement) {\r\n                if (registeredShowAdvertisement == null) {\r\n                    const dialog = self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-dialog');\r\n                    const checkbox = dialog.querySelector('input[type=\"checkbox\"]');\r\n                    checkbox.setAttribute('name', showAdvertisement);\r\n                    checkbox.checked = false;\r\n\r\n                    document.querySelector('#pageBlurMsg').textContent = TC.Util.detectMobile() ? self.getLocaleString('geo.trk.page.blur'): self.getLocaleString('geo.trk.page.blur.desktop');\r\n\r\n                    dialog.querySelector('h3').textContent = showAdvertisement == self.Const.LocalStorageKey.GPSSHOWADVERTISEMENT ?\r\n                        self.getLocaleString(\"geo.track.activate\") + \" \" + self.getLocaleString(\"geo.gps\") :\r\n                        self.getLocaleString('geo.track.activate.title');\r\n\r\n                    TC.Util.showModal(self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-dialog'));\r\n                }\r\n            });\r\n        });\r\n\r\n        self.map.toast(!TC.Util.detectMobile() ? self.getLocaleString('geo.trk.page.blur.desktop') : self.getLocaleString('geo.trk.page.blur'), {\r\n            type: TC.Consts.msgType.WARNING\r\n        });\r\n    };\r\n\r\n    ctlProto._askTracking = function (callback) {\r\n        var self = this;\r\n\r\n        TC.Util.showModal(self._dialogDiv.querySelector('.tc-ctl-geolocation-continue-track-dialog'), {\r\n            closeCallback: function () {\r\n\r\n                if (TC.Util.isFunction(callback)) {\r\n                    callback();\r\n                }\r\n            }\r\n        });\r\n\r\n        return true;\r\n    };\r\n\r\n    ctlProto.activateTracking = function () {\r\n        var self = this;\r\n        var trackingAvailable = true;\r\n\r\n        if (!self.isActive) {\r\n            self.activate();\r\n        }\r\n\r\n        self.clear(self.Const.Layers.TRACKING);\r\n\r\n        try {\r\n            TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TEST, self.Const.LocalStorageKey.TEST);\r\n        } catch (error) {\r\n            if (error.code === DOMException.QUOTA_EXCEEDED_ERR)\r\n                TC.alert(self.getLocaleString(\"geo.error.trackinglocalstorage\"));\r\n            else TC.error(error);\r\n\r\n            trackingAvailable = false;\r\n        }\r\n\r\n        if (trackingAvailable) {\r\n            addVideoKeepScreenOn.apply(self);\r\n            addWindowEvents.apply(self);\r\n\r\n            self.sessionTracking = TC.Util.storage.getSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n            if (self.sessionTracking) {\r\n                var asked = self._askTracking(function () {\r\n                    _deactivateTrackingBtns.call(self);\r\n                });\r\n\r\n                if (!asked) {\r\n                    self.track.trackRenew.click();\r\n                }\r\n            } else _tracking.call(self);\r\n        } else { _deactivateTrackingBtns.call(self); }\r\n    };\r\n\r\n    ctlProto.deactivateTracking = function () {\r\n        var self = this;\r\n\r\n        var _deactivateTracking = function () {\r\n\r\n            self.track.infoPanel.close();\r\n\r\n            fromSessionToStorage.apply(self);\r\n\r\n            self.wrap.setTracking(false);\r\n\r\n\r\n            delete self.geopositionTracking;\r\n\r\n            if (!visibilityTrack) {\r\n                self.div.querySelector(self._classSelector + '-track-render').querySelector('label').click();\r\n            }\r\n\r\n            removeVideoKeepScreenOn.apply(self);\r\n            removeWindowEvents.apply(self);\r\n\r\n            self.off(self.Const.Event.POSITIONCHANGE);\r\n            self.off(self.Const.Event.STATEUPDATED);\r\n\r\n            _deactivateTrackingBtns.call(self);\r\n\r\n            self.track.trackName.value = '';\r\n            self.track.trackName.disabled = true;\r\n            self.track.trackSave.disabled = true;\r\n\r\n            self.track.trackWPT.value = '';\r\n            self.track.trackWPT.disabled = true;\r\n            self.track.trackAdd.disabled = true;\r\n\r\n            self.clear(self.Const.Layers.TRACKING);\r\n            self.clear(self.Const.Layers.GPS);\r\n\r\n            //TC.Control.prototype.deactivate.call(self);\r\n\r\n            return true;\r\n        };\r\n\r\n        if (self.wrap.hasCoordinates()) {\r\n            self.map.toast(self.getLocaleString(\"geo.trk.deactivate.alert\"), {\r\n                duration: 10000\r\n            });\r\n            //TC.alert(self.getLocaleString(\"geo.trk.deactivate.alert\"));\r\n            return _deactivateTracking();\r\n        } else return _deactivateTracking();\r\n    };\r\n\r\n    /* Obtengo los tracks desde localForage */\r\n    ctlProto.getStoredTracks = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var tracks = [];\r\n\r\n            localforage.keys().then(function (keys) {\r\n                keys = keys.filter(function (k) {\r\n                    if (!(k.indexOf(self.Const.LocalStorageKey.TRACKINGTEMP) === 0) && k.indexOf(self.Const.LocalStorageKey.TRACKING) === 0) {\r\n                        return /trk#\\d/i.exec(k);\r\n                    }\r\n                    return false;\r\n                });\r\n\r\n                if (keys.length == 0) {\r\n                    self.availableTracks = tracks;\r\n                    resolve(tracks);\r\n                }\r\n\r\n                const promises = new Array(keys.length);\r\n                keys.forEach(function (key, idx) {\r\n                    promises[idx] = new Promise(function (res, rej) {\r\n                        localforage.getItem(key, function (e, v) {\r\n                            res(v);\r\n                        });\r\n                    });\r\n                });\r\n\r\n                Promise.all(promises).then(function (results) {\r\n                    if (results && results.length) {\r\n                        results.forEach(function (r) {\r\n                            var r = JSON.parse(r);\r\n                            if (r instanceof Array) {\r\n                                tracks = tracks.concat(r);\r\n                            } else {\r\n                                tracks.push(r);\r\n                            }\r\n                        });\r\n\r\n                        var tracksArray = tracks.length > 1 ? _orderTracks(tracks) : tracks;\r\n                        self.availableTracks = tracksArray;\r\n                        resolve(tracksArray);\r\n                    }\r\n                });\r\n            });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Recibe una sucesión de tracks y la ordena por nombre.\r\n     */\r\n    var _orderTracks = function (tracks) {\r\n        var tracksArray = [];\r\n\r\n        for (var index in tracks) {\r\n            if (tracks[index] && typeof (tracks[index]) === \"object\") {\r\n                tracksArray.push(tracks[index]);\r\n                tracksArray.sort(function (a, b) {\r\n                    if (typeof (a.name) === \"string\") {\r\n                        return TC.Util.isFunction(a.name.localeCompare) ? a.name.localeCompare(b.name) : 0;\r\n                    } else { return 0; }\r\n                });\r\n            }\r\n        }\r\n\r\n        return tracksArray;\r\n    };\r\n\r\n    /* Almaceno los tracks mediante localForage, actualizo la vble availableTracks y actualizo la lista de tracks */\r\n    ctlProto.setStoredTracks = function (tracks) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const promises = [];\r\n            tracks.forEach(function (t) {\r\n                promises.push(new Promise(function (res, rej) {\r\n                    localforage.setItem(self.Const.LocalStorageKey.TRACKING + \"#\" + t.uid, JSON.stringify(t), function (e, v) {\r\n                        res(v);\r\n                    });\r\n                }));\r\n            });\r\n\r\n            Promise.all(promises).then(function () {\r\n                self.getStoredTracks().then(function () {\r\n                    self.bindTracks();\r\n                    resolve();\r\n                });\r\n            });\r\n        });\r\n    };\r\n\r\n    /* Obtengo los tracks desde vble local */\r\n    ctlProto.getAvailableTracks = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            if (!self.availableTracks) {\r\n                self.getStoredTracks().then(function (availableTracks) {\r\n                    resolve(availableTracks);\r\n                });\r\n            }\r\n            else {\r\n                resolve(self.availableTracks);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.bindTracks = function () {\r\n        var self = this;\r\n\r\n        const listItems = self.track.trackList.querySelectorAll('li');\r\n        listItems.forEach(function (li) {\r\n            li.style.display = 'none';\r\n        });\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n\r\n            if (_isEmpty(tracks)) {\r\n                self.track.trackList.querySelectorAll('li[class^=\"tc-ctl-geolocation-track-available-empty\"]').forEach(function (li) {\r\n                    li.style.display = '';\r\n                });\r\n                self.track.trackSearch.disabled = true;\r\n            }\r\n            else {\r\n                const currentSelectedTrack = self.getSelectedTrack();\r\n                var currentSelectedTrackId;\r\n                if (currentSelectedTrack) {\r\n                    currentSelectedTrackId = currentSelectedTrack.dataset.uid\r\n                }\r\n                self.track.trackList.querySelectorAll('li[data-id]').forEach(function (li) {\r\n                    self.track.trackList.removeChild(li);\r\n                });\r\n\r\n                for (var i = 0; i < tracks.length; i++) {\r\n                    var t = tracks[i];\r\n                    if (typeof (t) === \"object\") {\r\n                        self.getRenderedHtml(self.CLASS + '-track-node', {\r\n                            id: i, uid: t.uid, name: t.name ? t.name.trim() : ''\r\n                        }, function (html) {\r\n                            const parser = new DOMParser();\r\n                            const newLi = parser.parseFromString(html, 'text/html').body.firstChild;\r\n                            self.track.trackList.appendChild(newLi);\r\n                        });\r\n                    }\r\n                }\r\n\r\n                if (currentSelectedTrackId) {\r\n                    self.setSelectedTrack(self.track.trackList.querySelector('li[data-uid=\"' + currentSelectedTrackId + '\"]'));\r\n                }\r\n\r\n                self.track.trackSearch.disabled = false;\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.chartProgressInit = function () {\r\n        const self = this;\r\n\r\n        if (!window.d3) {\r\n            TC.syncLoadJS(TC.Consts.url.D3C3);\r\n        }\r\n\r\n        const dataDiv = d3.select(\".c3-event-rects,.c3-event-rects-single\").node().getBoundingClientRect();\r\n        self.miDiv = document.createElement('div');\r\n        self.miDiv.classList.add('miDiv');\r\n        self.miDiv.style.width = dataDiv.width + 'px';\r\n        self.miDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miProgressDiv = document.createElement('div');\r\n        self.miProgressDiv.classList.add(\r\n            'miProgressDiv',\r\n            self.CLASS + '-track-elevation-chart-progress',\r\n            TC.Consts.classes.HIDDEN);\r\n        self.miProgressDiv.style.width = '0%';\r\n        self.miProgressDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miProgressTextDiv = document.createElement('div');\r\n        self.miProgressTextDiv.classList.add(\r\n            'miProgressTextDiv',\r\n            'tc-ctl-geolocation-track-elevation-chart-progress',\r\n            'text');\r\n        self.miProgressTextDiv.style.width = dataDiv.width + 'px';\r\n        self.miProgressTextDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miDiv.style.top = dataDiv.top + 'px';\r\n        self.miDiv.style.left = dataDiv.left + 'px';\r\n        self.miDiv.style.bottom = dataDiv.bottom + 'px';\r\n        self.miDiv.style.right = dataDiv.right + 'px';\r\n        self.miDiv.style.position = 'absolute';\r\n        self.miDiv.style.zIndex = 10008;\r\n        self.miDiv.style.display = 'none';\r\n\r\n        self.miProgressDiv.appendChild(self.miProgressTextDiv);\r\n        self.miDiv.appendChild(self.miProgressDiv);\r\n        document.body.appendChild(self.miDiv);\r\n\r\n    };\r\n\r\n    ctlProto.chartProgressClear = function () {\r\n        const self = this;\r\n        if (self.miDiv) {\r\n            self.miDiv.parentElement.removeChild(self.miDiv);\r\n            self.miDiv = null;\r\n            self.miProgressDiv = null;\r\n            self.miProgressTextDiv = null;\r\n        }\r\n    };\r\n\r\n    ctlProto.chartSetProgress = function (previous, current, distance, doneTime) {\r\n        var self = this;\r\n\r\n        if (self.miDiv && self.miDiv.style.display === 'none') {\r\n            self.miDiv.style.display = '';\r\n        }\r\n\r\n        self.miProgressDiv.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n        var done = previous.d;\r\n        var progress = (done + Math.hypot(previous.p[0] - current[0], previous.p[1] - current[1])) / distance * 100;\r\n\r\n        self.miProgressDiv.style.width = progress + '%';\r\n\r\n        var locale = self.map.options.locale && self.map.options.locale.replace('_', '-') || undefined;\r\n        var ele = parseInt(current[2].toFixed(0)).toLocaleString(locale);\r\n        var dist;\r\n        var measure;\r\n        if ((done / 1000) < 1) {\r\n            dist = Math.round((done / 1000) * 1000);\r\n            measure = ' m';\r\n        } else {\r\n            dist = Math.round((done / 1000) * 100) / 100;\r\n            measure = ' km';\r\n        }\r\n\r\n        dist = dist.toLocaleString(locale);\r\n\r\n        self.miProgressTextDiv.innerHTML = '<div><span>' + ele + ' m' + '</span>' + '<br>' + '<span>' + dist + measure + '</span></div>' + (doneTime ? '<br><span>' + doneTime.toString + '</span>' : '');\r\n\r\n    };\r\n\r\n    ctlProto._getTime = function (timeFrom, timeTo) {\r\n        var diff = timeTo - timeFrom;\r\n        var d = {};\r\n        var daysDifference = Math.floor(diff / 1000 / 60 / 60 / 24);\r\n        diff -= daysDifference * 1000 * 60 * 60 * 24;\r\n\r\n        var hoursDifference = Math.floor(diff / 1000 / 60 / 60);\r\n        diff -= hoursDifference * 1000 * 60 * 60;\r\n\r\n        d.h = hoursDifference + (daysDifference * 24);\r\n\r\n        var minutesDifference = Math.floor(diff / 1000 / 60);\r\n        diff -= minutesDifference * 1000 * 60;\r\n\r\n        d.m = minutesDifference;\r\n\r\n        d.s = Math.floor(diff / 1000);\r\n\r\n        return TC.Util.extend({}, d, { toString: (\"00000\" + d.h).slice(-2) + ':' + (\"00000\" + d.m).slice(-2) + ':' + (\"00000\" + d.s).slice(-2) });\r\n    };\r\n\r\n    ctlProto.simulateTrack = function (li) {\r\n        var self = this;\r\n\r\n        self.simulate_speed = 1;\r\n\r\n        self.drawTrack(li, false).then(function () {\r\n            self.wrap.simulateTrack();\r\n        });\r\n    };\r\n\r\n    ctlProto.drawTrack = function (li, activateSnapping) {\r\n        var self = this;\r\n\r\n        duringTrackingToolsPanel.call(self);\r\n        return new Promise(function (resolve, reject) {\r\n            self.setSelectedTrack(li);\r\n            self.drawTrackingData(li).then(function () {\r\n                self.elevationTrack(li);\r\n\r\n                self.activate();\r\n                resolve();\r\n            });\r\n        });\r\n    };\r\n\r\n\r\n    ctlProto.elevationTrack = function (li, resized) {\r\n        var self = this;\r\n\r\n        if (resized) {            \r\n\r\n            self.wrap.simulateTrackEnd();\r\n            self.uiSimulate(false, li);\r\n            return;\r\n        }\r\n\r\n        if (!self.onResize) {\r\n            self.onResize = self.elevationTrack.bind(self, li, true);\r\n            window.addEventListener(\"resize\", self.onResize, false);\r\n        }\r\n\r\n        self.chart = {\r\n            coordinates: []\r\n        };\r\n\r\n        if (self.track.elevationChart)\r\n            self.track.elevationChart = self.track.elevationChart.destroy();\r\n\r\n        var getChartData = function (li) {\r\n            return new Promise(function (resolve, reject) {\r\n                TC.loadJS(\r\n                    !TC.tool || !TC.tool.Elevation,\r\n                    TC.apiLocation + 'TC/tool/Elevation',\r\n                    function () {\r\n                        self.getTrackingData(li).then(function (track) {\r\n                            var geoJSON = track.data;\r\n                            if (geoJSON) {\r\n                                var x, ele; x = []; ele = [];\r\n                                var empty = true;\r\n                                var minEle, maxEle;\r\n                                var elevationGain = {};\r\n                                var time = {};\r\n                                var km = 0;\r\n                                var geom;\r\n\r\n                                var f = (new ol.format.GeoJSON()).readFeatures(geoJSON);\r\n\r\n                                var getDistance = function () {\r\n                                    if (geom.getLayout() == ol.geom.GeometryLayout.XYZ ||\r\n                                        geom.getLayout() == ol.geom.GeometryLayout.XYZM) {\r\n                                        var distance = 0;\r\n                                        if (self.map.crs !== self.map.options.utmCrs) {\r\n                                            line = new ol.geom.LineString(TC.Util.reproject(geom.getCoordinates(), self.map.crs, self.map.options.utmCrs));\r\n                                            distance = line.getLength();\r\n                                        } else {\r\n                                            distance = geom.getLength();\r\n                                        }\r\n                                        return parseFloat((distance / 1000).toFixed(2));\r\n                                    }\r\n\r\n                                    return null;\r\n                                };\r\n                                var getTime = function () {\r\n                                    if (geom.getLayout() == ol.geom.GeometryLayout.XYZM ||\r\n                                        geom.getLayout() == ol.geom.GeometryLayout.XYM) {\r\n                                        var diff = geom.getLastCoordinate()[3] - geom.getFirstCoordinate()[3];\r\n                                        return {\r\n                                            s: Math.floor((diff / 1000) % 60),\r\n                                            m: Math.floor(((diff / (1000 * 60)) % 60)),\r\n                                            h: Math.floor(((diff / (1000 * 60 * 60)) % 24))\r\n                                        };\r\n                                    }\r\n\r\n                                    return null;\r\n                                };\r\n\r\n                                var addX = function (x) {\r\n                                    if (self.chart.coordinates.length > 0) {\r\n                                        var distance = 0;\r\n                                        self.chart.coordinates\r\n                                            .forEach(function (point, idx, arr) {\r\n                                                var prev = idx === 0 ? point : arr[idx - 1];\r\n\r\n                                                if (self.map.crs !== self.map.options.utmCrs) {\r\n                                                    point = TC.Util.reproject(point, self.map.crs, self.map.options.utmCrs);\r\n                                                    prev = TC.Util.reproject(prev, self.map.crs, self.map.options.utmCrs);\r\n                                                }\r\n\r\n                                                const dx = point[0] - prev[0];\r\n                                                const dy = point[1] - prev[1];\r\n                                                distance += Math.sqrt(dx * dx + dy * dy);\r\n\r\n                                                x.push(parseFloat(distance.toFixed(2)));\r\n                                            });\r\n                                    }\r\n                                };\r\n\r\n                                var addElevation = function (ele) {\r\n                                    var y = [];\r\n                                    for (var i = 0; i < self.chart.coordinates.length; i++) {\r\n                                        if (self.chart.coordinates[i].length > 2) {\r\n                                            var v = (Math.round(self.chart.coordinates[i][2] * 10) / 10);\r\n                                            if (empty && v > 0)\r\n                                                empty = false;\r\n\r\n                                            ele.push(v);\r\n\r\n                                            if (i == 0)\r\n                                                minEle = maxEle = v;\r\n\r\n                                            minEle = Math.min(minEle, v);\r\n                                            maxEle = Math.max(maxEle, v);\r\n\r\n                                        }\r\n                                        else {\r\n                                            resolve(null);\r\n                                            return;\r\n                                        }\r\n                                    }\r\n                                };\r\n\r\n                                f.filter(function (feature) {\r\n                                    return feature.getGeometry().getType().toLowerCase() === 'linestring' || feature.getGeometry().getType().toLowerCase() === 'multilinestring';\r\n                                }).forEach(function (feature) {\r\n                                    geom = feature.getGeometry();\r\n\r\n                                    switch (geom.getType().toLowerCase()) {\r\n                                        case 'linestring':\r\n\r\n                                            if (track.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                track.layout === ol.geom.GeometryLayout.XYZ) {\r\n\r\n                                                time = getTime(geom);\r\n                                                km = getDistance(geom);\r\n                                                elevationGain = TC.tool.Elevation.getElevationGain({ coords: geom.getCoordinates(), hillDeltaThreshold: self.gapHill });\r\n                                                self.chart.coordinates = self.chart.coordinates.concat(geom.getCoordinates());\r\n\r\n                                                addX(x);\r\n                                                addElevation(ele);\r\n                                            }\r\n                                            break;\r\n                                        case 'multilinestring':\r\n\r\n                                            if (track.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                track.layout === ol.geom.GeometryLayout.XYZ) {\r\n\r\n                                                var _time;\r\n                                                var ls = geom.getLineStrings();\r\n                                                for (var i = 0; i < ls.length; i++) {\r\n                                                    km = km + getDistance(ls[i]);\r\n\r\n                                                    if (ls[i].getLayout() == ol.geom.GeometryLayout.XYZM)\r\n                                                        _time = _time + (ls[i].getLastCoordinate()[3] - ls[i].getFirstCoordinate()[3]);\r\n\r\n                                                    self.chart.coordinates = self.chart.coordinates.concat(ls[i].getCoordinates());\r\n\r\n                                                    if (_time) { time = getTime(_time); }\r\n\r\n                                                    addX(x);\r\n                                                    addElevation(ele);\r\n                                                }\r\n                                            }\r\n\r\n                                            break;\r\n                                        default:\r\n                                            return null;\r\n                                            break;\r\n                                    }\r\n                                });\r\n\r\n                                if (ele instanceof Array && ele.length == 0) {\r\n                                    empty = true;\r\n                                }\r\n\r\n                                self.chartData = !empty ? TC.Util.extend({}, { time: time, ele: ele, x: x, miny: minEle, maxy: maxEle }, elevationGain) : null;\r\n\r\n                                resolve(self.chartData);\r\n                                return;\r\n                            }\r\n\r\n                            resolve(null);\r\n                            return;\r\n                        });\r\n                    }\r\n                );\r\n            });\r\n        };\r\n\r\n        getChartData(li).then(function (data) {\r\n            var locale = TC.Util.getMapLocale(self.map);\r\n            if (data != null) {\r\n                if (data.time) data.time = (\"00000\" + data.time.h).slice(-2) + ':' + (\"00000\" + data.time.m).slice(-2) + ':' + (\"00000\" + data.time.s).slice(-2);\r\n                data.coords = self.chart.coordinates;\r\n                self.hasElevation = true;\r\n            }\r\n            else {\r\n                self.hasElevation = false;\r\n                data = {\r\n                    msg: self.getLocaleString(\"geo.trk.chart.chpe.empty\")\r\n                };\r\n            }\r\n\r\n            data.minHeight = self.CHART_SIZE.MIN_HEIGHT;\r\n            data.maxHeight = self.CHART_SIZE.MAX_HEIGHT;\r\n\r\n            data.minWidth = self.CHART_SIZE.MIN_WIDTH;\r\n            data.mediumWidth = self.CHART_SIZE.MEDIUM_WIDTH;\r\n            data.maxWidth = self.CHART_SIZE.MAX_WIDTH;\r\n\r\n            self.map.one(TC.Consts.event.DRAWCHART, function (e) {\r\n                self.chartProgressInit();\r\n            });\r\n\r\n            if (!self.resultsPanelChart) {\r\n\r\n                if (!window.c3) {\r\n                    TC.syncLoadJS(TC.Consts.url.D3C3 || TC.apiLocation + 'lib/d3c3/d3c3.min.js');\r\n                }\r\n\r\n                var resultsPanelOptions = {\r\n                    content: \"chart\",\r\n                    titles: {\r\n                        main: self.getLocaleString(\"geo.trk.chart.chpe\"),\r\n                        max: self.getLocaleString(\"geo.trk.chart.chpe\")\r\n                    },\r\n                    openOn: self.Const.Event.DRAWTRACK,\r\n                    closeOn: self.Const.Event.CLEARTRACK,\r\n                    chart: {\r\n                        ctx: self,\r\n                        onmouseout: ctlProto.removeElevationTooltip,\r\n                        tooltip: ctlProto.getElevationTooltip\r\n                    }\r\n                };\r\n\r\n                var ctlPromise;\r\n                const addResultsPanelChart = function (controlContainer) {\r\n                    resultsPanelOptions.side = controlContainer.SIDE.RIGHT;\r\n                    ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                };\r\n\r\n                if (self.options.displayOn) {\r\n                    var controlContainer = self.map.getControlsByClass('TC.control.' + self.options.displayOn[0].toUpperCase() + self.options.displayOn.substring(1))[0];\r\n                    if (!controlContainer) {\r\n                        self.map.addControl(self.options.displayOn).then(addResultsPanelChart);\r\n                    } else {\r\n                        addResultsPanelChart(controlContainer);\r\n                    }\r\n                } else {\r\n                    resultsPanelOptions.div = document.createElement('div');\r\n                    self.map.div.appendChild(resultsPanelOptions.div);\r\n                    ctlPromise = self.map.addControl('resultsPanel', resultsPanelOptions);\r\n                }\r\n\r\n                ctlPromise.then(function (resultsPanelChart) {\r\n                    resultsPanelChart.caller = self;\r\n                    self.resultsPanelChart = resultsPanelChart;\r\n                    resultsPanelChart.renderPromise().then(function () {\r\n\r\n                        resultsPanelChart.activateSnapping = function (e) {\r\n                            if (self.layerTrack && (!self.layerTrack.getVisibility() && self.layerTrack.getOpacity() == 0))\r\n                                self.wrap.deactivateSnapping.call(self.wrap);\r\n                        };\r\n                        resultsPanelChart.deactivateSnapping = function (e) {\r\n                            if (self.layerTrack && self.layerTrack.getVisibility() && self.layerTrack.getOpacity() > 0)\r\n                                self.wrap.activateSnapping.call(self.wrap);\r\n                        };\r\n\r\n                        resultsPanelChart.div.addEventListener('mouseover', resultsPanelChart.deactivateSnapping);\r\n                        resultsPanelChart.div.addEventListener('mouseout', resultsPanelChart.activateSnapping);\r\n\r\n                        self.map\r\n                            .on(TC.Consts.event.RESULTSPANELMIN, function () {\r\n                                if (self.miDiv) {\r\n                                    self.miDiv.style.display = 'none';\r\n                                }\r\n                            })\r\n                            .on(TC.Consts.event.RESULTSPANELMAX, function () {\r\n                                if (self.miDiv) {\r\n                                    self.miDiv.style.display = '';\r\n                                }\r\n                            })\r\n                            .on(TC.Consts.event.RESULTSPANELCLOSE, function () {\r\n                                if (self.miDiv) {\r\n                                    self.miDiv.style.display = 'none';\r\n                                }\r\n                            });\r\n\r\n                        self.map.trigger(self.Const.Event.DRAWTRACK, { data: data });\r\n                    });\r\n                });\r\n            } else {\r\n                self.resultsPanelChart.open();\r\n                self.map.trigger(self.Const.Event.DRAWTRACK, { data: data });\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.clear = function (layerType) {\r\n        var self = this;\r\n\r\n        if (self.onResize) {\r\n            window.removeEventListener(\"resize\", self.onResize, false);\r\n            self.onResize = undefined;\r\n        }\r\n\r\n        if (layerType == self.Const.Layers.TRACK) {\r\n\r\n            self.layerTrack.clearFeatures();\r\n\r\n            // gráfico perfil de elevación\r\n            if (self.resultsPanelChart)\r\n                self.resultsPanelChart.close();\r\n            delete self.chartData;\r\n\r\n            // overlay de la simulación\r\n            self.wrap.simulateTrackEnd();\r\n\r\n            self.wrap.clear();\r\n\r\n            // eliminamos la selección en la lista de tracks\r\n            self.track.trackList.querySelectorAll('li').forEach(function (li) {\r\n                li.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n            });\r\n\r\n            self.map.trigger(self.Const.Event.CLEARTRACK);\r\n\r\n            self.featuresToShare = [];\r\n\r\n            //TC.Control.prototype.deactivate.call(self);\r\n\r\n        } else {\r\n            self.layerTracking.clearFeatures();\r\n            self.layerGPS.clearFeatures();\r\n        }\r\n    };\r\n\r\n    ctlProto.saveTrack = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            var message = options.message || self.getLocaleString(\"geo.trk.save.alert\");\r\n\r\n            var _save = function (layer) {\r\n                var wait;\r\n                wait = self.getLoadingIndicator().addWait();\r\n\r\n                var trackName = options.importedFileName || self.track.trackName.value.trim();\r\n\r\n                var tracks = self.availableTracks;\r\n                if (!tracks) {\r\n                    tracks = [];\r\n                }\r\n\r\n                var formatted = self.wrap.formattedToStorage(layer, true, options.notReproject);\r\n\r\n                var clean = function (wait) {\r\n                    self.track.trackName.value = '';\r\n                    self.track.trackName.disabled = true;\r\n                    self.track.trackSave.disabled = true;\r\n\r\n                    self.track.trackWPT.value = '';\r\n                    self.track.trackWPT.disabled = true;\r\n                    self.track.trackAdd.disabled = true;\r\n\r\n                    self.getLoadingIndicator().removeWait(wait);\r\n\r\n                    duringTrackingToolsPanel.call(self);\r\n                };\r\n\r\n                var newTrack = {\r\n                    name: trackName,\r\n                    data: formatted.features,\r\n                    layout: formatted.layout,\r\n                    crs: self.storageCRS\r\n                };\r\n\r\n                TC.loadJS(\r\n                    !window.hex_md5,\r\n                    [TC.apiLocation + TC.Consts.url.HASH],\r\n                    function () {\r\n                        var hash = hex_md5(JSON.stringify(newTrack));\r\n\r\n                        var sameTrackUID = tracks.map(function (savedTrack) {\r\n                            var clonedTrack = JSON.parse(JSON.stringify(savedTrack));\r\n                            delete clonedTrack.uid;\r\n                            if (hash === hex_md5(JSON.stringify(clonedTrack))) {\r\n                                return savedTrack.uid;\r\n                            } else {\r\n                                const jsonFormat = new ol.format.GeoJSON();\r\n                                // validamos si se trata de un track exportado/importado ya que se compacta la geometría\r\n                                var features = jsonFormat.readFeatures(clonedTrack.data);\r\n                                // Aplicamos una precisión un dígito mayor que la del mapa, si no, al compartir algunas parcelas se deforman demasiado\r\n                                var precision = Math.pow(10, TC.Consts.DEGREE_PRECISION + 1);\r\n\r\n                                features.forEach(function (feature) {\r\n                                    var geom = TC.Util.explodeGeometry(TC.Util.compactGeometry(feature.getGeometry().getCoordinates(), precision));\r\n                                    feature.getGeometry().setCoordinates(geom);\r\n                                });\r\n\r\n                                clonedTrack.data = jsonFormat.writeFeatures(features);\r\n\r\n                                if (hash === hex_md5(JSON.stringify(clonedTrack))) {\r\n                                    return savedTrack.uid;\r\n                                } else {\r\n                                    return null;\r\n                                }\r\n                            }\r\n\r\n                        }).filter(function (uid) {\r\n                            return uid !== null\r\n                        });\r\n\r\n                        const getTrackIndex = function (uid) {\r\n                            return self.getStoredTracks().then(function () {\r\n                                self.bindTracks();\r\n\r\n                                var index;\r\n                                for (var i = 0; i < self.availableTracks.length; i++) {\r\n                                    if (self.availableTracks[i].uid === uid) {\r\n                                        index = i;\r\n                                        break;\r\n                                    }\r\n                                }\r\n\r\n                                return index;\r\n                            });\r\n                        };\r\n\r\n                        if (sameTrackUID.length === 0) {\r\n\r\n                            newTrack.uid = Date.now() + Math.random();\r\n                            tracks.push(newTrack);\r\n                            tracks = _orderTracks(tracks);\r\n\r\n                            try {\r\n                                self.setStoredTracks(tracks).then(function () {\r\n                                    self.map.toast(message, { duration: 3000 });\r\n\r\n                                    clean(wait);\r\n\r\n                                    getTrackIndex(newTrack.uid).then(function (index) {\r\n                                        resolve(index);\r\n                                    });\r\n                                });\r\n\r\n                            } catch (error) {\r\n                                TC.alert(self.getLocaleString(\"geo.error.savelocalstorage\") + ': ' + error.message);\r\n                                clean(wait);\r\n                                reject();\r\n                            }\r\n                        } else {\r\n                            console.log('Ya existe un track con ese mismo hash');\r\n\r\n                            clean(wait);\r\n\r\n                            getTrackIndex(sameTrackUID[0]).then(function (index) {\r\n                                resolve(index);\r\n                            });\r\n                        }\r\n                    });\r\n\r\n            };\r\n\r\n            const createTCFeatures = function (features) {\r\n                return new Promise(function (resolve, reject) {\r\n                    var featurePromises = features.filter(function (feature) {\r\n                        return !feature._wrap;\r\n                    }).forEach(function (elm) {\r\n                        return TC.wrap.Feature.createFeature(elm);\r\n                    });\r\n\r\n                    Promise.all(featurePromises).then(function (tcFeatures) {\r\n                        resolve();\r\n                    });\r\n                });\r\n            };\r\n\r\n            if (self.importedFileName)\r\n                _save(self.layerTrack);\r\n            else if (self.track.trackName.value.trim().length == 0) {\r\n                self.track.trackName.value = new Date().toLocaleString();\r\n                _save(self.layerTracking);\r\n            }\r\n            else {\r\n                _save(self.layerTracking);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.addWaypoint = function () {\r\n        var self = this;\r\n\r\n        var waypointName = self.track.trackWPT.value.trim();\r\n        if (!waypointName) {\r\n            waypointName = new Date().toLocaleString();\r\n        }\r\n\r\n        var wait = self.getLoadingIndicator().addWait();\r\n\r\n        duringTrackingToolsPanel.call(self);\r\n\r\n        self.wrap.addWaypoint(self.currentPoint.position, {\r\n            name: waypointName,\r\n            ele: self.currentPoint.heading,\r\n            time: new Date().getTime() // GLS: lo quito ya que hemos actualizado la función que gestiona la fechas para la exportación a GPX - espera la fecha en segundos -> / 1000 // para la exportación a GPX - espera la fecha en segundos\r\n        });\r\n\r\n        self.track.trackWPT.value = '';\r\n        self.track.trackWPT.disabled = true;\r\n        self.track.trackAdd.disabled = true;\r\n\r\n        // cada vez que se añade un waypoint almacenamos en sessionStorage\r\n        TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, self.wrap.formattedToStorage(self.layerTracking).features);\r\n\r\n        self.getLoadingIndicator().removeWait(wait);\r\n    };\r\n\r\n    ctlProto.editTrackName = function (trackId, newName) {\r\n        var self = this;\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n            if (tracks) {\r\n                if (tracks[trackId]) {\r\n                    tracks[trackId].name = newName;\r\n\r\n                    self.setStoredTracks(tracks);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.removeTrack = function (li) {\r\n        var self = this;\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n            if (tracks) {\r\n                var dataId = li.dataset.id;\r\n                if (tracks[dataId]) {\r\n                    var uid = tracks[dataId].uid;\r\n\r\n                    TC.confirm(self.getLocaleString(\"geo.trk.delete.alert\"), function () {\r\n\r\n                        const selectedTrack = self.getSelectedTrack();\r\n                        if (selectedTrack && selectedTrack.dataset.id === dataId) {\r\n                            self.clear(self.Const.Layers.TRACK);\r\n                        }\r\n\r\n                        localforage.removeItem(self.Const.LocalStorageKey.TRACKING + '#' + uid).then(function () {\r\n                            self.getStoredTracks().then(function () {\r\n                                self.bindTracks();\r\n                            });\r\n                        }).catch(function (err) {\r\n                            console.log(err);\r\n                        });\r\n\r\n                    }, function () { });\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.setSelectedTrack = function (li) {\r\n        var self = this;\r\n\r\n        if (!self.isActive) {\r\n            self.activate();\r\n        }\r\n\r\n        self.track.trackList.querySelectorAll('li[data-id] > span').forEach(function (span) {\r\n            span.setAttribute('title', span.textContent);\r\n        });\r\n        self.track.trackList.querySelectorAll('li').forEach(function (li) {\r\n            li.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n        });\r\n\r\n        li.classList.add(self.Const.Classes.SELECTEDTRACK);\r\n\r\n        li.setAttribute('title', self.getLocaleString(\"tr.lst.clear\") + \" \" + li.querySelector('span').textContent);\r\n        li.querySelector(self.Const.Selector.DRAW).setAttribute('title', li.getAttribute('title'));\r\n    };\r\n\r\n    ctlProto.getSelectedTrack = function () {\r\n        var self = this;\r\n\r\n        return self.track.trackList.querySelector('li.' + self.Const.Classes.SELECTEDTRACK);\r\n    };\r\n\r\n    ctlProto.clearSelectedTrack = function () {\r\n        const self = this;\r\n\r\n        const selected = self.getSelectedTrack();\r\n        if (selected) {\r\n\r\n            if (self.onResize) {\r\n                window.removeEventListener('resize', self.onResize, false);\r\n                self.onResize = undefined;\r\n            }\r\n\r\n            selected.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n            selected.setAttribute('title', selected.textContent);\r\n            selected.querySelector(self.Const.Selector.DRAW).setAttribute('title', selected.getAttribute('title'));\r\n        }\r\n    };\r\n\r\n    ctlProto.clearSelection = function () {\r\n        var self = this;\r\n\r\n        self.wrap.deactivateSnapping();\r\n        var selected = self.getSelectedTrack();\r\n        if (selected) {\r\n            self.clearSelectedTrack();\r\n        }\r\n        if (self.resultsPanelChart) {\r\n\r\n            self.resultsPanelChart.div.removeEventListener('mouseover', self.resultsPanelChart.deactivateSnapping);\r\n            self.resultsPanelChart.div.removeEventListener('mouseout', self.resultsPanelChart.activateSnapping);\r\n\r\n            self.resultsPanelChart.close();\r\n        }\r\n\r\n        self.clear(self.Const.Layers.TRACK);\r\n    };\r\n\r\n    ctlProto.drawTrackingData = function (li) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            self.wrap.clear();\r\n\r\n            self.getTrackingData(li).then(function (track) {\r\n                var data = track.data;\r\n                if (track.data)\r\n                    self.wrap.drawTrackingData(track).then(function () {\r\n                        var showFeatures = self.layerTrack.features;\r\n                        if (showFeatures && showFeatures.length > 0) {\r\n\r\n                            var coordinates = showFeatures.filter(function (feature) {\r\n                                feature.showsPopup = false;\r\n                                if (TC.feature.MultiPolyline && feature instanceof TC.feature.MultiPolyline) {\r\n                                    return true;\r\n                                } else if (feature instanceof TC.feature.Polyline) {\r\n                                    return true;\r\n                                }\r\n                                return false;\r\n                            }).map(function (feature) {\r\n                                if (TC.feature.MultiPolyline && feature instanceof TC.feature.MultiPolyline) {\r\n                                    return feature.geometry[0];\r\n                                } else if (feature instanceof TC.feature.Polyline) {\r\n                                    return feature.geometry;\r\n                                }\r\n                            })[0];\r\n\r\n                            if (coordinates) {\r\n                                var first = coordinates[0];\r\n                                var last = coordinates[coordinates.length - 1];\r\n\r\n                                if (first && !(first === last)) {\r\n                                    self.layerTrack.addMarker(first.slice().splice(0, 2), {\r\n                                        showsPopup: false, cssClass: self.CLASS + '-track-marker-icon-end', anchor: [0.5, 1], notExport: true\r\n                                    });\r\n                                }\r\n\r\n                                if (last) {\r\n                                    self.layerTrack.addMarker(last.slice().splice(0, 2), {\r\n                                        showsPopup: false, cssClass: self.CLASS + '-track-marker-icon', anchor: [0.5, 1], notExport: true\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                        self.layerTrack.setVisibility(true);\r\n                        resolve();\r\n                    });\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.getTrackingData = function (li) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            self.getAvailableTracks().then(function (tracks) {\r\n                if (tracks) {\r\n                    const dataId = li.dataset.id;\r\n                    if (tracks[dataId]) {\r\n                        var track = tracks[dataId].data;\r\n\r\n                        // GLS: tengo que transformar de 4326 al crs del mapa en el momento de pintar, porque si lo hacemos al cargar la lista\r\n                        // y después hay cambio de crs, en el momento de pintar no sé desde qué crs debo tranformar\r\n                        track = self.wrap.formattedFromStorage(track);\r\n\r\n                        resolve({ data: track, layout: tracks[dataId].layout });\r\n                    }\r\n                } else {\r\n                    resolve();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.export = function (type, li) {\r\n        var self = this;\r\n\r\n        return self.wrap.export(type, li);\r\n    };\r\n\r\n    ctlProto.getElevationTooltip = function (d) {\r\n        const self = this;\r\n        self.wrap.showElevationMarker(d);\r\n\r\n        return self.resultsPanelChart.getElevationChartTooltip(d);\r\n    };\r\n\r\n    ctlProto.removeElevationTooltip = function () {\r\n        var self = this;\r\n        self.wrap.hideElevationMarker();\r\n    }\r\n\r\n    ctlProto.clearFileInput = function (fileInput) {\r\n        const form = document.createElement('form');\r\n        const parent = fileInput.parentElement;\r\n        parent.insertBefore(form, fileInput);\r\n        form.appendChild(fileInput);\r\n        form.reset();\r\n        // Desenvolvemos el input del form\r\n        form.insertAdjacentElement('afterend', fileInput);\r\n        parent.removeChild(form);\r\n    };\r\n\r\n    ctlProto.getLoadingIndicator = function () {\r\n        var self = this;\r\n\r\n        if (!self.loading) {\r\n            self.loading = self.map.getControlsByClass(TC.control.LoadingIndicator);\r\n            if (self.loading && self.loading.length > 0)\r\n                self.loading = self.loading[0];\r\n        }\r\n\r\n        return self.loading;\r\n    };\r\n\r\n    ctlProto.onGeolocateError = function (error) {\r\n        var self = this;\r\n\r\n        if (navigator.geolocation) {\r\n            if (self.currentPosition)\r\n                navigator.geolocation.clearWatch(self.currentPosition);\r\n            if (self.currentPositionTrk) {\r\n                self.currentPositionTrk = self.currentPositionTrk instanceof Array ? self.currentPositionTrk : [self.currentPositionTrk];\r\n\r\n                self.currentPositionTrk.forEach(function (watch) {\r\n                    navigator.geolocation.clearWatch(watch);\r\n                });\r\n\r\n                self.currentPositionTrk = [];\r\n            }\r\n        }\r\n\r\n        if (self.currentPositionWaiting)\r\n            self.getLoadingIndicator().removeWait(self.currentPositionWaiting);\r\n\r\n        var errorMsg;\r\n        switch (error.code) {\r\n            case error.PERMISSION_DENIED:\r\n                errorMsg = self.getLocaleString(\"geo.error.permission_denied\");\r\n                break;\r\n            case error.POSITION_UNAVAILABLE:\r\n                errorMsg = self.getLocaleString(\"geo.error.position_unavailable\");\r\n                break;\r\n            case error.TIMEOUT:\r\n                errorMsg = self.getLocaleString(\"geo.error.timeout\");\r\n                break;\r\n            default:\r\n                errorMsg = self.getLocaleString(\"geo.error.default\");\r\n                break;\r\n        }\r\n\r\n        self.map.toast(errorMsg, { type: TC.Consts.msgType.WARNING });\r\n\r\n        if (!self.geopositionTracking && self.track) {\r\n            self.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n            self.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n    var _isEmpty = function (obj) {\r\n        return !obj || obj.length === 0;\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState) {\r\n            const state = {};\r\n            if (self.layerTrack) {\r\n                var features = self.layerTrack.features;\r\n\r\n                if (features.length > 0 && self.featuresToShare && self.featuresToShare.length > 0) {\r\n                    state.features = self.featuresToShare;\r\n                } else {\r\n                    const layerState = self.layerTrack.exportState({\r\n                        features: features\r\n                    });\r\n\r\n                    state.features = layerState.features;\r\n                }\r\n\r\n                state.id = self.id;\r\n                const selectedTrack = self.getSelectedTrack();\r\n                if (selectedTrack) {\r\n                    state.trackName = selectedTrack.querySelector('span').innerHTML;\r\n                }\r\n                return state;\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        if (self.map) {\r\n            if (state.features && state.features.length) {\r\n                self.enable();\r\n\r\n                if (state.features.length > 0) {\r\n                    const promises = new Array(state.features.length);\r\n                    state.features.forEach(function (f, idx) {\r\n                        const featureOptions = { data: f.data, id: f.id, showsPopup: f.showsPopup };\r\n                        var addFn;\r\n                        var geom = TC.Util.explodeGeometry(f.geom);\r\n                        switch (f.type) {\r\n                            case TC.Consts.geom.POLYLINE:\r\n                                promises[idx] = new TC.feature.Polyline(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.MULTIPOLYLINE:\r\n                                promises[idx] = new TC.feature.MultiPolyline(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.MARKER:\r\n                                promises[idx] = new TC.feature.Marker(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.POINT:\r\n                                promises[idx] = new TC.feature.Point(geom, featureOptions);\r\n                                break;\r\n                        }\r\n                    });\r\n\r\n                    Promise.all(promises).then(function (tcFeatures) {\r\n                        var options = { features: tcFeatures, fileName: state.trackName, notReproject: true, isShared: true };\r\n                        if (!self.availableTracks) {\r\n                            self.getStoredTracks().then(function () {\r\n                                self.importTrack(options);\r\n                            });\r\n                        } else {\r\n                            self.importTrack(options);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n})();"]}