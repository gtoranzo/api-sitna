{"version":3,"sources":["control/Geolocation.js"],"names":["Math","hypot","y","length","arguments","i","Infinity","sqrt","lastTime","vendors","hasPerformance","window","performance","now","x","max","requestAnimationFrame","cancelAnimationFrame","callback","element","currTime","Date","getTime","timeToCall","id","setTimeout","clearTimeout","rAF","startTime","timestamp","offset","this","TC","control","Control","syncLoadJS","apiLocation","Geolocation","options","_classSelector","CLASS","_layerPromises","Const","Classes","ACTIVE","CLOSED","SELECTEDTRACK","DRAWACTIVATED","SIMULATIONACTIVATED","Selector","SIMULATE","DRAW","EDIT","DELETE","SAVE","CANCEL","EXPORT","STOP","PAUSE","BACKWARD","FORWARD","SPEED","LocalStorageKey","TRACKING","TRACKINGTEMP","TRACKINGSHOWADVERTISEMENT","GPSSHOWADVERTISEMENT","TEST","Message","VALIDATENAME","Event","POSITIONCHANGE","GPSPOSITIONCHANGE","GPSPOSITIONERROR","STATEUPDATED","GPSADD","TRACKSNAPPING","DRAWTRACK","CLEARTRACK","IMPORTEDTRACK","MimeMap","KML","GPX","SupportedFileExtensions","Tabs","GPS","Layers","TRACK","apply","opts","_dialogDiv","Util","getDiv","dialogDiv","$","_$dialogDiv","document","body","appendChild","delta","walkingSpeed","gapHill","snappingTolerance","exportsState","storageCRS","inherit","ctlProto","prototype","CHART_SIZE","MIN_HEIGHT","MAX_HEIGHT","MIN_WIDTH","MEDIUM_WIDTH","MAX_WIDTH","featuresToShare","Consts","event","TOOLSCLOSE","TOOLSOPEN","template","dust","register","body_0","chk","ctx","w","h","$key","f","get","__dustBody","block","body_1","else","body_2","body_3","body_4","body_5","body_6","body_8","body_7","key","value","body_10","body_9","onFeatureRemove","e","self","layer","layerTrack","clearSelection","map","result","call","wrap","addLayer","getUID","type","layerType","VECTOR","owner","stealth","title","then","layerGPS","styles","point","radius","fillColor","fillOpacity","track","renderTrack","checked","bind","strokeColor","fontColor","labelOutlineColor","labelOutlineWidth","label","feature","name","getData","trim","toLowerCase","line","strokeOpacity","strokeWidth","lineDash","layerTracking","fontSize","on","FEATURESIMPORT","fileName","target","dropTarget","kmlPattern","format","gpxPattern","indexOf","clear","importTrack","test","features","forEach","Point","setStyle","Polyline","PROJECTIONCHANGE","elevationChartData","coords","reproject","oldCrs","newCrs","render","getRenderedHtml","html","innerHTML","renderData","controlId","off","FEATUREREMOVE","isDisabled","toast","getLocaleString","msgType","WARNING","wait","getLoadingIndicator","addWait","importedFileName","addPromises","len","push","addFeature","Promise","all","processImportedFeatures","notReproject","layout","accordion","div","classList","contains","classes","COLLAPSED","controls","filter","ctl","containerControl","add","remove","querySelector","click","isShared","trigger","prepareFeaturesToShare","trackUid","resolve","reject","storageData","availableTracks","saved","uid","toString","data","precision","pow","DEGREE_PRECISION","storageFeatures","ol","GeoJSON","readFeatures","promises","Array","idx","Feature","createFeature","tcFeatures","fObj","Marker","geom","MARKER","POINT","POLYLINE","MultiPolyline","MULTIPOLYLINE","compactGeometry","geometry","visibilityTrack","sel","querySelectorAll","span","addEventListener","CLICK","tagName","parentElement","newFormat","option","toggle","HIDDEN","matches","activateButton","deactivateButton","trackSearch","trackImportFile","trackSave","trackAdd","trackContinue","trackRenew","trackClose","trackAdvertisementOK","trackList","trackToolPanelOpened","_showAlerMsg","trackName","trackWPT","detectMobile","matchMedia","File","FileReader","FileList","Blob","disabled","form","createElement","parent","insertBefore","reset","insertAdjacentElement","removeChild","_layerError","LAYERERROR","clearFileInput","alert","_cleaning","loadFiles","files","console","log","activateTracking","_activateTrackingBtns","deactivateTracking","_deactivateTrackingBtns","trackSearchListener","searchTerm","lis","from","li","style","display","trackLis","searchIcon","visibility","r","RegExp","textContent","some","_filter","saveTrack","addWaypoint","list","_edit","edit","elm","input","focus","uiSimulate","simulate","editControls","simulateControls","cnt","parentNode","hidden","EventTarget","listenerBySelector","_loadTrack","removeWait","_drawTrack","listElement","index","scrollTop","offsetHeight","_stopOtherTracks","trackLiId","listItem","dataset","btnSimulate","btnPause","setAttribute","btnDraw","trackLi","getSelectedTrack","drawTrack","simulate_paused","simulateTrack","removeTrack","editTrackName","export","getDownloadDialog","dialog","filename","regex","join","cleanFilename","replace","elevation","resolution","sampleNumber","open","removeAttribute","simulateTrackEnd","simulate_speed","simulate_pausedElapse","closeModal","_tracking","sessionTracking","storage","setSessionLocalValue","undefined","localforage","removeItem","checkboxes","loadJS","url","LOCALFORAGE","setItem","getAttribute","setVisibility","bindTracks","isFunction","activate","deactivate","duration","markerStyle","lineStyle","setFormatInfoNewPosition","newPosition","locale","getMapLocale","on3DView","geoCoords","crs","view3D","position","toLocaleString","mdt","round","getHeightFromMDT","isGeo","z","altitude","accuracy","speed","minimumFractionDigits","maximumFractionDigits","renderInfoNewPosition","d","pd","infoPanel","isMinimized","renderPromise","getTableContainer","isVisible","doVisible","ctlPromise","resultsPanelOptions","content","titles","main","collapsed","addResultsPanelInfo","controlContainer","POSITION","RIGHT","addControl","displayOn","getControlsByClass","toUpperCase","substring","resultsPanelInfo","panel","close","_onWindowBlurred","_onWindowFocused","_onWindowVisibility","duringTrackingToolsPanel","currentPoint","formattedToStorage","advertisement","setTracking","onWindowFocused","videoScreenOn","paused","play","fromStorageToSession","onWindowVisibility","prefixes","getHiddenProperty","addWindowEvents","fromSessionToStorage","detectSafari","browserFeatures","touch","navigator","userAgent","match","getSessionLocalValue","JSON","stringify","getItem","showAdvertisement","registeredShowAdvertisement","checkbox","showModal","_askTracking","closeCallback","trackingAvailable","isActive","error","code","DOMException","QUOTA_EXCEEDED_ERR","media","WebM","MP4","sourceWebM","src","sourceMP4","_deactivateTracking","geopositionTracking","pause","removeEventListener","hasCoordinates","getStoredTracks","tracks","keys","k","exec","res","rej","v","results","parse","concat","tracksArray","_orderTracks","sort","a","b","localeCompare","setStoredTracks","t","getAvailableTracks","_isEmpty","currentSelectedTrack","currentSelectedTrackId","newLi","DOMParser","parseFromString","firstChild","setSelectedTrack","chartProgressInit","d3","D3C3","dataDiv","select","node","getBoundingClientRect","miDiv","width","height","miProgressDiv","miProgressTextDiv","top","left","bottom","right","zIndex","chartProgressClear","chartSetProgress","previous","current","distance","doneTime","done","progress","p","dist","measure","ele","parseInt","toFixed","_getTime","timeFrom","timeTo","diff","daysDifference","floor","hoursDifference","minutesDifference","m","s","extend","slice","activateSnapping","drawTrackingData","elevationTrack","resized","setCurrentFeature","resultsPanelChart","currentFeature","onResize","chartCoordinates","elevationChart","destroy","tool","Elevation","getTrackingData","geoJSON","minEle","maxEle","empty","elevationGain","time","getDistance","getLayout","GeometryLayout","XYZ","XYZM","utmCrs","LineString","getCoordinates","getLength","parseFloat","XYM","getLastCoordinate","getFirstCoordinate","addX","arr","prev","dx","dy","addElevation","min","getGeometry","getType","getElevationGain","hillDeltaThreshold","_time","ls","getLineStrings","miny","maxy","getChartData","hasElevation","msg","minHeight","maxHeight","minWidth","mediumWidth","maxWidth","one","DRAWCHART","c3","openOn","closeOn","chart","onmouseout","removeElevationTooltip","tooltip","getElevationTooltip","addResultsPanelChart","caller","getVisibility","getOpacity","deactivateSnapping","RESULTSPANELMIN","RESULTSPANELMAX","RESULTSPANELCLOSE","clearFeatures","message","_save","formatted","clean","newTrack","hex_md5","HASH","hash","sameTrackUID","savedTrack","clonedTrack","jsonFormat","explodeGeometry","setCoordinates","writeFeatures","getTrackIndex","random","waypointName","heading","trackId","newName","dataId","confirm","selectedTrack","catch","err","clearSelectedTrack","selected","showFeatures","coordinates","showsPopup","first","last","addMarker","splice","cssClass","anchor","notExport","formattedFromStorage","showElevationMarker","getElevationChartTooltip","hideElevationMarker","fileInput","loading","LoadingIndicator","onGeolocateError","errorMsg","geolocation","currentPosition","clearWatch","currentPositionTrk","watch","currentPositionWaiting","PERMISSION_DENIED","POSITION_UNAVAILABLE","TIMEOUT","obj","exportState","state","layerState","importState","enable","featureOptions","_downloadDialog"],"mappings":"AACIA,KAAKC,MAAQD,KAAKC,OAAS,WAIvB,IAHA,IAAIC,EAAI,EACJC,EAASC,UAAUD,OAEdE,EAAI,EAAGA,EAAIF,EAAQE,IAAK,CAC7B,GAAID,UAAUC,KAAOC,EAAAA,GAAYF,UAAUC,MAAO,EAAA,EAC9C,OAAOC,EAAAA,EAEXJ,GAAKE,UAAUC,GAAKD,UAAUC,GAElC,OAAOL,KAAKO,KAAKL,KAGzB,WAMI,IALA,IAAIM,EAAW,EACXC,EAAU,CAAC,KAAM,MAAO,SAAU,KAElCC,KAAoBC,OAAOC,cAAeD,OAAOC,YAAYC,KAExDC,EAAI,EAAGC,EAAMN,EAAQN,OAAQW,EAAIC,IAAQJ,OAAOK,sBAAuBF,GAAK,EAAG,CACpFH,OAAOK,sBAAwBL,OAAOF,EAAQK,GAAK,yBACnDH,OAAOM,qBAAuBN,OAAOF,EAAQK,GAAK,yBAC3CH,OAAOF,EAAQK,GAAK,+BAG1BH,OAAOK,wBACRL,OAAOK,sBAAwB,SAAUE,EAAUC,GAC/C,IAAIC,GAAW,IAAIC,MAAOC,UACtBC,EAAavB,KAAKe,IAAI,EAAG,IAAMK,EAAWZ,IAC1CgB,EAAKb,OAAOc,WAAW,WAAcP,EAASE,EAAWG,IACzDA,GACJf,EAAWY,EAAWG,EACtB,OAAOC,IAIVb,OAAOM,uBACRN,OAAOM,qBAAuB,SAAUO,GACpCE,aAAaF,KAKrB,IAAKd,EAAgB,CAEjB,IAAIiB,EAAMhB,OAAOK,sBACbY,GAAa,IAAIP,KAGrBV,OAAOK,sBAAwB,SAAUE,EAAUC,GAU/CQ,EARc,SAAUE,GAIpB,OAAOX,EAFqBW,EAAY,KAAQA,EAAYA,EAAYD,IAM/DT,KA9CzB,IAkDC,WAEG,GAAKR,OAAOC,aAOL,GAAID,OAAOC,cAAgBD,OAAOC,YAAYC,IAAK,CACtDF,OAAOC,YAAYkB,OAAST,KAAKR,MACjCF,OAAOC,YAAYC,IAAM,WACrB,OAAOQ,KAAKR,MAAQF,OAAOC,YAAYkB,cAT3CnB,OAAOC,YAAc,CACjBkB,OAAQT,KAAKR,MACbA,IAAK,WACD,OAAOQ,KAAKR,MAAQkB,KAAKD,SANzC,GAiBAE,GAAGC,QAAUD,GAAGC,SAAW,GAEtBD,GAAGE,SACJF,GAAGG,WAAWH,GAAGI,YAAc,cAGnCJ,GAAGC,QAAQI,YAAc,SAAUC,GACpBP,KACNQ,eAAiB,IADXR,KACsBS,MADtBT,KAGNU,eAAiB,GAHXV,KAKNW,MAAQ,CACTC,QAAS,CACLC,OAAQ,4BACRC,OAAQ,SACRC,cAAe,gBACfC,cAAe,iBACfC,oBAAqB,wBAEzBC,SAAU,CACNC,SAAU,mBACVC,KAAM,WACNC,KAAM,eACNC,OAAQ,iBACRC,KAAM,eACNC,OAAQ,iBACRC,OAAQ,iBACRC,KAAM,eACNC,MAAO,gBACPC,SAAU,mBACVC,QAAS,kBACTC,MAAO,iBAEXC,gBAAiB,CACbC,SAAU,MACVC,aAAc,UACdC,0BAA2B,mBAC3BC,qBAAsB,mBACtBC,KAAM,QAEVC,QAAS,CACLC,aAAc,IAElBC,MAAO,CACHC,eAAgB,gCAChBC,kBAAmB,mCACnBC,iBAAkB,+BAClBC,aAAc,8BACdC,OAAQ,wBACRC,cAAe,+BACfC,UAAW,2BACXC,WAAY,4BACZC,cAAe,gCAEnBC,QAAS,CACLC,IAAK,uCACLC,IAAK,uBAETC,wBAAyB,CACrB,OACA,QAEJC,KAAM,CACFC,IAAK,OAETC,OAAQ,CACJD,IAAK,MACLE,MAAO,QACPxB,SAAU,aAIlB/B,GAAGE,QAAQsD,MAlEAzD,KAkEY3B,WAEvB,IAAIqF,EAAOnD,GAAW,GApEXP,KAqEN2D,WAAa1D,GAAG2D,KAAKC,OAAOH,EAAKI,WAClClF,OAAOmF,IAtEA/D,KAuEFgE,YAAcD,EAvEZ/D,KAuEmB2D,aAEzBD,EAAKI,WACNG,SAASC,KAAKC,YA1EPnE,KA0EwB2D,YA1ExB3D,KA4ENoE,MAAQ,IA5EFpE,KA6ENqE,aAAe,IA7ETrE,KA8ENsE,QA9EMtE,KA8ESO,QAAQ+D,SAAW,GA9E5BtE,KAgFNuE,kBAhFMvE,KAgFmBO,QAAQgE,mBAAqB,GAhFhDvE,KAkFNwE,cAAe,EAlFTxE,KAoFNyE,WAAa,aAGtBxE,GAAGyE,QAAQzE,GAAGC,QAAQI,YAAaL,GAAGE,UAEtC,WACI,IAAIwE,EAAW1E,GAAGC,QAAQI,YAAYsE,UAEtCD,EAASlE,MAAQ,qBAEjBkE,EAASE,WAAa,CAClBC,WAAY,GACZC,WAAY,IAEZC,UAAW,IACXC,aAAc,IACdC,UAAW,KAGfP,EAASQ,gBAAkB,GAE3BlF,GAAGmF,OAAOC,MAAMC,WAAarF,GAAGmF,OAAOC,MAAMC,YAAc,gBAC3DrF,GAAGmF,OAAOC,MAAME,UAAYtF,GAAGmF,OAAOC,MAAME,WAAa,eAEzDZ,EAASa,SAAW,GACpBb,EAASa,SAASb,EAASlE,OAAS,WAAWgF,KAAKC,SAASf,EAASlE,MAAMkF,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,QAAQF,EAAE,ubAAgcG,EAAEJ,EAAIK,IAAI,CAAC,cAAc,GAAOL,EAAI,KAAKC,EAAE,iFAAqFG,EAAEJ,EAAIK,IAAI,CAAC,cAAc,GAAOL,EAAI,KAAKC,EAAE,aAAeC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,yBAAyBF,EAAE,MAAOC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,yBAAyBF,EAAE,qFAAwFC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,yBAAyBF,EAAE,8KAAsLC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,qEAA4EC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,YAAYF,EAAE,wEAA2EC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,qBAAqBF,EAAE,sEAA6EC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,eAAeF,EAAE,yaAAsbC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,kMAA2MC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,iBAAiBF,EAAE,sEAAwEC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,cAAcF,EAAE,6GAAkHG,EAAEJ,EAAIK,IAAI,CAAC,cAAc,GAAOL,EAAI,KAAKC,EAAE,6JAAuKG,EAAEJ,EAAIK,IAAI,CAAC,cAAc,GAAOL,EAAI,KAAKC,EAAE,aAAeC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,0BAA0BF,EAAE,MAAOC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,uBAAuBF,EAAE,6JAAmKC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,gCAAgCC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,aAAaC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,aAAaC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,aAAaC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,yKAA8KG,EAAEJ,EAAIK,IAAI,CAAC,cAAc,GAAOL,EAAI,KAAKC,EAAE,mFAAuFG,EAAEJ,EAAIK,IAAI,CAAC,cAAc,GAAOL,EAAI,KAAKC,EAAE,qDAAyDC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,mBAAmBF,EAAE,MAAOC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,mBAAmBF,EAAE,uGAA0GC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,6BAA6BF,EAAE,MAAOC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,uBAAuBF,EAAE,8GAAiHC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,+BAA+BF,EAAE,MAAOC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,yBAAyBF,EAAE,0LAAiMC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,sBAAsBF,EAAE,+GAAqHC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,sBAAsBF,EAAE,6GAAmHC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,qBAAqBF,EAAE,kHAAwHC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,qBAAqBF,EAAE,mHAAuHC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,mBAAmBF,EAAE,qBAAuBH,EAAOQ,YAAW,EAAG,OAAOR,GACxsKhB,EAASa,SAASb,EAASlE,MAAQ,eAAiB,WAAWgF,KAAKC,SAASf,EAASlE,MAAQ,cAAckF,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,iBAAkBG,EAAEJ,EAAIK,IAAI,CAAC,OAAO,GAAOL,EAAI,KAAKC,EAAE,gBAAkBG,EAAEJ,EAAIK,IAAI,CAAC,QAAQ,GAAOL,EAAI,KAAKC,EAAE,iDAAqDG,EAAEJ,EAAIK,IAAI,CAAC,SAAS,GAAOL,EAAI,KAAKC,EAAE,MAAOG,EAAEJ,EAAIK,IAAI,CAAC,SAAS,GAAOL,EAAI,KAAKC,EAAE,kEAAuEG,EAAEJ,EAAIK,IAAI,CAAC,SAAS,GAAOL,EAAI,KAAKC,EAAE,mDAAuDC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,yDAA6DC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,gBAAgBF,EAAE,kDAAsDC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,gBAAgBF,EAAE,0DAA8DC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,iBAAiBF,EAAE,iEAAqEC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,yDAA6DC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,2DAA+DC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,mBAAmBF,EAAE,oEAAwEC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,SAASF,EAAE,8DAAkEC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,kBAAkBF,EAAE,oDAAwDC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,kBAAkBF,EAAE,oDAAwDC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,aAAaF,EAAE,wBAA0BH,EAAOQ,YAAW,EAAG,OAAOR,GAC7qDhB,EAASa,SAASb,EAASlE,MAAQ,wBAA0B,WAAWgF,KAAKC,SAASf,EAASlE,MAAQ,uBAAuBkF,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQ/G,EAAE8G,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,CAACO,MAAQC,GAAQ,IAAIP,EAAE,eAAe/G,EAAE8G,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,CAACS,KAAOC,EAAOH,MAAQI,GAAQ,IAAIV,EAAE,aAAaG,EAAEJ,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,KAAKC,EAAE,oBAAoB/G,EAAE8G,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,CAACS,KAAOG,EAAOL,MAAQM,GAAQ,IAAIZ,EAAE,aAAaG,EAAEJ,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,KAAKC,EAAE,UAAU/G,EAAE8G,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,CAACO,MAAQO,GAAQ,IAAI5H,EAAE8G,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,CAACO,MAAQQ,GAAQ,IAAId,EAAE,SAAUH,EAAOQ,YAAW,EAAG,SAASE,EAAOT,EAAIC,GAAK,OAAOD,EAAIE,EAAE,cAAcC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,0BAA0BF,EAAE,aAAaG,EAAEJ,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,KAAKC,EAAE,SAAUO,EAAOF,YAAW,EAAG,SAASI,EAAOX,EAAIC,GAAK,OAAOD,EAAIE,EAAE,KAAMS,EAAOJ,YAAW,EAAG,SAASK,EAAOZ,EAAIC,GAAK,OAAOD,EAAIG,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,QAASQ,EAAOL,YAAW,EAAG,SAASM,EAAOb,EAAIC,GAAK,OAAOD,EAAIE,EAAE,KAAMW,EAAON,YAAW,EAAG,SAASO,EAAOd,EAAIC,GAAK,OAAOD,EAAIG,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,QAASU,EAAOP,YAAW,EAAG,SAASQ,EAAOf,EAAIC,GAAK,OAAOD,EAAIG,EAAE,KAAKF,EAAI,CAACO,MAAQS,GAAQ,CAACC,IAAMjB,EAAIK,IAAI,CAAC,MAAM,GAAOa,MAAQ,IAAKJ,EAAOR,YAAW,EAAG,SAASU,EAAOjB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,yBAAyBG,EAAEJ,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,KAAKC,EAAE,UAAWe,EAAOV,YAAW,EAAG,SAASS,EAAOhB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,SAASG,EAAEJ,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,KAAKC,EAAE,UAAWc,EAAOT,YAAW,EAAG,OAAOR,GACx+ChB,EAASa,SAASb,EAASlE,MAAQ,WAAa,WAAWgF,KAAKC,SAASf,EAASlE,MAAQ,UAAUkF,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,wLAAgMC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,YAAYF,EAAE,yIAA+IC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,uBAAuBF,EAAE,sEAAwEC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,uBAAuBF,EAAE,oEAAsEC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,0BAA0BF,EAAE,kNAA0NC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,6BAA6BF,EAAE,gGAAsGC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,sBAAsBF,EAAE,+IAAuJC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,iCAAiCF,EAAE,0HAA8HC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,OAAOF,EAAE,gCAAiCH,EAAOQ,YAAW,EAAG,OAAOR,GAChoDhB,EAASa,SAASb,EAASlE,MAAQ,mBAAqB,WAAWgF,KAAKC,SAASf,EAASlE,MAAQ,kBAAkBkF,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,4DAA8D/G,EAAE8G,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,CAACS,KAAOD,EAAOD,MAAQG,GAAQ,IAAIT,EAAE,eAAeG,EAAEJ,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,KAAKC,EAAE,UAAU/G,EAAE8G,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACO,MAAQI,GAAQ,IAAIV,EAAE,iBAAiB/G,EAAE8G,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,CAACS,KAAOG,EAAOL,MAAQM,GAAQ,IAAIZ,EAAE,eAAeG,EAAEJ,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,KAAKC,EAAE,UAAU/G,EAAE8G,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,CAACO,MAAQO,GAAQ,IAAIb,EAAE,aAAa/G,EAAE8G,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,CAACO,MAAQS,GAAQ,IAAI9H,EAAE8G,EAAIK,IAAI,CAAC,QAAQ,GAAOL,EAAI,CAACO,MAAQY,GAAS,IAAIlB,EAAE,qBAAsBH,EAAOQ,YAAW,EAAG,SAASE,EAAOT,EAAIC,GAAK,OAAOD,EAAIE,EAAE,KAAMO,EAAOF,YAAW,EAAG,SAASI,EAAOX,EAAIC,GAAK,OAAOD,EAAIG,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,QAASO,EAAOJ,YAAW,EAAG,SAASK,EAAOZ,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,qBAAqBF,EAAE,eAAeG,EAAEJ,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,KAAKC,EAAE,YAAaU,EAAOL,YAAW,EAAG,SAASM,EAAOb,EAAIC,GAAK,OAAOD,EAAIE,EAAE,KAAMW,EAAON,YAAW,EAAG,SAASO,EAAOd,EAAIC,GAAK,OAAOD,EAAIG,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,QAASU,EAAOP,YAAW,EAAG,SAASQ,EAAOf,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,kBAAkBF,EAAE,cAAcG,EAAEJ,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,KAAKC,EAAE,cAAea,EAAOR,YAAW,EAAG,SAASU,EAAOjB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQ/G,EAAE8G,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,CAACS,KAAOM,EAAOR,MAAQa,GAAQ,IAAInB,EAAE,eAAeG,EAAEJ,EAAIK,IAAI,CAAC,MAAM,GAAOL,EAAI,KAAKC,EAAE,YAAae,EAAOV,YAAW,EAAG,SAASS,EAAOhB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,KAAMc,EAAOT,YAAW,EAAG,SAASc,EAAOrB,EAAIC,GAAK,OAAOD,EAAIG,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,QAASiB,EAAOd,YAAW,EAAG,SAASa,EAAQpB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,eAAgBC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,eAAeF,EAAE,MAAOC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,QAAQF,EAAE,MAAMC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,QAAQF,EAAE,eAAeG,EAAEJ,EAAIK,IAAI,CAAC,QAAQ,GAAOL,EAAI,KAAKC,EAAE,YAAakB,EAAQb,YAAW,EAAG,OAAOR,GAErhE,IAAIuB,EAAkB,SAAUC,GAC5B,MAAMC,EAAOpH,KACCmH,EAAEE,MAEZF,EAAEE,QAAUD,EAAKE,YACjBF,EAAKG,kBAIb5C,EAASe,SAAW,SAAU8B,GAC1B,MAAMJ,EAAOpH,KACPyH,EAASxH,GAAGE,QAAQyE,UAAUc,SAASgC,KAAKN,EAAMI,GAExDJ,EAAKO,KAAO,IAAI1H,GAAG0H,KAAKzH,QAAQI,YAAY8G,GAC5CA,EAAKO,KAAKjC,SAAS8B,GAEnBA,EAAII,SAAS,CACTnI,GAAI2H,EAAKS,SACTC,KAAM7H,GAAGmF,OAAO2C,UAAUC,OAC1BC,MAAOb,EACPc,SAAS,EACTC,MAAO,mBACRC,KAAK,SAAUf,GACdD,EAAKiB,SAAWhB,IAEpBG,EAAII,SAAS,CACTnI,GAAI2H,EAAKS,SACTC,KAAM7H,GAAGmF,OAAO2C,UAAUC,OAC1BC,MAAOb,EACPc,SAAS,EACTC,MAAO,sBACPG,OAAQ,CACJC,MAAO,CACHC,OAAQ,EACRC,UAAW,UACXC,YAAa,WACT,OAAO1I,KAAK2I,MAAMC,YAAYC,QAAU,EAAI,GAC9CC,KAAK1B,GACP2B,YAAa,UACbC,UAAW,UACXC,kBAAmB,UACnBC,kBAAmB,EACnBC,MAAO,SAAUC,GACb,IAAIC,EAAOD,EAAQE,UAAgB,KAOnC,OALID,EADAA,IAASA,EAAO,IAAIE,OAAOnL,OAAS,GAC5BiL,EAAO,IAAIE,OAAOC,cAEnB,KAMnBC,KAAM,CACFC,cAAe,WACX,OAAO1J,KAAK2I,MAAMC,YAAYC,QAAU,EAAI,GAC9CC,KAAK1B,GACPuC,YAAa,EACbZ,YAAa,UACba,SAAU,CAAC,GAAI,OAGxBxB,KAAK,SAAUf,GACdD,EAAKyC,cAAgBxC,IAEzBG,EAAII,SAAS,CACTnI,GAAI2H,EAAKS,SACTC,KAAM7H,GAAGmF,OAAO2C,UAAUC,OAC1BC,MAAOb,EACPc,SAAS,EACTC,MAAO,mBACPG,OAAQ,CACJmB,KAAM,CACFE,YAAa,EACbZ,YAAa,WAEjBR,MAAO,CACHC,OAAQ,SAAUY,GACd,IAAIC,EAAOD,EAAQE,UAAgB,KACnC,OAAID,IAASA,EAAO,IAAIE,OAAOnL,OAAS,EAC7B,EAEA,GAKfqK,UAAW,UACXM,YAAa,UACbC,UAAW,UACXc,SAAU,GACVb,kBAAmB,UACnBC,kBAAmB,EACnBC,MAAO,SAAUC,GACb,IAAIC,EAAOD,EAAQE,UAAgB,KAOnC,OALID,EADAA,IAASA,EAAO,IAAIE,OAAOnL,OAAS,GAC5BiL,EAAO,IAAIE,OAAOC,cAEnB,QAOxBpB,KAAK,SAAUf,GACdD,EAAKE,WAAaD,IAGtBG,EAAIuC,GAAG9J,GAAGmF,OAAOC,MAAM2E,eAAgB,SAAU7C,GAC7C,MAAMC,EAAOpH,KACPiK,EAAW9C,EAAE8C,SACbC,EAAS/C,EAAEgD,WACjB,IAAIC,EAAa,IAAMnK,GAAGmF,OAAOiF,OAAOnH,IAAIsG,cACxCc,EAAa,IAAMrK,GAAGmF,OAAOiF,OAAOlH,IAAIqG,cAG5C,GAAIS,EAAST,cAAce,QAAQD,KAAgBL,EAAS7L,OAASkM,EAAWlM,QAE3E6L,EAAST,cAAce,QAAQH,KAAgBH,EAAS7L,OAASgM,EAAWhM,QAAU8L,IAAW9C,EAFtG,CAIIA,EAAKoD,MAAMpD,EAAKzG,MAAM4C,OAAOC,OAC7B4D,EAAKqD,YAAYtD,GAEb,SAASuD,KAAKT,EAAST,gBAAkBpC,EAAKE,YAC1CF,EAAKE,WAAWgB,QAChBlB,EAAKE,WAAWqD,SAASC,QAAQ,SAAUxB,GACnCA,aAAmBnJ,GAAGmJ,QAAQyB,OAASzD,EAAKE,WAAWgB,OAAOC,MAC9Da,EAAQ0B,SAAS1D,EAAKE,WAAWgB,OAAOC,OACjCa,aAAmBnJ,GAAGmJ,QAAQ2B,UAAY3D,EAAKE,WAAWgB,OAAOmB,MACxEL,EAAQ0B,SAAS1D,EAAKE,WAAWgB,OAAOmB,UAS9DX,KAAK1B,IAEPI,EAAIuC,GAAG9J,GAAGmF,OAAOC,MAAM2F,iBAAkB,SAAU7D,GAC3CC,EAAK6D,qBACL7D,EAAK6D,mBAAmBC,OAASjL,GAAG2D,KAAKuH,UAAU/D,EAAK6D,mBAAmBC,OAAQ/D,EAAEiE,OAAQjE,EAAEkE,WAIvG,OAAO5D,GAGX9C,EAAS2G,OAAS,SAAUnM,GACxB,MAAMiI,EAAOpH,KACb,OAAOoH,EAAKmE,gBAAgBnE,EAAK3G,MAAQ,UAAW,KAAM,SAAU+K,GAChEpE,EAAKzD,WAAW8H,UAAYD,IAC7BpD,KAAK,WACJ,OAAOhB,EAAKsE,WAAW,CAAEC,UAAWvE,EAAK3H,IAAMN,MAIvDwF,EAAS8F,YAAc,SAAUlK,GAC7B,IAAI6G,EAAOpH,KAEXoH,EAAKI,IAAIoE,IAAI3L,GAAGmF,OAAOC,MAAMwG,cAAe3E,GAE5C,GAAKE,EAAK0E,WAsCC,SAASpB,KAAKnK,EAAQ0J,SAAST,gBACtCpC,EAAKI,IAAIuE,MAAM3E,EAAK4E,gBAAgB,2BAA4B,CAAElE,KAAM7H,GAAGmF,OAAO6G,QAAQC,eAtC1F,GAAI3L,EAAQ0J,UAAY1J,EAAQoK,UAAYpK,EAAQoK,SAASvM,OAAS,EAAG,CAErE,IAAI+N,EAAO/E,EAAKgF,sBAAsBC,UACtCjF,EAAKkF,iBAAmB/L,EAAQ0J,SAChC,MAAMsC,EAAc,GACpB,IAAK,IAAIjO,EAAI,EAAGkO,EAAMjM,EAAQoK,SAASvM,OAAQE,EAAIkO,EAAKlO,IACpDiO,EAAYE,KAAKrF,EAAKE,WAAWoF,WAAWnM,EAAQoK,SAASrM,KAEjEqO,QAAQC,IAAIL,GAAanE,KAAK,WAE1BhB,EAAKO,KAAKkF,wBAAwB,CAAEV,KAAMA,EAAMW,aAAcvM,EAAQuM,eAEtE,GAAI1F,EAAKE,WAAY,CAEbF,EAAKI,KAAOJ,EAAKI,IAAIuF,QAAU3F,EAAKI,IAAIuF,OAAOC,WAC3C5F,EAAK6F,IAAIC,UAAUC,SAASlN,GAAGmF,OAAOgI,QAAQC,YAC9CjG,EAAKI,IAAI8F,SACJC,OAAO,SAAUC,GAEd,OAAOA,IAAQpG,IAASoG,EAAIC,mBAE/B7C,QAAQ,SAAU4C,GACfA,EAAIP,IAAIC,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQC,aAKxDjG,EAAK6F,IAAIC,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQC,WAC5CjG,EAAK6F,IAAIW,cAAc,IAAMxG,EAAK3G,MAAQ,sBAAsBoN,QAE3DtN,EAAQuN,UAET1G,EAAKI,IAAIuG,QAAQ9N,GAAGmF,OAAOC,MAAME,gBAUzDZ,EAASqJ,uBAAyB,SAAUC,GACxC,MAAM7G,EAAOpH,KAEb,OAAO,IAAI2M,QAAQ,SAAUuB,EAASC,GAClC,GAAIF,EAAU,CAEV,IAAIG,EAAchH,EAAKiH,gBAAgBd,OAAO,SAAUe,GACpD,OAAOA,EAAMC,IAAIC,aAAeP,EAASO,aAC1C,GAAGC,KAGFC,EAAYzQ,KAAK0Q,IAAI,GAAI1O,GAAGmF,OAAOwJ,iBAAmB,GAEtDC,GAAkB,IAAIC,GAAGzE,OAAO0E,SAAUC,aAAaZ,GAC3D,MAAMa,EAAW,IAAIC,MAAML,EAAgBzQ,QAC3CyQ,EAAgBjE,QAAQ,SAAU3E,EAAGkJ,GACjCF,EAASE,GAAOlP,GAAG0H,KAAKyH,QAAQC,cAAcpJ,KAGlD0G,QAAQC,IAAIqC,GAAU7G,KAAK,SAAUkH,GACjClI,EAAKjC,gBAAkBmK,EAAW9H,IAAI,SAAUvB,GAC5C,MAAMsJ,EAAO,GAEb,QAAQ,GACJ,KAAKtP,GAAGmJ,QAAQoG,QAAUvJ,aAAahG,GAAGmJ,QAAQoG,OAC9CD,EAAKzH,KAAO7H,GAAGmF,OAAOqK,KAAKC,OAC3B,MACJ,KAAKzP,GAAGmJ,QAAQyB,OAAS5E,aAAahG,GAAGmJ,QAAQyB,MAC7C0E,EAAKzH,KAAO7H,GAAGmF,OAAOqK,KAAKE,MAC3B,MACJ,KAAK1P,GAAGmJ,QAAQ2B,UAAY9E,aAAahG,GAAGmJ,QAAQ2B,SAChDwE,EAAKzH,KAAO7H,GAAGmF,OAAOqK,KAAKG,SAC3B,MACJ,KAAK3P,GAAGmJ,QAAQyG,eAAiB5J,aAAahG,GAAGmJ,QAAQyG,cACrDN,EAAKzH,KAAO7H,GAAGmF,OAAOqK,KAAKK,cAGnCP,EAAK9P,GAAKwG,EAAExG,GACZ8P,EAAKE,KAAOxP,GAAG2D,KAAKmM,gBAAgB9J,EAAE+J,SAAUtB,GAChDa,EAAKd,KAAOxI,EAAEqD,UAEd,OAAOiG,IAGXrB,WAGJA,OAOZ,IAAI+B,GAAkB,EACtBtL,EAAS+G,WAAa,SAAU+C,EAAMtP,GAClC,MAAMiI,EAAOpH,KAEb,IAAIkQ,EAAM9I,EAAKzG,MAAMO,SAErB,OAAOjB,GAAGE,QAAQyE,UAAU8G,WAAWhE,KAAKN,EAAMqH,EAAM,WAEpD,MAAMlO,EAAU6G,EAAK6F,IAAIkD,iBAAiB/I,EAAK5G,eAAiB,UAChE4G,EAAK6F,IAAIkD,iBAAiB,IAAM/I,EAAK3G,MAAQ,gBAAgBmK,QAAQ,SAAUwF,GAC3EA,EAAKC,iBAAiBpQ,GAAGmF,OAAOC,MAAMiL,MAAO,SAAUnJ,GAEnD,IADA,IAAIgC,EAAQhC,EAAE+C,OACPf,GAA2B,UAAlBA,EAAMoH,SAClBpH,EAAQA,EAAMqH,cAElB,MAAMC,EAAYtH,EAAMyE,cAAc,gCAAgC7G,MAEtExG,EAAQqK,QAAQ,SAAU8F,GACtBA,EAAOxD,UAAUyD,OAAO1Q,GAAGmF,OAAOgI,QAAQwD,QAASF,EAAOG,QAAQ,IAAMzJ,EAAK3G,MAAQ,IAAMgQ,UAKvGrJ,EAAKuB,MAAQ,CACTmI,eAAgB1J,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,sBAC7DuQ,iBAAkB3J,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,wBAC/DwQ,YAAa5J,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,yBAC1DyQ,gBAAiB7J,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,iBAC9D0Q,UAAW9J,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,eACxD2Q,SAAU/J,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,kBACvD4Q,cAAehK,EAAKzD,WAAWiK,cAAc,sCAC7CyD,WAAYjK,EAAKzD,WAAWiK,cAAc,iCAC1C0D,WAAYlK,EAAKzD,WAAWiK,cAAc,mEAE1C2D,qBAAsBnK,EAAKzD,WAAWiK,cAAc,wCAGxDxG,EAAKuB,MAAM6I,UAAYpK,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,wBAEpE4G,EAAKuB,MAAM8I,qBAAuBrK,EAAK6F,IAAIW,cAAc,0CAA4CxG,EAAK3H,IAE1G2H,EAAK6F,IAAIW,cAAc,IAAMjJ,EAASlE,MAAQ,qBAAqB4P,iBAAiB,QAAS,WACzFqB,EAAahK,KAAKN,KAGtBA,EAAKuB,MAAMgJ,UAAYvK,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,gBAEpE4G,EAAKuB,MAAMiJ,SAAWxK,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,mBAE/DP,GAAG2D,KAAKiO,gBACJC,WAAW,uDAAuDjB,UAClEzJ,EAAKuB,MAAM8I,qBAAqB5I,SAAU,GAGlD,GAAIjK,OAAOmT,MAAQnT,OAAOoT,YAAcpT,OAAOqT,UAAYrT,OAAOsT,KAAM,CACpE9K,EAAKuB,MAAMsI,gBAAgBkB,UAAW,EAEtC/K,EAAKuB,MAAMsI,gBAAgBZ,iBAAiBpQ,GAAGmF,OAAOC,MAAMiL,MAAO,SAAUnJ,GAEzE,MACMiL,EAAOnO,SAASoO,cAAc,QAC9BC,EAFQtS,KAEOwQ,cACrB8B,EAAOC,aAAaH,EAHNpS,MAIdoS,EAAKjO,YAJSnE,MAKdoS,EAAKI,QAELJ,EAAKK,sBAAsB,WAPbzS,MAQdsS,EAAOI,YAAYN,KAGvB,MAAMO,EAAc,WAChBvL,EAAKI,IAAIoE,IAAI3L,GAAGmF,OAAOC,MAAMuN,WAAYD,GACzCvL,EAAKyL,eAAezL,EAAKuB,MAAMsI,iBAE/BhR,GAAG6S,MAAM1L,EAAK4E,gBAAgB,2BAGlC5E,EAAKuB,MAAMsI,gBAAgBZ,iBAAiB,SAAU,SAAUlJ,GAC5D,IAAKC,EAAK2L,UAAW,CACjB3L,EAAKoD,MAAMpD,EAAKzG,MAAM4C,OAAOC,OAE7B,GAAI4D,EAAKI,IAAK,CACVJ,EAAKI,IAAIuC,GAAG9J,GAAGmF,OAAOC,MAAMuN,WAAYD,GACxCvL,EAAKI,IAAIG,KAAKqL,UAAU7L,EAAE+C,OAAO+I,MAAO,CAAE/S,QAASkH,aAK/D8L,QAAQC,IAAI,mCAGhB/L,EAAKuB,MAAMmI,eAAeT,iBAAiB,QAAS,WAChDjJ,EAAKgM,mBACLC,EAAsB3L,KAAKN,KAG/BA,EAAKuB,MAAMoI,iBAAiBV,iBAAiB,QAAS,WAClDjJ,EAAKkM,qBACLC,EAAwB7L,KAAKN,KAsCjC,MAAMoM,EAAsB,YAnCd,SAAUC,GACpBA,EAAaA,EAAWjK,cAExB,MAAMkK,EAAMxE,MAAMyE,KAAKvM,EAAKuB,MAAM6I,UAAUrB,iBAAiB,OAC7DuD,EAAI9I,QAAQ,SAAUgJ,GAClBA,EAAGC,MAAMC,QAAU,SAEvB,MAAMC,EAAWL,EAAInG,OAAO,SAAUqG,GAClC,OAAOA,EAAG/C,QAAQ,sBAAwBzJ,EAAKzG,MAAMC,QAAQG,iBAG3DiT,EAAa5M,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,sBAChE,GAA0B,IAAtBiT,EAAWrV,OAAc,CACzB2V,EAASnJ,QAAQ,SAAUgJ,GACvBA,EAAGC,MAAMC,QAAU,KAEvBE,EAAWH,MAAMI,WAAa,cAC3B,CACHD,EAAWH,MAAMI,WAAa,SAC9B,IAAIC,EAAI,IAAIC,OAAOV,EAAY,KAC/BM,EAASnJ,QAAQ,SAAUgJ,GACvBA,EAAGC,MAAMC,QAAUI,EAAExJ,KAAKkJ,EAAGhG,cAAc,QAAQwG,aAAe,GAAK,SAGtEL,EAASM,KAAK,SAAUT,GACzB,MAA4B,KAArBA,EAAGC,MAAMC,WAEhBJ,EAAI9I,QAAQ,SAAUgJ,GACdA,EAAG/C,QAAQ,6CACX+C,EAAGC,MAAMC,QAAU,OAOnCQ,CAAQtU,KAAK+G,MAAMyC,cAAcD,SAErCnC,EAAKuB,MAAMqI,YAAYX,iBAAiB,QAASmD,GACjDpM,EAAKuB,MAAMqI,YAAYX,iBAAiB,SAAUmD,GAGlDpM,EAAKuB,MAAMuI,UAAUb,iBAAiB,QAASjJ,EAAKmN,UAAUzL,KAAK1B,IACnEA,EAAKuB,MAAMwI,SAASd,iBAAiB,QAASjJ,EAAKoN,YAAY1L,KAAK1B,IAEpE,MAAMqN,EAAOrN,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,wBAG1D,IAAIkU,EAAQ,SAAUC,EAAMC,GACJ,OAAhBA,EAAIrE,UACJqE,EAAMA,EAAIpE,eAGd,MAAMqE,EAAQD,EAAIhH,cAAc,SAC1BwC,EAAOwE,EAAIhH,cAAc,QAE/B,GAAI+G,EAAM,CAENE,EAAM3H,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QACzCiE,EAAMC,QACND,EAAM9N,MAAQqJ,EAAKgE,YACnBhE,EAAKlD,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,QAErCgE,EAAIhH,cAAcsC,EAAI/O,UAAU+L,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,QAChEgE,EAAIhH,cAAcsC,EAAI7O,MAAM6L,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,QAC5DgE,EAAIhH,cAAcsC,EAAI5O,QAAQ4L,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,QAC9DgE,EAAIhH,cAAcsC,EAAI9O,MAAM8L,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,QAC5DgE,EAAIhH,cAAcsC,EAAIzO,QAAQyL,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,QAE9DgE,EAAIhH,cAAcsC,EAAI3O,MAAM2L,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QAC/DgE,EAAIhH,cAAcsC,EAAI1O,QAAQ0L,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,YAC9D,CAEHiE,EAAM3H,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,QACtCR,EAAKlD,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QAExCgE,EAAIhH,cAAcsC,EAAI/O,UAAU+L,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QACnEgE,EAAIhH,cAAcsC,EAAI7O,MAAM6L,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QAC/DgE,EAAIhH,cAAcsC,EAAI5O,QAAQ4L,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QACjEgE,EAAIhH,cAAcsC,EAAI9O,MAAM8L,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QAC/DgE,EAAIhH,cAAcsC,EAAIzO,QAAQyL,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QAEjEgE,EAAIhH,cAAcsC,EAAI3O,MAAM2L,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,QAC5DgE,EAAIhH,cAAcsC,EAAI1O,QAAQ0L,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,UAItExJ,EAAK2N,WAAa,SAAUC,EAAUJ,GAClC,GAAIA,EAAK,CACL,IAAIK,EAAe,CACf/E,EAAI/O,SACJ+O,EAAI7O,KACJ6O,EAAI5O,OACJ4O,EAAIzO,QAEJyT,EAAmB,CACnBhF,EAAIxO,KACJwO,EAAIvO,MACJuO,EAAItO,SACJsO,EAAIrO,QACJqO,EAAIpO,OAEJqT,EAAsB,OAAhBP,EAAIrE,QAAmBqE,EAAMA,EAAIQ,WAE3CH,EAAarK,QAAQ,SAAU4C,GAC3B2H,EAAIvH,cAAcJ,GAAK6H,OAASL,IAGpCE,EAAiBtK,QAAQ,SAAU4C,GAC/B2H,EAAIvH,cAAcJ,GAAK6H,QAAUL,MAK7CP,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBrF,EAAI/O,SAAU,SAAUgG,GACrF,IAAIgF,EAAO/E,EAAKgF,sBAAsBC,UAEtClF,EAAE+C,OAAOsG,cAAc5C,cAAcsC,EAAIpO,OAAOsS,YAAc,MAE9DoB,EAAWpO,EAAMD,EAAE+C,QAAQ9B,KAAK,WAC5BhB,EAAKgF,sBAAsBqJ,WAAWtJ,QAG9CsI,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBrF,EAAI9O,KAAM,SAAU+F,GACjF,IAAIgF,EAAO/E,EAAKgF,sBAAsBC,UAEtCqJ,EAAWtO,EAAMD,EAAE+C,QAAQ9B,KAAK,WAC5BhB,EAAKgF,sBAAsBqJ,WAAWtJ,QAI9C/E,EAAK2C,GAAG3C,EAAKzG,MAAM4B,MAAMS,cAAe,SAAUmE,GAC9C,GAAKC,EAAK0E,WAON1E,EAAKI,IAAIuE,MAAM3E,EAAK4E,gBAAgB,2BAA4B,CAAElE,KAAM7H,GAAGmF,OAAO6G,QAAQC,cAPxE,CAClB,MAAMyJ,EAAcvO,EAAKuB,MAAM6I,UAAU5D,cAAc,eAAiBzG,EAAEyO,MAAQ,MAClFF,EAAWtO,EAAMuO,EAAY/H,cAAcsC,EAAI9O,OAC/C1B,WAAW,WACP0H,EAAKuB,MAAM6I,UAAUqE,UAAY1O,EAAEyO,MAAQD,EAAYG,cACxD,QAMX,MAAMC,EAAmB,SAAU3O,EAAM4O,GACrC5O,EAAKuB,MAAM6I,UAAUrB,iBAAiB,eAAevF,QAAQ,SAAUqL,GACnE,GAAIA,EAASC,QAAQzW,KAAOuW,EAAW,CACnC,MAAMG,EAAcF,EAASrI,cAAcsC,EAAI/O,UACzCiV,EAAWH,EAASrI,cAAcsC,EAAIvO,OAE5CwU,EAAYjJ,UAAUS,OAAOvG,EAAKzG,MAAMC,QAAQK,qBAChDkV,EAAYE,aAAa,QAASjP,EAAK4E,gBAAgB,oBACvDoK,EAASlJ,UAAUS,OAAO,QAC1ByI,EAASC,aAAa,QAASjP,EAAK4E,gBAAgB,iBAEpD5E,EAAK2N,YAAW,EAAOkB,GACvBvB,GAAM,EAAOuB,MAIrB7O,EAAKoD,MAAMpD,EAAKzG,MAAM4C,OAAOC,QAGjC,IAAIkS,EAAa,SAAUtO,EAAMkP,GAC7B,OAAO,IAAI3J,QAAQ,SAAUuB,EAASC,GAElC,MAAMoI,EAAUD,EAAQ9F,cAExB9Q,WAAW,WACP,GAAI6W,EAAQrJ,UAAUC,SAAS/F,EAAKzG,MAAMC,QAAQG,eAAgB,CAC9DqG,EAAK2N,YAAW,EAAOuB,GAEvBlP,EAAKoD,MAAMpD,EAAKzG,MAAM4C,OAAOC,OAC7B4D,EAAKI,IAAIoE,IAAI3L,GAAGmF,OAAOC,MAAMwG,cAAe3E,GAE5CoP,EAAQD,aAAa,QAASC,EAAQlC,kBAErC,GAAIhN,EAAKoP,mBAAoB,CAC9BT,EAAiB3O,EAAMmP,EAAQL,QAAQzW,IACvC2H,EAAKqP,UAAUF,QAEfnP,EAAKqP,UAAUF,GAKfA,EAAQrJ,UAAUC,SAAS/F,EAAKzG,MAAMC,QAAQG,eAC9CqG,EAAK4G,uBAAuBuI,EAAQL,QAAQ3H,KAAKnG,KAAK,WAClD8F,MAGJA,KAEL,MAIPsH,EAAa,SAAUpO,EAAM+O,GAC7B,OAAO,IAAIxJ,QAAQ,SAAUuB,EAASC,GAClCzO,WAAW,WACP,MAAM6W,EAAUJ,EAAY3F,cAE5BuF,EAAiB3O,EAAMmP,EAAQL,QAAQzW,IACvC2H,EAAK2N,YAAW,EAAO3N,EAAKoP,oBAC5BpP,EAAK2N,YAAW,EAAMoB,GAEtB/O,EAAKsP,iBAAkB,EACvBtP,EAAKuP,cAAcJ,GAEnBrI,KACD,MAIXuG,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBnO,EAAK5G,eAAiB,IAAM0P,EAAI7O,KAAM,SAAU8F,GAC7GuN,GAAM,EAAMvN,EAAE+C,WAElBuK,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBnO,EAAK5G,eAAiB,IAAM0P,EAAI5O,OAAQ,SAAU6F,GAC/GC,EAAKwP,YAAYzP,EAAE+C,OAAOsG,kBAE9BiE,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBnO,EAAK5G,eAAiB,IAAM0P,EAAI3O,KAAM,SAAU4F,GAE7G,GAA8B,IADhBA,EAAE+C,OAAOsG,cAAc5C,cAAc,SAAS7G,MAChDwC,OAAOnL,OACf6B,GAAG6S,MAAM1L,EAAK4E,gBAAgB,2BAE7B,CACD5E,EAAKyP,cAAc1P,EAAE+C,OAAOsG,cAAc0F,QAAQzW,GAAI0H,EAAE+C,OAAOsG,cAAc5C,cAAc,SAAS7G,OACpG2N,GAAM,EAAOvN,EAAE+C,YAGvBuK,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBnO,EAAK5G,eAAiB,IAAM0P,EAAI1O,OAAQ,SAAU2F,GAC/GuN,GAAM,EAAOvN,EAAE+C,WAGnBuK,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBnO,EAAK5G,eAAiB,IAAM0P,EAAIzO,OAAQ,SAAU0F,GAC/G,MAAMmL,EAASnL,EAAE+C,OAAOsG,cACxBrJ,EAAE+C,OAAOmM,aAAa,WAAY,IAElCjP,EAAK0P,OAAOxE,GAAQlK,KAAMuC,IACtBvD,EAAK2P,oBAAoB3O,KAAK,SAAU4O,GACpC,IAAIC,EAAW3E,EAAO1E,cAAc,QAAQwG,YACxC8C,EAAQ,IAAI/C,OAAO/M,EAAKzG,MAAMyC,wBAAwB+T,KAAK,KAAM,MACjEC,EAAgBH,EAASI,QAAQH,EAAO,IAC5C,MAAM3W,EAAU,CACZ4H,MAAOf,EAAK4E,gBAAgB,YAC5B/B,SAAUmN,EACVE,UAAW,CACPC,WAAY,GACZC,aAAc,MAGtBR,EAAOS,KAAK9M,EAAUpK,GAEtB4G,EAAE+C,OAAOwN,gBAAgB,mBAKrCjD,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBnO,EAAK5G,eAAiB,IAAM0P,EAAIxO,KAAM,SAAUyF,GAC7GC,EAAK2N,YAAW,EAAO5N,EAAE+C,QACzB9C,EAAKO,KAAKgQ,mBACV,MAAMvB,EAAWjP,EAAE+C,OAAOsG,cAAc5C,cAAcsC,EAAIvO,OAC1DyU,EAASlJ,UAAUS,OAAO,QAC1ByI,EAASC,aAAa,QAASjP,EAAK4E,gBAAgB,iBAEpD7E,EAAE+C,OAAOsG,cAAc5C,cAAcsC,EAAIpO,OAAOsS,YAAc,MAC9DhN,EAAKwQ,eAAiB,KAG1BnD,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBnO,EAAK5G,eAAiB,IAAM0P,EAAIvO,MAAO,SAAUwF,GAC9GC,EAAKsP,iBAAmBvP,EAAE+C,OAAOgD,UAAUC,SAAS,QAChD/F,EAAKsP,kBACLtP,EAAKyQ,uBAAyB,GAElC1Q,EAAE+C,OAAOmM,aAAa,QAASjP,EAAK4E,gBAAgB5E,EAAKsP,gBAAkB,cAAgB,iBAC3FvP,EAAE+C,OAAOgD,UAAUyD,OAAO,SAAUvJ,EAAKsP,oBAI7CjC,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBnO,EAAK5G,eAAiB,IAAM0P,EAAItO,SAAU,SAAUuF,GACtF,GAAvBC,EAAKwQ,eACLxQ,EAAKwQ,eAHD,GAIHxQ,EAAKwQ,eAAiBxQ,EAAKwQ,eAAiB,EAEjDzQ,EAAE+C,OAAOsG,cAAc5C,cAAcxG,EAAK5G,eAAiB,IAAM0P,EAAIrO,SAASsQ,UAAW,EAEzFhL,EAAE+C,OAAOsG,cAAc5C,cAAcsC,EAAIpO,OAAOsS,YAAchN,EAAKwQ,eAAiB,EAAI,KAAQ,EAAIxQ,EAAKwQ,eAAkB,KAAOxQ,EAAKwQ,eAE5G,eAAvBxQ,EAAKwQ,iBACLzQ,EAAE+C,OAAOiI,UAAW,MAI5BsC,EAAKpE,iBAAiB,QAASpQ,GAAGqV,YAAYC,mBAAmBnO,EAAK5G,eAAiB,IAAM0P,EAAIrO,QAAS,SAAUsF,GAChHC,EAAKwQ,eAAiBxQ,EAAKwQ,eAhBnB,GAkBRzQ,EAAE+C,OAAOsG,cAAc5C,cAAcsC,EAAIpO,OAAOsS,YAAchN,EAAKwQ,eAAiB,EAAI,KAAQ,EAAIxQ,EAAKwQ,eAAkB,KAAOxQ,EAAKwQ,eAEvIzQ,EAAE+C,OAAOsG,cAAc5C,cAAcxG,EAAK5G,eAAiB,IAAM0P,EAAItO,UAAUuQ,UAAW,EAE/D,MAAvB/K,EAAKwQ,iBACLzQ,EAAE+C,OAAOiI,UAAW,MAM5B/K,EAAKuB,MAAMyI,cAAcf,iBAAiB,QAAS,WAE/CpQ,GAAG2D,KAAKkU,aAERC,EAAUrQ,KAAKN,KAEnBA,EAAKuB,MAAM0I,WAAWhB,iBAAiB,QAAS,kBAErCjJ,EAAK4Q,gBACZ/X,GAAG2D,KAAKqU,QAAQC,qBAAqB9Q,EAAKzG,MAAMoB,gBAAgBE,kBAAckW,GAC9EC,YAAYC,WAAWjR,EAAKzG,MAAMoB,gBAAgBE,cAElDhC,GAAG2D,KAAKkU,aAERC,EAAUrQ,KAAKN,KAEnBA,EAAKuB,MAAM2I,WAAWjB,iBAAiB,QAAS,WAC5CkD,EAAwB7L,KAAKN,KASjCA,EAAKuB,MAAM4I,qBAAqBlB,iBAAiB,QAAS,WAEtD,MAAMiI,EAAarU,SAASC,KAAKiM,iBAAiB,wCAElD,GAAImI,EAAWla,OAAS,EAAG,CACP,IAAIuO,QAAQ,SAAUuB,EAASC,GACvCvP,OAAOwZ,YACPlK,IAEAjO,GAAGsY,QAAQ3Z,OAAOwZ,YAAa,CAACnY,GAAGmF,OAAOoT,IAAIC,aAAc,WACxDvK,QAKJ9F,KAAK,WACTgQ,YAAYM,QAAQJ,EAAW,GAAGK,aAAa,SAAS,KAIhE1Y,GAAG2D,KAAKkU,eAGZ1Q,EAAKuB,MAAMC,YAAc3E,SAAS2J,cAAc,oCAAsCxG,EAAK3H,IAC3F2H,EAAKuB,MAAMC,YAAYyH,iBAAiB,SAAU,WAC1CjJ,EAAKuB,MAAMmI,eAAe5D,UAAUC,SAASlN,GAAGmF,OAAOgI,QAAQwD,SAC/DxJ,EAAKyC,cAAc+O,cAAc5Y,KAAK6I,SAG1CoH,EAAkBjQ,KAAK6I,UAGvBjK,OAAOwZ,YACPhR,EAAKyR,aAEL5Y,GAAGsY,QAAQ3Z,OAAOwZ,YAAa,CAACnY,GAAGmF,OAAOoT,IAAIC,aAAc,WACxDrR,EAAKyR,eAIT5Y,GAAG2D,KAAKkV,WAAW3Z,IACnBA,OAKZwF,EAASoU,SAAW,aAKpBpU,EAASqU,WAAa,WAGlB/Y,GAAG2D,KAAKkU,aAFG9X,KAGNuH,iBAHMvH,KAINsT,sBAIT,IAAID,EAAwB,WACbrT,KAEN2I,MAAMmI,eAAe5D,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,QAF/C5Q,KAGN2I,MAAMoI,iBAAiB7D,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,SAG/D2C,EAA0B,WACfvT,KAEN2I,MAAMmI,eAAe5D,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QAFlD5Q,KAGN2I,MAAMoI,iBAAiB7D,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,SAG5Dc,EAAe,WACJ1R,KACNwH,IAAIuE,MADE/L,KACSiN,IAAIW,cAAc,kBAAkBnC,UAAW,CAC/DwN,SAAU,OAIlBtU,EAASuU,YAAc,CACnB1Q,OAAQ,EACRC,UAAW,CAAC,IAAK,EAAG,EAAG,KACvBM,YAAa,CAAC,IAAK,IAAK,IAAK,KAC7BY,YAAa,GAGjBhF,EAASwU,UAAY,CACjBxP,YAAa,EACbZ,YAAa,CAAC,EAAG,IAAK,IAAK,MAG/BpE,EAASyU,yBAA2B,SAAUC,GAC1C,IAEI5K,EAAO,GACP6K,EAASrZ,GAAG2D,KAAK2V,aAHVvZ,KAG4BwH,KAEvC,GALWxH,KAKFwH,IAAIgS,SAAU,CACnB,IAAIC,EANGzZ,KAMcwH,IAAIkS,MANlB1Z,KAM+BwH,IAAImS,OAAOD,IAAMzZ,GAAG2D,KAAKuH,UAAUkO,EAAYO,SAN9E5Z,KAM6FwH,IAAIkS,IANjG1Z,KAM2GwH,IAAImS,OAAOD,KAAOL,EAAYO,SAChJnL,EAAK1P,EAAI0a,EAAU,GAAGI,eAAeP,GACrC7K,EAAKtQ,EAAIsb,EAAU,GAAGI,eAAeP,GAErC7K,EAAKqL,IAAM7b,KAAK8b,MAVT/Z,KAUoBwH,IAAImS,OAAOK,iBAAiBP,IAAYI,eAAeP,GAElF7K,EAAKwL,OAAQ,MAEV,CACHxL,EAAK1P,EAAId,KAAK8b,MAAMV,EAAYO,SAAS,IAAIC,eAAeP,GAC5D7K,EAAKtQ,EAAIF,KAAK8b,MAAMV,EAAYO,SAAS,IAAIC,eAAeP,GAGhE7K,EAAKyL,EAAKjc,KAAK8b,MAAMV,EAAYc,UAAUN,eAAeP,GAC1D7K,EAAK2L,SAAYnc,KAAK8b,MAAMV,EAAYe,UAAUP,eAAeP,GACjE7K,EAAK4L,MAAQhB,EAAYgB,MAAMR,eAAeP,EAAQ,CAAEgB,sBAAuB,EAAGC,sBAAuB,IAEzG,OAAO9L,GAGX9J,EAAS6V,sBAAwB,SAAUC,GACvC,IAAIrT,EAAOpH,KAEXoH,EAAKmE,gBAAgBnE,EAAK3G,MAAQ,kBAAmB2G,EAAKgS,yBAAyBqB,EAAEC,IAAK,SAAUlP,GAEhG,GAAKpE,EAAKuB,MAAMgS,UA8C6B,kBAA1BvT,EAAKuB,MAAe,WAAoBvB,EAAKuB,MAAMgS,UAAUC,eAC5ExT,EAAKuB,MAAMgS,UAAUE,gBAAgBzS,KAAK,WACtChB,EAAKuB,MAAMgS,UAAUG,oBAAoBrP,UAAYD,EAChDpE,EAAKuB,MAAMgS,UAAUI,aACtB3T,EAAKuB,MAAMgS,UAAUK,kBAlDN,CACvB5T,EAAKuB,MAAMgS,WAAY,EAEvB,IAWIM,EAXAC,EAAsB,CACtBC,QAAS,QACTC,OAAQ,CACJC,KAAMjU,EAAK4E,gBAAgB,kBAC3BhN,IAAKoI,EAAK4E,gBAAgB,wBAE9BoB,QAAS,CACLkO,UAAW,aAKnB,MAAMC,EAAsB,SAAUC,GAClCN,EAAoBtB,SAAW4B,EAAiBC,SAASC,MACzDT,EAAaO,EAAiBG,WAAW,eAAgBT,IAG7D,GAAI9T,EAAK7G,QAAQqb,UAAW,CACxB,IAAIJ,EAAmBpU,EAAKI,IAAIqU,mBAAmB,cAAgBzU,EAAK7G,QAAQqb,UAAU,GAAGE,cAAgB1U,EAAK7G,QAAQqb,UAAUG,UAAU,IAAI,GAC7IP,EAGDD,EAAoBC,GAFpBpU,EAAKI,IAAImU,WAAWvU,EAAK7G,QAAQqb,WAAWxT,KAAKmT,OAIlD,CACHL,EAAoBjO,IAAMhJ,SAASoO,cAAc,OACjDjL,EAAKI,IAAIyF,IAAI9I,YAAY+W,EAAoBjO,KAC7CgO,EAAa7T,EAAKI,IAAImU,WAAW,eAAgBT,GAGrDD,EAAW7S,KAAK,SAAU4T,GACtB5U,EAAKI,IAAIqU,mBAAmB,2BAA2BtO,OAAO,SAAU0O,GACpE,MAAyB,UAAlBA,EAAMd,SAAuBc,IAAUD,IAC/CpR,QAAQ,SAAUqR,GACjBA,EAAMC,UAGV9U,EAAKuB,MAAMgS,UAAYqB,EAEvBA,EAAiBnB,gBAAgBzS,KAAK,WAClC4T,EAAiBvE,KAAKjM,WAe1C,IA+EI2Q,EAOAC,EAsBAC,EA5GAC,EAA2B,WAChBtc,KAED2I,MAAM8I,qBAAqB5I,SAF1B7I,KAGFwH,IAAIuG,QAAQ9N,GAAGmF,OAAOC,MAAMC,aAIrCyS,EAAY,WACZ,IAAI3Q,EAAOpH,KAEXoH,EAAK2R,WAEL1F,EAAsB3L,KAAKN,GAC3BkV,EAAyB5U,KAAKN,GAE9BA,EAAK2C,GAAG3C,EAAKzG,MAAM4B,MAAMC,eAAgB,SAAUiY,GAE/CrT,EAAKmV,aAAe9B,EAAEC,GACtBtT,EAAKoT,sBAAsBC,GAE3BrT,EAAKuB,MAAMgJ,UAAUQ,UAAW,EAChC/K,EAAKuB,MAAMuI,UAAUiB,UAAW,EAEhC/K,EAAKuB,MAAMiJ,SAASO,UAAW,EAC/B/K,EAAKuB,MAAMwI,SAASgB,UAAW,EAG/BlS,GAAG2D,KAAKqU,QAAQC,qBAAqB9Q,EAAKzG,MAAMoB,gBAAgBE,aAAcmF,EAAKO,KAAK6U,mBAAmBpV,EAAKyC,eAAec,YAEnIvD,EAAK2C,GAAG3C,EAAKzG,MAAM4B,MAAMI,aAAc,SAAU8L,MAIjDrH,EAAKoD,MAAMpD,EAAKzG,MAAM4C,OAAOvB,UAE7Bya,EAAc/U,KAAKN,EAAMA,EAAKzG,MAAMoB,gBAAgBG,2BAEpDkF,EAAKO,KAAK+U,aAAY,IAiDtBC,EAAkB,WACP3c,KAEF4c,cAAcC,QAFZ7c,KAGF4c,cAAcE,OAEvBC,EAAqBtZ,MALVzD,OAqBXgd,EAAqB,WACrB,IAEI3H,EAhBgB,WACpB,IAAI4H,EAAW,CAAC,SAAU,MAAO,KAAM,KAEvC,GAAI,WAAYhZ,SAAU,MAAO,SAEjC,IAAK,IAAI3F,EAAI,EAAGA,EAAI2e,EAAS7e,OAAQE,IACjC,GAAK2e,EAAS3e,GAAK,WAAa2F,SAC5B,OAAOgZ,EAAS3e,GAAK,SAG7B,OAAO,KAMM4e,GAERjZ,SAASoR,IACVsH,EAAgBlZ,MALTzD,MAOXkT,QAAQC,IAAI,aAPDnT,KAOqB4c,cAAcC,SAE9CM,EAAkB,WAGbd,IACDA,EAAsBW,EAAmBlU,KAHlC9I,OAKNmc,IACDA,EA9Cc,WAGlBiB,EAAqB3Z,MAFVzD,OA6C4B8I,KAN5B9I,OAQNoc,IACDA,EAAmBO,EAAgB7T,KAT5B9I,OAWXpB,OAAOyR,iBAAiB,mBAAoBgM,GAAqB,GAGjE,GAAIpc,GAAG2D,KAAKyZ,gBAAkBpd,GAAGqd,gBAAgBC,UAAYC,UAAUC,UAAUC,MAAM,cAAgBF,UAAUC,UAAUC,MAAM,UAAW,CACxI9e,OAAOyR,iBAAiB,WAAY8L,GAAkB,GACtDvd,OAAOyR,iBAAiB,WAAY+L,GAAkB,OACnD,CACHxd,OAAOyR,iBAAiB,OAAQ8L,GAAkB,GAClDvd,OAAOyR,iBAAiB,QAAS+L,GAAkB,KAiBvDgB,EAAuB,WACvB,IAEIpF,EAAkB/X,GAAG2D,KAAKqU,QAAQ0F,qBAF3B3d,KAEqDW,MAAMoB,gBAAgBE,cAClF+V,GAAmBA,EAAgB5Z,OAAS,GAC5Cga,YAAYM,QAJL1Y,KAIkBW,MAAMoB,gBAAgBE,aAA2C,iBAAtB,EAAiC+V,EAAkB4F,KAAKC,UAAU7F,KAE1I+E,EAAuB,WACvB,IAAI3V,EAAOpH,KAEXoY,YAAY0F,QAAQ1W,EAAKzG,MAAMoB,gBAAgBE,cAAcmG,KAAK,SAAUgG,GACpD,OAAhBA,GAAwC,SAAhBA,GAA0BA,EAAYhQ,OAAS,GACvE6B,GAAG2D,KAAKqU,QAAQC,qBAAqB9Q,EAAKzG,MAAMoB,gBAAgBE,aAAcmM,MAMtFqO,EAAgB,SAAUsB,GAC1B,IAAI3W,EAAOpH,KAEA,IAAI2M,QAAQ,SAAUuB,EAASC,GAClCvP,OAAOwZ,YACPlK,IAEAjO,GAAGsY,QAAQ3Z,OAAOwZ,YAAa,CAACnY,GAAGmF,OAAOoT,IAAIC,aAAc,WACxDvK,QAKP9F,KAAK,WACNgQ,YAAY0F,QAAQC,GAAmB3V,KAAK,SAAU4V,GAClD,GAAmC,MAA/BA,EAAqC,CACrC,MAAMhH,EAAS5P,EAAKzD,WAAWiK,cAAc,2CACvCqQ,EAAWjH,EAAOpJ,cAAc,0BACtCqQ,EAAS5H,aAAa,OAAQ0H,GAC9BE,EAASpV,SAAU,EAEnB5E,SAAS2J,cAAc,gBAAgBwG,YAAcnU,GAAG2D,KAAKiO,eAAiBzK,EAAK4E,gBAAgB,qBAAuB5E,EAAK4E,gBAAgB,6BAE/IgL,EAAOpJ,cAAc,MAAMwG,YAAc2J,GAAqB3W,EAAKzG,MAAMoB,gBAAgBI,qBACrFiF,EAAK4E,gBAAgB,sBAAwB,IAAM5E,EAAK4E,gBAAgB,WACxE5E,EAAK4E,gBAAgB,4BAEzB/L,GAAG2D,KAAKsa,UAAU9W,EAAKzD,WAAWiK,cAAc,iDAK5DxG,EAAKI,IAAIuE,MAAO9L,GAAG2D,KAAKiO,eAAqEzK,EAAK4E,gBAAgB,qBAAzE5E,EAAK4E,gBAAgB,6BAA0E,CACpIlE,KAAM7H,GAAGmF,OAAO6G,QAAQC,WAIhCvH,EAASwZ,aAAe,SAAUhf,GAG9Bc,GAAG2D,KAAKsa,UAFGle,KAEY2D,WAAWiK,cAAc,6CAA8C,CAC1FwQ,cAAe,WAEPne,GAAG2D,KAAKkV,WAAW3Z,IACnBA,OAKZ,OAAO,GAGXwF,EAASyO,iBAAmB,WACxB,IAAIhM,EAAOpH,KACPqe,GAAoB,EAEnBjX,EAAKkX,UACNlX,EAAK2R,WAGT3R,EAAKoD,MAAMpD,EAAKzG,MAAM4C,OAAOvB,UAE7B,IACI/B,GAAG2D,KAAKqU,QAAQC,qBAAqB9Q,EAAKzG,MAAMoB,gBAAgBK,KAAMgF,EAAKzG,MAAMoB,gBAAgBK,MACnG,MAAOmc,GACDA,EAAMC,OAASC,aAAaC,mBAC5Bze,GAAG6S,MAAM1L,EAAK4E,gBAAgB,mCAC7B/L,GAAGse,MAAMA,GAEdF,GAAoB,EAGxB,GAAIA,EAAmB,EA3MA,WAGvB,IAFWre,KAED4c,cAAe,CACrB,IAAI+B,EAAQ,CACRC,KAAM,kRACNC,IAAK,klCALF7e,KAQF4c,cAAgB3Y,SAASoO,cAAc,SARrCrS,KASF4c,cAAcvG,aAAa,OAAQ,IATjCrW,KAUF4c,cAAcvG,aAAa,QAAS,IAVlCrW,KAWF4c,cAAcvG,aAAa,qBAAsB,IAX/CrW,KAYF4c,cAAcvG,aAAa,cAAe,IAZxCrW,KAaF4c,cAAcvG,aAAa,QAAS,+BAEzC,IAAIyI,EAAa7a,SAASoO,cAAc,UACxCyM,EAAWC,IAAMJ,EAAMC,KACvBE,EAAWhX,KAAO,aAjBX9H,KAkBF4c,cAAczY,YAAY2a,GAE/B,IAAIE,EAAY/a,SAASoO,cAAc,UACvC2M,EAAUD,IAAMJ,EAAME,IACtBG,EAAUlX,KAAO,YAtBV9H,KAuBF4c,cAAczY,YAAY6a,GAvBxBhf,KA0BN4c,cAAcE,SAiLMrZ,MAAM2D,GAC3B+V,EAAgB1Z,MAAM2D,GAEtBA,EAAK4Q,gBAAkB/X,GAAG2D,KAAKqU,QAAQ0F,qBAAqBvW,EAAKzG,MAAMoB,gBAAgBE,cACvF,GAAImF,EAAK4Q,gBAAiB,CACV5Q,EAAK+W,aAAa,WAC1B5K,EAAwB7L,KAAKN,MAI7BA,EAAKuB,MAAM0I,WAAWxD,aAEvBkK,EAAUrQ,KAAKN,QACjBmM,EAAwB7L,KAAKN,IAG1CzC,EAAS2O,mBAAqB,WAC1B,IAAIlM,EAAOpH,KAEPif,EAAsB,WAEtB7X,EAAKuB,MAAMgS,UAAUuB,QAErBkB,EAAqB3Z,MAAM2D,GAE3BA,EAAKO,KAAK+U,aAAY,UAGftV,EAAK8X,oBAEPjP,GACD7I,EAAK6F,IAAIW,cAAcxG,EAAK5G,eAAiB,iBAAiBoN,cAAc,SAASC,SA9MnE,WACf7N,KACF4c,eADE5c,KAEF4c,cAAcuC,UA8MK1b,MAAM2D,IA3Ib,WAErBxI,OAAOwgB,oBAAoB,mBAAoB/C,GAAqB,GAGpE,GAAIpc,GAAG2D,KAAKyZ,gBAAkBpd,GAAGqd,gBAAgBC,UAAYC,UAAUC,UAAUC,MAAM,cAAgBF,UAAUC,UAAUC,MAAM,UAAW,CACxI9e,OAAOwgB,oBAAoB,WAAYjD,GAAkB,GACzDvd,OAAOwgB,oBAAoB,WAAYhD,GAAkB,OACtD,CACHxd,OAAOwgB,oBAAoB,OAAQjD,GAAkB,GACrDvd,OAAOwgB,oBAAoB,QAAShD,GAAkB,MAkInC3Y,MAAM2D,GAEzBA,EAAKwE,IAAIxE,EAAKzG,MAAM4B,MAAMC,gBAC1B4E,EAAKwE,IAAIxE,EAAKzG,MAAM4B,MAAMI,cAE1B4Q,EAAwB7L,KAAKN,GAE7BA,EAAKuB,MAAMgJ,UAAU5K,MAAQ,GAC7BK,EAAKuB,MAAMgJ,UAAUQ,UAAW,EAChC/K,EAAKuB,MAAMuI,UAAUiB,UAAW,EAEhC/K,EAAKuB,MAAMiJ,SAAS7K,MAAQ,GAC5BK,EAAKuB,MAAMiJ,SAASO,UAAW,EAC/B/K,EAAKuB,MAAMwI,SAASgB,UAAW,EAE/B/K,EAAKoD,MAAMpD,EAAKzG,MAAM4C,OAAOvB,UAC7BoF,EAAKoD,MAAMpD,EAAKzG,MAAM4C,OAAOD,KAI7B,OAAO,GAGX,GAAI8D,EAAKO,KAAK0X,iBAAkB,CAC5BjY,EAAKI,IAAIuE,MAAM3E,EAAK4E,gBAAgB,4BAA6B,CAC7DiN,SAAU,MAGd,OAAOgG,IACJ,OAAOA,KAIlBta,EAAS2a,gBAAkB,WACvB,MAAMlY,EAAOpH,KACb,OAAO,IAAI2M,QAAQ,SAAUuB,EAASC,GAClC,IAAIoR,EAAS,GAEbnH,YAAYoH,OAAOpX,KAAK,SAAUoX,GAQ9B,GAAmB,IAPnBA,EAAOA,EAAKjS,OAAO,SAAUkS,GACzB,OAA6D,IAAvDA,EAAElV,QAAQnD,EAAKzG,MAAMoB,gBAAgBE,eAA2E,IAAnDwd,EAAElV,QAAQnD,EAAKzG,MAAMoB,gBAAgBC,WAC7F,UAAU0d,KAAKD,MAKrBrhB,OAAa,CAClBgJ,EAAKiH,gBAAkBkR,EACvBrR,EAAQqR,GAGZ,MAAMtQ,EAAW,IAAIC,MAAMsQ,EAAKphB,QAChCohB,EAAK5U,QAAQ,SAAU9D,EAAKqI,GACxBF,EAASE,GAAO,IAAIxC,QAAQ,SAAUgT,EAAKC,GACvCxH,YAAY0F,QAAQhX,EAAK,SAAUK,EAAG0Y,GAClCF,EAAIE,SAKhBlT,QAAQC,IAAIqC,GAAU7G,KAAK,SAAU0X,GACjC,GAAIA,GAAWA,EAAQ1hB,OAAQ,CAC3B0hB,EAAQlV,QAAQ,SAAUsJ,IAClBA,EAAI0J,KAAKmC,MAAM7L,cACFhF,MACbqQ,EAASA,EAAOS,OAAO9L,GAEvBqL,EAAO9S,KAAKyH,KAIpB,IAAI+L,EAAcV,EAAOnhB,OAAS,EAAI8hB,EAAaX,GAAUA,EAC7DnY,EAAKiH,gBAAkB4R,EACvB/R,EAAQ+R,WAU5B,IAAIC,EAAe,SAAUX,GACzB,IAAIU,EAAc,GAElB,IAAK,IAAIrK,KAAS2J,EACd,GAAIA,EAAO3J,IAAqC,iBAAnB2J,EAAO3J,GAAsB,CACtDqK,EAAYxT,KAAK8S,EAAO3J,IACxBqK,EAAYE,KAAK,SAAUC,EAAGC,GAC1B,MAAwB,iBAAZD,EAAM,MACPngB,GAAG2D,KAAKkV,WAAWsH,EAAE/W,KAAKiX,eAAiBF,EAAE/W,KAAKiX,cAAcD,EAAEhX,MAC7D,IAK5B,OAAO4W,GAIXtb,EAAS4b,gBAAkB,SAAUhB,GACjC,MAAMnY,EAAOpH,KACb,OAAO,IAAI2M,QAAQ,SAAUuB,EAASC,GAClC,MAAMc,EAAW,GACjBsQ,EAAO3U,QAAQ,SAAU4V,GACrBvR,EAASxC,KAAK,IAAIE,QAAQ,SAAUgT,EAAKC,GACrCxH,YAAYM,QAAQtR,EAAKzG,MAAMoB,gBAAgBC,SAAW,IAAMwe,EAAEjS,IAAKqP,KAAKC,UAAU2C,GAAI,SAAUrZ,EAAG0Y,GACnGF,EAAIE,UAKhBlT,QAAQC,IAAIqC,GAAU7G,KAAK,WACvBhB,EAAKkY,kBAAkBlX,KAAK,WACxBhB,EAAKyR,aACL3K,WAOhBvJ,EAAS8b,mBAAqB,WAC1B,MAAMrZ,EAAOpH,KACb,OAAO,IAAI2M,QAAQ,SAAUuB,EAASC,GAC7B/G,EAAKiH,gBAMNH,EAAQ9G,EAAKiH,iBALbjH,EAAKkY,kBAAkBlX,KAAK,SAAUiG,GAClCH,EAAQG,QASxB1J,EAASkU,WAAa,WAClB,IAAIzR,EAAOpH,KAEOoH,EAAKuB,MAAM6I,UAAUrB,iBAAiB,MAC9CvF,QAAQ,SAAUgJ,GACxBA,EAAGC,MAAMC,QAAU,SAGvB1M,EAAKqZ,qBAAqBrY,KAAK,SAAUmX,GAErC,GAAImB,EAASnB,GAAS,CAClBnY,EAAKuB,MAAM6I,UAAUrB,iBAAiB,yDAAyDvF,QAAQ,SAAUgJ,GAC7GA,EAAGC,MAAMC,QAAU,KAEvB1M,EAAKuB,MAAMqI,YAAYmB,UAAW,MAEjC,CACD,MAAMwO,EAAuBvZ,EAAKoP,mBAClC,IAAIoK,EACAD,IACAC,EAAyBD,EAAqBzK,QAAQ3H,KAE1DnH,EAAKuB,MAAM6I,UAAUrB,iBAAiB,eAAevF,QAAQ,SAAUgJ,GACnExM,EAAKuB,MAAM6I,UAAUkB,YAAYkB,KAGrC,IAAK,IAAItV,EAAI,EAAGA,EAAIihB,EAAOnhB,OAAQE,IAAK,CACpC,IAAIkiB,EAAIjB,EAAOjhB,GACI,iBAAR,GACP8I,EAAKmE,gBAAgBnE,EAAK3G,MAAQ,cAAe,CAC7ChB,GAAInB,EAAGiQ,IAAKiS,EAAEjS,IAAKlF,KAAMmX,EAAEnX,KAAOmX,EAAEnX,KAAKE,OAAS,IACnD,SAAUiC,GACT,MACMqV,GADS,IAAIC,WACEC,gBAAgBvV,EAAM,aAAatH,KAAK8c,WAC7D5Z,EAAKuB,MAAM6I,UAAUrN,YAAY0c,KAKzCD,GACAxZ,EAAK6Z,iBAAiB7Z,EAAKuB,MAAM6I,UAAU5D,cAAc,gBAAkBgT,EAAyB,OAGxGxZ,EAAKuB,MAAMqI,YAAYmB,UAAW,MAK9CxN,EAASuc,kBAAoB,WAGpBtiB,OAAOuiB,IACRlhB,GAAGG,WAAWH,GAAGmF,OAAOoT,IAAI4I,MAGhC,MAAMC,EAAUF,GAAGG,OAAO,0CAA0CC,OAAOC,wBAN9DxhB,KAORyhB,MAAQxd,SAASoO,cAAc,OAPvBrS,KAQRyhB,MAAMvU,UAAUQ,IAAI,SARZ1N,KASRyhB,MAAM5N,MAAM6N,MAAQL,EAAQK,MAAQ,KAT5B1hB,KAURyhB,MAAM5N,MAAM8N,OAASN,EAAQM,OAAS,KAV9B3hB,KAYR4hB,cAAgB3d,SAASoO,cAAc,OAZ/BrS,KAaR4hB,cAAc1U,UAAUQ,IACzB,gBAdS1N,KAeJS,MAAQ,kCACbR,GAAGmF,OAAOgI,QAAQwD,QAhBT5Q,KAiBR4hB,cAAc/N,MAAM6N,MAAQ,KAjBpB1hB,KAkBR4hB,cAAc/N,MAAM8N,OAASN,EAAQM,OAAS,KAlBtC3hB,KAoBR6hB,kBAAoB5d,SAASoO,cAAc,OApBnCrS,KAqBR6hB,kBAAkB3U,UAAUQ,IAC7B,oBACA,oDACA,QAxBS1N,KAyBR6hB,kBAAkBhO,MAAM6N,MAAQL,EAAQK,MAAQ,KAzBxC1hB,KA0BR6hB,kBAAkBhO,MAAM8N,OAASN,EAAQM,OAAS,KA1B1C3hB,KA4BRyhB,MAAM5N,MAAMiO,IAAMT,EAAQS,IAAM,KA5BxB9hB,KA6BRyhB,MAAM5N,MAAMkO,KAAOV,EAAQU,KAAO,KA7B1B/hB,KA8BRyhB,MAAM5N,MAAMmO,OAASX,EAAQW,OAAS,KA9B9BhiB,KA+BRyhB,MAAM5N,MAAMoO,MAAQZ,EAAQY,MAAQ,KA/B5BjiB,KAgCRyhB,MAAM5N,MAAM+F,SAAW,WAhCf5Z,KAiCRyhB,MAAM5N,MAAMqO,OAAS,MAjCbliB,KAkCRyhB,MAAM5N,MAAMC,QAAU,OAlCd9T,KAoCR4hB,cAAczd,YApCNnE,KAoCuB6hB,mBApCvB7hB,KAqCRyhB,MAAMtd,YArCEnE,KAqCe4hB,eAC5B3d,SAASC,KAAKC,YAtCDnE,KAsCkByhB,QAInC9c,EAASwd,mBAAqB,WAC1B,MAAM/a,EAAOpH,KACb,GAAIoH,EAAKqa,MAAO,CACZra,EAAKqa,MAAMjR,cAAckC,YAAYtL,EAAKqa,OAC1Cra,EAAKqa,MAAQ,KACbra,EAAKwa,cAAgB,KACrBxa,EAAKya,kBAAoB,OAIjCld,EAASyd,iBAAmB,SAAUC,EAAUC,EAASC,EAAUC,GACpDxiB,KAEFyhB,OAAsC,SAFpCzhB,KAEYyhB,MAAM5N,MAAMC,UAFxB9T,KAGFyhB,MAAM5N,MAAMC,QAAU,IAHpB9T,KAMN4hB,cAAc1U,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QAEtD,IAAI6R,EAAOJ,EAAS5H,EAChBiI,GAAYD,EAAOxkB,KAAKC,MAAMmkB,EAASM,EAAE,GAAKL,EAAQ,GAAID,EAASM,EAAE,GAAKL,EAAQ,KAAOC,EAAW,IAT7FviB,KAWN4hB,cAAc/N,MAAM6N,MAAQgB,EAAW,IAE5C,IAEIE,EACAC,EAHAvJ,EAbOtZ,KAaOwH,IAAIjH,QAAQ+Y,QAbnBtZ,KAakCwH,IAAIjH,QAAQ+Y,OAAOjC,QAAQ,IAAK,WAAQc,EACjF2K,EAAMC,SAAST,EAAQ,GAAGU,QAAQ,IAAInJ,eAAeP,GAGzD,GAAKmJ,EAAO,IAAQ,EAAG,CACnBG,EAAO3kB,KAAK8b,MAAO0I,EAAO,IAAQ,KAClCI,EAAU,SACP,CACHD,EAAO3kB,KAAK8b,MAAO0I,EAAO,IAAQ,KAAO,IACzCI,EAAU,MAGdD,EAAOA,EAAK/I,eAAeP,GAzBhBtZ,KA2BN6hB,kBAAkBpW,UAAY,cAAgBqX,EAAM,sBAAuCF,EAAOC,EAAU,iBAAmBL,EAAW,aAAeA,EAAShU,SAAW,UAAY,KAIlM7J,EAASse,SAAW,SAAUC,EAAUC,GACpC,IAAIC,EAAOD,EAASD,EAChBzI,EAAI,GACJ4I,EAAiBplB,KAAKqlB,MAAMF,EAAO,IAAO,GAAK,GAAK,IACxDA,GAAyB,IAAjBC,EAAwB,GAAK,GAAK,GAE1C,IAAIE,EAAkBtlB,KAAKqlB,MAAMF,EAAO,IAAO,GAAK,IACpDA,GAA0B,IAAlBG,EAAyB,GAAK,GAEtC9I,EAAE1U,EAAIwd,EAAoC,GAAjBF,EAEzB,IAAIG,EAAoBvlB,KAAKqlB,MAAMF,EAAO,IAAO,IACjDA,GAA4B,IAApBI,EAA2B,GAEnC/I,EAAEgJ,EAAID,EAEN/I,EAAEiJ,EAAIzlB,KAAKqlB,MAAMF,EAAO,KAExB,OAAOnjB,GAAG2D,KAAK+f,OAAO,GAAIlJ,EAAG,CAAEjM,UAAW,QAAUiM,EAAE1U,GAAG6d,OAAO,GAAK,KAAO,QAAUnJ,EAAEgJ,GAAGG,OAAO,GAAK,KAAO,QAAUnJ,EAAEiJ,GAAGE,OAAO,MAGxIjf,EAASgS,cAAgB,SAAU/C,GAC/B,IAAIxM,EAAOpH,KAEXoH,EAAKwQ,eAAiB,EAEtBxQ,EAAKqP,UAAU7C,GAAI,GAAOxL,KAAK,WAC3BhB,EAAKO,KAAKgP,mBAIlBhS,EAAS8R,UAAY,SAAU7C,EAAIiQ,GAC/B,IAAIzc,EAAOpH,KAEXsc,EAAyB5U,KAAKN,GAC9B,OAAO,IAAIuF,QAAQ,SAAUuB,EAASC,GAClC/G,EAAK6Z,iBAAiBrN,GACtBxM,EAAK0c,iBAAiBlQ,GAAIxL,KAAK,WAC3BhB,EAAK2c,eAAenQ,GAAIxL,KAAK,KACzBhB,EAAK2R,WAEL7K,WAOhBvJ,EAASof,eAAiB,SAAUnQ,EAAIoQ,GACpC,IAAI5c,EAAOpH,KAEX,OAAO,IAAI2M,QAAQ,CAACuB,EAASC,KACzB,MAAM8V,EAAoB,WAClB7c,EAAK8c,oBACL9c,EAAK8c,kBAAkBC,eAAiB/c,EAAKE,WAAWqD,SAAS4C,OAAQnE,KAC5DnJ,GAAGmJ,QAAQoG,QAAUpG,aAAmBnJ,GAAGmJ,QAAQoG,QAAavP,GAAGmJ,QAAQyB,OAASzB,aAAmBnJ,GAAGmJ,QAAQyB,QAC5H,KAIX,GAAImZ,EAAS,CAET5c,EAAKO,KAAKgQ,mBACVvQ,EAAK2N,YAAW,EAAOnB,GACvB,OAGJ,IAAKxM,EAAKgd,SAAU,CAChBhd,EAAKgd,SAAWhd,EAAK2c,eAAejb,KAAK1B,EAAMwM,GAAI,GACnDhV,OAAOyR,iBAAiB,SAAUjJ,EAAKgd,UAAU,GAGrD,IAAIC,EAAmB,GAEnBjd,EAAKuB,MAAM2b,iBACXld,EAAKuB,MAAM2b,eAAiBld,EAAKuB,MAAM2b,eAAeC,YAEvC,SAAU3Q,GACzB,OAAO,IAAIjH,QAAQ,SAAUuB,EAASC,GAClClO,GAAGsY,QACEtY,GAAGukB,OAASvkB,GAAGukB,KAAKC,UACrBxkB,GAAGI,YAAc,oBACjB,WACI+G,EAAKsd,gBAAgB9Q,GAAIxL,KAAK,SAAUO,GACpC,IAAIgc,EAAUhc,EAAM8F,KACpB,GAAIkW,EAAJ,CACI,IAAI5lB,EAAG+jB,EAAK/jB,EAAI,GAAI+jB,EAAM,GAC1B,IACI8B,EAAQC,EAIRpV,EALAqV,GAAQ,EAERC,EAAgB,GAChBC,EAAO,GAIP/e,GAAI,IAAK6I,GAAGzE,OAAO0E,SAAWC,aAAa2V,GAE3CM,EAAc,WACd,GAAIxV,EAAKyV,aAAepW,GAAGW,KAAK0V,eAAeC,KAC3C3V,EAAKyV,aAAepW,GAAGW,KAAK0V,eAAeE,KAAM,CACjD,IAAI9C,EAAW,EACf,GAAInb,EAAKI,IAAIkS,MAAQtS,EAAKI,IAAIjH,QAAQ+kB,OAAQ,CAC1C7b,KAAO,IAAIqF,GAAGW,KAAK8V,WAAWtlB,GAAG2D,KAAKuH,UAAUsE,EAAK+V,iBAAkBpe,EAAKI,IAAIkS,IAAKtS,EAAKI,IAAIjH,QAAQ+kB,SACtG/C,EAAW9Y,KAAKgc,iBAEhBlD,EAAW9S,EAAKgW,YAEpB,OAAOC,YAAYnD,EAAW,KAAMS,QAAQ,IAGhD,OAAO,MAEPzjB,EAAU,WACV,GAAIkQ,EAAKyV,aAAepW,GAAGW,KAAK0V,eAAeE,MAC3C5V,EAAKyV,aAAepW,GAAGW,KAAK0V,eAAeQ,IAAK,CAChD,IAAIvC,EAAO3T,EAAKmW,oBAAoB,GAAKnW,EAAKoW,qBAAqB,GACnE,MAAO,CACHnC,EAAGzlB,KAAKqlB,MAAOF,EAAO,IAAQ,IAC9BK,EAAGxlB,KAAKqlB,MAAQF,EAAO,IAAe,IACtCrd,EAAG9H,KAAKqlB,MAAQF,EAAO,KAAoB,KAInD,OAAO,MAGP0C,EAAO,SAAU/mB,GACjB,GAAIslB,EAAiBjmB,OAAS,EAAG,CAC7B,IAAImkB,EAAW,EACf8B,EACKzZ,QAAQ,SAAUrC,EAAO4G,EAAK4W,GAC3B,IAAIC,EAAe,IAAR7W,EAAY5G,EAAQwd,EAAI5W,EAAM,GAEzC,GAAI/H,EAAKI,IAAIkS,MAAQtS,EAAKI,IAAIjH,QAAQ+kB,OAAQ,CAC1C/c,EAAQtI,GAAG2D,KAAKuH,UAAU5C,EAAOnB,EAAKI,IAAIkS,IAAKtS,EAAKI,IAAIjH,QAAQ+kB,QAChEU,EAAO/lB,GAAG2D,KAAKuH,UAAU6a,EAAM5e,EAAKI,IAAIkS,IAAKtS,EAAKI,IAAIjH,QAAQ+kB,QAGlE,MAAMW,EAAK1d,EAAM,GAAKyd,EAAK,GACrBE,EAAK3d,EAAM,GAAKyd,EAAK,GAC3BzD,GAAYtkB,KAAKO,KAAKynB,EAAKA,EAAKC,EAAKA,GAErCnnB,EAAE0N,KAAKiZ,WAAWnD,EAASS,QAAQ,SAK/CmD,EAAe,SAAUrD,GAEzB,IADA,IACSxkB,EAAI,EAAGA,EAAI+lB,EAAiBjmB,OAAQE,IAAK,CAC9C,KAAI+lB,EAAiB/lB,GAAGF,OAAS,GAc5B,CACD8P,EAAQ,MACR,OAfA,IAAI2R,EAAK5hB,KAAK8b,MAA+B,GAAzBsK,EAAiB/lB,GAAG,IAAW,GAC/CwmB,GAASjF,EAAI,IACbiF,GAAQ,GAEZhC,EAAIrW,KAAKoT,GAEA,GAALvhB,IACAsmB,EAASC,EAAShF,GAEtB+E,EAAS3mB,KAAKmoB,IAAIxB,EAAQ/E,GAC1BgF,EAAS5mB,KAAKe,IAAI6lB,EAAQhF,KAUtC5Z,EAAEsH,OAAO,SAAUnE,GACf,MAAyD,eAAlDA,EAAQid,cAAcC,UAAU9c,eAAoF,oBAAlDJ,EAAQid,cAAcC,UAAU9c,gBAC1GoB,QAAQ,SAAUxB,GAGjB,QAFAqG,EAAOrG,EAAQid,eAEFC,UAAU9c,eACnB,IAAK,aAED,GAAIb,EAAMoE,SAAW+B,GAAGW,KAAK0V,eAAeE,MACxC1c,EAAMoE,SAAW+B,GAAGW,KAAK0V,eAAeC,IAAK,CAE7CJ,EAAOzlB,IACF0lB,IACLF,EAAgB9kB,GAAGukB,KAAKC,UAAU8B,iBAAiB,CAAErb,OAAQuE,EAAK+V,iBAAkBgB,mBAAoBpf,EAAK9C,UAC7G+f,EAAmBA,EAAiBrE,OAAOvQ,EAAK+V,kBAEhDM,EAAK/mB,GACLonB,EAAarD,GAEjB,MACJ,IAAK,kBAED,GAAIna,EAAMoE,SAAW+B,GAAGW,KAAK0V,eAAeE,MACxC1c,EAAMoE,SAAW+B,GAAGW,KAAK0V,eAAeC,IAIxC,IAFA,IAAIqB,EACAC,EAAKjX,EAAKkX,iBACLroB,EAAI,EAAGA,EAAIooB,EAAGtoB,OAAQE,IAAK,CACtB2mB,EAAYyB,EAAGpoB,IAErBooB,EAAGpoB,GAAG4mB,aAAepW,GAAGW,KAAK0V,eAAeE,OAC5CoB,GAAiBC,EAAGpoB,GAAGsnB,oBAAoB,GAAKc,EAAGpoB,GAAGunB,qBAAqB,IAE/ExB,EAAmBA,EAAiBrE,OAAO0G,EAAGpoB,GAAGknB,kBAE7CiB,IAASzB,EAAOzlB,KAEpBumB,EAAK/mB,GACLonB,EAAarD,GAIrB,MACJ,QACI,OAAO,QAKfA,aAAe5T,OAAuB,GAAd4T,EAAI1kB,SAC5B0mB,GAAQ,GAGZ1d,EAAK6D,mBAAsB6Z,EAAwG,KAAhG7kB,GAAG2D,KAAK+f,OAAO,GAAI,CAAEqB,KAAMA,EAAMlC,IAAKA,EAAK/jB,EAAGA,EAAG6nB,KAAMhC,EAAQiC,KAAMhC,GAAUE,GAElH7W,EAAQ9G,EAAK6D,yBAIjBiD,EAAQ,aAQ5B4Y,CAAalT,GAAIxL,KAAK,SAAUqG,GAC5B,GAAY,MAARA,EAAc,CACVA,EAAKuW,OAAMvW,EAAKuW,MAAQ,QAAUvW,EAAKuW,KAAKjf,GAAG6d,OAAO,GAAK,KAAO,QAAUnV,EAAKuW,KAAKvB,GAAGG,OAAO,GAAK,KAAO,QAAUnV,EAAKuW,KAAKtB,GAAGE,OAAO,IAC9InV,EAAKvD,OAASmZ,EACdjd,EAAK2f,cAAe,MAEnB,CACD3f,EAAK2f,cAAe,EACpBtY,EAAO,CACHuY,IAAK5f,EAAK4E,gBAAgB,6BAIlCyC,EAAKwY,UAAY7f,EAAKvC,WAAWC,WACjC2J,EAAKyY,UAAY9f,EAAKvC,WAAWE,WAEjC0J,EAAK0Y,SAAW/f,EAAKvC,WAAWG,UAChCyJ,EAAK2Y,YAAchgB,EAAKvC,WAAWI,aACnCwJ,EAAK4Y,SAAWjgB,EAAKvC,WAAWK,UAEhCkC,EAAKI,IAAI8f,IAAIrnB,GAAGmF,OAAOC,MAAMkiB,UAAW,SAAUpgB,GAC9CC,EAAK8Z,oBACLhT,MAGJ,GAAK9G,EAAK8c,kBA+EH,CACHD,IACA7c,EAAK8c,kBAAkBzM,OACvBrQ,EAAKI,IAAIuG,QAAQ3G,EAAKzG,MAAM4B,MAAMO,UAAW,CAAE2L,KAAMA,QAlF5B,CAEpB7P,OAAO4oB,IACRvnB,GAAGG,WAAWH,GAAGmF,OAAOoT,IAAI4I,MAAQnhB,GAAGI,YAAc,wBAGzD,IAeI4a,EAfAC,EAAsB,CACtBC,QAAS,QACTC,OAAQ,CACJC,KAAMjU,EAAK4E,gBAAgB,sBAC3BhN,IAAKoI,EAAK4E,gBAAgB,uBAE9Byb,OAAQrgB,EAAKzG,MAAM4B,MAAMO,UACzB4kB,QAAStgB,EAAKzG,MAAM4B,MAAMQ,WAC1B4kB,MAAO,CACH9hB,IAAKuB,EACLwgB,WAAYjjB,EAASkjB,uBACrBC,QAASnjB,EAASojB,sBAK1B,MAAMC,EAAuB,SAAUxM,GACnCN,EAAoBtB,SAAW4B,EAAiBC,SAASC,MACzDT,EAAaO,EAAiBG,WAAW,eAAgBT,IAG7D,GAAI9T,EAAK7G,QAAQqb,UAAW,CACxB,IAAIJ,EAAmBpU,EAAKI,IAAIqU,mBAAmB,cAAgBzU,EAAK7G,QAAQqb,UAAU,GAAGE,cAAgB1U,EAAK7G,QAAQqb,UAAUG,UAAU,IAAI,GAC7IP,EAGDwM,EAAqBxM,GAFrBpU,EAAKI,IAAImU,WAAWvU,EAAK7G,QAAQqb,WAAWxT,KAAK4f,OAIlD,CACH9M,EAAoBjO,IAAMhJ,SAASoO,cAAc,OACjDjL,EAAKI,IAAIyF,IAAI9I,YAAY+W,EAAoBjO,KAC7CgO,EAAa7T,EAAKI,IAAImU,WAAW,eAAgBT,GAGrDD,EAAW7S,KAAK,SAAU8b,GACtBA,EAAkB+D,OAAS7gB,EAC3BA,EAAK8c,kBAAoBA,EAEzBD,IACAC,EAAkBrJ,gBAAgBzS,KAAK,WAEnC8b,EAAkBL,iBAAmB,SAAU1c,GACvCC,EAAKE,aAAgBF,EAAKE,WAAW4gB,iBAAmD,GAAhC9gB,EAAKE,WAAW6gB,cACxE/gB,EAAKO,KAAKygB,mBAAmB1gB,KAAKN,EAAKO,OAE/Cuc,EAAkBkE,mBAAqB,SAAUjhB,GACzCC,EAAKE,YAAcF,EAAKE,WAAW4gB,iBAAmB9gB,EAAKE,WAAW6gB,aAAe,GACrF/gB,EAAKO,KAAKkc,iBAAiBnc,KAAKN,EAAKO,OAG7Cuc,EAAkBjX,IAAIoD,iBAAiB,YAAa6T,EAAkBkE,oBACtElE,EAAkBjX,IAAIoD,iBAAiB,WAAY6T,EAAkBL,kBAErEzc,EAAKI,IACAuC,GAAG9J,GAAGmF,OAAOC,MAAMgjB,gBAAiB,WAC7BjhB,EAAKqa,QACLra,EAAKqa,MAAM5N,MAAMC,QAAU,UAGlC/J,GAAG9J,GAAGmF,OAAOC,MAAMijB,gBAAiB,WAC7BlhB,EAAKqa,QACLra,EAAKqa,MAAM5N,MAAMC,QAAU,MAGlC/J,GAAG9J,GAAGmF,OAAOC,MAAMkjB,kBAAmB,WAC/BnhB,EAAKqa,QACLra,EAAKqa,MAAM5N,MAAMC,QAAU,UAIvC1M,EAAKI,IAAIuG,QAAQ3G,EAAKzG,MAAM4B,MAAMO,UAAW,CAAE2L,KAAMA,QAUjEvH,EAAkBA,EAAgB4B,KAAK1B,GACvCA,EAAKI,IAAIuC,GAAG9J,GAAGmF,OAAOC,MAAMwG,cAAe3E,QAKvDvC,EAAS6F,MAAQ,SAAUzC,GACvB,IAAIX,EAAOpH,KAEX,GAAIoH,EAAKgd,SAAU,CACfxlB,OAAOwgB,oBAAoB,SAAUhY,EAAKgd,UAAU,GACpDhd,EAAKgd,cAAWjM,EAGpB,GAAIpQ,GAAaX,EAAKzG,MAAM4C,OAAOC,MAAO,CAEtC4D,EAAKE,WAAWkhB,gBAGZphB,EAAK8c,mBACL9c,EAAK8c,kBAAkBhI,eACpB9U,EAAK6D,mBAGZ7D,EAAKO,KAAKgQ,mBAEVvQ,EAAKO,KAAK6C,QAGVpD,EAAKuB,MAAM6I,UAAUrB,iBAAiB,MAAMvF,QAAQ,SAAUgJ,GAC1DA,EAAG1G,UAAUS,OAAOvG,EAAKzG,MAAMC,QAAQG,iBAG3CqG,EAAKI,IAAIuG,QAAQ3G,EAAKzG,MAAM4B,MAAMQ,YAElCqE,EAAKjC,gBAAkB,OAIpB,CACHiC,EAAKyC,cAAc2e,gBACnBphB,EAAKiB,SAASmgB,kBAItB7jB,EAAS4P,UAAY,SAAUhU,GAC3B,MAAM6G,EAAOpH,KACb,OAAO,IAAI2M,QAAQ,SAAUuB,EAASC,GAElC,IAAIsa,EAAUloB,EAAQkoB,SAAWrhB,EAAK4E,gBAAgB,sBAElD0c,EAAQ,SAAUrhB,GAClB,IAAI8E,EACJA,EAAO/E,EAAKgF,sBAAsBC,UAElC,IAAIsF,EAAYpR,EAAQ+L,kBAAoBlF,EAAKuB,MAAMgJ,UAAU5K,MAAMwC,OAEnEgW,EAASnY,EAAKiH,gBACbkR,IACDA,EAAS,IAGb,IAAIoJ,EAAYvhB,EAAKO,KAAK6U,mBAAmBnV,GAAO,EAAM9G,EAAQuM,cAE9D8b,EAAQ,SAAUzc,GAClB/E,EAAKuB,MAAMgJ,UAAU5K,MAAQ,GAC7BK,EAAKuB,MAAMgJ,UAAUQ,UAAW,EAChC/K,EAAKuB,MAAMuI,UAAUiB,UAAW,EAEhC/K,EAAKuB,MAAMiJ,SAAS7K,MAAQ,GAC5BK,EAAKuB,MAAMiJ,SAASO,UAAW,EAC/B/K,EAAKuB,MAAMwI,SAASgB,UAAW,EAE/B/K,EAAKgF,sBAAsBqJ,WAAWtJ,GAEtCmQ,EAAyB5U,KAAKN,IAG9ByhB,EAAW,CACXxf,KAAMsI,EACNlD,KAAMka,EAAUhe,SAChBoC,OAAQ4b,EAAU5b,OAClB2M,IAAKtS,EAAK3C,YAGdxE,GAAGsY,QACE3Z,OAAOkqB,QACR,CAAC7oB,GAAGI,YAAcJ,GAAGmF,OAAOoT,IAAIuQ,MAChC,WACI,IAAIC,EAAOF,QAAQlL,KAAKC,UAAUgL,IAE9BI,EAAe1J,EAAO/X,IAAI,SAAU0hB,GACpC,IAAIC,EAAcvL,KAAKmC,MAAMnC,KAAKC,UAAUqL,WACrCC,EAAY5a,IACnB,GAAIya,IAASF,QAAQlL,KAAKC,UAAUsL,IAChC,OAAOD,EAAW3a,IACf,CACH,MAAM6a,EAAa,IAAIta,GAAGzE,OAAO0E,QAEjC,IAAIpE,EAAWye,EAAWpa,aAAama,EAAY1a,MAE/CC,EAAYzQ,KAAK0Q,IAAI,GAAI1O,GAAGmF,OAAOwJ,iBAAmB,GAE1DjE,EAASC,QAAQ,SAAUxB,GACvB,IAAIqG,EAAOxP,GAAG2D,KAAKylB,gBAAgBppB,GAAG2D,KAAKmM,gBAAgB3G,EAAQid,cAAcb,iBAAkB9W,IACnGtF,EAAQid,cAAciD,eAAe7Z,KAGzC0Z,EAAY1a,KAAO2a,EAAWG,cAAc5e,GAE5C,OAAIqe,IAASF,QAAQlL,KAAKC,UAAUsL,IACzBD,EAAW3a,IAEX,QAIhBhB,OAAO,SAAUgB,GAChB,OAAe,OAARA,IAGX,MAAMib,EAAgB,SAAUjb,GAC5B,OAAOnH,EAAKkY,kBAAkBlX,KAAK,WAC/BhB,EAAKyR,aAGL,IADA,IAAIjD,EACKtX,EAAI,EAAGA,EAAI8I,EAAKiH,gBAAgBjQ,OAAQE,IAC7C,GAAI8I,EAAKiH,gBAAgB/P,GAAGiQ,MAAQA,EAAK,CACrCqH,EAAQtX,EACR,MAIR,OAAOsX,KAIf,GAA4B,IAAxBqT,EAAa7qB,OAAc,CAE3ByqB,EAASta,IAAMjP,KAAKR,MAAQb,KAAKwrB,SACjClK,EAAO9S,KAAKoc,GACZtJ,EAASW,EAAaX,GAEtB,IACInY,EAAKmZ,gBAAgBhB,GAAQnX,KAAK,WAC9BhB,EAAKI,IAAIuE,MAAM0c,EAAS,CAAExP,SAAU,MAEpC2P,EAAMzc,GAENqd,EAAcX,EAASta,KAAKnG,KAAK,SAAUwN,GACvC1H,EAAQ0H,OAIlB,MAAO2I,GACLte,GAAG6S,MAAM1L,EAAK4E,gBAAgB,8BAAgC,KAAOuS,EAAMkK,SAC3EG,EAAMzc,GACNgC,EAAOoQ,QAER,CACHrL,QAAQC,IAAI,yCAEZyV,EAAMzc,GAENqd,EAAcP,EAAa,IAAI7gB,KAAK,SAAUwN,GAC1C1H,EAAQ0H,SAqB5B,GAAIxO,EAAKkF,iBACLoc,EAAMthB,EAAKE,iBACV,GAAgD,GAA5CF,EAAKuB,MAAMgJ,UAAU5K,MAAMwC,OAAOnL,OAAa,CACpDgJ,EAAKuB,MAAMgJ,UAAU5K,OAAQ,IAAIzH,MAAOua,iBACxC6O,EAAMthB,EAAKyC,oBAGX6e,EAAMthB,EAAKyC,kBAKvBlF,EAAS6P,YAAc,WACnB,IAEIkV,EAFO1pB,KAEa2I,MAAMiJ,SAAS7K,MAAMwC,OACxCmgB,IACDA,GAAe,IAAIpqB,MAAOua,kBAG9B,IAAI1N,EAPOnM,KAOKoM,sBAAsBC,UAEtCiQ,EAAyB5U,KATd1H,MAAAA,KAWN2H,KAAK6M,YAXCxU,KAWgBuc,aAAa3C,SAAU,CAC9CvQ,KAAMqgB,EACN5G,IAbO9iB,KAaGuc,aAAaoN,QACvB3E,MAAM,IAAI1lB,MAAOC,YAdVS,KAiBN2I,MAAMiJ,SAAS7K,MAAQ,GAjBjB/G,KAkBN2I,MAAMiJ,SAASO,UAAW,EAlBpBnS,KAmBN2I,MAAMwI,SAASgB,UAAW,EAG/BlS,GAAG2D,KAAKqU,QAAQC,qBAtBLlY,KAsB+BW,MAAMoB,gBAAgBE,aAtBrDjC,KAsBwE2H,KAAK6U,mBAtB7Exc,KAsBqG6J,eAAec,UAtBpH3K,KAwBNoM,sBAAsBqJ,WAAWtJ,IAG1CxH,EAASkS,cAAgB,SAAU+S,EAASC,GACxC,IAAIziB,EAAOpH,KAEXoH,EAAKqZ,qBAAqBrY,KAAK,SAAUmX,GACrC,GAAIA,GACIA,EAAOqK,GAAU,CACjBrK,EAAOqK,GAASvgB,KAAOwgB,EAEvBziB,EAAKmZ,gBAAgBhB,OAMrC5a,EAASiS,YAAc,SAAUhD,GAC7B,IAAIxM,EAAOpH,KAEXoH,EAAKqZ,qBAAqBrY,KAAK,SAAUmX,GACrC,GAAIA,EAAQ,CACR,IAAIuK,EAASlW,EAAGsC,QAAQzW,GACxB,GAAI8f,EAAOuK,GAAS,CAChB,IAAIvb,EAAMgR,EAAOuK,GAAQvb,IAEzBtO,GAAG8pB,QAAQ3iB,EAAK4E,gBAAgB,wBAAyB,WAErD,MAAMge,EAAgB5iB,EAAKoP,mBACvBwT,GAAiBA,EAAc9T,QAAQzW,KAAOqqB,GAC9C1iB,EAAKoD,MAAMpD,EAAKzG,MAAM4C,OAAOC,OAGjC4U,YAAYC,WAAWjR,EAAKzG,MAAMoB,gBAAgBC,SAAW,IAAMuM,GAAKnG,KAAK,WACzEhB,EAAKkY,kBAAkBlX,KAAK,WACxBhB,EAAKyR,iBAEVoR,MAAM,SAAUC,GACfhX,QAAQC,IAAI+W,MAGjB,mBAMnBvlB,EAASsc,iBAAmB,SAAUrN,GAClC,IAAIxM,EAAOpH,KAENoH,EAAKkX,UACNlX,EAAK2R,WAGT3R,EAAKuB,MAAM6I,UAAUrB,iBAAiB,sBAAsBvF,QAAQ,SAAUwF,GAC1EA,EAAKiG,aAAa,QAASjG,EAAKgE,eAEpChN,EAAKuB,MAAM6I,UAAUrB,iBAAiB,MAAMvF,QAAQ,SAAUgJ,GAC1DA,EAAG1G,UAAUS,OAAOvG,EAAKzG,MAAMC,QAAQG,iBAG3C6S,EAAG1G,UAAUQ,IAAItG,EAAKzG,MAAMC,QAAQG,eAEpC6S,EAAGyC,aAAa,QAASjP,EAAK4E,gBAAgB,gBAAkB,IAAM4H,EAAGhG,cAAc,QAAQwG,aAC/FR,EAAGhG,cAAcxG,EAAKzG,MAAMO,SAASE,MAAMiV,aAAa,QAASzC,EAAG+E,aAAa,WAGrFhU,EAAS6R,iBAAmB,WAGxB,OAFWxW,KAEC2I,MAAM6I,UAAU5D,cAAc,MAF/B5N,KAE4CW,MAAMC,QAAQG,gBAGzE4D,EAASwlB,mBAAqB,WAC1B,MAAM/iB,EAAOpH,KAEPoqB,EAAWhjB,EAAKoP,mBACtB,GAAI4T,EAAU,CAEV,GAAIhjB,EAAKgd,SAAU,CACfxlB,OAAOwgB,oBAAoB,SAAUhY,EAAKgd,UAAU,GACpDhd,EAAKgd,cAAWjM,EAGpBiS,EAASld,UAAUS,OAAOvG,EAAKzG,MAAMC,QAAQG,eAC7CqpB,EAAS/T,aAAa,QAAS+T,EAAShW,aACxCgW,EAASxc,cAAcxG,EAAKzG,MAAMO,SAASE,MAAMiV,aAAa,QAAS+T,EAASzR,aAAa,YAIrGhU,EAAS4C,eAAiB,WACXvH,KACN2H,KAAKygB,qBADCpoB,KAESwW,oBAFTxW,KAIFmqB,qBAET,GANWnqB,KAMFkkB,kBAAmB,CANjBlkB,KAQFkkB,kBAAkBjX,IAAImS,oBAAoB,YARxCpf,KAQ0DkkB,kBAAkBkE,oBAR5EpoB,KASFkkB,kBAAkBjX,IAAImS,oBAAoB,WATxCpf,KASyDkkB,kBAAkBL,kBAT3E7jB,KAWFkkB,kBAAkBhI,QAXhBlc,KAcNwK,MAdMxK,KAcKW,MAAM4C,OAAOC,QAGjCmB,EAASmf,iBAAmB,SAAUlQ,GAClC,MAAMxM,EAAOpH,KAEb,OAAO,IAAI2M,QAAQ,SAAUuB,EAASC,GAClC/G,EAAKO,KAAK6C,QAEVpD,EAAKsd,gBAAgB9Q,GAAIxL,KAAK,SAAUO,GACzBA,EAAM8F,KACb9F,EAAM8F,MACNrH,EAAKO,KAAKmc,iBAAiBnb,GAAOP,KAAK,WACnC,IAAIiiB,EAAejjB,EAAKE,WAAWqD,SACnC,GAAI0f,GAAgBA,EAAajsB,OAAS,EAAG,CAEzC,IAAIksB,EAAcD,EAAa9c,OAAO,SAAUnE,GAC5CA,EAAQmhB,YAAa,EACrB,SAAItqB,GAAGmJ,QAAQyG,eAAiBzG,aAAmBnJ,GAAGmJ,QAAQyG,gBAEnDzG,aAAmBnJ,GAAGmJ,QAAQ2B,WAI1CvD,IAAI,SAAU4B,GACb,OAAInJ,GAAGmJ,QAAQyG,eAAiBzG,aAAmBnJ,GAAGmJ,QAAQyG,cACnDzG,EAAQ4G,SAAS,GACjB5G,aAAmBnJ,GAAGmJ,QAAQ2B,SAC9B3B,EAAQ4G,cADZ,IAGR,GAEH,GAAIsa,EAAa,CACb,IAAIE,EAAQF,EAAY,GACpBG,EAAOH,EAAYA,EAAYlsB,OAAS,GAExCosB,GAAWA,IAAUC,GACrBrjB,EAAKE,WAAWojB,UAAUF,EAAM5G,QAAQ+G,OAAO,EAAG,GAAI,CAClDJ,YAAY,EAAOK,SAAUxjB,EAAK3G,MAAQ,yBAA0BoqB,OAAQ,CAAC,GAAK,GAAIC,WAAW,IAIrGL,GACArjB,EAAKE,WAAWojB,UAAUD,EAAK7G,QAAQ+G,OAAO,EAAG,GAAI,CACjDJ,YAAY,EAAOK,SAAUxjB,EAAK3G,MAAQ,qBAAsBoqB,OAAQ,CAAC,GAAK,GAAIC,WAAW,KAK7G1jB,EAAKE,WAAWsR,eAAc,GAC9B1K,WAMpBvJ,EAAS+f,gBAAkB,SAAU9Q,GACjC,MAAMxM,EAAOpH,KACb,OAAO,IAAI2M,QAAQ,SAAUuB,EAASC,GAClC/G,EAAKqZ,qBAAqBrY,KAAK,SAAUmX,GACrC,GAAIA,EAAQ,CACR,MAAMuK,EAASlW,EAAGsC,QAAQzW,GAC1B,GAAI8f,EAAOuK,GAAS,CAChB,IAAInhB,EAAQ4W,EAAOuK,GAAQrb,KAI3B9F,EAAQvB,EAAKO,KAAKojB,qBAAqBpiB,GAEvCuF,EAAQ,CAAEO,KAAM9F,EAAOoE,OAAQwS,EAAOuK,GAAQ/c,eAGlDmB,SAMhBvJ,EAASmS,OAAS,SAAUlD,GAExB,OADW5T,KACC2H,KAAKmP,OAAOlD,IAG5BjP,EAASojB,oBAAsB,SAAUtN,GACxBza,KACR2H,KAAKqjB,oBAAoBvQ,GAE9B,OAHaza,KAGDkkB,kBAAkB+G,yBAAyBxQ,IAG3D9V,EAASkjB,uBAAyB,WACnB7nB,KACN2H,KAAKujB,uBAGdvmB,EAASkO,eAAiB,SAAUsY,GAChC,MAAM/Y,EAAOnO,SAASoO,cAAc,QAC9BC,EAAS6Y,EAAU3a,cACzB8B,EAAOC,aAAaH,EAAM+Y,GAC1B/Y,EAAKjO,YAAYgnB,GACjB/Y,EAAKI,QAELJ,EAAKK,sBAAsB,WAAY0Y,GACvC7Y,EAAOI,YAAYN,IAGvBzN,EAASyH,oBAAsB,WAG3B,IAFWpM,KAEDorB,QAAS,CAFRprB,KAGForB,QAHEprB,KAGawH,IAAIqU,mBAAmB5b,GAAGC,QAAQmrB,kBAH/CrrB,KAIEorB,SAJFprB,KAIkBorB,QAAQhtB,OAAS,IAJnC4B,KAKEorB,QALFprB,KAKiBorB,QAAQ,IAGpC,OARWprB,KAQCorB,SAGhBzmB,EAAS2mB,iBAAmB,SAAU/M,GAClC,IAmBIgN,EAjBJ,GAAI/N,UAAUgO,YAAa,CAFhBxrB,KAGEyrB,iBACLjO,UAAUgO,YAAYE,WAJnB1rB,KAImCyrB,iBAC1C,GALOzrB,KAKE2rB,mBAAoB,CALtB3rB,KAME2rB,mBANF3rB,KAM4B2rB,8BAA8Bzc,MAN1DlP,KAMuE2rB,mBAAqB,CAN5F3rB,KAMkG2rB,oBANlG3rB,KAQE2rB,mBAAmB/gB,QAAQ,SAAUghB,GACtCpO,UAAUgO,YAAYE,WAAWE,KATlC5rB,KAYE2rB,mBAAqB,IAZvB3rB,KAgBF6rB,wBAhBE7rB,KAiBFoM,sBAAsBqJ,WAjBpBzV,KAiBoC6rB,wBAG/C,OAAQtN,EAAMC,MACV,KAAKD,EAAMuN,kBACPP,EAtBGvrB,KAsBagM,gBAAgB,+BAChC,MACJ,KAAKuS,EAAMwN,qBACPR,EAzBGvrB,KAyBagM,gBAAgB,kCAChC,MACJ,KAAKuS,EAAMyN,QACPT,EA5BGvrB,KA4BagM,gBAAgB,qBAChC,MACJ,QACIuf,EA/BGvrB,KA+BagM,gBAAgB,qBA/B7BhM,KAmCNwH,IAAIuE,MAAMwf,EAAU,CAAEzjB,KAAM7H,GAAGmF,OAAO6G,QAAQC,UAEnD,IArCWlM,KAqCDkf,qBArCClf,KAqC2B2I,MAAO,CArClC3I,KAsCF2I,MAAMmI,eAAe5D,UAAUS,OAAO1N,GAAGmF,OAAOgI,QAAQwD,QAtCtD5Q,KAuCF2I,MAAMoI,iBAAiB7D,UAAUQ,IAAIzN,GAAGmF,OAAOgI,QAAQwD,UAIpE,IAAI8P,EAAW,SAAUuL,GACrB,OAAQA,GAAsB,IAAfA,EAAI7tB,QAGvBuG,EAASunB,YAAc,WACnB,MAAM9kB,EAAOpH,KACb,GAAIoH,EAAK5C,aAAc,CACnB,MAAM2nB,EAAQ,GACd,GAAI/kB,EAAKE,WAAY,CACjB,IAAIqD,EAAWvD,EAAKE,WAAWqD,SAE/B,GAAIA,EAASvM,OAAS,GAAKgJ,EAAKjC,iBAAmBiC,EAAKjC,gBAAgB/G,OAAS,EAC7E+tB,EAAMxhB,SAAWvD,EAAKjC,oBACnB,CACH,MAAMinB,EAAahlB,EAAKE,WAAW4kB,YAAY,CAC3CvhB,SAAUA,IAGdwhB,EAAMxhB,SAAWyhB,EAAWzhB,SAGhCwhB,EAAM1sB,GAAK2H,EAAK3H,GAChB,MAAMuqB,EAAgB5iB,EAAKoP,mBACvBwT,IACAmC,EAAMxa,UAAYqY,EAAcpc,cAAc,QAAQnC,WAE1D,OAAO0gB,GAGf,OAAO,MAGXxnB,EAAS0nB,YAAc,SAAUF,GAC7B,MAAM/kB,EAAOpH,KACb,GAAIoH,EAAKI,KACD2kB,EAAMxhB,UAAYwhB,EAAMxhB,SAASvM,OAAQ,CACzCgJ,EAAKklB,SAEL,GAAIH,EAAMxhB,SAASvM,OAAS,EAAG,CAC3B,MAAM6Q,EAAW,IAAIC,MAAMid,EAAMxhB,SAASvM,QAC1C+tB,EAAMxhB,SAASC,QAAQ,SAAU3E,EAAGkJ,GAChC,MAAMod,EAAiB,CAAE9d,KAAMxI,EAAEwI,KAAMhP,GAAIwG,EAAExG,GAAI8qB,WAAYtkB,EAAEskB,YAC/D,IACI9a,EAAOxP,GAAG2D,KAAKylB,gBAAgBpjB,EAAEwJ,MACrC,OAAQxJ,EAAE6B,MACN,KAAK7H,GAAGmF,OAAOqK,KAAKG,SAChBX,EAASE,GAAO,IAAIlP,GAAGmJ,QAAQ2B,SAAS0E,EAAM8c,GAC9C,MACJ,KAAKtsB,GAAGmF,OAAOqK,KAAKK,cAChBb,EAASE,GAAO,IAAIlP,GAAGmJ,QAAQyG,cAAcJ,EAAM8c,GACnD,MACJ,KAAKtsB,GAAGmF,OAAOqK,KAAKC,OAChBT,EAASE,GAAO,IAAIlP,GAAGmJ,QAAQoG,OAAOC,EAAM8c,GAC5C,MACJ,KAAKtsB,GAAGmF,OAAOqK,KAAKE,MAChBV,EAASE,GAAO,IAAIlP,GAAGmJ,QAAQyB,MAAM4E,EAAM8c,MAKvD5f,QAAQC,IAAIqC,GAAU7G,KAAK,SAAUkH,GACjC,IAAI/O,EAAU,CAAEoK,SAAU2E,EAAYrF,SAAUkiB,EAAMxa,UAAW7E,cAAc,EAAMgB,UAAU,GAC1F1G,EAAKiH,gBAKNjH,EAAKqD,YAAYlK,GAJjB6G,EAAKkY,kBAAkBlX,KAAK,WACxBhB,EAAKqD,YAAYlK,UAW7CoE,EAASoS,kBAAoB,WACzB,MAAM3P,EAAOpH,KACb,OAAIoH,EAAKolB,gBACE7f,QAAQuB,QAAQ9G,EAAKolB,iBAEzB,IAAI7f,QAAQ,SAAUuB,EAASC,GAClC/G,EAAKI,IAAImU,WAAW,yBAAyBvT,KAAKoF,IAC9CpG,EAAKolB,gBAAkBhf,EACvBU,EAAQV,QAx0ExB","sourcesContent":["(function () {\r\n    Math.hypot = Math.hypot || function () {\r\n        var y = 0;\r\n        var length = arguments.length;\r\n\r\n        for (var i = 0; i < length; i++) {\r\n            if (arguments[i] === Infinity || arguments[i] === -Infinity) {\r\n                return Infinity;\r\n            }\r\n            y += arguments[i] * arguments[i];\r\n        }\r\n        return Math.sqrt(y);\r\n    };\r\n}());\r\n(function () {\r\n    var lastTime = 0,\r\n        vendors = ['ms', 'moz', 'webkit', 'o'],\r\n        // Feature check for performance (high-resolution timers)\r\n        hasPerformance = !!(window.performance && window.performance.now);\r\n\r\n    for (var x = 0, max = vendors.length; x < max && !window.requestAnimationFrame; x += 1) {\r\n        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];\r\n        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']\r\n            || window[vendors[x] + 'CancelRequestAnimationFrame'];\r\n    }\r\n\r\n    if (!window.requestAnimationFrame) {\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            var currTime = new Date().getTime();\r\n            var timeToCall = Math.max(0, 16 - (currTime - lastTime));\r\n            var id = window.setTimeout(function () { callback(currTime + timeToCall); },\r\n                timeToCall);\r\n            lastTime = currTime + timeToCall;\r\n            return id;\r\n        };\r\n    }\r\n\r\n    if (!window.cancelAnimationFrame) {\r\n        window.cancelAnimationFrame = function (id) {\r\n            clearTimeout(id);\r\n        };\r\n    }\r\n\r\n    // Add new wrapper for browsers that don't have performance\r\n    if (!hasPerformance) {\r\n        // Store reference to existing rAF and initial startTime\r\n        var rAF = window.requestAnimationFrame,\r\n            startTime = +new Date;\r\n\r\n        // Override window rAF to include wrapped callback\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            // Wrap the given callback to pass in performance timestamp\r\n            var wrapped = function (timestamp) {\r\n                // Get performance-style timestamp\r\n                var performanceTimestamp = (timestamp < 1e12) ? timestamp : timestamp - startTime;\r\n\r\n                return callback(performanceTimestamp);\r\n            };\r\n\r\n            // Call original rAF with wrapped callback\r\n            rAF(wrapped, element);\r\n        }\r\n    }\r\n})();\r\n(function () {\r\n    // Polyfill window.performance.now\r\n    if (!window.performance) {\r\n        window.performance = {\r\n            offset: Date.now(),\r\n            now: function () {\r\n                return Date.now() - this.offset;\r\n            }\r\n        };\r\n    } else if (window.performance && !window.performance.now) {\r\n        window.performance.offset = Date.now();\r\n        window.performance.now = function () {\r\n            return Date.now() - window.performance.offset;\r\n        };\r\n    }\r\n}());\r\n\r\nTC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.control.Geolocation = function (options) {\r\n    var self = this;\r\n    self._classSelector = '.' + self.CLASS;\r\n\r\n    self._layerPromises = {};\r\n\r\n    self.Const = {\r\n        Classes: {\r\n            ACTIVE: 'tc-ctl-geolocation-active',\r\n            CLOSED: 'closed',\r\n            SELECTEDTRACK: 'selectedTrack',\r\n            DRAWACTIVATED: 'draw-activated',\r\n            SIMULATIONACTIVATED: 'simulation-activated'\r\n        },\r\n        Selector: {\r\n            SIMULATE: '.tc-btn-simulate',\r\n            DRAW: '.tc-draw',\r\n            EDIT: '.tc-btn-edit',\r\n            DELETE: '.tc-btn-delete',\r\n            SAVE: '.tc-btn-save',\r\n            CANCEL: '.tc-btn-cancel',\r\n            EXPORT: '.tc-btn-export',\r\n            STOP: '.tc-btn-stop',\r\n            PAUSE: '.tc-btn-pause',\r\n            BACKWARD: '.tc-btn-backward',\r\n            FORWARD: '.tc-btn-forward',\r\n            SPEED: '.tc-spn-speed'\r\n        },\r\n        LocalStorageKey: {\r\n            TRACKING: 'trk',\r\n            TRACKINGTEMP: 'trktemp',\r\n            TRACKINGSHOWADVERTISEMENT: 'trkAdvertisement',\r\n            GPSSHOWADVERTISEMENT: 'gpsAdvertisement',\r\n            TEST: 'test'\r\n        },\r\n        Message: {\r\n            VALIDATENAME: '',\r\n        },\r\n        Event: {\r\n            POSITIONCHANGE: 'positionchange.tc.geolocation',\r\n            GPSPOSITIONCHANGE: 'gpspositionchange.tc.geolocation',\r\n            GPSPOSITIONERROR: 'positionerror.tc.geolocation',\r\n            STATEUPDATED: 'stateupdated.tc.geolocation',\r\n            GPSADD: 'gpsadd.tc.geolocation',\r\n            TRACKSNAPPING: 'tracksnapping.tc.geolocation',\r\n            DRAWTRACK: 'drawtrack.tc.geolocation',\r\n            CLEARTRACK: 'cleartrack.tc.geolocation',\r\n            IMPORTEDTRACK: 'importedtrack.tc.geolocation'\r\n        },\r\n        MimeMap: {\r\n            KML: 'application/vnd.google-earth.kml+xml',\r\n            GPX: 'application/gpx+xml'\r\n        },\r\n        SupportedFileExtensions: [\r\n            '.kml',\r\n            '.gpx'\r\n        ],\r\n        Tabs: {\r\n            GPS: \"gps\"\r\n        },\r\n        Layers: {\r\n            GPS: \"gps\",\r\n            TRACK: \"track\",\r\n            TRACKING: \"tracking\"\r\n        }\r\n    };\r\n\r\n    TC.Control.apply(self, arguments);\r\n\r\n    var opts = options || {};\r\n    self._dialogDiv = TC.Util.getDiv(opts.dialogDiv);\r\n    if (window.$) {\r\n        self._$dialogDiv = $(self._dialogDiv);\r\n    }\r\n    if (!opts.dialogDiv) {\r\n        document.body.appendChild(self._dialogDiv);\r\n    }\r\n    self.delta = 500;\r\n    self.walkingSpeed = 5000;\r\n    self.gapHill = self.options.gapHill || 20;\r\n\r\n    self.snappingTolerance = self.options.snappingTolerance || 50;\r\n\r\n    self.exportsState = true;\r\n\r\n    self.storageCRS = 'EPSG:4326';\r\n};\r\n\r\nTC.inherit(TC.control.Geolocation, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Geolocation.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-geolocation';\r\n\r\n    ctlProto.CHART_SIZE = {\r\n        MIN_HEIGHT: 75,\r\n        MAX_HEIGHT: 128,\r\n\r\n        MIN_WIDTH: 300,\r\n        MEDIUM_WIDTH: 310,\r\n        MAX_WIDTH: 445\r\n    };\r\n\r\n    ctlProto.featuresToShare = [];\r\n\r\n    TC.Consts.event.TOOLSCLOSE = TC.Consts.event.TOOLSCLOSE || 'toolsclose.tc';\r\n    TC.Consts.event.TOOLSOPEN = TC.Consts.event.TOOLSOPEN || 'toolsopen.tc';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/Geolocation.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-track-node'] = TC.apiLocation + \"TC/templates/GeolocationTrackNode.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-track-snapping-node'] = TC.apiLocation + \"TC/templates/GeolocationTrackSnappingNode.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/GeolocationDialog.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-tracking-toast'] = TC.apiLocation + \"TC/templates/GeolocationTrackingToast.html\";\r\n\r\n    var onFeatureRemove = function (e) {\r\n        const self = this;\r\n        const layer = e.layer;\r\n\r\n        if (e.layer === self.layerTrack) {\r\n            self.clearSelection();\r\n        }\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self.wrap = new TC.wrap.control.Geolocation(self);\r\n        self.wrap.register(map);\r\n\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            owner: self,\r\n            stealth: true,\r\n            title: 'Posicionar.GPS',\r\n        }).then(function (layer) {\r\n            self.layerGPS = layer;\r\n        });\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            owner: self,\r\n            stealth: true,\r\n            title: 'Posicionar.Tracking',\r\n            styles: {\r\n                point: {\r\n                    radius: 3,\r\n                    fillColor: \"#00ced1\",\r\n                    fillOpacity: function () {\r\n                        return this.track.renderTrack.checked ? 1 : 0;\r\n                    }.bind(self),\r\n                    strokeColor: \"#ffffff\",\r\n                    fontColor: \"#00ced1\",\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 1,\r\n                    label: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            name = (name + '').trim().toLowerCase();\r\n                        } else {\r\n                            name = '';\r\n                        }\r\n\r\n                        return name;\r\n                    }\r\n                },\r\n                line: {\r\n                    strokeOpacity: function () {\r\n                        return this.track.renderTrack.checked ? 1 : 0;\r\n                    }.bind(self),\r\n                    strokeWidth: 2,\r\n                    strokeColor: \"#00ced1\",\r\n                    lineDash: [.1, 6]\r\n                }\r\n            }\r\n        }).then(function (layer) {\r\n            self.layerTracking = layer;\r\n        });\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            owner: self,\r\n            stealth: true,\r\n            title: 'Posicionar.Track',\r\n            styles: {\r\n                line: {\r\n                    strokeWidth: 2,\r\n                    strokeColor: \"#C52737\"\r\n                },\r\n                point: {\r\n                    radius: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            return 3;\r\n                        } else {\r\n                            return 6;\r\n                        }\r\n\r\n                        return 3;\r\n                    },\r\n                    fillColor: \"#C52737\",\r\n                    strokeColor: \"#ffffff\",\r\n                    fontColor: \"#C52737\",\r\n                    fontSize: 10,\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 2,\r\n                    label: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            name = (name + '').trim().toLowerCase();\r\n                        } else {\r\n                            name = '';\r\n                        }\r\n\r\n                        return name;\r\n                    }\r\n                }\r\n            }\r\n        }).then(function (layer) {\r\n            self.layerTrack = layer;\r\n        });\r\n\r\n        map.on(TC.Consts.event.FEATURESIMPORT, function (e) {\r\n            const self = this;\r\n            const fileName = e.fileName;\r\n            const target = e.dropTarget;\r\n            var kmlPattern = '.' + TC.Consts.format.KML.toLowerCase();\r\n            var gpxPattern = '.' + TC.Consts.format.GPX.toLowerCase();\r\n\r\n            // GLS: ¿es un GPX?\r\n            if (fileName.toLowerCase().indexOf(gpxPattern) === fileName.length - gpxPattern.length ||\r\n                // GLS: ¿es un KML y viene desde el upload de Geolocation?\r\n                (fileName.toLowerCase().indexOf(kmlPattern) === fileName.length - kmlPattern.length && target === self)) {\r\n\r\n                self.clear(self.Const.Layers.TRACK);\r\n                self.importTrack(e);\r\n\r\n                if (/.kml$/g.test(fileName.toLowerCase()) && self.layerTrack) {\r\n                    if (self.layerTrack.styles) {\r\n                        self.layerTrack.features.forEach(function (feature) {\r\n                            if (feature instanceof TC.feature.Point && self.layerTrack.styles.point) {\r\n                                feature.setStyle(self.layerTrack.styles.point);\r\n                            } else if (feature instanceof TC.feature.Polyline && self.layerTrack.styles.line) {\r\n                                feature.setStyle(self.layerTrack.styles.line);\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            } else {\r\n                //GLS: si es un KML pero viene desde el mapa o es otro tipo de archivo que no es ni GPX ni KML, lo ignoramos\r\n                return;\r\n            }\r\n        }.bind(self));\r\n\r\n        map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n            if (self.elevationChartData) {\r\n                self.elevationChartData.coords = TC.Util.reproject(self.elevationChartData.coords, e.oldCrs, e.newCrs);\r\n            }\r\n        });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        return self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n        }).then(function () {\r\n            return self.renderData({ controlId: self.id }, callback);\r\n        });\r\n    };\r\n\r\n    ctlProto.importTrack = function (options) {\r\n        var self = this;\r\n\r\n        self.map.off(TC.Consts.event.FEATUREREMOVE, onFeatureRemove);\r\n\r\n        if (!self.isDisabled) {\r\n            if (options.fileName && options.features && options.features.length > 0) {\r\n\r\n                var wait = self.getLoadingIndicator().addWait();\r\n                self.importedFileName = options.fileName;\r\n                const addPromises = [];\r\n                for (var i = 0, len = options.features.length; i < len; i++) {\r\n                    addPromises.push(self.layerTrack.addFeature(options.features[i]));\r\n                }\r\n                Promise.all(addPromises).then(function () {\r\n\r\n                    self.wrap.processImportedFeatures({ wait: wait, notReproject: options.notReproject });\r\n\r\n                    if (self.layerTrack) { // Si tenemos capa es que todo ha ido bien y gestionamos el despliegue del control\r\n                        // Desplegamos el control \"ubicar\" al importar mediante drag&drop\r\n                        if (self.map && self.map.layout && self.map.layout.accordion) {\r\n                            if (self.div.classList.contains(TC.Consts.classes.COLLAPSED)) {\r\n                                self.map.controls\r\n                                    .filter(function (ctl) {\r\n                                        // Todos los otros controles que no cuelgan de otro control\r\n                                        return ctl !== self && !ctl.containerControl;\r\n                                    })\r\n                                    .forEach(function (ctl) {\r\n                                        ctl.div.classList.add(TC.Consts.classes.COLLAPSED);\r\n                                    });\r\n                            }\r\n                        }\r\n\r\n                        self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                        self.div.querySelector('.' + self.CLASS + '-btn-tracks > span').click();\r\n\r\n                        if (!options.isShared) {\r\n                            // abrimos el panel de herramientas\r\n                            self.map.trigger(TC.Consts.event.TOOLSOPEN);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        } else if (/.gpx$/g.test(options.fileName.toLowerCase())) {\r\n            self.map.toast(self.getLocaleString(\"geo.trk.import.disabled\"), { type: TC.Consts.msgType.WARNING });\r\n        }\r\n    };\r\n\r\n    ctlProto.prepareFeaturesToShare = function (trackUid) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            if (trackUid) {\r\n\r\n                var storageData = self.availableTracks.filter(function (saved) {\r\n                    return saved.uid.toString() === trackUid.toString();\r\n                })[0].data;\r\n\r\n                // Aplicamos una precisión un dígito mayor que la del mapa, si no, al compartir algunas parcelas se deforman demasiado\r\n                var precision = Math.pow(10, TC.Consts.DEGREE_PRECISION + 1);\r\n\r\n                var storageFeatures = new ol.format.GeoJSON().readFeatures(storageData);\r\n                const promises = new Array(storageFeatures.length);\r\n                storageFeatures.forEach(function (f, idx) {\r\n                    promises[idx] = TC.wrap.Feature.createFeature(f);\r\n                });\r\n\r\n                Promise.all(promises).then(function (tcFeatures) {\r\n                    self.featuresToShare = tcFeatures.map(function (f) {\r\n                        const fObj = {};\r\n                        var layerStyle;\r\n                        switch (true) {\r\n                            case TC.feature.Marker && f instanceof TC.feature.Marker:\r\n                                fObj.type = TC.Consts.geom.MARKER;\r\n                                break;\r\n                            case TC.feature.Point && f instanceof TC.feature.Point:\r\n                                fObj.type = TC.Consts.geom.POINT;\r\n                                break;\r\n                            case TC.feature.Polyline && f instanceof TC.feature.Polyline:\r\n                                fObj.type = TC.Consts.geom.POLYLINE;\r\n                                break;\r\n                            case TC.feature.MultiPolyline && f instanceof TC.feature.MultiPolyline:\r\n                                fObj.type = TC.Consts.geom.MULTIPOLYLINE;\r\n                                break;\r\n                        }\r\n                        fObj.id = f.id;\r\n                        fObj.geom = TC.Util.compactGeometry(f.geometry, precision);\r\n                        fObj.data = f.getData();\r\n\r\n                        return fObj;\r\n                    });\r\n\r\n                    resolve();\r\n                });\r\n            } else {\r\n                resolve();\r\n            }\r\n        });\r\n\r\n\r\n    };\r\n\r\n    var visibilityTrack = true;\r\n    ctlProto.renderData = function (data, callback) {\r\n        const self = this;\r\n\r\n        var sel = self.Const.Selector;\r\n\r\n        return TC.Control.prototype.renderData.call(self, data, function () {\r\n\r\n            const options = self.div.querySelectorAll(self._classSelector + '-panel');\r\n            self.div.querySelectorAll('.' + self.CLASS + '-select span').forEach(function (span) {\r\n                span.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    var label = e.target;\r\n                    while (label && label.tagName !== 'LABEL') {\r\n                        label = label.parentElement;\r\n                    }\r\n                    const newFormat = label.querySelector('input[type=radio][name=mode]').value;\r\n\r\n                    options.forEach(function (option) {\r\n                        option.classList.toggle(TC.Consts.classes.HIDDEN, !option.matches('.' + self.CLASS + '-' + newFormat));\r\n                    });\r\n                });\r\n            });\r\n\r\n            self.track = {\r\n                activateButton: self.div.querySelector(self._classSelector + '-track-ui-activate'),\r\n                deactivateButton: self.div.querySelector(self._classSelector + '-track-ui-deactivate'),\r\n                trackSearch: self.div.querySelector(self._classSelector + '-track-available-srch'),\r\n                trackImportFile: self.div.querySelector(self._classSelector + '-track-import'),\r\n                trackSave: self.div.querySelector(self._classSelector + '-track-save'),\r\n                trackAdd: self.div.querySelector(self._classSelector + '-track-add-wpt'),\r\n                trackContinue: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-continue'),\r\n                trackRenew: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-new'),\r\n                trackClose: self._dialogDiv.querySelector('.tc-ctl-geolocation-continue-track-dialog button.tc-modal-close'),\r\n                //trackAddSegment: self.div.querySelector('#tc-ctl-geolocation-track-segment'),\r\n                trackAdvertisementOK: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-ok')\r\n            };\r\n\r\n            self.track.trackList = self.div.querySelector(self._classSelector + '-track-available-lst');\r\n\r\n            self.track.trackToolPanelOpened = self.div.querySelector('#tc-ctl-geolocation-track-panel-opened-' + self.id);\r\n\r\n            self.div.querySelector('.' + ctlProto.CLASS + '-track-panel-help').addEventListener('click', function () {\r\n                _showAlerMsg.call(self);\r\n            });\r\n\r\n            self.track.trackName = self.div.querySelector(self._classSelector + '-track-title');\r\n\r\n            self.track.trackWPT = self.div.querySelector(self._classSelector + '-track-waypoint');\r\n\r\n            if (TC.Util.detectMobile()) {\r\n                if (matchMedia('screen and (max-height: 50em) and (max-width: 50em)').matches)\r\n                    self.track.trackToolPanelOpened.checked = false;\r\n            }\r\n\r\n            if (window.File && window.FileReader && window.FileList && window.Blob) {\r\n                self.track.trackImportFile.disabled = false;\r\n                // GLS: Eliminamos el archivo subido, sin ello no podemos subir el mismo archivo seguido varias veces\r\n                self.track.trackImportFile.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    // Envolvemos el input en un form\r\n                    const input = this;\r\n                    const form = document.createElement('form');\r\n                    const parent = input.parentElement;\r\n                    parent.insertBefore(form, input);\r\n                    form.appendChild(input);\r\n                    form.reset();\r\n                    // Desenvolvemos el input del form\r\n                    form.insertAdjacentElement('afterend', input);\r\n                    parent.removeChild(form);\r\n                });\r\n\r\n                const _layerError = function () {\r\n                    self.map.off(TC.Consts.event.LAYERERROR, _layerError);\r\n                    self.clearFileInput(self.track.trackImportFile);\r\n\r\n                    TC.alert(self.getLocaleString(\"geo.trk.upload.error3\"));\r\n                };\r\n\r\n                self.track.trackImportFile.addEventListener('change', function (e) {\r\n                    if (!self._cleaning) { // Valido que el evento import no lo provoco yo al limpiar el fileinput (al limpiar se lanza el change)                        \r\n                        self.clear(self.Const.Layers.TRACK);\r\n\r\n                        if (self.map) {\r\n                            self.map.on(TC.Consts.event.LAYERERROR, _layerError);\r\n                            self.map.wrap.loadFiles(e.target.files, { control: self });\r\n                        }\r\n                    }\r\n                });\r\n            } else {\r\n                console.log('no es posible la importación');\r\n            }\r\n\r\n            self.track.activateButton.addEventListener('click', function () {\r\n                self.activateTracking();\r\n                _activateTrackingBtns.call(self);\r\n\r\n            });\r\n            self.track.deactivateButton.addEventListener('click', function () {\r\n                self.deactivateTracking();\r\n                _deactivateTrackingBtns.call(self);\r\n            });\r\n\r\n            var _filter = function (searchTerm) {\r\n                searchTerm = searchTerm.toLowerCase();\r\n                //tc-ctl-geolocation-track-available-empty\r\n                const lis = Array.from(self.track.trackList.querySelectorAll('li'));\r\n                lis.forEach(function (li) {\r\n                    li.style.display = 'none';\r\n                });\r\n                const trackLis = lis.filter(function (li) {\r\n                    return li.matches('li:not([class]),li.' + self.Const.Classes.SELECTEDTRACK);\r\n                });\r\n\r\n                const searchIcon = self.div.querySelector(self._classSelector + '-track-search-icon');\r\n                if (searchTerm.length === 0) {\r\n                    trackLis.forEach(function (li) {\r\n                        li.style.display = '';\r\n                    });\r\n                    searchIcon.style.visibility = 'visible';\r\n                } else {\r\n                    searchIcon.style.visibility = 'hidden';\r\n                    var r = new RegExp(searchTerm, 'i');\r\n                    trackLis.forEach(function (li) {\r\n                        li.style.display = r.test(li.querySelector('span').textContent) ? '' : 'none';\r\n                    });\r\n\r\n                    if (!trackLis.some(function (li) {\r\n                        return li.style.display === '';\r\n                    })) {\r\n                        lis.forEach(function (li) {\r\n                            if (li.matches('[class^=\"tc-ctl-geolocation-track-not\"]')) {\r\n                                li.style.display = '';\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            };\r\n            const trackSearchListener = function () {\r\n                _filter(this.value.toLowerCase().trim());\r\n            };\r\n            self.track.trackSearch.addEventListener(\"keyup\", trackSearchListener);\r\n            self.track.trackSearch.addEventListener(\"search\", trackSearchListener);\r\n\r\n            // en el panel\r\n            self.track.trackSave.addEventListener('click', self.saveTrack.bind(self));\r\n            self.track.trackAdd.addEventListener('click', self.addWaypoint.bind(self));\r\n\r\n            const list = self.div.querySelector(self._classSelector + '-track-available-lst');\r\n\r\n            // en lista\r\n            var _edit = function (edit, elm) {\r\n                if (elm.tagName !== 'LI') {\r\n                    elm = elm.parentElement;\r\n                }\r\n\r\n                const input = elm.querySelector('input');\r\n                const span = elm.querySelector('span');\r\n\r\n                if (edit) {\r\n\r\n                    input.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    input.focus();\r\n                    input.value = span.textContent;\r\n                    span.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SIMULATE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EDIT).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DELETE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DRAW).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT).classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SAVE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.CANCEL).classList.remove(TC.Consts.classes.HIDDEN);\r\n                } else {\r\n\r\n                    input.classList.add(TC.Consts.classes.HIDDEN);\r\n                    span.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SIMULATE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EDIT).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DELETE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DRAW).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT).classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SAVE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.CANCEL).classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            };\r\n\r\n            self.uiSimulate = function (simulate, elm) {\r\n                if (elm) {\r\n                    var editControls = [\r\n                        sel.SIMULATE,\r\n                        sel.EDIT,\r\n                        sel.DELETE,\r\n                        sel.EXPORT\r\n                    ];\r\n                    var simulateControls = [\r\n                        sel.STOP,\r\n                        sel.PAUSE,\r\n                        sel.BACKWARD,\r\n                        sel.FORWARD,\r\n                        sel.SPEED\r\n                    ];\r\n                    var cnt = elm.tagName === 'LI' ? elm : elm.parentNode;\r\n\r\n                    editControls.forEach(function (ctl) {\r\n                        cnt.querySelector(ctl).hidden = simulate;\r\n                    });\r\n\r\n                    simulateControls.forEach(function (ctl) {\r\n                        cnt.querySelector(ctl).hidden = !simulate;\r\n                    });\r\n                }\r\n            };\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(sel.SIMULATE, function (e) {\r\n                var wait = self.getLoadingIndicator().addWait();\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = 'x 1';\r\n\r\n                _loadTrack(self, e.target).then(function () { //Para evitar el bloqueo de la interfaz en móviles\r\n                    self.getLoadingIndicator().removeWait(wait)\r\n                });\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(sel.DRAW, function (e) {\r\n                var wait = self.getLoadingIndicator().addWait();\r\n\r\n                _drawTrack(self, e.target).then(function () {\r\n                    self.getLoadingIndicator().removeWait(wait);\r\n                });\r\n            }));\r\n\r\n            self.on(self.Const.Event.IMPORTEDTRACK, function (e) {\r\n                if (!self.isDisabled) {\r\n                    const listElement = self.track.trackList.querySelector('li[data-id=\"' + e.index + '\"]');\r\n                    _drawTrack(self, listElement.querySelector(sel.DRAW));\r\n                    setTimeout(function () {\r\n                        self.track.trackList.scrollTop = e.index * listElement.offsetHeight;\r\n                    }, 100);\r\n                } else {\r\n                    self.map.toast(self.getLocaleString(\"geo.trk.import.disabled\"), { type: TC.Consts.msgType.WARNING });\r\n                }\r\n            });\r\n\r\n            const _stopOtherTracks = function (self, trackLiId) {\r\n                self.track.trackList.querySelectorAll('li[data-id]').forEach(function (listItem) {\r\n                    if (listItem.dataset.id !== trackLiId) {\r\n                        const btnSimulate = listItem.querySelector(sel.SIMULATE);\r\n                        const btnPause = listItem.querySelector(sel.PAUSE);\r\n\r\n                        btnSimulate.classList.remove(self.Const.Classes.SIMULATIONACTIVATED);\r\n                        btnSimulate.setAttribute('title', self.getLocaleString(\"tr.lst.simulate\"));\r\n                        btnPause.classList.remove('play');\r\n                        btnPause.setAttribute('title', self.getLocaleString(\"tr.lst.pause\"));\r\n\r\n                        self.uiSimulate(false, listItem);\r\n                        _edit(false, listItem);\r\n                    }\r\n                });\r\n\r\n                self.clear(self.Const.Layers.TRACK);\r\n            };\r\n\r\n            var _drawTrack = function (self, btnDraw) {\r\n                return new Promise(function (resolve, reject) {\r\n\r\n                    const trackLi = btnDraw.parentElement;\r\n\r\n                    setTimeout(function () {\r\n                        if (trackLi.classList.contains(self.Const.Classes.SELECTEDTRACK)) {\r\n                            self.uiSimulate(false, btnDraw);\r\n\r\n                            self.clear(self.Const.Layers.TRACK);\r\n                            self.map.off(TC.Consts.event.FEATUREREMOVE, onFeatureRemove);\r\n\r\n                            btnDraw.setAttribute('title', btnDraw.textContent);\r\n                        }\r\n                        else if (self.getSelectedTrack()) { // GLS: si hay elemento seleccionado actuamos\r\n                            _stopOtherTracks(self, trackLi.dataset.id);\r\n                            self.drawTrack(trackLi);\r\n                        } else {\r\n                            self.drawTrack(trackLi);\r\n                        }\r\n\r\n                        /* GLS: 15/02/2019 Preparamos la feature por si se comparte, necesito hacerlo aquí \r\n                           porque la gestión en asíncrona y todo el flujo de exportación es síncrono */\r\n                        if (trackLi.classList.contains(self.Const.Classes.SELECTEDTRACK)) {\r\n                            self.prepareFeaturesToShare(trackLi.dataset.uid).then(function () {\r\n                                resolve();\r\n                            });\r\n                        } else {\r\n                            resolve();\r\n                        }\r\n                    }, 0);\r\n                });\r\n            };\r\n\r\n            var _loadTrack = function (self, btnSimulate) {\r\n                return new Promise(function (resolve, reject) {\r\n                    setTimeout(function () {\r\n                        const trackLi = btnSimulate.parentElement;\r\n\r\n                        _stopOtherTracks(self, trackLi.dataset.id);\r\n                        self.uiSimulate(false, self.getSelectedTrack());\r\n                        self.uiSimulate(true, btnSimulate);\r\n\r\n                        self.simulate_paused = false;\r\n                        self.simulateTrack(trackLi);\r\n\r\n                        resolve();\r\n                    }, 0);\r\n                });\r\n            };\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.EDIT, function (e) {\r\n                _edit(true, e.target);\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.DELETE, function (e) {\r\n                self.removeTrack(e.target.parentElement);\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.SAVE, function (e) {\r\n                var newName = e.target.parentElement.querySelector('input').value;\r\n                if (newName.trim().length === 0) {\r\n                    TC.alert(self.getLocaleString('geo.trk.edit.alert'));\r\n                }\r\n                else {\r\n                    self.editTrackName(e.target.parentElement.dataset.id, e.target.parentElement.querySelector('input').value);\r\n                    _edit(false, e.target);\r\n                }\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.CANCEL, function (e) {\r\n                _edit(false, e.target);\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.EXPORT, function (e) {\r\n                const parent = e.target.parentElement;\r\n                e.target.setAttribute('disabled', \"\");\r\n\r\n                self.export(parent).then((features) => {\r\n                    self.getDownloadDialog().then(function (dialog) {\r\n                        var filename = parent.querySelector('span').textContent;\r\n                        var regex = new RegExp(self.Const.SupportedFileExtensions.join('|'), 'gi');\r\n                        var cleanFilename = filename.replace(regex, '');\r\n                        const options = {\r\n                            title: self.getLocaleString('download'),\r\n                            fileName: cleanFilename,\r\n                            elevation: {\r\n                                resolution: 20,\r\n                                sampleNumber: 200\r\n                            }                            \r\n                        };\r\n                        dialog.open(features, options);\r\n\r\n                        e.target.removeAttribute('disabled');\r\n                    });\r\n                });\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.STOP, function (e) {\r\n                self.uiSimulate(false, e.target);\r\n                self.wrap.simulateTrackEnd();\r\n                const btnPause = e.target.parentElement.querySelector(sel.PAUSE);\r\n                btnPause.classList.remove('play');\r\n                btnPause.setAttribute('title', self.getLocaleString('tr.lst.pause'));\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = 'x 1';\r\n                self.simulate_speed = 1;\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.PAUSE, function (e) {\r\n                self.simulate_paused = !e.target.classList.contains('play');\r\n                if (self.simulate_paused)\r\n                    self.simulate_pausedElapse = -1;\r\n\r\n                e.target.setAttribute('title', self.getLocaleString(self.simulate_paused ? 'tr.lst.play' : 'tr.lst.pause'));\r\n                e.target.classList.toggle('play', !!self.simulate_paused);\r\n            }));\r\n\r\n            var lapse = 0.5;\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.BACKWARD, function (e) {\r\n                if (self.simulate_speed == 1)\r\n                    self.simulate_speed = lapse;\r\n                else self.simulate_speed = self.simulate_speed / 2;\r\n\r\n                e.target.parentElement.querySelector(self._classSelector + \" \" + sel.FORWARD).disabled = false;\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = self.simulate_speed < 1 ? '/ ' + (1 / self.simulate_speed) : 'x ' + self.simulate_speed;\r\n\r\n                if (self.simulate_speed == 0.000244140625) {\r\n                    e.target.disabled = true;\r\n                }\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.FORWARD, function (e) {\r\n                self.simulate_speed = self.simulate_speed / lapse;\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = self.simulate_speed < 1 ? '/ ' + (1 / self.simulate_speed) : 'x ' + self.simulate_speed;\r\n\r\n                e.target.parentElement.querySelector(self._classSelector + \" \" + sel.BACKWARD).disabled = false;\r\n\r\n                if (self.simulate_speed == 4096) {\r\n                    e.target.disabled = true;\r\n                }\r\n            }));\r\n\r\n\r\n            // popup\r\n            self.track.trackContinue.addEventListener('click', function () {\r\n                // cerramos popup y continuamos con el track de session y almacenando en session\r\n                TC.Util.closeModal();\r\n                // al obtener la posición se almacena en session y continuamos almacenando en session mientras se mueve\r\n                _tracking.call(self);\r\n            });\r\n            self.track.trackRenew.addEventListener('click', function () {\r\n                // eliminamos el track actual de session - restablecemos el tracking\r\n                delete self.sessionTracking;\r\n                TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, undefined);\r\n                localforage.removeItem(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n                // cerramos el popup\r\n                TC.Util.closeModal();\r\n                // al obtener la posición se almacena en session y continuamos almacenando en session mientras se mueve\r\n                _tracking.call(self);\r\n            });\r\n            self.track.trackClose.addEventListener('click', function () {\r\n                _deactivateTrackingBtns.call(self);\r\n            });\r\n            //self.track.trackAddSegment.addEventListener('click', function () {\r\n            //    TC.alert('pendiente');\r\n            //    // cerramos el popup\r\n            //    TC.Util.closeModal();\r\n            //});\r\n\r\n            // popup advertencia\r\n            self.track.trackAdvertisementOK.addEventListener('click', function () {\r\n\r\n                const checkboxes = document.body.querySelectorAll('input[name*=\"Advertisement\"]:checked');\r\n\r\n                if (checkboxes.length > 0) {\r\n                    const promise = new Promise(function (resolve, reject) {\r\n                        if (window.localforage)\r\n                            resolve();\r\n                        else {\r\n                            TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                                resolve();\r\n                            });\r\n                        }\r\n                    });\r\n\r\n                    promise.then(function () {\r\n                        localforage.setItem(checkboxes[0].getAttribute('name'), false);\r\n                    });\r\n                }\r\n\r\n                TC.Util.closeModal();\r\n            });\r\n\r\n            self.track.renderTrack = document.querySelector('#tc-ctl-geolocation-track-render-' + self.id);\r\n            self.track.renderTrack.addEventListener('change', function () {\r\n                if (self.track.activateButton.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                    self.layerTracking.setVisibility(this.checked);\r\n                }\r\n\r\n                visibilityTrack = this.checked;\r\n            });\r\n\r\n            if (window.localforage)\r\n                self.bindTracks();\r\n            else {\r\n                TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                    self.bindTracks();\r\n                });\r\n            }\r\n\r\n            if (TC.Util.isFunction(callback)) {\r\n                callback();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.activate = function () {\r\n        //var self = this;\r\n        //TC.Control.prototype.activate.call(self);\r\n    };\r\n\r\n    ctlProto.deactivate = function () {\r\n        var self = this;\r\n\r\n        TC.Util.closeModal();\r\n        self.clearSelection();\r\n        self.deactivateTracking();\r\n        //TC.Control.prototype.deactivate.call(self);\r\n    };\r\n\r\n    var _activateTrackingBtns = function () {\r\n        var self = this;\r\n\r\n        self.track.activateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        self.track.deactivateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    var _deactivateTrackingBtns = function () {\r\n        var self = this;\r\n\r\n        self.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n        self.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    var _showAlerMsg = function () {\r\n        var self = this;\r\n        self.map.toast(self.div.querySelector(\".alert-warning\").innerHTML, {\r\n            duration: 10000\r\n        });\r\n    };\r\n\r\n    ctlProto.markerStyle = {\r\n        radius: 7,\r\n        fillColor: [255, 0, 0, 100],\r\n        strokeColor: [255, 255, 255, 255],\r\n        strokeWidth: 2\r\n    };\r\n\r\n    ctlProto.lineStyle = {\r\n        strokeWidth: 2,\r\n        strokeColor: [0, 206, 209, 255]\r\n    };\r\n\r\n    ctlProto.setFormatInfoNewPosition = function (newPosition) {\r\n        var self = this;\r\n\r\n        var data = {};\r\n        var locale = TC.Util.getMapLocale(self.map);\r\n\r\n        if (self.map.on3DView) {\r\n            var geoCoords = self.map.crs !== self.map.view3D.crs ? TC.Util.reproject(newPosition.position, self.map.crs, self.map.view3D.crs) : newPosition.position;\r\n            data.x = geoCoords[0].toLocaleString(locale);\r\n            data.y = geoCoords[1].toLocaleString(locale);\r\n\r\n            data.mdt = Math.round(self.map.view3D.getHeightFromMDT(geoCoords)).toLocaleString(locale);\r\n\r\n            data.isGeo = true;\r\n\r\n        } else {\r\n            data.x = Math.round(newPosition.position[0]).toLocaleString(locale);\r\n            data.y = Math.round(newPosition.position[1]).toLocaleString(locale);\r\n        }\r\n\r\n        data.z = (Math.round(newPosition.altitude).toLocaleString(locale));\r\n        data.accuracy = (Math.round(newPosition.accuracy).toLocaleString(locale));\r\n        data.speed = newPosition.speed.toLocaleString(locale, { minimumFractionDigits: 1, maximumFractionDigits: 1 });\r\n\r\n        return data;\r\n    };\r\n\r\n    ctlProto.renderInfoNewPosition = function (d) {\r\n        var self = this;\r\n\r\n        self.getRenderedHtml(self.CLASS + '-tracking-toast', self.setFormatInfoNewPosition(d.pd), function (html) {\r\n\r\n            if (!self.track.infoPanel) {\r\n                self.track.infoPanel = true;\r\n\r\n                var resultsPanelOptions = {\r\n                    content: \"table\",\r\n                    titles: {\r\n                        main: self.getLocaleString(\"geo.mylocation\"),\r\n                        max: self.getLocaleString(\"geo.mylocation.show\")\r\n                    },\r\n                    classes: {\r\n                        collapsed: \"tracking\"\r\n                    }\r\n                };\r\n\r\n                var ctlPromise;\r\n                const addResultsPanelInfo = function (controlContainer) {\r\n                    resultsPanelOptions.position = controlContainer.POSITION.RIGHT;\r\n                    ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                };\r\n\r\n                if (self.options.displayOn) {\r\n                    var controlContainer = self.map.getControlsByClass('TC.control.' + self.options.displayOn[0].toUpperCase() + self.options.displayOn.substring(1))[0];\r\n                    if (!controlContainer) {\r\n                        self.map.addControl(self.options.displayOn).then(addResultsPanelInfo);\r\n                    } else {\r\n                        addResultsPanelInfo(controlContainer);\r\n                    }\r\n                } else {\r\n                    resultsPanelOptions.div = document.createElement('div');\r\n                    self.map.div.appendChild(resultsPanelOptions.div);\r\n                    ctlPromise = self.map.addControl('resultsPanel', resultsPanelOptions);\r\n                }\r\n\r\n                ctlPromise.then(function (resultsPanelInfo) {\r\n                    self.map.getControlsByClass('TC.control.ResultsPanel').filter(function (panel) {\r\n                        return panel.content === \"table\" && panel !== resultsPanelInfo;\r\n                    }).forEach(function (panel) {\r\n                        panel.close();\r\n                    });\r\n\r\n                    self.track.infoPanel = resultsPanelInfo;\r\n\r\n                    resultsPanelInfo.renderPromise().then(function () {\r\n                        resultsPanelInfo.open(html);\r\n                    });\r\n                });\r\n            } else if (typeof (self.track.infoPanel) !== \"boolean\" && !self.track.infoPanel.isMinimized()) {\r\n                self.track.infoPanel.renderPromise().then(function () {\r\n                    self.track.infoPanel.getTableContainer().innerHTML = html;\r\n                    if (!self.track.infoPanel.isVisible()) {\r\n                        self.track.infoPanel.doVisible();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n\r\n    var duringTrackingToolsPanel = function () {\r\n        var self = this;\r\n\r\n        if (!self.track.trackToolPanelOpened.checked) {\r\n            self.map.trigger(TC.Consts.event.TOOLSCLOSE);\r\n        }\r\n    };\r\n\r\n    var _tracking = function () {\r\n        var self = this;\r\n\r\n        self.activate();\r\n\r\n        _activateTrackingBtns.call(self);\r\n        duringTrackingToolsPanel.call(self);\r\n\r\n        self.on(self.Const.Event.POSITIONCHANGE, function (d) {\r\n\r\n            self.currentPoint = d.pd;\r\n            self.renderInfoNewPosition(d);\r\n\r\n            self.track.trackName.disabled = false;\r\n            self.track.trackSave.disabled = false;\r\n\r\n            self.track.trackWPT.disabled = false;\r\n            self.track.trackAdd.disabled = false;\r\n\r\n            // cada vez que se registra una nueva posición almacenamos en sessionStorage\r\n            TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, self.wrap.formattedToStorage(self.layerTracking).features);\r\n        });\r\n        self.on(self.Const.Event.STATEUPDATED, function (data) {\r\n            //self.track.htmlMarker.setAttribute('src', data.moving ? 'layout/idena/img/geo-marker-heading.png' : 'layout/idena/img/geo-marker.png');\r\n        });\r\n\r\n        self.clear(self.Const.Layers.TRACKING);\r\n\r\n        advertisement.call(self, self.Const.LocalStorageKey.TRACKINGSHOWADVERTISEMENT);\r\n\r\n        self.wrap.setTracking(true);\r\n    };\r\n\r\n    /* inicio gestión suspensión de la pantalla en móviles */\r\n    var _onpauseVideo;\r\n    var addVideoKeepScreenOn = function () {\r\n        var self = this;\r\n\r\n        if (!self.videoScreenOn) {\r\n            var media = {\r\n                WebM: \"data:video/webm;base64,GkXfo0AgQoaBAUL3gQFC8oEEQvOBCEKCQAR3ZWJtQoeBAkKFgQIYU4BnQI0VSalmQCgq17FAAw9CQE2AQAZ3aGFtbXlXQUAGd2hhbW15RIlACECPQAAAAAAAFlSua0AxrkAu14EBY8WBAZyBACK1nEADdW5khkAFVl9WUDglhohAA1ZQOIOBAeBABrCBCLqBCB9DtnVAIueBAKNAHIEAAIAwAQCdASoIAAgAAUAmJaQAA3AA/vz0AAA=\",\r\n                MP4: \"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAB8JbCAfCWwgAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAD3wlsIB8JbCAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAIAAAACAAAAAABsW1kaWEAAAAgbWRoZAAAAAB8JbCAfCWwgAAAA+gAAAAAVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW9IYW5kbGVyAAAAAVxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEcc3RibAAAALhzdHNkAAAAAAAAAAEAAACobXA0dgAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAIAAgASAAAAEgAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABj//wAAAFJlc2RzAAAAAANEAAEABDwgEQAAAAADDUAAAAAABS0AAAGwAQAAAbWJEwAAAQAAAAEgAMSNiB9FAEQBFGMAAAGyTGF2YzUyLjg3LjQGAQIAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAK2lsc3QAAAAjqXRvbwAAABtkYXRhAAAAAQAAAABMYXZmNTIuNzguMw==\"\r\n            };\r\n\r\n            self.videoScreenOn = document.createElement('video');\r\n            self.videoScreenOn.setAttribute(\"loop\", \"\");\r\n            self.videoScreenOn.setAttribute(\"muted\", \"\");\r\n            self.videoScreenOn.setAttribute(\"webkit-playsinline\", \"\");\r\n            self.videoScreenOn.setAttribute(\"playsinline\", \"\");\r\n            self.videoScreenOn.setAttribute(\"style\", \"transform: translateZ(0px);\");\r\n\r\n            var sourceWebM = document.createElement('source');\r\n            sourceWebM.src = media.WebM;\r\n            sourceWebM.type = \"video/webm\";\r\n            self.videoScreenOn.appendChild(sourceWebM);\r\n\r\n            var sourceMP4 = document.createElement('source');\r\n            sourceMP4.src = media.MP4;\r\n            sourceMP4.type = \"video/mp4\";\r\n            self.videoScreenOn.appendChild(sourceMP4);\r\n        }\r\n\r\n        self.videoScreenOn.play();\r\n    };\r\n    var removeVideoKeepScreenOn = function () {\r\n        var self = this;\r\n        if (self.videoScreenOn) {\r\n            self.videoScreenOn.pause();\r\n        }\r\n    };\r\n\r\n    var _onWindowBlurred;\r\n    var onWindowBlurred = function () {\r\n        var self = this;\r\n\r\n        fromSessionToStorage.apply(self);\r\n    };\r\n\r\n    var _onWindowFocused;\r\n    var onWindowFocused = function () {\r\n        var self = this;\r\n\r\n        if (self.videoScreenOn.paused)\r\n            self.videoScreenOn.play();\r\n\r\n        fromStorageToSession.apply(self);\r\n    };\r\n\r\n    var getHiddenProperty = function () {\r\n        var prefixes = ['webkit', 'moz', 'ms', 'o'];\r\n\r\n        if ('hidden' in document) return 'hidden';\r\n\r\n        for (var i = 0; i < prefixes.length; i++) {\r\n            if ((prefixes[i] + 'Hidden') in document)\r\n                return prefixes[i] + 'Hidden';\r\n        }\r\n\r\n        return null;\r\n    };\r\n    var _onWindowVisibility;\r\n    var onWindowVisibility = function () {\r\n        var self = this;\r\n\r\n        var hidden = getHiddenProperty();\r\n\r\n        if (!document[hidden])\r\n            onWindowFocused.apply(self);\r\n\r\n        console.log('video is: ' + self.videoScreenOn.paused);\r\n    };\r\n    var addWindowEvents = function () {\r\n        var self = this;\r\n\r\n        if (!_onWindowVisibility)\r\n            _onWindowVisibility = onWindowVisibility.bind(self);\r\n\r\n        if (!_onWindowBlurred)\r\n            _onWindowBlurred = onWindowBlurred.bind(self);\r\n\r\n        if (!_onWindowFocused)\r\n            _onWindowFocused = onWindowFocused.bind(self);\r\n\r\n        window.addEventListener('visibilitychange', _onWindowVisibility, false);\r\n\r\n        // ipad / iphone / ipod (Safari mobile, not Android default browsers not Chrome Mobile that is)\r\n        if (TC.Util.detectSafari() && TC.browserFeatures.touch() && !navigator.userAgent.match(/Android/i) && !navigator.userAgent.match(/CriOS/i)) {\r\n            window.addEventListener('pagehide', _onWindowBlurred, false);\r\n            window.addEventListener('pageshow', _onWindowFocused, false);\r\n        } else { // the rest            \r\n            window.addEventListener('blur', _onWindowBlurred, false);\r\n            window.addEventListener('focus', _onWindowFocused, false);\r\n        }\r\n    }\r\n    var removeWindowEvents = function () {\r\n\r\n        window.removeEventListener('visibilitychange', _onWindowVisibility, false);\r\n\r\n        // ipad / iphone / ipod (Safari mobile, not Android default browsers not Chrome Mobile that is)\r\n        if (TC.Util.detectSafari() && TC.browserFeatures.touch() && !navigator.userAgent.match(/Android/i) && !navigator.userAgent.match(/CriOS/i)) {\r\n            window.removeEventListener('pagehide', _onWindowBlurred, false);\r\n            window.removeEventListener('pageshow', _onWindowFocused, false);\r\n        } else { // the rest            \r\n            window.removeEventListener('blur', _onWindowBlurred, false);\r\n            window.removeEventListener('focus', _onWindowFocused, false);\r\n        }\r\n    };\r\n\r\n    var fromSessionToStorage = function () {\r\n        var self = this;\r\n\r\n        var sessionTracking = TC.Util.storage.getSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n        if (sessionTracking && sessionTracking.length > 0)\r\n            localforage.setItem(self.Const.LocalStorageKey.TRACKINGTEMP, typeof (sessionTracking) === \"string\" ? sessionTracking : JSON.stringify(sessionTracking));\r\n    };\r\n    var fromStorageToSession = function () {\r\n        var self = this;\r\n\r\n        localforage.getItem(self.Const.LocalStorageKey.TRACKINGTEMP).then(function (storageData) {\r\n            if (storageData !== null && storageData !== \"null\" && storageData.length > 0) {\r\n                TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, storageData);\r\n            }\r\n        });\r\n    };\r\n    /* final gestión suspensión de la pantalla en móviles */\r\n\r\n    var advertisement = function (showAdvertisement) {\r\n        var self = this;\r\n\r\n        var done = new Promise(function (resolve, reject) {\r\n            if (window.localforage)\r\n                resolve();\r\n            else {\r\n                TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                    resolve();\r\n                });\r\n            }\r\n        });\r\n\r\n        done.then(function () {\r\n            localforage.getItem(showAdvertisement).then(function (registeredShowAdvertisement) {\r\n                if (registeredShowAdvertisement == null) {\r\n                    const dialog = self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-dialog');\r\n                    const checkbox = dialog.querySelector('input[type=\"checkbox\"]');\r\n                    checkbox.setAttribute('name', showAdvertisement);\r\n                    checkbox.checked = false;\r\n\r\n                    document.querySelector('#pageBlurMsg').textContent = TC.Util.detectMobile() ? self.getLocaleString('geo.trk.page.blur') : self.getLocaleString('geo.trk.page.blur.desktop');\r\n\r\n                    dialog.querySelector('h3').textContent = showAdvertisement == self.Const.LocalStorageKey.GPSSHOWADVERTISEMENT ?\r\n                        self.getLocaleString(\"geo.track.activate\") + \" \" + self.getLocaleString(\"geo.gps\") :\r\n                        self.getLocaleString('geo.track.activate.title');\r\n\r\n                    TC.Util.showModal(self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-dialog'));\r\n                }\r\n            });\r\n        });\r\n\r\n        self.map.toast(!TC.Util.detectMobile() ? self.getLocaleString('geo.trk.page.blur.desktop') : self.getLocaleString('geo.trk.page.blur'), {\r\n            type: TC.Consts.msgType.WARNING\r\n        });\r\n    };\r\n\r\n    ctlProto._askTracking = function (callback) {\r\n        var self = this;\r\n\r\n        TC.Util.showModal(self._dialogDiv.querySelector('.tc-ctl-geolocation-continue-track-dialog'), {\r\n            closeCallback: function () {\r\n\r\n                if (TC.Util.isFunction(callback)) {\r\n                    callback();\r\n                }\r\n            }\r\n        });\r\n\r\n        return true;\r\n    };\r\n\r\n    ctlProto.activateTracking = function () {\r\n        var self = this;\r\n        var trackingAvailable = true;\r\n\r\n        if (!self.isActive) {\r\n            self.activate();\r\n        }\r\n\r\n        self.clear(self.Const.Layers.TRACKING);\r\n\r\n        try {\r\n            TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TEST, self.Const.LocalStorageKey.TEST);\r\n        } catch (error) {\r\n            if (error.code === DOMException.QUOTA_EXCEEDED_ERR)\r\n                TC.alert(self.getLocaleString(\"geo.error.trackinglocalstorage\"));\r\n            else TC.error(error);\r\n\r\n            trackingAvailable = false;\r\n        }\r\n\r\n        if (trackingAvailable) {\r\n            addVideoKeepScreenOn.apply(self);\r\n            addWindowEvents.apply(self);\r\n\r\n            self.sessionTracking = TC.Util.storage.getSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n            if (self.sessionTracking) {\r\n                var asked = self._askTracking(function () {\r\n                    _deactivateTrackingBtns.call(self);\r\n                });\r\n\r\n                if (!asked) {\r\n                    self.track.trackRenew.click();\r\n                }\r\n            } else _tracking.call(self);\r\n        } else { _deactivateTrackingBtns.call(self); }\r\n    };\r\n\r\n    ctlProto.deactivateTracking = function () {\r\n        var self = this;\r\n\r\n        var _deactivateTracking = function () {\r\n\r\n            self.track.infoPanel.close();\r\n\r\n            fromSessionToStorage.apply(self);\r\n\r\n            self.wrap.setTracking(false);\r\n\r\n\r\n            delete self.geopositionTracking;\r\n\r\n            if (!visibilityTrack) {\r\n                self.div.querySelector(self._classSelector + '-track-render').querySelector('label').click();\r\n            }\r\n\r\n            removeVideoKeepScreenOn.apply(self);\r\n            removeWindowEvents.apply(self);\r\n\r\n            self.off(self.Const.Event.POSITIONCHANGE);\r\n            self.off(self.Const.Event.STATEUPDATED);\r\n\r\n            _deactivateTrackingBtns.call(self);\r\n\r\n            self.track.trackName.value = '';\r\n            self.track.trackName.disabled = true;\r\n            self.track.trackSave.disabled = true;\r\n\r\n            self.track.trackWPT.value = '';\r\n            self.track.trackWPT.disabled = true;\r\n            self.track.trackAdd.disabled = true;\r\n\r\n            self.clear(self.Const.Layers.TRACKING);\r\n            self.clear(self.Const.Layers.GPS);\r\n\r\n            //TC.Control.prototype.deactivate.call(self);\r\n\r\n            return true;\r\n        };\r\n\r\n        if (self.wrap.hasCoordinates()) {\r\n            self.map.toast(self.getLocaleString(\"geo.trk.deactivate.alert\"), {\r\n                duration: 10000\r\n            });\r\n            //TC.alert(self.getLocaleString(\"geo.trk.deactivate.alert\"));\r\n            return _deactivateTracking();\r\n        } else return _deactivateTracking();\r\n    };\r\n\r\n    /* Obtengo los tracks desde localForage */\r\n    ctlProto.getStoredTracks = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var tracks = [];\r\n\r\n            localforage.keys().then(function (keys) {\r\n                keys = keys.filter(function (k) {\r\n                    if (!(k.indexOf(self.Const.LocalStorageKey.TRACKINGTEMP) === 0) && k.indexOf(self.Const.LocalStorageKey.TRACKING) === 0) {\r\n                        return /trk#\\d/i.exec(k);\r\n                    }\r\n                    return false;\r\n                });\r\n\r\n                if (keys.length == 0) {\r\n                    self.availableTracks = tracks;\r\n                    resolve(tracks);\r\n                }\r\n\r\n                const promises = new Array(keys.length);\r\n                keys.forEach(function (key, idx) {\r\n                    promises[idx] = new Promise(function (res, rej) {\r\n                        localforage.getItem(key, function (e, v) {\r\n                            res(v);\r\n                        });\r\n                    });\r\n                });\r\n\r\n                Promise.all(promises).then(function (results) {\r\n                    if (results && results.length) {\r\n                        results.forEach(function (r) {\r\n                            var r = JSON.parse(r);\r\n                            if (r instanceof Array) {\r\n                                tracks = tracks.concat(r);\r\n                            } else {\r\n                                tracks.push(r);\r\n                            }\r\n                        });\r\n\r\n                        var tracksArray = tracks.length > 1 ? _orderTracks(tracks) : tracks;\r\n                        self.availableTracks = tracksArray;\r\n                        resolve(tracksArray);\r\n                    }\r\n                });\r\n            });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Recibe una sucesión de tracks y la ordena por nombre.\r\n     */\r\n    var _orderTracks = function (tracks) {\r\n        var tracksArray = [];\r\n\r\n        for (var index in tracks) {\r\n            if (tracks[index] && typeof (tracks[index]) === \"object\") {\r\n                tracksArray.push(tracks[index]);\r\n                tracksArray.sort(function (a, b) {\r\n                    if (typeof (a.name) === \"string\") {\r\n                        return TC.Util.isFunction(a.name.localeCompare) ? a.name.localeCompare(b.name) : 0;\r\n                    } else { return 0; }\r\n                });\r\n            }\r\n        }\r\n\r\n        return tracksArray;\r\n    };\r\n\r\n    /* Almaceno los tracks mediante localForage, actualizo la vble availableTracks y actualizo la lista de tracks */\r\n    ctlProto.setStoredTracks = function (tracks) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const promises = [];\r\n            tracks.forEach(function (t) {\r\n                promises.push(new Promise(function (res, rej) {\r\n                    localforage.setItem(self.Const.LocalStorageKey.TRACKING + \"#\" + t.uid, JSON.stringify(t), function (e, v) {\r\n                        res(v);\r\n                    });\r\n                }));\r\n            });\r\n\r\n            Promise.all(promises).then(function () {\r\n                self.getStoredTracks().then(function () {\r\n                    self.bindTracks();\r\n                    resolve();\r\n                });\r\n            });\r\n        });\r\n    };\r\n\r\n    /* Obtengo los tracks desde vble local */\r\n    ctlProto.getAvailableTracks = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            if (!self.availableTracks) {\r\n                self.getStoredTracks().then(function (availableTracks) {\r\n                    resolve(availableTracks);\r\n                });\r\n            }\r\n            else {\r\n                resolve(self.availableTracks);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.bindTracks = function () {\r\n        var self = this;\r\n\r\n        const listItems = self.track.trackList.querySelectorAll('li');\r\n        listItems.forEach(function (li) {\r\n            li.style.display = 'none';\r\n        });\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n\r\n            if (_isEmpty(tracks)) {\r\n                self.track.trackList.querySelectorAll('li[class^=\"tc-ctl-geolocation-track-available-empty\"]').forEach(function (li) {\r\n                    li.style.display = '';\r\n                });\r\n                self.track.trackSearch.disabled = true;\r\n            }\r\n            else {\r\n                const currentSelectedTrack = self.getSelectedTrack();\r\n                var currentSelectedTrackId;\r\n                if (currentSelectedTrack) {\r\n                    currentSelectedTrackId = currentSelectedTrack.dataset.uid\r\n                }\r\n                self.track.trackList.querySelectorAll('li[data-id]').forEach(function (li) {\r\n                    self.track.trackList.removeChild(li);\r\n                });\r\n\r\n                for (var i = 0; i < tracks.length; i++) {\r\n                    var t = tracks[i];\r\n                    if (typeof (t) === \"object\") {\r\n                        self.getRenderedHtml(self.CLASS + '-track-node', {\r\n                            id: i, uid: t.uid, name: t.name ? t.name.trim() : ''\r\n                        }, function (html) {\r\n                            const parser = new DOMParser();\r\n                            const newLi = parser.parseFromString(html, 'text/html').body.firstChild;\r\n                            self.track.trackList.appendChild(newLi);\r\n                        });\r\n                    }\r\n                }\r\n\r\n                if (currentSelectedTrackId) {\r\n                    self.setSelectedTrack(self.track.trackList.querySelector('li[data-uid=\"' + currentSelectedTrackId + '\"]'));\r\n                }\r\n\r\n                self.track.trackSearch.disabled = false;\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.chartProgressInit = function () {\r\n        const self = this;\r\n\r\n        if (!window.d3) {\r\n            TC.syncLoadJS(TC.Consts.url.D3C3);\r\n        }\r\n\r\n        const dataDiv = d3.select(\".c3-event-rects,.c3-event-rects-single\").node().getBoundingClientRect();\r\n        self.miDiv = document.createElement('div');\r\n        self.miDiv.classList.add('miDiv');\r\n        self.miDiv.style.width = dataDiv.width + 'px';\r\n        self.miDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miProgressDiv = document.createElement('div');\r\n        self.miProgressDiv.classList.add(\r\n            'miProgressDiv',\r\n            self.CLASS + '-track-elevation-chart-progress',\r\n            TC.Consts.classes.HIDDEN);\r\n        self.miProgressDiv.style.width = '0%';\r\n        self.miProgressDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miProgressTextDiv = document.createElement('div');\r\n        self.miProgressTextDiv.classList.add(\r\n            'miProgressTextDiv',\r\n            'tc-ctl-geolocation-track-elevation-chart-progress',\r\n            'text');\r\n        self.miProgressTextDiv.style.width = dataDiv.width + 'px';\r\n        self.miProgressTextDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miDiv.style.top = dataDiv.top + 'px';\r\n        self.miDiv.style.left = dataDiv.left + 'px';\r\n        self.miDiv.style.bottom = dataDiv.bottom + 'px';\r\n        self.miDiv.style.right = dataDiv.right + 'px';\r\n        self.miDiv.style.position = 'absolute';\r\n        self.miDiv.style.zIndex = 10008;\r\n        self.miDiv.style.display = 'none';\r\n\r\n        self.miProgressDiv.appendChild(self.miProgressTextDiv);\r\n        self.miDiv.appendChild(self.miProgressDiv);\r\n        document.body.appendChild(self.miDiv);\r\n\r\n    };\r\n\r\n    ctlProto.chartProgressClear = function () {\r\n        const self = this;\r\n        if (self.miDiv) {\r\n            self.miDiv.parentElement.removeChild(self.miDiv);\r\n            self.miDiv = null;\r\n            self.miProgressDiv = null;\r\n            self.miProgressTextDiv = null;\r\n        }\r\n    };\r\n\r\n    ctlProto.chartSetProgress = function (previous, current, distance, doneTime) {\r\n        var self = this;\r\n\r\n        if (self.miDiv && self.miDiv.style.display === 'none') {\r\n            self.miDiv.style.display = '';\r\n        }\r\n        \r\n        self.miProgressDiv.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n        var done = previous.d;\r\n        var progress = (done + Math.hypot(previous.p[0] - current[0], previous.p[1] - current[1])) / distance * 100;\r\n\r\n        self.miProgressDiv.style.width = progress + '%';\r\n\r\n        var locale = self.map.options.locale && self.map.options.locale.replace('_', '-') || undefined;\r\n        var ele = parseInt(current[2].toFixed(0)).toLocaleString(locale);\r\n        var dist;\r\n        var measure;\r\n        if ((done / 1000) < 1) {\r\n            dist = Math.round((done / 1000) * 1000);\r\n            measure = ' m';\r\n        } else {\r\n            dist = Math.round((done / 1000) * 100) / 100;\r\n            measure = ' km';\r\n        }\r\n\r\n        dist = dist.toLocaleString(locale);\r\n\r\n        self.miProgressTextDiv.innerHTML = '<div><span>' + ele + ' m' + '</span>' + '<br>' + '<span>' + dist + measure + '</span></div>' + (doneTime ? '<br><span>' + doneTime.toString + '</span>' : '');\r\n\r\n    };\r\n\r\n    ctlProto._getTime = function (timeFrom, timeTo) {\r\n        var diff = timeTo - timeFrom;\r\n        var d = {};\r\n        var daysDifference = Math.floor(diff / 1000 / 60 / 60 / 24);\r\n        diff -= daysDifference * 1000 * 60 * 60 * 24;\r\n\r\n        var hoursDifference = Math.floor(diff / 1000 / 60 / 60);\r\n        diff -= hoursDifference * 1000 * 60 * 60;\r\n\r\n        d.h = hoursDifference + (daysDifference * 24);\r\n\r\n        var minutesDifference = Math.floor(diff / 1000 / 60);\r\n        diff -= minutesDifference * 1000 * 60;\r\n\r\n        d.m = minutesDifference;\r\n\r\n        d.s = Math.floor(diff / 1000);\r\n\r\n        return TC.Util.extend({}, d, { toString: (\"00000\" + d.h).slice(-2) + ':' + (\"00000\" + d.m).slice(-2) + ':' + (\"00000\" + d.s).slice(-2) });\r\n    };\r\n\r\n    ctlProto.simulateTrack = function (li) {\r\n        var self = this;\r\n\r\n        self.simulate_speed = 1;\r\n\r\n        self.drawTrack(li, false).then(function () {\r\n            self.wrap.simulateTrack();\r\n        });\r\n    };\r\n\r\n    ctlProto.drawTrack = function (li, activateSnapping) {\r\n        var self = this;\r\n\r\n        duringTrackingToolsPanel.call(self);\r\n        return new Promise(function (resolve, reject) {\r\n            self.setSelectedTrack(li);\r\n            self.drawTrackingData(li).then(function () {\r\n                self.elevationTrack(li).then(() => {\r\n                    self.activate();\r\n\r\n                    resolve();\r\n                }); \r\n            });\r\n        });\r\n    };\r\n\r\n\r\n    ctlProto.elevationTrack = function (li, resized) {\r\n        var self = this;\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const setCurrentFeature = function () {\r\n                if (self.resultsPanelChart) {\r\n                    self.resultsPanelChart.currentFeature = self.layerTrack.features.filter((feature) => {\r\n                        return !(TC.feature.Marker && feature instanceof TC.feature.Marker) && !(TC.feature.Point && feature instanceof TC.feature.Point)\r\n                    })[0];\r\n                }\r\n            };\r\n\r\n            if (resized) {\r\n\r\n                self.wrap.simulateTrackEnd();\r\n                self.uiSimulate(false, li);\r\n                return;\r\n            }\r\n\r\n            if (!self.onResize) {\r\n                self.onResize = self.elevationTrack.bind(self, li, true);\r\n                window.addEventListener(\"resize\", self.onResize, false);\r\n            }\r\n\r\n            let chartCoordinates = [];\r\n\r\n            if (self.track.elevationChart)\r\n                self.track.elevationChart = self.track.elevationChart.destroy();\r\n\r\n            var getChartData = function (li) {\r\n                return new Promise(function (resolve, reject) {\r\n                    TC.loadJS(\r\n                        !TC.tool || !TC.tool.Elevation,\r\n                        TC.apiLocation + 'TC/tool/Elevation',\r\n                        function () {\r\n                            self.getTrackingData(li).then(function (track) {\r\n                                var geoJSON = track.data;\r\n                                if (geoJSON) {\r\n                                    var x, ele; x = []; ele = [];\r\n                                    var empty = true;\r\n                                    var minEle, maxEle;\r\n                                    var elevationGain = {};\r\n                                    var time = {};\r\n                                    var km = 0;\r\n                                    var geom;\r\n\r\n                                    var f = (new ol.format.GeoJSON()).readFeatures(geoJSON);\r\n\r\n                                    var getDistance = function () {\r\n                                        if (geom.getLayout() == ol.geom.GeometryLayout.XYZ ||\r\n                                            geom.getLayout() == ol.geom.GeometryLayout.XYZM) {\r\n                                            var distance = 0;\r\n                                            if (self.map.crs !== self.map.options.utmCrs) {\r\n                                                line = new ol.geom.LineString(TC.Util.reproject(geom.getCoordinates(), self.map.crs, self.map.options.utmCrs));\r\n                                                distance = line.getLength();\r\n                                            } else {\r\n                                                distance = geom.getLength();\r\n                                            }\r\n                                            return parseFloat((distance / 1000).toFixed(2));\r\n                                        }\r\n\r\n                                        return null;\r\n                                    };\r\n                                    var getTime = function () {\r\n                                        if (geom.getLayout() == ol.geom.GeometryLayout.XYZM ||\r\n                                            geom.getLayout() == ol.geom.GeometryLayout.XYM) {\r\n                                            var diff = geom.getLastCoordinate()[3] - geom.getFirstCoordinate()[3];\r\n                                            return {\r\n                                                s: Math.floor((diff / 1000) % 60),\r\n                                                m: Math.floor(((diff / (1000 * 60)) % 60)),\r\n                                                h: Math.floor(((diff / (1000 * 60 * 60)) % 24))\r\n                                            };\r\n                                        }\r\n\r\n                                        return null;\r\n                                    };\r\n\r\n                                    var addX = function (x) {\r\n                                        if (chartCoordinates.length > 0) {\r\n                                            var distance = 0;\r\n                                            chartCoordinates\r\n                                                .forEach(function (point, idx, arr) {\r\n                                                    var prev = idx === 0 ? point : arr[idx - 1];\r\n\r\n                                                    if (self.map.crs !== self.map.options.utmCrs) {\r\n                                                        point = TC.Util.reproject(point, self.map.crs, self.map.options.utmCrs);\r\n                                                        prev = TC.Util.reproject(prev, self.map.crs, self.map.options.utmCrs);\r\n                                                    }\r\n\r\n                                                    const dx = point[0] - prev[0];\r\n                                                    const dy = point[1] - prev[1];\r\n                                                    distance += Math.sqrt(dx * dx + dy * dy);\r\n\r\n                                                    x.push(parseFloat(distance.toFixed(2)));\r\n                                                });\r\n                                        }\r\n                                    };\r\n\r\n                                    var addElevation = function (ele) {\r\n                                        var y = [];\r\n                                        for (var i = 0; i < chartCoordinates.length; i++) {\r\n                                            if (chartCoordinates[i].length > 2) {\r\n                                                var v = (Math.round(chartCoordinates[i][2] * 10) / 10);\r\n                                                if (empty && v > 0)\r\n                                                    empty = false;\r\n\r\n                                                ele.push(v);\r\n\r\n                                                if (i == 0)\r\n                                                    minEle = maxEle = v;\r\n\r\n                                                minEle = Math.min(minEle, v);\r\n                                                maxEle = Math.max(maxEle, v);\r\n\r\n                                            }\r\n                                            else {\r\n                                                resolve(null);\r\n                                                return;\r\n                                            }\r\n                                        }\r\n                                    };\r\n\r\n                                    f.filter(function (feature) {\r\n                                        return feature.getGeometry().getType().toLowerCase() === 'linestring' || feature.getGeometry().getType().toLowerCase() === 'multilinestring';\r\n                                    }).forEach(function (feature) {\r\n                                        geom = feature.getGeometry();\r\n\r\n                                        switch (geom.getType().toLowerCase()) {\r\n                                            case 'linestring':\r\n\r\n                                                if (track.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                    track.layout === ol.geom.GeometryLayout.XYZ) {\r\n\r\n                                                    time = getTime(geom);\r\n                                                    km = getDistance(geom);\r\n                                                    elevationGain = TC.tool.Elevation.getElevationGain({ coords: geom.getCoordinates(), hillDeltaThreshold: self.gapHill });\r\n                                                    chartCoordinates = chartCoordinates.concat(geom.getCoordinates());\r\n\r\n                                                    addX(x);\r\n                                                    addElevation(ele);\r\n                                                }\r\n                                                break;\r\n                                            case 'multilinestring':\r\n\r\n                                                if (track.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                    track.layout === ol.geom.GeometryLayout.XYZ) {\r\n\r\n                                                    var _time;\r\n                                                    var ls = geom.getLineStrings();\r\n                                                    for (var i = 0; i < ls.length; i++) {\r\n                                                        km = km + getDistance(ls[i]);\r\n\r\n                                                        if (ls[i].getLayout() == ol.geom.GeometryLayout.XYZM)\r\n                                                            _time = _time + (ls[i].getLastCoordinate()[3] - ls[i].getFirstCoordinate()[3]);\r\n\r\n                                                        chartCoordinates = chartCoordinates.concat(ls[i].getCoordinates());\r\n\r\n                                                        if (_time) { time = getTime(_time); }\r\n\r\n                                                        addX(x);\r\n                                                        addElevation(ele);\r\n                                                    }\r\n                                                }\r\n\r\n                                                break;\r\n                                            default:\r\n                                                return null;\r\n                                                break;\r\n                                        }\r\n                                    });\r\n\r\n                                    if (ele instanceof Array && ele.length == 0) {\r\n                                        empty = true;\r\n                                    }\r\n\r\n                                    self.elevationChartData = !empty ? TC.Util.extend({}, { time: time, ele: ele, x: x, miny: minEle, maxy: maxEle }, elevationGain) : null;\r\n\r\n                                    resolve(self.elevationChartData);\r\n                                    return;\r\n                                }\r\n\r\n                                resolve(null);\r\n                                return;\r\n                            });\r\n                        }\r\n                    );\r\n                });\r\n            };\r\n\r\n            getChartData(li).then(function (data) {\r\n                if (data != null) {\r\n                    if (data.time) data.time = (\"00000\" + data.time.h).slice(-2) + ':' + (\"00000\" + data.time.m).slice(-2) + ':' + (\"00000\" + data.time.s).slice(-2);\r\n                    data.coords = chartCoordinates;\r\n                    self.hasElevation = true;\r\n                }\r\n                else {\r\n                    self.hasElevation = false;\r\n                    data = {\r\n                        msg: self.getLocaleString(\"geo.trk.chart.chpe.empty\")\r\n                    };\r\n                }\r\n\r\n                data.minHeight = self.CHART_SIZE.MIN_HEIGHT;\r\n                data.maxHeight = self.CHART_SIZE.MAX_HEIGHT;\r\n\r\n                data.minWidth = self.CHART_SIZE.MIN_WIDTH;\r\n                data.mediumWidth = self.CHART_SIZE.MEDIUM_WIDTH;\r\n                data.maxWidth = self.CHART_SIZE.MAX_WIDTH;\r\n\r\n                self.map.one(TC.Consts.event.DRAWCHART, function (e) {\r\n                    self.chartProgressInit();\r\n                    resolve();\r\n                });\r\n\r\n                if (!self.resultsPanelChart) {\r\n\r\n                    if (!window.c3) {\r\n                        TC.syncLoadJS(TC.Consts.url.D3C3 || TC.apiLocation + 'lib/d3c3/d3c3.min.js');\r\n                    }\r\n\r\n                    var resultsPanelOptions = {\r\n                        content: \"chart\",\r\n                        titles: {\r\n                            main: self.getLocaleString(\"geo.trk.chart.chpe\"),\r\n                            max: self.getLocaleString(\"geo.trk.chart.chpe\")\r\n                        },\r\n                        openOn: self.Const.Event.DRAWTRACK,\r\n                        closeOn: self.Const.Event.CLEARTRACK,\r\n                        chart: {\r\n                            ctx: self,\r\n                            onmouseout: ctlProto.removeElevationTooltip,\r\n                            tooltip: ctlProto.getElevationTooltip\r\n                        }\r\n                    };\r\n\r\n                    var ctlPromise;\r\n                    const addResultsPanelChart = function (controlContainer) {\r\n                        resultsPanelOptions.position = controlContainer.POSITION.RIGHT;\r\n                        ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                    };\r\n\r\n                    if (self.options.displayOn) {\r\n                        var controlContainer = self.map.getControlsByClass('TC.control.' + self.options.displayOn[0].toUpperCase() + self.options.displayOn.substring(1))[0];\r\n                        if (!controlContainer) {\r\n                            self.map.addControl(self.options.displayOn).then(addResultsPanelChart);\r\n                        } else {\r\n                            addResultsPanelChart(controlContainer);\r\n                        }\r\n                    } else {\r\n                        resultsPanelOptions.div = document.createElement('div');\r\n                        self.map.div.appendChild(resultsPanelOptions.div);\r\n                        ctlPromise = self.map.addControl('resultsPanel', resultsPanelOptions);\r\n                    }\r\n\r\n                    ctlPromise.then(function (resultsPanelChart) {\r\n                        resultsPanelChart.caller = self;\r\n                        self.resultsPanelChart = resultsPanelChart;\r\n\r\n                        setCurrentFeature();\r\n                        resultsPanelChart.renderPromise().then(function () {\r\n\r\n                            resultsPanelChart.activateSnapping = function (e) {\r\n                                if (self.layerTrack && (!self.layerTrack.getVisibility() && self.layerTrack.getOpacity() == 0))\r\n                                    self.wrap.deactivateSnapping.call(self.wrap);\r\n                            };\r\n                            resultsPanelChart.deactivateSnapping = function (e) {\r\n                                if (self.layerTrack && self.layerTrack.getVisibility() && self.layerTrack.getOpacity() > 0)\r\n                                    self.wrap.activateSnapping.call(self.wrap);\r\n                            };\r\n\r\n                            resultsPanelChart.div.addEventListener('mouseover', resultsPanelChart.deactivateSnapping);\r\n                            resultsPanelChart.div.addEventListener('mouseout', resultsPanelChart.activateSnapping);\r\n\r\n                            self.map\r\n                                .on(TC.Consts.event.RESULTSPANELMIN, function () {\r\n                                    if (self.miDiv) {\r\n                                        self.miDiv.style.display = 'none';\r\n                                    }\r\n                                })\r\n                                .on(TC.Consts.event.RESULTSPANELMAX, function () {\r\n                                    if (self.miDiv) {\r\n                                        self.miDiv.style.display = '';\r\n                                    }\r\n                                })\r\n                                .on(TC.Consts.event.RESULTSPANELCLOSE, function () {\r\n                                    if (self.miDiv) {\r\n                                        self.miDiv.style.display = 'none';\r\n                                    }\r\n                                });\r\n\r\n                            self.map.trigger(self.Const.Event.DRAWTRACK, { data: data });\r\n                        });\r\n                    });\r\n                } else {\r\n                    setCurrentFeature();\r\n                    self.resultsPanelChart.open();\r\n                    self.map.trigger(self.Const.Event.DRAWTRACK, { data: data });\r\n                }\r\n\r\n                // 10/02/2020 gestionamos el borrado desde featureTools\r\n                onFeatureRemove = onFeatureRemove.bind(self);\r\n                self.map.on(TC.Consts.event.FEATUREREMOVE, onFeatureRemove);\r\n            });\r\n        });        \r\n    };\r\n\r\n    ctlProto.clear = function (layerType) {\r\n        var self = this;\r\n\r\n        if (self.onResize) {\r\n            window.removeEventListener(\"resize\", self.onResize, false);\r\n            self.onResize = undefined;\r\n        }\r\n\r\n        if (layerType == self.Const.Layers.TRACK) {\r\n\r\n            self.layerTrack.clearFeatures();\r\n\r\n            // gráfico perfil de elevación\r\n            if (self.resultsPanelChart)\r\n                self.resultsPanelChart.close();\r\n            delete self.elevationChartData;\r\n\r\n            // overlay de la simulación\r\n            self.wrap.simulateTrackEnd();\r\n\r\n            self.wrap.clear();\r\n\r\n            // eliminamos la selección en la lista de tracks\r\n            self.track.trackList.querySelectorAll('li').forEach(function (li) {\r\n                li.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n            });\r\n\r\n            self.map.trigger(self.Const.Event.CLEARTRACK);\r\n\r\n            self.featuresToShare = [];\r\n\r\n            //TC.Control.prototype.deactivate.call(self);\r\n\r\n        } else {\r\n            self.layerTracking.clearFeatures();\r\n            self.layerGPS.clearFeatures();\r\n        }\r\n    };\r\n\r\n    ctlProto.saveTrack = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            var message = options.message || self.getLocaleString(\"geo.trk.save.alert\");\r\n\r\n            var _save = function (layer) {\r\n                var wait;\r\n                wait = self.getLoadingIndicator().addWait();\r\n\r\n                var trackName = options.importedFileName || self.track.trackName.value.trim();\r\n\r\n                var tracks = self.availableTracks;\r\n                if (!tracks) {\r\n                    tracks = [];\r\n                }\r\n\r\n                var formatted = self.wrap.formattedToStorage(layer, true, options.notReproject);\r\n\r\n                var clean = function (wait) {\r\n                    self.track.trackName.value = '';\r\n                    self.track.trackName.disabled = true;\r\n                    self.track.trackSave.disabled = true;\r\n\r\n                    self.track.trackWPT.value = '';\r\n                    self.track.trackWPT.disabled = true;\r\n                    self.track.trackAdd.disabled = true;\r\n\r\n                    self.getLoadingIndicator().removeWait(wait);\r\n\r\n                    duringTrackingToolsPanel.call(self);\r\n                };\r\n\r\n                var newTrack = {\r\n                    name: trackName,\r\n                    data: formatted.features,\r\n                    layout: formatted.layout,\r\n                    crs: self.storageCRS\r\n                };\r\n\r\n                TC.loadJS(\r\n                    !window.hex_md5,\r\n                    [TC.apiLocation + TC.Consts.url.HASH],\r\n                    function () {\r\n                        var hash = hex_md5(JSON.stringify(newTrack));\r\n\r\n                        var sameTrackUID = tracks.map(function (savedTrack) {\r\n                            var clonedTrack = JSON.parse(JSON.stringify(savedTrack));\r\n                            delete clonedTrack.uid;\r\n                            if (hash === hex_md5(JSON.stringify(clonedTrack))) {\r\n                                return savedTrack.uid;\r\n                            } else {\r\n                                const jsonFormat = new ol.format.GeoJSON();\r\n                                // validamos si se trata de un track exportado/importado ya que se compacta la geometría\r\n                                var features = jsonFormat.readFeatures(clonedTrack.data);\r\n                                // Aplicamos una precisión un dígito mayor que la del mapa, si no, al compartir algunas parcelas se deforman demasiado\r\n                                var precision = Math.pow(10, TC.Consts.DEGREE_PRECISION + 1);\r\n\r\n                                features.forEach(function (feature) {\r\n                                    var geom = TC.Util.explodeGeometry(TC.Util.compactGeometry(feature.getGeometry().getCoordinates(), precision));\r\n                                    feature.getGeometry().setCoordinates(geom);\r\n                                });\r\n\r\n                                clonedTrack.data = jsonFormat.writeFeatures(features);\r\n\r\n                                if (hash === hex_md5(JSON.stringify(clonedTrack))) {\r\n                                    return savedTrack.uid;\r\n                                } else {\r\n                                    return null;\r\n                                }\r\n                            }\r\n\r\n                        }).filter(function (uid) {\r\n                            return uid !== null\r\n                        });\r\n\r\n                        const getTrackIndex = function (uid) {\r\n                            return self.getStoredTracks().then(function () {\r\n                                self.bindTracks();\r\n\r\n                                var index;\r\n                                for (var i = 0; i < self.availableTracks.length; i++) {\r\n                                    if (self.availableTracks[i].uid === uid) {\r\n                                        index = i;\r\n                                        break;\r\n                                    }\r\n                                }\r\n\r\n                                return index;\r\n                            });\r\n                        };\r\n\r\n                        if (sameTrackUID.length === 0) {\r\n\r\n                            newTrack.uid = Date.now() + Math.random();\r\n                            tracks.push(newTrack);\r\n                            tracks = _orderTracks(tracks);\r\n\r\n                            try {\r\n                                self.setStoredTracks(tracks).then(function () {\r\n                                    self.map.toast(message, { duration: 3000 });\r\n\r\n                                    clean(wait);\r\n\r\n                                    getTrackIndex(newTrack.uid).then(function (index) {\r\n                                        resolve(index);\r\n                                    });\r\n                                });\r\n\r\n                            } catch (error) {\r\n                                TC.alert(self.getLocaleString(\"geo.error.savelocalstorage\") + ': ' + error.message);\r\n                                clean(wait);\r\n                                reject(error);\r\n                            }\r\n                        } else {\r\n                            console.log('Ya existe un track con ese mismo hash');\r\n\r\n                            clean(wait);\r\n\r\n                            getTrackIndex(sameTrackUID[0]).then(function (index) {\r\n                                resolve(index);\r\n                            });\r\n                        }\r\n                    });\r\n\r\n            };\r\n\r\n            const createTCFeatures = function (features) {\r\n                return new Promise(function (resolve, reject) {\r\n                    var featurePromises = features.filter(function (feature) {\r\n                        return !feature._wrap;\r\n                    }).forEach(function (elm) {\r\n                        return TC.wrap.Feature.createFeature(elm);\r\n                    });\r\n\r\n                    Promise.all(featurePromises).then(function (tcFeatures) {\r\n                        resolve();\r\n                    });\r\n                });\r\n            };\r\n\r\n            if (self.importedFileName)\r\n                _save(self.layerTrack);\r\n            else if (self.track.trackName.value.trim().length == 0) {\r\n                self.track.trackName.value = new Date().toLocaleString();\r\n                _save(self.layerTracking);\r\n            }\r\n            else {\r\n                _save(self.layerTracking);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.addWaypoint = function () {\r\n        var self = this;\r\n\r\n        var waypointName = self.track.trackWPT.value.trim();\r\n        if (!waypointName) {\r\n            waypointName = new Date().toLocaleString();\r\n        }\r\n\r\n        var wait = self.getLoadingIndicator().addWait();\r\n\r\n        duringTrackingToolsPanel.call(self);\r\n\r\n        self.wrap.addWaypoint(self.currentPoint.position, {\r\n            name: waypointName,\r\n            ele: self.currentPoint.heading,\r\n            time: new Date().getTime() // GLS: lo quito ya que hemos actualizado la función que gestiona la fechas para la exportación a GPX - espera la fecha en segundos -> / 1000 // para la exportación a GPX - espera la fecha en segundos\r\n        });\r\n\r\n        self.track.trackWPT.value = '';\r\n        self.track.trackWPT.disabled = true;\r\n        self.track.trackAdd.disabled = true;\r\n\r\n        // cada vez que se añade un waypoint almacenamos en sessionStorage\r\n        TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, self.wrap.formattedToStorage(self.layerTracking).features);\r\n\r\n        self.getLoadingIndicator().removeWait(wait);\r\n    };\r\n\r\n    ctlProto.editTrackName = function (trackId, newName) {\r\n        var self = this;\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n            if (tracks) {\r\n                if (tracks[trackId]) {\r\n                    tracks[trackId].name = newName;\r\n\r\n                    self.setStoredTracks(tracks);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.removeTrack = function (li) {\r\n        var self = this;\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n            if (tracks) {\r\n                var dataId = li.dataset.id;\r\n                if (tracks[dataId]) {\r\n                    var uid = tracks[dataId].uid;\r\n\r\n                    TC.confirm(self.getLocaleString(\"geo.trk.delete.alert\"), function () {\r\n\r\n                        const selectedTrack = self.getSelectedTrack();\r\n                        if (selectedTrack && selectedTrack.dataset.id === dataId) {\r\n                            self.clear(self.Const.Layers.TRACK);\r\n                        }\r\n\r\n                        localforage.removeItem(self.Const.LocalStorageKey.TRACKING + '#' + uid).then(function () {\r\n                            self.getStoredTracks().then(function () {\r\n                                self.bindTracks();\r\n                            });\r\n                        }).catch(function (err) {\r\n                            console.log(err);\r\n                        });\r\n\r\n                    }, function () { });\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.setSelectedTrack = function (li) {\r\n        var self = this;\r\n\r\n        if (!self.isActive) {\r\n            self.activate();\r\n        }\r\n\r\n        self.track.trackList.querySelectorAll('li[data-id] > span').forEach(function (span) {\r\n            span.setAttribute('title', span.textContent);\r\n        });\r\n        self.track.trackList.querySelectorAll('li').forEach(function (li) {\r\n            li.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n        });\r\n\r\n        li.classList.add(self.Const.Classes.SELECTEDTRACK);\r\n\r\n        li.setAttribute('title', self.getLocaleString(\"tr.lst.clear\") + \" \" + li.querySelector('span').textContent);\r\n        li.querySelector(self.Const.Selector.DRAW).setAttribute('title', li.getAttribute('title'));\r\n    };\r\n\r\n    ctlProto.getSelectedTrack = function () {\r\n        var self = this;\r\n\r\n        return self.track.trackList.querySelector('li.' + self.Const.Classes.SELECTEDTRACK);\r\n    };\r\n\r\n    ctlProto.clearSelectedTrack = function () {\r\n        const self = this;\r\n\r\n        const selected = self.getSelectedTrack();\r\n        if (selected) {\r\n\r\n            if (self.onResize) {\r\n                window.removeEventListener('resize', self.onResize, false);\r\n                self.onResize = undefined;\r\n            }\r\n\r\n            selected.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n            selected.setAttribute('title', selected.textContent);\r\n            selected.querySelector(self.Const.Selector.DRAW).setAttribute('title', selected.getAttribute('title'));\r\n        }\r\n    };\r\n\r\n    ctlProto.clearSelection = function () {\r\n        var self = this;\r\n        self.wrap.deactivateSnapping();\r\n        var selected = self.getSelectedTrack();\r\n        if (selected) {\r\n            self.clearSelectedTrack();\r\n        }\r\n        if (self.resultsPanelChart) {\r\n\r\n            self.resultsPanelChart.div.removeEventListener('mouseover', self.resultsPanelChart.deactivateSnapping);\r\n            self.resultsPanelChart.div.removeEventListener('mouseout', self.resultsPanelChart.activateSnapping);\r\n\r\n            self.resultsPanelChart.close();\r\n        }\r\n\r\n        self.clear(self.Const.Layers.TRACK);\r\n    };\r\n\r\n    ctlProto.drawTrackingData = function (li) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            self.wrap.clear();\r\n\r\n            self.getTrackingData(li).then(function (track) {\r\n                var data = track.data;\r\n                if (track.data)\r\n                    self.wrap.drawTrackingData(track).then(function () {\r\n                        var showFeatures = self.layerTrack.features;\r\n                        if (showFeatures && showFeatures.length > 0) {\r\n\r\n                            var coordinates = showFeatures.filter(function (feature) {\r\n                                feature.showsPopup = false;\r\n                                if (TC.feature.MultiPolyline && feature instanceof TC.feature.MultiPolyline) {\r\n                                    return true;\r\n                                } else if (feature instanceof TC.feature.Polyline) {\r\n                                    return true;\r\n                                }\r\n                                return false;\r\n                            }).map(function (feature) {\r\n                                if (TC.feature.MultiPolyline && feature instanceof TC.feature.MultiPolyline) {\r\n                                    return feature.geometry[0];\r\n                                } else if (feature instanceof TC.feature.Polyline) {\r\n                                    return feature.geometry;\r\n                                }\r\n                            })[0];\r\n\r\n                            if (coordinates) {\r\n                                var first = coordinates[0];\r\n                                var last = coordinates[coordinates.length - 1];\r\n\r\n                                if (first && !(first === last)) {\r\n                                    self.layerTrack.addMarker(first.slice().splice(0, 2), {\r\n                                        showsPopup: false, cssClass: self.CLASS + '-track-marker-icon-end', anchor: [0.5, 1], notExport: true\r\n                                    });\r\n                                }\r\n\r\n                                if (last) {\r\n                                    self.layerTrack.addMarker(last.slice().splice(0, 2), {\r\n                                        showsPopup: false, cssClass: self.CLASS + '-track-marker-icon', anchor: [0.5, 1], notExport: true\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                        self.layerTrack.setVisibility(true);\r\n                        resolve();\r\n                    });\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.getTrackingData = function (li) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            self.getAvailableTracks().then(function (tracks) {\r\n                if (tracks) {\r\n                    const dataId = li.dataset.id;\r\n                    if (tracks[dataId]) {\r\n                        var track = tracks[dataId].data;\r\n\r\n                        // GLS: tengo que transformar de 4326 al crs del mapa en el momento de pintar, porque si lo hacemos al cargar la lista\r\n                        // y después hay cambio de crs, en el momento de pintar no sé desde qué crs debo tranformar\r\n                        track = self.wrap.formattedFromStorage(track);\r\n\r\n                        resolve({ data: track, layout: tracks[dataId].layout });\r\n                    }\r\n                } else {\r\n                    resolve();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.export = function (li) {\r\n        var self = this;\r\n        return self.wrap.export(li);\r\n    };\r\n\r\n    ctlProto.getElevationTooltip = function (d) {\r\n        const self = this;\r\n        self.wrap.showElevationMarker(d);\r\n\r\n        return self.resultsPanelChart.getElevationChartTooltip(d);\r\n    };\r\n\r\n    ctlProto.removeElevationTooltip = function () {\r\n        var self = this;\r\n        self.wrap.hideElevationMarker();\r\n    }\r\n\r\n    ctlProto.clearFileInput = function (fileInput) {\r\n        const form = document.createElement('form');\r\n        const parent = fileInput.parentElement;\r\n        parent.insertBefore(form, fileInput);\r\n        form.appendChild(fileInput);\r\n        form.reset();\r\n        // Desenvolvemos el input del form\r\n        form.insertAdjacentElement('afterend', fileInput);\r\n        parent.removeChild(form);\r\n    };\r\n\r\n    ctlProto.getLoadingIndicator = function () {\r\n        var self = this;\r\n\r\n        if (!self.loading) {\r\n            self.loading = self.map.getControlsByClass(TC.control.LoadingIndicator);\r\n            if (self.loading && self.loading.length > 0)\r\n                self.loading = self.loading[0];\r\n        }\r\n\r\n        return self.loading;\r\n    };\r\n\r\n    ctlProto.onGeolocateError = function (error) {\r\n        var self = this;\r\n\r\n        if (navigator.geolocation) {\r\n            if (self.currentPosition)\r\n                navigator.geolocation.clearWatch(self.currentPosition);\r\n            if (self.currentPositionTrk) {\r\n                self.currentPositionTrk = self.currentPositionTrk instanceof Array ? self.currentPositionTrk : [self.currentPositionTrk];\r\n\r\n                self.currentPositionTrk.forEach(function (watch) {\r\n                    navigator.geolocation.clearWatch(watch);\r\n                });\r\n\r\n                self.currentPositionTrk = [];\r\n            }\r\n        }\r\n\r\n        if (self.currentPositionWaiting)\r\n            self.getLoadingIndicator().removeWait(self.currentPositionWaiting);\r\n\r\n        var errorMsg;\r\n        switch (error.code) {\r\n            case error.PERMISSION_DENIED:\r\n                errorMsg = self.getLocaleString(\"geo.error.permission_denied\");\r\n                break;\r\n            case error.POSITION_UNAVAILABLE:\r\n                errorMsg = self.getLocaleString(\"geo.error.position_unavailable\");\r\n                break;\r\n            case error.TIMEOUT:\r\n                errorMsg = self.getLocaleString(\"geo.error.timeout\");\r\n                break;\r\n            default:\r\n                errorMsg = self.getLocaleString(\"geo.error.default\");\r\n                break;\r\n        }\r\n\r\n        self.map.toast(errorMsg, { type: TC.Consts.msgType.WARNING });\r\n\r\n        if (!self.geopositionTracking && self.track) {\r\n            self.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n            self.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n    var _isEmpty = function (obj) {\r\n        return !obj || obj.length === 0;\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState) {\r\n            const state = {};\r\n            if (self.layerTrack) {\r\n                var features = self.layerTrack.features;\r\n\r\n                if (features.length > 0 && self.featuresToShare && self.featuresToShare.length > 0) {\r\n                    state.features = self.featuresToShare;\r\n                } else {\r\n                    const layerState = self.layerTrack.exportState({\r\n                        features: features\r\n                    });\r\n\r\n                    state.features = layerState.features;\r\n                }\r\n\r\n                state.id = self.id;\r\n                const selectedTrack = self.getSelectedTrack();\r\n                if (selectedTrack) {\r\n                    state.trackName = selectedTrack.querySelector('span').innerHTML;\r\n                }\r\n                return state;\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        if (self.map) {\r\n            if (state.features && state.features.length) {\r\n                self.enable();\r\n\r\n                if (state.features.length > 0) {\r\n                    const promises = new Array(state.features.length);\r\n                    state.features.forEach(function (f, idx) {\r\n                        const featureOptions = { data: f.data, id: f.id, showsPopup: f.showsPopup };\r\n                        var addFn;\r\n                        var geom = TC.Util.explodeGeometry(f.geom);\r\n                        switch (f.type) {\r\n                            case TC.Consts.geom.POLYLINE:\r\n                                promises[idx] = new TC.feature.Polyline(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.MULTIPOLYLINE:\r\n                                promises[idx] = new TC.feature.MultiPolyline(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.MARKER:\r\n                                promises[idx] = new TC.feature.Marker(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.POINT:\r\n                                promises[idx] = new TC.feature.Point(geom, featureOptions);\r\n                                break;\r\n                        }\r\n                    });\r\n\r\n                    Promise.all(promises).then(function (tcFeatures) {\r\n                        var options = { features: tcFeatures, fileName: state.trackName, notReproject: true, isShared: true };\r\n                        if (!self.availableTracks) {\r\n                            self.getStoredTracks().then(function () {\r\n                                self.importTrack(options);\r\n                            });\r\n                        } else {\r\n                            self.importTrack(options);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.getDownloadDialog = function () {\r\n        const self = this;\r\n        if (self._downloadDialog) {\r\n            return Promise.resolve(self._downloadDialog);\r\n        }\r\n        return new Promise(function (resolve, reject) {\r\n            self.map.addControl('FeatureDownloadDialog').then(ctl => {\r\n                self._downloadDialog = ctl;\r\n                resolve(ctl);\r\n            })\r\n        });\r\n    };\r\n})();"]}