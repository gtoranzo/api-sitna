{"version":3,"sources":["Control/Search.js"],"names":["window","performance","now","offset","Date","this","TC","control","Control","syncLoadJS","apiLocation","SearchType","type","options","parent","self","_featureTypes","$","extend","typeName","_throwConfigError","Error","getFeatureTypes","toFilter","featureType","Array","length","type_featureType","type_renderFeatureType","renderFeatureType","concat","isFeatureOfThisType","id","indexOf","getStyleByFeatureType","styles","getColor","css","geomType","getValue","style","hasOwnProperty","i","color","getSuggestionListHead","headerData","label","suggestionListHead","title","getLocaleString","call","featureTypes","map","elm","liHTML","join","getSuggestionListElements","data","results","areSame","a","b","isNaN","trim","getUnique","inputArray","outputArray","jQuery","inArray","push","parseFeatures","forEach","feature","attributes","ids","valueToAdd","properties","outputProperties","dataIdProperties","dataIdProperty","strFormat","outputFormatLabel","dataLayer","split","slice","shift","j","compareData","p","tcFormat","text","toCamelCase","r","isThere","property","filter","dataRole","outputFormat","Consts","format","JSON","wrap","parser","WFS","featureNS","featurePrefix","read","getPattern","pattern","bindRootFilterNode","filtersArr","dataT","rootFilters","rootCfg","active","root","limit","item","getFilterNode","filterNode","queryProperties","firstQueryWord","queryWord","index","_LIKE_PATTERN","getPropertyValue","role","propertyName","getSearchTypeByRole","getIsLikeNode","name","value","toEscape","test","replace","toString","toLowerCase","toUpperCase","getFunctionStrMatches","propertyValue","fn","filterByMatch","regex","RegExp","_MATCH_PATTERN","f","key","propName","getFilter","multiL","searchType","NUMBER","_f","exec","t","s","secondQueryWord","match","substring","thirdQueryWord","STREET","LOCALITY","getParams","filters","params","REQUEST","SERVICE","MAXFEATURES","VERSION","version","OUTPUTFORMAT","ft","TYPENAME","_getProperties","Object","prop","_properties","_ids","PROPERTYNAME","FILTER","param","getGoToFilter","props","_id","source","src","transformFilter","equalTo","comparison","EQUAL_TO","and","apply","Search","arguments","exportsState","event","TOOLSCLOSE","url","UTMX","UTMY","LON","LAT","UTMX_LABEL","UTMY_LABEL","LON_LABEL","LAT_LABEL","MUN","POL","PAR","MUN_LABEL","POL_LABEL","PAR_LABEL","availableSearchTypes","CADASTRAL","suggestionRoot","geometryName","searchWeight","municipality","labelProperty","idProperty","CATAST_Pol_ParcelaUrba","CATAST_Pol_ParcelaRusti","CATAST_Pol_ParcelaMixta","polygon","fillColor","fillOpacity","strokeColor","strokeWidth","strokeOpacity","getCadastralRef","goTo","goToCadastralRef","goToIdFormat","idPropertiesIdentifier","COORDINATES","getCoordinates","goToCoordinates","QUERYWORD","FIRST","SECOND","THIRD","MUNICIPALITY","getStringPattern","bind","stringPatternToCheck","stringPatternsValidators","s_or_t","goToStringPattern","COUNCIL","line","strokeLinecap","strokeDashstyle","point","angle","fontColor","fontSize","fontWeight","labelOutlineColor","labelOutlineWidth","radius","URBAN","PLACENAME","PLACENAMEMUNICIPALITY","COMMONWEALTH","ROAD","getRoad","goToRoad","ROADPK","getPK","goToPK","getRootLabel","Promise","resolve","reject","rootLabel","CQL_FILTER","elem","ajax","method","responseType","mimeType","then","totalFeatures","features","catch","allowedSearchTypes","allowed","isEmptyObject","rootType","addAllowedSearchType","queryableFeatures","UTMX_LEN","UTMY_LEN","interval","NORMAL_PATTERNS","ROMAN_NUMBER","ABSOLUTE_NOT_DOT","ABSOLUTE","inherit","ctlProto","prototype","CLASS","SEARCHQUERYEMPTY","isDebug","template","dust","register","body_0","chk","ctx","w","h","$key","__dustBody","result","_search","layerStyleFN","getFeatureType","idFeature","getStyle","getSearchTypeByFeature","Cfg","extractValue","Feature","trigger","FEATURESADD","layer","geom","values","getData","styleFN","layerPromise","addLayer","getUID","stealth","declutter","layerType","VECTOR","marker","anchor","Defaults","height","width","EMPTY_RESULTS_LABEL","EMPTY_RESULTS_TITLE","OUTBBX_LABEL","WFS_TYPE_ATTRS","renderData","callback","search","textInput","list","_goToResult","resultsList","querySelector","getAttribute","classList","add","classes","HIDDEN","_research","textContent","lastPattern","unescape","div","placeHolder","setAttribute","$list","button","addEventListener","CLICK","getLayer","l","querySelectorAll","zoomToFeatures","dispatchEvent","Event","instructions","EventTarget","listenerBySelector","focus","contains","e","setTimeout","which","preventDefault","stopPropagation","remove","retryTimeout","loadJS","UI","autocomplete","searchDelay","link","target","minLength","lastpress","requestAnimationFrame","step","criteria","cancelAnimationFrame","undefined","_target","tagName","el","selector","matchesSelector","matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector","parentElement","closest","parentNode","buildHTML","html","dataRoles","reA","reN","sortAlphaNum","AInt","parseInt","BInt","aA","bA","aN","bN","sort","sort_","aRoot","bRoot","first","highlighting","strReg","normalizedLastPattern","querys","separatorChar","q","_strReg","st","rex","encodeURIComponent","onKeydown","ctrlKey","altKey","shiftKey","keyCode","document","activeElement","sibling","nextElementSibling","getNextSibling","previousElementSibling","getPreviousSibling","isFunction","getElementOnSuggestionList","getFeatures","cleanMap","clearFeatures","FEATUREREMOVE","getMunicipalities","cache","_municipalitiesPromise","municipalities","coords","Util","parseCoords","xValue","yValue","xLabel","UTM","yLabel","getPoint","insideLimit","crs","getLabel","_pattern","matcher","getItem","mun","munLabel","pol","par","grep","removePunctuation","tsp","getPortal","formatStreetNumber","bindRoot","spt","tnsp","ts","reverse","getStreet","revS","fs","si","_criteria","isPortal","c","x","_cr","inPortal","criteriaRev","chs","sp","snp","isCheck","check","m","ch","addRoot","indicatedRoot","newResult","splice","getObjectsFromStringToQuery","allowedRoles","charAt","tests","ex","error","msgErrorMode","EMAIL","getResultsFromWFS","objectsToQuery","request","keys","doneCallback","innerHTML","CustomEvent","statusText","alert","all","combinedCriteria","bothSearchObjects","some","outputProperty","console","log","waiting","_a","_b","loading","getControlsByClass","wait","addWait","Modernizr","mq","blur","customSearchType","keepOnLooping","dr","removeWait","on","showsPopup","refresh","one","LAYERUPDATE","getSource","bounds","getExtent","pointBoundsRadius","setExtent","ZOOMTO","extent","inner","emptyResultHTML","newData","goToResult","promise","addMarker","group","feat","maxFeatures","isMapGeo","isGeo","parseFloat","reproject","utmCrs","geoCrs","getIntersectsBounds","maxExtent","locale","getMapLocale","toLocaleString","localeDecimalSeparator","Number","isInteger","á","à","Á","À","é","è","É","È","í","ì","Í","Ì","ó","ò","Ó","Ò","ú","ù","ü","Ú","Ù","Ü","len","exportState","searchText","exportStyles","importState","state","setStyle","String","args","number","splitRemoveWhiteSpaces","separator","_arr","arr","_value","defineProperty","enumerable","writable","endsWith","searchString","position","subjectString","isFinite","Math","floor","lastIndex"],"mappings":"CAAE,WAEE,GAAKA,OAAOC,aAOL,GAAID,OAAOC,cAAgBD,OAAOC,YAAYC,IAAK,CACtDF,OAAOC,YAAYE,OAASC,KAAKF,MACjCF,OAAOC,YAAYC,IAAM,WACrB,OAAOE,KAAKF,MAAQF,OAAOC,YAAYE,cAT3CH,OAAOC,aACHE,OAAQC,KAAKF,MACbA,IAAK,WACD,OAAOE,KAAKF,MAAQG,KAAKF,SANxC,GAiBDG,GAAGC,QAAUD,GAAGC,YAEXD,GAAGE,SACJF,GAAGG,WAAWH,GAAGI,YAAc,cAInC,IAAIC,WAAa,SAAUC,EAAMC,EAASC,GACtC,IAAIC,EAAOV,KAEXU,EAAKD,OAASA,EAEdC,EAAKC,iBAELC,EAAEC,OAAOH,EAAMF,GAEfE,EAAKI,SAAWP,EAEhBG,EAAKK,kBAAoB,WAGrB,MAAM,IAAIC,MAAM,mDAFLhB,KAEyDc,WAGxEJ,EAAKO,gBAAkB,SAAUC,GAG7B,GAAIA,EACA,OAHOlB,KAGKmB,uBAAuBC,MAH5BpB,KAGyCmB,aAHzCnB,KAG6DmB,aAGxE,GAAkC,IANvBnB,KAMFW,cAAcU,OAAc,CACjC,IAAIC,EAPGtB,KAOqBmB,uBAAuBC,MAP5CpB,KAOyDmB,aAPzDnB,KAO6EmB,aAChFI,EARGvB,KAQ2BwB,kBAR3BxB,KAQoDwB,6BAA6BJ,MARjFpB,KAQ8FwB,mBAR9FxB,KAQwHwB,sBARxHxB,KASFW,cAAgBW,EAAiBG,OAAOF,GAGjD,OAZWvB,KAYCW,eAGhBD,EAAKgB,oBAAsB,SAAUC,GAGjC,OAFW3B,KAECiB,kBAAkBW,QAAQD,IAAO,GAGjDjB,EAAKmB,sBAAwB,SAAUV,GAGnC,OAFWnB,KAEFiB,kBAAkBW,QAAQT,IAAgB,EAFxCnB,KAGK8B,OAHL9B,KAGiBiB,kBAAkBW,QAAQT,IAG/C,MAGX,IAAIY,EAAW,SAAUC,EAAKC,EAAUd,GACpC,IAEIe,EAAW,SAAUC,EAAOF,EAAUD,GACtC,GAAIC,GACA,GAAIE,EAAMC,eAAeH,IAAaE,EAAMF,GAAUG,eAAeJ,GACjE,OAAOG,EAAMF,GAAUD,QAG3B,IAAK,IAAIC,KAAYE,EACjB,GAAIA,EAAMF,GAAUG,eAAeJ,GAC/B,OAAOG,EAAMF,GAAUD,IAMvC,GAAIb,EAAa,CAEb,OAAOe,EAlBAlC,KAiBU6B,sBAAsBV,GAChBc,EAAUD,GAEjC,IAAK,IAAIK,EAAI,EAAGA,EApBTrC,KAoBkB8B,OAAOT,OAAQgB,IAAK,CACzC,IACIC,EAAQJ,EAtBTlC,KAqBc8B,OAAOO,GACIJ,EAAUD,GACtC,GAAIM,EACA,OAAOA,IAMvB5B,EAAK6B,sBAAwB,WACzB,IAEIC,EAAYC,EAAOH,EAFnB5B,EAAOV,KAIX,GAAuC,mBAA5BU,EAAKgC,mBAAmC,CAC/CF,EAAa9B,EAAKgC,qBAClBD,EAAQD,EAAWC,MACnBH,IACIA,MAAOE,EAAWF,MAClBK,MAAOH,EAAWC,YAEnB,CACHD,EAAa9B,EAAKgC,mBAClBD,EAAQ/B,EAAKD,OAAOmC,gBAAgBJ,EAAWC,OAG/C,GAAgC,iBAArBD,EAAWF,MAClBA,IACIA,MAAOP,EAASc,KAAKnC,EAAM8B,EAAWF,OACtCK,MAAOF,SAER,GAAID,EAAWF,iBAAiBlB,MAAO,CAC1C,IAAI0B,EAAepC,EAAKO,kBACpBuB,EAAWF,MAAMjB,SAAWyB,EAAazB,OACzCiB,EAAQE,EAAWF,MAAMS,IAAI,SAAUC,EAAKX,GACxC,OACIC,MAAOP,EAASc,KAAKnC,EAAMsC,EAAIF,EAAaT,IAAIC,MAAMN,IAAKgB,EAAIF,EAAaT,IAAIC,MAAML,SAAUa,EAAaT,IAC7GM,MAAOjC,EAAKD,OAAOmC,gBAAgBI,EAAIF,EAAaT,IAAIM,QAAUF,KAI1E/B,EAAKK,wBAE0B,iBAArByB,EAAWF,QACzBA,IACIA,MAAOP,EAASc,KAAKnC,EAAM8B,EAAWF,MAAMN,IAAKQ,EAAWF,MAAML,UAClEU,MAAOF,KAKnB,GAAIA,GAASH,EAAO,CAChB,IAAIW,EAAS,mCAAqCR,EAAQ,UAQ1D,OANAQ,GAAUX,EAAMS,IAAI,SAAUC,GAC1B,GAAIA,EAAIV,MACJ,MAAO,qCAAuCU,EAAIL,MAAQ,mBAAqBK,EAAIV,MAAQ,eAEhGY,KAAK,IAAM,QAKdxC,EAAKK,qBAIbL,EAAKyC,0BAA4B,SAAUC,GACvC,IAAI1C,EAAOV,KACPqD,KAEAC,EAAU,SAAUC,EAAGC,GACvB,QAAQ,GACJ,IAAoB,iBAAR,EACR,GAAID,IAAMC,EACN,OAAO,EAEX,MACJ,IAAoB,iBAAR,EACR,GAAKC,MAAMF,IAAOE,MAAMD,IAKpB,GAAID,EAAEG,SAAWF,EAAEE,OACf,OAAO,OALX,GAAIH,IAAMC,EACN,OAAO,EAUvB,OAAO,GAEPG,EAAY,SAAUC,GAEtB,IADA,IAAIC,KACKxB,EAAI,EAAGA,EAAIuB,EAAWvC,OAAQgB,KACkB,GAAhDyB,OAAOC,QAAQH,EAAWvB,GAAIwB,IAC/BA,EAAYG,KAAKJ,EAAWvB,IAIpC,OAAOwB,GAmBInD,EAAKuD,cAAcb,GAEzBc,QAAQ,SAAUC,GACvB,IAAIC,KAAiBC,KACjBC,EAAa,GAEbC,EAAa7D,EAAK8D,iBAClBC,EAAmB/D,EAAKgE,eAExBC,EAAYjE,EAAKkE,kBACjBC,EAAYV,EAAQxC,GAAGmD,MAAM,KAAKC,MAAM,EAAG,GAAGC,QAElD,KAAMtE,EAAK8D,4BAA4BpD,OAAQ,CAC3CmD,EAAa7D,EAAK8D,iBAAiBK,GACnCJ,EAAmB/D,EAAKgE,eAAeG,GACvCF,EAAYA,EAAUE,GAG1B,IAAK,IAAII,EAAI,EAAGA,EAAIV,EAAWlD,OAAQ4D,IACnCb,EAAWJ,KAAKG,EAAQf,KAAKmB,EAAWU,KAG5C,IAASA,EAAI,EAAGA,EAAIR,EAAiBpD,OAAQ4D,IACzCZ,EAAIL,KAAKG,EAAQf,KAAKqB,EAAiBQ,KAI3C,IADA,IAAIC,KACKC,EAAI,EAAGA,EAAIzE,EAAK8D,iBAAiBnD,OAAQ8D,IAC9CD,EAAYxE,EAAK8D,iBAAiBW,IAAMf,EAAWe,GAGnDf,aAAsBhD,OAASuD,GAAahB,EAAUS,GAAY/C,OAAS,EAC3EiD,EAAaK,EAAUS,SAAShB,GAE3BA,aAAsBhD,OAAyC,GAAhCuC,EAAUS,GAAY/C,SAC1DiD,EAAaF,EAAW,IAG5B,IAAIiB,EAAOf,EAAWgB,eAvDR,SAAUJ,GACxB,IAAK,IAAIK,EAAI,EAAGA,EAAIlC,EAAQhC,OAAQkE,IAAK,CACrC,IAAIlE,EAAS,EACTmE,KACJ,IAAK,IAAIC,KAAYP,EAAa,CAC9BM,EAAQxB,KAAKV,EAAQ4B,EAAYO,GAAWpC,EAAQkC,GAAGhB,WAAWkB,KAClEpE,IAEJ,GAAImE,EAAQE,OAAO,SAAUrD,GAAK,OAAOA,IAAMhB,SAAWA,EACtD,OAAO,EAKf,OAAO,GA2CF,CAAa6D,IAEd7B,EAAQW,MACJqB,KAAMA,EACN5C,MAAO4C,EACP1D,GAAI0C,EAAInB,KAAK,KACbyC,SAAUjF,EAAKI,SACf+D,UAAWA,EACXN,WAAYW,MAKxB,OAAO7B,GAGX3C,EAAKuD,cAAgB,SAAUb,GAW3B,OATI1C,EAAKkF,eAAiB3F,GAAG4F,OAAOC,OAAOC,KAC9B,IAAI9F,GAAG+F,KAAKC,OAAOF,KAGnB,IAAI9F,GAAG+F,KAAKC,OAAOC,KACxBC,UAAWzF,EAAK0F,cAChBjF,YAAaT,EAAKS,eAGZkF,KAAKjD,IAGvB1C,EAAK4F,WAAa,WAGd,MAA4B,mBAFjBtG,KAEKuG,QAFLvG,KAGKuG,UAHLvG,KAKKuG,SAIpB7F,EAAKgF,OAAS,SAAWhF,GAErB,MAAM8F,EAAqB,SAAUC,EAAYC,GAC7C,IAAIC,KAEJ,GAAID,GAAShG,EAAKD,OAAOmG,QAAQC,OAAOC,KAEpC,IAA4B,IAAxBJ,EAAM9E,QAAQ,MAAgBlB,EAAKD,OAAOmG,QAAQC,OAAOE,MAiBzD,IAFA,IAAIC,EAAON,EAAM5B,MAAM,KAEdG,EAAI,EAAGA,EAAIvE,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAerD,OAAQ4D,IAAK,CAE9D,GAALA,GAAUvE,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAerD,OAAS,GAC7DsF,EAAY3C,KAAK,aAGrB2C,EAAY3C,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAeO,GAAI+B,EAAK3F,OAAS4D,EAAI+B,EAAK/B,GAAK+B,EAAK,KAEtH/B,GAAKvE,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAerD,OAAS,GAAKX,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAerD,OAAS,GAChHsF,EAAY3C,KAAK,kBA1BuC,CAEhE,IAAIkD,EAAaxG,EAAKD,OAAOmG,QAAQC,OAAOM,gBAAgBC,eAAerE,IAAI,SAAUsE,EAAWC,GAChG,OAAO5G,EAAKgF,OAAOuB,cAAcI,EAAW3G,EAAKD,OAAO8G,cAAgBb,EAAQhG,EAAKD,OAAO8G,iBAGhG,GAAIL,EAAW7F,OAAS,EAAG,CACvBsF,EAAY3C,KAAK,cACjB2C,EAAcA,EAAYlF,OAAOyF,IACrBlD,KAAK,mBAEjB2C,EAAcA,EAAYlF,OAAOyF,OAmBtC,CACH,IAAK,IAAI7E,EAAI,EAAGA,EAAI3B,EAAKD,OAAOmG,QAAQC,OAAOC,KAAKzF,OAAQgB,IAAK,CACzD2E,EAAOtG,EAAKD,OAAOmG,QAAQC,OAAOC,KAAKzE,GAElC,GAALA,GAAU3B,EAAKD,OAAOmG,QAAQC,OAAOC,KAAKzF,OAAS,GACnDsF,EAAY3C,KAAK,YAGrB,IAASiB,EAAI,EAAGA,EAAIvE,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAerD,OAAQ4D,IAAK,CAE9D,GAALA,GAAUvE,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAerD,OAAS,GAC7DsF,EAAY3C,KAAK,aAGrB2C,EAAY3C,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAeO,GAAI+B,EAAK3F,OAAS4D,EAAI+B,EAAK/B,GAAK+B,EAAK,KAEtH/B,GAAKvE,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAerD,OAAS,GAAKX,EAAKD,OAAOmG,QAAQC,OAAOnC,eAAerD,OAAS,GAChHsF,EAAY3C,KAAK,eAKzBtD,EAAKD,OAAOmG,QAAQC,OAAOC,KAAKzF,OAAS,GACzCsF,EAAY3C,KAAK,aAIzB,OAAOyC,EAAWhF,OAAOkF,IAG7B,OACIa,iBAAkB,SAAUC,EAAMC,GAC9B,OAAOhH,EAAKiH,oBAAoBF,GAAMC,IAE1CE,cAAe,SAAUC,EAAMC,GAC3B,IAAIC,EAAW,wBACXA,EAASC,KAAKF,KACdA,EAAQA,EAAMG,QAAQF,EAAU,SAGpC,OAAID,EAAMI,WAAWtG,QAAQlB,EAAKD,OAAO8G,gBAAkB,EAChD,+FACgBM,EAAO,2BACZC,EAAMK,cAAcF,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,sHAGjEJ,EAAO,2BACZC,EAAMM,cAAcH,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,mCAGjF,oCACgBJ,EAAO,2BACZC,EAAMG,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,kCAGlFI,sBAAuB,SAAUR,EAAMC,GACnC,IAAIC,EAAW,sBACXA,EAASC,KAAKF,KACdA,EAAQA,EAAMG,QAAQF,EAAU,SAGpC,GAAID,EAAMI,WAAWtG,QAAQlB,EAAKD,OAAO8G,gBAAkB,EAAG,CAE1D,IAAIhB,EAAUuB,EAOd,MAAO,8EAEoBD,EAAO,yCAJlCtB,GADAA,GADAA,GADAA,GADAA,EAAUA,EAAQ0B,QAAQ,MAAO,gBACfA,QAAQ,MAAO,gBACfA,QAAQ,MAAO,gBACfA,QAAQ,MAAO,gBACfA,QAAQ,MAAO,oBAKMA,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,0FAMzF,MAAO,oCACgBJ,EAAO,2BACZC,EAAMG,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,kCAIlFhB,cAAe,SAAUS,EAAcY,GACnC,IAAI/C,EAEAgD,EAAK7H,EAAKgF,OAAOkC,cAErB,GAAIlH,EAAK8H,cAAe,CAEpBD,EAAK7H,EAAKgF,OAAO2C,sBAEjB,IAAII,EAAQ,IAAIC,OAAO,KAAOhI,EAAKD,OAAO8G,cAAe,MACzDe,EAAgBA,EAAcL,QAAQQ,EAAO/H,EAAKD,OAAOkI,gBAG7D,GAAMjB,aAAwBtG,OAAmC,iBAAjBsG,EAwBzC,CAAA,GAAIA,aAAwBtG,OAASsG,EAAarG,OAAS,EAAG,CACjEkE,EAAI,WACJ,IAASlD,EAAI,EAAGA,EAAIqF,EAAarG,OAAQgB,IACrCkD,GAAKgD,EAAGb,EAAarF,GAAGqB,OAAQ4E,GAGpC,OAAO/C,EAAK,YAEZ,OAAOgD,EAAIb,aAAwBtG,OAAiC,IAAxBsG,EAAarG,OAAeqG,EAAa,GAAGhE,OAASgE,EAAahE,OAAS4E,GA/BvH,IAAIM,KACJ,IAAK,IAAIC,KAAOnB,EACZ,GAAKA,EAAamB,aAAgBzH,OAAUsG,EAAamB,GAAKxH,OAAS,EAAG,CACtEkE,EAAI,OACJ,IAAK,IAAIlD,EAAI,EAAGA,EAAIqF,EAAamB,GAAKxH,OAAQgB,IAC1CkD,GAAKgD,EAAGb,EAAamB,GAAKxG,GAAGqB,OAAQ4E,GAGzC/C,GAAK,QACLqD,EAAE5E,KAAK,+CAAiDuB,EAAI,kBACzD,CACH,IAAIuD,EAAWpB,EAAamB,GACvBnB,EAAamB,aAAgBzH,OAAsC,GAA5BsG,EAAamB,GAAKxH,SAC1DyH,EAAWpB,EAAamB,GAAK,IAEjCD,EAAE5E,KAAK,mDACMuE,EAAGO,EAASpF,OAAQ4E,GAAiB,mBAK1D,OAAOM,EAAE1F,KAAK,KAYtB6F,UAAW,SAAU3F,GACjB,IAAImC,GACJyD,QAAW,EACXJ,EAAM,IAIN,QAAQ,GACJ,KAAKlI,EAAKI,WAAab,GAAG4F,OAAOoD,WAAWC,OACxCC,KACA,GAAMzI,EAAKD,OAAOmG,QAAc,SAAM,iBAAiBwC,KAAKhG,EAAKiG,KAAM,iBAAiBD,KAAKhG,EAAKkG,GAmB7F,CACG5I,EAAKD,OAAOmG,QAAQC,OACpBsC,EAAK3C,EAAmB2C,EAAI/F,EAAKiG,GAEjCF,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBC,eAAgB1G,EAAKD,OAAO8G,cAAgBnE,EAAKiG,EAAI3I,EAAKD,OAAO8G,gBAE5H4B,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBoC,gBAAiB7I,EAAKD,OAAO8G,cAAgBnE,EAAKkG,EAAI5I,EAAKD,OAAO8G,oBAzBtB,EAC/FiC,EAAQ,iBAAiBJ,KAAKhG,EAAKiG,IAGnCF,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBC,eAAgB1G,EAAKD,OAAO8G,cAAgBnE,EAAKiG,EAAEI,UAAU,EAAGrG,EAAKiG,EAAEzH,QAAQ4H,EAAM,KAAK9F,OAAShD,EAAKD,OAAO8G,gBAElK7G,EAAKD,OAAOmG,QAAQC,OACpBsC,EAAK3C,EAAmB2C,EAAI/F,EAAKiG,GAGjCF,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBC,eAAgB1G,EAAKD,OAAO8G,cAAgBnE,EAAKiG,EAAI3I,EAAKD,OAAO8G,iBAIhIiC,EAAQ,iBAAiBJ,KAAKhG,EAAKkG,IAE/BH,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBoC,gBAAiB7I,EAAKD,OAAO8G,cAAgBnE,EAAKkG,EAAEG,UAAU,EAAGrG,EAAKkG,EAAE1H,QAAQ4H,EAAM,KAAK9F,OAAShD,EAAKD,OAAO8G,gBACtK4B,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBoC,gBAAiB7I,EAAKD,OAAO8G,cAAgBnE,EAAKkG,EAAI5I,EAAKD,OAAO8G,gBAWlI4B,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBuC,eAAgBtG,EAAK+B,EAAIzE,EAAKD,OAAO8G,gBAE5FhC,EAAEqD,EAAI,+DAAsEO,EAAGjG,KAAK,IAAM,0BAE1F,MACJ,KAAKxC,EAAKI,WAAab,GAAG4F,OAAOoD,WAAWU,OACxCR,KAEA,GAAMzI,EAAKD,OAAOmG,QAAc,SAAM,iBAAiBwC,KAAKhG,EAAKiG,KAAM,iBAAiBD,KAAKhG,EAAKkG,GAiB3F,CAEC5I,EAAKD,OAAOmG,QAAQC,OACpBsC,EAAK3C,EAAmB2C,EAAI/F,EAAKiG,GAGjCF,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBC,eAAgB1G,EAAKD,OAAO8G,cAAgBnE,EAAKiG,EAAI3I,EAAKD,OAAO8G,gBAE5H4B,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBoC,gBAAiB7I,EAAKD,OAAO8G,cAAgBnE,EAAKkG,EAAI5I,EAAKD,OAAO8G,oBAzBtB,CACnG,IAAIiC,GAAAA,EAAQ,iBAAiBJ,KAAKhG,EAAKiG,IAEnCF,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBC,eAAgB1G,EAAKD,OAAO8G,cAAgBnE,EAAKiG,EAAEI,UAAU,EAAGrG,EAAKiG,EAAEzH,QAAQ4H,EAAM,KAAK9F,OAAShD,EAAKD,OAAO8G,gBAElK7G,EAAKD,OAAOmG,QAAQC,OACpBsC,EAAK3C,EAAmB2C,EAAI/F,EAAKiG,GAGjCF,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBC,eAAgB1G,EAAKD,OAAO8G,cAAgBnE,EAAKiG,EAAI3I,EAAKD,OAAO8G,iBAIhIiC,EAAQ,iBAAiBJ,KAAKhG,EAAKkG,IAE/BH,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBoC,gBAAiB7I,EAAKD,OAAO8G,cAAgBnE,EAAKkG,EAAEG,UAAU,EAAGrG,EAAKkG,EAAE1H,QAAQ4H,EAAM,KAAK9F,OAAShD,EAAKD,OAAO8G,gBACtK4B,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBoC,gBAAiB7I,EAAKD,OAAO8G,cAAgBnE,EAAKkG,EAAI5I,EAAKD,OAAO8G,gBAWlIhC,EAAEqD,EAAI,+DAAsEO,EAAGjG,KAAK,IAAM,0BAC1F,MACJ,KAAKxC,EAAKI,WAAab,GAAG4F,OAAOoD,WAAWW,SACxCrE,EAAEqD,EAAIlI,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBC,eAAgB1G,EAAKD,OAAO8G,cAAgBnE,EAAKiG,EAAI3I,EAAKD,OAAO8G,eACtHhC,EAAEyD,QAAS,EACX,MACJ,KAAKtI,EAAKyG,gBAAgB/E,eAAe,mBACrC,IAAI+G,GAAAA,MACDnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBC,eAAgB1G,EAAKD,OAAO8G,cAAgBnE,EAAKiG,EAAI3I,EAAKD,OAAO8G,gBACxH4B,EAAGnF,KAAKtD,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBoC,gBAAiB7I,EAAKD,OAAO8G,cAAgBnE,EAAKkG,EAAI5I,EAAKD,OAAO8G,gBACzHhC,EAAEqD,EAAI,+DAAsEO,EAAGjG,KAAK,IAAM,0BAC1F,MACJ,QACIqC,EAAEqD,EAAI,sDAAwDlI,EAAKgF,OAAOuB,cAAcvG,EAAKyG,gBAAgBC,eAAgB1G,EAAKD,OAAO8G,cAAgBnE,EAAKiG,EAAI3I,EAAKD,OAAO8G,eAAiB,gBAIvM,OAAOhC,GAEXsE,UAAW,SAAUzG,GACjB,IAAI0G,EAAUpJ,EAAKgF,OAAOqD,UAAU3F,GAEhC2G,GACAC,QAAS,aACTC,QAAS,MACTC,YAAa,IACbC,QAASzJ,EAAK0J,QACdC,aAAc3J,EAAKkF,cAGnB9C,EAAepC,EAAKO,iBAAgB,GACxC,GAAM6B,aAAwB1B,MAEzB,CAED,IADA,IAAIkJ,KACKjI,EAAI,EAAGA,EAAIS,EAAazB,OAAQgB,IACrCiI,EAAGtG,KAAKtD,EAAK0F,cACT1F,EAAK0F,cAAgB,IAAMtD,EAAaT,GAAGqB,OAC3CZ,EAAaT,GAAGqB,QAGxBqG,EAAOQ,SAAWD,EAAGpH,KAAK,UAT1B6G,EAAOQ,SAAW7J,EAAK0F,cAAgB1F,EAAK0F,cAAgB,IAAMtD,EAAaY,OAASZ,EAAaY,OAYzG,IAAI8G,EAAiB,SAAUjG,GAC3B,GAA2B,MAAtBA,GAAc,IAAY,CAC3B,GAAMA,aAAsBnD,MAcxB,OAAOmD,EAAWrB,KAAK,KAbvB,IAAIiC,KACJ,GAAIZ,aAAsBkG,OACtB,IAAK,IAAI5B,KAAOtE,EAAY,CACxB,IAAImG,EAAOnG,EAAWsE,GAAK,GACvBtE,EAAWsE,GAAKxH,OAAS,IACzBqJ,EAAOnG,EAAWsE,GAAK3F,KAAK,MAEhCiC,EAAEnB,KAAK0G,GAGf,OAAOvF,IAMfwF,EAAcH,EAAe9J,EAAK8D,kBAClCoG,EAAOJ,EAAe9J,EAAKgE,gBAE/B,GAAIiG,aAAuBvJ,OAASwJ,aAAgBxJ,MAAO,CACvD2I,EAAOc,aAAe,GACtB,IAASxI,EAAI,EAAGA,EAAIsI,EAAYtJ,OAAQgB,IACpC0H,EAAOc,cAAgB,IAAMF,EAAYtI,GAAK,IAAMuI,EAAKvI,GAAK,SAGlE0H,EAAOc,aAAeF,EAAc,IAAMC,EAE9Cb,EAAOe,OAAShB,EAAQlB,EAExB,OAAOhI,EAAEmK,MAAMhB,IAEnBiB,cAAe,SAAUrJ,GACrB,IAAIsJ,KACAC,EAAMvJ,EAAGmD,MAAM,KAEfqG,EAASzK,EAAKgE,eACdG,EAAYnE,EAAKO,kBAErB,GAAIkK,GAAUtG,EAEV,GAAIlD,EAAGC,QAAQ,MAAQ,GAAKiD,aAAqBzD,OAASyD,EAAUxD,OAAS,EACzE,IAAK,IAAIgB,EAAI,EAAGA,EAAIwC,EAAUxD,OAAQgB,IAElC,IAAK,IAAI4C,EAAI,EAAGA,EAAIkG,EAAOtG,EAAUxC,IAAIhB,OAAQ4D,IAC7CgG,EAAMjH,MAAO6D,KAAMsD,EAAOtG,EAAUxC,IAAI4C,GAAI6C,MAAOoD,EAAIjG,UAG5D,IAAwB,GAApBtD,EAAGC,QAAQ,MAAciD,aAAqBzD,MACrD,CAAA,IAAIgK,EAAMD,EAEV,IAAS9I,EAAI,EAAGA,EAAIwC,EAAUxD,OAAQgB,IAClC,IAAK4I,EAAM7I,eAAeyC,EAAUxC,IAAK,CAEjC+I,aAAeX,QAAUU,EAAO/I,eAAeyC,EAAUxC,MACzD+I,EAAMD,EAAOtG,EAAUxC,KAE3B,IAAS4C,EAAI,EAAGA,EAAImG,EAAI/J,OAAQ4D,IACxBA,EAAIiG,EAAI7J,QACR4J,EAAMjH,MAAO6D,KAAMuD,EAAInG,GAAI6C,MAAOoD,EAAIjG,UAKrD,CACGkG,aAAkBV,QAAUU,EAAO/I,eAAeyC,KAClDsG,EAASA,EAAOtG,IAGpB,IAASxC,EAAI,EAAGA,EAAI8I,EAAO9J,OAAQgB,IAC/B4I,EAAMjH,MAAO6D,KAAMsD,EAAO9I,GAAIyF,MAAOoD,EAAI7I,KAKrD,OAAO3B,EAAKgF,OAAO2F,gBAAgBJ,IAEvCI,gBAAiB,SAAU9G,GAGlBtE,GAAGyF,QACJzF,GAAGG,WAAWH,GAAGI,YAAc,aAGnC,GAAIkE,GAAcA,aAAsBnD,MAAO,CAC3C,IAAI0I,EAAUvF,EAAWxB,IAAI,SAAUC,GACnC,IAAIA,EAAIZ,eAAe,QAOnB,OAAO,IAAInC,GAAGyF,OAAO4F,QAAQtI,EAAI6E,KAAM7E,EAAI8E,OAN3C,QAAQ,GACJ,KAAK9E,EAAIzC,MAAQN,GAAG4F,OAAO0F,WAAWC,SAClC,OAAO,IAAIvL,GAAGyF,OAAO4F,QAAQtI,EAAI6E,KAAM7E,EAAI8E,UAQ3D,OAAIgC,EAAQzI,OAAS,EACVpB,GAAGyF,OAAO+F,IAAIC,MAAM,KAAM5B,GAE1BA,EAAQ,MApYrB,CAyYXpJ,IAGPT,GAAGC,QAAQyL,OAAS,WAChB,IAAIjL,EAAOV,KACXC,GAAGE,QAAQuL,MAAMhL,EAAMkL,WAEvBlL,EAAKmL,cAAe,EAEpB5L,GAAG4F,OAAOiG,MAAMC,WAAa9L,GAAG4F,OAAOiG,MAAMC,YAAc,gBAE3DrL,EAAKsL,IAAM,6BACXtL,EAAK0J,QAAU,QACf1J,EAAK0F,cAAgB,QAEjB1F,EAAKF,SAAWE,EAAKF,QAAQwL,MAC7BtL,EAAKsL,IAAMtL,EAAKF,QAAQwL,KAG5BtL,EAAK6G,cAAgB,IACrB7G,EAAKiI,eAAiB,KAEtBjI,EAAKuL,KAAO,IACZvL,EAAKwL,KAAO,IACZxL,EAAKyL,IAAM,MACXzL,EAAK0L,IAAM,MAEX1L,EAAK2L,WAAa,MAClB3L,EAAK4L,WAAa,MAClB5L,EAAK6L,UAAY,QACjB7L,EAAK8L,UAAY,QAEjB9L,EAAK+L,IAAM,MACX/L,EAAKgM,IAAM,MACXhM,EAAKiM,IAAM,MAEXjM,EAAKkM,UAAY,QACjBlM,EAAKmM,UAAY,QACjBnM,EAAKoM,UAAY,QAEjBpM,EAAKqM,wBAELrM,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAW+D,YAC3CC,eAAgB,KAChBjB,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACdC,aAAc,EACdhM,aAAc,yBAA0B,0BAA2B,2BACnEiM,cACIjM,YAAa,uBACbkM,cAAe,YACfC,WAAY,cAEhBnG,iBACIC,eAAgB,aAChBmC,gBAAiB,WACjBG,eAAgB,WAEpBhH,oBACID,MAAO,wBACPH,QAEQiL,wBACI5K,MAAO,8BACPL,OACIL,SAAU,UACVD,IAAK,kBAKbwL,yBACI7K,MAAO,+BACPL,OACIL,SAAU,UACVD,IAAK,kBAKbyL,yBACI9K,MAAO,8BACPL,OACIL,SAAU,UACVD,IAAK,mBAMzBF,SAEQ4L,SACIC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,KAInBL,SACIC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,KAInBL,SACIC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,KAI3B9H,OAAQvF,EAAKsN,gBACbC,KAAMvN,EAAKwN,iBACXC,aAAczN,EAAK+L,IAAM,MAAQ/L,EAAKgM,IAAM,MAAQhM,EAAKiM,IAAM,MAC/DyB,uBAAwB,KAG5B1N,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWoF,cAC3CpI,OAAQvF,EAAK4N,eACbL,KAAMvN,EAAK6N,gBACXpB,aAAc,EACd1K,MAAO,KACPC,mBAAoB,SAAU2C,GAC1B,OACI5C,MAAO/B,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWoF,aAAa5L,OAAS/B,EAAKkC,gBAAgB,8BAK7GlC,EAAKyG,iBACDqH,UAAW,YACXC,MAAO,QACPC,OAAQ,SACRC,MAAO,SAGXjO,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAW2F,eAC3C9H,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BiG,IAAK,6BACL5F,cAAe,QACf8G,aAAc,WACd/L,YAAa,uBACbuD,gBAAiB,cACjByC,iBACIC,gBAAiB,WAAY,cAEjC1E,oBACID,MAAO,2BACPH,MAAO,eAEXkC,kBAAmB,aACnBI,kBAAmB,MACnBuI,aAAc,EACdrL,SAEQ4L,SACIC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,KAI3B9H,OAAQvF,EAAKmO,iBAAiBC,KAAK9O,MAAOC,GAAG4F,OAAOoD,WAAW2F,eAC/DG,qBAAsBrO,EAAKsO,yBAAyBC,OACpDhB,KAAMvN,EAAKwO,mBA4DfxO,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWkG,UAC3CrI,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,YAAa,qBACbK,kBAAmB,GACnBkD,gBAAiB,aAAc,YAC/ByC,iBACIC,gBAAiB,YAErB5C,kBAAmB,YAAa,WAChCI,kBAAmB,YACnBuI,aAAc,EACdlH,OAAQvF,EAAKmO,iBAAiBC,KAAK9O,MAAOC,GAAG4F,OAAOoD,WAAWkG,UAC/DJ,qBAAsBrO,EAAKsO,yBAAyBC,OACpDhB,KAAMvN,EAAKwO,kBACXd,uBAAwB,IACxB1L,oBACID,MAAO,sBACPH,MAAO,eAEXR,SAEQ4L,SACIC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,MAM/BrN,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWU,SAC3C7C,KAAM,KACNC,MAAO,KACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd1L,kBAAmB,mBACnBL,YAAa,sBACbuD,gBAAiB,QACjByI,aAAc,EACdhG,iBACIC,gBAAiB,WAAY,YAC7BmC,iBAAkB,MAAO,YAE7B7G,oBACID,MAAO,qBACPH,MAAO,eAEXkC,kBAAmB,WAAY,MAAO,OAAQ,YAAa,cAC3DI,kBAAmB,WACnB9C,SAEQsN,MACIvB,YAAa,UACbE,cAAe,EACfD,YAAa,EACbuB,cAAe,QACfC,gBAAiB,WAIrBC,OACI9M,MAAO,MACP+M,MAAO,WACPC,UAAW,UACXC,SAAU,GACVC,WAAY,OACZC,kBAAmB,UACnBC,kBAAmB,KAI/B5J,OAAQvF,EAAKmO,iBAAiBC,KAAK9O,MAAOC,GAAG4F,OAAOoD,WAAWU,SAC/DsE,KAAMvN,EAAKwO,mBAGfxO,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWC,SAC3CpC,KAAM,KACNC,MAAO,KACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,YAAa,oBACbK,kBAAmB,GACnB2L,aAAc,EACdzI,gBAAiB,aAAc,YAAa,OAAQ,UACpDyC,iBACIC,gBAAiB,WAAY,YAC7BmC,iBAAkB,MAAO,WACzBG,gBAAiB,WAErBhH,oBACID,MAAO,qBACPH,MAAO,aAEXkC,kBAAmB,WAAY,MAAO,SAAU,OAAQ,YAAa,cACrEI,kBAAmB,eACnB9C,SAEQyN,OACIO,OAAQ,EACRrN,MAAO,SACP+M,MAAO,WACPC,UAAW,UACXC,SAAU,GACVE,kBAAmB,UACnBC,kBAAmB,KAI/B5J,OAAQvF,EAAKmO,iBAAiBC,KAAK9O,MAAOC,GAAG4F,OAAOoD,WAAWC,SAC/D+E,KAAMvN,EAAKwO,mBAGfxO,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAW8G,QAC3CjJ,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,YAAa,wBACbK,kBAAmB,GACnBkD,gBAAiB,aAAc,YAC/B0J,uBAAwB,IACxBjH,iBACIC,gBAAiB,WAAY,YAEjC1E,oBACID,MAAO,oBACPH,MAAO,eAEXkC,kBAAmB,YAAa,WAChCI,kBAAmB,YACnBuI,aAAc,EACdrL,SAEQ4L,SACIC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,KAI3B9H,OAAQvF,EAAKmO,iBAAiBC,KAAK9O,MAAOC,GAAG4F,OAAOoD,WAAW8G,QAC/DhB,qBAAsBrO,EAAKsO,yBAAyBC,OACpDhB,KAAMvN,EAAKwO,mBAGfxO,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAW+G,YAC3ClJ,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,YAAa,uBACbK,kBAAmB,GACnBkD,gBAAiB,aACjB0J,uBAAwB,IACxBjH,iBACIC,gBAAiB,WAAY,eAEjC1E,oBACID,MAAO,wBACPH,MAAO,aAEXkC,kBAAmB,YAAa,WAAY,aAAc,aAC1DI,kBAAmB,YACnBuI,aAAc,EAEdrL,SAEQyN,OACIO,OAAQ,EACRrN,MAAO,UACP+M,MAAO,WACPC,UAAW,UACXC,SAAU,GACVE,kBAAmB,UACnBC,kBAAmB,KAI/B5J,OAAQvF,EAAKmO,iBAAiBC,KAAK9O,MAAOC,GAAG4F,OAAOoD,WAAW+G,YAC/DjB,qBAAsBrO,EAAKsO,yBAAyBC,OACpDhB,KAAMvN,EAAKwO,mBAGfxO,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWgH,wBAC3CnJ,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,YAAa,uBACbK,kBAAmB,GACnBkD,gBAAiB,aAAc,aAC/B0J,uBAAwB,IACxBjH,iBACIC,gBAAiB,YAAa,YAC9BmC,iBAAkB,WAAY,eAElC7G,oBACID,MAAO,wBACPH,MAAO,aAEXkC,kBAAmB,YAAa,WAAY,aAAc,aAC1DI,kBAAmB,YACnBuI,aAAc,EAEdrL,SAEQyN,OACIO,OAAQ,EACRrN,MAAO,UACP+M,MAAO,WACPC,UAAW,UACXC,SAAU,GACVE,kBAAmB,UACnBC,kBAAmB,KAI/B5J,OAAQvF,EAAKmO,iBAAiBC,KAAK9O,MAAOC,GAAG4F,OAAOoD,WAAWgH,wBAC/DhC,KAAMvN,EAAKwO,mBAGfxO,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWiH,eAC3CpJ,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,aAAc,wBACdK,kBAAmB,GACnBkD,gBAAiB,cACjByC,iBACIC,gBAAiB,eAErB5C,kBAAmB,cACnBI,kBAAmB,MACnBuI,aAAc,EACdrL,SAEQ4L,SACIC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,MAM/BrN,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWkH,OAC3CrJ,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,YAAa,qBACbuD,gBAAiB,cACjByC,iBACIC,gBAAiB,eAErB1E,oBACID,MAAO,mBACPH,MAAO,eAEXkC,kBAAmB,cACnBI,kBAAmBlE,EAAKkC,gBAAgB,4BAA8B,QACtEuK,aAAc,GACdrL,SAEQ4L,SACIG,YAAa,UACbE,cAAe,EACfD,YAAa,GAEjBsB,MACIvB,YAAa,UACbE,cAAe,EACfD,YAAa,EACbuB,cAAe,QACfC,gBAAiB,WAI7BrJ,OAAQvF,EAAK0P,QACbnC,KAAMvN,EAAK2P,SACX9J,QAAS,WACL,OAAO,IAAImC,OAAO,UAAYhI,EAAKkC,gBAAgB,oBAAsB,IAAMlC,EAAKkC,gBAAgB,4BAA8B,qGAAsG,OAIhPlC,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWqH,SAC3CxJ,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,YAAa,oBACbuD,gBAAiB,aAAc,OAC/ByC,iBACIC,gBAAiB,cACjBmC,iBAAkB,OAEtB7G,oBACID,MAAO,wBACPH,MAAO,aAEXkC,kBAAmB,aAAc,MACjCI,kBAAmBlE,EAAKkC,gBAAgB,4BAA8B,SAAWlC,EAAKkC,gBAAgB,kBAAoB,QAC1HuK,aAAc,GACdrL,SAEQyN,OACI9M,OAAQ,aAAc,MACtBgN,UAAW,UACXC,SAAU,GACVE,kBAAmB,UACnBC,kBAAmB,KAI/B5J,OAAQvF,EAAK6P,MACbtC,KAAMvN,EAAK8P,OACXjK,QAAS,WACL,OAAO,IAAImC,OAAO,UAAYhI,EAAKkC,gBAAgB,oBAAsB,IAAMlC,EAAKkC,gBAAgB,4BAA8B,sHAAwHlC,EAAKkC,gBAAgB,kBAAoB,qEAAsE,OAIjXlC,EAAKkG,WACLlG,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,eAC9B9H,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,YAAa,uBACbuD,gBAAiB,cACjByC,iBACIC,gBAAiB,cAErB5C,kBAAmB,aACnBI,kBAAmB,MACnB6L,aAAc,WACV,OAAO,IAAIC,QAAQ,SAAUC,EAASC,GAElC,GAAIlQ,EAAKkG,QAAQC,SAAWnG,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAciC,UAAW,CAEnF,IAAI9G,GACJE,QAAiB,OACjBF,EAAOI,QAAUzJ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAcxE,QACjEL,EAAOC,QAAU,aACjBD,EAAOQ,SAAW7J,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAcxI,cAAgB,IAAM1F,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAczN,YACxI4I,EAAOM,aAAe3J,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAchJ,aACtEmE,EAAOc,cAAgB,cAAcpJ,OAAOf,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAcpK,kBAAkBtB,KAAK,KAEnH6G,EAAO+G,WAAapQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAc9H,KAAK/D,IAAI,SAAUgO,GACnF,OAAQ,cAAchO,IAAI,SAAUpB,EAAI2F,GACpC,OAAO3F,EAAK,IAAMoP,EAAKzJ,KACxBpE,KAAK,WAGZ6G,EAAO+G,WAAa/G,EAAO+G,WAAW5N,KAAK,QAE3CjD,GAAG+Q,MACChF,IAAKtL,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAc5C,IAAM,IAAMpL,EAAEmK,MAAMhB,GACzEkH,OAAQ,MACRC,aAAcjR,GAAG4F,OAAOsL,SAASpL,OAClCqL,KAAK,SAAUhO,GACd,GAAIA,EAAKiO,cAAgB,EAAG,CAExB3Q,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAciC,UAAYzN,EAAKkO,SAASvO,IAAI,SAAUoB,GACpF,OACIxC,IAAK,cAAcoB,IAAI,SAAUgO,GAC7B,OAAO5M,EAAQI,WAAWwM,KAC3B7N,KAAK,KACRT,MAAO0B,EAAQI,WAAW7D,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAcpK,iBAAiB,IAAI2D,iBAIvGwI,EAAQjQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAciC,eAErD,CACHnQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAciC,aAChDF,EAAQjQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAciC,cAE7DU,MAAM,WACLZ,aAIJA,EAAQjQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAW2F,cAAciC,eAKxEnQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,WAC9B9C,KAAM,KACNC,OAAO,EACPiF,IAAKtL,EAAKsL,KAAO,6BACjB5B,QAAS1J,EAAK0J,SAAW,QACzBxE,aAAc3F,GAAG4F,OAAOC,OAAOC,KAC/BK,cAAe1F,EAAK0F,eAAiB,QACrC8G,aAAc,WACd/L,aAAc,yBACdK,kBAAmB,GACnBkD,gBAAiB,aAAc,aAC/ByC,iBACIC,gBAAiB,aAErB5C,kBAAmB,YACnBiM,aAAc,WACV,OAAO,IAAIC,QAAQ,SAAUC,EAASC,GAClC,GAAIlQ,EAAKkG,QAAQC,SAAWnG,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUiH,UAAW,CAE/E,IAAI9G,GACJE,QAAiB,OACjBF,EAAOI,QAAUzJ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUQ,QAC7DL,EAAOC,QAAU,aACjBD,EAAOQ,SAAW7J,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUxD,cAAgB,IAAM1F,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUzI,YAChI4I,EAAOM,aAAe3J,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUhE,aAClEmE,EAAOc,cAAgB,aAAc,YAAYpJ,OAAOf,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUpF,kBAAkBtB,KAAK,KAE3H6G,EAAO+G,WAAapQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAU9C,KAAK/D,IAAI,SAAUgO,GAC/E,OAAQ,aAAc,YAAYhO,IAAI,SAAUpB,EAAI2F,GAChD,OAAO3F,EAAK,IAAMoP,EAAKzJ,KACxBpE,KAAK,WAGZ6G,EAAO+G,WAAa/G,EAAO+G,WAAW5N,KAAK,QAE3CjD,GAAG+Q,MACChF,IAAKtL,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUoC,IAAM,IAAMpL,EAAEmK,MAAMhB,GACrEkH,OAAQ,MACRC,aAAcjR,GAAG4F,OAAOsL,SAASpL,OAClCqL,KAAK,SAAUhO,GACd,GAAIA,EAAKiO,cAAgB,EAAG,CAExB3Q,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUiH,UAAYzN,EAAKkO,SAASvO,IAAI,SAAUoB,GAChF,OACIxC,IAAK,aAAc,YAAYoB,IAAI,SAAUgO,GACzC,OAAO5M,EAAQI,WAAWwM,KAC3B7N,KAAK,KACRT,MAAO0B,EAAQI,WAAW7D,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUpF,iBAAiB,IAAI2D,iBAInGwI,EAAQjQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUiH,eAEjD,CACHnQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUiH,aAC5CF,EAAQjQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUiH,cAEzDU,MAAM,WACLZ,aAIJA,EAAQjQ,EAAKkG,QAAQ3G,GAAG4F,OAAOoD,WAAWW,UAAUiH,eAOpEnQ,EAAK8Q,sBAEL,GAAI9Q,EAAKF,QAAQgR,mBACb,IAAK,IAAIC,KAAW/Q,EAAKF,QAAQgR,mBAAoB,CAEjD,GAAI9Q,EAAKqM,qBAAqB0E,KAAa7Q,EAAE8Q,cAAchR,EAAKF,QAAQgR,mBAAmBC,IAAW,CAKlG,GAAI/Q,EAAKqM,qBAAqB0E,GAASjQ,mBAAqBd,EAAKqM,qBAAqB0E,GAASjQ,kBAAkBH,OAAS,GACtHX,EAAKF,QAAQgR,mBAAmBC,GAAStQ,cAAgBT,EAAKF,QAAQgR,mBAAmBC,GAASjQ,kBAAmB,QAE9Gd,EAAKqM,qBAAqB0E,GAASjQ,kBAC1Cd,EAAKqM,qBAAqB0E,GAAS3P,OAASpB,EAAKqM,qBAAqB0E,GAAS3P,OAAOiD,MAAM,EAAGrE,EAAKqM,qBAAqB0E,GAAS3P,OAAOT,OAAS,GAItJT,EAAEC,OAAOH,EAAKqM,qBAAqB0E,GAAU/Q,EAAKF,QAAQgR,mBAAmBC,IAI7E,GAAI/Q,EAAKF,QAAQgR,mBAAmBC,GAAS3K,MACxC2K,GAAWxR,GAAG4F,OAAOoD,WAAW2F,cAAgBlO,EAAKF,QAAQgR,mBAAmBC,GAASE,UAAY1R,GAAG4F,OAAOoD,WAAW2F,cAC1H6C,GAAWxR,GAAG4F,OAAOoD,WAAWW,UAAYlJ,EAAKF,QAAQgR,mBAAmBC,GAASE,UAAY1R,GAAG4F,OAAOoD,WAAWW,SAAW,CAElIlJ,EAAKkG,QAAQC,OAASnG,EAAKkG,QAAQlG,EAAKF,QAAQgR,mBAAmBC,GAASE,UAC5EjR,EAAKkG,QAAQC,OAAOC,KAAOpG,EAAKF,QAAQgR,mBAAmBC,GAAS3K,KACpEpG,EAAKkG,QAAQC,OAAOE,MAAQrG,EAAKF,QAAQgR,mBAAmBC,GAAS1K,MAErErG,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWU,QAAQxC,gBAAgBC,eACnE1G,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWC,QAAQ/B,gBAAgBC,eACvE1G,EAAKkG,QAAQC,OAAOnC,gBAK3BhE,EAAKF,QAAQgR,mBAAmBC,GAGjC/Q,EAAKkR,qBAAqBH,EAAS/Q,EAAKqM,qBAAqB0E,GAAW/Q,EAAKqM,qBAAqB0E,GAAW/Q,EAAKF,QAAQgR,mBAAmBC,GAAU/Q,UAFhJA,EAAKF,QAAQgR,mBAAmBC,GAO/C/Q,EAAKkG,QAAQC,QACbnG,EAAKkG,QAAQC,OAAO4J,eAGxB/P,EAAKmR,kBAAoBnR,EAAKF,QAAQqR,oBAAqB,EAE3DnR,EAAKoR,SAAW,EAChBpR,EAAKqR,SAAW,EAEhBrR,EAAKsF,KAAO,IAAI/F,GAAG+F,KAAK9F,QAAQyL,OAAOjL,GAEvCA,EAAKsR,SAAW,IAEhBtR,EAAKuR,iBACDC,aAAc,oEACdC,iBAAkB,qCAClBC,SAAU,uCAIlBnS,GAAGoS,QAAQpS,GAAGC,QAAQyL,OAAQ1L,GAAGE,UAEjC,WACI,IAAImS,EAAWrS,GAAGC,QAAQyL,OAAO4G,UAEjCD,EAASE,MAAQ,gBAEjBvS,GAAG4F,OAAOiG,MAAM2G,iBAAmBxS,GAAG4F,OAAOiG,MAAM2G,kBAAoB,sBAEnExS,GAAGyS,QACHJ,EAASK,SAAW1S,GAAGI,YAAc,2BAGrCiS,EAASK,SAAW,WAChBC,KAAKC,SAASP,EAASE,MAAOM,GAAS,SAASA,EAAOC,EAAKC,GAAO,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAQF,MAAWG,KAAQ,aAAcF,EAAE,wGAA+GC,EAAE,OAAQF,MAAWG,KAAQ,uBAAwBF,EAAE,aAAeC,EAAE,OAAQF,MAAWG,KAAQ,wBAAyBF,EAAE,kBAAoBC,EAAE,OAAQF,MAAWG,KAAQ,wBAAyBF,EAAE,2CAA8CC,EAAE,OAAQF,MAAWG,KAAQ,aAAcF,EAAE,4DAAiEH,EAAOM,YAAa,EAAI,OAAON,GAIjoBR,EAASO,SAAW,SAAU9P,GAC1B,MAAMrC,EAAOV,KACPqT,EAASpT,GAAGE,QAAQoS,UAAUM,SAAShQ,KAAKnC,EAAMqC,GAExDrC,EAAK4S,SACDlQ,SAGJ1C,EAAK6S,aAAgB,WACjB,SAASC,EAAeC,GACpB,OAAOA,EAAU7R,QAAQ,MAAQ,EAAI6R,EAAU3O,MAAM,KAAK,GAAK2O,EAEnE,SAASC,EAASjO,EAAUxD,EAAUN,GAElC,IAAIpB,EAAOG,EAAKiT,uBAAuBhS,GACvC,GAAIpB,EAAM,CACN,IAAI4B,EAAQ5B,EAAKsB,sBAAsB2R,EAAe7R,IAEtD,GAAIQ,GAASA,EAAMC,eAAeH,GAC9B,OAAOE,EAAMF,GAAUwD,GAI/B,OAAOxF,GAAG2T,IAAI9R,OAAOG,GAAUwD,GAGnC,OAAO,SAAUxD,EAAUwD,EAAUoO,EAAcjL,IAG3C3I,GAAG6T,SAAalL,aAAa3I,GAAG6T,SAFzB9T,KAGF+C,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAMkI,aAAeC,MAHzCjU,KAGqDiU,MAAOC,KAAMtL,EAAEsL,OAG/E,IAAIxJ,EAAOgJ,EAASjO,EAAUxD,EAAUuR,EAAe5K,EAAEjH,KACzD,GAAIkS,EAAc,CACd,GAAInJ,aAAgBtJ,MAAO,CACvB,IAAI+S,EAASzJ,EAAK3H,IAAI,SAAUoC,GAC5B,OAAOyD,EAAEwL,UAAUhS,eAAe+C,GAAKyD,EAAEwL,UAAUjP,GAAK,KAExD8D,EAAajJ,KAAK2T,uBAAuBH,EAAe5K,EAAEjH,KAC9D,OAAIsH,EACOA,EAAWrE,kBAAkBQ,SAAS+O,GAEtCA,EAAOjR,KAAK,KAGvB,OAAO0F,EAAEwL,UAAUhS,eAAesI,GAAQ9B,EAAEwL,UAAU1J,GAAQ,GAIlE,OAAOA,GA1CC,GA+CpB,IAAI2J,EAAU3T,EAAK6S,aAEnB7S,EAAK4T,aAAevR,EAAIwR,UACpB5S,GAAIjB,EAAK8T,SACT7R,MAAO,eACP8R,SAAS,EACTC,WAAW,EACXnU,KAAMN,GAAG4F,OAAO8O,UAAUC,OAC1B9S,QACI4L,SACIC,UAAW0G,EAAQvF,KAAKpO,EAAM,UAAW,aAAa,GACtDkN,YAAayG,EAAQvF,KAAKpO,EAAM,UAAW,eAAe,GAC1DmN,YAAawG,EAAQvF,KAAKpO,EAAM,UAAW,eAAe,GAC1DqN,cAAesG,EAAQvF,KAAKpO,EAAM,UAAW,iBAAiB,GAC9DoN,YAAauG,EAAQvF,KAAKpO,EAAM,UAAW,eAAe,IAE9D0O,MACIvB,YAAawG,EAAQvF,KAAKpO,EAAM,OAAQ,eAAe,GACvDqN,cAAesG,EAAQvF,KAAKpO,EAAM,OAAQ,iBAAiB,GAC3DoN,YAAauG,EAAQvF,KAAKpO,EAAM,OAAQ,eAAe,IAE3DmU,QACIC,OAAQ7U,GAAG8U,SAASjT,OAAO+S,OAAOC,OAClCE,OAAQ/U,GAAG8U,SAASjT,OAAO+S,OAAOG,OAClCC,MAAOhV,GAAG8U,SAASjT,OAAO+S,OAAOI,OAErC1F,OACIO,OAAQuE,EAAQvF,KAAKpO,EAAM,QAAS,UAAU,GAC9CsU,OAAQX,EAAQvF,KAAKpO,EAAM,QAAS,UAAU,GAC9CuU,MAAOZ,EAAQvF,KAAKpO,EAAM,QAAS,SAAS,GAC5CiN,UAAW0G,EAAQvF,KAAKpO,EAAM,QAAS,aAAa,GACpDkN,YAAayG,EAAQvF,KAAKpO,EAAM,QAAS,eAAe,GACxDmN,YAAawG,EAAQvF,KAAKpO,EAAM,QAAS,eAAe,GACxDoN,YAAauG,EAAQvF,KAAKpO,EAAM,QAAS,eAAe,GACxDgP,SAAU2E,EAAQvF,KAAKpO,EAAM,QAAS,YAAY,GAClD+O,UAAW4E,EAAQvF,KAAKpO,EAAM,QAAS,aAAa,GACpDkP,kBAAmByE,EAAQvF,KAAKpO,EAAM,QAAS,qBAAqB,GACpEmP,kBAAmBwE,EAAQvF,KAAKpO,EAAM,QAAS,qBAAqB,GACpE+B,MAAO4R,EAAQvF,KAAKpO,EAAM,QAAS,SAAS,GAC5C8O,MAAO6E,EAAQvF,KAAKpO,EAAM,QAAS,SAAS,OAInD0Q,KAAK,SAAU6C,GACZvT,EAAKuT,MAAQA,EACb,OAAOA,IAGfvT,EAAKwU,oBAAsBxU,EAAKkC,gBAAgB,aAChDlC,EAAKyU,oBAAsBzU,EAAKkC,gBAAgB,kBAChDlC,EAAK0U,aAAe1U,EAAKkC,gBAAgB,mBAEzClC,EAAK2U,gBAAkB,MAAO,UAAW,eAAgB,gBAAiB,cAAe,aAAc,gBAEvG,OAAOhC,GAGXf,EAASgD,WAAa,SAAUlS,EAAMmS,GAClC,IAAI7U,EAAOV,KAEXU,EAAK4S,QAAU5S,EAAK4S,YAEpB,IAAIA,EAAU,WACV5S,EAAK8U,OAAO9U,EAAK+U,UAAU3N,MAAO,SAAU4N,GACxC,GAAoB,IAAhBA,EAAKrU,OAAc,CACnBX,EAAK+U,UAAU3N,MAAQ4N,EAAK,GAAGjT,MAC/B/B,EAAKiV,YAAYD,EAAK,GAAG/T,GAAIjB,EAAKkV,YAAYC,cAAc,oBAAoBC,aAAa,aAC7FpV,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,aAE5B,IAAhBR,EAAKrU,QACVX,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,WAK7D,OAAOjW,GAAGE,QAAQoS,UAAU+C,WAAWzS,KAAKnC,EAAM0C,EAAM,WAGpD,IAAI+S,EAAY,WACZzV,EAAK+U,UAAU3N,MAAQpH,EAAKkV,YAAYnT,OAAS/B,EAAKkV,YAAYC,cAAc,+BAA+BO,YAC/G1V,EAAK2V,YAAc3V,EAAK+U,UAAU3N,MAClCpH,EAAKiV,YAAYjV,EAAKkV,YAAYjU,IAAM2U,SAAS5V,EAAKkV,YAAYC,cAAc,wBAAwBC,aAAa,SAASrM,UAAU,GAAI/I,EAAKkV,YAAYC,cAAc,oBAAoBC,aAAa,aAC5MpV,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,SAGrDxV,EAAK+U,UAAY/U,EAAK6V,IAAIV,cAAc,2BACpCnV,EAAKF,SAAWE,EAAKF,QAAQgW,aAC7B9V,EAAK+U,UAAUgB,aAAa,cAAe/V,EAAKF,QAAQgW,YAAY9S,QAGxEhD,EAAKkV,YAAclV,EAAK6V,IAAIV,cAAc,uBAC1CnV,EAAKgW,MAAQ9V,EAAEF,EAAKkV,aACpBlV,EAAKiW,OAASjW,EAAK6V,IAAIV,cAAc,sBACrCnV,EAAKiW,OAAOC,iBAAiB3W,GAAG4F,OAAOiG,MAAM+K,MAAO,WAChDnW,EAAKoW,WAAW1F,KAAK,SAAU2F,GACvBrW,EAAKkV,YAAYoB,iBAAiB,sEAAsE3V,OAAS,IAC5G0V,EAAEzF,SAASjQ,OAAS,EACzB0V,EAAEhU,IAAIkU,eAAeF,EAAEzF,UAEiG,IAAnH5Q,EAAKkV,YAAYoB,iBAAiB,sEAAsE3V,OAC7G8U,IAGAzV,EAAK+U,UAAUyB,cAAc,IAAIC,MAAM,eAInD,GAAIzW,EAAKF,QAAQ4W,aAAc,CAC3B1W,EAAK+U,UAAUgB,aAAa,QAAS/V,EAAKF,QAAQ4W,aAAa1T,QAC/DhD,EAAKiW,OAAOF,aAAa,QAAS/V,EAAKF,QAAQ4W,aAAa1T,QAIhEhD,EAAKkV,YAAYgB,iBAAiB3W,GAAG4F,OAAOiG,MAAM+K,MAAO5W,GAAGoX,YAAYC,mBAAmB,2BAA4B,WACnH5W,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,QACjDxV,EAAK+U,UAAU8B,WAKnB,IACI,GAAI7W,EAAK+U,UAAUM,UAAUyB,SAAS,eAAgB,CAElD9W,EAAK+U,UAAUmB,iBAAiB,UAAW,SAAUa,GAGhC,KAFN/W,EAAK+U,UAAU3N,OAQ1B4P,WAAW,WAGP,GAAiB,KAFFhX,EAAK+U,UAAU3N,MAET,CACjBpH,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,QAEjD5C,MAEL,MAIf,MAAOmE,IAEP/W,EAAK+U,UAAUmB,iBAAiB,WAAY,SAAUa,GAClD,GAAe,IAAXA,EAAEE,MAAa,CACfF,EAAEG,iBACFH,EAAEI,kBAEFnX,EAAK2V,YAAc,GAEoG,IAAnH3V,EAAKkV,YAAYoB,iBAAiB,sEAAsE3V,OACxG8U,IAEA7C,IAEJ,OAAO,KAGf5S,EAAK+U,UAAUmB,iBAAiB,SAAU,WACtC,GAAoC,IAAhClW,EAAK+U,UAAU3N,MAAMzG,OAAc,CACnCX,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,QACjD5C,OAGR5S,EAAK+U,UAAUmB,iBAAiB,QAAS,WACrC,GAAoC,IAAhClW,EAAK+U,UAAU3N,MAAMzG,OAAc,CACnCX,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,QACjD5C,OAGR5S,EAAK+U,UAAUmB,iBAAiB,6BAA8B,WAC1DlW,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,UAErDxV,EAAK+U,UAAUmB,iBAAiB,6BAA8B,WACtDlW,EAAKkV,YAAYoB,iBAAiB,MAAM3V,OAAS,GACjDX,EAAKkV,YAAYG,UAAU+B,OAAO7X,GAAG4F,OAAOoQ,QAAQC,UAI5DxV,EAAK2V,YAAc,GACnB3V,EAAKqX,aAAe,KACpB9X,GAAG+X,QACE/X,GAAGgY,KAAOhY,GAAGgY,GAAGC,cAChBjY,GAAGI,YAAc,yBAClB,WACI,IAAI8X,EAuSJlY,GAAGgY,GAAGC,aAAarV,KAAKnC,EAAK+U,WACzB2C,KAAM,IACNC,OAAQ3X,EAAKkV,YACb0C,UAAW,EACXtF,IAAKtS,EACLyK,OA1SW,SAAU9F,EAAMkQ,GAC3B7U,EAAK6X,UAAY3Y,YAAYC,MAExBsY,IA+BDA,EAAcK,sBA9Bd,SAASC,IACL,IAAIC,EAAWhY,EAAK+U,UAAU3N,MAAMpE,OAEpC,GAAIgV,EAASrX,OAAS,KAChBX,EAAK2V,aAAeqC,GAAYhY,EAAK2V,cACvCzW,YAAYC,MAAQa,EAAK6X,UAAY7X,EAAKsR,SAAU,CAEpDrS,OAAOgZ,qBAAqBR,GAC5BA,OAAcS,EAEdlY,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,QAYjDxV,EAAK2V,YAAcqC,EAEnBhY,EAAK8U,OAAOkD,EAAUnD,QAEtB4C,EAAcK,sBAAsBC,OA6QhDlD,SAxPa,SAAUkC,GACvB,IAAIoB,EAAUpB,EAAEY,OAEuB,MAAnCZ,EAAEY,OAAOS,QAAQ3Q,gBACjB0Q,EAjBM,SAAUE,EAAIC,GACxB,MAAMC,EAAkBF,EAAGG,SAAWH,EAAGI,uBAAyBJ,EAAGK,oBAAsBL,EAAGM,kBAE9F,KAAON,GAAI,CACP,GAAIE,EAAgBpW,KAAKkW,EAAIC,GACzB,OAAOD,EAEPA,EAAKA,EAAGO,cAGhB,OAAO,KAOOC,CAAQ9B,EAAEY,OAAQ,MAGhC,GAAIQ,EAAQhD,cAAc,gBAAiB,CACvCnV,EAAK+U,UAAU3N,MAAQ+Q,EAAQhD,cAAc,gBAAgBO,YAC7D1V,EAAK2V,YAAc3V,EAAK+U,UAAU3N,MAClCpH,EAAKiV,YAAYW,SAASuC,EAAQ/C,aAAa,SAASrM,UAAU,GAAIoP,EAAQW,WAAW1D,aAAa,aACtG7V,GAAGgY,GAAGC,aAAarV,KAAKnC,EAAK+U,UAAW,WA8O5CgE,UA1Oc,SAAUpW,GAExB,IAAIqW,KACAC,KAEAC,EAAM,aACNC,EAAM,UACV,SAASC,EAAavW,EAAGC,GACrB,IAAIuW,EAAOC,SAASzW,EAAG,IACnB0W,EAAOD,SAASxW,EAAG,IAEvB,GAAIC,MAAMsW,IAAStW,MAAMwW,GAAO,CAC5B,IAAIC,EAAK3W,EAAE0E,QAAQ2R,EAAK,IACpBO,EAAK3W,EAAEyE,QAAQ2R,EAAK,IACxB,GAAIM,IAAOC,EAAI,CACX,IAAIC,EAAKJ,SAASzW,EAAE0E,QAAQ4R,EAAK,IAAK,IAClCQ,EAAKL,SAASxW,EAAEyE,QAAQ4R,EAAK,IAAK,IACtC,OAAOO,IAAOC,EAAK,EAAID,EAAKC,EAAK,GAAK,EAEtC,OAAOH,EAAKC,EAAK,GAAK,EAEvB,OAAI1W,MAAMsW,GACN,EACAtW,MAAMwW,IACL,EAEDF,EAAOE,EAAO,GAAK,EAKlC,IAAI7W,EAAOC,EAAQA,QAAQiX,KAAK,SAAU/W,EAAGC,GACzC,OAAIxD,KAAKgT,IAAIrL,oBAAoBpE,EAAEoC,UAAUwH,cAAgBnN,KAAKgT,IAAIrL,oBAAoBnE,EAAEmC,UAAUwH,cAC7FnN,KAAKgT,IAAIrL,oBAAoBpE,EAAEoC,UAAUwH,cAAgB,IAAMnN,KAAKgT,IAAIrL,oBAAoBnE,EAAEmC,UAAUwH,cAAgB,GAClH,GACCnN,KAAKgT,IAAIrL,oBAAoBpE,EAAEoC,UAAUwH,cAAgB,IAAMnN,KAAKgT,IAAIrL,oBAAoBnE,EAAEmC,UAAUwH,cAAgB,IACxH,EAGD2M,EAAavW,EAAEd,MAAOe,EAAEf,OAG/Bc,EAAEoC,SAAWnC,EAAEmC,SACR,EAEFpC,EAAEoC,SAAWnC,EAAEmC,UACZ,EAEDmU,EAAavW,EAAEd,MAAOe,EAAEf,QAGzCqM,KAAK9O,OAEHU,EAAKkG,QAAQC,SACbzD,EAAOA,EAAKkX,KAAK,SAAU/W,EAAGC,GAE1B,MAAM+W,EAAQ,WACV,IAEIC,EAAOC,EAFPC,EAAQ1a,KAAK4G,QAAQC,OAAOC,KAAK,aAAc1F,MAAQpB,KAAK4G,QAAQC,OAAOC,KAAK,GAAG5D,KAAK,KAAOlD,KAAK4G,QAAQC,OAAOC,KAAK,GAG5H,GAAIvD,EAAEgB,YAAchB,EAAEgB,WAAWlD,OAAS,GAAKmC,EAAEe,YAAcf,EAAEe,WAAWlD,OAAS,EAAG,CACpFmZ,EAAQxa,KAAK4G,QAAQC,OAAOnC,eAAe3B,IAAI,SAAUgO,GAAQ,OAAOxN,EAAEgB,WAAWwM,GAAM7I,aAAehF,KAAK,KAC/GuX,EAAQza,KAAK4G,QAAQC,OAAOnC,eAAe3B,IAAI,SAAUgO,GAAQ,OAAOvN,EAAEe,WAAWwM,GAAM7I,aAAehF,KAAK,SAC5G,CACHsX,EAAQjX,EAAE5B,GACV8Y,EAAQjX,EAAE7B,GAGd,OAAI6Y,IAAUE,GAASD,IAAUC,EACtB,EACAF,IAAUE,GAASD,IAAUC,GAC5B,EAEDZ,EAAavW,EAAEd,MAAOe,EAAEf,QAErCqM,KAAK9O,MAEP,OAAIA,KAAK2H,oBAAoBpE,EAAEoC,UAAUwH,cAAgBnN,KAAK2H,oBAAoBnE,EAAEmC,UAAUwH,cACrFnN,KAAK2H,oBAAoBpE,EAAEoC,UAAUwH,cAAgB,IAAMnN,KAAK2H,oBAAoBnE,EAAEmC,UAAUwH,cAAgB,GAC1G,GACCnN,KAAK2H,oBAAoBpE,EAAEoC,UAAUwH,cAAgB,IAAMnN,KAAK2H,oBAAoBnE,EAAEmC,UAAUwH,cAAgB,IAChH,EAGDoN,IAIJA,KAGbzL,KAAKpO,KAGX,IAAK,IAAI2B,EAAI,EAAGA,EAAIe,EAAK/B,OAAQgB,IAAK,CAClC,IAAIW,EAAMI,EAAKf,GAEf,IAAwC,GAApCsX,EAAU/X,QAAQoB,EAAI2C,UAAiB,CAEvC,IAAIpF,EAAOP,KAAKgT,IAAIrL,oBAAoB3E,EAAI2C,UAE5C+T,EAAKA,EAAKrY,QAAUd,EAAKgC,wBAEzBoX,EAAU3V,KAAKhB,EAAI2C,UAGvB,MAAMgV,EAAe,WACC3X,EAAIP,MAAtB,IACImY,KAIuC,IAAvC5a,KAAKgT,IAAIqD,YAAY3S,OAAOrC,QAAgBX,EAAK+U,UAAU3N,MAAMpE,OAAOrC,OAAS,IACjFrB,KAAKgT,IAAIqD,YAAc3V,EAAK+U,UAAU3N,MAAMpE,QAGhD,IAAImX,EAAwB7a,KAAKgT,IAAIqD,YAOjCyE,KACAC,EAAgB,KACiC,IAPjDF,EADAna,EAAKuR,gBAAgBC,aAAalK,KAAK6S,GACfA,EAAsB5S,QAAQvH,EAAKuR,gBAAgBE,iBAAkB,IAErE0I,EAAsB5S,QAAQvH,EAAKuR,gBAAgBG,SAAU,KAK/DxQ,QAAQmZ,KAC9BA,EAAgB,KAGpBD,EAASD,EAAsBnX,OAAOoB,MAAMiW,GAG5C,GAAK/X,EAAIP,MAAMb,QAAQ5B,KAAKgT,IAAIxG,YAAc,GAAKxJ,EAAIP,MAAMb,QAAQ5B,KAAKgT,IAAIzG,YAAc,GACvFvJ,EAAIP,MAAMb,QAAQ5B,KAAKgT,IAAI3G,aAAe,GAAKrJ,EAAIP,MAAMb,QAAQ5B,KAAKgT,IAAI1G,aAAe,EAAI,CAC9FwO,EAAS9a,KAAKgT,IAAIqD,YAAYvR,MAAM,KAEpC,IAAK,IAAIuE,EAAI,EAAGA,EAAIyR,EAAOzZ,OAAQgI,IACG,KAA9ByR,EAAOzR,GAAG3F,OAAOqB,OAAO,KACxB+V,EAAOzR,GAAKyR,EAAOzR,GAAGtE,MAAM,GAAI,IAI5C,IAAK,IAAIiW,EAAI,EAAGA,EAAIF,EAAOzZ,OAAQ2Z,IAC/B,GAAIF,EAAOE,GAAGtX,OAAOrC,OAAS,EAAG,CAC7BuZ,EAAO5W,KAAK,IAAM8W,EAAOE,GAAGtX,OAAOuE,QAAQ,OAAQ,IAAIA,QAAQ,OAAQ,IAAM,KAE7E,GADIuB,EAAQ,uBAAuBJ,KAAK0R,EAAOE,GAAGtX,QAG9C,IADA,IAAIuX,EAAUH,EAAOE,GAAGtX,OAAOuE,QAAQ,uBAAwB,IAAInD,MAAM,KAChEoW,EAAK,EAAGA,EAAKD,EAAQ5Z,OAAQ6Z,IAC9BD,EAAQC,GAAIxX,OAAOrC,OAAS,GAC5BuZ,EAAO5W,KAAK,IAAMiX,EAAQC,GAAIxX,OAAOuE,QAAQ,OAAQ,OAAOA,QAAQ,OAAQ,OAAS,KAMzG,GAAIjF,EAAI2C,UAAY1F,GAAG4F,OAAOoD,WAAWkH,MAAQnN,EAAI2C,UAAY1F,GAAG4F,OAAOoD,WAAWqH,OAAQ,CAC1F,IACI9G,EAEJ,GAFIA,EADW9I,EAAKiH,oBAAoB3E,EAAI2C,UAAUW,aACjC8C,KAAKpJ,KAAKgT,IAAIqD,aAExB,CACPuE,KAEIpR,EAAM,IAAMA,EAAM,IAAMA,EAAM,GAC9BoR,EAAO5W,KAAK,IAAMwF,EAAM,GAAK,IAAMA,EAAM,GAAK,IAAMA,EAAM,GAAK,KACxDA,EAAM,IAAMA,EAAM,GACzBoR,EAAO5W,KAAK,IAAMwF,EAAM,GAAK,IAAMA,EAAM,GAAK,KACvCA,EAAM,IAAMA,EAAM,GACzBoR,EAAO5W,KAAK,IAAMwF,EAAM,GAAK,IAAMA,EAAM,GAAK,MACvCA,EAAM,IAAMA,EAAM,KACzBoR,EAAO5W,KAAK,KAAOwF,EAAM,IAAMA,EAAM,IAAM,KAG3CA,EAAM,IACNoR,EAAO5W,KAAK,MAAQtD,EAAKkC,gBAAgB,kBAAoB,eAAsB4G,EAAM,GAAK,cAE3FA,GAASA,EAAM,KACtBoR,MAEO5W,KAAK,MAAQtD,EAAKkC,gBAAgB,kBAAoB,eAAsB4G,EAAM,GAAK,SAItG,IAAIjD,EAAU,IAAMqU,EAAO1X,KAAK,KAAO,IAavCqD,GADAA,GADAA,GADAA,GADAA,GAFAA,GADAA,GADAA,GADAA,GADAA,GADAA,EAAUA,EAAQ0B,QAAQ,cAAS,MACjBA,QAAQ,cAAS,MACjBA,QAAQ,cAAS,MACjBA,QAAQ,cAAS,MACjBA,QAAQ,cAAS,MACjBA,QAAQ,SAAO,MAEfA,QAAQ,MAAO,kBACfA,QAAQ,MAAO,kBACfA,QAAQ,MAAO,kBACfA,QAAQ,MAAO,kBACfA,QAAQ,MAAO,sBACjC,IAAIkT,EAAM,IAAIzS,OAAOnC,EAAS,MAE1B9D,EAAQO,EAAIP,MAiBhB,OAfIO,EAAI2C,WAAa1F,GAAG4F,OAAOoD,WAAWkH,MAAQnN,EAAI2C,WAAa1F,GAAG4F,OAAOoD,WAAWqH,OACtE7N,EAAMwF,QAAQkT,EACxB,WACI,IAAIpR,EAAS3I,MAAMmR,UAAUxN,MAAMlC,KAAK+I,UAAW,GAEnD,OAAI7B,EAAOA,EAAO1I,OAAS,GAChB0I,EAAO,GAAG9B,QAAQ8B,EAAOA,EAAO1I,OAAS,GAAI,MAAQ0I,EAAOA,EAAO1I,OAAS,GAAK,QAEjF,MAAQ0I,EAAO,GAAK,SAIzBtH,EAAMwF,QAAQkT,EAAK,cAIvCrM,KAAK9O,MAEP0Z,EAAKA,EAAKrY,QAAU,iBAAmB2B,EAAI2C,SAAW,eAAsByV,mBAAmBpY,EAAIrB,IAAM,kBAAoBqB,EAAIP,MAAQ,UAAYkY,IAAiB,YAK1K,OAAOjB,EAAKxW,KAAK,OAgDrB,MAAMmY,EAAY,SAAU5D,GACxB,IAAKA,EAAE6D,UAAY7D,EAAE8D,SAAW9D,EAAE+D,SAC9B,GAAkB,KAAd/D,EAAEgE,QAAgB,CACd/a,EAAK+U,WAAaiG,SAASC,eAAiBjb,EAAKkV,YAAYC,cAAc,sBAE3EnV,EAAKkV,YAAYC,cAAc,sBAAsB0B,QAC9C7W,EAAKkV,YAAYC,cAAc,mCAAqC6F,SAASC,cAEpFjb,EAAK+U,UAAU8B,QA3CV,SAAUxG,EAAMiI,GAGjC,IAAI4C,EAAU7K,EAAK8K,mBAGnB,IAAK7C,EAAU,OAAO4C,EAItB,KAAOA,GAAS,CACZ,GAAIA,EAAQ1C,QAAQF,GAAW,OAAO4C,EACtCA,EAAUA,EAAQC,oBAkCVC,CAAeJ,SAASC,cAAcrC,cAAe,oBAChDzD,cAAc,KAAK0B,QAE5BE,EAAEG,iBACFH,EAAEI,uBACC,GAAkB,KAAdJ,EAAEgE,QAAgB,CACrB/a,EAAK+U,WAAaiG,SAASC,cAE3Bjb,EAAKkV,YAAYC,cAAc,iCAAiC0B,QACzDmE,SAASC,eAAiBjb,EAAKkV,YAAYC,cAAc,sBAChEnV,EAAKkV,YAAYC,cAAc,iCAAiC0B,QAvCvD,SAAUxG,EAAMiI,GAGrC,IAAI4C,EAAU7K,EAAKgL,uBAGnB,IAAK/C,EAAU,OAAO4C,EAItB,KAAOA,GAAS,CACZ,GAAIA,EAAQ1C,QAAQF,GAAW,OAAO4C,EACtCA,EAAUA,EAAQG,wBA8BVC,CAAmBN,SAASC,cAAcrC,cAAe,oBACpDzD,cAAc,KAAK0B,QAE5BE,EAAEG,iBACFH,EAAEI,kBAGVJ,EAAEI,mBAGNnX,EAAK+U,UAAUmB,iBAAiB,UAAWyE,GAC3C3a,EAAKkV,YAAYgB,iBAAiB,UAAWyE,KAIjDza,EAAEqb,WAAW1G,IACbA,OAKZjD,EAASV,qBAAuB,SAAU/J,EAAMrH,GACjCR,KAENwR,mBAAmBxN,KAAK,IAAI1D,WAAWuH,EAAMrH,EAFvCR,QAKfsS,EAAS3K,oBAAsB,SAAUpH,GAGrC,OAFWP,KAECwR,mBAAmB9L,OAAO,SAAU+L,GAC5C,OAAOA,EAAQ3Q,UAAYP,IAC5B,IAGP+R,EAASqB,uBAAyB,SAAUhS,GACxC,IAEIpB,EAFOP,KAEKwR,mBAAmB9L,OAAO,SAAU+L,GAChD,OAAOA,EAAQ/P,oBAAoBC,KAGvC,OAAIpB,EAAKc,OAAS,EACPd,EAAK,GAGT,MAGX+R,EAAS4J,2BAA6B,SAAUva,EAAIgE,GAChD,MAAMjF,EAAOV,KAEb,IAAK,IAAIqC,EAAI,EAAGA,EAAI3B,EAAK4S,QAAQlQ,KAAK/B,OAAQgB,IAC1C,GAAI3B,EAAK4S,QAAQlQ,KAAKf,GAAGV,IAAMA,KAAQgE,GAAaA,GAAYjF,EAAK4S,QAAQlQ,KAAKf,GAAGsD,WAAaA,GAC9F,OAAOjF,EAAK4S,QAAQlQ,KAAKf,IAIrCiQ,EAASwE,SAAW,WAEhB,OADW9W,KACCsU,cAGhBhC,EAAS6J,YAAc,WAInB,OAHWnc,KAGCiU,MAAM3C,UAGtBgB,EAAS8J,SAAW,WAChB,IAAI1b,EAAOV,KAEXU,EAAKoW,WAAW1F,KAAK,SAAU2F,GAC3B,IAAIzF,EAAWyF,EAAEzF,SAASvM,QAC1BgS,EAAEsF,gBAEF3b,EAAKqC,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAMwQ,eAAiBrI,MAAO8C,EAAG5S,QAASmN,IAErE,IAAK,IAAIjP,EAAI,EAAGA,EAAI3B,EAAK2U,eAAehU,OAAQgB,IACxC0U,EAAE3U,eAAe1B,EAAK2U,eAAehT,YAC9B0U,EAAErW,EAAK2U,eAAehT,OAK7CiQ,EAASiK,kBAAoB,WACzB,IAAI7b,EAAOV,KAEXC,GAAGuc,MAAMhH,OAASvV,GAAGuc,MAAMhH,WAC3B9U,EAAK+b,uBAAyB,IAAI/L,QAAQ,SAAUC,EAASC,GACzD,GAAI3Q,GAAGuc,MAAMhH,OAAOkH,eAChB/L,EAAQ1Q,GAAGuc,MAAMhH,OAAOkH,oBAEvB,CACD,IAAInc,EAAOG,EAAKiH,oBAAoB1H,GAAG4F,OAAOoD,WAAW+D,WAEzD,KAAIzM,EAAK6M,cAAgB7M,EAAK6M,aAAajM,aAAeZ,EAAK6M,aAAaC,eAAiB9M,EAAK6M,aAAaE,YAsD3G,MAAM,IAAItM,MAAM,mDAA+CT,EAAKO,SAAW,qCArD/E,IAAIiJ,GACAC,QAAS,aACTC,QAAS,MACTM,SAAUhK,EAAK6M,aAAajM,YAC5BgJ,QAAS5J,EAAK6J,QACdS,aAActK,EAAK6M,aAAaC,cAAgB,IAAM9M,EAAK6M,aAAaE,WACxEjD,aAAc9J,EAAKqF,cAEnBrF,EAAK6F,gBACL2D,EAAOQ,SAAWhK,EAAK6F,cAAgB,IAAM2D,EAAOQ,UAExD,IAAIyB,EAAMzL,EAAKyL,IAAM,IAAMpL,EAAEmK,MAAMhB,GACnC9J,GAAG+Q,MACChF,IAAKA,EACLiF,OAAQ,MACRC,aAAc,SACfE,KAAK,SAAUhO,GACd,IAUIkO,GATA/Q,EAAKqF,eAAiB3F,GAAG4F,OAAOC,OAAOC,KAC9B,IAAI9F,GAAG+F,KAAKC,OAAOF,KAGnB,IAAI9F,GAAG+F,KAAKC,OAAOC,KACxBC,UAAW5F,EAAK6M,aAAahH,cAC7BjF,YAAaZ,EAAK6M,aAAajM,eAGjBkF,KAAKjD,GAC3BnD,GAAGuc,MAAMhH,OAAOkH,kBAChB,IAAK,IAAIra,EAAI,EAAGA,EAAIiP,EAASjQ,OAAQgB,IAAK,CACtC,IAAI8B,EAAUmN,EAASjP,GACvBpC,GAAGuc,MAAMhH,OAAOkH,eAAe1Y,MAAOvB,MAAO0B,EAAQf,KAAK7C,EAAK6M,aAAaC,eAAgB1L,GAAIwC,EAAQf,KAAK7C,EAAK6M,aAAaE,cAGnIrN,GAAGuc,MAAMhH,OAAOkH,eAAepC,KAAK,SAAU/W,EAAGC,GAW7C,OATID,EAAEd,MAAQe,EAAEf,OACF,EAELc,EAAEd,MAAQe,EAAEf,MACR,EAGA,IAKjBkO,EAAQ1Q,GAAGuc,MAAMhH,OAAOkH,kBACzBnL,MAAM,WACLZ,SAOhB,OAAOjQ,EAAK+b,wBAGhBnK,EAAShE,eAAiB,SAAU/H,GAChC,MAAM7F,EAAOV,KACb,OAAO,IAAI0Q,QAAQ,SAAUC,EAASC,GAClC,IAAIpH,EAAQjD,EAAQiD,MAAM,IAAId,OAAO,IAAM9H,EAAE8C,KAAKhD,EAAK2L,WAAWlE,eAAiB,eAAiBzH,EAAKoR,SAAW,8BAAgClR,EAAE8C,KAAKhD,EAAK4L,WAAWnE,eAAiB,eAAiBzH,EAAKqR,SAAW,qBACzNvI,IACAjD,EAAUiD,EAAM,GAAK,IAAMA,EAAM,KAGrCA,EAAQjD,EAAQiD,MAAM,IAAId,OAAO,IAAM9H,EAAE8C,KAAKhD,EAAK8L,UAAUrE,eAAiB,0CAA4CvH,EAAE8C,KAAKhD,EAAK6L,UAAUpE,eAAiB,wCAE7J5B,EAAUiD,EAAM,GAAK,IAAMA,EAAM,IAGrC,GAAI,KAAKxB,KAAKzB,KAAa,IAAImC,OAAO,WAAahI,EAAKoR,SAAW,qCAAuCpR,EAAKqR,SAAW,oBAAoB/J,KAAKzB,IAAY,2DAA2DyB,KAAKzB,IAAW,CAEtO,IADAiD,EAAQ,2DAA2DJ,KAAK7C,MAC1DiD,EAAM,GAAG5H,QAAQ,MAAQ,GAAK4H,EAAM,GAAG5H,QAAQ,MAAQ,GAAI,CACrE4H,EAAM,GAAKA,EAAM,GAAGvB,QAAQ,IAAK,KACjCuB,EAAM,GAAKA,EAAM,GAAGvB,QAAQ,IAAK,KAEjC1B,EAAUiD,EAAM,GAAK,IAAMA,EAAM,GAGrC,IAAKA,GAASA,IAAWA,EAAM,GAAG5H,QAAQ,MAAQ,EAAI4H,EAAM,GAAGvB,QAAQ,IAAK,KAAOuB,EAAM,KAAO,MAAUA,EAAM,GAAG5H,QAAQ,MAAQ,EAAI4H,EAAM,GAAGvB,QAAQ,IAAK,KAAOuB,EAAM,KAAO,GAAK,CAGlL,IADAA,EAAQ,IAAId,OAAO,WAAahI,EAAKoR,SAAW,qCAAuCpR,EAAKqR,SAAW,oBAAoB3I,KAAK7C,MAClHiD,EAAM,GAAG5H,QAAQ,MAAQ,GAAK4H,EAAM,GAAG5H,QAAQ,MAAQ,GAAI,CACrE4H,EAAM,GAAKA,EAAM,GAAGvB,QAAQ,IAAK,KACjCuB,EAAM,GAAKA,EAAM,GAAGvB,QAAQ,IAAK,KAEjC1B,EAAUiD,EAAM,GAAK,IAAMA,EAAM,GAIrCjD,EAAUA,EAAQ0B,QAAQvH,EAAK2L,WAAY,IAAIpE,QAAQvH,EAAK4L,WAAY,IAAIrE,QAAQvH,EAAK6L,UAAW,IAAItE,QAAQvH,EAAK8L,UAAW,IAChI,IAAImQ,EAAS1c,GAAG2c,KAAKC,YAAYtW,GACjC,GAAIoW,EAAQ,CACR,IAAIG,EAASH,EAAO,GAAG7U,MACnBiV,EAASJ,EAAO,GAAG7U,MACnBkV,EAAUL,EAAO,GAAGpc,OAASN,GAAG4F,OAAOoX,IAAOvc,EAAKuL,KAAOvL,EAAK0L,IAC/D8Q,EAAUP,EAAO,GAAGpc,OAASN,GAAG4F,OAAOoX,IAAOvc,EAAKwL,KAAOxL,EAAKyL,IAC/DxK,EAAKqb,EAASF,EAASI,EAASH,EAEhCxN,EAAQ7O,EAAKyc,SAASxb,GAC1B,GAAI4N,IAAU7O,EAAK0c,YAAY7N,GAAQ,CACnCuN,EAASH,EAAO,GAAG7U,MACnBiV,EAASJ,EAAO,GAAG7U,MAGnBnG,GAFAqb,EAAUL,EAAO,GAAGpc,OAASN,GAAG4F,OAAOoX,IAAOvc,EAAKuL,KAAOvL,EAAK0L,KAEjD0Q,GADdI,EAAUP,EAAO,GAAGpc,OAASN,GAAG4F,OAAOoX,IAAOvc,EAAKwL,KAAOxL,EAAKyL,KAC/B4Q,EAChCxN,EAAQ7O,EAAKyc,SAASxb,GAG1B,GAAI4N,EAAO,CACP7O,EAAKqM,qBAAqB9M,GAAG4F,OAAOoD,WAAWoF,aAAa5L,MAAQ,qCAAqCuF,KAAKrG,GAAMjB,EAAKkC,gBAAgB,+BAAiClC,EAAKqC,IAAIsa,IAAM3c,EAAKkC,gBAAgB,+BAG9M+N,IACIhP,GAAIA,EAAIc,MAAO/B,EAAK4c,SAAS3b,GAAKgE,SAAU1F,GAAG4F,OAAOoD,WAAWoF,oBAKrEsC,WAIJA,WAIJA,WAIJA,SAKZ2B,EAAStE,gBAAkB,SAAUzH,GACjC,MAAM7F,EAAOV,KACb,OAAO,IAAI0Q,QAAQ,SAAUC,EAASC,GAClC,IAAIpH,EAAQjD,EAAQiD,MAAM,IAAId,OAAO9H,EAAE8C,KAAKhD,EAAKkM,UAAUzE,eAAiB,kBAAoBvH,EAAE8C,KAAKhD,EAAKmM,UAAU1E,eAAiB,wBAA0BvH,EAAE8C,KAAKhD,EAAKoM,UAAU3E,eAAiB,mBACpMqB,IACAjD,EAAUiD,EAAM,GAAK,KAAOA,EAAM,GAAK,KAAOA,EAAM,IAGxD,IAAI+T,EAAWhX,GACT,2CAA2CyB,KAAKzB,IAAa7F,EAAKiH,oBAAoB1H,GAAG4F,OAAOoD,WAAW+D,WAAWC,iBACxHsQ,EAAW7c,EAAKiH,oBAAoB1H,GAAG4F,OAAOoD,WAAW+D,WAAWC,eAAiB,KAAO1G,GAE5F,2CAA2CyB,KAAKuV,KAAe,IAAI7U,OAAO,WAAahI,EAAKoR,SAAW,uBAAyBpR,EAAKqR,SAAW,OAAO/J,KAAKzB,GAC5J7F,EAAK6b,oBAAoBnL,KAAK,SAAUsE,GACpC,IAAIlM,EAAQ,2CAA2CJ,KAAKmU,GAC5D,GAAI/T,EAAO,CACP,IAAIgU,EAAU,IAAI9U,OAAO9H,EAAE8C,KAAK8F,EAAM,IAAIvB,QAAQ,2BAA4B,QAAS,KACnF5E,KAEJ,MAAMoa,EAAU,SAAUC,EAAKC,EAAUC,EAAKC,GAC1C,IAAItZ,KAEJA,EAAWP,KAAKtD,EAAK+L,KAAOiR,EAC5BnZ,EAAWP,KAAKtD,EAAKgM,KAAOkR,EAC5BrZ,EAAWP,KAAKtD,EAAKiM,KAAOkR,EAE5B,OACIlc,GAAIjB,EAAK+L,IAAMiR,EAAMhd,EAAKgM,IAAMkR,EAAMld,EAAKiM,IAAMkR,EACjDpb,MAAO/B,EAAK4c,SAAS5c,EAAK+L,IAAMkR,EAAWjd,EAAKgM,IAAMkR,EAAMld,EAAKiM,IAAMkR,GACvElY,SAAU1F,GAAG4F,OAAOoD,WAAW+D,UAC/BzI,WAAYA,IASpB,IALAlB,EAAUzC,EAAEkd,KAAKpI,EAAM,SAAU5N,GAC7BA,EAAQA,EAAMrF,OAASqF,EAAMnG,IAAMmG,EACnC,OAAO0V,EAAQxV,KAAKF,IAAU0V,EAAQxV,KAAKtH,EAAKqd,kBAAkBjW,OAG1DzG,OAAS,EACjB,IAAK,IAAIgB,EAAI,EAAGA,EAAIgB,EAAQhC,OAAQgB,IAChCgB,EAAQhB,GAAKob,EAAQpa,EAAQhB,GAAGV,GAAI0B,EAAQhB,GAAGI,MAAO7B,EAAE8C,KAAK8F,EAAM,IAAK5I,EAAE8C,KAAK8F,EAAM,KAI7F,GAAI,YAAYxB,KAAKwB,EAAM,IAAK,CAE5B,GAAIA,EAAM,GAAG9F,SAAWhD,EAAKiH,oBAAoB1H,GAAG4F,OAAOoD,WAAW+D,WAAWC,eAAgB,CAE7F,IAAIA,EAAiByI,EAAKhQ,OAAO,SAAU1C,GACvC,OAAOgX,SAAShX,EAAIrB,MAAQqY,SAAStZ,EAAKiH,oBAAoB1H,GAAG4F,OAAOoD,WAAW+D,WAAWC,kBAC/F,GAECA,GACA0D,GAAS8M,EAAQxQ,EAAetL,GAAIsL,EAAexK,MAAO7B,EAAE8C,KAAK8F,EAAM,IAAK5I,EAAE8C,KAAK8F,EAAM,OAIjGnG,EAAQW,KAAKyZ,EAAQ7c,EAAE8C,KAAK8F,EAAM,IAAK5I,EAAE8C,KAAK8F,EAAM,IAAK5I,EAAE8C,KAAK8F,EAAM,IAAK5I,EAAE8C,KAAK8F,EAAM,MAI5FmH,EAAQtN,MAKhBsN,SAKZ2B,EAAStD,0BACLgP,IAAK,SAAU3Y,EAAMgO,EAAQvM,EAAMC,GAE/B,IAAIyC,EAAQ,6PAAyNJ,KAAK/D,GAC1O,GAAImE,GAASA,EAAM,IAAMA,EAAM,GAAI,CAE/B,IAAIyU,EAAY,WACZ,OAAOC,GAAoB1U,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAI9F,SAG7E,GAAI,eAAesE,KAAKwB,EAAM,GAAG9F,SAAW,eAAesE,KAAKwB,EAAM,GAAG9F,QAAS,CAC9E2P,EAAOrP,MACHqF,EAAGG,EAAM,GAAG9F,OAAQ4F,EAAGE,EAAM,GAAG9F,OAAQyB,EAAG8Y,MAE/C5K,EAAOrP,MACHqF,EAAGG,EAAM,GAAG9F,OAAQ4F,EAAGE,EAAM,GAAG9F,OAAQyB,EAAG8Y,UAI3C,eAAejW,KAAKwB,EAAM,GAAG9F,QAAS2P,EAAOrP,MAC7CqF,EAAGG,EAAM,GAAG9F,OAAQ4F,EAAGE,EAAM,GAAG9F,OAAQyB,EAAG8Y,MAE1C5K,EAAOrP,MACRsF,EAAGE,EAAM,GAAG9F,OAAQ2F,EAAGG,EAAM,GAAG9F,OAAQyB,EAAG8Y,MAGnDE,EAAStb,KAAK7C,KAAMqT,EAAQvM,EAAMC,GAClC,OAAO,EAGX,OAAO,GAEXqX,IAAK,SAAU/Y,EAAMgO,EAAQvM,EAAMC,GAE/B,IAAIyC,EAAQ,6PAAyNJ,KAAK/D,GAC1O,GAAImE,GAASA,EAAM,IAAMA,EAAM,GAAI,CAE/B,IAAIyU,EAAY,WACZ,OAAOC,GAAoB1U,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAI9F,SAG7E,GAAI,eAAesE,KAAKwB,EAAM,GAAG9F,SAAW,eAAesE,KAAKwB,EAAM,GAAG9F,QAAS,CAC9E2P,EAAOrP,MACHqF,EAAGG,EAAM,GAAG9F,OAAQ4F,EAAGE,EAAM,GAAG9F,OAAQyB,EAAG8Y,MAE/C5K,EAAOrP,MACHqF,EAAGG,EAAM,GAAG9F,OAAQ4F,EAAGE,EAAM,GAAG9F,OAAQyB,EAAG8Y,UAI3C,eAAejW,KAAKwB,EAAM,GAAG9F,QAAS2P,EAAOrP,MAC7CqF,EAAGG,EAAM,GAAG9F,OAAQ4F,EAAGE,EAAM,GAAG9F,OAAQyB,EAAG8Y,MAE1C5K,EAAOrP,MACRsF,EAAGE,EAAM,GAAG9F,OAAQ2F,EAAGG,EAAM,GAAG9F,OAAQyB,EAAG8Y,MAGnDE,EAAStb,KAAK7C,KAAMqT,EAAQvM,EAAMC,GAClC,OAAO,EAGX,OAAO,GAEXsX,KAAM,SAAUhZ,EAAMgO,EAAQvM,EAAMC,GAEhC,IAAIyC,EAAQ,6PAAyNJ,KAAK/D,GAE1O,GAAImE,GAASA,EAAM,IAAMA,EAAM,GAAI,CAC/B6J,EAAOrP,MACHqF,EAAGG,EAAM,GAAG9F,OAAQ4F,EAAGE,EAAM,GAAG9F,OAAQyB,EAAG+Y,GAAoB1U,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAI9F,UAEjHya,EAAStb,KAAK7C,KAAMqT,EAAQvM,EAAMC,GAClC,OAAO,EAGX,OAAO,GAEXuX,GAAI,SAAUjZ,EAAMgO,EAAQvM,EAAMC,GAE9B,IAAIyC,EAAQ,+GAA2EJ,KAAK/D,GAG5F,IAAKmE,GAAS,aAAaxB,KAAK3C,EAAK3B,QAAS,CAC1C,IAAIgV,EAAWrT,EAAKP,MAAM,KAAKyZ,UAC/B/U,EAAQ,+GAA2EJ,KAAKsP,EAASxV,KAAK,MAG1G,GAAIsG,GAASA,EAAM,IAAMA,EAAM,GAAI,CAE/B,GAAI,eAAexB,KAAKwB,EAAM,GAAG9F,SAAW,eAAesE,KAAKwB,EAAM,GAAG9F,QAAS,CAC9E2P,EAAOrP,MACHqF,EAAGG,EAAM,GAAG9F,OAAQ4F,EAAGE,EAAM,GAAG9F,SAEpC2P,EAAOrP,MACHsF,EAAGE,EAAM,GAAG9F,OAAQ2F,EAAGG,EAAM,GAAG9F,SAGpCya,EAAStb,KAAK7C,KAAMqT,EAAQvM,EAAMC,OAEjC,CAED,IAAIyX,EAAY,SAAUlV,GAItB,IAHA,IAAImV,EAAOnV,EAAExE,MAAM,KAAKyZ,UAEpBG,KACKC,EAAK,EAAGA,EAAKF,EAAKpd,OAAQsd,IAC/B,GAAuB,GAAnBF,EAAKE,GAAItd,OAAa,CACtBqd,EAAG1a,KAAKya,EAAKE,IACbF,EAAKE,GAAM,GAInB,OAAOD,EAAGrd,OAAS,EAAIod,EAAKF,UAAUrb,KAAK,KAAKQ,OAAShD,KAAK6G,cAAgBmX,EAAGH,UAAUrb,KAAKxC,KAAK6G,eAAiBkX,EAAKF,UAAUrb,KAAK,KAAKQ,QAG/I,eAAesE,KAAKwB,EAAM,GAAG9F,QAC7B2P,EAAOrP,MACHqF,EAAGG,EAAM,GAAG9F,OAAQ4F,EAAGkV,EAAUhV,EAAM,GAAG9F,UAE7C2P,EAAOrP,MACRsF,EAAGkV,EAAUhV,EAAM,GAAG9F,QAAS2F,EAAGG,EAAM,GAAG9F,SAG/Cya,EAAStb,KAAK7C,KAAMqT,EAAQvM,EAAMC,GAAO,GAG7C,OAAO,EAGX,OAAO,GAEXmU,GAAI,SAAU7V,EAAMgO,EAAQvM,EAAMC,GAE9B,IAAIyC,EAAQ,8GAA0EJ,KAAK/D,GAE3F,IAAKmE,EAAO,CACR,IAAIkP,EAAWrT,EAAKP,MAAM,KAAKyZ,UAC/B/U,EAAQ,+GAA2EJ,KAAKsP,EAASxV,KAAK,MAG1G,GAAIsG,EAAO,CAIP,IAHA,IAAIpG,KAGKf,GADLqW,EAAWrT,EAAKP,MAAM,KAAKyZ,UAClB,GAAGlc,EAAIqW,EAASrX,OAAQgB,IACjC,GAAI,iBAAiB2F,KAAK0Q,EAASrW,GAAGqB,QAClCN,EAAKiG,EAAIqP,EAASrW,GAAGqB,YAEpB,GAAI,YAAYsE,KAAK0Q,EAASrW,GAAGqB,QAClC,IAAwC,GAApCgV,EAASrW,GAAGqB,OAAO9B,QAAQ,KAC3BwB,EAAKkG,EAAIoP,EAASrW,GAAGqB,WAClB,CAcH,IAbA,IAAIkb,EAAYlG,EAASrW,GAAGqB,OAAOoB,MAAM,KAAKyZ,UAE1CM,EAAW,SAAUC,GAErB,GADQ,yIAAyI1V,KAAK0V,EAAEpb,QACjJ,CACHN,EAAK+B,EAAI+Y,EAAmBY,EAAEpb,QAC9B,OAAO,EAEX,OAAO,GAGPqb,EAAI,EACJ5Z,EAAIyZ,EAAUG,GAAGrb,OACdqb,EAAIH,EAAUvd,SAAWwd,EAAS1Z,MACrC4Z,EACQH,EAAUvd,SACd8D,GAAQyZ,EAAUG,IAI1B,GAAI3b,EAAK+B,EAAG,CAER,IADA,IAAI6Z,EAAMJ,EACD1L,EAAI,EAAGA,EAAI8L,EAAI3d,OAAQ6R,IAAK,CAGjC,IADA,IAAI+L,GAAW,EACNH,EAAI,EAAGA,EAAIE,EAAI9L,GAAGpO,MAAM,IAAIzD,OAAQyd,IACrC1b,EAAK+B,EAAEvD,QAAQod,EAAI9L,GAAG4L,KAAO,IAC7BG,GAAW,GAGnB,GAAIA,EAAU,CACDD,EAAI9L,GAEb8L,EAAI9L,GAAK,GACT,GAAI9P,EAAK+B,GAAK+Y,EAAmB/Y,GAC7B,OAIZ,GAAI,mFAA+C6C,KAAK4W,EAAUL,UAAUrb,KAAK,KAAKQ,QAAS,CAG3F,IAFA,IAAIgb,KACAQ,EAAcN,EAAUL,UACnBY,EAAM,EAAGA,EAAMD,EAAY7d,OAAQ8d,IACxC,GAAsC,GAAlCD,EAAYC,GAAKzb,OAAOrC,OAAa,CACrCqd,EAAG1a,KAAKkb,EAAYC,GAAKzb,QACzBwb,EAAYC,GAAO,GAI3B/b,EAAKkG,EAAIoV,EAAGrd,OAAS,EAAI6d,EAAYX,UAAUrb,KAAK,KAAKQ,OAAShD,KAAK6G,cAAgBmX,EAAGH,UAAUrb,KAAKxC,KAAK6G,eAAiB2X,EAAYX,UAAUrb,KAAK,KAAKQ,OAMnK2P,EAAOrP,MACHqF,EAAGjG,EAAKiG,EACRC,EAAGlG,EAAKkG,EAAI,IAAMlG,EAAK+B,SAG3B/B,EAAKkG,EAAIoP,EAASrW,GAAGqB,OAMrC2P,EAAOrP,KAAKZ,GACZ+a,EAAStb,KAAK7C,KAAMqT,EAAQvM,EAAMC,GAClC,OAAO,EAGX,OAAO,GAEXkI,OAAQ,SAAU5J,EAAMgO,EAAQvM,EAAMC,GAClC,IAAIyC,EAAQ,uFAAmDJ,KAAK/D,GACpE,GAAImE,GAASA,EAAM,GAAI,CACnB,GAAI1C,EAAM,CACNuM,EAAOrP,MACHqF,EAAGG,EAAM,GAAG9F,SAGhB2P,EAAOrP,MACHqF,EAAGvC,EACHwC,EAAGE,EAAM,GAAG9F,cAGf2P,EAAOrP,MACRqF,EAAGG,EAAM,GAAG9F,SAEhB,OAAO,EAGX,OAAO,GAEX0b,GAAI,SAAU/Z,EAAMgO,EAAQvM,EAAMC,GAC9B,IAAIyC,EAAQ,0NAAsLJ,KAAK/D,GACvM,GAAImE,GAASA,EAAM,IAAMA,EAAM,GAAI,CAC3B1C,EACAuM,EAAOrP,MACHqF,EAAGvC,EACHwC,EAAGE,EAAM,GAAG9F,OACZyB,EAAG+Y,EAAmB1U,EAAM,GAAG9F,UAGnC2P,EAAOrP,MACHqF,EAAGG,EAAM,GAAG9F,OACZ4F,EAAGE,EAAM,GAAG9F,SAGpB,OAAO,EAGX,OAAO,GAEX2b,IAAK,SAAUha,EAAMgO,EAAQvM,EAAMC,GAC/B,IAAIyC,EAAQ,wKAAwKJ,KAAK/D,GACzL,GAAImE,GAASA,EAAM,IAAMA,EAAM,IAAM1C,EAAM,CACvCuM,EAAOrP,MACHqF,EAAGvC,EACHwC,EAAGE,EAAM,GAAG9F,OACZyB,EAAG+Y,EAAmB1U,EAAM,GAAG9F,UAEnC,OAAO,EAGX,OAAO,IAMf,MAeMwa,EAAqB,SAAUpW,GA+DjC,IA9DA,IA2DIwX,GAzDU,SAAUxX,GACpB,MAAO,yDAAyDE,KAAKF,IAgB7D,SAAUA,GAClB,MAAO,oCAAoCE,KAAKF,IAgBxC,SAAUA,GAClB,MAAO,yBAAyBE,KAAKF,IAW5B,SAAUA,GACnB,MAAO,oCAAoCE,KAAKF,KAWhDyX,GAvDO,SAAUzX,GACjB,IAAIc,KACA4W,EAAI,yDAAyDpW,KAAKtB,GACtE,GAAI0X,EAAG,CACH,IAAK,IAAInd,EAAI,EAAGA,EAAImd,EAAEne,OAAQgB,IACtBmd,EAAEnd,GAAGqB,OAAOrC,OAAS,GACrBuH,EAAE5E,KAAKwb,EAAEnd,GAAGqB,QAGpB,OAAOkF,EAAE1F,KAAKxC,KAAK6G,eAEvB,OAAOO,GAMF,SAAUA,GACf,IAAIc,KACA4W,EAAI,oCAAoCpW,KAAKtB,GACjD,GAAI0X,EAAG,CACH,IAAK,IAAInd,EAAI,EAAGA,EAAImd,EAAEne,OAAQgB,IACtBmd,EAAEnd,GAAGqB,OAAOrC,OAAS,GACrBuH,EAAE5E,KAAKwb,EAAEnd,GAAGqB,QAGpB,OAAOkF,EAAE1F,KAAKxC,KAAK6G,eAEvB,OAAOO,GAMF,SAAUA,GAEf,MADQ,yBAAyBsB,KAAKtB,GAE3B,MAEJA,GAOD,SAAUA,GACR,oCAAoCsB,KAAKtB,GACjD,OACWA,IAOX2X,EAAK,EACFA,EAAKF,EAAMle,SAAWie,EAAQG,GAAI5c,KAAKnC,KAAMoH,IAChD2X,IAGJ,OAAIA,EAAKF,EAAMle,OACJke,EAAME,GAAI5c,KAAKnC,KAAMoH,GACpBA,GAGVqW,EAAW,SAAU9K,EAAQvM,EAAMC,EAAO2Y,GAC5C,MAAMhf,EAAOV,KAEb,GAAI8G,EAEA,IADA,IAAIzE,EAAIgR,EAAOhS,OACRgB,KACH,GAAKqd,EAwBDrM,EAAOrP,KAAKpD,EAAEC,UAAWwS,EAAOhR,IAAMgH,EAAGvC,UAvBzC,GAAIuM,EAAOhR,GAAGgH,EAAG,CACb,IAAIsW,EAAgBjf,EAAKkG,QAAQC,OAAOgK,UAAUnL,OAAO,SAAUqL,GAC/D,OAAOA,EAAKtO,MAAMb,QAAQlB,EAAKqd,kBAAkB1K,EAAOhR,GAAGgH,GAAGlB,gBAAkB,GAClF2G,KAAKpO,IAEqB,GAAxBif,EAActe,OACdgS,EAAOhR,GAAGgH,EAAIsW,EAAc,GAAGhe,GACxBge,EAActe,OAAS,EAE9Bse,EAAc5c,IAAI,SAAUgO,GACxB,IAAI6O,EAAYhf,EAAEC,UACfwS,EAAOhR,IACVud,EAAUvW,EAAI0H,EAAKpP,GAEnB0R,EAAOrP,KAAK4b,KAGe,GAAxBD,EAActe,QAAe0F,GACpCsM,EAAOwM,OAAOxd,EAAG,KAWnCyd,EAA8B,SAAUC,EAAc1a,GACxD,MAAM3E,EAAOV,KACP8G,EAAOpG,EAAKkG,QAAQC,QAAUnG,EAAKkG,QAAQC,OAAOC,MAAQ,GAC1DC,EAAQrG,EAAKkG,QAAQC,QAAUnG,EAAKkG,QAAQC,OAAOE,QAAS,EAElE,IAAIsM,KAsBgC,MAHpChO,EAAOA,EAAK3B,QAGHsc,OAAO3a,EAAKhE,OAAS,KAC1BgE,EAAOA,EAAKoE,UAAU,EAAGpE,EAAKhE,OAAS,IAG3C,GAxBa,WAQT,IAPA,IAAI4e,GAAS,SAAU5a,GACnB,OAAOA,EAAKhE,QAAU,GAE1B,SAAUgE,GACN,OAAO,QAAQ2C,KAAK3C,KAAiB,gBAAgB2C,KAAK3C,KAGrDhD,EAAI,EAAGA,EAAI4d,EAAM5e,OAAQgB,IAC9B,IAAK4d,EAAM5d,GAAGQ,KAAKnC,EAAM2E,GACrB,OAAO,EAGf,OAAO,EAWP2C,GAAY,CACZ,IAAIuX,KAUJ,GAAqB,KARrBA,EAAQQ,EAAahd,IAAI,SAAU4C,GAC/B,OAAOjF,EAAKiH,oBAAoBhC,KACjCD,OAAO,SAAUuD,GAChB,OAAOA,EAAW8F,uBACnBhM,IAAI,SAAUkG,GACb,OAAOA,EAAW8F,wBAGZ1N,OAAc,CACpBke,GAAS7e,EAAKsO,yBAAyBgP,IAAKtd,EAAKsO,yBAAyBoP,IAAK1d,EAAKsO,yBAAyBqP,KAAM3d,EAAKsO,yBAAyBsP,GAAI5d,EAAKsO,yBAAyBkM,IAE/KqE,EADAzY,GAAQzB,EAAKP,MAAM,KAAKzD,OAAS,GACxBX,EAAKsO,yBAAyBoQ,GAAI1e,EAAKsO,yBAAyBqQ,IAAK3e,EAAKsO,yBAAyBC,QAAQxN,OAAO8d,GAGnHA,EAAM9d,QAAQf,EAAKsO,yBAAyBoQ,GAAI1e,EAAKsO,yBAAyBqQ,IAAK3e,EAAKsO,yBAAyBC,SAIjI,IAAIwQ,EAAK,EACT,IACI,KAAOA,EAAKF,EAAMle,SAAWke,EAAME,GAAI5c,KAAKnC,EAAM2E,EAAMgO,EAAQvM,EAAMC,IAClE0Y,IAGR,MAAOS,GACHjgB,GAAGkgB,MAAM,gCAA4B9a,EAAMpF,GAAG4F,OAAOua,aAAaC,MAAO,yCAG7E,OAAOhN,EAGX,OAAO,MAwBLiN,EAAoB,SAAUP,EAAcpP,EAASC,EAAQ2P,GAC/D,MAAM7f,EAAOV,KAEb,GAAIugB,EAAgB,CAChB,IAAIld,KAEJ3C,EAAK4S,QAAQlQ,KAAOC,EAEf3C,EAAK8f,UACN9f,EAAK8f,YAGTD,EAAerc,QAAQ,SAAUd,EAAMf,GAEnC0d,EAAara,OAAO,SAAU1C,GAC1B,IAAIzC,EAAOG,EAAKiH,oBAAoB3E,GACpC,OAAOyH,OAAOgW,KAAKlgB,EAAK4G,iBAAiB9F,SAAWoJ,OAAOgW,KAAKrd,GAAM/B,SACvE0B,IAAI,SAAU4C,GACb,IAAIpF,EAAOG,EAAKiH,oBAAoBhC,GACpCjF,EAAK8f,QAAQxc,KAxCR,SAAUzD,EAAMmgB,EAActd,GAClCpD,KAER4V,YAAY+K,UAAY,oDAFhB3gB,KAE2E4C,gBAAgB,aAAe,qFAF1G5C,KAGRyV,UAAUyB,cAAc,IAAI0J,YAAY,+BAC7C,OAAO3gB,GAAG+Q,MACNhF,IAAKzL,EAAKyL,IACViF,OAAQ,OAERC,aAAc,OACd9N,KAAM7C,EAAKmF,OAAOmE,UAAUzG,KAE3BgO,KAAKsP,GACLnP,MAAM,SAAUnO,GACW,UAApBA,EAAKyd,YACLC,MAAM,YAyByBje,KAAKnC,EAAMH,EAAM,SAAU6C,GACtDC,EAAUA,EAAQ5B,OAAOlB,EAAK4C,0BAA0BC,KACzDA,QAIXsN,QAAQqQ,IAAIrgB,EAAK8f,SAASpP,KAAK,WAG3BT,EAAQtN,UAIZsN,OAIR2B,EAASzD,iBAAmB,SAAUkR,EAAcxZ,GAChD,MAAM7F,EAAOV,KAEb,OAAO,IAAI0Q,QAAQ,SAAUC,EAASC,GAClCrK,EA5PmB,SAAUuB,GAKjCA,EAJa9H,KAIA+d,kBAAkBjW,GAO/B,OAHIA,EARS9H,KAOJiS,gBAAgBC,aAAalK,KAAKF,GAC/BA,EAAMG,QARLjI,KAQkBiS,gBAAgBE,iBAAkB,IAErDrK,EAAMG,QAVLjI,KAUkBiS,gBAAgBG,SAAU,KAC5CjK,eAgPoBtF,KAAKnC,EAAM6F,GAMxC,IAAIya,EAAmB,eAAe5X,KAAK7C,GAC3C,GAAIya,GAAoBA,EAAiB3f,OAAS,EAAG,CAGjD,IAAIkf,EAAiBT,EAA4Bjd,KAAKnC,EAAMqf,EAAciB,EAAiB,IAGvFC,EAAoBnB,EAA4Bjd,KAAKnC,EAAMqf,EAAciB,EAAiB,GAAK,IAAMA,EAAiB,IAE1HC,GAAqBA,OAAyBxf,OAAO8e,OAErDD,EAAkBzd,KAAKnC,EAAMqf,EAAcpP,EAASC,EAAQqQ,OACzD,CACCV,EAAiBT,EAA4Bjd,KAAKnC,EAAMqf,EAAcxZ,GAE1E+Z,EAAkBzd,KAAKnC,EAAMqf,EAAcpP,EAASC,EAAQ2P,OAKxEjO,EAASlC,QAAU,SAAU7J,GACzB,MAAM7F,EAAOV,KACb,OAAO,IAAI0Q,QAAQ,SAAUC,EAASC,GAElC,IADArK,EAAUA,EAAQ7C,QACNrC,OAAS,EACjBsP,UACG,CACH,IAAIpQ,EAAOG,EAAKiH,oBAAoB1H,GAAG4F,OAAOoD,WAAWkH,MAGrD3G,EADcjJ,EAAK+F,aACC8C,KAAK7C,GAC7B,GAAIiD,GAASA,EAAM,GAAI,CAEnB,IAAI+T,EAAW/T,EAAM,GAAKA,EAAM,GAAG9F,OAAS,IAAM8F,EAAM,GAAG9F,OAAS8F,EAAM,GAAG9F,OACzE8F,EAAM,IAAMA,EAAM,GAAGnI,OAAS,IAC9Bkc,EAAWA,EAAW,IAAM/T,EAAM,GAAG9F,QAGzChD,EAAKkV,YAAY+K,UAAY,oDAAsDjgB,EAAKkC,gBAAgB,aAAe,qFACvHlC,EAAK+U,UAAUyB,cAAc,IAAI0J,YAAY,+BAC7C3gB,GAAG+Q,MACChF,IAAKzL,EAAKyL,IAAM,IAAMzL,EAAKmF,OAAOmE,WAAYR,EAAGkU,IACjDtM,OAAQ,MACRC,aAAcjR,GAAG4F,OAAOsL,SAASpL,OAClCqL,KAAK,SAAUhO,GACd,IAAIiQ,KAEJ,GAAIjQ,EAAKiO,cAAgB,EAAG,CACxBjO,EAAKkO,SAASvO,IAAI,SAAUoB,GACxB,IAAII,EAAahE,EAAKiE,iBACtB,IAAK6O,EAAO6N,KAAK,SAAUnQ,GACvB,OAAQA,EAAK1L,MAAQlB,EAAQI,WAAWA,EAAW,MACnD,CACA,IAAI9B,EAAQlC,EAAKqE,kBAAkBQ,SAAS7E,EAAKiE,iBAAiBzB,IAAI,SAAUoe,GAC5E,OAAOhd,EAAQI,WAAW4c,MAG1B9b,EAAO9E,EAAKiE,iBAAiBzB,IAAI,SAAUoe,GAC3C,OAAOhd,EAAQI,WAAW4c,KAC3Bje,KAAK,KAERmQ,EAAOrP,MACHrC,GAAIpB,EAAKmE,eAAe3B,IAAI,SAAUgO,GAClC,OAAO5M,EAAQI,WAAWwM,KAC3B7N,KAAK,KACRT,MAAOA,EACP4C,KAAMA,EACNR,UAAWV,EAAQxC,GAAGmD,MAAM,KAAK,GACjCa,SAAUpF,EAAKO,cAM3B6P,EAAQ0C,QAGR1C,QAELY,MAAM,SAAUnO,GAEfuN,aAIJA,UAMhB2B,EAAS/B,MAAQ,SAAUhK,GACvB,IAAI7F,EAAOV,KACX,OAAO,IAAI0Q,QAAQ,SAAUC,EAASC,GAElC,IADArK,EAAUA,EAAQ7C,QACNrC,OAAS,EACjBsP,UACG,CAEH,IAAIpQ,EAAOG,EAAKiH,oBAAoB1H,GAAG4F,OAAOoD,WAAWqH,QAGrD9G,EADgBjJ,EAAK+F,aACC8C,KAAK7C,GAC/B,GAAIiD,GAASA,EAAM,IAAMA,EAAM,GAAI,CAE/B,IAAI+T,EAAW/T,EAAM,GAAKA,EAAM,GAAG9F,OAAS,IAAM8F,EAAM,GAAG9F,OAAS8F,EAAM,GAAG9F,OACzE8F,EAAM,IAAMA,EAAM,GAAGnI,OAAS,IAC9Bkc,EAAWA,EAAW,IAAM/T,EAAM,GAAG9F,QAGzChD,EAAKkV,YAAY+K,UAAY,oDAAsDjgB,EAAKkC,gBAAgB,aAAe,qFACvHlC,EAAK+U,UAAUyB,cAAc,IAAI0J,YAAY,+BAC7C3gB,GAAG+Q,MACChF,IAAKzL,EAAKyL,IAAM,IAAMzL,EAAKmF,OAAOmE,WAAYR,EAAGkU,EAAUjU,EAAGE,EAAM,GAAG9F,SACvEuN,OAAQ,MACRC,aAAcjR,GAAG4F,OAAOsL,SAASpL,OAClCqL,KAAK,SAAUhO,GACd,IAAIiQ,KACJ,GAAIjQ,EAAKiO,cAAgB,EAAG,CACxBjO,EAAKkO,SAASvO,IAAI,SAAUoB,GACxB,IAAII,EAAahE,EAAKiE,iBACtB,IAAK6O,EAAO6N,KAAK,SAAUnQ,GACvB,OAAQA,EAAKtO,OAAS0B,EAAQI,WAAWA,EAAW,MACpD,CACA,IAAIc,EAAO9E,EAAKqE,kBAAkBQ,SAAS7E,EAAKiE,iBAAiBzB,IAAI,SAAUoe,GAC3E,OAAOhd,EAAQI,WAAW4c,MAE9B9N,EAAOrP,MACHrC,GAAIpB,EAAKmE,eAAe3B,IAAI,SAAUgO,GAClC,OAAO5M,EAAQI,WAAWwM,KAC3B7N,KAAK,KACRT,MAAO4C,EACPA,KAAMA,EACNR,UAAWV,EAAQxC,GAAGmD,MAAM,KAAK,GACjCa,SAAUpF,EAAKO,cAK3B6P,EAAQ0C,QAGR1C,QAELY,MAAM,SAAUnO,GAEfuN,aAIJA,UAMhB2B,EAASkD,OAAS,SAAUjP,EAASgP,GACjC,IAAI7U,EAAOV,KACPqD,KAEJ,GAAI3C,EAAK8f,QAAS,CAEd,IAAK,IAAIne,EAAI,EAAGA,EAAI3B,EAAK8f,QAAQnf,OAAQgB,IACrC+e,QAAQC,IAAI,0CAIhB3gB,EAAK8f,WAIT,IADAja,EAAU3F,EAAE8C,KAAK6C,IACLlF,OAAS,EAAG,CACpBkF,EAAUA,EAAQ4B,cAElB,IAAImZ,KAYJ5gB,EAAK8Q,mBAAmBtN,QAAQ,SAAUuN,GAClCA,EAAQxL,QAZWsC,EAaRkJ,EAAQxL,OAZvBqb,EAAQtd,KAAK,IAAI0M,QAAQ,SAAUC,EAASC,GACxCrI,EAAG1F,KAAKnC,EAAM6F,GAAS6K,KAAK,SAAUiC,GAClChQ,EAAUA,EAAQ5B,OAAO4R,GACzB1C,EAAQtN,SAWZ+d,QAAQC,IAAI,gDAfH,IAAU9Y,IAmB3BmI,QAAQqQ,IAAIO,GAASlQ,KAAK,WAClB/N,IACA3C,EAAK4S,QAAQlQ,KAAOC,EAAUA,EAAQiX,KAAK,SAAU/W,EAAGC,GACpD,IACI+d,EADAhb,EAAU,QACNib,EAAK,GACb,GAAIjb,EAAQyB,KAAKzE,EAAEd,QAAU8D,EAAQyB,KAAKxE,EAAEf,OAAQ,CAChD8e,EAAKhe,EAAEd,MAAM+G,MAAMjD,GAAS,GAC5Bib,EAAKhe,EAAEf,MAAM+G,MAAMjD,GAAS,OACzB,CACHgb,EAAKhe,EAAEd,MACP+e,EAAKhe,EAAEf,MAGX,OAAI8e,EAAKC,EACE,EAEHD,EAAKC,GACG,EAED,GACjB1S,KAAKpO,KAEP6U,GACAA,EAASlS,GAEb,GAAuB,IAAnBA,EAAQhC,OAAc,CACtBX,EAAK0b,WAEL,IAAK1b,EAAKuT,OACLvT,EAAKuT,OAAwC,IAA/BvT,EAAKuT,MAAM3C,SAASjQ,OAAe,CAClDX,EAAKkV,YAAY+K,UAAY,iBAAmBjgB,EAAKyU,oBAAsB,oCAAsCzU,EAAKwU,oBAAsB,YAC5IxU,EAAK+U,UAAUyB,cAAc,IAAI0J,YAAY,gCAIrDlgB,EAAK2V,YAAc,UAGtB3V,EAAK0b,YAad9J,EAASqD,YAAc,SAAUhU,EAAIgE,GACjC,IAAIjF,EAAOV,KACPiO,EAAO,KACX,OAAO,IAAIyC,QAAQ,SAAUC,EAASC,GAC7BlQ,EAAK+gB,UACN/gB,EAAK+gB,QAAU/gB,EAAKqC,IAAI2e,mBAAmB,+BAA+B,IAE9E,IAAIC,EACJA,EAAOjhB,EAAK+gB,QAAQG,UAGpB,GAAIC,UAAUC,GAAG,qBAAsB,CACnCphB,EAAK+U,UAAUsM,OACfrhB,EAAKqC,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAMC,YAGrCrL,EAAK0b,WAEL,IAAI4F,GAAmB,EACnBC,GAAgB,EAEpBvhB,EAAK8Q,mBAAmBtN,QAAQ,SAAUuN,GACtC,GAAIwQ,EAEA,GAAKvhB,EAAKqM,qBAAqB0E,EAAQ3Q,UAWhC,CAEH,IAAIohB,EAAKvc,GAAYjF,EAAKwb,2BAA2BrZ,KAAKnC,EAAMiB,GAAIgE,SACpE,GAAIuc,EAAI,CAEJ,IAAIjZ,EAAavI,EAAKiH,oBAAoBua,GAE1C,GAAIxhB,EAAKqM,qBAAqBmV,IAAOjZ,GAAcA,EAAWgF,KAE7C,QADbA,EAAOhF,EAAWgF,KAAKpL,KAAKnC,EAAMiB,EAAIugB,MAElCD,GAAgB,QAEjB,IAAKvhB,EAAKqM,qBAAqBmV,IAAOjZ,GAAcA,EAAWgF,KAAM,CACxE+T,GAAmB,EAGN,QADb/T,EAAOhF,EAAWgF,KAAKpL,KAAKnC,EAAMiB,EAAIugB,MAElCD,GAAgB,QAEjBb,QAAQC,IAAI,oDA5BvB,GAAI5P,EAAQxD,KAAM,CACd+T,GAAmB,EAGN,QADb/T,EAAOwD,EAAQxD,KAAKpL,KAAKnC,EAAMiB,MAE3BsgB,GAAgB,QAEjBb,QAAQC,IAAI,gDA2B/B3gB,EAAK+gB,QAAQU,WAAWR,GAExB,GAAI1T,EAAM,CAENvN,EAAKoW,WAAW1F,KAAK,SAAU6C,GAC3B,QAAQ,GACJ,KAAKhG,EAAKlE,OAAOxJ,MAAQN,GAAG4F,OAAO8O,UAAUC,OACzC,IAAK,IAAIvS,EAAI,EAAGA,EAAI3B,EAAK2U,eAAehU,OAAQgB,IACxC4R,EAAM7R,eAAe1B,EAAK2U,eAAehT,YAClC4R,EAAMvT,EAAK2U,eAAehT,IAEzC,MACJ,KAAK4L,EAAKlE,OAAOxJ,MAAQN,GAAG4F,OAAO8O,UAAUzO,IACzC,IAAS7D,EAAI,EAAGA,EAAI3B,EAAK2U,eAAehU,OAAQgB,IAC5C4R,EAAMvT,EAAK2U,eAAehT,IAAM4L,EAAKlE,OAAOrJ,EAAK2U,eAAehT,IAGpEsf,EAAOjhB,EAAK+gB,QAAQG,UAK5B3N,EAAM1T,KAAO0N,EAAKlE,OAAOxJ,KAEzBG,EAAKqC,IAAIqf,GAAGniB,GAAG4F,OAAOiG,MAAMkI,YAAa,SAAUyD,GAC3CA,EAAExD,QAAUvT,EAAKuT,OA/Fd,SAAU3C,GAGjC,GAAIA,GAAYA,EAASjQ,OAAS,EAC9B,IAAK,IAAIgB,EAAI,EAAGA,EAAIiP,EAASjQ,OAAQgB,IAC7BiP,EAASjP,GAAGggB,YAJbriB,KAIgC6R,oBAC/BP,EAASjP,GAAGggB,WALbriB,KAK+B6R,oBA0FDhP,KAAKnC,EAAM+W,EAAEnG,YAI1C2C,EAAMqO,UAAUlR,KAAK,WACjB1Q,EAAKqC,IAAIwf,IAAItiB,GAAG4F,OAAOiG,MAAM0W,YAAa,SAAU/K,GAChD,GAAIA,EAAExD,OAASA,EAAO,CAElBvT,EAAKqC,IAAIwf,IAAItiB,GAAG4F,OAAOiG,MAAMkI,YAAa,SAAUyD,GAChD,GAAIA,EAAExD,OAASA,EAAO,CAClB,IAAKwD,EAAExD,MAAM3C,UAAuC,GAA3BmG,EAAExD,MAAM3C,SAASjQ,QAAeoW,EAAExD,MAAMjO,KAAKiO,MAAMwO,YAAYtG,cAAe,CACnGzb,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,QACjD,IAAIwM,EAASjL,EAAExD,MAAMjO,KAAKiO,MAAMwO,YAAYE,YACxC7S,EAAS2H,EAAExD,MAAMlR,IAAIvC,QAAQoiB,kBAEjC,GAAIF,EAAO,GAAKA,EAAO,IAAO,EAAG,CAC7BA,EAAO,GAAKA,EAAO,GAAK5S,EACxB4S,EAAO,GAAKA,EAAO,GAAK5S,EAE5B,GAAI4S,EAAO,GAAKA,EAAO,IAAO,EAAG,CAC7BA,EAAO,GAAKA,EAAO,GAAK5S,EACxB4S,EAAO,GAAKA,EAAO,GAAK5S,EAE5B2H,EAAExD,MAAMlR,IAAI8f,UAAUH,GAGtBhiB,EAAKqC,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAMgX,QAC7BC,OAAQL,EAAQzO,MAAOwD,EAAExD,aAG5B,GAAIwD,EAAExD,MAAM3C,UAAYmG,EAAExD,MAAM3C,SAASjQ,OAAS,EAAG,CACtDX,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,QACjDxV,EAAKuT,MAAMlR,IAAIkU,eAAeQ,EAAExD,MAAM3C,UAEtC5Q,EAAKqC,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAMkI,aAAeC,MAAOvT,EAAKuT,MAAO3C,SAAU5Q,EAAKuT,MAAM3C,gBAErF,GAAImG,EAAExD,MAAM3C,UAAuC,GAA3BmG,EAAExD,MAAM3C,SAASjQ,QAAe4M,EAAKlE,OAAOxJ,MAAQN,GAAG4F,OAAO8O,UAAUzO,IAAK,CACxGxF,EAAKkV,YAAYoN,MAAQ/U,EAAKgV,gBAC9BviB,EAAK+U,UAAUyB,cAAc,IAAI0J,YAAY,+BAE7ClgB,EAAKqC,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAM2G,kBAGrC/R,EAAK+gB,QAAQU,WAAWR,MAIhC,GAAIlK,EAAExD,MAAM3C,UAAYmG,EAAExD,MAAM3C,SAASjQ,OAAS,EAAG,CACjDX,EAAKkV,YAAYG,UAAUC,IAAI/V,GAAG4F,OAAOoQ,QAAQC,QACjDxV,EAAKuT,MAAMlR,IAAIkU,eAAevW,EAAKuT,MAAM3C,UAEzC5Q,EAAKqC,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAMkI,aAAeC,MAAOvT,EAAKuT,MAAO3C,SAAU5Q,EAAKuT,MAAM3C,WAExF5Q,EAAK+gB,QAAQU,WAAWR,QACrB,GAAIlK,EAAExD,MAAM3C,UAAuC,GAA3BmG,EAAExD,MAAM3C,SAASjQ,QAAe4M,EAAKlE,OAAOxJ,MAAQN,GAAG4F,OAAO8O,UAAUzO,IAAK,CACxGxF,EAAKkV,YAAY+K,UAAY1S,EAAKgV,gBAClCviB,EAAK+U,UAAUyB,cAAc,IAAI0J,YAAY,+BAEvCnJ,EAAEyL,SAAWzL,EAAEyL,QAAQ5R,UAAYmG,EAAEyL,QAAQ5R,SAASjQ,OAAS,GACjEX,EAAKqC,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAM2G,kBAGrC/R,EAAK+gB,QAAQU,WAAWR,WAO5ChR,EAAQ1C,OACL,CACH2C,IACKoR,GACDthB,EAAKqC,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAM2G,sBAMjDH,EAAS6Q,WAAa,SAAUxhB,EAAIgE,GAGhC,GAFW3F,KAEF2H,oBAAoBhC,GACzB,OAHO3F,KAGK2V,YAAYhU,EAAIgE,GAEzB,GALI3F,KAKK+M,qBAAqBpH,GAAW,CALrC3F,KAMF4R,qBAAqBjM,EANnB3F,KAMkC+M,qBAAqBpH,GANvD3F,MAOP,OAPOA,KAOK2V,YAAYhU,EAAIgE,GAE5Bmb,MAAM,0CAAyCnb,IAyCvD2M,EAAS/D,gBAAkB,SAAU5M,GACjC,IACIsM,KACJ,GAAI,6CAA6CjG,KAAKrG,IAAO,+DAA+DqG,KAAKrG,GAAK,CAElIsM,EAAKlE,QACDxJ,KAAMN,GAAG4F,OAAO8O,UAAUC,OAC1B9S,QACI+S,QACI7I,IARLhM,KAQeuT,aAAazE,KAR5B9O,KAQuC,SAAU,OAAO,MAK/DiO,EAAKgV,gBAAkB,yCAbhBjjB,KAagEoV,aAAe,aAnD9E,SAAUzT,GACtB,IAAIjB,EAAOV,KAEX2hB,KAAOjhB,EAAK+gB,QAAQG,UAEpB,IAEIjf,EACAygB,EAHA7T,EAAQ7O,EAAKyc,SAASxb,GAK1B,GAAI4N,EAAO,CACP5M,EAAQjC,EAAK4c,SAAS3b,GACtByhB,EAAU1iB,EAAKuT,MAAMoP,UAAU9T,EAAO3O,EAAEC,UAAWH,EAAKqC,IAAIvC,QAAQsB,OAAOyN,OAAS5M,MAAOA,EAAO2gB,MAAO3gB,SACtG,CACH,IAAI6G,EAAQ,2DAA2DJ,KAAKzH,GAC5EA,EAAKjB,EAAK0L,IAAM5C,EAAM,GAAK9I,EAAKyL,IAAM3C,EAAM,GAG5C,GAFA+F,EAAQ7O,EAAKyc,SAASxb,GAEX,CACPgB,EAAQjC,EAAK4c,SAAS3b,GACtByhB,EAAU1iB,EAAKuT,MAAMoP,UAAU9T,EAAO3O,EAAEC,UAAWH,EAAKqC,IAAIvC,QAAQsB,OAAOyN,OAAS5M,MAAOA,EAAO2gB,MAAO3gB,KAEzGjC,EAAK+U,UAAU3N,MAAQnF,GAI/BygB,EAAQhS,KAAK,SAAUmS,GACnB7iB,EAAKqC,IAAIgR,QAAQ9T,GAAG4F,OAAOiG,MAAMkI,aAC7BC,MAAOvT,EAAKuT,MAAO3C,UAAWiS,KAGlC7iB,EAAKqC,IAAIkU,gBAAgBsM,IAEzB7iB,EAAK+gB,QAAQU,WAAWR,UAoBd9e,KAfH7C,KAec2B,GAErB,OAAOsM,EAGX,OAAO,MAGXqE,EAASpE,iBAAmB,SAAUvM,GAClC,IACIsM,KAEAxF,EAAQ,IAAIC,OAAO,IAHZ1I,KAGuByM,IAAM,SAH7BzM,KAG6C0M,IAAM,aAHnD1M,KAGuE2M,IAAM,iBACxF,GAAIlE,EAAMT,KAAKrG,GAAK,CAChB,IAAI6H,EAAQf,EAAMW,KAAKzH,GAElB1B,GAAGyF,QACJzF,GAAGG,WAAWH,GAAGI,YAAc,aAGnC,IAAIE,EAXGP,KAWS2H,oBAAoB1H,GAAG4F,OAAOoD,WAAW+D,WAEzDiB,EAAKlE,QACDxJ,KAAMN,GAAG4F,OAAO8O,UAAUzO,IAC1B8F,IAAKzL,EAAKyL,IACV5B,QAAS7J,EAAK6J,QACd8C,aAAc3M,EAAK2M,aACnB9G,cAAe7F,EAAK6F,cACpBjF,YAAaZ,EAAKY,YAClBoD,WAAY,IAAItE,GAAGyF,OAAO+F,IACtB,IAAIxL,GAAGyF,OAAO4F,QAAQ/K,EAAK4G,gBAAgBC,eAAgBxG,EAAE8C,KAAK8F,EAAM,KACxE,IAAIvJ,GAAGyF,OAAO4F,QAAQ/K,EAAK4G,gBAAgBoC,gBAAiB3I,EAAE8C,KAAK8F,EAAM,KACzE,IAAIvJ,GAAGyF,OAAO4F,QAAQ/K,EAAK4G,gBAAgBuC,eAAgB9I,EAAE8C,KAAK8F,EAAM,MAC5E5D,aAAcrF,EAAKqF,aACnB9D,OAAQvB,EAAKuB,QAGjBmM,EAAKgV,gBAAkB,iBA5BhBjjB,KA4BwCmV,oBAAsB,oCA5B9DnV,KA4ByGkV,oBAAsB,YAEtI,OAAOjH,EAGX,OAAO,MAGXqE,EAASjC,SAAW,SAAU1O,GAC1B,IACIsM,KAEA1N,EAHOP,KAGK2H,oBAAoB1H,GAAG4F,OAAOoD,WAAWkH,MAEzDlC,EAAKlE,QACDxJ,KAAMN,GAAG4F,OAAO8O,UAAUzO,IAC1B8F,IAAKzL,EAAKyL,IACV5B,QAAS7J,EAAK6J,QACd8C,aAAc3M,EAAK2M,aACnB9G,cAAe7F,EAAK6F,cACpBjF,YAAaZ,EAAKU,kBAClBuiB,YAAa,IACbjf,WAAYhE,EAAKmF,OAAOsF,cAAcrJ,GACtCiE,aAAcrF,EAAKqF,aACnB9D,OAAQvB,EAAKuB,QAGjBmM,EAAKgV,gBAAkB,iBAlBZjjB,KAkBoCmV,oBAAsB,oCAlB1DnV,KAkBqGkV,oBAAsB,YAEtI,OAAOjH,GAGXqE,EAAS9B,OAAS,SAAU7O,GACxB,IACIsM,KAEA1N,EAHOP,KAGK2H,oBAAoB1H,GAAG4F,OAAOoD,WAAWqH,QAEzDrC,EAAKlE,QACDxJ,KAAMN,GAAG4F,OAAO8O,UAAUzO,IAC1B8F,IAAKzL,EAAKyL,IACV5B,QAAS7J,EAAK6J,QACd8C,aAAc3M,EAAK2M,aACnB9G,cAAe7F,EAAK6F,cACpBjF,YAAaZ,EAAKU,kBAClBuiB,YAAa,IACbjf,WAAYhE,EAAKmF,OAAOsF,cAAcrJ,GACtCiE,aAAcrF,EAAKqF,aACnB9D,OAAQvB,EAAKuB,QAGjBmM,EAAKgV,gBAAkB,iBAlBZjjB,KAkBoCmV,oBAAsB,oCAlB1DnV,KAkBqGkV,oBAAsB,YAEtI,OAAOjH,GAGXqE,EAASpD,kBAAoB,SAAUvN,EAAIgE,GACvC,IACIsI,KAEA1N,EAHOP,KAGK2H,oBAAoBhC,GAEpCsI,EAAKlE,QACDxJ,KAAMN,GAAG4F,OAAO8O,UAAUzO,IAC1B8F,IAAKzL,EAAKyL,IACV5B,QAAS7J,EAAK6J,QACd8C,aAAc3M,EAAK2M,aACnB9G,cAAe7F,EAAK6F,cACpBjF,YAAaZ,EAAKU,kBAClBuiB,YAAa,IACbjf,WAAYhE,EAAKmF,OAAOsF,cAAcrJ,GACtCiE,aAAcrF,EAAKqF,aACnB9D,OAAQvB,EAAKuB,QAGjB,OAAOmM,GAGXqE,EAAS6K,SAAW,SAAU5W,GAC1B,IAEIgJ,EADAkU,EADOzjB,KACS+C,IAAIiD,KAAK0d,QAEzBla,EAAQ,qCAAqCJ,KAAK7C,GACtD,GAAIiD,GAA0B,IAAjBA,EAAMnI,OAAc,CAC7BkO,GAASoU,WAAWna,EAAM,IAAKma,WAAWna,EAAM,KAC5Cia,IACAlU,EAAQtP,GAAG2c,KAAKgH,UAAUrU,EAPvBvP,KAOmC+C,IAAIvC,QAAQqjB,OAP/C7jB,KAO4D+C,IAAIsa,UAGtE,CAED,IADA7T,EAAQ,+DAA+DJ,KAAK7C,KAC9C,IAAjBiD,EAAMnI,OAAc,CAC7BkO,GAASoU,WAAWna,EAAM,IAAKma,WAAWna,EAAM,KAChD,IAAKia,EACD,OAAOxjB,GAAG2c,KAAKgH,UAAUrU,EAf1BvP,KAesC+C,IAAIvC,QAAQsjB,OAflD9jB,KAe+D+C,IAAIsa,KAK1E,IADA7T,EAAQ,+DAA+DJ,KAAK7C,KAC9C,IAAjBiD,EAAMnI,OAAc,CAC7BkO,GAASoU,WAAWna,EAAM,IAAKma,WAAWna,EAAM,KAChD,IAAKia,EACD,OAAOxjB,GAAG2c,KAAKgH,UAAUrU,EAvB1BvP,KAuBsC+C,IAAIvC,QAAQsjB,OAvBlD9jB,KAuB+D+C,IAAIsa,MAK9E,OAAO9N,GAGX+C,EAAS8K,YAAc,SAAU7N,GAQ7B,QAN0B,SAAUwT,EAAQxT,GACxC,QAAIwT,aAAkB3hB,QACXmO,EAAM,IAAMwT,EAAO,IAAMxT,EAAM,IAAMwT,EAAO,IAAMxT,EAAM,IAAMwT,EAAO,IAAMxT,EAAM,IAAMwT,EAAO,GAIzGgB,CAPO/jB,KAOkB+C,IAAIvC,QAAQwjB,UAAWzU,IAOxD+C,EAAShM,WAAa,WAElB,OADWtG,KACCyV,UAAU3N,OAG1BwK,EAASgL,SAAW,SAAU3b,GAC1B,IACI0R,EAAS1R,EACTsiB,EAAShkB,GAAG2c,KAAKsH,aAFVlkB,KAE4B+C,KAEvC,GAAIpB,EAAG6H,MAAM,IAAId,OAAO,OAJb1I,KAI2BoM,IAAM,cAJjCpM,KAIsDiM,KAAO,WAAY,EAE5EzC,GADJ6J,EAASA,EAAOpL,QALTjI,KAKsBoM,IALtBpM,KAKgCwM,WAAWvE,QAL3CjI,KAKwDmM,IAAK,IAL7DnM,KAKwEuM,WAAWtE,QALnFjI,KAKgGiM,KALhGjM,KAK2GqM,YAAYpE,QALvHjI,KAKoIkM,KAAM,IAL1IlM,KAKqJsM,aACzI9C,MAAM,IAAId,OAAO,IAAM9H,EAAE8C,KANrC1D,KAM+CwM,WAAa,0CAA4C5L,EAAE8C,KAN1G1D,KAMoHuM,WAAa,wCAGpI8G,GADAA,EAASA,EAAOpL,QAAQuB,EAAM,GAAIma,WAAWna,EAAM,IAAI2a,eAAeF,KACtDhc,QAAQuB,EAAM,GAAIma,WAAWna,EAAM,IAAI2a,eAAeF,KAG1E,IAAIG,EAAyB,IAAID,eAAeF,GAAQxa,UAAU,EAAG,GAErE,GADID,EAAQ6J,EAAO7J,MAAM,IAAId,OAAO,IAAM9H,EAAE8C,KAbrC1D,KAa+CqM,YAAc,eAb7DrM,KAamF8R,SAAW,8BAAgClR,EAAE8C,KAbhI1D,KAa0IsM,YAAc,eAbxJtM,KAa8K+R,SAAW,qBACrL,CACFsS,OAAOC,UAAUX,WAAWna,EAAM,OACnC6J,EAASA,EAAOpL,QAAQuB,EAAM,GAAIA,EAAM,GAAGvB,QAAQ,IAAKmc,KACvDC,OAAOC,UAAUX,WAAWna,EAAM,OACnC6J,EAASA,EAAOpL,QAAQuB,EAAM,GAAIA,EAAM,GAAGvB,QAAQ,IAAKmc,WAG7D,GAAIziB,EAAG6H,MAAM,IAAId,OAAO,OArBpB1I,KAqBkCmM,IAAM,YAAa,EAGxD3C,GAFJ6J,EAASA,EAAOpL,QAtBTjI,KAsBsBmM,IAtBtBnM,KAsBgCuM,WAAWtE,QAtB3CjI,KAsBwDoM,IAAK,IAtB7DpM,KAsBwEwM,YAE5DhD,MAAM,IAAId,OAAO,IAAM9H,EAAE8C,KAxBrC1D,KAwB+CuM,WAAa,0CAA4C3L,EAAE8C,KAxB1G1D,KAwBoHwM,WAAa,wCAGpI6G,GADAA,EAASA,EAAOpL,QAAQuB,EAAM,GAAIma,WAAWna,EAAM,IAAI2a,eAAeF,KACtDhc,QAAQuB,EAAM,GAAIma,WAAWna,EAAM,IAAI2a,eAAeF,UAGvE,GAAItiB,EAAG6H,MAAM,IAAId,OAAO,UA9BpB1I,KA8BqCyM,IAAM,cA9B3CzM,KA8BqE0M,IAAM,oBA9B3E1M,KA8BgH2M,IAAM,oBAA0B,CACvJ,IAAInD,EAAQ7H,EAAG6H,MAAM,IAAId,OAAO,UA/BzB1I,KA+B0CyM,IAAM,cA/BhDzM,KA+B0E0M,IAAM,oBA/BhF1M,KA+BqH2M,IAAM,oBAClI0G,EAhCOrT,KAgCO4M,UAAYpD,EAAM,GAAK,KAhC9BxJ,KAgC0C6M,UAAYrD,EAAM,GAAK,KAhCjExJ,KAgC6E8M,UAAYtD,EAAM,GAE1G,OAAO6J,GAGXf,EAASyL,kBAAoB,SAAU1Y,GACnCA,EAAOA,GAAQ,GA0Bf,IAzBA,IAAIgO,EAAS,IAAIjS,MAAMiE,EAAKhE,QACxB0B,GACAwhB,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,KAEAvjB,EAAI,EAAGwjB,EAAMxgB,EAAKhE,OAAQgB,EAAIwjB,EAAKxjB,IACxCgR,EAAOhR,GAAKU,EAAIsC,EAAK2a,OAAO3d,KAAOgD,EAAK2a,OAAO3d,GAEnD,OAAOgR,EAAOnQ,KAAK,KAGvBoP,EAASwT,YAAc,WACnB,MAAMplB,EAAOV,KACb,OAAIU,EAAKmL,cAEDlK,GAAIjB,EAAKiB,GACTokB,WAAYrlB,EAAK+U,UAAU3N,MAC3BmM,MAAOvT,EAAKuT,MAAM6R,aACdE,cAAc,KAInB,MAGX1T,EAAS2T,YAAc,SAAUC,GAC7B,MAAMxlB,EAAOV,KACbU,EAAK+U,UAAU3N,MAAQoe,EAAMH,WAC7BrlB,EAAKuT,MAAMgS,YAAYC,EAAMjS,OAAO7C,KAAK,WACrC1Q,EAAKuT,MAAM3C,SAASpN,QAAQ,SAAU0E,GAClCA,EAAEud,SAAS,WA/pE3B,GAuqEKC,OAAO7T,UAAUnN,WAClBghB,OAAO7T,UAAUnN,SAAW,WACxB,IAAIihB,GAAQza,YAAc,KAAK,GAC/B,OAAO5L,KAAKiI,QAAQ,WAAY,SAAUuB,EAAO8c,GAC7C,YAA8B,IAAhBD,EAAKC,GACfD,EAAKC,GACH9c,MAOb4c,OAAO7T,UAAUgU,yBAClBH,OAAO7T,UAAUgU,uBAAyB,SAAUC,GAGhD,IAFA,IAAIC,KACAC,EAAM1mB,KAAK8E,MAAM0hB,GACZnkB,EAAI,EAAGA,EAAIqkB,EAAIrlB,OAAQgB,IACxBqkB,EAAIrkB,GAAGqB,OAAOrC,OAAS,GACvBolB,EAAKziB,KAAK0iB,EAAIrkB,GAAGqB,QAEzB,OAAO+iB,IAKVL,OAAO7T,UAAUjN,cAClB8gB,OAAO7T,UAAUjN,YAAc,WAC3B,IAAIqhB,EAAS3mB,KAAKmI,cACdqB,EAAQxJ,KAAKmI,cAAcqB,MAAM,8GACrC,GAAIA,EACA,IAAK,IAAInH,EAAI,EAAGA,EAAImH,EAAMnI,OAAQgB,IAC1B,0BAA0B2F,KAAKwB,EAAMnH,MACrCskB,EAASA,EAAO1e,QAAQuB,EAAMnH,GAAImH,EAAMnH,GAAG+F,gBAIvD,OAAOue,EAAO3G,OAAO,GAAG5X,cAAgBue,EAAOld,UAAU,KAK5DrI,MAAMmR,UAAUnQ,eAAe,mBAChCqI,OAAOmc,eAAexlB,MAAMmR,UAAW,kBACnCsU,YAAY,EACZC,UAAU,EACVhf,MAAO,SAAUJ,EAAcI,GAC3B,IAAK,IAAIzF,EAAI,EAAGA,EAAIrC,KAAKqB,OAAQgB,IAC7B,GAAIrC,KAAKqC,GAAGqF,IAAiBI,EACzB,OAAO9H,KAAKqC,MAM3B+jB,OAAO7T,UAAUwU,WAClBX,OAAO7T,UAAUwU,SAAW,SAAUC,EAAcC,GAChD,IAAIC,EAAgBlnB,KAAKkI,YACD,iBAAb+e,IAA0BE,SAASF,IAAaG,KAAKC,MAAMJ,KAAcA,GAAYA,EAAWC,EAAc7lB,UACrH4lB,EAAWC,EAAc7lB,QAE7B4lB,GAAYD,EAAa3lB,OACzB,IAAIimB,EAAYJ,EAActlB,QAAQolB,EAAcC,GACpD,OAAsB,IAAfK,GAAoBA,IAAcL","sourcesContent":["(function () {\r\n    // Polyfill window.performance.now\r\n    if (!window.performance) {\r\n        window.performance = {\r\n            offset: Date.now(),\r\n            now: function () {\r\n                return Date.now() - this.offset;\r\n            }\r\n        };\r\n    } else if (window.performance && !window.performance.now) {\r\n        window.performance.offset = Date.now();\r\n        window.performance.now = function () {\r\n            return Date.now() - window.performance.offset;\r\n        };\r\n    }\r\n}());\r\n\r\nTC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\n\r\nvar SearchType = function (type, options, parent) {\r\n    var self = this;\r\n\r\n    self.parent = parent;\r\n\r\n    self._featureTypes = [];\r\n\r\n    $.extend(self, options);\r\n\r\n    self.typeName = type;\r\n\r\n    self._throwConfigError = function () {\r\n        var self = this;\r\n\r\n        throw new Error('Error en la configuración de la búsqueda: ' + self.typeName);\r\n    };\r\n\r\n    self.getFeatureTypes = function (toFilter) {\r\n        var self = this;\r\n\r\n        if (toFilter) {\r\n            return self.featureType instanceof Array ? self.featureType : [self.featureType];\r\n        }\r\n\r\n        if (self._featureTypes.length === 0) {\r\n            var type_featureType = self.featureType instanceof Array ? self.featureType : [self.featureType];\r\n            var type_renderFeatureType = self.renderFeatureType ? self.renderFeatureType instanceof Array ? self.renderFeatureType : [self.renderFeatureType] : [];\r\n            self._featureTypes = type_featureType.concat(type_renderFeatureType);\r\n        }\r\n\r\n        return self._featureTypes;\r\n    };\r\n\r\n    self.isFeatureOfThisType = function (id) {\r\n        var self = this;\r\n\r\n        return self.getFeatureTypes().indexOf(id) > -1;\r\n    };\r\n\r\n    self.getStyleByFeatureType = function (featureType) {\r\n        var self = this;\r\n\r\n        if (self.getFeatureTypes().indexOf(featureType) > -1) {\r\n            return self.styles[self.getFeatureTypes().indexOf(featureType)];\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    var getColor = function (css, geomType, featureType) {\r\n        var self = this;\r\n\r\n        var getValue = function (style, geomType, css) {\r\n            if (geomType) {\r\n                if (style.hasOwnProperty(geomType) && style[geomType].hasOwnProperty(css)) {\r\n                    return style[geomType][css];\r\n                }\r\n            } else {\r\n                for (var geomType in style) {\r\n                    if (style[geomType].hasOwnProperty(css)) {\r\n                        return style[geomType][css];\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        if (featureType) {\r\n            var style = self.getStyleByFeatureType(featureType);\r\n            return getValue(style, geomType, css);\r\n        } else {\r\n            for (var i = 0; i < self.styles.length; i++) {\r\n                var style = self.styles[i];\r\n                var color = getValue(style, geomType, css);\r\n                if (color) {\r\n                    return color;\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    self.getSuggestionListHead = function () {\r\n        var self = this;\r\n\r\n        var headerData, label, color;\r\n\r\n        if (typeof self.suggestionListHead === \"function\") {\r\n            headerData = self.suggestionListHead();\r\n            label = headerData.label;\r\n            color = [{\r\n                color: headerData.color,\r\n                title: headerData.label\r\n            }];\r\n        } else {\r\n            headerData = self.suggestionListHead;\r\n            label = self.parent.getLocaleString(headerData.label);\r\n\r\n            // color es string que es el atributo CSS. El valor se obtiene de la 1º coincidencia encontrada en styles\r\n            if (typeof headerData.color === \"string\") {\r\n                color = [{\r\n                    color: getColor.call(self, headerData.color),\r\n                    title: label\r\n                }];\r\n            } else if (headerData.color instanceof Array) { // color es un array de objetos, con nombre de featureType como clave\r\n                var featureTypes = self.getFeatureTypes();\r\n                if (headerData.color.length === featureTypes.length) {\r\n                    color = headerData.color.map(function (elm, i) {\r\n                        return {\r\n                            color: getColor.call(self, elm[featureTypes[i]].color.css, elm[featureTypes[i]].color.geomType, featureTypes[i]),\r\n                            title: self.parent.getLocaleString(elm[featureTypes[i]].title) || label\r\n                        }\r\n                    });\r\n                } else {\r\n                    self._throwConfigError();\r\n                }\r\n            } else if (typeof headerData.color === \"object\") { // color es un objeto con atributo css y tipo de geometría\r\n                color = [{\r\n                    color: getColor.call(self, headerData.color.css, headerData.color.geomType),\r\n                    title: label\r\n                }];\r\n            }\r\n        }\r\n\r\n        if (label && color) {\r\n            var liHTML = '<li header><span class=\"header\">' + label + '</span>';\r\n\r\n            liHTML += color.map(function (elm) {\r\n                if (elm.color) {\r\n                    return '<span class=\"header-color\" title=\"' + elm.title + '\" style=\"color: ' + elm.color + ';\"></span>';\r\n                }\r\n            }).join('') + '</li>';\r\n\r\n            return liHTML;\r\n\r\n        } else {\r\n            self._throwConfigError();\r\n        }\r\n    };\r\n\r\n    self.getSuggestionListElements = function (data) {\r\n        var self = this;\r\n        var results = [];\r\n\r\n        var areSame = function (a, b) {\r\n            switch (true) {\r\n                case typeof (a) === \"number\":\r\n                    if (a === b) {\r\n                        return true;\r\n                    }\r\n                    break;\r\n                case typeof (a) === \"string\":\r\n                    if (!isNaN(a) || !isNaN(b)) {\r\n                        if (a === b) {\r\n                            return true;\r\n                        }\r\n                    } else {\r\n                        if (a.trim() === b.trim()) {\r\n                            return true;\r\n                        }\r\n                    }\r\n                    break;\r\n            }\r\n\r\n            return false;\r\n        };\r\n        var getUnique = function (inputArray) {\r\n            var outputArray = [];\r\n            for (var i = 0; i < inputArray.length; i++) {\r\n                if ((jQuery.inArray(inputArray[i], outputArray)) == -1) {\r\n                    outputArray.push(inputArray[i]);\r\n                }\r\n            }\r\n\r\n            return outputArray;\r\n        };\r\n        var intoResults = function (compareData) {\r\n            for (var r = 0; r < results.length; r++) {\r\n                var length = 0;\r\n                var isThere = [];\r\n                for (var property in compareData) {\r\n                    isThere.push(areSame(compareData[property], results[r].properties[property]));\r\n                    length++;\r\n                }\r\n                if (isThere.filter(function (i) { return i; }).length === length) {\r\n                    return true;\r\n                }\r\n\r\n            }\r\n\r\n            return false;\r\n        };\r\n\r\n        var features = self.parseFeatures(data);\r\n\r\n        features.forEach(function (feature) {\r\n            var attributes = [], ids = [];\r\n            var valueToAdd = '';\r\n\r\n            var properties = self.outputProperties;\r\n            var dataIdProperties = self.dataIdProperty;\r\n\r\n            var strFormat = self.outputFormatLabel;\r\n            var dataLayer = feature.id.split('.').slice(0, 1).shift();\r\n\r\n            if (!(self.outputProperties instanceof Array)) {\r\n                properties = self.outputProperties[dataLayer];\r\n                dataIdProperties = self.dataIdProperty[dataLayer];\r\n                strFormat = strFormat[dataLayer];\r\n            }\r\n\r\n            for (var j = 0; j < properties.length; j++) {\r\n                attributes.push(feature.data[properties[j]]);\r\n            }\r\n\r\n            for (var j = 0; j < dataIdProperties.length; j++) {\r\n                ids.push(feature.data[dataIdProperties[j]]);\r\n            }\r\n\r\n            var compareData = {};\r\n            for (var p = 0; p < self.outputProperties.length; p++) {\r\n                compareData[self.outputProperties[p]] = attributes[p];\r\n            }\r\n\r\n            if (attributes instanceof Array && strFormat && getUnique(attributes).length > 1) {\r\n                valueToAdd = strFormat.tcFormat(attributes);\r\n            }\r\n            else if (attributes instanceof Array && getUnique(attributes).length == 1) {\r\n                valueToAdd = attributes[0];\r\n            }\r\n\r\n            var text = valueToAdd.toCamelCase();\r\n\r\n            if (!(intoResults(compareData))) {\r\n\r\n                results.push({\r\n                    text: text,\r\n                    label: text,\r\n                    id: ids.join('#'),\r\n                    dataRole: self.typeName,\r\n                    dataLayer: dataLayer,\r\n                    properties: compareData\r\n                });\r\n            }\r\n        });\r\n\r\n        return results;\r\n    };\r\n\r\n    self.parseFeatures = function (data) {\r\n        var parser;\r\n        if (self.outputFormat === TC.Consts.format.JSON) {\r\n            parser = new TC.wrap.parser.JSON();\r\n        }\r\n        else {\r\n            parser = new TC.wrap.parser.WFS({\r\n                featureNS: self.featurePrefix,\r\n                featureType: self.featureType\r\n            });\r\n        }\r\n        return parser.read(data);\r\n    };\r\n\r\n    self.getPattern = function () {\r\n        var self = this;\r\n\r\n        if (typeof self.pattern === \"function\") {\r\n            return self.pattern();\r\n        } else {\r\n            return self.pattern;\r\n        }\r\n    };\r\n\r\n    self.filter = (function (self) {\r\n\r\n        const bindRootFilterNode = function (filtersArr, dataT) {\r\n            var rootFilters = [];\r\n\r\n            if (dataT != self.parent.rootCfg.active.root) {\r\n                // GLS: Si llego aquí, significa que el usuario está indicando la población\r\n                if (dataT.indexOf('#') === -1 && !self.parent.rootCfg.active.limit) { // si no está limitada la búsqueda, indico la población\r\n\r\n                    var filterNode = self.parent.rootCfg.active.queryProperties.firstQueryWord.map(function (queryWord, index) {\r\n                        return self.filter.getFilterNode(queryWord, self.parent._LIKE_PATTERN + dataT + self.parent._LIKE_PATTERN);\r\n                    });\r\n\r\n                    if (filterNode.length > 1) {\r\n                        rootFilters.push('<ogc:And>');\r\n                        rootFilters = rootFilters.concat(filterNode);\r\n                        rootFilters.push('</ogc:And>');\r\n                    } else {\r\n                        rootFilters = rootFilters.concat(filterNode);\r\n                    }\r\n\r\n                } else { // por tanto no añado todas las raíces posibles, añado la población que ha indicado (validando antes contra rootLabel)                     \r\n                    var item = dataT.split('#');\r\n\r\n                    for (var j = 0; j < self.parent.rootCfg.active.dataIdProperty.length; j++) {\r\n\r\n                        if (j == 0 && self.parent.rootCfg.active.dataIdProperty.length > 1) {\r\n                            rootFilters.push('<ogc:And>');\r\n                        }\r\n\r\n                        rootFilters.push(self.filter.getFilterNode(self.parent.rootCfg.active.dataIdProperty[j], item.length > j ? item[j] : item[0]));\r\n\r\n                        if (j == self.parent.rootCfg.active.dataIdProperty.length - 1 && self.parent.rootCfg.active.dataIdProperty.length > 1) {\r\n                            rootFilters.push('</ogc:And>');\r\n                        }\r\n                    }\r\n                }\r\n            } else {\r\n                for (var i = 0; i < self.parent.rootCfg.active.root.length; i++) {\r\n                    var item = self.parent.rootCfg.active.root[i];\r\n\r\n                    if (i == 0 && self.parent.rootCfg.active.root.length > 1) {\r\n                        rootFilters.push('<ogc:Or>');\r\n                    }\r\n\r\n                    for (var j = 0; j < self.parent.rootCfg.active.dataIdProperty.length; j++) {\r\n\r\n                        if (j == 0 && self.parent.rootCfg.active.dataIdProperty.length > 1) {\r\n                            rootFilters.push('<ogc:And>');\r\n                        }\r\n\r\n                        rootFilters.push(self.filter.getFilterNode(self.parent.rootCfg.active.dataIdProperty[j], item.length > j ? item[j] : item[0]));\r\n\r\n                        if (j == self.parent.rootCfg.active.dataIdProperty.length - 1 && self.parent.rootCfg.active.dataIdProperty.length > 1) {\r\n                            rootFilters.push('</ogc:And>');\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (self.parent.rootCfg.active.root.length > 1) {\r\n                    rootFilters.push('</ogc:Or>');\r\n                }\r\n            }\r\n\r\n            return filtersArr.concat(rootFilters);\r\n        };\r\n\r\n        return {\r\n            getPropertyValue: function (role, propertyName) {\r\n                return self.getSearchTypeByRole(role)[propertyName];\r\n            },\r\n            getIsLikeNode: function (name, value) {\r\n                var toEscape = /([\\-\\\"\\.\\xba\\(\\)\\/])/g;\r\n                if (toEscape.test(value)) {\r\n                    value = value.replace(toEscape, \"\\\\$1\");\r\n                }\r\n\r\n                if (value.toString().indexOf(self.parent._LIKE_PATTERN) > -1)\r\n                    return '<Or><PropertyIsLike escape=\"\\\\\" singleChar=\"_\" wildCard=\"*\" matchCase=\"false\">' +\r\n                        '<PropertyName>' + name + '</PropertyName>' +\r\n                        '<Literal>' + value.toLowerCase().replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</Literal>' +\r\n                        '</PropertyIsLike>' +\r\n                        '<PropertyIsLike escape=\"\\\\\" singleChar=\"_\" wildCard=\"*\" matchCase=\"false\">' +\r\n                        '<PropertyName>' + name + '</PropertyName>' +\r\n                        '<Literal>' + value.toUpperCase().replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</Literal>' +\r\n                        '</PropertyIsLike></Or>';\r\n                else\r\n                    return '<PropertyIsEqualTo>' +\r\n                        '<PropertyName>' + name + '</PropertyName>' +\r\n                        '<Literal>' + value.replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</Literal>' +\r\n                        '</PropertyIsEqualTo>';\r\n            },\r\n            getFunctionStrMatches: function (name, value) {\r\n                var toEscape = /([\\-\\\"\\xba\\(\\)\\/])/g;\r\n                if (toEscape.test(value)) {\r\n                    value = value.replace(toEscape, \"\\\\$1\");\r\n                }\r\n\r\n                if (value.toString().indexOf(self.parent._LIKE_PATTERN) > -1) {\r\n\r\n                    var pattern = value;\r\n                    pattern = pattern.replace(/a/gi, \"[aáà]\");\r\n                    pattern = pattern.replace(/e/gi, \"[eéè]\");\r\n                    pattern = pattern.replace(/i/gi, \"[iíì]\");\r\n                    pattern = pattern.replace(/o/gi, \"[oóò]\");\r\n                    pattern = pattern.replace(/u/gi, \"[uúüù]\");\r\n\r\n                    return '<ogc:PropertyIsEqualTo> ' +\r\n                        '<ogc:Function name=\"strMatches\"> ' +\r\n                        '<ogc:PropertyName>' + name + '</ogc:PropertyName> ' +\r\n                        '<ogc:Literal>' + '(?i)' + pattern.replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</ogc:Literal> ' +\r\n                        '</ogc:Function> ' +\r\n                        '<ogc:Literal>true</ogc:Literal> ' +\r\n                        '</ogc:PropertyIsEqualTo>';\r\n                }\r\n                else {\r\n                    return '<PropertyIsEqualTo>' +\r\n                        '<PropertyName>' + name + '</PropertyName>' +\r\n                        '<Literal>' + value.replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</Literal>' +\r\n                        '</PropertyIsEqualTo>';\r\n                }\r\n            },\r\n            getFilterNode: function (propertyName, propertyValue) {\r\n                var r;\r\n\r\n                var fn = self.filter.getIsLikeNode;\r\n\r\n                if (self.filterByMatch) {\r\n\r\n                    fn = self.filter.getFunctionStrMatches;\r\n\r\n                    var regex = new RegExp('\\\\' + self.parent._LIKE_PATTERN, 'gi');\r\n                    propertyValue = propertyValue.replace(regex, self.parent._MATCH_PATTERN);\r\n                }\r\n\r\n                if (!(propertyName instanceof Array) && (typeof propertyName !== 'string')) {\r\n                    var f = [];\r\n                    for (var key in propertyName) {\r\n                        if ((propertyName[key] instanceof Array) && propertyName[key].length > 1) {\r\n                            r = '<Or>';\r\n                            for (var i = 0; i < propertyName[key].length; i++) {\r\n                                r += fn(propertyName[key][i].trim(), propertyValue);\r\n                            }\r\n\r\n                            r += '</Or>';\r\n                            f.push('(<Filter xmlns=\"http://www.opengis.net/ogc\">' + r + '</Filter>)');\r\n                        } else {\r\n                            var propName = propertyName[key];\r\n                            if ((propertyName[key] instanceof Array) && propertyName[key].length == 1)\r\n                                propName = propertyName[key][0];\r\n\r\n                            f.push('(<Filter xmlns=\"http://www.opengis.net/ogc\">' +\r\n                                '<Or>' + fn(propName.trim(), propertyValue) + '</Or>' +\r\n                                '</Filter>)');\r\n                        }\r\n                    }\r\n\r\n                    return f.join('');\r\n\r\n                } else if (propertyName instanceof Array && propertyName.length > 1) {\r\n                    r = '<ogc:Or>';\r\n                    for (var i = 0; i < propertyName.length; i++) {\r\n                        r += fn(propertyName[i].trim(), propertyValue);\r\n                    }\r\n\r\n                    return r += '</ogc:Or>';\r\n                } else\r\n                    return fn((propertyName instanceof Array && propertyName.length === 1 ? propertyName[0].trim() : propertyName.trim()), propertyValue);\r\n            },\r\n            getFilter: function (data) {\r\n                var r = {};\r\n                r.multiL = false;\r\n                r.f = '';\r\n\r\n                var _f;\r\n\r\n                switch (true) {\r\n                    case self.typeName === TC.Consts.searchType.NUMBER:\r\n                        _f = [];\r\n                        if (!(self.parent.rootCfg.active) && (/(\\<|\\>|\\<\\>)/gi.exec(data.t) || /(\\<|\\>|\\<\\>)/gi.exec(data.s))) {\r\n                            var match = /(\\<|\\>|\\<\\>)/gi.exec(data.t);\r\n                            if (match)\r\n\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t.substring(0, data.t.indexOf(match[0])).trim() + self.parent._LIKE_PATTERN));\r\n                            else {\r\n                                if (self.parent.rootCfg.active) {\r\n                                    _f = bindRootFilterNode(_f, data.t);\r\n                                }\r\n                                else {\r\n                                    _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                                }\r\n                            }\r\n\r\n                            match = /(\\<|\\>|\\<\\>)/gi.exec(data.s);\r\n                            if (match)\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s.substring(0, data.s.indexOf(match[0])).trim() + self.parent._LIKE_PATTERN));\r\n                            else _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        }\r\n                        else {\r\n                            if (self.parent.rootCfg.active) {\r\n                                _f = bindRootFilterNode(_f, data.t);\r\n                            } else {\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                            }\r\n                            _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        }\r\n\r\n                        _f.push(self.filter.getFilterNode(self.queryProperties.thirdQueryWord, data.p + self.parent._LIKE_PATTERN));\r\n\r\n                        r.f = '<ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\">' + '<ogc:And>' + _f.join('') + '</ogc:And>' + '</ogc:Filter>';\r\n\r\n                        break;\r\n                    case self.typeName === TC.Consts.searchType.STREET:\r\n                        _f = [];\r\n\r\n                        if (!(self.parent.rootCfg.active) && (/(\\<|\\>|\\<\\>)/gi.exec(data.t) || /(\\<|\\>|\\<\\>)/gi.exec(data.s))) {\r\n                            var match = /(\\<|\\>|\\<\\>)/gi.exec(data.t);\r\n                            if (match)\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t.substring(0, data.t.indexOf(match[0])).trim() + self.parent._LIKE_PATTERN));\r\n                            else {\r\n                                if (self.parent.rootCfg.active) {\r\n                                    _f = bindRootFilterNode(_f, data.t);\r\n                                }\r\n                                else {\r\n                                    _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                                }\r\n                            }\r\n\r\n                            match = /(\\<|\\>|\\<\\>)/gi.exec(data.s);\r\n                            if (match)\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s.substring(0, data.s.indexOf(match[0])).trim() + self.parent._LIKE_PATTERN));\r\n                            else _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        } else {\r\n\r\n                            if (self.parent.rootCfg.active) {\r\n                                _f = bindRootFilterNode(_f, data.t);\r\n                            }\r\n                            else {\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                            }\r\n                            _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        }\r\n                        r.f = '<ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\">' + '<ogc:And>' + _f.join('') + '</ogc:And>' + '</ogc:Filter>';\r\n                        break;\r\n                    case self.typeName === TC.Consts.searchType.LOCALITY:\r\n                        r.f = self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN);\r\n                        r.multiL = true;\r\n                        break;                                            // GLS: consulta de 2 niveles (carretera con pk / topónimo con municipio)\r\n                    case self.queryProperties.hasOwnProperty('secondQueryWord'):\r\n                        var _f = [];\r\n                        _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                        _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        r.f = '<ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\">' + '<ogc:And>' + _f.join('') + '</ogc:And>' + '</ogc:Filter>';\r\n                        break;\r\n                    default: // GLS: consulta de 1 único nivel (municipio, casco urbano, carretera)\r\n                        r.f = '<ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\">' + self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN) + '</ogc:Filter>';\r\n                        break;\r\n                }\r\n\r\n                return r;\r\n            },\r\n            getParams: function (data) {\r\n                var filters = self.filter.getFilter(data);\r\n\r\n                var params = {\r\n                    REQUEST: 'GetFeature',\r\n                    SERVICE: 'WFS',\r\n                    MAXFEATURES: 500,\r\n                    VERSION: self.version,\r\n                    OUTPUTFORMAT: self.outputFormat\r\n                };\r\n\r\n                var featureTypes = self.getFeatureTypes(true);\r\n                if (!(featureTypes instanceof Array))\r\n                    params.TYPENAME = self.featurePrefix ? self.featurePrefix + ':' + featureTypes.trim() : featureTypes.trim();\r\n                else {\r\n                    var ft = [];\r\n                    for (var i = 0; i < featureTypes.length; i++) {\r\n                        ft.push(self.featurePrefix ?\r\n                            self.featurePrefix + ':' + featureTypes[i].trim() :\r\n                            featureTypes[i].trim());\r\n                    }\r\n\r\n                    params.TYPENAME = ft.join(',');\r\n                }\r\n\r\n                var _getProperties = function (properties) {\r\n                    if ((properties || '') !== '') {\r\n                        if (!(properties instanceof Array)) {\r\n                            var p = [];\r\n                            if (properties instanceof Object) {\r\n                                for (var key in properties) {\r\n                                    var prop = properties[key][0];\r\n                                    if (properties[key].length > 1)\r\n                                        prop = properties[key].join(',');\r\n\r\n                                    p.push(prop);\r\n                                }\r\n                            }\r\n                            return p;\r\n                        }\r\n                        else\r\n                            return properties.join(',');\r\n                    }\r\n                };\r\n                var _properties = _getProperties(self.outputProperties);\r\n                var _ids = _getProperties(self.dataIdProperty);\r\n\r\n                if (_properties instanceof Array && _ids instanceof Array) {\r\n                    params.PROPERTYNAME = '';\r\n                    for (var i = 0; i < _properties.length; i++) {\r\n                        params.PROPERTYNAME += '(' + _properties[i] + ',' + _ids[i] + ')';\r\n                    }\r\n                } else\r\n                    params.PROPERTYNAME = _properties + ',' + _ids;\r\n\r\n                params.FILTER = filters.f;\r\n\r\n                return $.param(params);\r\n            },\r\n            getGoToFilter: function (id) {\r\n                var props = [];\r\n                var _id = id.split('#');\r\n\r\n                var source = self.dataIdProperty;\r\n                var dataLayer = self.getFeatureTypes();\r\n\r\n                if (source && dataLayer) {\r\n\r\n                    if (id.indexOf('#') > -1 && dataLayer instanceof Array && dataLayer.length > 1) {\r\n                        for (var i = 0; i < dataLayer.length; i++) {\r\n\r\n                            for (var j = 0; j < source[dataLayer[i]].length; j++) {\r\n                                props.push({ name: source[dataLayer[i]][j], value: _id[j] });\r\n                            }\r\n                        }\r\n                    } else if (id.indexOf('#') == -1 && dataLayer instanceof Array) {\r\n                        var src = source;\r\n\r\n                        for (var i = 0; i < dataLayer.length; i++) {\r\n                            if (!props.hasOwnProperty(dataLayer[i])) {\r\n\r\n                                if (src instanceof Object && source.hasOwnProperty(dataLayer[i]))\r\n                                    src = source[dataLayer[i]];\r\n\r\n                                for (var j = 0; j < src.length; j++) {\r\n                                    if (j < _id.length)\r\n                                        props.push({ name: src[j], value: _id[j] });\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                    else {\r\n                        if (source instanceof Object && source.hasOwnProperty(dataLayer)) {\r\n                            source = source[dataLayer];\r\n                        }\r\n\r\n                        for (var i = 0; i < source.length; i++) {\r\n                            props.push({ name: source[i], value: _id[i] });\r\n                        }\r\n                    }\r\n                }\r\n\r\n                return self.filter.transformFilter(props);\r\n            },\r\n            transformFilter: function (properties) {\r\n                var self = this;\r\n\r\n                if (!TC.filter) {\r\n                    TC.syncLoadJS(TC.apiLocation + 'TC/Filter');\r\n                }\r\n\r\n                if (properties && properties instanceof Array) {\r\n                    var filters = properties.map(function (elm) {\r\n                        if (elm.hasOwnProperty(\"type\")) {\r\n                            switch (true) {\r\n                                case elm.type == TC.Consts.comparison.EQUAL_TO: {\r\n                                    return new TC.filter.equalTo(elm.name, elm.value);\r\n                                }\r\n                            }\r\n                        } else {\r\n                            return new TC.filter.equalTo(elm.name, elm.value);\r\n                        }\r\n                    });\r\n\r\n                    if (filters.length > 1) {\r\n                        return TC.filter.and.apply(null, filters);\r\n                    } else {\r\n                        return filters[0];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    })(self);\r\n};\r\n\r\nTC.control.Search = function () {\r\n    var self = this;\r\n    TC.Control.apply(self, arguments);\r\n\r\n    self.exportsState = true;\r\n\r\n    TC.Consts.event.TOOLSCLOSE = TC.Consts.event.TOOLSCLOSE || 'toolsclose.tc';\r\n\r\n    self.url = '//idena.navarra.es/ogc/wfs';\r\n    self.version = '1.1.0';\r\n    self.featurePrefix = 'IDENA';\r\n\r\n    if (self.options && self.options.url) {\r\n        self.url = self.options.url;\r\n    }\r\n\r\n    self._LIKE_PATTERN = '*';\r\n    self._MATCH_PATTERN = '.*';\r\n\r\n    self.UTMX = 'X';\r\n    self.UTMY = 'Y';\r\n    self.LON = 'Lon';\r\n    self.LAT = 'Lat';\r\n\r\n    self.UTMX_LABEL = 'X: ';\r\n    self.UTMY_LABEL = 'Y: ';\r\n    self.LON_LABEL = 'Lon: ';\r\n    self.LAT_LABEL = 'Lat: ';\r\n\r\n    self.MUN = 'Mun';\r\n    self.POL = 'Pol';\r\n    self.PAR = 'Par';\r\n\r\n    self.MUN_LABEL = 'Mun: ';\r\n    self.POL_LABEL = 'Pol: ';\r\n    self.PAR_LABEL = 'Par: ';\r\n\r\n    self.availableSearchTypes = {};\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.CADASTRAL] = {\r\n        suggestionRoot: null,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        searchWeight: 3,\r\n        featureType: ['CATAST_Pol_ParcelaUrba', 'CATAST_Pol_ParcelaRusti', 'CATAST_Pol_ParcelaMixta'],\r\n        municipality: {\r\n            featureType: 'CATAST_Pol_Municipio',\r\n            labelProperty: 'MUNICIPIO',\r\n            idProperty: 'CMUNICIPIO'\r\n        },\r\n        queryProperties: {\r\n            firstQueryWord: 'CMUNICIPIO',\r\n            secondQueryWord: 'POLIGONO',\r\n            thirdQueryWord: 'PARCELA'\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.cadastral\",\r\n            color: [\r\n                {\r\n                    CATAST_Pol_ParcelaUrba: {\r\n                        title: \"search.list.cadastral.urban\",\r\n                        color: {\r\n                            geomType: \"polygon\",\r\n                            css: \"strokeColor\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    CATAST_Pol_ParcelaRusti: {\r\n                        title: \"search.list.cadastral.rustic\",\r\n                        color: {\r\n                            geomType: \"polygon\",\r\n                            css: \"strokeColor\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    CATAST_Pol_ParcelaMixta: {\r\n                        title: \"search.list.cadastral.mixed\",\r\n                        color: {\r\n                            geomType: \"polygon\",\r\n                            css: \"strokeColor\"\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#136278',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            },\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#0c8b3d',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            },\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#e5475f',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                },\r\n            }\r\n        ],\r\n        parser: self.getCadastralRef,\r\n        goTo: self.goToCadastralRef,\r\n        goToIdFormat: self.MUN + '{0}' + self.POL + '{1}' + self.PAR + '{2}',\r\n        idPropertiesIdentifier: '#'\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.COORDINATES] = {\r\n        parser: self.getCoordinates,\r\n        goTo: self.goToCoordinates,\r\n        searchWeight: 4,\r\n        label: null,\r\n        suggestionListHead: function (text) {\r\n            return {\r\n                label: self.availableSearchTypes[TC.Consts.searchType.COORDINATES].label || self.getLocaleString('search.list.coordinates')\r\n            };\r\n        }\r\n    };\r\n\r\n    self.queryProperties = {\r\n        QUERYWORD: 'QueryWord',\r\n        FIRST: 'first',\r\n        SECOND: 'second',\r\n        THIRD: 'third'\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        url: '//idena.navarra.es/ogc/wfs',\r\n        featurePrefix: 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'CATAST_Pol_Municipio',\r\n        dataIdProperty: ['CMUNICIPIO'],\r\n        queryProperties: {\r\n            firstQueryWord: ['MUNINOAC', 'MUNICIPIO']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.municipality\",\r\n            color: \"strokeColor\"\r\n        },\r\n        outputProperties: ['MUNICIPIO'],\r\n        outputFormatLabel: '{0}',\r\n        searchWeight: 1,\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#fe06a5',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.MUNICIPALITY]),\r\n        stringPatternToCheck: self.stringPatternsValidators.s_or_t,\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    //self.availableSearchTypes[TC.Consts.searchType.LOCALITY] = {\r\n    //    root: null,\r\n    //    limit: false,\r\n    //    url: self.url || '//idena.navarra.es/ogc/wfs',\r\n    //    version: self.version || '1.1.0',\r\n    //    outputFormat: TC.Consts.format.JSON,\r\n    //    featurePrefix: self.featurePrefix || 'IDENA',\r\n    //    geometryName: 'the_geom',\r\n    //    featureType: ['CATAST_Pol_Municipio', 'ESTADI_Pol_EntidadPob'],\r\n    //    renderFeatureType: ['CATAST_Pol_Municipio'],\r\n    //    dataIdProperty: {\r\n    //        CATAST_Pol_Municipio: ['CMUNICIPIO'],\r\n    //        ESTADI_Pol_EntidadPob: ['CMUNICIPIO', 'CENTIDAD']\r\n    //    },\r\n    //    queryProperties: {\r\n    //        firstQueryWord: {\r\n    //            CATAST_Pol_Municipio: ['MUNINOAC', 'MUNICIPIO'],\r\n    //            ESTADI_Pol_EntidadPob: ['ENTINOAC', 'ENTIDAD']\r\n    //        }\r\n    //    },\r\n    //    suggestionListHead: {\r\n    //        label: \"search.list.locality\",\r\n    //        color: \"strokeColor\"\r\n    //    },\r\n    //    outputProperties: {\r\n    //        CATAST_Pol_Municipio: ['MUNICIPIO'],\r\n    //        ESTADI_Pol_EntidadPob: ['MUNICIPIO', 'ENTIDAD']\r\n    //    },\r\n    //    outputFormatLabel: {\r\n    //        CATAST_Pol_Municipio: '{0}',\r\n    //        ESTADI_Pol_EntidadPob: '{1} ({0})'\r\n    //    },\r\n    //    searchWeight: 1,\r\n    //    styles: [\r\n    //        {\r\n    //            polygon: {\r\n    //                fillColor: '#000000',\r\n    //                fillOpacity: 0,\r\n    //                strokeColor: '#ffffff',\r\n    //                strokeWidth: 5,\r\n    //                strokeOpacity: 1\r\n    //            }\r\n    //        },\r\n    //        {\r\n    //            polygon: {\r\n    //                fillColor: '#000000',\r\n    //                fillOpacity: 0.1,\r\n    //                strokeColor: '#feba1e',\r\n    //                strokeWidth: 2,\r\n    //                strokeOpacity: 1\r\n    //            }\r\n    //        }\r\n    //    ],\r\n    //    parser: self.getStringPattern.bind(this, [TC.Consts.searchType.LOCALITY]),\r\n    //    goTo: self.goToStringPattern\r\n    //};\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.COUNCIL] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'CATAST_Pol_Concejo',\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMUNICIPIO', 'CCONCEJO'],\r\n        queryProperties: {\r\n            firstQueryWord: ['CONCEJO']\r\n        },\r\n        outputProperties: ['MUNICIPIO', 'CONCEJO'],\r\n        outputFormatLabel: '{1} ({0})',\r\n        searchWeight: 4,\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.COUNCIL]),\r\n        stringPatternToCheck: self.stringPatternsValidators.s_or_t,\r\n        goTo: self.goToStringPattern,\r\n        idPropertiesIdentifier: '#',\r\n        suggestionListHead: {\r\n            label: \"search.list.council\",\r\n            color: \"strokeColor\"\r\n        },\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#49006a',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            }\r\n        ]\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.STREET] = {\r\n        root: null,\r\n        limit: null,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        renderFeatureType: 'CATAST_Txt_Calle',\r\n        featureType: 'CATAST_Lin_CalleEje',\r\n        dataIdProperty: ['CVIA'],\r\n        searchWeight: 5,\r\n        queryProperties: {\r\n            firstQueryWord: ['ENTINOAC', 'ENTIDADC'],\r\n            secondQueryWord: ['VIA', 'VIANOAC']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.street\",\r\n            color: \"strokeColor\"\r\n        },\r\n        outputProperties: ['ENTIDADC', 'VIA', 'CVIA', 'CENTIDADC', 'CMUNICIPIO'],\r\n        outputFormatLabel: '{1}, {0}',\r\n        styles: [\r\n            {\r\n                line: {\r\n                    strokeColor: \"#CB0000\",\r\n                    strokeOpacity: 1,\r\n                    strokeWidth: 2,\r\n                    strokeLinecap: \"round\",\r\n                    strokeDashstyle: \"solid\"\r\n                }\r\n            },\r\n            {\r\n                point: {\r\n                    label: \"VIA\",\r\n                    angle: \"CADANGLE\",\r\n                    fontColor: \"#000000\",\r\n                    fontSize: 10,\r\n                    fontWeight: \"bold\",\r\n                    labelOutlineColor: \"#FFFFFF\",\r\n                    labelOutlineWidth: 4\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.STREET]),\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.NUMBER] = {\r\n        root: null,\r\n        limit: null,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'CATAST_Txt_Portal',\r\n        renderFeatureType: '',\r\n        searchWeight: 6,\r\n        dataIdProperty: ['CMUNICIPIO', 'CENTIDADC', 'CVIA', 'PORTAL'],\r\n        queryProperties: {\r\n            firstQueryWord: ['ENTIDADC', 'ENTINOAC'],\r\n            secondQueryWord: ['VIA', 'VIANOAC'],\r\n            thirdQueryWord: ['PORTAL']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.number\",\r\n            color: \"fontColor\"\r\n        },\r\n        outputProperties: ['ENTIDADC', 'VIA', 'PORTAL', 'CVIA', 'CENTIDADC', 'CMUNICIPIO'],\r\n        outputFormatLabel: '{1} {2}, {0}',\r\n        styles: [\r\n            {\r\n                point: {\r\n                    radius: 0,\r\n                    label: \"PORTAL\",\r\n                    angle: \"CADANGLE\",\r\n                    fontColor: \"#CB0000\",\r\n                    fontSize: 14,\r\n                    labelOutlineColor: \"#FFFFFF\",\r\n                    labelOutlineWidth: 4\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.NUMBER]),\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.URBAN] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'ESTADI_Pol_EntidadPob',\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMUNICIPIO', 'CENTIDAD'],\r\n        idPropertiesIdentifier: '#',\r\n        queryProperties: {\r\n            firstQueryWord: ['ENTINOAC', 'ENTIDAD']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.urban\",\r\n            color: \"strokeColor\"\r\n        },\r\n        outputProperties: ['MUNICIPIO', 'ENTIDAD'],\r\n        outputFormatLabel: '{1} ({0})',\r\n        searchWeight: 2,\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#feba1e',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.URBAN]),\r\n        stringPatternToCheck: self.stringPatternsValidators.s_or_t,\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.PLACENAME] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'TOPONI_Txt_Toponimos',\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CTOPONIMO'],\r\n        idPropertiesIdentifier: '#',\r\n        queryProperties: {\r\n            firstQueryWord: ['TOPONIMO', 'TOPONINOAC']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.placeName\",\r\n            color: \"fontColor\"\r\n        },\r\n        outputProperties: ['MUNICIPIO', 'TOPONIMO', 'CMUNICIPIO', 'CTOPONIMO'],\r\n        outputFormatLabel: '{1} ({0})',\r\n        searchWeight: 7,\r\n        /*filterByMatch: true, // si queremos que filtre por expresión regular */\r\n        styles: [\r\n            {\r\n                point: {\r\n                    radius: 0,\r\n                    label: \"CADTEXT\",\r\n                    angle: \"CADANGLE\",\r\n                    fontColor: \"#ff5722\",\r\n                    fontSize: 14,\r\n                    labelOutlineColor: \"#FFFFFF\",\r\n                    labelOutlineWidth: 4\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.PLACENAME]),\r\n        stringPatternToCheck: self.stringPatternsValidators.s_or_t,\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.PLACENAMEMUNICIPALITY] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'TOPONI_Txt_Toponimos',\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMUNICIPIO', 'CTOPONIMO'],\r\n        idPropertiesIdentifier: '#',\r\n        queryProperties: {\r\n            firstQueryWord: ['MUNICIPIO', 'MUNINOAC'],\r\n            secondQueryWord: ['TOPONIMO', 'TOPONINOAC']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.placeName\",\r\n            color: \"fontColor\"\r\n        },\r\n        outputProperties: ['MUNICIPIO', 'TOPONIMO', 'CMUNICIPIO', 'CTOPONIMO'],\r\n        outputFormatLabel: '{1} ({0})',\r\n        searchWeight: 8,\r\n        /*filterByMatch: true, si queremos que filtre por expresión regular */\r\n        styles: [\r\n            {\r\n                point: {\r\n                    radius: 0,\r\n                    label: \"CADTEXT\",\r\n                    angle: \"CADANGLE\",\r\n                    fontColor: \"#ff5722\",\r\n                    fontSize: 14,\r\n                    labelOutlineColor: \"#FFFFFF\",\r\n                    labelOutlineWidth: 4\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.PLACENAMEMUNICIPALITY]),\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.COMMONWEALTH] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: ['POLUCI_Pol_MancoRSUg'],\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMANCOMUNI'],\r\n        queryProperties: {\r\n            firstQueryWord: ['MANCOMUNID']\r\n        },\r\n        outputProperties: ['MANCOMUNID'],\r\n        outputFormatLabel: '{0}',\r\n        searchWeight: 9,\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#fc4e2a',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            }\r\n        ]\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.ROAD] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'INFRAE_Lin_CtraEje',\r\n        dataIdProperty: ['DCARRETERA'],\r\n        queryProperties: {\r\n            firstQueryWord: ['DCARRETERA']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.road\",\r\n            color: \"strokeColor\"\r\n        },\r\n        outputProperties: ['DCARRETERA'],\r\n        outputFormatLabel: self.getLocaleString('search.list.road.shorter') + ': ' + '{0}',\r\n        searchWeight: 10,\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    strokeColor: \"#00b2fc\",\r\n                    strokeOpacity: 1,\r\n                    strokeWidth: 5\r\n                },\r\n                line: {\r\n                    strokeColor: \"#00b2fc\",\r\n                    strokeOpacity: 1,\r\n                    strokeWidth: 5,\r\n                    strokeLinecap: \"round\",\r\n                    strokeDashstyle: \"solid\"\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getRoad,\r\n        goTo: self.goToRoad,\r\n        pattern: function () {\r\n            return new RegExp(\"^(?:(?:\" + self.getLocaleString(\"search.list.road\") + \"|\" + self.getLocaleString(\"search.list.road.shorter\") + \")\\\\:?)?\\\\s*((A?|AP?|N?|R?|E?|[A-Z]{2}?|[A-Z]{1}?)\\\\s*\\\\-?\\\\s*(\\\\d{1,4})\\\\s*\\\\-?\\\\s*(A?|B?|C?|R?))$\", \"i\")\r\n        }\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.ROADPK] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'INFRAE_Sym_CtraPK',\r\n        dataIdProperty: ['DCARRETERA', 'CPK'],\r\n        queryProperties: {\r\n            firstQueryWord: ['DCARRETERA'],\r\n            secondQueryWord: ['PK']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.pk.larger\",\r\n            color: \"fontColor\"\r\n        },\r\n        outputProperties: ['DCARRETERA', 'PK'],\r\n        outputFormatLabel: self.getLocaleString('search.list.road.shorter') + ': {0} ' + self.getLocaleString('search.list.pk') + ': {1}',\r\n        searchWeight: 11,\r\n        styles: [\r\n            {\r\n                point: {\r\n                    label: [\"DCARRETERA\", \"PK\"],\r\n                    fontColor: \"#00b2fc\",\r\n                    fontSize: 14,\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 2\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getPK,\r\n        goTo: self.goToPK,\r\n        pattern: function () {\r\n            return new RegExp(\"^(?:(?:\" + self.getLocaleString(\"search.list.road\") + \"|\" + self.getLocaleString(\"search.list.road.shorter\") + \")\\\\:?)?\\\\s*((A?|AP?|N?|R?|E?|[A-Z]{2}?|[A-Z]{1}?)\\\\s*\\\\-?\\\\s*(\\\\d{1,4})\\\\s*\\\\-?\\\\s*(A?|B?|C?|R?))\\\\s*\\\\,*\\\\s*(?:(?:\" + self.getLocaleString(\"search.list.pk\") + \"\\\\:?)|(?:P\\\\:?)|(?:K\\\\:?)|(?:KM\\\\:?)|(?:\\\\s+|\\\\,+))\\\\s*(\\\\d{1,4})$\", \"i\")\r\n        }\r\n    };\r\n\r\n    self.rootCfg = {};\r\n    self.rootCfg[TC.Consts.searchType.MUNICIPALITY] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'CATAST_Pol_Municipio',\r\n        dataIdProperty: ['CMUNICIPIO'],\r\n        queryProperties: {\r\n            firstQueryWord: ['MUNICIPIO']\r\n        },\r\n        outputProperties: ['MUNICIPIO'],\r\n        outputFormatLabel: '{0}',\r\n        getRootLabel: function () {\r\n            return new Promise(function (resolve, reject) {\r\n\r\n                if (self.rootCfg.active && !self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel) {\r\n\r\n                    var params = {};\r\n                    params.SERVICE = 'WFS';\r\n                    params.VERSION = self.rootCfg[TC.Consts.searchType.MUNICIPALITY].version;\r\n                    params.REQUEST = 'GetFeature';\r\n                    params.TYPENAME = self.rootCfg[TC.Consts.searchType.MUNICIPALITY].featurePrefix + ':' + self.rootCfg[TC.Consts.searchType.MUNICIPALITY].featureType;\r\n                    params.OUTPUTFORMAT = self.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputFormat;\r\n                    params.PROPERTYNAME = ['CMUNICIPIO'].concat(self.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties).join(',');\r\n\r\n                    params.CQL_FILTER = self.rootCfg[TC.Consts.searchType.MUNICIPALITY].root.map(function (elem) {\r\n                        return ['CMUNICIPIO'].map(function (id, index) {\r\n                            return id + '=' + elem[index];\r\n                        }).join(' AND ');\r\n                    });\r\n\r\n                    params.CQL_FILTER = params.CQL_FILTER.join(' OR ');\r\n\r\n                    TC.ajax({\r\n                        url: self.rootCfg[TC.Consts.searchType.MUNICIPALITY].url + '?' + $.param(params),\r\n                        method: 'GET',\r\n                        responseType: TC.Consts.mimeType.JSON\r\n                    }).then(function (data) {\r\n                        if (data.totalFeatures > 0) {\r\n\r\n                            self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel = data.features.map(function (feature) {\r\n                                return {\r\n                                    id: ['CMUNICIPIO'].map(function (elem) {\r\n                                        return feature.properties[elem];\r\n                                    }).join('#'),\r\n                                    label: feature.properties[self.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties[0]].toLowerCase()\r\n                                };\r\n                            });\r\n\r\n                            resolve(self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel);\r\n\r\n                        } else {\r\n                            self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel = [];\r\n                            resolve(self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel);\r\n                        }\r\n                    }).catch(function () {\r\n                        resolve([]);\r\n                    });\r\n                }\r\n                else {\r\n                    resolve(self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel);\r\n                }\r\n            });\r\n        }\r\n    };\r\n    self.rootCfg[TC.Consts.searchType.LOCALITY] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: ['ESTADI_Pol_EntidadPob'],\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMUNICIPIO', 'CENTIDADC'],\r\n        queryProperties: {\r\n            firstQueryWord: ['ENTINOAC']\r\n        },\r\n        outputProperties: ['ENTINOAC'],\r\n        getRootLabel: function () {\r\n            return new Promise(function (resolve, reject) {\r\n                if (self.rootCfg.active && !self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel) {\r\n\r\n                    var params = {};\r\n                    params.SERVICE = 'WFS';\r\n                    params.VERSION = self.rootCfg[TC.Consts.searchType.LOCALITY].version;\r\n                    params.REQUEST = 'GetFeature';\r\n                    params.TYPENAME = self.rootCfg[TC.Consts.searchType.LOCALITY].featurePrefix + ':' + self.rootCfg[TC.Consts.searchType.LOCALITY].featureType;\r\n                    params.OUTPUTFORMAT = self.rootCfg[TC.Consts.searchType.LOCALITY].outputFormat;\r\n                    params.PROPERTYNAME = ['CMUNICIPIO', 'CENTIDAD'].concat(self.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties).join(',');\r\n\r\n                    params.CQL_FILTER = self.rootCfg[TC.Consts.searchType.LOCALITY].root.map(function (elem) {\r\n                        return ['CMUNICIPIO', 'CENTIDAD'].map(function (id, index) {\r\n                            return id + '=' + elem[index];\r\n                        }).join(' AND ');\r\n                    });\r\n\r\n                    params.CQL_FILTER = params.CQL_FILTER.join(' OR ');\r\n\r\n                    TC.ajax({\r\n                        url: self.rootCfg[TC.Consts.searchType.LOCALITY].url + '?' + $.param(params),\r\n                        method: 'GET',\r\n                        responseType: TC.Consts.mimeType.JSON\r\n                    }).then(function (data) {\r\n                        if (data.totalFeatures > 0) {\r\n\r\n                            self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel = data.features.map(function (feature) {\r\n                                return {\r\n                                    id: ['CMUNICIPIO', 'CENTIDAD'].map(function (elem) {\r\n                                        return feature.properties[elem];\r\n                                    }).join('#'),\r\n                                    label: feature.properties[self.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties[0]].toLowerCase()\r\n                                };\r\n                            });\r\n\r\n                            resolve(self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel);\r\n\r\n                        } else {\r\n                            self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel = [];\r\n                            resolve(self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel);\r\n                        }\r\n                    }).catch(function () {\r\n                        resolve([]);\r\n                    });\r\n                }\r\n                else {\r\n                    resolve(self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel);\r\n                }\r\n            });\r\n            return done;\r\n        }\r\n    };\r\n\r\n    self.allowedSearchTypes = [];\r\n\r\n    if (self.options.allowedSearchTypes) {\r\n        for (var allowed in self.options.allowedSearchTypes) {\r\n\r\n            if (self.availableSearchTypes[allowed] && !$.isEmptyObject(self.options.allowedSearchTypes[allowed])) {\r\n\r\n                // GLS: gestionamos el override de featureType y renderFeatureType.\r\n                // Si por defecto cuenta con renderFeatureType y sobrescribe featureType y no renderFeatureType, \r\n                // elimino la propiedad renderFeatureType y elimino el último estilo definido, que se corresponde con el de renderFeatureType.\r\n                if (self.availableSearchTypes[allowed].renderFeatureType && self.availableSearchTypes[allowed].renderFeatureType.length > 0 &&\r\n                    self.options.allowedSearchTypes[allowed].featureType && !self.options.allowedSearchTypes[allowed].renderFeatureType) {\r\n\r\n                    delete self.availableSearchTypes[allowed].renderFeatureType;\r\n                    self.availableSearchTypes[allowed].styles = self.availableSearchTypes[allowed].styles.slice(0, self.availableSearchTypes[allowed].styles.length - 1);\r\n                }\r\n\r\n                // GLS: override de la configuración por defecto con la del config.JSON\r\n                $.extend(self.availableSearchTypes[allowed], self.options.allowedSearchTypes[allowed]);\r\n\r\n\r\n                // GLS: Limitamos la búsqueda en portales y calles cuando así se establezca en la configuración de las búsquedas\r\n                if (self.options.allowedSearchTypes[allowed].root &&\r\n                    (allowed != TC.Consts.searchType.MUNICIPALITY && self.options.allowedSearchTypes[allowed].rootType == TC.Consts.searchType.MUNICIPALITY) ||\r\n                    (allowed != TC.Consts.searchType.LOCALITY && self.options.allowedSearchTypes[allowed].rootType == TC.Consts.searchType.LOCALITY)) {\r\n\r\n                    self.rootCfg.active = self.rootCfg[self.options.allowedSearchTypes[allowed].rootType];\r\n                    self.rootCfg.active.root = self.options.allowedSearchTypes[allowed].root;\r\n                    self.rootCfg.active.limit = self.options.allowedSearchTypes[allowed].limit;\r\n\r\n                    self.availableSearchTypes[TC.Consts.searchType.STREET].queryProperties.firstQueryWord =\r\n                        self.availableSearchTypes[TC.Consts.searchType.NUMBER].queryProperties.firstQueryWord =\r\n                        self.rootCfg.active.dataIdProperty;\r\n                }\r\n            }\r\n\r\n            // Si esta a false lo borramos de las disponibles\r\n            if (!self.options.allowedSearchTypes[allowed]) {\r\n                delete self.options.allowedSearchTypes[allowed];\r\n            } else {\r\n                self.addAllowedSearchType(allowed, self.availableSearchTypes[allowed] ? self.availableSearchTypes[allowed] : self.options.allowedSearchTypes[allowed], self);\r\n            }\r\n        }\r\n    }\r\n\r\n    if (self.rootCfg.active) {\r\n        self.rootCfg.active.getRootLabel();\r\n    }\r\n\r\n    self.queryableFeatures = self.options.queryableFeatures || false;\r\n\r\n    self.UTMX_LEN = 6;\r\n    self.UTMY_LEN = 7;\r\n\r\n    self.wrap = new TC.wrap.control.Search(self);\r\n\r\n    self.interval = 500;\r\n\r\n    self.NORMAL_PATTERNS = {\r\n        ROMAN_NUMBER: /M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3}){1,}?\\S?\\./i,\r\n        ABSOLUTE_NOT_DOT: /[`~!@#$%^&*_|+\\=?;:'\"\\{\\}\\[\\]\\\\]/gi,\r\n        ABSOLUTE: /[`~!@#$%^&*_|+\\=?;:'.\\{\\}\\[\\]\\\\]/gi\r\n    };\r\n};\r\n\r\nTC.inherit(TC.control.Search, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Search.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-search';\r\n\r\n    TC.Consts.event.SEARCHQUERYEMPTY = TC.Consts.event.SEARCHQUERYEMPTY || 'searchqueryempty.tc';\r\n\r\n    if (TC.isDebug) {\r\n        ctlProto.template = TC.apiLocation + \"TC/templates/Search.html\";\r\n    }\r\n    else {\r\n        ctlProto.template = function () {\r\n            dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"search.1\" }).w(\"</h2><div class=\\\"tc-ctl-search-content\\\"><input type=\\\"search\\\" class=\\\"tc-ctl-search-txt\\\" placeholder=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"search.placeholder\" }).w(\"\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"search.instructions\" }).w(\"\\\" /><a title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"search.instructions\" }).w(\"\\\" class=\\\"tc-ctl-btn tc-ctl-search-btn\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"search.2\" }).w(\"</a><ul class=\\\"tc-ctl-search-list tc-hidden\\\"></ul></div>\"); } body_0.__dustBody = !0; return body_0\r\n        };\r\n    }\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self._search = {\r\n            data: []\r\n        };\r\n\r\n        self.layerStyleFN = (function () {\r\n            function getFeatureType(idFeature) {\r\n                return idFeature.indexOf('.') > -1 ? idFeature.split('.')[0] : idFeature;\r\n            };\r\n            function getStyle(property, geomType, id) {\r\n\r\n                var type = self.getSearchTypeByFeature(id);\r\n                if (type) {\r\n                    var style = type.getStyleByFeatureType(getFeatureType(id));\r\n\r\n                    if (style && style.hasOwnProperty(geomType)) {\r\n                        return style[geomType][property];\r\n                    }\r\n                }\r\n\r\n                return TC.Cfg.styles[geomType][property];\r\n            };\r\n\r\n            return function (geomType, property, extractValue, f) {\r\n                var self = this;\r\n\r\n                if (TC.Feature && !(f instanceof TC.Feature)) {\r\n                    self.map.trigger(TC.Consts.event.FEATURESADD, { layer: self.layer, geom: f.geom });\r\n                }\r\n\r\n                var prop = getStyle(property, geomType, getFeatureType(f.id));\r\n                if (extractValue) {\r\n                    if (prop instanceof Array) {\r\n                        var values = prop.map(function (p) {\r\n                            return f.getData().hasOwnProperty(p) ? f.getData()[p] : '';\r\n                        });\r\n                        var searchType = this.getSearchTypeByFeature(getFeatureType(f.id));\r\n                        if (searchType) {\r\n                            return searchType.outputFormatLabel.tcFormat(values);\r\n                        } else {\r\n                            return values.join(' ');\r\n                        }\r\n                    } else {\r\n                        return f.getData().hasOwnProperty(prop) ? f.getData()[prop] : '';\r\n                    }\r\n                }\r\n                else {\r\n                    return prop;\r\n                }\r\n            };\r\n        }());\r\n\r\n        var styleFN = self.layerStyleFN;\r\n\r\n        self.layerPromise = map.addLayer({\r\n            id: self.getUID(),\r\n            title: 'Búsquedas',\r\n            stealth: true,\r\n            declutter: true,\r\n            type: TC.Consts.layerType.VECTOR,\r\n            styles: {\r\n                polygon: {\r\n                    fillColor: styleFN.bind(self, 'polygon', 'fillColor', false),\r\n                    fillOpacity: styleFN.bind(self, 'polygon', 'fillOpacity', false),\r\n                    strokeColor: styleFN.bind(self, 'polygon', 'strokeColor', false),\r\n                    strokeOpacity: styleFN.bind(self, 'polygon', 'strokeOpacity', false),\r\n                    strokeWidth: styleFN.bind(self, 'polygon', 'strokeWidth', false)\r\n                },\r\n                line: {\r\n                    strokeColor: styleFN.bind(self, 'line', 'strokeColor', false),\r\n                    strokeOpacity: styleFN.bind(self, 'line', 'strokeOpacity', false),\r\n                    strokeWidth: styleFN.bind(self, 'line', 'strokeWidth', false)\r\n                },\r\n                marker: {\r\n                    anchor: TC.Defaults.styles.marker.anchor,\r\n                    height: TC.Defaults.styles.marker.height,\r\n                    width: TC.Defaults.styles.marker.width\r\n                },\r\n                point: {\r\n                    radius: styleFN.bind(self, 'point', 'radius', false),\r\n                    height: styleFN.bind(self, 'point', 'height', false),\r\n                    width: styleFN.bind(self, 'point', 'width', false),\r\n                    fillColor: styleFN.bind(self, 'point', 'fillColor', false),\r\n                    fillOpacity: styleFN.bind(self, 'point', 'fillOpacity', false),\r\n                    strokeColor: styleFN.bind(self, 'point', 'strokeColor', false),\r\n                    strokeWidth: styleFN.bind(self, 'point', 'strokeWidth', false),\r\n                    fontSize: styleFN.bind(self, 'point', 'fontSize', false),\r\n                    fontColor: styleFN.bind(self, 'point', 'fontColor', false),\r\n                    labelOutlineColor: styleFN.bind(self, 'point', 'labelOutlineColor', false),\r\n                    labelOutlineWidth: styleFN.bind(self, 'point', 'labelOutlineWidth', false),\r\n                    label: styleFN.bind(self, 'point', 'label', true),\r\n                    angle: styleFN.bind(self, 'point', 'angle', true)\r\n                }\r\n            }\r\n        })\r\n            .then(function (layer) {\r\n                self.layer = layer;\r\n                return layer;\r\n            });\r\n\r\n        self.EMPTY_RESULTS_LABEL = self.getLocaleString('noResults');\r\n        self.EMPTY_RESULTS_TITLE = self.getLocaleString('checkCriterion');\r\n        self.OUTBBX_LABEL = self.getLocaleString('outsideOfLimits');\r\n\r\n        self.WFS_TYPE_ATTRS = [\"url\", \"version\", \"geometryName\", \"featurePrefix\", \"featureType\", \"properties\", \"outputFormat\"];\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.renderData = function (data, callback) {\r\n        var self = this;\r\n\r\n        self._search = self._search || {};\r\n\r\n        var _search = function () {\r\n            self.search(self.textInput.value, function (list) {\r\n                if (list.length === 1) {\r\n                    self.textInput.value = list[0].label;\r\n                    self._goToResult(list[0].id, self.resultsList.querySelector('li:not([header])').getAttribute('dataRole'));\r\n                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n                else if (list.length === 0) {\r\n                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            });\r\n        };\r\n\r\n        return TC.Control.prototype.renderData.call(self, data, function () {\r\n\r\n            // desde keypress y desde la lupa\r\n            var _research = function () {\r\n                self.textInput.value = self.resultsList.label || self.resultsList.querySelector('li:not([header]) > a > span').textContent;\r\n                self.lastPattern = self.textInput.value;\r\n                self._goToResult(self.resultsList.id || unescape(self.resultsList.querySelector('li:not([header]) > a').getAttribute('href')).substring(1), self.resultsList.querySelector('li:not([header])').getAttribute('dataRole'));\r\n                self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n            };\r\n\r\n            self.textInput = self.div.querySelector('input.tc-ctl-search-txt');\r\n            if (self.options && self.options.placeHolder) {\r\n                self.textInput.setAttribute('placeHolder', self.options.placeHolder.trim());\r\n            }\r\n\r\n            self.resultsList = self.div.querySelector('.tc-ctl-search-list');\r\n            self.$list = $(self.resultsList);\r\n            self.button = self.div.querySelector('.tc-ctl-search-btn');\r\n            self.button.addEventListener(TC.Consts.event.CLICK, function () {\r\n                self.getLayer().then(function (l) {\r\n                    if (self.resultsList.querySelectorAll('li > a:not(.tc-ctl-search-li-loading):not(.tc-ctl-search-li-empty)').length > 1) { }\r\n                    else if (l.features.length > 0) {\r\n                        l.map.zoomToFeatures(l.features);\r\n                    }\r\n                    else if (self.resultsList.querySelectorAll('li > a:not(.tc-ctl-search-li-loading):not(.tc-ctl-search-li-empty)').length === 1) {\r\n                        _research();\r\n                    }\r\n                    else {\r\n                        self.textInput.dispatchEvent(new Event(\"keyup\"));\r\n                    }\r\n                });\r\n            });\r\n            if (self.options.instructions) {\r\n                self.textInput.setAttribute('title', self.options.instructions.trim());\r\n                self.button.setAttribute('title', self.options.instructions.trim());\r\n            }\r\n\r\n            // GLS: añadimos la funcionalidad al mensaje de \"No hay resultados\", al hacer click repliega el mensaje.\r\n            self.resultsList.addEventListener(TC.Consts.event.CLICK, TC.EventTarget.listenerBySelector('a.tc-ctl-search-li-empty', function () {\r\n                self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                self.textInput.focus();\r\n            }));\r\n\r\n\r\n            // IE10 polyfill\r\n            try {\r\n                if (self.textInput.classList.contains('::-ms-clear')) {\r\n                    var oldValue;\r\n                    self.textInput.addEventListener('mouseup', function (e) {\r\n                        oldValue = self.textInput.value;\r\n\r\n                        if (oldValue === '') {\r\n                            return;\r\n                        }\r\n\r\n                        // When this event is fired after clicking on the clear button\r\n                        // the value is not cleared yet. We have to wait for it.\r\n                        setTimeout(function () {\r\n                            var newValue = self.textInput.value;\r\n\r\n                            if (newValue === '') {\r\n                                self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                                // Gotcha\r\n                                _search();\r\n                            }\r\n                        }, 1);\r\n                    });\r\n                }\r\n            }\r\n            catch (e) { }\r\n\r\n            self.textInput.addEventListener('keypress', function (e) {\r\n                if (e.which == 13) {\r\n                    e.preventDefault();\r\n                    e.stopPropagation();\r\n\r\n                    self.lastPattern = \"\";\r\n\r\n                    if (self.resultsList.querySelectorAll('li > a:not(.tc-ctl-search-li-loading):not(.tc-ctl-search-li-empty)').length === 1) {\r\n                        _research();\r\n                    } else {\r\n                        _search();\r\n                    }\r\n                    return false;\r\n                }\r\n            });\r\n            self.textInput.addEventListener(\"search\", function () {\r\n                if (self.textInput.value.length === 0) {\r\n                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                    _search();\r\n                }\r\n            });\r\n            self.textInput.addEventListener(\"input\", function () {\r\n                if (self.textInput.value.length === 0) {\r\n                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                    _search();\r\n                }\r\n            });\r\n            self.textInput.addEventListener(\"targetCleared.autocomplete\", function () {\r\n                self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n            })\r\n            self.textInput.addEventListener(\"targetUpdated.autocomplete\", function () {\r\n                if (self.resultsList.querySelectorAll('li').length > 0) {\r\n                    self.resultsList.classList.remove(TC.Consts.classes.HIDDEN);\r\n                }\r\n            });\r\n\r\n            self.lastPattern = '';\r\n            self.retryTimeout = null;\r\n            TC.loadJS(\r\n                !TC.UI || !TC.UI.autocomplete,\r\n                [TC.apiLocation + 'TC/ui/autocomplete.js'],\r\n                function () {\r\n                    var searchDelay;\r\n\r\n                    const source = function (text, callback) {\r\n                        self.lastpress = performance.now();\r\n\r\n                        if (!searchDelay) {\r\n                            function step() {\r\n                                var criteria = self.textInput.value.trim();\r\n\r\n                                if (criteria.length > 0 &&\r\n                                    (!self.lastPattern || criteria != self.lastPattern) &&\r\n                                    performance.now() - self.lastpress > self.interval) {\r\n\r\n                                    window.cancelAnimationFrame(searchDelay);\r\n                                    searchDelay = undefined;\r\n\r\n                                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                                    // Pendiente de afinar\r\n                                    //if (self.lastPattern && criteria.substring(0, criteria.lastIndexOf(' ')) == self.lastPattern) {                                            \r\n\r\n                                    //    // Si el patrón de búsqueda anterior y actual es el mismo más algo nuevo (típico en la búsqueda de un portal), lo nuevo lo separo por coma\r\n                                    //    // self.lastPattern: \"Calle Cataluña/Katalunia Kalea, Pamplona\"\r\n                                    //    // text: \"Calle Cataluña/Katalunia Kalea, Pamplona 18\"\r\n\r\n                                    //    criteria = criteria.substring(0, criteria.lastIndexOf(' ')) + (self.lastPattern.trim().endsWith(',') ? \"\" : \",\") + criteria.substring(criteria.lastIndexOf(' '));\r\n                                    //}\r\n\r\n                                    self.lastPattern = criteria;\r\n\r\n                                    self.search(criteria, callback);\r\n                                } else {\r\n                                    searchDelay = requestAnimationFrame(step);\r\n                                }\r\n                            }\r\n\r\n                            searchDelay = requestAnimationFrame(step);\r\n                        }\r\n                    };\r\n\r\n                    var closest = function (el, selector) {\r\n                        const matchesSelector = el.matches || el.webkitMatchesSelector || el.mozMatchesSelector || el.msMatchesSelector;\r\n\r\n                        while (el) {\r\n                            if (matchesSelector.call(el, selector)) {\r\n                                return el;\r\n                            } else {\r\n                                el = el.parentElement;\r\n                            }\r\n                        }\r\n                        return null;\r\n                    };\r\n\r\n                    const callback = function (e) {\r\n                        var _target = e.target;\r\n\r\n                        if (e.target.tagName.toLowerCase() !== 'a') {\r\n                            _target = closest(e.target, 'a');\r\n                        }\r\n\r\n                        if (_target.querySelector('span[hidden]')) {\r\n                            self.textInput.value = _target.querySelector('span[hidden]').textContent;\r\n                            self.lastPattern = self.textInput.value;\r\n                            self._goToResult(unescape(_target.getAttribute('href')).substring(1), _target.parentNode.getAttribute('dataRole'));\r\n                            TC.UI.autocomplete.call(self.textInput, 'clear');\r\n                        }\r\n                    };\r\n\r\n                    const buildHTML = function (results) {\r\n\r\n                        var html = [];\r\n                        var dataRoles = [];\r\n\r\n                        var reA = /[^a-zA-Z]/g;\r\n                        var reN = /[^0-9]/g;\r\n                        function sortAlphaNum(a, b) {\r\n                            var AInt = parseInt(a, 10);\r\n                            var BInt = parseInt(b, 10);\r\n\r\n                            if (isNaN(AInt) && isNaN(BInt)) {\r\n                                var aA = a.replace(reA, \"\");\r\n                                var bA = b.replace(reA, \"\");\r\n                                if (aA === bA) {\r\n                                    var aN = parseInt(a.replace(reN, \"\"), 10);\r\n                                    var bN = parseInt(b.replace(reN, \"\"), 10);\r\n                                    return aN === bN ? 0 : aN > bN ? 1 : -1;\r\n                                } else {\r\n                                    return aA > bA ? 1 : -1;\r\n                                }\r\n                            } else if (isNaN(AInt)) {//A is not an Int\r\n                                return 1;//to make alphanumeric sort first return -1 here\r\n                            } else if (isNaN(BInt)) {//B is not an Int\r\n                                return -1;//to make alphanumeric sort first return 1 here\r\n                            } else {\r\n                                return AInt > BInt ? 1 : -1;\r\n                            }\r\n                        };\r\n\r\n                        // ordenamos por roles y alfabéticamente\r\n                        var data = results.results.sort(function (a, b) {\r\n                            if (this.ctx.getSearchTypeByRole(a.dataRole).searchWeight && this.ctx.getSearchTypeByRole(b.dataRole).searchWeight) {\r\n                                if ((this.ctx.getSearchTypeByRole(a.dataRole).searchWeight || 0) > (this.ctx.getSearchTypeByRole(b.dataRole).searchWeight || 0)) {\r\n                                    return 1;\r\n                                } else if ((this.ctx.getSearchTypeByRole(a.dataRole).searchWeight || 0) < (this.ctx.getSearchTypeByRole(b.dataRole).searchWeight || 0)) {\r\n                                    return -1;\r\n                                }\r\n                                else {\r\n                                    return sortAlphaNum(a.label, b.label);\r\n                                }\r\n                            } else {\r\n                                if (a.dataRole > b.dataRole) {\r\n                                    return 1;\r\n                                }\r\n                                else if (a.dataRole < b.dataRole)\r\n                                    return -1;\r\n                                else {\r\n                                    return sortAlphaNum(a.label, b.label);\r\n                                }\r\n                            }\r\n                        }.bind(this));\r\n\r\n                        if (self.rootCfg.active) {// si hay root, aplicamos el orden por entidades \r\n                            data = data.sort(function (a, b) {\r\n\r\n                                const sort_ = function () {\r\n                                    var first = this.rootCfg.active.root[0] instanceof Array ? this.rootCfg.active.root[0].join('-') : this.rootCfg.active.root[0];\r\n\r\n                                    var aRoot, bRoot;\r\n                                    if (a.properties && a.properties.length > 0 && b.properties && b.properties.length > 0) {\r\n                                        aRoot = this.rootCfg.active.dataIdProperty.map(function (elem) { return a.properties[elem].toString(); }).join('-');\r\n                                        bRoot = this.rootCfg.active.dataIdProperty.map(function (elem) { return b.properties[elem].toString(); }).join('-');\r\n                                    } else {\r\n                                        aRoot = a.id;\r\n                                        bRoot = b.id;\r\n                                    }\r\n\r\n                                    if (aRoot !== first && bRoot === first) {\r\n                                        return 1;\r\n                                    } else if (aRoot === first && bRoot !== first) {\r\n                                        return -1;\r\n                                    } else {\r\n                                        return sortAlphaNum(a.label, b.label);\r\n                                    }\r\n                                }.bind(this);\r\n\r\n                                if (this.getSearchTypeByRole(a.dataRole).searchWeight && this.getSearchTypeByRole(b.dataRole).searchWeight) {\r\n                                    if ((this.getSearchTypeByRole(a.dataRole).searchWeight || 0) > (this.getSearchTypeByRole(b.dataRole).searchWeight || 0)) {\r\n                                        return 1;\r\n                                    } else if ((this.getSearchTypeByRole(a.dataRole).searchWeight || 0) < (this.getSearchTypeByRole(b.dataRole).searchWeight || 0)) {\r\n                                        return -1;\r\n                                    }\r\n                                    else {\r\n                                        return sort_();\r\n                                    }\r\n                                }\r\n                                else {\r\n                                    return sort_();\r\n                                }\r\n\r\n                            }.bind(self));\r\n                        }\r\n\r\n                        for (var i = 0; i < data.length; i++) {\r\n                            var elm = data[i];\r\n\r\n                            if (dataRoles.indexOf(elm.dataRole) == -1) {\r\n\r\n                                var type = this.ctx.getSearchTypeByRole(elm.dataRole);\r\n\r\n                                html[html.length] = type.getSuggestionListHead();\r\n\r\n                                dataRoles.push(elm.dataRole);\r\n                            }\r\n\r\n                            const highlighting = function () {\r\n                                var highlighted = elm.label;\r\n                                var strReg = [];\r\n\r\n                                // eliminamos caracteres extraños del patrón ya analizado\r\n\r\n                                if (this.ctx.lastPattern.trim().length === 0 && self.textInput.value.trim().length > 0) {\r\n                                    this.ctx.lastPattern = self.textInput.value.trim();                                    \r\n                                }\r\n\r\n                                var normalizedLastPattern = this.ctx.lastPattern;\r\n                                if (self.NORMAL_PATTERNS.ROMAN_NUMBER.test(normalizedLastPattern))\r\n                                    normalizedLastPattern = normalizedLastPattern.replace(self.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT, '');\r\n                                else\r\n                                    normalizedLastPattern = normalizedLastPattern.replace(self.NORMAL_PATTERNS.ABSOLUTE, '');\r\n\r\n\r\n                                var querys = [];\r\n                                var separatorChar = ',';\r\n                                if (normalizedLastPattern.indexOf(separatorChar) == -1) {\r\n                                    separatorChar = ' ';\r\n                                }\r\n\r\n                                querys = normalizedLastPattern.trim().split(separatorChar);                                \r\n\r\n                                // si estamos tratando con coordenadas el separador es el espacio, no la coma\r\n                                if ((elm.label.indexOf(this.ctx.LAT_LABEL) > -1 && elm.label.indexOf(this.ctx.LON_LABEL) > -1) ||\r\n                                    (elm.label.indexOf(this.ctx.UTMX_LABEL) > -1 && elm.label.indexOf(this.ctx.UTMY_LABEL) > -1)) {\r\n                                    querys = this.ctx.lastPattern.split(' ');\r\n\r\n                                    for (var t = 0; t < querys.length; t++) {\r\n                                        if (querys[t].trim().slice(-1) == ',')\r\n                                            querys[t] = querys[t].slice(0, -1);\r\n                                    }\r\n                                }\r\n\r\n                                for (var q = 0; q < querys.length; q++) {\r\n                                    if (querys[q].trim().length > 0) {\r\n                                        strReg.push('(' + querys[q].trim().replace(/\\(/gi, \"\").replace(/\\)/gi, \"\") + ')');\r\n                                        var match = /((\\<)|(\\>)|(\\<\\>))/gi.exec(querys[q].trim());\r\n                                        if (match) {\r\n                                            var _strReg = querys[q].trim().replace(/((\\<)|(\\>)|(\\<\\>))/gi, '').split(' ');\r\n                                            for (var st = 0; st < _strReg.length; st++) {\r\n                                                if (_strReg[st].trim().length > 0)\r\n                                                    strReg.push('(' + _strReg[st].trim().replace(/\\(/gi, \"\\\\(\").replace(/\\)/gi, \"\\\\)\") + ')');\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n                                if (elm.dataRole == TC.Consts.searchType.ROAD || elm.dataRole == TC.Consts.searchType.ROADPK) {\r\n                                    var rPattern = self.getSearchTypeByRole(elm.dataRole).getPattern();\r\n                                    var match = rPattern.exec(this.ctx.lastPattern);\r\n\r\n                                    if (match) {\r\n                                        strReg = [];\r\n\r\n                                        if (match[2] && match[3] && match[4]) {\r\n                                            strReg.push('(' + match[2] + \"-\" + match[3] + \"-\" + match[4] + ')');\r\n                                        } else if (match[2] && match[3]) {\r\n                                            strReg.push('(' + match[2] + \"-\" + match[3] + ')');\r\n                                        } else if (match[3] && match[4]) {\r\n                                            strReg.push('(' + match[3] + \"-\" + match[4] + ')');\r\n                                        } else if (match[2] || match[3]) {\r\n                                            strReg.push('(' + (match[2] || match[3]) + ')');\r\n                                        }\r\n\r\n                                        if (match[5]) {\r\n                                            strReg.push(\"(?:\" + self.getLocaleString(\"search.list.pk\") + \"\\\\:\\\\s\\\\d*)\" + \"(\" + match[5] + \")\" + \"\\\\d*\");\r\n                                        }\r\n                                    } else if (match && match[5]) {\r\n                                        strReg = [];\r\n\r\n                                        strReg.push(\"(?:\" + self.getLocaleString(\"search.list.pk\") + \"\\\\:\\\\s\\\\d*)\" + \"(\" + match[5] + \")\" + \"\\\\d*\");\r\n                                    }\r\n                                }\r\n\r\n                                var pattern = '(' + strReg.join('|') + ')';\r\n\r\n                                pattern = pattern.replace(/á|à/gi, \"a\");\r\n                                pattern = pattern.replace(/é|è/gi, \"e\");\r\n                                pattern = pattern.replace(/í|ì/gi, \"i\");\r\n                                pattern = pattern.replace(/ó|ò/gi, \"o\");\r\n                                pattern = pattern.replace(/ú|ù/gi, \"u\");\r\n                                pattern = pattern.replace(/ü/gi, \"u\");\r\n\r\n                                pattern = pattern.replace(/a/gi, \"[a|á|à]\");\r\n                                pattern = pattern.replace(/e/gi, \"[e|é|è]\");\r\n                                pattern = pattern.replace(/i/gi, \"[i|í|ì]\");\r\n                                pattern = pattern.replace(/o/gi, \"[o|ó|ò]\");\r\n                                pattern = pattern.replace(/u/gi, \"[u|ú|ü|ù]\");\r\n                                var rex = new RegExp(pattern, \"gi\");\r\n\r\n                                var label = elm.label;\r\n\r\n                                if (elm.dataRole !== TC.Consts.searchType.ROAD || elm.dataRole !== TC.Consts.searchType.ROADPK) {\r\n                                    highlighted = label.replace(rex,\r\n                                        function () {\r\n                                            var params = Array.prototype.slice.call(arguments, 0);                                            \r\n\r\n                                            if (params[params.length - 3]) {\r\n                                                return params[0].replace(params[params.length - 3], \"<b>\" + params[params.length - 3] + \"</b>\");\r\n                                            } else {\r\n                                                return \"<b>\" + params[0] + \"</b>\";\r\n                                            }\r\n                                        });\r\n                                } else {\r\n                                    highlighted = label.replace(rex, \"<b>$1</b>\");\r\n                                }\r\n\r\n                                return highlighted;\r\n                            }.bind(this);\r\n\r\n                            html[html.length] = '<li dataRole=\"' + elm.dataRole + '\"><a href=\"' + '#' + encodeURIComponent(elm.id) + '\"><span hidden>' + elm.label + '</span>' + highlighting() + '</a></li>';\r\n                        }\r\n\r\n\r\n\r\n                        return html.join('');\r\n                    };\r\n\r\n                    TC.UI.autocomplete.call(self.textInput, {\r\n                        link: '#',\r\n                        target: self.resultsList,\r\n                        minLength: 2,\r\n                        ctx: self,\r\n                        source: source,\r\n                        callback: callback,\r\n                        buildHTML: buildHTML\r\n                    });                    \r\n\r\n                    var getNextSibling = function (elem, selector) {\r\n\r\n                        // Get the next sibling element\r\n                        var sibling = elem.nextElementSibling;\r\n\r\n                        // If there's no selector, return the first sibling\r\n                        if (!selector) return sibling;\r\n\r\n                        // If the sibling matches our selector, use it\r\n                        // If not, jump to the next sibling and continue the loop\r\n                        while (sibling) {\r\n                            if (sibling.matches(selector)) return sibling;\r\n                            sibling = sibling.nextElementSibling\r\n                        }\r\n\r\n                    };\r\n\r\n                    var getPreviousSibling = function (elem, selector) {\r\n\r\n                        // Get the next sibling element\r\n                        var sibling = elem.previousElementSibling;\r\n\r\n                        // If there's no selector, return the first sibling\r\n                        if (!selector) return sibling;\r\n\r\n                        // If the sibling matches our selector, use it\r\n                        // If not, jump to the next sibling and continue the loop\r\n                        while (sibling) {\r\n                            if (sibling.matches(selector)) return sibling;\r\n                            sibling = sibling.previousElementSibling;\r\n                        }\r\n\r\n                    };\r\n\r\n                    // Detect up/down arrow\r\n                    const onKeydown = function (e) {\r\n                        if (!e.ctrlKey && !e.altKey && !e.shiftKey) {\r\n                            if (e.keyCode === 40) { // down arrow\r\n                                if (self.textInput == document.activeElement && self.resultsList.querySelector('li:not([header]) a')) {\r\n                                    // Scenario 1: We're focused on the search input; move down to the first li\r\n                                    self.resultsList.querySelector('li:not([header]) a').focus();\r\n                                } else if (self.resultsList.querySelector('li:not([header]):last-child a') === document.activeElement) { //} else if (self.resultsList.querySelector('li:not([header]):last a').is(':focus')) {\r\n                                    // Scenario 2: We're focused on the last li; move up to search input\r\n                                    self.textInput.focus();\r\n                                } else {\r\n                                    // Scenario 3: We're in the list but not on the last element, simply move down\r\n                                    getNextSibling(document.activeElement.parentElement, 'li:not([header])')\r\n                                        .querySelector('a').focus();                                    \r\n                                }\r\n                                e.preventDefault(); // Stop page from scrolling\r\n                                e.stopPropagation();\r\n                            } else if (e.keyCode === 38) { // up arrow\r\n                                if (self.textInput == document.activeElement) {\r\n                                    // Scenario 1: We're focused on the search input; move down to the last li\r\n                                    self.resultsList.querySelector('li:not([header]):last-child a').focus();\r\n                                } else if (document.activeElement == self.resultsList.querySelector('li:not([header]) a')) {\r\n                                    self.resultsList.querySelector('li:not([header]):last-child a').focus();\r\n                                } else {\r\n                                    // Scenario 3: We're in the list but not on the first element, simply move up\r\n                                    getPreviousSibling(document.activeElement.parentElement, 'li:not([header])')\r\n                                        .querySelector('a').focus();                                    \r\n                                }\r\n                                e.preventDefault(); // Stop page from scrolling\r\n                                e.stopPropagation();\r\n                            }\r\n                        }\r\n                        e.stopPropagation();\r\n                    };\r\n\r\n                    self.textInput.addEventListener('keydown', onKeydown);\r\n                    self.resultsList.addEventListener('keydown', onKeydown);\r\n                }\r\n            );\r\n\r\n            if ($.isFunction(callback)) {\r\n                callback();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.addAllowedSearchType = function (name, options) {\r\n        var self = this;\r\n\r\n        self.allowedSearchTypes.push(new SearchType(name, options, self));\r\n    };\r\n\r\n    ctlProto.getSearchTypeByRole = function (type) {\r\n        var self = this;\r\n\r\n        return self.allowedSearchTypes.filter(function (allowed) {\r\n            return allowed.typeName == type;\r\n        })[0];\r\n    };\r\n\r\n    ctlProto.getSearchTypeByFeature = function (id) {\r\n        var self = this;\r\n\r\n        var type = self.allowedSearchTypes.filter(function (allowed) {\r\n            return allowed.isFeatureOfThisType(id);\r\n        });\r\n\r\n        if (type.length > 0) {\r\n            return type[0];\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    ctlProto.getElementOnSuggestionList = function (id, dataRole) {\r\n        const self = this;\r\n\r\n        for (var i = 0; i < self._search.data.length; i++) {\r\n            if (self._search.data[i].id == id && (!dataRole || (dataRole && self._search.data[i].dataRole === dataRole)))\r\n                return self._search.data[i];\r\n        }\r\n    };\r\n\r\n    ctlProto.getLayer = function () {\r\n        var self = this;\r\n        return self.layerPromise;\r\n    };\r\n\r\n    ctlProto.getFeatures = function () {\r\n        var self = this;\r\n        var features = [];\r\n\r\n        return self.layer.features;\r\n    };\r\n\r\n    ctlProto.cleanMap = function () {\r\n        var self = this;\r\n\r\n        self.getLayer().then(function (l) {\r\n            var features = l.features.slice();\r\n            l.clearFeatures();\r\n\r\n            self.map.trigger(TC.Consts.event.FEATUREREMOVE, { layer: l, feature: features });\r\n\r\n            for (var i = 0; i < self.WFS_TYPE_ATTRS.length; i++) {\r\n                if (l.hasOwnProperty(self.WFS_TYPE_ATTRS[i]))\r\n                    delete l[self.WFS_TYPE_ATTRS[i]];\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getMunicipalities = function () {\r\n        var self = this;\r\n\r\n        TC.cache.search = TC.cache.search || {};\r\n        self._municipalitiesPromise = new Promise(function (resolve, reject) {\r\n            if (TC.cache.search.municipalities) {\r\n                resolve(TC.cache.search.municipalities);\r\n            }\r\n            else {\r\n                var type = self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL);\r\n\r\n                if (type.municipality && type.municipality.featureType && type.municipality.labelProperty && type.municipality.idProperty) {\r\n                    var params = {\r\n                        REQUEST: 'GetFeature',\r\n                        SERVICE: 'WFS',\r\n                        TYPENAME: type.municipality.featureType,\r\n                        VERSION: type.version,\r\n                        PROPERTYNAME: type.municipality.labelProperty + \",\" + type.municipality.idProperty,\r\n                        OUTPUTFORMAT: type.outputFormat\r\n                    };\r\n                    if (type.featurePrefix) {\r\n                        params.TYPENAME = type.featurePrefix + ':' + params.TYPENAME;\r\n                    }\r\n                    var url = type.url + '?' + $.param(params);\r\n                    TC.ajax({\r\n                        url: url,\r\n                        method: 'GET',\r\n                        responseType: 'text'\r\n                    }).then(function (data) {\r\n                        var parser;\r\n                        if (type.outputFormat === TC.Consts.format.JSON) {\r\n                            parser = new TC.wrap.parser.JSON();\r\n                        }\r\n                        else {\r\n                            parser = new TC.wrap.parser.WFS({\r\n                                featureNS: type.municipality.featurePrefix,\r\n                                featureType: type.municipality.featureType\r\n                            });\r\n                        }\r\n                        var features = parser.read(data);\r\n                        TC.cache.search.municipalities = [];\r\n                        for (var i = 0; i < features.length; i++) {\r\n                            var feature = features[i];\r\n                            TC.cache.search.municipalities.push({ label: feature.data[type.municipality.labelProperty], id: feature.data[type.municipality.idProperty] });\r\n                        }\r\n\r\n                        TC.cache.search.municipalities.sort(function (a, b) {\r\n                            var result;\r\n                            if (a.label < b.label) {\r\n                                result = -1;\r\n                            }\r\n                            else if (a.label > b.label) {\r\n                                result = 1;\r\n                            }\r\n                            else {\r\n                                result = 0;\r\n                            }\r\n                            return result;\r\n                        });\r\n\r\n                        resolve(TC.cache.search.municipalities);\r\n                    }).catch(function () {\r\n                        resolve();\r\n                    });\r\n                } else {\r\n                    throw new Error(\"Error en la configuración de la búsqueda: \" + type.typeName + \". Error en el objeto municipality\");\r\n                }\r\n            }\r\n        });\r\n        return self._municipalitiesPromise;\r\n    };\r\n\r\n    ctlProto.getCoordinates = function (pattern) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var match = pattern.match(new RegExp('^' + $.trim(self.UTMX_LABEL.toLowerCase()) + '*\\\\s*([0-9]{' + self.UTMX_LEN + '}(?:[.,]\\\\d+)?)\\\\s*\\\\,?\\\\s*' + $.trim(self.UTMY_LABEL.toLowerCase()) + '*\\\\s*([0-9]{' + self.UTMY_LEN + '}(?:[.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                pattern = match[1] + ' ' + match[2];\r\n            }\r\n\r\n            match = pattern.match(new RegExp('^' + $.trim(self.LAT_LABEL.toLowerCase()) + '*\\\\s*([-+]?\\\\d{1,3}([.,]\\\\d+)?)\\\\,?\\\\s*' + $.trim(self.LON_LABEL.toLowerCase()) + '*\\\\s*([-+]?\\\\d{1,2}([.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                pattern = match[1] + ' ' + match[3];\r\n            }\r\n\r\n            if (/\\d/.test(pattern) && (new RegExp('^([0-9]{' + self.UTMX_LEN + '}(?:[.,]\\\\d+)?)\\\\s*\\\\,?\\\\s*([0-9]{' + self.UTMY_LEN + '}(?:[.,]\\\\d+)?)$').test(pattern) || /^([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*([-+]?\\d{1,2}([.,]\\d+)?)$/.test(pattern))) {\r\n                match = /^([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*([-+]?\\d{1,2}([.,]\\d+)?)$/.exec(pattern);\r\n                if (match && (match[1].indexOf(',') > -1 || match[3].indexOf(',') > -1)) {\r\n                    match[1] = match[1].replace(',', '.');\r\n                    match[3] = match[3].replace(',', '.');\r\n\r\n                    pattern = match[1] + ' ' + match[3];\r\n                }\r\n\r\n                if (!match || match && ((match[1].indexOf(',') > -1 ? match[1].replace(',', '.') : match[1]) <= 180) && ((match[3].indexOf(',') > -1 ? match[3].replace(',', '.') : match[3]) <= 90)) {\r\n\r\n                    match = new RegExp('^([0-9]{' + self.UTMX_LEN + '}(?:[.,]\\\\d+)?)\\\\s*\\\\,?\\\\s*([0-9]{' + self.UTMY_LEN + '}(?:[.,]\\\\d+)?)$').exec(pattern);\r\n                    if (match && (match[1].indexOf(',') > -1 || match[2].indexOf(',') > -1)) {\r\n                        match[1] = match[1].replace(',', '.');\r\n                        match[2] = match[2].replace(',', '.');\r\n\r\n                        pattern = match[1] + ' ' + match[2];\r\n                    }\r\n\r\n                    // parse coordinates\r\n                    pattern = pattern.replace(self.UTMX_LABEL, '').replace(self.UTMY_LABEL, '').replace(self.LON_LABEL, '').replace(self.LAT_LABEL, '');\r\n                    var coords = TC.Util.parseCoords(pattern);\r\n                    if (coords) {\r\n                        var xValue = coords[0].value;\r\n                        var yValue = coords[1].value;\r\n                        var xLabel = (coords[0].type === TC.Consts.UTM) ? self.UTMX : self.LAT;\r\n                        var yLabel = (coords[1].type === TC.Consts.UTM) ? self.UTMY : self.LON;\r\n                        var id = xLabel + xValue + yLabel + yValue;\r\n\r\n                        var point = self.getPoint(id);\r\n                        if (point && !self.insideLimit(point)) {\r\n                            xValue = coords[1].value;\r\n                            yValue = coords[0].value;\r\n                            xLabel = (coords[1].type === TC.Consts.UTM) ? self.UTMX : self.LAT;\r\n                            yLabel = (coords[0].type === TC.Consts.UTM) ? self.UTMY : self.LON;\r\n                            id = xLabel + xValue + yLabel + yValue;\r\n                            point = self.getPoint(id);\r\n                        }\r\n\r\n                        if (point) {\r\n                            self.availableSearchTypes[TC.Consts.searchType.COORDINATES].label = /^X(\\d+(?:\\.\\d+)?)Y(\\d+(?:\\.\\d+)?)$/.test(id) ? self.getLocaleString('search.list.coordinates.utm') + self.map.crs : self.getLocaleString('search.list.coordinates.geo');\r\n\r\n                            //console.log('getCoordinates promise resuelta');\r\n                            resolve([{\r\n                                id: id, label: self.getLabel(id), dataRole: TC.Consts.searchType.COORDINATES\r\n                            }]);\r\n                        }\r\n                        else {\r\n                            //console.log('getCoordinates promise resuelta');\r\n                            resolve([]);\r\n                        }\r\n                    } else {\r\n                        //console.log('getCoordinates promise resuelta');\r\n                        resolve([]);\r\n                    }\r\n                } else {\r\n                    //console.log('getCoordinates promise resuelta');\r\n                    resolve([]);\r\n                }\r\n            } else {\r\n                //console.log('getCoordinates promise resuelta');\r\n                resolve([]);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getCadastralRef = function (pattern) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var match = pattern.match(new RegExp($.trim(self.MUN_LABEL.toLowerCase()) + '?\\\\s(.*)\\\\,\\\\s?' + $.trim(self.POL_LABEL.toLowerCase()) + '?\\\\s(\\\\d{1,2})\\\\,\\\\s?' + $.trim(self.PAR_LABEL.toLowerCase()) + '?\\\\s(\\\\d{1,4})'));\r\n            if (match) {\r\n                pattern = match[1] + ', ' + match[2] + ', ' + match[3];\r\n            }\r\n\r\n            var _pattern = pattern;\r\n            if (!(/^(.*)\\,(\\s*\\d{1,2}\\s*)\\,(\\s*\\d{1,4}\\s*)$/.test(pattern)) && self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot)\r\n                _pattern = self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot + ', ' + pattern;\r\n\r\n            if (/^(.*)\\,(\\s*\\d{1,2}\\s*)\\,(\\s*\\d{1,4}\\s*)$/.test(_pattern) && !(new RegExp('^([0-9]{' + self.UTMX_LEN + '})\\\\s*\\\\,\\\\s*([0-9]{' + self.UTMY_LEN + '})$').test(pattern))) {\r\n                self.getMunicipalities().then(function (list) {\r\n                    var match = /^(.*)\\,(\\s*\\d{1,2}\\s*)\\,(\\s*\\d{1,4}\\s*)$/.exec(_pattern);\r\n                    if (match) {\r\n                        var matcher = new RegExp($.trim(match[1]).replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, \"\\\\$&\"), \"i\");\r\n                        var results = [];\r\n\r\n                        const getItem = function (mun, munLabel, pol, par) {\r\n                            var properties = [];\r\n\r\n                            properties.push[self.MUN] = mun;\r\n                            properties.push[self.POL] = pol;\r\n                            properties.push[self.PAR] = par;\r\n\r\n                            return {\r\n                                id: self.MUN + mun + self.POL + pol + self.PAR + par,\r\n                                label: self.getLabel(self.MUN + munLabel + self.POL + pol + self.PAR + par),\r\n                                dataRole: TC.Consts.searchType.CADASTRAL,\r\n                                properties: properties\r\n                            };\r\n                        };\r\n\r\n                        results = $.grep(list, function (value) {\r\n                            value = value.label || value.id || value;\r\n                            return matcher.test(value) || matcher.test(self.removePunctuation(value));\r\n                        });\r\n\r\n                        if (results.length > 0) {\r\n                            for (var i = 0; i < results.length; i++) {\r\n                                results[i] = getItem(results[i].id, results[i].label, $.trim(match[2]), $.trim(match[3]));\r\n                            }\r\n                        }\r\n\r\n                        if (/^[0-9]*$/g.test(match[1])) {\r\n\r\n                            if (match[1].trim() === self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot) {\r\n\r\n                                var suggestionRoot = list.filter(function (elm) {\r\n                                    return parseInt(elm.id) === parseInt(self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot);\r\n                                })[0];\r\n\r\n                                if (suggestionRoot) {\r\n                                    resolve([getItem(suggestionRoot.id, suggestionRoot.label, $.trim(match[2]), $.trim(match[3]))]);\r\n                                }\r\n                            }\r\n\r\n                            results.push(getItem($.trim(match[1]), $.trim(match[1]), $.trim(match[2]), $.trim(match[3])));\r\n                        }\r\n\r\n                        //console.log('getCadastralRef promise resuelta');\r\n                        resolve(results);\r\n                    }\r\n                });\r\n            } else {\r\n                //console.log('getCadastralRef promise resuelta - no es ref catastral');\r\n                resolve([]);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.stringPatternsValidators = {\r\n        tsp: function (text, result, root, limit) {\r\n            // town, street, portal - street, town, portal\r\n            var match = /^([^0-9\\,]+)(?:\\s*\\,\\s*)(?:([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+))(?:\\s*\\,\\s*)(?:(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))$/i.exec(text);\r\n            if (match && match[1] && match[2]) {\r\n\r\n                var getPortal = function () {\r\n                    return formatStreetNumber((match[3] || match[4] || match[5] || match[6]).trim());\r\n                };\r\n                // ninguno contiene número duplicamos búsqueda\r\n                if (/^([^0-9]+)$/i.test(match[1].trim()) && /^([^0-9]+)$/i.test(match[2].trim())) {\r\n                    result.push({\r\n                        t: match[1].trim(), s: match[2].trim(), p: getPortal()\r\n                    });\r\n                    result.push({\r\n                        t: match[2].trim(), s: match[1].trim(), p: getPortal()\r\n                    });\r\n                }\r\n                else {  // indicamos como calle el criterio que contiene números, ya que no existen municipios con números pero sí calles\r\n                    if (/^([^0-9]+)$/i.test(match[1].trim())) result.push({\r\n                        t: match[1].trim(), s: match[2].trim(), p: getPortal()\r\n                    });\r\n                    else result.push({\r\n                        s: match[1].trim(), t: match[2].trim(), p: getPortal()\r\n                    });\r\n                }\r\n                bindRoot.call(this, result, root, limit);\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        spt: function (text, result, root, limit) {\r\n            // street, portal, town\r\n            var match = /^(?:([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+))(?:\\s*\\,\\s*)(?:(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))(?:\\s*\\,\\s*)([^0-9\\,]+)$/i.exec(text);\r\n            if (match && match[6] && match[1]) {\r\n\r\n                var getPortal = function () {\r\n                    return formatStreetNumber((match[2] || match[3] || match[4] || match[5]).trim());\r\n                };\r\n                // ninguno contiene número duplicamos búsqueda\r\n                if (/^([^0-9]+)$/i.test(match[6].trim()) && /^([^0-9]+)$/i.test(match[1].trim())) {\r\n                    result.push({\r\n                        t: match[6].trim(), s: match[1].trim(), p: getPortal()\r\n                    });\r\n                    result.push({\r\n                        t: match[1].trim(), s: match[6].trim(), p: getPortal()\r\n                    });\r\n                }\r\n                else {  // indicamos como calle el criterio que contiene números, ya que no existen municipios con números pero sí calles\r\n                    if (/^([^0-9]+)$/i.test(match[6].trim())) result.push({\r\n                        t: match[6].trim(), s: match[1].trim(), p: getPortal()\r\n                    });\r\n                    else result.push({\r\n                        s: match[6].trim(), t: match[1].trim(), p: getPortal()\r\n                    });\r\n                }\r\n                bindRoot.call(this, result, root, limit);\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        tnsp: function (text, result, root, limit) {\r\n            // town, numbers street, portal\r\n            var match = /^(?:([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+))(?:\\s*\\,\\s*)([^0-9\\,]+)(?:\\s*\\,\\s*)(?:(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))$/i.exec(text);\r\n\r\n            if (match && match[1] && match[2]) {\r\n                result.push({\r\n                    t: match[2].trim(), s: match[1].trim(), p: formatStreetNumber((match[3] || match[4] || match[5] || match[6]).trim())\r\n                });\r\n                bindRoot.call(this, result, root, limit);\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        ts: function (text, result, root, limit) {\r\n            // town, street\r\n            var match = /^([^0-9\\,]+)(?:\\s*\\,\\s*)(?:([^\\,][a-zñáéíóúüàèìòù\"\\s*\\-\\.\\(\\)\\/0-9]+))$/i.exec(text);\r\n\r\n            // topónimo, municipio\r\n            if (!match && /^[^0-9]*$/i.test(text.trim())) { // si no hay números reviso dándole la vuelta, si hay números que lo trate la función st\r\n                var criteria = text.split(',').reverse();\r\n                match = /^([^0-9\\,]+)(?:\\s*\\,\\s*)(?:([^\\,][a-zñáéíóúüàèìòù\"\\s*\\-\\.\\(\\)\\/0-9]+))$/i.exec(criteria.join(','));\r\n            }\r\n\r\n            if (match && match[1] && match[2]) {\r\n                // ninguno contiene número duplicamos búsqueda\r\n                if (/^([^0-9]+)$/i.test(match[1].trim()) && /^([^0-9]+)$/i.test(match[2].trim())) {\r\n                    result.push({\r\n                        t: match[1].trim(), s: match[2].trim()\r\n                    });\r\n                    result.push({\r\n                        s: match[1].trim(), t: match[2].trim()\r\n                    });\r\n\r\n                    bindRoot.call(this, result, root, limit);\r\n                }\r\n                else {  // indicamos como calle el criterio que contiene números, ya que no existen municipios con números pero sí calles\r\n\r\n                    var getStreet = function (s) {\r\n                        var revS = s.split(' ').reverse();\r\n                        // validamos si el criterio es compuesto \r\n                        var fs = [];\r\n                        for (var si = 0; si < revS.length; si++) {\r\n                            if (revS[si].length == 1) {\r\n                                fs.push(revS[si]);\r\n                                revS[si] = '';\r\n                            }\r\n                        }\r\n\r\n                        return fs.length > 0 ? revS.reverse().join(' ').trim() + self._LIKE_PATTERN + fs.reverse().join(self._LIKE_PATTERN) : revS.reverse().join(' ').trim();\r\n                    };\r\n\r\n                    if (/^([^0-9]+)$/i.test(match[1].trim()))\r\n                        result.push({\r\n                            t: match[1].trim(), s: getStreet(match[2].trim())\r\n                        });\r\n                    else result.push({\r\n                        s: getStreet(match[1].trim()), t: match[2].trim()\r\n                    });\r\n\r\n                    bindRoot.call(this, result, root, limit, true);\r\n                }\r\n\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        st: function (text, result, root, limit) {\r\n            // street, town\r\n            var match = /^(?:([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+))(?:\\s*\\,\\s*)([^0-9\\,]+)$/i.exec(text);\r\n\r\n            if (!match) {\r\n                var criteria = text.split(',').reverse();\r\n                match = /^([^0-9\\,]+)(?:\\s*\\,\\s*)(?:([^\\,][a-zñáéíóúüàèìòù\"\\s*\\-\\.\\(\\)\\/0-9]+))$/i.exec(criteria.join(','));\r\n            }\r\n\r\n            if (match) { // puede generar falsos positivos cuando el portal llega seguido de la calle -> calle mayor 14, pamplona\r\n                var data = {\r\n                };\r\n                var criteria = text.split(',').reverse();\r\n                for (var i = 0; i < criteria.length; i++) {\r\n                    if (/^([^0-9\\,]+)$/i.test(criteria[i].trim())) { // si no hay números se trata de municipio\r\n                        data.t = criteria[i].trim();\r\n                    }\r\n                    else if (/(\\s*\\d+)/i.test(criteria[i].trim())) { // si contiene número, puede ser calle o calle + portal\r\n                        if (criteria[i].trim().indexOf(' ') == -1) { // si no contiene espacios se trata de calle compuesta por números\r\n                            data.s = criteria[i].trim();\r\n                        } else { // si contiene espacio puede contener calle + portal\r\n                            var _criteria = criteria[i].trim().split(' ').reverse();\r\n\r\n                            var isPortal = function (c) {\r\n                                var m = /^(?:(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))$/i.exec(c.trim());\r\n                                if (m) {\r\n                                    data.p = formatStreetNumber(c.trim());\r\n                                    return true;\r\n                                }\r\n                                return false;\r\n                            };\r\n\r\n                            var x = 0;\r\n                            var p = _criteria[x].trim();\r\n                            while (x < _criteria.length && !isPortal(p)) {\r\n                                x++;\r\n                                if (x < _criteria.length)\r\n                                    p = p + _criteria[x];\r\n\r\n                            }\r\n\r\n                            if (data.p) {\r\n                                var _cr = _criteria;\r\n                                for (var h = 0; h < _cr.length; h++) {\r\n                                    // validamos que lo que hemos deducido como portal, está en portal para no añadirlo a calle\r\n                                    var inPortal = false;\r\n                                    for (var c = 0; c < _cr[h].split('').length; c++) {\r\n                                        if (data.p.indexOf(_cr[h][c]) > -1)\r\n                                            inPortal = true;\r\n                                    }\r\n\r\n                                    if (inPortal) {\r\n                                        var _p = _cr[h];\r\n\r\n                                        _cr[h] = '';\r\n                                        if (data.p == formatStreetNumber(p))\r\n                                            break;\r\n                                    }\r\n                                }\r\n\r\n                                if (/^([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+)$/i.test(_criteria.reverse().join(' ').trim())) {\r\n                                    var fs = [];\r\n                                    var criteriaRev = _criteria.reverse();\r\n                                    for (var chs = 0; chs < criteriaRev.length; chs++) {\r\n                                        if (criteriaRev[chs].trim().length == 1) {\r\n                                            fs.push(criteriaRev[chs].trim());\r\n                                            criteriaRev[chs] = '';\r\n                                        }\r\n                                    }\r\n\r\n                                    data.s = fs.length > 0 ? criteriaRev.reverse().join(' ').trim() + self._LIKE_PATTERN + fs.reverse().join(self._LIKE_PATTERN) : criteriaRev.reverse().join(' ').trim();\r\n                                }\r\n\r\n\r\n                                // nombre_de_calle = 137, 1, 20...\r\n                                // duplico la búsqueda para el caso de [Calle nombre_de_calle], municipio\r\n                                result.push({\r\n                                    t: data.t,\r\n                                    s: data.s + ' ' + data.p\r\n                                });\r\n                            } else {\r\n                                data.s = criteria[i].trim();\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                result.push(data);\r\n                bindRoot.call(this, result, root, limit);\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        s_or_t: function (text, result, root, limit) {\r\n            var match = /^([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9\\<\\>]+)$/i.exec(text);\r\n            if (match && match[1]) {\r\n                if (root) {\r\n                    result.push({\r\n                        t: match[1].trim()\r\n                    });\r\n\r\n                    result.push({\r\n                        t: root,\r\n                        s: match[1].trim()\r\n                    });\r\n                }\r\n                else result.push({\r\n                    t: match[1].trim()\r\n                });\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        sp: function (text, result, root, limit) {\r\n            var match = /^([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/]+)\\s*\\,?\\s*((\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))$/i.exec(text);\r\n            if (match && match[1] && match[2]) { // && text.indexOf(',') > -1 && text.split(',').length < 3) {\r\n                if (root)\r\n                    result.push({\r\n                        t: root,\r\n                        s: match[1].trim(),\r\n                        p: formatStreetNumber(match[2].trim())\r\n                    });\r\n                else\r\n                    result.push({\r\n                        t: match[1].trim(),\r\n                        s: match[2].trim()\r\n                    });\r\n\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        snp: function (text, result, root, limit) { // calle puede contener números con portal (cuando exista un municipio root establecido)\r\n            var match = /^([^\\,][0-9\\s*\\-\\.\\(\\)\\/]+)\\s*\\,?\\s*(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4})$/i.exec(text);\r\n            if (match && match[1] && match[2] && root) {\r\n                result.push({\r\n                    t: root,\r\n                    s: match[1].trim(),\r\n                    p: formatStreetNumber(match[2].trim())\r\n                });\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        }\r\n    };\r\n\r\n    /* métodos auxiliares de getStringPattern */\r\n\r\n    const normalizedCriteria = function (value) {\r\n        const self = this;\r\n\r\n        var _value = '';\r\n\r\n        value = self.removePunctuation(value);\r\n\r\n        // elimino los caracteres especiales\r\n        if (self.NORMAL_PATTERNS.ROMAN_NUMBER.test(value))\r\n            value = value.replace(self.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT, '');\r\n        else\r\n            value = value.replace(self.NORMAL_PATTERNS.ABSOLUTE, '');\r\n        return value.toLowerCase();\r\n    };\r\n\r\n    const formatStreetNumber = function (value) {\r\n        var result = value;\r\n\r\n        var is_nc_c = function (value) {\r\n            return /^(\\d{1,3})\\s?\\-?\\s?([a-z]{0,4})\\s?\\-?\\s?([a-z]{0,4})$/i.test(value);\r\n        }\r\n        var nc_c = function (value) {\r\n            var f = [];\r\n            var m = /^(\\d{1,3})\\s?\\-?\\s?([a-z]{0,4})\\s?\\-?\\s?([a-z]{0,4})$/i.exec(value);\r\n            if (m) {\r\n                for (var i = 1; i < m.length; i++) {\r\n                    if (m[i].trim().length > 0)\r\n                        f.push(m[i].trim());\r\n                }\r\n\r\n                return f.join(self._LIKE_PATTERN);\r\n            }\r\n            return value;\r\n        };\r\n\r\n        var is_cn = function (value) {\r\n            return /^([a-z]{1,4})\\s?\\-?\\s?(\\d{1,3})$/i.test(value);\r\n        };\r\n        var cn = function (value) {\r\n            var f = [];\r\n            var m = /^([a-z]{1,4})\\s?\\-?\\s?(\\d{1,3})$/i.exec(value);\r\n            if (m) {\r\n                for (var i = 1; i < m.length; i++) {\r\n                    if (m[i].trim().length > 0)\r\n                        f.push(m[i].trim());\r\n                }\r\n\r\n                return f.join(self._LIKE_PATTERN);\r\n            }\r\n            return value;\r\n        };\r\n\r\n        var is_sn = function (value) {\r\n            return /^(sn|S\\/N|s\\/n|s\\-n)$/i.test(value);\r\n        };\r\n        var sn = function (value) {\r\n            var m = /^(sn|S\\/N|s\\/n|s\\-n)$/i.exec(value);\r\n            if (m) {\r\n                return 's*n';\r\n            }\r\n            return value;\r\n        };\r\n\r\n\r\n        var is_cmc = function (value) {\r\n            return /^([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4})$/i.test(value);\r\n        };\r\n        var cmc = function (value) {\r\n            var m = /^([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4})$/i.exec(value);\r\n            if (m) {\r\n                return value;\r\n            }\r\n            return value;\r\n        };\r\n\r\n        var isCheck = [is_nc_c, is_cn, is_sn, is_cmc];\r\n        var check = [nc_c, cn, sn, cmc];\r\n        var ch = 0;\r\n        while (ch < check.length && !isCheck[ch].call(self, value)) {\r\n            ch++;\r\n        }\r\n\r\n        if (ch < check.length)\r\n            return check[ch].call(self, value);\r\n        else return value;\r\n    };\r\n\r\n    const bindRoot = function (result, root, limit, addRoot) {\r\n        const self = this;\r\n\r\n        if (root) {\r\n            var i = result.length;\r\n            while (i--) {\r\n                if (!addRoot) {\r\n                    if (result[i].t) {\r\n                        var indicatedRoot = self.rootCfg.active.rootLabel.filter(function (elem) {\r\n                            return elem.label.indexOf(self.removePunctuation(result[i].t).toLowerCase()) > -1;\r\n                        }.bind(self));\r\n\r\n                        if (indicatedRoot.length == 1) {\r\n                            result[i].t = indicatedRoot[0].id;\r\n                        } else if (indicatedRoot.length > 1) {\r\n\r\n                            indicatedRoot.map(function (elem) {\r\n                                var newResult = $.extend({\r\n                                }, result[i]);\r\n                                newResult.t = elem.id;\r\n\r\n                                result.push(newResult);\r\n                            });\r\n\r\n                        } else if (indicatedRoot.length == 0 && limit) {\r\n                            result.splice(i, 1);\r\n                        }\r\n                    }\r\n                }\r\n                else {\r\n                    result.push($.extend({}, result[i], { t: root }));\r\n                };\r\n            }\r\n        }\r\n    };\r\n\r\n    const getObjectsFromStringToQuery = function (allowedRoles, text) {\r\n        const self = this;\r\n        const root = self.rootCfg.active && self.rootCfg.active.root || '';\r\n        const limit = self.rootCfg.active && self.rootCfg.active.limit || false;\r\n\r\n        var result = [];\r\n\r\n        const test = function () {\r\n            var tests = [function (text) {\r\n                return text.length >= 3;\r\n            },\r\n            function (text) {\r\n                return /^\\d+$/.test(text) ? false : (/^\\d+\\,\\s*\\d+$/.test(text) ? false : true);\r\n            }];\r\n\r\n            for (var i = 0; i < tests.length; i++) {\r\n                if (!tests[i].call(self, text))\r\n                    return false;\r\n            }\r\n\r\n            return true;\r\n        };\r\n\r\n        // eliminamos espacios en blanco\r\n        text = text.trim();\r\n\r\n        // comprobamos si acaba con coma, si es así, la eliminamos\r\n        if (text.charAt(text.length - 1) == ',') {\r\n            text = text.substring(0, text.length - 1);\r\n        }\r\n\r\n        if (test(text)) {\r\n            var check = [];\r\n\r\n            check = allowedRoles.map(function (dataRole) {\r\n                return self.getSearchTypeByRole(dataRole);\r\n            }).filter(function (searchType) {\r\n                return searchType.stringPatternToCheck;\r\n            }).map(function (searchType) {\r\n                return searchType.stringPatternToCheck;\r\n            });\r\n\r\n            if (check.length === 0) {\r\n                check = [self.stringPatternsValidators.tsp, self.stringPatternsValidators.spt, self.stringPatternsValidators.tnsp, self.stringPatternsValidators.ts, self.stringPatternsValidators.st];\r\n                if (root && text.split(',').length < 3) {\r\n                    check = [self.stringPatternsValidators.sp, self.stringPatternsValidators.snp, self.stringPatternsValidators.s_or_t].concat(check);\r\n                }\r\n                else {\r\n                    check = check.concat([self.stringPatternsValidators.sp, self.stringPatternsValidators.snp, self.stringPatternsValidators.s_or_t]);\r\n                }\r\n            }\r\n\r\n            var ch = 0;\r\n            try {\r\n                while (ch < check.length && !check[ch].call(self, text, result, root, limit)) {\r\n                    ch++;\r\n                }\r\n            }\r\n            catch (ex) {\r\n                TC.error(\"Error según el patrón: \" + text, TC.Consts.msgErrorMode.EMAIL, \"Error en la búsqueda del callejero\");\r\n            }\r\n\r\n            return result;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    const requestToWFS = function (type, doneCallback, data) {\r\n        const self = this;\r\n\r\n        self.resultsList.innerHTML = '<li><a class=\"tc-ctl-search-li-loading\" href=\"#\">' + self.getLocaleString('searching') + '<span class=\"tc-ctl-search-loading-spinner tc-ctl-search-loading\"></span></a></li>';\r\n        self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n        return TC.ajax({\r\n            url: type.url,\r\n            method: 'POST',\r\n            //contentType: \"application/x-www-form-urlencoded;charset=UTF-8\",\r\n            responseType: 'text',\r\n            data: type.filter.getParams(data)\r\n        })\r\n            .then(doneCallback)\r\n            .catch(function (data) {\r\n                if (data.statusText !== 'abort')\r\n                    alert('error');\r\n\r\n                //console.log('getStringPattern promise resuelta - data.statusText: ' + data.statusText);\r\n            });\r\n    };\r\n\r\n    const getResultsFromWFS = function (allowedRoles, resolve, reject, objectsToQuery) {\r\n        const self = this;\r\n\r\n        if (objectsToQuery) {\r\n            var results = [];\r\n\r\n            self._search.data = results;\r\n\r\n            if (!self.request) {\r\n                self.request = [];\r\n            }\r\n\r\n            objectsToQuery.forEach(function (data, i) {\r\n\r\n                allowedRoles.filter(function (elm) {\r\n                    var type = self.getSearchTypeByRole(elm);\r\n                    return Object.keys(type.queryProperties).length === Object.keys(data).length;\r\n                }).map(function (dataRole) {\r\n                    var type = self.getSearchTypeByRole(dataRole);\r\n                    self.request.push(requestToWFS.call(self, type, function (data) {\r\n                        results = results.concat(type.getSuggestionListElements(data));\r\n                    }, data));\r\n                });\r\n            });\r\n\r\n            Promise.all(self.request).then(function () {\r\n                //self.request = [];\r\n                //console.log('getStringPattern promise resuelta');\r\n                resolve(results);\r\n            });\r\n        } else {\r\n            //console.log('getStringPattern promise resuelta - no encaja en address');\r\n            resolve([]);\r\n        }\r\n    };\r\n\r\n    ctlProto.getStringPattern = function (allowedRoles, pattern) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            pattern = normalizedCriteria.call(self, pattern);\r\n\r\n            /* gestionamos:\r\n                Entidad de población: Irisarri Auzoa (Igantzi)\r\n                Topónimo: Aldabeko Bidea (Arbizu)\r\n            */\r\n            var combinedCriteria = /(.*)\\((.*)\\)/.exec(pattern);\r\n            if (combinedCriteria && combinedCriteria.length > 2) {\r\n\r\n                // búsqueda de entidad de población\r\n                var objectsToQuery = getObjectsFromStringToQuery.call(self, allowedRoles, combinedCriteria[1]);\r\n\r\n                // búsqueda de topónimo\r\n                var bothSearchObjects = getObjectsFromStringToQuery.call(self, allowedRoles, combinedCriteria[1] + ',' + combinedCriteria[2]);\r\n\r\n                bothSearchObjects = (bothSearchObjects || []).concat(objectsToQuery || []);\r\n\r\n                getResultsFromWFS.call(self, allowedRoles, resolve, reject, bothSearchObjects);\r\n            } else {\r\n                var objectsToQuery = getObjectsFromStringToQuery.call(self, allowedRoles, pattern);\r\n\r\n                getResultsFromWFS.call(self, allowedRoles, resolve, reject, objectsToQuery);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getRoad = function (pattern) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            pattern = pattern.trim();\r\n            if (pattern.length < 2) {\r\n                resolve([]);\r\n            } else {\r\n                var type = self.getSearchTypeByRole(TC.Consts.searchType.ROAD);\r\n\r\n                var roadPattern = type.getPattern();\r\n                var match = roadPattern.exec(pattern);\r\n                if (match && match[3]) {\r\n\r\n                    var _pattern = match[2] ? match[2].trim() + \"-\" + match[3].trim() : match[3].trim();\r\n                    if (match[4] && match[4].length > 0) {\r\n                        _pattern = _pattern + \"-\" + match[4].trim();\r\n                    }\r\n\r\n                    self.resultsList.innerHTML = '<li><a class=\"tc-ctl-search-li-loading\" href=\"#\">' + self.getLocaleString('searching') + '<span class=\"tc-ctl-search-loading-spinner tc-ctl-search-loading\"></span></a></li>';\r\n                    self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n                    TC.ajax({\r\n                        url: type.url + '?' + type.filter.getParams({ t: _pattern }),\r\n                        method: 'GET',\r\n                        responseType: TC.Consts.mimeType.JSON\r\n                    }).then(function (data) {\r\n                        var result = [];                        \r\n\r\n                        if (data.totalFeatures > 0) {\r\n                            data.features.map(function (feature) {\r\n                                var properties = type.outputProperties;\r\n                                if (!result.some(function (elem) {\r\n                                    return (elem.text == feature.properties[properties[0]]);\r\n                                })) {\r\n                                    var label = type.outputFormatLabel.tcFormat(type.outputProperties.map(function (outputProperty) {\r\n                                        return feature.properties[outputProperty];\r\n                                    }));\r\n\r\n                                    var text = type.outputProperties.map(function (outputProperty) {\r\n                                        return feature.properties[outputProperty];\r\n                                    }).join('-');\r\n\r\n                                    result.push({\r\n                                        id: type.dataIdProperty.map(function (elem) {\r\n                                            return feature.properties[elem];\r\n                                        }).join('#'),\r\n                                        label: label,\r\n                                        text: text,\r\n                                        dataLayer: feature.id.split('.')[0],\r\n                                        dataRole: type.typeName\r\n                                    });\r\n                                }\r\n                            });\r\n\r\n                            //console.log('getRoad promise resuelta');\r\n                            resolve(result);\r\n                        } else {\r\n                            //console.log('getRoad promise resuelta');\r\n                            resolve([]);\r\n                        }\r\n                    }).catch(function (data) {\r\n                        //console.log('getRoad promise resuelta - xhr fail');\r\n                        resolve([]);\r\n                    });\r\n                } else {\r\n                    //console.log('getRoad promise resuelta - no encaja en road');\r\n                    resolve([]);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getPK = function (pattern) {\r\n        var self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            pattern = pattern.trim();\r\n            if (pattern.length < 3) {\r\n                resolve([]);\r\n            } else {\r\n\r\n                var type = self.getSearchTypeByRole(TC.Consts.searchType.ROADPK);\r\n\r\n                var roadPKPattern = type.getPattern();\r\n                var match = roadPKPattern.exec(pattern);\r\n                if (match && match[3] && match[5]) {\r\n\r\n                    var _pattern = match[2] ? match[2].trim() + \"-\" + match[3].trim() : match[3].trim();\r\n                    if (match[4] && match[4].length > 0) {\r\n                        _pattern = _pattern + \"-\" + match[4].trim();\r\n                    }\r\n\r\n                    self.resultsList.innerHTML = '<li><a class=\"tc-ctl-search-li-loading\" href=\"#\">' + self.getLocaleString('searching') + '<span class=\"tc-ctl-search-loading-spinner tc-ctl-search-loading\"></span></a></li>';\r\n                    self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n                    TC.ajax({\r\n                        url: type.url + '?' + type.filter.getParams({ t: _pattern, s: match[5].trim() }),\r\n                        method: 'GET',\r\n                        responseType: TC.Consts.mimeType.JSON                        \r\n                    }).then(function (data) {\r\n                        var result = [];\r\n                        if (data.totalFeatures > 0) {\r\n                            data.features.map(function (feature) {\r\n                                var properties = type.outputProperties;\r\n                                if (!result.some(function (elem) {\r\n                                    return (elem.label == feature.properties[properties[0]]);\r\n                                })) {\r\n                                    var text = type.outputFormatLabel.tcFormat(type.outputProperties.map(function (outputProperty) {\r\n                                        return feature.properties[outputProperty];\r\n                                    }));\r\n                                    result.push({\r\n                                        id: type.dataIdProperty.map(function (elem) {\r\n                                            return feature.properties[elem];\r\n                                        }).join('#'),\r\n                                        label: text,\r\n                                        text: text,\r\n                                        dataLayer: feature.id.split('.')[0],\r\n                                        dataRole: type.typeName\r\n                                    });\r\n                                }\r\n                            });\r\n                            //console.log('getRoadPK promise resuelta');\r\n                            resolve(result);\r\n                        } else {\r\n                            //console.log('getRoadPK promise resuelta');\r\n                            resolve([]);\r\n                        }\r\n                    }).catch(function (data) {\r\n                        //console.log('getRoadPK promise resuelta - xhr fail');\r\n                        resolve([]);\r\n                    });\r\n                } else {\r\n                    //console.log('getRoadPK promise resuelta - no encaja en pk');\r\n                    resolve([]);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.search = function (pattern, callback) {\r\n        var self = this;\r\n        var results = [];\r\n\r\n        if (self.request) {\r\n\r\n            for (var i = 0; i < self.request.length; i++) {\r\n                console.log(\"new criteria: search promise/s aborted\");\r\n                //self.request[i].abort();\r\n            }\r\n\r\n            self.request = [];\r\n        }\r\n\r\n        pattern = $.trim(pattern);\r\n        if (pattern.length > 0) {\r\n            pattern = pattern.toLowerCase();\r\n\r\n            var waiting = [];\r\n            var addWaiting = function (fn) {\r\n                waiting.push(new Promise(function (resolve, reject) {\r\n                    fn.call(self, pattern).then(function (result) {\r\n                        results = results.concat(result);\r\n                        resolve(results);\r\n                    });\r\n                }));\r\n            };\r\n\r\n            var addressSearched = false;\r\n\r\n            self.allowedSearchTypes.forEach(function (allowed) {\r\n                if (allowed.parser) {\r\n                    addWaiting(allowed.parser);\r\n                } else {\r\n                    console.log('Falta implementación del método parser');\r\n                }\r\n            });\r\n\r\n            Promise.all(waiting).then(function () {\r\n                if (results)\r\n                    self._search.data = results = results.sort(function (a, b) {\r\n                        var pattern = /(\\d+)/;\r\n                        var _a, _b = '';\r\n                        if (pattern.test(a.label) && pattern.test(b.label)) {\r\n                            _a = a.label.match(pattern)[1];\r\n                            _b = b.label.match(pattern)[1];\r\n                        } else {\r\n                            _a = a.label;\r\n                            _b = b.label;\r\n                        }\r\n\r\n                        if (_a > _b)\r\n                            return 1;\r\n                        else\r\n                            if (_a < _b)\r\n                                return -1;\r\n                            else\r\n                                return 0;\r\n                    }.bind(self));\r\n\r\n                if (callback)\r\n                    callback(results);\r\n\r\n                if (results.length === 0) {\r\n                    self.cleanMap();\r\n\r\n                    if (!self.layer ||\r\n                        (self.layer && self.layer.features.length === 0)) {\r\n                        self.resultsList.innerHTML = '<li><a title=\"' + self.EMPTY_RESULTS_TITLE + '\" class=\"tc-ctl-search-li-empty\">' + self.EMPTY_RESULTS_LABEL + '</a></li>';\r\n                        self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n                    }\r\n                }\r\n\r\n                self.lastPattern = \"\";\r\n            });\r\n        }\r\n        else self.cleanMap();\r\n    };\r\n\r\n    var setQueryableFeatures = function (features) {\r\n        var self = this;\r\n\r\n        if (features && features.length > 0) {\r\n            for (var i = 0; i < features.length; i++) {\r\n                if (features[i].showsPopup != self.queryableFeatures)\r\n                    features[i].showsPopup = self.queryableFeatures;\r\n            }\r\n        }\r\n    };\r\n    ctlProto._goToResult = function (id, dataRole) {\r\n        var self = this;\r\n        var goTo = null;\r\n        return new Promise(function (resolve, reject) {\r\n            if (!self.loading)\r\n                self.loading = self.map.getControlsByClass(\"TC.control.LoadingIndicator\")[0];\r\n\r\n            var wait;\r\n            wait = self.loading.addWait();\r\n\r\n            // en pantallas pequeñas, colapsamos el panel de herramientas\r\n            if (Modernizr.mq('(max-width: 30em)')) {\r\n                self.textInput.blur();\r\n                self.map.trigger(TC.Consts.event.TOOLSCLOSE);\r\n            }\r\n\r\n            self.cleanMap();\r\n\r\n            var customSearchType = false;\r\n            var keepOnLooping = true;\r\n\r\n            self.allowedSearchTypes.forEach(function (allowed) {\r\n                if (keepOnLooping) {\r\n\r\n                    if (!self.availableSearchTypes[allowed.typeName]) {\r\n\r\n                        if (allowed.goTo) {\r\n                            customSearchType = true;\r\n\r\n                            goTo = allowed.goTo.call(self, id);\r\n                            if (goTo !== null) {\r\n                                keepOnLooping = false;\r\n                            }\r\n                        } else console.log('Falta implementación del método goTo');\r\n\r\n                    } else {\r\n\r\n                        var dr = dataRole || self.getElementOnSuggestionList.call(self, id).dataRole;\r\n                        if (dr) {\r\n\r\n                            var searchType = self.getSearchTypeByRole(dr);\r\n\r\n                            if (self.availableSearchTypes[dr] && searchType && searchType.goTo) {\r\n                                goTo = searchType.goTo.call(self, id, dr);\r\n                                if (goTo !== null) {\r\n                                    keepOnLooping = false;\r\n                                }\r\n                            } else if (!self.availableSearchTypes[dr] && searchType && searchType.goTo) {\r\n                                customSearchType = true;\r\n\r\n                                goTo = searchType.goTo.call(self, id, dr);\r\n                                if (goTo !== null) {\r\n                                    keepOnLooping = false;\r\n                                }\r\n                            } else console.log('Falta implementación del método goTo');\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            self.loading.removeWait(wait);\r\n\r\n            if (goTo) {\r\n\r\n                self.getLayer().then(function (layer) {\r\n                    switch (true) {\r\n                        case goTo.params.type == TC.Consts.layerType.VECTOR:\r\n                            for (var i = 0; i < self.WFS_TYPE_ATTRS.length; i++) {\r\n                                if (layer.hasOwnProperty(self.WFS_TYPE_ATTRS[i]))\r\n                                    delete layer[self.WFS_TYPE_ATTRS[i]];\r\n                            }\r\n                            break;\r\n                        case goTo.params.type == TC.Consts.layerType.WFS:\r\n                            for (var i = 0; i < self.WFS_TYPE_ATTRS.length; i++) {\r\n                                layer[self.WFS_TYPE_ATTRS[i]] = goTo.params[self.WFS_TYPE_ATTRS[i]];\r\n                            }\r\n\r\n                            wait = self.loading.addWait();\r\n                            break;\r\n                        default:\r\n                    }\r\n\r\n                    layer.type = goTo.params.type;\r\n\r\n                    self.map.on(TC.Consts.event.FEATURESADD, function (e) {\r\n                        if (e.layer === self.layer) {\r\n                            setQueryableFeatures.call(self, e.features);\r\n                        }\r\n                    });\r\n\r\n                    layer.refresh().then(function () {\r\n                        self.map.one(TC.Consts.event.LAYERUPDATE, function (e) {\r\n                            if (e.layer == layer) {\r\n                                // Salta cuando se pinta una feature que no es de tipo API porque la gestión de estilos salta antes (no es controlable)\r\n                                self.map.one(TC.Consts.event.FEATURESADD, function (e) {\r\n                                    if (e.layer == layer) {\r\n                                        if (!e.layer.features || e.layer.features.length == 0 && e.layer.wrap.layer.getSource().getFeatures()) {\r\n                                            self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                                            var bounds = e.layer.wrap.layer.getSource().getExtent();\r\n                                            var radius = e.layer.map.options.pointBoundsRadius;\r\n\r\n                                            if (bounds[2] - bounds[0] === 0) {\r\n                                                bounds[0] = bounds[0] - radius;\r\n                                                bounds[2] = bounds[2] + radius;\r\n                                            }\r\n                                            if (bounds[3] - bounds[1] === 0) {\r\n                                                bounds[1] = bounds[1] - radius;\r\n                                                bounds[3] = bounds[3] + radius;\r\n                                            }\r\n                                            e.layer.map.setExtent(bounds);\r\n\r\n                                            // GLS: Necesito diferenciar un zoom programático de un zoom del usuario para la gestión del zoom en 3D\r\n                                            self.map.trigger(TC.Consts.event.ZOOMTO, {\r\n                                                extent: bounds, layer: e.layer\r\n                                            });\r\n                                        }\r\n                                        else if (e.layer.features && e.layer.features.length > 0) {\r\n                                            self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                                            self.layer.map.zoomToFeatures(e.layer.features);\r\n\r\n                                            self.map.trigger(TC.Consts.event.FEATURESADD, { layer: self.layer, features: self.layer.features });\r\n\r\n                                        } else if (e.layer.features && e.layer.features.length == 0 && goTo.params.type == TC.Consts.layerType.WFS) {\r\n                                            self.resultsList.inner = goTo.emptyResultHTML;\r\n                                            self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n\r\n                                            self.map.trigger(TC.Consts.event.SEARCHQUERYEMPTY);\r\n                                        }\r\n\r\n                                        self.loading.removeWait(wait);\r\n                                    }\r\n                                });\r\n\r\n                                if (e.layer.features && e.layer.features.length > 0) {\r\n                                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                                    self.layer.map.zoomToFeatures(self.layer.features);\r\n\r\n                                    self.map.trigger(TC.Consts.event.FEATURESADD, { layer: self.layer, features: self.layer.features });\r\n\r\n                                    self.loading.removeWait(wait);\r\n                                } else if (e.layer.features && e.layer.features.length == 0 && goTo.params.type == TC.Consts.layerType.WFS) {\r\n                                    self.resultsList.innerHTML = goTo.emptyResultHTML;\r\n                                    self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n\r\n                                    if (!(e.newData && e.newData.features && e.newData.features.length > 0)) {\r\n                                        self.map.trigger(TC.Consts.event.SEARCHQUERYEMPTY);\r\n                                    }\r\n\r\n                                    self.loading.removeWait(wait);\r\n                                }\r\n                            }\r\n                        });\r\n                    });\r\n                });\r\n\r\n                resolve(goTo);\r\n            } else {\r\n                reject();\r\n                if (!customSearchType) {\r\n                    self.map.trigger(TC.Consts.event.SEARCHQUERYEMPTY);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.goToResult = function (id, dataRole) {\r\n        var self = this;\r\n        // si está habilitada\r\n        if (self.getSearchTypeByRole(dataRole)) {\r\n            return self._goToResult(id, dataRole);\r\n            // si no está habilitada pero está disponible\r\n        } else if (self.availableSearchTypes[dataRole]) {\r\n            self.addAllowedSearchType(dataRole, self.availableSearchTypes[dataRole], self);\r\n            return self._goToResult(id, dataRole);\r\n        } else {\r\n            alert('No se reconoce el tipo de búsqueda: ' + dataRole);\r\n        }\r\n    };\r\n\r\n    var drawPoint = function (id) {\r\n        var self = this;\r\n\r\n        wait = self.loading.addWait();\r\n\r\n        var point = self.getPoint(id);\r\n        var delta;\r\n        var title;\r\n        var promise;\r\n\r\n        if (point) {\r\n            title = self.getLabel(id);\r\n            promise = self.layer.addMarker(point, $.extend({}, self.map.options.styles.point, { title: title, group: title }));\r\n        } else {\r\n            var match = /^Lat((?:[+-]?)\\d+(?:\\.\\d+)?)Lon((?:[+-]?)\\d+(?:\\.\\d+)?)$/.exec(id);\r\n            id = self.LAT + match[2] + self.LON + match[1];\r\n            point = self.getPoint(id);\r\n\r\n            if (point) {\r\n                title = self.getLabel(id);\r\n                promise = self.layer.addMarker(point, $.extend({}, self.map.options.styles.point, { title: title, group: title }));\r\n\r\n                self.textInput.value = title;\r\n            }\r\n        }\r\n\r\n        promise.then(function (feat) {\r\n            self.map.trigger(TC.Consts.event.FEATURESADD, {\r\n                layer: self.layer, features: [feat]\r\n            });\r\n\r\n            self.map.zoomToFeatures([feat]);\r\n\r\n            self.loading.removeWait(wait);\r\n        });\r\n\r\n    };\r\n    ctlProto.goToCoordinates = function (id) {\r\n        var self = this;\r\n        var goTo = {};\r\n        if (/^X(\\d+(?:[\\.\\,]\\d+)?)Y(\\d+(?:[\\.\\,]\\d+)?)$/.test(id) || /^Lat((?:[+-]?)\\d+(?:[.,]\\d+)?)Lon((?:[+-]?)\\d+(?:[.,]\\d+)?)$/.test(id)) {\r\n\r\n            goTo.params = {\r\n                type: TC.Consts.layerType.VECTOR,\r\n                styles: {\r\n                    marker: {\r\n                        url: self.layerStyleFN.bind(self, 'marker', 'url', true)\r\n                    }\r\n                }\r\n            };\r\n\r\n            goTo.emptyResultHTML = '<li><a class=\"tc-ctl-search-li-empty\">' + self.OUTBBX_LABEL + '</a></li>';\r\n\r\n            drawPoint.call(self, id);\r\n\r\n            return goTo;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    ctlProto.goToCadastralRef = function (id) {\r\n        var self = this;\r\n        var goTo = {};\r\n\r\n        var regex = new RegExp(\"^\" + self.MUN + \"(\\\\d+)\" + self.POL + \"(\\\\d{1,2})\" + self.PAR + \"{1}(\\\\d{1,4})\");\r\n        if (regex.test(id)) {\r\n            var match = regex.exec(id);\r\n\r\n            if (!TC.filter) {\r\n                TC.syncLoadJS(TC.apiLocation + 'TC/Filter');\r\n            }\r\n\r\n            var type = self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL);\r\n\r\n            goTo.params = {\r\n                type: TC.Consts.layerType.WFS,\r\n                url: type.url,\r\n                version: type.version,\r\n                geometryName: type.geometryName,\r\n                featurePrefix: type.featurePrefix,\r\n                featureType: type.featureType,\r\n                properties: new TC.filter.and(\r\n                    new TC.filter.equalTo(type.queryProperties.firstQueryWord, $.trim(match[1])),\r\n                    new TC.filter.equalTo(type.queryProperties.secondQueryWord, $.trim(match[2])),\r\n                    new TC.filter.equalTo(type.queryProperties.thirdQueryWord, $.trim(match[3]))),\r\n                outputFormat: type.outputFormat,\r\n                styles: type.styles\r\n            };\r\n\r\n            goTo.emptyResultHTML = '<li><a title=\"' + self.EMPTY_RESULTS_TITLE + '\" class=\"tc-ctl-search-li-empty\">' + self.EMPTY_RESULTS_LABEL + '</a></li>';\r\n\r\n            return goTo;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    ctlProto.goToRoad = function (id) {\r\n        var self = this;\r\n        var goTo = {};\r\n\r\n        var type = self.getSearchTypeByRole(TC.Consts.searchType.ROAD);\r\n\r\n        goTo.params = {\r\n            type: TC.Consts.layerType.WFS,\r\n            url: type.url,\r\n            version: type.version,\r\n            geometryName: type.geometryName,\r\n            featurePrefix: type.featurePrefix,\r\n            featureType: type.getFeatureTypes(),\r\n            maxFeatures: 3000,\r\n            properties: type.filter.getGoToFilter(id),\r\n            outputFormat: type.outputFormat,\r\n            styles: type.styles\r\n        };\r\n\r\n        goTo.emptyResultHTML = '<li><a title=\"' + self.EMPTY_RESULTS_TITLE + '\" class=\"tc-ctl-search-li-empty\">' + self.EMPTY_RESULTS_LABEL + '</a></li>';\r\n\r\n        return goTo;\r\n    };\r\n\r\n    ctlProto.goToPK = function (id) {\r\n        var self = this;\r\n        var goTo = {};\r\n\r\n        var type = self.getSearchTypeByRole(TC.Consts.searchType.ROADPK);\r\n\r\n        goTo.params = {\r\n            type: TC.Consts.layerType.WFS,\r\n            url: type.url,\r\n            version: type.version,\r\n            geometryName: type.geometryName,\r\n            featurePrefix: type.featurePrefix,\r\n            featureType: type.getFeatureTypes(),\r\n            maxFeatures: 3000,\r\n            properties: type.filter.getGoToFilter(id),\r\n            outputFormat: type.outputFormat,\r\n            styles: type.styles\r\n        };\r\n\r\n        goTo.emptyResultHTML = '<li><a title=\"' + self.EMPTY_RESULTS_TITLE + '\" class=\"tc-ctl-search-li-empty\">' + self.EMPTY_RESULTS_LABEL + '</a></li>';\r\n\r\n        return goTo;\r\n    };\r\n\r\n    ctlProto.goToStringPattern = function (id, dataRole) {\r\n        var self = this;\r\n        var goTo = {};\r\n\r\n        var type = self.getSearchTypeByRole(dataRole);\r\n\r\n        goTo.params = {\r\n            type: TC.Consts.layerType.WFS,\r\n            url: type.url,\r\n            version: type.version,\r\n            geometryName: type.geometryName,\r\n            featurePrefix: type.featurePrefix,\r\n            featureType: type.getFeatureTypes(),\r\n            maxFeatures: 3000,\r\n            properties: type.filter.getGoToFilter(id),\r\n            outputFormat: type.outputFormat,\r\n            styles: type.styles\r\n        };\r\n\r\n        return goTo;\r\n    };\r\n\r\n    ctlProto.getPoint = function (pattern) {\r\n        var self = this;\r\n        var isMapGeo = self.map.wrap.isGeo();\r\n        var point;\r\n        var match = /^X(\\d+(?:\\.\\d+)?)Y(\\d+(?:\\.\\d+)?)$/.exec(pattern);\r\n        if (match && match.length === 3) {\r\n            point = [parseFloat(match[1]), parseFloat(match[2])];\r\n            if (isMapGeo) {\r\n                point = TC.Util.reproject(point, self.map.options.utmCrs, self.map.crs);\r\n            }\r\n        }\r\n        else {\r\n            match = /^Lat((?:[+-]?)\\d+(?:[.,]\\d+)?)Lon((?:[+-]?)\\d+(?:[.,]\\d+)?)$/.exec(pattern);\r\n            if (match && match.length === 3) {\r\n                point = [parseFloat(match[2]), parseFloat(match[1])];\r\n                if (!isMapGeo) {\r\n                    return TC.Util.reproject(point, self.map.options.geoCrs, self.map.crs);\r\n                }\r\n            }\r\n\r\n            match = /^Lon((?:[+-]?)\\d+(?:[.,]\\d+)?)Lat((?:[+-]?)\\d+(?:[.,]\\d+)?)$/.exec(pattern);\r\n            if (match && match.length === 3) {\r\n                point = [parseFloat(match[2]), parseFloat(match[1])];\r\n                if (!isMapGeo) {\r\n                    return TC.Util.reproject(point, self.map.options.geoCrs, self.map.crs);\r\n                }\r\n            }\r\n        }\r\n\r\n        return point;\r\n    };\r\n\r\n    ctlProto.insideLimit = function (point) {\r\n        var self = this;\r\n        var getIntersectsBounds = function (extent, point) {\r\n            if (extent instanceof Array)\r\n                return point[0] >= extent[0] && point[0] <= extent[2] && point[1] >= extent[1] && point[1] <= extent[3];\r\n            else return true;\r\n        };\r\n\r\n        if (getIntersectsBounds(self.map.options.maxExtent, point)) {\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    };\r\n\r\n    ctlProto.getPattern = function () {\r\n        var self = this;\r\n        return self.textInput.value;\r\n    };\r\n\r\n    ctlProto.getLabel = function (id) {\r\n        var self = this;\r\n        var result = id;\r\n        var locale = TC.Util.getMapLocale(self.map);\r\n\r\n        if (id.match(new RegExp('^(?:' + self.LAT + '[-\\\\d])|(?:' + self.UTMX + '[\\\\d])'))) {\r\n            result = result.replace(self.LAT, self.LAT_LABEL).replace(self.LON, ' ' + self.LON_LABEL).replace(self.UTMX, self.UTMX_LABEL).replace(self.UTMY, ' ' + self.UTMY_LABEL);\r\n            var match = result.match(new RegExp('^' + $.trim(self.LAT_LABEL) + '*\\\\s*([-+]?\\\\d{1,3}([.,]\\\\d+)?)\\\\,?\\\\s*' + $.trim(self.LON_LABEL) + '*\\\\s*([-+]?\\\\d{1,2}([.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                result = result.replace(match[1], parseFloat(match[1]).toLocaleString(locale));\r\n                result = result.replace(match[3], parseFloat(match[3]).toLocaleString(locale));\r\n            }\r\n\r\n            var localeDecimalSeparator = 1.1.toLocaleString(locale).substring(1, 2);\r\n            var match = result.match(new RegExp('^' + $.trim(self.UTMX_LABEL) + '*\\\\s*([0-9]{' + self.UTMX_LEN + '}(?:[.,]\\\\d+)?)\\\\s*\\\\,?\\\\s*' + $.trim(self.UTMY_LABEL) + '*\\\\s*([0-9]{' + self.UTMY_LEN + '}(?:[.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                if (!Number.isInteger(parseFloat(match[1])))\r\n                    result = result.replace(match[1], match[1].replace('.', localeDecimalSeparator));\r\n                if (!Number.isInteger(parseFloat(match[2])))\r\n                    result = result.replace(match[2], match[2].replace('.', localeDecimalSeparator));\r\n            }\r\n\r\n        } else if (id.match(new RegExp('^(?:' + self.LON + '[-\\\\d])'))) {\r\n            result = result.replace(self.LON, self.LON_LABEL).replace(self.LAT, ' ' + self.LAT_LABEL);\r\n\r\n            var match = result.match(new RegExp('^' + $.trim(self.LON_LABEL) + '*\\\\s*([-+]?\\\\d{1,3}([.,]\\\\d+)?)\\\\,?\\\\s*' + $.trim(self.LAT_LABEL) + '*\\\\s*([-+]?\\\\d{1,2}([.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                result = result.replace(match[1], parseFloat(match[1]).toLocaleString(locale));\r\n                result = result.replace(match[3], parseFloat(match[3]).toLocaleString(locale));\r\n            }\r\n\r\n        } else if (id.match(new RegExp('^(?:(\\\\' + self.MUN + '{1})(.*)' + '(\\\\' + self.POL + '{1})' + '(\\\\d{1,2})' + '(\\\\' + self.PAR + '{1})' + '(\\\\d{1,4}))'))) {\r\n            var match = id.match(new RegExp('^(?:(\\\\' + self.MUN + '{1})(.*)' + '(\\\\' + self.POL + '{1})' + '(\\\\d{1,2})' + '(\\\\' + self.PAR + '{1})' + '(\\\\d{1,4}))'));\r\n            result = self.MUN_LABEL + match[2] + ', ' + self.POL_LABEL + match[4] + ', ' + self.PAR_LABEL + match[6];\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.removePunctuation = function (text) {\r\n        text = text || '';\r\n        var result = new Array(text.length);\r\n        var map = {\r\n            'á': 'a',\r\n            'à': 'a',\r\n            'Á': 'A',\r\n            'À': 'A',\r\n            'é': 'e',\r\n            'è': 'e',\r\n            'É': 'E',\r\n            'È': 'E',\r\n            'í': 'i',\r\n            'ì': 'i',\r\n            'Í': 'I',\r\n            'Ì': 'I',\r\n            'ó': 'o',\r\n            'ò': 'o',\r\n            'Ó': 'O',\r\n            'Ò': 'O',\r\n            'ú': 'u',\r\n            'ù': 'u',\r\n            'ü': 'u',\r\n            'Ú': 'U',\r\n            'Ù': 'U',\r\n            'Ü': 'U'\r\n        };\r\n        for (var i = 0, len = text.length; i < len; i++) {\r\n            result[i] = map[text.charAt(i)] || text.charAt(i);\r\n        }\r\n        return result.join('');\r\n    };    \r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState) {\r\n            return {\r\n                id: self.id,\r\n                searchText: self.textInput.value,\r\n                layer: self.layer.exportState({\r\n                    exportStyles: false\r\n                })\r\n            };\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        self.textInput.value = state.searchText;\r\n        self.layer.importState(state.layer).then(function () {\r\n            self.layer.features.forEach(function (f) {\r\n                f.setStyle(null); // Los estilos vienen dados exclusivamente por la capa, borramos estilos propios de la feature\r\n            });\r\n        });\r\n    };\r\n\r\n})();\r\n\r\n\r\nif (!String.prototype.tcFormat) {\r\n    String.prototype.tcFormat = function () {\r\n        var args = (arguments || [\"\"])[0];\r\n        return this.replace(/{(\\d+)}/g, function (match, number) {\r\n            return typeof args[number] != 'undefined' ?\r\n                args[number]\r\n                : match\r\n                ;\r\n        });\r\n    };\r\n}\r\n\r\n\r\nif (!String.prototype.splitRemoveWhiteSpaces) {\r\n    String.prototype.splitRemoveWhiteSpaces = function (separator) {\r\n        var _arr = [];\r\n        var arr = this.split(separator);\r\n        for (var i = 0; i < arr.length; i++)\r\n            if (arr[i].trim().length > 0)\r\n                _arr.push(arr[i].trim());\r\n\r\n        return _arr;\r\n    };\r\n}\r\n\r\n\r\nif (!String.prototype.toCamelCase) {\r\n    String.prototype.toCamelCase = function () {\r\n        var _value = this.toLowerCase();\r\n        var match = this.toLowerCase().match(/[^A-ZÁÉÍÓÚÜÀÈÌÒÙáéíóúüàèìòùa-z0-9_]+(.)/g);\r\n        if (match) {\r\n            for (var i = 0; i < match.length; i++) {\r\n                if (/[-;:.<>\\{\\}\\[\\]\\/\\s()]/g.test(match[i]))\r\n                    _value = _value.replace(match[i], match[i].toUpperCase());\r\n            }\r\n        }\r\n\r\n        return _value.charAt(0).toUpperCase() + _value.substring(1);\r\n    };\r\n}\r\n\r\n\r\nif (!Array.prototype.hasOwnProperty('findByProperty')) {\r\n    Object.defineProperty(Array.prototype, \"findByProperty\", {\r\n        enumerable: false,\r\n        writable: true,\r\n        value: function (propertyName, value) {\r\n            for (var i = 0; i < this.length; i++) {\r\n                if (this[i][propertyName] == value)\r\n                    return this[i];\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nif (!String.prototype.endsWith) {\r\n    String.prototype.endsWith = function (searchString, position) {\r\n        var subjectString = this.toString();\r\n        if (typeof position !== 'number' || !isFinite(position) || Math.floor(position) !== position || position > subjectString.length) {\r\n            position = subjectString.length;\r\n        }\r\n        position -= searchString.length;\r\n        var lastIndex = subjectString.indexOf(searchString, position);\r\n        return lastIndex !== -1 && lastIndex === position;\r\n    };\r\n}\r\n"],"file":"../../Control/Search.min.js"}