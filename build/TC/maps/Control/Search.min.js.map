{"version":3,"sources":["control/Search.js"],"names":["window","performance","now","offset","Date","this","TC","control","Control","syncLoadJS","apiLocation","SearchType","type","options","parent","self","_featureTypes","Util","extend","typeName","_throwConfigError","Error","getFeatureTypes","toFilter","featureType","Array","length","type_featureType","type_renderFeatureType","renderFeatureType","concat","isFeatureOfThisType","id","indexOf","getStyleByFeatureType","styles","getColor","css","geomType","getValue","style","hasOwnProperty","i","color","getSuggestionListHead","headerData","label","suggestionListHead","title","getLocaleString","call","featureTypes","map","elm","liHTML","join","getSuggestionListElements","data","results","areSame","a","b","isNaN","trim","getUnique","inputArray","outputArray","push","parseFeatures","forEach","feature","attributes","ids","valueToAdd","properties","outputProperties","dataIdProperties","dataIdProperty","strFormat","outputFormatLabel","dataLayer","split","slice","shift","j","compareData","p","tcFormat","text","toCamelCase","r","isThere","property","filter","dataRole","outputFormat","Consts","format","JSON","wrap","parser","WFS","featureNS","featurePrefix","read","getPattern","pattern","bindRootFilterNode","filtersArr","dataT","rootFilters","rootCfg","active","root","limit","item","getFilterNode","filterNode","queryProperties","firstQueryWord","queryWord","index","_LIKE_PATTERN","getPropertyValue","role","propertyName","getSearchTypeByRole","getIsLikeNode","name","value","toEscape","test","replace","toString","toLowerCase","toUpperCase","getFunctionStrMatches","propertyValue","fn","filterByMatch","regex","RegExp","_MATCH_PATTERN","f","key","propName","getFilter","multiL","searchType","NUMBER","_f","exec","t","s","secondQueryWord","match","substring","thirdQueryWord","STREET","LOCALITY","getParams","filters","params","REQUEST","SERVICE","MAXFEATURES","VERSION","version","OUTPUTFORMAT","ft","TYPENAME","_getProperties","Object","prop","_properties","_ids","removeDuplicates","toCheck","arr","PROPERTYNAME","FILTER","getParamString","getGoToFilter","props","_id","source","src","transformFilter","equalTo","comparison","EQUAL_TO","and","apply","Search","arguments","exportsState","event","TOOLSCLOSE","url","UTMX","UTMY","LON","LAT","UTMX_LABEL","UTMY_LABEL","LON_LABEL","LAT_LABEL","MUN","POL","PAR","MUN_LABEL","POL_LABEL","PAR_LABEL","availableSearchTypes","CADASTRAL","suggestionRoot","geometryName","searchWeight","municipality","labelProperty","idProperty","CATAST_Pol_ParcelaUrba","CATAST_Pol_ParcelaRusti","CATAST_Pol_ParcelaMixta","polygon","fillColor","fillOpacity","strokeColor","strokeWidth","strokeOpacity","getCadastralRef","goTo","goToCadastralRef","goToIdFormat","idPropertiesIdentifier","COORDINATES","getCoordinates","goToCoordinates","QUERYWORD","FIRST","SECOND","THIRD","MUNICIPALITY","getStringPattern","bind","stringPatternToCheck","stringPatternsValidators","s_or_t","goToStringPattern","COUNCIL","line","strokeLinecap","strokeDashstyle","point","angle","fontColor","fontSize","fontWeight","labelOutlineColor","labelOutlineWidth","radius","URBAN","PLACENAME","PLACENAMEMUNICIPALITY","COMMONWEALTH","ROAD","getRoad","goToRoad","ROADPK","getPK","goToPK","getRootLabel","Promise","resolve","reject","rootLabel","CQL_FILTER","elem","ajax","method","responseType","mimeType","then","response","totalFeatures","features","catch","allowedSearchTypes","allowed","isEmptyObject","rootType","addAllowedSearchType","queryableFeatures","UTMX_LEN","UTMY_LEN","interval","NORMAL_PATTERNS","ROMAN_NUMBER","ABSOLUTE_NOT_DOT","ABSOLUTE","inherit","ctlProto","prototype","CLASS","SEARCHQUERYEMPTY","template","dust","register","body_0","chk","ctx","w","h","$key","__dustBody","result","_search","layerStyleFN","getFeatureType","idFeature","getStyle","getSearchTypeByFeature","Cfg","extractValue","Feature","trigger","FEATURESADD","layer","geom","values","getData","styleFN","layerPromise","addLayer","getUID","owner","stealth","declutter","layerType","VECTOR","marker","anchor","Defaults","height","width","EMPTY_RESULTS_LABEL","EMPTY_RESULTS_TITLE","OUTBBX_LABEL","WFS_TYPE_ATTRS","highlighting","strReg","lastPattern","textInput","normalizedLastPattern","querys","separatorChar","q","_strReg","st","rex","selectionCallback","e","_target","target","tagName","el","matchesSelector","matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector","parentElement","querySelector","textContent","_goToResult","unescape","getAttribute","parentNode","UI","autocomplete","sortAlphaNum","reA","reN","AInt","parseInt","BInt","aA","bA","aN","bN","buildHTML","html","dataRoles","sort","sort_","aRoot","bRoot","first","encodeURIComponent","resultsList","querySelectorAll","liDataRoles","includes","renderData","callback","search","list","classList","add","classes","HIDDEN","_research","div","placeHolder","setAttribute","button","addEventListener","CLICK","getLayer","l","zoomToFeatures","dispatchEvent","Event","instructions","EventTarget","listenerBySelector","focus","which","preventDefault","stopPropagation","remove","retryTimeout","loadJS","searchDelay","link","minLength","lastpress","requestAnimationFrame","step","criteria","cancelAnimationFrame","undefined","onKeydown","ctrlKey","altKey","shiftKey","keyCode","document","activeElement","selector","sibling","nextElementSibling","getNextSibling","previousElementSibling","getPreviousSibling","isFunction","getElementOnSuggestionList","searchRequestsResults","getFeatures","cleanMap","clearFeatures","FEATUREREMOVE","getMunicipalities","cache","_municipalitiesPromise","municipalities","coords","parseCoords","xValue","yValue","xLabel","UTM","yLabel","getPoint","insideLimit","crs","getLabel","_pattern","matcher","getItem","mun","munLabel","pol","par","removePunctuation","tsp","getPortal","formatStreetNumber","bindRoot","spt","tnsp","ts","reverse","getStreet","revS","fs","si","_criteria","isPortal","c","x","_cr","inPortal","criteriaRev","chs","sp","snp","isCheck","check","m","ch","addRoot","indicatedRoot","newResult","splice","getObjectsFromStringToQuery","allowedRoles","charAt","tests","ex","error","msgErrorMode","EMAIL","requestToWFS","signal","doneCallback","fetch","headers","Content-Type","body","ok","err","console","log","toQuery","requestsQuery","combinedCriteria","toQueryCombined","pendingSuggestionLstHead","filterRoles","dataToQuery","keys","pendingHeaderRoles","roles","responseToSuggestionLstElmt","searchRequestsAbortController","innerHTML","CustomEvent","all","json","some","outputProperty","abort","isAborted","onAbort","removeEventListener","AbortController","toRender","renderingEnd","renderResultsOnSuggestionList","_a","_b","manageLoadingByDataRole","loadingElemOfDataRole","indexLoadingElemOfDataRole","childNodes","headerElemOfDataRole","removeChild","toConcat","findIndex","srrElm","loading","getControlsByClass","wait","addWait","matchMedia","blur","customSearchType","keepOnLooping","dr","removeWait","on","showsPopup","one","LAYERUPDATE","getSource","bounds","getExtent","pointBoundsRadius","setExtent","ZOOMTO","extent","inner","emptyResultHTML","newData","refresh","goToResult","alert","promise","addMarker","group","feat","maxFeatures","isMapGeo","isGeo","parseFloat","reproject","utmCrs","geoCrs","getIntersectsBounds","maxExtent","locale","getMapLocale","toLocaleString","localeDecimalSeparator","Number","isInteger","á","à","Á","À","é","è","É","È","í","ì","Í","Ì","ó","ò","Ó","Ò","ú","ù","ü","Ú","Ù","Ü","len","exportState","searchText","exportStyles","importState","state","setStyle","String","args","number","splitRemoveWhiteSpaces","separator","_arr","_value","defineProperty","enumerable","writable","endsWith","searchString","position","subjectString","isFinite","Math","floor","lastIndex"],"mappings":"CAAC,WAEG,GAAKA,OAAOC,aAOL,GAAID,OAAOC,cAAgBD,OAAOC,YAAYC,IAAK,CACtDF,OAAOC,YAAYE,OAASC,KAAKF,MACjCF,OAAOC,YAAYC,IAAM,WACrB,OAAOE,KAAKF,MAAQF,OAAOC,YAAYE,cAT3CH,OAAOC,YAAc,CACjBE,OAAQC,KAAKF,MACbA,IAAK,WACD,OAAOE,KAAKF,MAAQG,KAAKF,SANzC,GAiBAG,GAAGC,QAAUD,GAAGC,SAAW,GAEtBD,GAAGE,SACJF,GAAGG,WAAWH,GAAGI,YAAc,cAInC,IAAIC,WAAa,SAAUC,EAAMC,EAASC,GACtC,IAAIC,EAAOV,KAEXU,EAAKD,OAASA,EAEdC,EAAKC,cAAgB,GAErBV,GAAGW,KAAKC,OAAOH,EAAMF,GAErBE,EAAKI,SAAWP,EAEhBG,EAAKK,kBAAoB,WAGrB,MAAM,IAAIC,MAAM,mDAFLhB,KAEyDc,WAGxEJ,EAAKO,gBAAkB,SAAUC,GAG7B,GAAIA,EACA,OAHOlB,KAGKmB,uBAAuBC,MAH5BpB,KAGyCmB,YAAc,CAHvDnB,KAG6DmB,aAGxE,GAAkC,IANvBnB,KAMFW,cAAcU,OAAc,CACjC,IAAIC,EAPGtB,KAOqBmB,uBAAuBC,MAP5CpB,KAOyDmB,YAAc,CAPvEnB,KAO6EmB,aAChFI,EARGvB,KAQ2BwB,kBAR3BxB,KAQoDwB,6BAA6BJ,MARjFpB,KAQ8FwB,kBAAoB,CARlHxB,KAQwHwB,mBAAqB,GAR7IxB,KASFW,cAAgBW,EAAiBG,OAAOF,GAGjD,OAZWvB,KAYCW,eAGhBD,EAAKgB,oBAAsB,SAAUC,GAGjC,OAFW3B,KAECiB,kBAAkBW,QAAQD,IAAO,GAGjDjB,EAAKmB,sBAAwB,SAAUV,GAGnC,OAFWnB,KAEFiB,kBAAkBW,QAAQT,IAAgB,EAFxCnB,KAGK8B,OAHL9B,KAGiBiB,kBAAkBW,QAAQT,IAG/C,MAGX,IAAIY,EAAW,SAAUC,EAAKC,EAAUd,GACpC,IAEIe,EAAW,SAAUC,EAAOF,EAAUD,GACtC,GAAIC,GACA,GAAIE,EAAMC,eAAeH,IAAaE,EAAMF,GAAUG,eAAeJ,GACjE,OAAOG,EAAMF,GAAUD,QAG3B,IAAK,IAAIC,KAAYE,EACjB,GAAIA,EAAMF,GAAUG,eAAeJ,GAC/B,OAAOG,EAAMF,GAAUD,IAMvC,GAAIb,EAAa,CAEb,OAAOe,EAlBAlC,KAiBU6B,sBAAsBV,GAChBc,EAAUD,GAEjC,IAAK,IAAIK,EAAI,EAAGA,EApBTrC,KAoBkB8B,OAAOT,OAAQgB,IAAK,CACzC,IACIC,EAAQJ,EAtBTlC,KAqBc8B,OAAOO,GACIJ,EAAUD,GACtC,GAAIM,EACA,OAAOA,IAMvB5B,EAAK6B,sBAAwB,WACzB,IAEIC,EAAYC,EAAOH,EAFnB5B,EAAOV,KAIX,GAAuC,mBAA5BU,EAAKgC,mBAAmC,CAC/CF,EAAa9B,EAAKgC,qBAClBD,EAAQD,EAAWC,MACnBH,EAAQ,CAAC,CACLA,MAAOE,EAAWF,MAClBK,MAAOH,EAAWC,YAEnB,CACHD,EAAa9B,EAAKgC,mBAClBD,EAAQ/B,EAAKD,OAAOmC,gBAAgBJ,EAAWC,OAG/C,GAAgC,iBAArBD,EAAWF,MAClBA,EAAQ,CAAC,CACLA,MAAOP,EAASc,KAAKnC,EAAM8B,EAAWF,OACtCK,MAAOF,SAER,GAAID,EAAWF,iBAAiBlB,MAAO,CAC1C,IAAI0B,EAAepC,EAAKO,kBACpBuB,EAAWF,MAAMjB,SAAWyB,EAAazB,OACzCiB,EAAQE,EAAWF,MAAMS,IAAI,SAAUC,EAAKX,GACxC,MAAO,CACHC,MAAOP,EAASc,KAAKnC,EAAMsC,EAAIF,EAAaT,IAAIC,MAAMN,IAAKgB,EAAIF,EAAaT,IAAIC,MAAML,SAAUa,EAAaT,IAC7GM,MAAOjC,EAAKD,OAAOmC,gBAAgBI,EAAIF,EAAaT,IAAIM,QAAUF,KAI1E/B,EAAKK,wBAE0B,iBAArByB,EAAWF,QACzBA,EAAQ,CAAC,CACLA,MAAOP,EAASc,KAAKnC,EAAM8B,EAAWF,MAAMN,IAAKQ,EAAWF,MAAML,UAClEU,MAAOF,KAKnB,GAAIA,GAASH,EAAO,CAChB,IAAIW,EAAS,mCAAqCR,EAAQ,UAQ1D,OANAQ,GAAUX,EAAMS,IAAI,SAAUC,GAC1B,GAAIA,EAAIV,MACJ,MAAO,qCAAuCU,EAAIL,MAAQ,mBAAqBK,EAAIV,MAAQ,eAEhGY,KAAK,IAAM,QAKdxC,EAAKK,qBAIbL,EAAKyC,0BAA4B,SAAUC,GACvC,IAAI1C,EAAOV,KACPqD,EAAU,GAEVC,EAAU,SAAUC,EAAGC,GACvB,QAAQ,GACJ,IAAoB,iBAAR,EACR,GAAID,IAAMC,EACN,OAAO,EAEX,MACJ,IAAoB,iBAAR,EACR,GAAKC,MAAMF,IAAOE,MAAMD,IAKpB,GAAID,EAAEG,SAAWF,EAAEE,OACf,OAAO,OALX,GAAIH,IAAMC,EACN,OAAO,EAUvB,OAAO,GAEPG,EAAY,SAAUC,GAEtB,IADA,IAAIC,EAAc,GACTxB,EAAI,EAAGA,EAAIuB,EAAWvC,OAAQgB,KACS,IAAxCwB,EAAYjC,QAAQgC,EAAWvB,KAC/BwB,EAAYC,KAAKF,EAAWvB,IAIpC,OAAOwB,GAmBInD,EAAKqD,cAAcX,GAEzBY,QAAQ,SAAUC,GACvB,IAAIC,EAAa,GAAIC,EAAM,GACvBC,EAAa,GAEbC,EAAa3D,EAAK4D,iBAClBC,EAAmB7D,EAAK8D,eAExBC,EAAY/D,EAAKgE,kBACjBC,EAAYV,EAAQtC,GAAGiD,MAAM,KAAKC,MAAM,EAAG,GAAGC,QAElD,KAAMpE,EAAK4D,4BAA4BlD,OAAQ,CAC3CiD,EAAa3D,EAAK4D,iBAAiBK,GACnCJ,EAAmB7D,EAAK8D,eAAeG,GACvCF,EAAYA,EAAUE,GAG1B,IAAK,IAAII,EAAI,EAAGA,EAAIV,EAAWhD,OAAQ0D,IACnCb,EAAWJ,KAAKG,EAAQb,KAAKiB,EAAWU,KAG5C,IAASA,EAAI,EAAGA,EAAIR,EAAiBlD,OAAQ0D,IACzCZ,EAAIL,KAAKG,EAAQb,KAAKmB,EAAiBQ,KAI3C,IADA,IAAIC,EAAc,GACTC,EAAI,EAAGA,EAAIvE,EAAK4D,iBAAiBjD,OAAQ4D,IAC9CD,EAAYtE,EAAK4D,iBAAiBW,IAAMf,EAAWe,GAGnDf,aAAsB9C,OAASqD,GAAad,EAAUO,GAAY7C,OAAS,EAC3E+C,EAAaK,EAAUS,SAAShB,GAE3BA,aAAsB9C,OAAyC,GAAhCuC,EAAUO,GAAY7C,SAC1D+C,EAAaF,EAAW,IAG5B,IAAIiB,EAAOf,EAAWgB,eAvDR,SAAUJ,GACxB,IAAK,IAAIK,EAAI,EAAGA,EAAIhC,EAAQhC,OAAQgE,IAAK,CACrC,IAAIhE,EAAS,EACTiE,EAAU,GACd,IAAK,IAAIC,KAAYP,EAAa,CAC9BM,EAAQxB,KAAKR,EAAQ0B,EAAYO,GAAWlC,EAAQgC,GAAGhB,WAAWkB,KAClElE,IAEJ,GAAIiE,EAAQE,OAAO,SAAUnD,GAAK,OAAOA,IAAMhB,SAAWA,EACtD,OAAO,EAKf,OAAO,GA2CF,CAAa2D,IAEd3B,EAAQS,KAAK,CACTqB,KAAMA,EACN1C,MAAO0C,EACPxD,GAAIwC,EAAIjB,KAAK,KACbuC,SAAU/E,EAAKI,SACf6D,UAAWA,EACXN,WAAYW,MAKxB,OAAO3B,GAGX3C,EAAKqD,cAAgB,SAAUX,GAW3B,OATI1C,EAAKgF,eAAiBzF,GAAG0F,OAAOC,OAAOC,KAC9B,IAAI5F,GAAG6F,KAAKC,OAAOF,KAGnB,IAAI5F,GAAG6F,KAAKC,OAAOC,IAAI,CAC5BC,UAAWvF,EAAKwF,cAChB/E,YAAaT,EAAKS,eAGZgF,KAAK/C,IAGvB1C,EAAK0F,WAAa,WAGd,MAA4B,mBAFjBpG,KAEKqG,QAFLrG,KAGKqG,UAHLrG,KAKKqG,SAIpB3F,EAAK8E,OAAS,SAAW9E,GAErB,MAAM4F,EAAqB,SAAUC,EAAYC,GAC7C,IAAIC,EAAc,GAElB,GAAID,GAAS9F,EAAKD,OAAOiG,QAAQC,OAAOC,KAEpC,IAA4B,IAAxBJ,EAAM5E,QAAQ,MAAgBlB,EAAKD,OAAOiG,QAAQC,OAAOE,MAiBzD,IAFA,IAAIC,EAAON,EAAM5B,MAAM,KAEdG,EAAI,EAAGA,EAAIrE,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAenD,OAAQ0D,IAAK,CAE9D,GAALA,GAAUrE,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAenD,OAAS,GAC7DoF,EAAY3C,KAAK,aAGrB2C,EAAY3C,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAeO,GAAI+B,EAAKzF,OAAS0D,EAAI+B,EAAK/B,GAAK+B,EAAK,KAEtH/B,GAAKrE,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAenD,OAAS,GAAKX,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAenD,OAAS,GAChHoF,EAAY3C,KAAK,kBA1BuC,CAEhE,IAAIkD,EAAatG,EAAKD,OAAOiG,QAAQC,OAAOM,gBAAgBC,eAAenE,IAAI,SAAUoE,EAAWC,GAChG,OAAO1G,EAAK8E,OAAOuB,cAAcI,EAAWzG,EAAKD,OAAO4G,cAAgBb,EAAQ9F,EAAKD,OAAO4G,iBAGhG,GAAIL,EAAW3F,OAAS,EAAG,CACvBoF,EAAY3C,KAAK,cACjB2C,EAAcA,EAAYhF,OAAOuF,IACrBlD,KAAK,mBAEjB2C,EAAcA,EAAYhF,OAAOuF,OAmBtC,CACH,IAAK,IAAI3E,EAAI,EAAGA,EAAI3B,EAAKD,OAAOiG,QAAQC,OAAOC,KAAKvF,OAAQgB,IAAK,CACzDyE,EAAOpG,EAAKD,OAAOiG,QAAQC,OAAOC,KAAKvE,GAElC,GAALA,GAAU3B,EAAKD,OAAOiG,QAAQC,OAAOC,KAAKvF,OAAS,GACnDoF,EAAY3C,KAAK,YAGrB,IAASiB,EAAI,EAAGA,EAAIrE,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAenD,OAAQ0D,IAAK,CAE9D,GAALA,GAAUrE,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAenD,OAAS,GAC7DoF,EAAY3C,KAAK,aAGrB2C,EAAY3C,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAeO,GAAI+B,EAAKzF,OAAS0D,EAAI+B,EAAK/B,GAAK+B,EAAK,KAEtH/B,GAAKrE,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAenD,OAAS,GAAKX,EAAKD,OAAOiG,QAAQC,OAAOnC,eAAenD,OAAS,GAChHoF,EAAY3C,KAAK,eAKzBpD,EAAKD,OAAOiG,QAAQC,OAAOC,KAAKvF,OAAS,GACzCoF,EAAY3C,KAAK,aAIzB,OAAOyC,EAAW9E,OAAOgF,IAG7B,MAAO,CACHa,iBAAkB,SAAUC,EAAMC,GAC9B,OAAO9G,EAAK+G,oBAAoBF,GAAMC,IAE1CE,cAAe,SAAUC,EAAMC,GAC3B,IAAIC,EAAW,wBACXA,EAASC,KAAKF,KACdA,EAAQA,EAAMG,QAAQF,EAAU,SAGpC,OAAID,EAAMI,WAAWpG,QAAQlB,EAAKD,OAAO4G,gBAAkB,EAChD,+FACgBM,EAAO,2BACZC,EAAMK,cAAcF,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,sHAGjEJ,EAAO,2BACZC,EAAMM,cAAcH,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,mCAGjF,oCACgBJ,EAAO,2BACZC,EAAMG,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,kCAGlFI,sBAAuB,SAAUR,EAAMC,GACnC,IAAIC,EAAW,sBACXA,EAASC,KAAKF,KACdA,EAAQA,EAAMG,QAAQF,EAAU,SAGpC,GAAID,EAAMI,WAAWpG,QAAQlB,EAAKD,OAAO4G,gBAAkB,EAAG,CAE1D,IAAIhB,EAAUuB,EAOd,MAAO,8EAEoBD,EAAO,yCAJlCtB,GADAA,GADAA,GADAA,GADAA,EAAUA,EAAQ0B,QAAQ,MAAO,gBACfA,QAAQ,MAAO,gBACfA,QAAQ,MAAO,gBACfA,QAAQ,MAAO,gBACfA,QAAQ,MAAO,oBAKMA,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,0FAMzF,MAAO,oCACgBJ,EAAO,2BACZC,EAAMG,QAAQ,OAAQ,QAAQA,QAAQ,OAAQ,QAAU,kCAIlFhB,cAAe,SAAUS,EAAcY,GACnC,IAAI/C,EAEAgD,EAAK3H,EAAK8E,OAAOkC,cAErB,GAAIhH,EAAK4H,cAAe,CAEpBD,EAAK3H,EAAK8E,OAAO2C,sBAEjB,IAAII,EAAQ,IAAIC,OAAO,KAAO9H,EAAKD,OAAO4G,cAAe,MACzDe,EAAgBA,EAAcL,QAAQQ,EAAO7H,EAAKD,OAAOgI,gBAG7D,GAAMjB,aAAwBpG,OAAmC,iBAAjBoG,EAwBzC,CAAA,GAAIA,aAAwBpG,OAASoG,EAAanG,OAAS,EAAG,CACjEgE,EAAI,WACJ,IAAShD,EAAI,EAAGA,EAAImF,EAAanG,OAAQgB,IACrCgD,GAAKgD,EAAGb,EAAanF,GAAGqB,OAAQ0E,GAGpC,OAAO/C,EAAK,YAEZ,OAAOgD,EAAIb,aAAwBpG,OAAiC,IAAxBoG,EAAanG,OAAemG,EAAa,GAAG9D,OAAS8D,EAAa9D,OAAS0E,GA/BvH,IAAIM,EAAI,GACR,IAAK,IAAIC,KAAOnB,EACZ,GAAKA,EAAamB,aAAgBvH,OAAUoG,EAAamB,GAAKtH,OAAS,EAAG,CACtEgE,EAAI,OACJ,IAAK,IAAIhD,EAAI,EAAGA,EAAImF,EAAamB,GAAKtH,OAAQgB,IAC1CgD,GAAKgD,EAAGb,EAAamB,GAAKtG,GAAGqB,OAAQ0E,GAGzC/C,GAAK,QACLqD,EAAE5E,KAAK,+CAAiDuB,EAAI,kBACzD,CACH,IAAIuD,EAAWpB,EAAamB,GACvBnB,EAAamB,aAAgBvH,OAAsC,GAA5BoG,EAAamB,GAAKtH,SAC1DuH,EAAWpB,EAAamB,GAAK,IAEjCD,EAAE5E,KAAK,mDACMuE,EAAGO,EAASlF,OAAQ0E,GAAiB,mBAK1D,OAAOM,EAAExF,KAAK,KAYtB2F,UAAW,SAAUzF,GACjB,IAAIiC,EAAI,CACRyD,QAAW,EACXJ,EAAM,IAIN,QAAQ,GACJ,KAAKhI,EAAKI,WAAab,GAAG0F,OAAOoD,WAAWC,OACxCC,EAAK,GACL,GAAMvI,EAAKD,OAAOiG,QAAc,SAAM,iBAAiBwC,KAAK9F,EAAK+F,KAAM,iBAAiBD,KAAK9F,EAAKgG,GAmB7F,CACG1I,EAAKD,OAAOiG,QAAQC,OACpBsC,EAAK3C,EAAmB2C,EAAI7F,EAAK+F,GAEjCF,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBC,eAAgBxG,EAAKD,OAAO4G,cAAgBjE,EAAK+F,EAAIzI,EAAKD,OAAO4G,gBAE5H4B,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBoC,gBAAiB3I,EAAKD,OAAO4G,cAAgBjE,EAAKgG,EAAI1I,EAAKD,OAAO4G,oBAzBtB,EAC/FiC,EAAQ,iBAAiBJ,KAAK9F,EAAK+F,IAGnCF,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBC,eAAgBxG,EAAKD,OAAO4G,cAAgBjE,EAAK+F,EAAEI,UAAU,EAAGnG,EAAK+F,EAAEvH,QAAQ0H,EAAM,KAAK5F,OAAShD,EAAKD,OAAO4G,gBAElK3G,EAAKD,OAAOiG,QAAQC,OACpBsC,EAAK3C,EAAmB2C,EAAI7F,EAAK+F,GAGjCF,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBC,eAAgBxG,EAAKD,OAAO4G,cAAgBjE,EAAK+F,EAAIzI,EAAKD,OAAO4G,iBAIhIiC,EAAQ,iBAAiBJ,KAAK9F,EAAKgG,IAE/BH,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBoC,gBAAiB3I,EAAKD,OAAO4G,cAAgBjE,EAAKgG,EAAEG,UAAU,EAAGnG,EAAKgG,EAAExH,QAAQ0H,EAAM,KAAK5F,OAAShD,EAAKD,OAAO4G,gBACtK4B,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBoC,gBAAiB3I,EAAKD,OAAO4G,cAAgBjE,EAAKgG,EAAI1I,EAAKD,OAAO4G,gBAWlI4B,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBuC,eAAgBpG,EAAK6B,EAAIvE,EAAKD,OAAO4G,gBAE5FhC,EAAEqD,EAAI,+DAAsEO,EAAG/F,KAAK,IAAM,0BAE1F,MACJ,KAAKxC,EAAKI,WAAab,GAAG0F,OAAOoD,WAAWU,OACxCR,EAAK,GAEL,GAAMvI,EAAKD,OAAOiG,QAAc,SAAM,iBAAiBwC,KAAK9F,EAAK+F,KAAM,iBAAiBD,KAAK9F,EAAKgG,GAiB3F,CAEC1I,EAAKD,OAAOiG,QAAQC,OACpBsC,EAAK3C,EAAmB2C,EAAI7F,EAAK+F,GAGjCF,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBC,eAAgBxG,EAAKD,OAAO4G,cAAgBjE,EAAK+F,EAAIzI,EAAKD,OAAO4G,gBAE5H4B,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBoC,gBAAiB3I,EAAKD,OAAO4G,cAAgBjE,EAAKgG,EAAI1I,EAAKD,OAAO4G,oBAzBtB,CACnG,IAAIiC,GAAAA,EAAQ,iBAAiBJ,KAAK9F,EAAK+F,IAEnCF,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBC,eAAgBxG,EAAKD,OAAO4G,cAAgBjE,EAAK+F,EAAEI,UAAU,EAAGnG,EAAK+F,EAAEvH,QAAQ0H,EAAM,KAAK5F,OAAShD,EAAKD,OAAO4G,gBAElK3G,EAAKD,OAAOiG,QAAQC,OACpBsC,EAAK3C,EAAmB2C,EAAI7F,EAAK+F,GAGjCF,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBC,eAAgBxG,EAAKD,OAAO4G,cAAgBjE,EAAK+F,EAAIzI,EAAKD,OAAO4G,iBAIhIiC,EAAQ,iBAAiBJ,KAAK9F,EAAKgG,IAE/BH,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBoC,gBAAiB3I,EAAKD,OAAO4G,cAAgBjE,EAAKgG,EAAEG,UAAU,EAAGnG,EAAKgG,EAAExH,QAAQ0H,EAAM,KAAK5F,OAAShD,EAAKD,OAAO4G,gBACtK4B,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBoC,gBAAiB3I,EAAKD,OAAO4G,cAAgBjE,EAAKgG,EAAI1I,EAAKD,OAAO4G,gBAWlIhC,EAAEqD,EAAI,+DAAsEO,EAAG/F,KAAK,IAAM,0BAC1F,MACJ,KAAKxC,EAAKI,WAAab,GAAG0F,OAAOoD,WAAWW,SACxCrE,EAAEqD,EAAIhI,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBC,eAAgBxG,EAAKD,OAAO4G,cAAgBjE,EAAK+F,EAAIzI,EAAKD,OAAO4G,eACtHhC,EAAEyD,QAAS,EACX,MACJ,KAAKpI,EAAKuG,gBAAgB7E,eAAe,mBACrC,IAAI6G,GAAAA,EAAK,IACNnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBC,eAAgBxG,EAAKD,OAAO4G,cAAgBjE,EAAK+F,EAAIzI,EAAKD,OAAO4G,gBACxH4B,EAAGnF,KAAKpD,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBoC,gBAAiB3I,EAAKD,OAAO4G,cAAgBjE,EAAKgG,EAAI1I,EAAKD,OAAO4G,gBACzHhC,EAAEqD,EAAI,+DAAsEO,EAAG/F,KAAK,IAAM,0BAC1F,MACJ,QACImC,EAAEqD,EAAI,sDAAwDhI,EAAK8E,OAAOuB,cAAcrG,EAAKuG,gBAAgBC,eAAgBxG,EAAKD,OAAO4G,cAAgBjE,EAAK+F,EAAIzI,EAAKD,OAAO4G,eAAiB,gBAIvM,OAAOhC,GAEXsE,UAAW,SAAUvG,GACjB,IAAIwG,EAAUlJ,EAAK8E,OAAOqD,UAAUzF,GAEhCyG,EAAS,CACTC,QAAS,aACTC,QAAS,MACTC,YAAa,IACbC,QAASvJ,EAAKwJ,QACdC,aAAczJ,EAAKgF,cAGnB5C,EAAepC,EAAKO,iBAAgB,GACxC,GAAM6B,aAAwB1B,MAEzB,CAED,IADA,IAAIgJ,EAAK,GACA/H,EAAI,EAAGA,EAAIS,EAAazB,OAAQgB,IACrC+H,EAAGtG,KAAKpD,EAAKwF,cACTxF,EAAKwF,cAAgB,IAAMpD,EAAaT,GAAGqB,OAC3CZ,EAAaT,GAAGqB,QAGxBmG,EAAOQ,SAAWD,EAAGlH,KAAK,UAT1B2G,EAAOQ,SAAW3J,EAAKwF,cAAgBxF,EAAKwF,cAAgB,IAAMpD,EAAaY,OAASZ,EAAaY,OAYzG,IAAI4G,EAAiB,SAAUjG,GAC3B,GAA2B,MAAtBA,GAAc,IAAY,CAC3B,GAAMA,aAAsBjD,MAcxB,OAAOiD,EAAWnB,KAAK,KAbvB,IAAI+B,EAAI,GACR,GAAIZ,aAAsBkG,OACtB,IAAK,IAAI5B,KAAOtE,EAAY,CACxB,IAAImG,EAAOnG,EAAWsE,GAAK,GACvBtE,EAAWsE,GAAKtH,OAAS,IACzBmJ,EAAOnG,EAAWsE,GAAKzF,KAAK,MAEhC+B,EAAEnB,KAAK0G,GAGf,OAAOvF,IAMfwF,EAAcH,EAAe5J,EAAK4D,kBAClCoG,EAAOJ,EAAe5J,EAAK8D,gBAE/B,MAAMmG,EAAoBC,IACtB,MAAMC,EAAMD,EAAQhG,MAAM,KAC1B,OAAOiG,EAAIrF,OAAO,CAACsB,EAAMzE,IACbwI,EAAIjJ,QAAQkF,KAAUzE,GAC/Ba,KAAK,MAGZ,GAAIuH,aAAuBrJ,OAASsJ,aAAgBtJ,MAAO,CACvDyI,EAAOiB,aAAe,GACtB,IAASzI,EAAI,EAAGA,EAAIoI,EAAYpJ,OAAQgB,IACpCwH,EAAOiB,cAAgB,IAAMH,EAAiBF,EAAYpI,GAAK,IAAMqI,EAAKrI,IAAM,SAGpFwH,EAAOiB,aAAeH,EAAiBF,EAAc,IAAMC,GAG/Db,EAAOkB,OAASnB,EAAQlB,EAExB,OAAOzI,GAAGW,KAAKoK,eAAenB,IAElCoB,cAAe,SAAUtJ,GACrB,IAAIuJ,EAAQ,GACRC,EAAMxJ,EAAGiD,MAAM,KAEfwG,EAAS1K,EAAK8D,eACdG,EAAYjE,EAAKO,kBAErB,GAAImK,GAAUzG,EAEV,GAAIhD,EAAGC,QAAQ,MAAQ,GAAK+C,aAAqBvD,OAASuD,EAAUtD,OAAS,EACzE,IAAK,IAAIgB,EAAI,EAAGA,EAAIsC,EAAUtD,OAAQgB,IAElC,IAAK,IAAI0C,EAAI,EAAGA,EAAIqG,EAAOzG,EAAUtC,IAAIhB,OAAQ0D,IAC7CmG,EAAMpH,KAAK,CAAE6D,KAAMyD,EAAOzG,EAAUtC,IAAI0C,GAAI6C,MAAOuD,EAAIpG,UAG5D,IAAwB,GAApBpD,EAAGC,QAAQ,MAAc+C,aAAqBvD,MACrD,CAAA,IAAIiK,EAAMD,EAEV,IAAS/I,EAAI,EAAGA,EAAIsC,EAAUtD,OAAQgB,IAClC,IAAK6I,EAAM9I,eAAeuC,EAAUtC,IAAK,CAEjCgJ,aAAed,QAAUa,EAAOhJ,eAAeuC,EAAUtC,MACzDgJ,EAAMD,EAAOzG,EAAUtC,KAE3B,IAAS0C,EAAI,EAAGA,EAAIsG,EAAIhK,OAAQ0D,IACxBA,EAAIoG,EAAI9J,QACR6J,EAAMpH,KAAK,CAAE6D,KAAM0D,EAAItG,GAAI6C,MAAOuD,EAAIpG,UAKrD,CACGqG,aAAkBb,QAAUa,EAAOhJ,eAAeuC,KAClDyG,EAASA,EAAOzG,IAGpB,IAAStC,EAAI,EAAGA,EAAI+I,EAAO/J,OAAQgB,IAC/B6I,EAAMpH,KAAK,CAAE6D,KAAMyD,EAAO/I,GAAIuF,MAAOuD,EAAI9I,KAKrD,OAAO3B,EAAK8E,OAAO8F,gBAAgBJ,IAEvCI,gBAAiB,SAAUjH,GAGlBpE,GAAGuF,QACJvF,GAAGG,WAAWH,GAAGI,YAAc,aAGnC,GAAIgE,GAAcA,aAAsBjD,MAAO,CAC3C,IAAIwI,EAAUvF,EAAWtB,IAAI,SAAUC,GACnC,IAAIA,EAAIZ,eAAe,QAOnB,OAAO,IAAInC,GAAGuF,OAAO+F,QAAQvI,EAAI2E,KAAM3E,EAAI4E,OAN3C,QAAQ,GACJ,KAAK5E,EAAIzC,MAAQN,GAAG0F,OAAO6F,WAAWC,SAClC,OAAO,IAAIxL,GAAGuF,OAAO+F,QAAQvI,EAAI2E,KAAM3E,EAAI4E,UAQ3D,OAAIgC,EAAQvI,OAAS,EACVpB,GAAGuF,OAAOkG,IAAIC,MAAM,KAAM/B,GAE1BA,EAAQ,MA5YrB,CAiZXlJ,IAGPT,GAAGC,QAAQ0L,OAAS,WAChB,IAAIlL,EAAOV,KACXC,GAAGE,QAAQwL,MAAMjL,EAAMmL,WAEvBnL,EAAKoL,cAAe,EAEpB7L,GAAG0F,OAAOoG,MAAMC,WAAa/L,GAAG0F,OAAOoG,MAAMC,YAAc,gBAE3DtL,EAAKuL,IAAM,6BACXvL,EAAKwJ,QAAU,QACfxJ,EAAKwF,cAAgB,QAEjBxF,EAAKF,SAAWE,EAAKF,QAAQyL,MAC7BvL,EAAKuL,IAAMvL,EAAKF,QAAQyL,KAG5BvL,EAAK2G,cAAgB,IACrB3G,EAAK+H,eAAiB,KAEtB/H,EAAKwL,KAAO,IACZxL,EAAKyL,KAAO,IACZzL,EAAK0L,IAAM,MACX1L,EAAK2L,IAAM,MAEX3L,EAAK4L,WAAa,MAClB5L,EAAK6L,WAAa,MAClB7L,EAAK8L,UAAY,QACjB9L,EAAK+L,UAAY,QAEjB/L,EAAKgM,IAAM,MACXhM,EAAKiM,IAAM,MACXjM,EAAKkM,IAAM,MAEXlM,EAAKmM,UAAY,QACjBnM,EAAKoM,UAAY,QACjBpM,EAAKqM,UAAY,QAEjBrM,EAAKsM,qBAAuB,GAE5BtM,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWkE,WAAa,CACxDC,eAAgB,KAChBjB,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdC,aAAc,EACdjM,YAAa,CAAC,yBAA0B,0BAA2B,2BACnEkM,aAAc,CACVlM,YAAa,uBACbmM,cAAe,YACfC,WAAY,cAEhBtG,gBAAiB,CACbC,eAAgB,aAChBmC,gBAAiB,WACjBG,eAAgB,WAEpB9G,mBAAoB,CAChBD,MAAO,wBACPH,MAAO,CACH,CACIkL,uBAAwB,CACpB7K,MAAO,8BACPL,MAAO,CACHL,SAAU,UACVD,IAAK,iBAIjB,CACIyL,wBAAyB,CACrB9K,MAAO,+BACPL,MAAO,CACHL,SAAU,UACVD,IAAK,iBAIjB,CACI0L,wBAAyB,CACrB/K,MAAO,8BACPL,MAAO,CACHL,SAAU,UACVD,IAAK,mBAMzBF,OAAQ,CACJ,CACI6L,QAAS,CACLC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,IAGvB,CACIL,QAAS,CACLC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,IAGvB,CACIL,QAAS,CACLC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,KAI3BjI,OAAQrF,EAAKuN,gBACbC,KAAMxN,EAAKyN,iBACXC,aAAc1N,EAAKgM,IAAM,MAAQhM,EAAKiM,IAAM,MAAQjM,EAAKkM,IAAM,MAC/DyB,uBAAwB,KAG5B3N,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWuF,aAAe,CAC1DvI,OAAQrF,EAAK6N,eACbL,KAAMxN,EAAK8N,gBACXpB,aAAc,EACd3K,MAAO,KACPC,mBAAoB,SAAUyC,GAC1B,MAAO,CACH1C,MAAO/B,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWuF,aAAa7L,OAAS/B,EAAKkC,gBAAgB,8BAK7GlC,EAAKuG,gBAAkB,CACnBwH,UAAW,YACXC,MAAO,QACPC,OAAQ,SACRC,MAAO,SAGXlO,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAW8F,cAAgB,CAC3DjI,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BoG,IAAK,6BACL/F,cAAe,QACfiH,aAAc,WACdhM,YAAa,uBACbqD,eAAgB,CAAC,cACjByC,gBAAiB,CACbC,eAAgB,CAAC,WAAY,cAEjCxE,mBAAoB,CAChBD,MAAO,2BACPH,MAAO,eAEXgC,iBAAkB,CAAC,aACnBI,kBAAmB,MACnB0I,aAAc,EACdtL,OAAQ,CACJ,CACI6L,QAAS,CACLC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,KAI3BjI,OAAQrF,EAAKoO,iBAAiBC,KAAK/O,KAAM,CAACC,GAAG0F,OAAOoD,WAAW8F,eAC/DG,qBAAsBtO,EAAKuO,yBAAyBC,OACpDhB,KAAMxN,EAAKyO,mBA4DfzO,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWqG,SAAW,CACtDxI,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,qBACbK,kBAAmB,GACnBgD,eAAgB,CAAC,aAAc,YAC/ByC,gBAAiB,CACbC,eAAgB,CAAC,YAErB5C,iBAAkB,CAAC,YAAa,WAChCI,kBAAmB,YACnB0I,aAAc,EACdrH,OAAQrF,EAAKoO,iBAAiBC,KAAK/O,KAAM,CAACC,GAAG0F,OAAOoD,WAAWqG,UAC/DJ,qBAAsBtO,EAAKuO,yBAAyBC,OACpDhB,KAAMxN,EAAKyO,kBACXd,uBAAwB,IACxB3L,mBAAoB,CAChBD,MAAO,sBACPH,MAAO,eAEXR,OAAQ,CACJ,CACI6L,QAAS,CACLC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,MAM/BtN,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWU,QAAU,CACrD7C,KAAM,KACNC,MAAO,KACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACd3L,kBAAmB,mBACnBL,YAAa,sBACbqD,eAAgB,CAAC,QACjB4I,aAAc,EACdnG,gBAAiB,CACbC,eAAgB,CAAC,WAAY,YAC7BmC,gBAAiB,CAAC,MAAO,YAE7B3G,mBAAoB,CAChBD,MAAO,qBACPH,MAAO,eAEXgC,iBAAkB,CAAC,WAAY,MAAO,OAAQ,YAAa,cAC3DI,kBAAmB,WACnB5C,OAAQ,CACJ,CACIuN,KAAM,CACFvB,YAAa,UACbE,cAAe,EACfD,YAAa,EACbuB,cAAe,QACfC,gBAAiB,UAGzB,CACIC,MAAO,CACH/M,MAAO,MACPgN,MAAO,WACPC,UAAW,UACXC,SAAU,GACVC,WAAY,OACZC,kBAAmB,UACnBC,kBAAmB,KAI/B/J,OAAQrF,EAAKoO,iBAAiBC,KAAK/O,KAAM,CAACC,GAAG0F,OAAOoD,WAAWU,SAC/DyE,KAAMxN,EAAKyO,mBAGfzO,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWC,QAAU,CACrDpC,KAAM,KACNC,MAAO,KACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,oBACbK,kBAAmB,GACnB4L,aAAc,EACd5I,eAAgB,CAAC,aAAc,YAAa,OAAQ,UACpDyC,gBAAiB,CACbC,eAAgB,CAAC,WAAY,YAC7BmC,gBAAiB,CAAC,MAAO,WACzBG,eAAgB,CAAC,WAErB9G,mBAAoB,CAChBD,MAAO,qBACPH,MAAO,aAEXgC,iBAAkB,CAAC,WAAY,MAAO,SAAU,OAAQ,YAAa,cACrEI,kBAAmB,eACnB5C,OAAQ,CACJ,CACI0N,MAAO,CACHO,OAAQ,EACRtN,MAAO,SACPgN,MAAO,WACPC,UAAW,UACXC,SAAU,GACVE,kBAAmB,UACnBC,kBAAmB,KAI/B/J,OAAQrF,EAAKoO,iBAAiBC,KAAK/O,KAAM,CAACC,GAAG0F,OAAOoD,WAAWC,SAC/DkF,KAAMxN,EAAKyO,mBAGfzO,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWiH,OAAS,CACpDpJ,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,wBACbK,kBAAmB,GACnBgD,eAAgB,CAAC,aAAc,YAC/B6J,uBAAwB,IACxBpH,gBAAiB,CACbC,eAAgB,CAAC,WAAY,YAEjCxE,mBAAoB,CAChBD,MAAO,oBACPH,MAAO,eAEXgC,iBAAkB,CAAC,YAAa,WAChCI,kBAAmB,YACnB0I,aAAc,EACdtL,OAAQ,CACJ,CACI6L,QAAS,CACLC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,KAI3BjI,OAAQrF,EAAKoO,iBAAiBC,KAAK/O,KAAM,CAACC,GAAG0F,OAAOoD,WAAWiH,QAC/DhB,qBAAsBtO,EAAKuO,yBAAyBC,OACpDhB,KAAMxN,EAAKyO,mBAGfzO,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWkH,WAAa,CACxDrJ,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,uBACbK,kBAAmB,GACnBgD,eAAgB,CAAC,aAAc,aAC/B6J,uBAAwB,IACxBpH,gBAAiB,CACbC,eAAgB,CAAC,WAAY,eAEjCxE,mBAAoB,CAChBD,MAAO,wBACPH,MAAO,aAEXgC,iBAAkB,CAAC,YAAa,WAAY,aAAc,aAC1DI,kBAAmB,YACnB0I,aAAc,EAEdtL,OAAQ,CACJ,CACI0N,MAAO,CACHO,OAAQ,EACRtN,MAAO,WACPgN,MAAO,WACPC,UAAW,UACXC,SAAU,GACVE,kBAAmB,UACnBC,kBAAmB,KAI/B/J,OAAQrF,EAAKoO,iBAAiBC,KAAK/O,KAAM,CAACC,GAAG0F,OAAOoD,WAAWkH,YAC/DjB,qBAAsBtO,EAAKuO,yBAAyBC,OACpDhB,KAAMxN,EAAKyO,mBAGfzO,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWmH,uBAAyB,CACpEtJ,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,uBACbK,kBAAmB,GACnBgD,eAAgB,CAAC,aAAc,aAC/B6J,uBAAwB,IACxBpH,gBAAiB,CACbC,eAAgB,CAAC,YAAa,YAC9BmC,gBAAiB,CAAC,WAAY,eAElC3G,mBAAoB,CAChBD,MAAO,wBACPH,MAAO,aAEXgC,iBAAkB,CAAC,YAAa,WAAY,aAAc,aAC1DI,kBAAmB,YACnB0I,aAAc,EAEdtL,OAAQ,CACJ,CACI0N,MAAO,CACHO,OAAQ,EACRtN,MAAO,WACPgN,MAAO,WACPC,UAAW,UACXC,SAAU,GACVE,kBAAmB,UACnBC,kBAAmB,KAI/B/J,OAAQrF,EAAKoO,iBAAiBC,KAAK/O,KAAM,CAACC,GAAG0F,OAAOoD,WAAWmH,wBAC/DhC,KAAMxN,EAAKyO,mBAGfzO,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWoH,cAAgB,CAC3DvJ,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,CAAC,wBACdK,kBAAmB,GACnBgD,eAAgB,CAAC,cACjByC,gBAAiB,CACbC,eAAgB,CAAC,eAErB5C,iBAAkB,CAAC,cACnBI,kBAAmB,MACnB0I,aAAc,EACdtL,OAAQ,CACJ,CACI6L,QAAS,CACLC,UAAW,UACXC,YAAa,GACbC,YAAa,UACbC,YAAa,EACbC,cAAe,MAM/BtN,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWqH,MAAQ,CACnDxJ,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,qBACbqD,eAAgB,CAAC,cACjByC,gBAAiB,CACbC,eAAgB,CAAC,eAErBxE,mBAAoB,CAChBD,MAAO,mBACPH,MAAO,eAEXgC,iBAAkB,CAAC,cACnBI,kBAAmBhE,EAAKkC,gBAAgB,4BAA8B,QACtEwK,aAAc,GACdtL,OAAQ,CACJ,CACI6L,QAAS,CACLG,YAAa,UACbE,cAAe,EACfD,YAAa,GAEjBsB,KAAM,CACFvB,YAAa,UACbE,cAAe,EACfD,YAAa,EACbuB,cAAe,QACfC,gBAAiB,WAI7BxJ,OAAQrF,EAAK2P,QACbnC,KAAMxN,EAAK4P,SACXjK,QAAS,WACL,OAAO,IAAImC,OAAO,UAAY9H,EAAKkC,gBAAgB,oBAAsB,IAAMlC,EAAKkC,gBAAgB,4BAA8B,qGAAsG,OAIhPlC,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWwH,QAAU,CACrD3J,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,oBACbqD,eAAgB,CAAC,aAAc,OAC/ByC,gBAAiB,CACbC,eAAgB,CAAC,cACjBmC,gBAAiB,CAAC,OAEtB3G,mBAAoB,CAChBD,MAAO,wBACPH,MAAO,aAEXgC,iBAAkB,CAAC,aAAc,MACjCI,kBAAmBhE,EAAKkC,gBAAgB,4BAA8B,SAAWlC,EAAKkC,gBAAgB,kBAAoB,QAC1HwK,aAAc,GACdtL,OAAQ,CACJ,CACI0N,MAAO,CACH/M,MAAO,CAAC,aAAc,MACtBiN,UAAW,UACXC,SAAU,GACVE,kBAAmB,UACnBC,kBAAmB,KAI/B/J,OAAQrF,EAAK8P,MACbtC,KAAMxN,EAAK+P,OACXpK,QAAS,WACL,OAAO,IAAImC,OAAO,UAAY9H,EAAKkC,gBAAgB,oBAAsB,IAAMlC,EAAKkC,gBAAgB,4BAA8B,sHAAwHlC,EAAKkC,gBAAgB,kBAAoB,qEAAsE,OAIjXlC,EAAKgG,QAAU,GACfhG,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAgB,CAC9CjI,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,uBACbqD,eAAgB,CAAC,cACjByC,gBAAiB,CACbC,eAAgB,CAAC,cAErB5C,iBAAkB,CAAC,aACnBI,kBAAmB,MACnBgM,aAAc,WACV,OAAO,IAAIC,QAAQ,SAAUC,EAASC,GAElC,GAAInQ,EAAKgG,QAAQC,SAAWjG,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAciC,UAAW,CAEnF,IAAIjH,EAAS,CACbE,QAAiB,OACjBF,EAAOI,QAAUvJ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAc3E,QACjEL,EAAOC,QAAU,aACjBD,EAAOQ,SAAW3J,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAc3I,cAAgB,IAAMxF,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAc1N,YACxI0I,EAAOM,aAAezJ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAcnJ,aACtEmE,EAAOiB,aAAe,CAAC,cAAcrJ,OAAOf,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAcvK,kBAAkBpB,KAAK,KAEnH2G,EAAOkH,WAAarQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAcjI,KAAK7D,IAAI,SAAUiO,GACnF,MAAO,CAAC,cAAcjO,IAAI,SAAUpB,EAAIyF,GACpC,OAAOzF,EAAK,IAAMqP,EAAK5J,KACxBlE,KAAK,WAGZ2G,EAAOkH,WAAalH,EAAOkH,WAAW7N,KAAK,QAE3CjD,GAAGgR,KAAK,CACJhF,IAAKvL,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAc5C,IAAM,IAAMhM,GAAGW,KAAKoK,eAAenB,GACxFqH,OAAQ,MACRC,aAAclR,GAAG0F,OAAOyL,SAASvL,OAClCwL,KAAK,SAAUC,GACd,MAAMlO,EAAOkO,EAASlO,KACtB,GAAIA,EAAKmO,cAAgB,EAAG,CAExB7Q,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAciC,UAAY1N,EAAKoO,SAASzO,IAAI,SAAUkB,GACpF,MAAO,CACHtC,GAAI,CAAC,cAAcoB,IAAI,SAAUiO,GAC7B,OAAO/M,EAAQI,WAAW2M,KAC3B9N,KAAK,KACRT,MAAOwB,EAAQI,WAAW3D,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAcvK,iBAAiB,IAAI2D,iBAIvG2I,EAAQlQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAciC,eAErD,CACHpQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAciC,UAAY,GAC5DF,EAAQlQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAciC,cAE7DW,MAAM,WACLb,EAAQ,WAIZA,EAAQlQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAW8F,cAAciC,eAKxEpQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAY,CAC1C9C,KAAM,KACNC,OAAO,EACPoF,IAAKvL,EAAKuL,KAAO,6BACjB/B,QAASxJ,EAAKwJ,SAAW,QACzBxE,aAAczF,GAAG0F,OAAOC,OAAOC,KAC/BK,cAAexF,EAAKwF,eAAiB,QACrCiH,aAAc,WACdhM,YAAa,CAAC,yBACdK,kBAAmB,GACnBgD,eAAgB,CAAC,aAAc,aAC/ByC,gBAAiB,CACbC,eAAgB,CAAC,aAErB5C,iBAAkB,CAAC,YACnBoM,aAAc,WACV,OAAO,IAAIC,QAAQ,SAAUC,EAASC,GAClC,GAAInQ,EAAKgG,QAAQC,SAAWjG,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUoH,UAAW,CAE/E,IAAIjH,EAAS,CACbE,QAAiB,OACjBF,EAAOI,QAAUvJ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUQ,QAC7DL,EAAOC,QAAU,aACjBD,EAAOQ,SAAW3J,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUxD,cAAgB,IAAMxF,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUvI,YAChI0I,EAAOM,aAAezJ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUhE,aAClEmE,EAAOiB,aAAe,CAAC,aAAc,YAAYrJ,OAAOf,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUpF,kBAAkBpB,KAAK,KAE3H2G,EAAOkH,WAAarQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAU9C,KAAK7D,IAAI,SAAUiO,GAC/E,MAAO,CAAC,aAAc,YAAYjO,IAAI,SAAUpB,EAAIyF,GAChD,OAAOzF,EAAK,IAAMqP,EAAK5J,KACxBlE,KAAK,WAGZ2G,EAAOkH,WAAalH,EAAOkH,WAAW7N,KAAK,QAE3CjD,GAAGgR,KAAK,CACJhF,IAAKvL,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUuC,IAAM,IAAMhM,GAAGW,KAAKoK,eAAenB,GACpFqH,OAAQ,MACRC,aAAclR,GAAG0F,OAAOyL,SAASvL,OAClCwL,KAAK,SAAUC,GACd,MAAMlO,EAAOkO,EAASlO,KACtB,GAAIA,EAAKmO,cAAgB,EAAG,CAExB7Q,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUoH,UAAY1N,EAAKoO,SAASzO,IAAI,SAAUkB,GAChF,MAAO,CACHtC,GAAI,CAAC,aAAc,YAAYoB,IAAI,SAAUiO,GACzC,OAAO/M,EAAQI,WAAW2M,KAC3B9N,KAAK,KACRT,MAAOwB,EAAQI,WAAW3D,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUpF,iBAAiB,IAAI2D,iBAInG2I,EAAQlQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUoH,eAEjD,CACHpQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUoH,UAAY,GACxDF,EAAQlQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUoH,cAEzDW,MAAM,WACLb,EAAQ,WAIZA,EAAQlQ,EAAKgG,QAAQzG,GAAG0F,OAAOoD,WAAWW,UAAUoH,eAMpEpQ,EAAKgR,mBAAqB,GAE1B,GAAIhR,EAAKF,QAAQkR,mBACb,IAAK,IAAIC,KAAWjR,EAAKF,QAAQkR,mBAAoB,CAEjD,GAAIhR,EAAKsM,qBAAqB2E,KAAa1R,GAAGW,KAAKgR,cAAclR,EAAKF,QAAQkR,mBAAmBC,IAAW,CAKxG,GAAIjR,EAAKsM,qBAAqB2E,GAASnQ,mBAAqBd,EAAKsM,qBAAqB2E,GAASnQ,kBAAkBH,OAAS,GACtHX,EAAKF,QAAQkR,mBAAmBC,GAASxQ,cAAgBT,EAAKF,QAAQkR,mBAAmBC,GAASnQ,kBAAmB,QAE9Gd,EAAKsM,qBAAqB2E,GAASnQ,kBAC1Cd,EAAKsM,qBAAqB2E,GAAS7P,OAASpB,EAAKsM,qBAAqB2E,GAAS7P,OAAO+C,MAAM,EAAGnE,EAAKsM,qBAAqB2E,GAAS7P,OAAOT,OAAS,GAItJpB,GAAGW,KAAKC,OAAOH,EAAKsM,qBAAqB2E,GAAUjR,EAAKF,QAAQkR,mBAAmBC,IAInF,GAAIjR,EAAKF,QAAQkR,mBAAmBC,GAAS/K,MACxC+K,GAAW1R,GAAG0F,OAAOoD,WAAW8F,cAAgBnO,EAAKF,QAAQkR,mBAAmBC,GAASE,UAAY5R,GAAG0F,OAAOoD,WAAW8F,cAC1H8C,GAAW1R,GAAG0F,OAAOoD,WAAWW,UAAYhJ,EAAKF,QAAQkR,mBAAmBC,GAASE,UAAY5R,GAAG0F,OAAOoD,WAAWW,SAAW,CAElIhJ,EAAKgG,QAAQC,OAASjG,EAAKgG,QAAQhG,EAAKF,QAAQkR,mBAAmBC,GAASE,UAC5EnR,EAAKgG,QAAQC,OAAOC,KAAOlG,EAAKF,QAAQkR,mBAAmBC,GAAS/K,KACpElG,EAAKgG,QAAQC,OAAOE,MAAQnG,EAAKF,QAAQkR,mBAAmBC,GAAS9K,MAErEnG,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWU,QAAQxC,gBAAgBC,eACnExG,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWC,QAAQ/B,gBAAgBC,eACvExG,EAAKgG,QAAQC,OAAOnC,gBAK3B9D,EAAKF,QAAQkR,mBAAmBC,GAGjCjR,EAAKoR,qBAAqBH,EAASjR,EAAKsM,qBAAqB2E,GAAWjR,EAAKsM,qBAAqB2E,GAAWjR,EAAKF,QAAQkR,mBAAmBC,GAAUjR,UAFhJA,EAAKF,QAAQkR,mBAAmBC,GAO/CjR,EAAKgG,QAAQC,QACbjG,EAAKgG,QAAQC,OAAO+J,eAGxBhQ,EAAKqR,kBAAoBrR,EAAKF,QAAQuR,oBAAqB,EAE3DrR,EAAKsR,SAAW,EAChBtR,EAAKuR,SAAW,EAEhBvR,EAAKoF,KAAO,IAAI7F,GAAG6F,KAAK5F,QAAQ0L,OAAOlL,GAEvCA,EAAKwR,SAAW,IAEhBxR,EAAKyR,gBAAkB,CACnBC,aAAc,oEACdC,iBAAkB,qCAClBC,SAAU,uCAIlBrS,GAAGsS,QAAQtS,GAAGC,QAAQ0L,OAAQ3L,GAAGE,UAEjC,WACI,IAAIqS,EAAWvS,GAAGC,QAAQ0L,OAAO6G,UAEjCD,EAASE,MAAQ,gBAEjBzS,GAAG0F,OAAOoG,MAAM4G,iBAAmB1S,GAAG0F,OAAOoG,MAAM4G,kBAAoB,sBAEvEH,EAASI,SAAW,WAAWC,KAAKC,SAASN,EAASE,MAAMK,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,aAAaF,EAAE,wGAA+GC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,uBAAuBF,EAAE,aAAeC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,wBAAwBF,EAAE,uBAAyBC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,wBAAwBF,EAAE,2CAA8CC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,aAAaF,EAAE,iEAAoEH,EAAOM,YAAW,EAAG,OAAON,GAE1nBP,EAASM,SAAW,SAAU/P,GAC1B,MAAMrC,EAAOV,KACPsT,EAASrT,GAAGE,QAAQsS,UAAUK,SAASjQ,KAAKnC,EAAMqC,GAExDrC,EAAK6S,QAAU,CACXnQ,KAAM,IAGV1C,EAAK8S,aAAgB,WACjB,SAASC,EAAeC,GACpB,OAAOA,EAAU9R,QAAQ,MAAQ,EAAI8R,EAAU9O,MAAM,KAAK,GAAK8O,EAEnE,SAASC,EAASpO,EAAUtD,EAAUN,GAElC,IAAIpB,EAAOG,EAAKkT,uBAAuBjS,GACvC,GAAIpB,EAAM,CACN,IAAI4B,EAAQ5B,EAAKsB,sBAAsB4R,EAAe9R,IAEtD,GAAIQ,GAASA,EAAMC,eAAeH,GAC9B,OAAOE,EAAMF,GAAUsD,GAI/B,OAAOtF,GAAG4T,IAAI/R,OAAOG,GAAUsD,GAGnC,OAAO,SAAUtD,EAAUsD,EAAUuO,EAAcpL,IAG3CzI,GAAG8T,SAAarL,aAAazI,GAAG8T,SAFzB/T,KAGF+C,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAMkI,YAAa,CAAEC,MAHzClU,KAGqDkU,MAAOC,KAAMzL,EAAEyL,OAG/E,IAAI3J,EAAOmJ,EAASpO,EAAUtD,EAAUwR,EAAe/K,EAAE/G,KACzD,GAAImS,EAAc,CACd,GAAItJ,aAAgBpJ,MAAO,CACvB,IAAIgT,EAAS5J,EAAKzH,IAAI,SAAUkC,GAC5B,OAAOyD,EAAE2L,UAAUjS,eAAe6C,GAAKyD,EAAE2L,UAAUpP,GAAK,KAExD8D,EAAa/I,KAAK4T,uBAAuBH,EAAe/K,EAAE/G,KAC9D,OAAIoH,EACOA,EAAWrE,kBAAkBQ,SAASkP,GAEtCA,EAAOlR,KAAK,KAGvB,OAAOwF,EAAE2L,UAAUjS,eAAeoI,GAAQ9B,EAAE2L,UAAU7J,GAAQ,GAIlE,OAAOA,GA1CC,GA+CpB,IAAI8J,EAAU5T,EAAK8S,aAEnB9S,EAAK6T,aAAexR,EAAIyR,SAAS,CAC7B7S,GAAIjB,EAAK+T,SACT9R,MAAO,eACP+R,MAAOhU,EACPiU,SAAS,EACTC,WAAW,EACXrU,KAAMN,GAAG0F,OAAOkP,UAAUC,OAC1BhT,OAAQ,CACJ6L,QAAS,CACLC,UAAW0G,EAAQvF,KAAKrO,EAAM,UAAW,aAAa,GACtDmN,YAAayG,EAAQvF,KAAKrO,EAAM,UAAW,eAAe,GAC1DoN,YAAawG,EAAQvF,KAAKrO,EAAM,UAAW,eAAe,GAC1DsN,cAAesG,EAAQvF,KAAKrO,EAAM,UAAW,iBAAiB,GAC9DqN,YAAauG,EAAQvF,KAAKrO,EAAM,UAAW,eAAe,IAE9D2O,KAAM,CACFvB,YAAawG,EAAQvF,KAAKrO,EAAM,OAAQ,eAAe,GACvDsN,cAAesG,EAAQvF,KAAKrO,EAAM,OAAQ,iBAAiB,GAC3DqN,YAAauG,EAAQvF,KAAKrO,EAAM,OAAQ,eAAe,IAE3DqU,OAAQ,CACJC,OAAQ/U,GAAGgV,SAASnT,OAAOiT,OAAOC,OAClCE,OAAQjV,GAAGgV,SAASnT,OAAOiT,OAAOG,OAClCC,MAAOlV,GAAGgV,SAASnT,OAAOiT,OAAOI,OAErC3F,MAAO,CACHO,OAAQuE,EAAQvF,KAAKrO,EAAM,QAAS,UAAU,GAC9CwU,OAAQZ,EAAQvF,KAAKrO,EAAM,QAAS,UAAU,GAC9CyU,MAAOb,EAAQvF,KAAKrO,EAAM,QAAS,SAAS,GAC5CkN,UAAW0G,EAAQvF,KAAKrO,EAAM,QAAS,aAAa,GACpDmN,YAAayG,EAAQvF,KAAKrO,EAAM,QAAS,eAAe,GACxDoN,YAAawG,EAAQvF,KAAKrO,EAAM,QAAS,eAAe,GACxDqN,YAAauG,EAAQvF,KAAKrO,EAAM,QAAS,eAAe,GACxDiP,SAAU2E,EAAQvF,KAAKrO,EAAM,QAAS,YAAY,GAClDgP,UAAW4E,EAAQvF,KAAKrO,EAAM,QAAS,aAAa,GACpDmP,kBAAmByE,EAAQvF,KAAKrO,EAAM,QAAS,qBAAqB,GACpEoP,kBAAmBwE,EAAQvF,KAAKrO,EAAM,QAAS,qBAAqB,GACpE+B,MAAO6R,EAAQvF,KAAKrO,EAAM,QAAS,SAAS,GAC5C+O,MAAO6E,EAAQvF,KAAKrO,EAAM,QAAS,SAAS,OAInD2Q,KAAK,SAAU6C,GACZxT,EAAKwT,MAAQA,EACb,OAAOA,IAGfxT,EAAK0U,oBAAsB1U,EAAKkC,gBAAgB,aAChDlC,EAAK2U,oBAAsB3U,EAAKkC,gBAAgB,kBAChDlC,EAAK4U,aAAe5U,EAAKkC,gBAAgB,mBAEzClC,EAAK6U,eAAiB,CAAC,MAAO,UAAW,eAAgB,gBAAiB,cAAe,aAAc,gBAEvG,OAAOjC,GAGX,MAAMkC,EAAe,SAAUxS,GAC3B,MAAMtC,EAAOV,KAEKgD,EAAIP,MAAtB,IACIgT,EAAS,GAI0B,IAAnC/U,EAAKgV,YAAYhS,OAAOrC,QAAgBX,EAAKiV,UAAU/N,MAAMlE,OAAOrC,OAAS,IAC7EX,EAAKgV,YAAchV,EAAKiV,UAAU/N,MAAMlE,QAG5C,IAAIkS,EAAwBlV,EAAKgV,YAO7BG,EAAS,GACTC,EAAgB,KACiC,IAPjDF,EADAlV,EAAKyR,gBAAgBC,aAAatK,KAAK8N,GACfA,EAAsB7N,QAAQrH,EAAKyR,gBAAgBE,iBAAkB,IAErEuD,EAAsB7N,QAAQrH,EAAKyR,gBAAgBG,SAAU,KAK/D1Q,QAAQkU,KAC9BA,EAAgB,KAGpBD,EAASD,EAAsBlS,OAAOkB,MAAMkR,GAG5C,GAAK9S,EAAIP,MAAMb,QAAQlB,EAAK+L,YAAc,GAAKzJ,EAAIP,MAAMb,QAAQlB,EAAK8L,YAAc,GAC/ExJ,EAAIP,MAAMb,QAAQlB,EAAK4L,aAAe,GAAKtJ,EAAIP,MAAMb,QAAQlB,EAAK6L,aAAe,EAAI,CACtFsJ,EAASnV,EAAKgV,YAAY9Q,MAAM,KAEhC,IAAK,IAAIuE,EAAI,EAAGA,EAAI0M,EAAOxU,OAAQ8H,IACG,KAA9B0M,EAAO1M,GAAGzF,OAAOmB,OAAO,KACxBgR,EAAO1M,GAAK0M,EAAO1M,GAAGtE,MAAM,GAAI,IAI5C,IAAK,IAAIkR,EAAI,EAAGA,EAAIF,EAAOxU,OAAQ0U,IAC/B,GAAIF,EAAOE,GAAGrS,OAAOrC,OAAS,EAAG,CAC7BoU,EAAO3R,KAAK,IAAM+R,EAAOE,GAAGrS,OAAOqE,QAAQ,OAAQ,IAAIA,QAAQ,OAAQ,IAAM,KAE7E,GADIuB,EAAQ,uBAAuBJ,KAAK2M,EAAOE,GAAGrS,QAG9C,IADA,IAAIsS,EAAUH,EAAOE,GAAGrS,OAAOqE,QAAQ,uBAAwB,IAAInD,MAAM,KAChEqR,EAAK,EAAGA,EAAKD,EAAQ3U,OAAQ4U,IAC9BD,EAAQC,GAAIvS,OAAOrC,OAAS,GAC5BoU,EAAO3R,KAAK,IAAMkS,EAAQC,GAAIvS,OAAOqE,QAAQ,OAAQ,OAAOA,QAAQ,OAAQ,OAAS,KAMzG,GAAI/E,EAAIyC,UAAYxF,GAAG0F,OAAOoD,WAAWqH,MAAQpN,EAAIyC,UAAYxF,GAAG0F,OAAOoD,WAAWwH,OAAQ,CAC1F,IACIjH,EAEJ,GAFIA,EADW5I,EAAK+G,oBAAoBzE,EAAIyC,UAAUW,aACjC8C,KAAKxI,EAAKgV,aAEpB,CACPD,EAAS,GAELnM,EAAM,IAAMA,EAAM,IAAMA,EAAM,GAC9BmM,EAAO3R,KAAK,IAAMwF,EAAM,GAAK,IAAMA,EAAM,GAAK,IAAMA,EAAM,GAAK,KACxDA,EAAM,IAAMA,EAAM,GACzBmM,EAAO3R,KAAK,IAAMwF,EAAM,GAAK,IAAMA,EAAM,GAAK,KACvCA,EAAM,IAAMA,EAAM,GACzBmM,EAAO3R,KAAK,IAAMwF,EAAM,GAAK,IAAMA,EAAM,GAAK,MACvCA,EAAM,IAAMA,EAAM,KACzBmM,EAAO3R,KAAK,KAAOwF,EAAM,IAAMA,EAAM,IAAM,KAG3CA,EAAM,IACNmM,EAAO3R,KAAK,MAAQpD,EAAKkC,gBAAgB,kBAAoB,eAAsB0G,EAAM,GAAK,cAE3FA,GAASA,EAAM,KACtBmM,EAAS,IAEF3R,KAAK,MAAQpD,EAAKkC,gBAAgB,kBAAoB,eAAsB0G,EAAM,GAAK,SAItG,IAAIjD,EAAU,IAAMoP,EAAOvS,KAAK,KAAO,IAavCmD,GADAA,GADAA,GADAA,GADAA,GAFAA,GADAA,GADAA,GADAA,GADAA,GADAA,EAAUA,EAAQ0B,QAAQ,cAAS,MACjBA,QAAQ,cAAS,MACjBA,QAAQ,cAAS,MACjBA,QAAQ,cAAS,MACjBA,QAAQ,cAAS,MACjBA,QAAQ,SAAO,MAEfA,QAAQ,MAAO,kBACfA,QAAQ,MAAO,kBACfA,QAAQ,MAAO,kBACfA,QAAQ,MAAO,kBACfA,QAAQ,MAAO,sBACjC,IAAImO,EAAM,IAAI1N,OAAOnC,EAAS,MAE1B5D,EAAQO,EAAIP,MAiBhB,OAfIO,EAAIyC,WAAaxF,GAAG0F,OAAOoD,WAAWqH,MAAQpN,EAAIyC,WAAaxF,GAAG0F,OAAOoD,WAAWwH,OACtE9N,EAAMsF,QAAQmO,EACxB,WACI,IAAIrM,EAASzI,MAAMqR,UAAU5N,MAAMhC,KAAKgJ,UAAW,GAEnD,OAAIhC,EAAOA,EAAOxI,OAAS,GAChBwI,EAAO,GAAG9B,QAAQ8B,EAAOA,EAAOxI,OAAS,GAAI,MAAQwI,EAAOA,EAAOxI,OAAS,GAAK,QAEjF,MAAQwI,EAAO,GAAK,SAIzBpH,EAAMsF,QAAQmO,EAAK,cAMnCC,EAAoB,SAAUC,GAChC,MAAM1V,EAAOV,KACb,IAAIqW,EAAUD,EAAEE,OAEhB,GAAsC,MAAlCD,EAAQE,QAAQtO,cAAuB,CACvC,IAAIuO,EAAKJ,EAAEE,OACX,MAAMG,EAAkBD,EAAGE,SAAWF,EAAGG,uBAAyBH,EAAGI,oBAAsBJ,EAAGK,kBAE9F,KAAOL,GAAI,CACP,GAAIC,EAAgB5T,KAAK2T,EAAI,KAAM,CAC/BH,EAAUG,EACV,MAEAA,EAAKA,EAAGM,eAKpB,GAAIT,EAAQU,cAAc,gBAAiB,CACvCrW,EAAKiV,UAAU/N,MAAQyO,EAAQU,cAAc,gBAAgBC,YAC7DtW,EAAKgV,YAAchV,EAAKiV,UAAU/N,MAClClH,EAAKuW,YAAYC,SAASb,EAAQc,aAAa,SAAS5N,UAAU,GAAI8M,EAAQe,WAAWD,aAAa,aACtGlX,GAAGoX,GAAGC,aAAazU,KAAKnC,EAAKiV,UAAW,WAI1C4B,EAAe,SAAUhU,EAAGC,GAC9B,MAAMgU,EAAM,aACNC,EAAM,UAEZ,IAAIC,EAAOC,SAASpU,EAAG,IACnBqU,EAAOD,SAASnU,EAAG,IAEvB,GAAIC,MAAMiU,IAASjU,MAAMmU,GAAO,CAC5B,IAAIC,EAAKtU,EAAEwE,QAAQyP,EAAK,IACpBM,EAAKtU,EAAEuE,QAAQyP,EAAK,IACxB,GAAIK,IAAOC,EAAI,CACX,IAAIC,EAAKJ,SAASpU,EAAEwE,QAAQ0P,EAAK,IAAK,IAClCO,EAAKL,SAASnU,EAAEuE,QAAQ0P,EAAK,IAAK,IACtC,OAAOM,IAAOC,EAAK,EAAID,EAAKC,EAAK,GAAK,EAEtC,OAAOH,EAAKC,EAAK,GAAK,EAEvB,OAAIrU,MAAMiU,GACN,EACAjU,MAAMmU,IACL,EAEDF,EAAOE,EAAO,GAAK,GAmE5BK,EAAY,SAAU5U,GACxB,MAAM3C,EAAOV,KAEb,IAAIkY,EAAO,GACPC,EAAY,GAGZ/U,EAAOC,EAAQA,QAAQ+U,KAtED,SAAU7U,EAAGC,GACvC,MAAM9C,EAAOV,KAEb,OAAIU,EAAK+G,oBAAoBlE,EAAEkC,UAAU2H,cAAgB1M,EAAK+G,oBAAoBjE,EAAEiC,UAAU2H,cACrF1M,EAAK+G,oBAAoBlE,EAAEkC,UAAU2H,cAAgB,IAAM1M,EAAK+G,oBAAoBjE,EAAEiC,UAAU2H,cAAgB,GAC1G,GACC1M,EAAK+G,oBAAoBlE,EAAEkC,UAAU2H,cAAgB,IAAM1M,EAAK+G,oBAAoBjE,EAAEiC,UAAU2H,cAAgB,IAChH,EAGDmK,EAAahU,EAAEd,MAAOe,EAAEf,OAG/Bc,EAAEkC,SAAWjC,EAAEiC,SACR,EAEFlC,EAAEkC,SAAWjC,EAAEiC,UACZ,EAED8R,EAAahU,EAAEd,MAAOe,EAAEf,QAmDesM,KAAKrO,IAEvDA,EAAKgG,QAAQC,SACbvD,EAAOA,EAAKgV,KAjDD,SAAU7U,EAAGC,GAC5B,MAAM9C,EAAOV,KAEPqY,EAAQ,WACV,IAEIC,EAAOC,EAFPC,EAAQ9X,EAAKgG,QAAQC,OAAOC,KAAK,aAAcxF,MAAQV,EAAKgG,QAAQC,OAAOC,KAAK,GAAG1D,KAAK,KAAOxC,EAAKgG,QAAQC,OAAOC,KAAK,GAG5H,GAAIrD,EAAEc,YAAcd,EAAEc,WAAWhD,OAAS,GAAKmC,EAAEa,YAAcb,EAAEa,WAAWhD,OAAS,EAAG,CACpFiX,EAAQ5X,EAAKgG,QAAQC,OAAOnC,eAAezB,IAAI,SAAUiO,GAAQ,OAAOzN,EAAEc,WAAW2M,GAAMhJ,aAAe9E,KAAK,KAC/GqV,EAAQ7X,EAAKgG,QAAQC,OAAOnC,eAAezB,IAAI,SAAUiO,GAAQ,OAAOxN,EAAEa,WAAW2M,GAAMhJ,aAAe9E,KAAK,SAC5G,CACHoV,EAAQ/U,EAAE5B,GACV4W,EAAQ/U,EAAE7B,GAGd,OAAI2W,IAAUE,GAASD,IAAUC,EACtB,EACAF,IAAUE,GAASD,IAAUC,GAC5B,EAEDjB,EAAahU,EAAEd,MAAOe,EAAEf,QAErCsM,KAAK/O,MAEP,OAAIU,EAAK+G,oBAAoBlE,EAAEkC,UAAU2H,cAAgB1M,EAAK+G,oBAAoBjE,EAAEiC,UAAU2H,cACrF1M,EAAK+G,oBAAoBlE,EAAEkC,UAAU2H,cAAgB,IAAM1M,EAAK+G,oBAAoBjE,EAAEiC,UAAU2H,cAAgB,GAC1G,GACC1M,EAAK+G,oBAAoBlE,EAAEkC,UAAU2H,cAAgB,IAAM1M,EAAK+G,oBAAoBjE,EAAEiC,UAAU2H,cAAgB,IAChH,EAGDiL,IAIJA,KAcqBtJ,KAAKrO,KAGrC,IAAK,IAAI2B,EAAI,EAAGA,EAAIe,EAAK/B,OAAQgB,IAAK,CAClC,IAAIW,EAAMI,EAAKf,GAEf,IAAwC,GAApC8V,EAAUvW,QAAQoB,EAAIyC,UAAiB,CACvCyS,EAAKA,EAAK7W,QAAUX,EAAK+G,oBAAoBzE,EAAIyC,UAAUlD,wBAC3D4V,EAAUrU,KAAKd,EAAIyC,UAGvByS,EAAKA,EAAK7W,QAAU,iBAAmB2B,EAAIyC,SAAW,eAC9BgT,mBAAmBzV,EAAIrB,IAAM,kBAEjDqB,EAAIP,MACJ,UACA+S,EAAa3S,KAAKnC,EAAMsC,GACxB,YAIR5B,MAAMqR,UAAU1P,IAAIF,KAAKnC,EAAKgY,YAAYC,iBAAiB,gBAAkB3V,GAClEA,EAAImU,aAAa,aACzB3R,OAAO,CAACC,EAAUpD,EAAGuW,IACbA,EAAYhX,QAAQ6D,KAAcpD,IAAM8V,EAAUU,SAASpT,IACnEzB,QAAQyB,IACPyS,EAAKA,EAAK7W,QAAUX,EAAK+G,oBAAoBhC,GAAUlD,wBACvD2V,EAAKA,EAAK7W,QAAU,iBAAmBoE,EAAW,kDAAoD/E,EAAKkC,gBAAgB,aAAe,uFAG9I,OAAOsV,EAAKhV,KAAK,KAGrBsP,EAASsG,WAAa,SAAU1V,EAAM2V,GAClC,IAAIrY,EAAOV,KAEXU,EAAK6S,QAAU7S,EAAK6S,SAAW,GAE/B,IAAIA,EAAU,WACV7S,EAAKsY,OAAOtY,EAAKiV,UAAU/N,MAAO,SAAUqR,GACxC,GAAoB,IAAhBA,EAAK5X,OAAc,CACnBX,EAAKiV,UAAU/N,MAAQqR,EAAK,GAAGxW,MAC/B/B,EAAKuW,YAAYgC,EAAK,GAAGtX,GAAIjB,EAAKgY,YAAY3B,cAAc,oBAAoBI,aAAa,aAC7FzW,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,aAE5B,IAAhBJ,EAAK5X,QACVX,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,WAK7D,OAAOpZ,GAAGE,QAAQsS,UAAUqG,WAAWjW,KAAKnC,EAAM0C,EAAM,WAGpD,IAAIkW,EAAY,WACZ5Y,EAAKiV,UAAU/N,MAAQlH,EAAKgY,YAAYjW,OAAS/B,EAAKgY,YAAY3B,cAAc,+BAA+BC,YAC/GtW,EAAKgV,YAAchV,EAAKiV,UAAU/N,MAClClH,EAAKuW,YAAYvW,EAAKgY,YAAY/W,IAAMuV,SAASxW,EAAKgY,YAAY3B,cAAc,wBAAwBI,aAAa,SAAS5N,UAAU,GAAI7I,EAAKgY,YAAY3B,cAAc,oBAAoBI,aAAa,aAC5MzW,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,SAGrD3Y,EAAKiV,UAAYjV,EAAK6Y,IAAIxC,cAAc,2BACpCrW,EAAKF,SAAWE,EAAKF,QAAQgZ,aAC7B9Y,EAAKiV,UAAU8D,aAAa,cAAe/Y,EAAKF,QAAQgZ,YAAY9V,QAGxEhD,EAAKgY,YAAchY,EAAK6Y,IAAIxC,cAAc,uBAC1CrW,EAAKgZ,OAAShZ,EAAK6Y,IAAIxC,cAAc,sBACrCrW,EAAKgZ,OAAOC,iBAAiB1Z,GAAG0F,OAAOoG,MAAM6N,MAAO,WAChDlZ,EAAKmZ,WAAWxI,KAAK,SAAUyI,GACvBpZ,EAAKgY,YAAYC,iBAAiB,sEAAsEtX,OAAS,IAC5GyY,EAAEtI,SAASnQ,OAAS,EACzByY,EAAE/W,IAAIgX,eAAeD,EAAEtI,UAEiG,IAAnH9Q,EAAKgY,YAAYC,iBAAiB,sEAAsEtX,OAC7GiY,IAGA5Y,EAAKiV,UAAUqE,cAAc,IAAIC,MAAM,eAInD,GAAIvZ,EAAKF,QAAQ0Z,aAAc,CAC3BxZ,EAAKiV,UAAU8D,aAAa,QAAS/Y,EAAKF,QAAQ0Z,aAAaxW,QAC/DhD,EAAKgZ,OAAOD,aAAa,QAAS/Y,EAAKF,QAAQ0Z,aAAaxW,QAIhEhD,EAAKgY,YAAYiB,iBAAiB1Z,GAAG0F,OAAOoG,MAAM6N,MAAO3Z,GAAGka,YAAYC,mBAAmB,2BAA4B,WACnH1Z,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,QACjD3Y,EAAKiV,UAAU0E,WAGnB3Z,EAAKiV,UAAUgE,iBAAiB,WAAY,SAAUvD,GAClD,GAAe,IAAXA,EAAEkE,MAAa,CACflE,EAAEmE,iBACFnE,EAAEoE,kBAEF9Z,EAAKgV,YAAc,GAEoG,IAAnHhV,EAAKgY,YAAYC,iBAAiB,sEAAsEtX,OACxGiY,IAEA/F,IAEJ,OAAO,KAGf7S,EAAKiV,UAAUgE,iBAAiB,SAAU,WACtC,GAAoC,IAAhCjZ,EAAKiV,UAAU/N,MAAMvG,OAAc,CACnCX,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,QACjD9F,OAGR7S,EAAKiV,UAAUgE,iBAAiB,QAAS,WACrC,GAAoC,IAAhCjZ,EAAKiV,UAAU/N,MAAMvG,OAAc,CACnCX,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,QACjD9F,OAGR7S,EAAKiV,UAAUgE,iBAAiB,6BAA8B,WAC1DjZ,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,UAErD3Y,EAAKiV,UAAUgE,iBAAiB,6BAA8B,WACtDjZ,EAAKgY,YAAYC,iBAAiB,MAAMtX,OAAS,GACjDX,EAAKgY,YAAYQ,UAAUuB,OAAOxa,GAAG0F,OAAOyT,QAAQC,UAI5D3Y,EAAKgV,YAAc,GACnBhV,EAAKga,aAAe,KACpBza,GAAG0a,QACE1a,GAAGoX,KAAOpX,GAAGoX,GAAGC,aACjB,CAACrX,GAAGI,YAAc,yBAClB,WACI,IAAIua,EAwCJ3a,GAAGoX,GAAGC,aAAazU,KAAKnC,EAAKiV,UAAW,CACpCkF,KAAM,IACNvE,OAAQ5V,EAAKgY,YACboC,UAAW,EACX7H,IAAKvS,EACL0K,OA3CW,SAAUjG,EAAM4T,GAC3BrY,EAAKqa,UAAYnb,YAAYC,MAExB+a,IA+BDA,EAAcI,sBA9Bd,SAASC,IACL,IAAIC,EAAWxa,EAAKiV,UAAU/N,MAAMlE,OAEpC,GAAIwX,EAAS7Z,OAAS,KAChBX,EAAKgV,aAAewF,GAAYxa,EAAKgV,cACvC9V,YAAYC,MAAQa,EAAKqa,UAAYra,EAAKwR,SAAU,CAEpDvS,OAAOwb,qBAAqBP,GAC5BA,OAAcQ,EAEd1a,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,QAYjD3Y,EAAKgV,YAAcwF,EAEnBxa,EAAKsY,OAAOkC,EAAUnC,QAEtB6B,EAAcI,sBAAsBC,OAchDlC,SAAU5C,EAAkBpH,KAAKrO,GACjCuX,UAAWA,EAAUlJ,KAAKrO,KAG9B,MA2BM2a,EAAY,SAAUjF,GACxB,IAAKA,EAAEkF,UAAYlF,EAAEmF,SAAWnF,EAAEoF,SAC9B,GAAkB,KAAdpF,EAAEqF,QAAgB,CACd/a,EAAKiV,WAAa+F,SAASC,eAAiBjb,EAAKgY,YAAY3B,cAAc,sBAE3ErW,EAAKgY,YAAY3B,cAAc,sBAAsBsD,QAC9C3Z,EAAKgY,YAAY3B,cAAc,mCAAqC2E,SAASC,cAEpFjb,EAAKiV,UAAU0E,QAnCR,SAAUrJ,EAAM4K,GAEnC,IAAIC,EAAU7K,EAAK8K,mBAEnB,IAAKF,EAAU,OAAOC,EAGtB,KAAOA,GAAS,CACZ,GAAIA,EAAQnF,QAAQkF,GAAW,OAAOC,EACtCA,EAAUA,EAAQC,oBA6BVC,CAAeL,SAASC,cAAc7E,cAAe,oBAChDC,cAAc,KAAKsD,QAE5BjE,EAAEmE,iBACFnE,EAAEoE,uBACC,GAAkB,KAAdpE,EAAEqF,QAAgB,CACrB/a,EAAKiV,WAAa+F,SAASC,cAE3Bjb,EAAKgY,YAAY3B,cAAc,iCAAiCsD,QACzDqB,SAASC,eAAiBjb,EAAKgY,YAAY3B,cAAc,sBAChErW,EAAKgY,YAAY3B,cAAc,iCAAiCsD,QAnCrD,SAAUrJ,EAAM4K,GAEvC,IAAIC,EAAU7K,EAAKgL,uBAEnB,IAAKJ,EAAU,OAAOC,EAGtB,KAAOA,GAAS,CACZ,GAAIA,EAAQnF,QAAQkF,GAAW,OAAOC,EACtCA,EAAUA,EAAQG,wBA6BVC,CAAmBP,SAASC,cAAc7E,cAAe,oBACpDC,cAAc,KAAKsD,QAE5BjE,EAAEmE,iBACFnE,EAAEoE,kBAGVpE,EAAEoE,mBAGN9Z,EAAKiV,UAAUgE,iBAAiB,UAAW0B,GAC3C3a,EAAKgY,YAAYiB,iBAAiB,UAAW0B,KAIjDpb,GAAGW,KAAKsb,WAAWnD,IACnBA,OAKZvG,EAASV,qBAAuB,SAAUnK,EAAMnH,GACjCR,KAEN0R,mBAAmB5N,KAAK,IAAIxD,WAAWqH,EAAMnH,EAFvCR,QAKfwS,EAAS/K,oBAAsB,SAAUlH,GAGrC,OAFWP,KAEC0R,mBAAmBlM,OAAO,SAAUmM,GAC5C,OAAOA,EAAQ7Q,UAAYP,IAC5B,IAGPiS,EAASoB,uBAAyB,SAAUjS,GACxC,IAEIpB,EAFOP,KAEK0R,mBAAmBlM,OAAO,SAAUmM,GAChD,OAAOA,EAAQjQ,oBAAoBC,KAGvC,OAAIpB,EAAKc,OAAS,EACPd,EAAK,GAGT,MAGXiS,EAAS2J,2BAA6B,SAAUxa,EAAI8D,GAChD,MAAM/E,EAAOV,KAEb,IAAK,IAAIqC,EAAI,EAAGA,EAAI3B,EAAK0b,sBAAsB/a,OAAQgB,IACnD,GAAI3B,EAAK0b,sBAAsB/Z,GAAGV,IAAMA,KAAQ8D,GAAaA,GAAY/E,EAAK0b,sBAAsB/Z,GAAGoD,WAAaA,GAChH,OAAO/E,EAAK0b,sBAAsB/Z,IAI9CmQ,EAASqH,SAAW,WAEhB,OADa7Z,KACDuU,cAGhB/B,EAAS6J,YAAc,WAEnB,OADarc,KACDkU,MAAM1C,UAGtBgB,EAAS8J,SAAW,WAChB,MAAM5b,EAAOV,KAEb,GAAIU,EAAKwT,MAAO,CACZ,MAAM4F,EAAIpZ,EAAKwT,MACf,IAAI1C,EAAWsI,EAAEtI,SAAS3M,QAC1BiV,EAAEyC,gBAEF7b,EAAKqC,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAMyQ,cAAe,CAAEtI,MAAO4F,EAAG7V,QAASuN,IAErE,IAAK,IAAInP,EAAI,EAAGA,EAAI3B,EAAK6U,eAAelU,OAAQgB,IACxCyX,EAAE1X,eAAe1B,EAAK6U,eAAelT,YAC9ByX,EAAEpZ,EAAK6U,eAAelT,MAK7CmQ,EAASiK,kBAAoB,WACzB,IAAI/b,EAAOV,KAEXC,GAAGyc,MAAM1D,OAAS/Y,GAAGyc,MAAM1D,QAAU,GACrCtY,EAAKic,uBAAyB,IAAIhM,QAAQ,SAAUC,EAASC,GACzD,GAAI5Q,GAAGyc,MAAM1D,OAAO4D,eAChBhM,EAAQ3Q,GAAGyc,MAAM1D,OAAO4D,oBAEvB,CACD,IAAIrc,EAAOG,EAAK+G,oBAAoBxH,GAAG0F,OAAOoD,WAAWkE,WAEzD,KAAI1M,EAAK8M,cAAgB9M,EAAK8M,aAAalM,aAAeZ,EAAK8M,aAAaC,eAAiB/M,EAAK8M,aAAaE,YAuD3G,MAAM,IAAIvM,MAAM,mDAA+CT,EAAKO,SAAW,qCAtD/E,IAAI+I,EAAS,CACTC,QAAS,aACTC,QAAS,MACTM,SAAU9J,EAAK8M,aAAalM,YAC5B8I,QAAS1J,EAAK2J,QACdY,aAAcvK,EAAK8M,aAAaC,cAAgB,IAAM/M,EAAK8M,aAAaE,WACxEpD,aAAc5J,EAAKmF,cAEnBnF,EAAK2F,gBACL2D,EAAOQ,SAAW9J,EAAK2F,cAAgB,IAAM2D,EAAOQ,UAExD,IAAI4B,EAAM1L,EAAK0L,IAAM,IAAMhM,GAAGW,KAAKoK,eAAenB,GAClD5J,GAAGgR,KAAK,CACJhF,IAAKA,EACLiF,OAAQ,MACRC,aAAc,SACfE,KAAK,SAAUC,GACd,MAAMlO,EAAOkO,EAASlO,KACtB,IAUIoO,GATAjR,EAAKmF,eAAiBzF,GAAG0F,OAAOC,OAAOC,KAC9B,IAAI5F,GAAG6F,KAAKC,OAAOF,KAGnB,IAAI5F,GAAG6F,KAAKC,OAAOC,IAAI,CAC5BC,UAAW1F,EAAK8M,aAAanH,cAC7B/E,YAAaZ,EAAK8M,aAAalM,eAGjBgF,KAAK/C,GAC3BnD,GAAGyc,MAAM1D,OAAO4D,eAAiB,GACjC,IAAK,IAAIva,EAAI,EAAGA,EAAImP,EAASnQ,OAAQgB,IAAK,CACtC,IAAI4B,EAAUuN,EAASnP,GACvBpC,GAAGyc,MAAM1D,OAAO4D,eAAe9Y,KAAK,CAAErB,MAAOwB,EAAQb,KAAK7C,EAAK8M,aAAaC,eAAgB3L,GAAIsC,EAAQb,KAAK7C,EAAK8M,aAAaE,cAGnItN,GAAGyc,MAAM1D,OAAO4D,eAAexE,KAAK,SAAU7U,EAAGC,GAW7C,OATID,EAAEd,MAAQe,EAAEf,OACF,EAELc,EAAEd,MAAQe,EAAEf,MACR,EAGA,IAKjBmO,EAAQ3Q,GAAGyc,MAAM1D,OAAO4D,kBACzBnL,MAAM,WACLb,SAOhB,OAAOlQ,EAAKic,wBAGhBnK,EAASjE,eAAiB,SAAUlI,GAChC,MAAM3F,EAAOV,KACb,OAAO,IAAI2Q,QAAQ,SAAUC,EAASC,GAClC,IAAIvH,EAAQjD,EAAQiD,MAAM,IAAId,OAAO,IAAM9H,EAAK4L,WAAW5I,OAAOuE,cAAgB,eAAiBvH,EAAKsR,SAAW,8BAAgCtR,EAAK6L,WAAW7I,OAAOuE,cAAgB,eAAiBvH,EAAKuR,SAAW,qBACvN3I,IACAjD,EAAUiD,EAAM,GAAK,IAAMA,EAAM,KAGrCA,EAAQjD,EAAQiD,MAAM,IAAId,OAAO,IAAM9H,EAAK+L,UAAU/I,OAAOuE,cAAgB,0CAA4CvH,EAAK8L,UAAU9I,OAAOuE,cAAgB,wCAE3J5B,EAAUiD,EAAM,GAAK,IAAMA,EAAM,IAGrC,GAAI,KAAKxB,KAAKzB,KAAa,IAAImC,OAAO,WAAa9H,EAAKsR,SAAW,qCAAuCtR,EAAKuR,SAAW,oBAAoBnK,KAAKzB,IAAY,2DAA2DyB,KAAKzB,IAAW,CAEtO,IADAiD,EAAQ,2DAA2DJ,KAAK7C,MAC1DiD,EAAM,GAAG1H,QAAQ,MAAQ,GAAK0H,EAAM,GAAG1H,QAAQ,MAAQ,GAAI,CACrE0H,EAAM,GAAKA,EAAM,GAAGvB,QAAQ,IAAK,KACjCuB,EAAM,GAAKA,EAAM,GAAGvB,QAAQ,IAAK,KAEjC1B,EAAUiD,EAAM,GAAK,IAAMA,EAAM,GAGrC,IAAKA,GAASA,IAAWA,EAAM,GAAG1H,QAAQ,MAAQ,EAAI0H,EAAM,GAAGvB,QAAQ,IAAK,KAAOuB,EAAM,KAAO,MAAUA,EAAM,GAAG1H,QAAQ,MAAQ,EAAI0H,EAAM,GAAGvB,QAAQ,IAAK,KAAOuB,EAAM,KAAO,GAAK,CAGlL,IADAA,EAAQ,IAAId,OAAO,WAAa9H,EAAKsR,SAAW,qCAAuCtR,EAAKuR,SAAW,oBAAoB/I,KAAK7C,MAClHiD,EAAM,GAAG1H,QAAQ,MAAQ,GAAK0H,EAAM,GAAG1H,QAAQ,MAAQ,GAAI,CACrE0H,EAAM,GAAKA,EAAM,GAAGvB,QAAQ,IAAK,KACjCuB,EAAM,GAAKA,EAAM,GAAGvB,QAAQ,IAAK,KAEjC1B,EAAUiD,EAAM,GAAK,IAAMA,EAAM,GAIrCjD,EAAUA,EAAQ0B,QAAQrH,EAAK4L,WAAY,IAAIvE,QAAQrH,EAAK6L,WAAY,IAAIxE,QAAQrH,EAAK8L,UAAW,IAAIzE,QAAQrH,EAAK+L,UAAW,IAChI,IAAIoQ,EAAS5c,GAAGW,KAAKkc,YAAYzW,GACjC,GAAIwW,EAAQ,CACR,IAAIE,EAASF,EAAO,GAAGjV,MACnBoV,EAASH,EAAO,GAAGjV,MACnBqV,EAAUJ,EAAO,GAAGtc,OAASN,GAAG0F,OAAOuX,IAAOxc,EAAKwL,KAAOxL,EAAK2L,IAC/D8Q,EAAUN,EAAO,GAAGtc,OAASN,GAAG0F,OAAOuX,IAAOxc,EAAKyL,KAAOzL,EAAK0L,IAC/DzK,EAAKsb,EAASF,EAASI,EAASH,EAEhCxN,EAAQ9O,EAAK0c,SAASzb,GAC1B,GAAI6N,IAAU9O,EAAK2c,YAAY7N,GAAQ,CACnCuN,EAASF,EAAO,GAAGjV,MACnBoV,EAASH,EAAO,GAAGjV,MAGnBjG,GAFAsb,EAAUJ,EAAO,GAAGtc,OAASN,GAAG0F,OAAOuX,IAAOxc,EAAKwL,KAAOxL,EAAK2L,KAEjD0Q,GADdI,EAAUN,EAAO,GAAGtc,OAASN,GAAG0F,OAAOuX,IAAOxc,EAAKyL,KAAOzL,EAAK0L,KAC/B4Q,EAChCxN,EAAQ9O,EAAK0c,SAASzb,GAG1B,GAAI6N,EAAO,CACP9O,EAAKsM,qBAAqB/M,GAAG0F,OAAOoD,WAAWuF,aAAa7L,MAAQ,qCAAqCqF,KAAKnG,GAAMjB,EAAKkC,gBAAgB,+BAAiClC,EAAKqC,IAAIua,IAAM5c,EAAKkC,gBAAgB,+BAG9MgO,EAAQ,CAAC,CACLjP,GAAIA,EAAIc,MAAO/B,EAAK6c,SAAS5b,GAAK8D,SAAUxF,GAAG0F,OAAOoD,WAAWuF,oBAKrEuC,SAIJA,SAIJA,SAIJA,OAKZ2B,EAASvE,gBAAkB,SAAU5H,GACjC,MAAM3F,EAAOV,KACb,OAAO,IAAI2Q,QAAQ,SAAUC,EAASC,GAClC,IAAIvH,EAAQjD,EAAQiD,MAAM,IAAId,OAAO9H,EAAKmM,UAAUnJ,OAAOuE,cAAgB,kBAAoBvH,EAAKoM,UAAUpJ,OAAOuE,cAAgB,wBAA0BvH,EAAKqM,UAAUrJ,OAAOuE,cAAgB,mBACjMqB,IACAjD,EAAUiD,EAAM,GAAK,KAAOA,EAAM,GAAK,KAAOA,EAAM,IAGxD,IAAIkU,EAAWnX,GACT,2CAA2CyB,KAAKzB,IAAa3F,EAAK+G,oBAAoBxH,GAAG0F,OAAOoD,WAAWkE,WAAWC,iBACxHsQ,EAAW9c,EAAK+G,oBAAoBxH,GAAG0F,OAAOoD,WAAWkE,WAAWC,eAAiB,KAAO7G,GAE5F,2CAA2CyB,KAAK0V,KAAe,IAAIhV,OAAO,WAAa9H,EAAKsR,SAAW,uBAAyBtR,EAAKuR,SAAW,OAAOnK,KAAKzB,GAC5J3F,EAAK+b,oBAAoBpL,KAAK,SAAU4H,GACpC,IAAI3P,EAAQ,2CAA2CJ,KAAKsU,GAC5D,GAAIlU,EAAO,CACP,IAAImU,EAAU,IAAIjV,OAAOc,EAAM,GAAG5F,OAAOqE,QAAQ,2BAA4B,QAAS,KAClF1E,EAAU,GAEd,MAAMqa,EAAU,SAAUC,EAAKC,EAAUC,EAAKC,GAC1C,IAAIzZ,EAAa,GAEjBA,EAAWP,KAAKpD,EAAKgM,KAAOiR,EAC5BtZ,EAAWP,KAAKpD,EAAKiM,KAAOkR,EAC5BxZ,EAAWP,KAAKpD,EAAKkM,KAAOkR,EAE5B,MAAO,CACHnc,GAAIjB,EAAKgM,IAAMiR,EAAMjd,EAAKiM,IAAMkR,EAAMnd,EAAKkM,IAAMkR,EACjDrb,MAAO/B,EAAK6c,SAAS7c,EAAKgM,IAAMkR,EAAWld,EAAKiM,IAAMkR,EAAMnd,EAAKkM,IAAMkR,GACvErY,SAAUxF,GAAG0F,OAAOoD,WAAWkE,UAC/B5I,WAAYA,IASpB,IALAhB,EAAU4V,EAAKzT,OAAO,SAAUoC,GAC5BA,EAAQA,EAAMnF,OAASmF,EAAMjG,IAAMiG,EACnC,OAAO6V,EAAQ3V,KAAKF,IAAU6V,EAAQ3V,KAAKpH,EAAKqd,kBAAkBnW,OAG1DvG,OAAS,EACjB,IAAK,IAAIgB,EAAI,EAAGA,EAAIgB,EAAQhC,OAAQgB,IAChCgB,EAAQhB,GAAKqb,EAAQra,EAAQhB,GAAGV,GAAI0B,EAAQhB,GAAGI,MAAO6G,EAAM,GAAG5F,OAAQ4F,EAAM,GAAG5F,QAIxF,GAAI,YAAYoE,KAAKwB,EAAM,IAAK,CAE5B,GAAIA,EAAM,GAAG5F,SAAWhD,EAAK+G,oBAAoBxH,GAAG0F,OAAOoD,WAAWkE,WAAWC,eAAgB,CAE7F,IAAIA,EAAiB+L,EAAKzT,OAAO,SAAUxC,GACvC,OAAO2U,SAAS3U,EAAIrB,MAAQgW,SAASjX,EAAK+G,oBAAoBxH,GAAG0F,OAAOoD,WAAWkE,WAAWC,kBAC/F,GAECA,GACA0D,EAAQ,CAAC8M,EAAQxQ,EAAevL,GAAIuL,EAAezK,MAAO6G,EAAM,GAAG5F,OAAQ4F,EAAM,GAAG5F,UAI5FL,EAAQS,KAAK4Z,EAAQpU,EAAM,GAAG5F,OAAQ4F,EAAM,GAAG5F,OAAQ4F,EAAM,GAAG5F,OAAQ4F,EAAM,GAAG5F,SAIrFkN,EAAQvN,MAKhBwN,OAKZ2B,EAASvD,yBAA2B,CAChC+O,IAAK,SAAU7Y,EAAMmO,EAAQ1M,EAAMC,GAE/B,IAAIyC,EAAQ,6PAAyNJ,KAAK/D,GAC1O,GAAImE,GAASA,EAAM,IAAMA,EAAM,GAAI,CAE/B,IAAI2U,EAAY,WACZ,OAAOC,GAAoB5U,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAI5F,SAG7E,GAAI,eAAeoE,KAAKwB,EAAM,GAAG5F,SAAW,eAAeoE,KAAKwB,EAAM,GAAG5F,QAAS,CAC9E4P,EAAOxP,KAAK,CACRqF,EAAGG,EAAM,GAAG5F,OAAQ0F,EAAGE,EAAM,GAAG5F,OAAQuB,EAAGgZ,MAE/C3K,EAAOxP,KAAK,CACRqF,EAAGG,EAAM,GAAG5F,OAAQ0F,EAAGE,EAAM,GAAG5F,OAAQuB,EAAGgZ,UAI3C,eAAenW,KAAKwB,EAAM,GAAG5F,QAAS4P,EAAOxP,KAAK,CAClDqF,EAAGG,EAAM,GAAG5F,OAAQ0F,EAAGE,EAAM,GAAG5F,OAAQuB,EAAGgZ,MAE1C3K,EAAOxP,KAAK,CACbsF,EAAGE,EAAM,GAAG5F,OAAQyF,EAAGG,EAAM,GAAG5F,OAAQuB,EAAGgZ,MAGnDE,EAAStb,KAAK7C,KAAMsT,EAAQ1M,EAAMC,GAClC,OAAO,EAGX,OAAO,GAEXuX,IAAK,SAAUjZ,EAAMmO,EAAQ1M,EAAMC,GAE/B,IAAIyC,EAAQ,6PAAyNJ,KAAK/D,GAC1O,GAAImE,GAASA,EAAM,IAAMA,EAAM,GAAI,CAE/B,IAAI2U,EAAY,WACZ,OAAOC,GAAoB5U,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAI5F,SAG7E,GAAI,eAAeoE,KAAKwB,EAAM,GAAG5F,SAAW,eAAeoE,KAAKwB,EAAM,GAAG5F,QAAS,CAC9E4P,EAAOxP,KAAK,CACRqF,EAAGG,EAAM,GAAG5F,OAAQ0F,EAAGE,EAAM,GAAG5F,OAAQuB,EAAGgZ,MAE/C3K,EAAOxP,KAAK,CACRqF,EAAGG,EAAM,GAAG5F,OAAQ0F,EAAGE,EAAM,GAAG5F,OAAQuB,EAAGgZ,UAI3C,eAAenW,KAAKwB,EAAM,GAAG5F,QAAS4P,EAAOxP,KAAK,CAClDqF,EAAGG,EAAM,GAAG5F,OAAQ0F,EAAGE,EAAM,GAAG5F,OAAQuB,EAAGgZ,MAE1C3K,EAAOxP,KAAK,CACbsF,EAAGE,EAAM,GAAG5F,OAAQyF,EAAGG,EAAM,GAAG5F,OAAQuB,EAAGgZ,MAGnDE,EAAStb,KAAK7C,KAAMsT,EAAQ1M,EAAMC,GAClC,OAAO,EAGX,OAAO,GAEXwX,KAAM,SAAUlZ,EAAMmO,EAAQ1M,EAAMC,GAEhC,IAAIyC,EAAQ,6PAAyNJ,KAAK/D,GAE1O,GAAImE,GAASA,EAAM,IAAMA,EAAM,GAAI,CAC/BgK,EAAOxP,KAAK,CACRqF,EAAGG,EAAM,GAAG5F,OAAQ0F,EAAGE,EAAM,GAAG5F,OAAQuB,EAAGiZ,GAAoB5U,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAMA,EAAM,IAAI5F,UAEjHya,EAAStb,KAAK7C,KAAMsT,EAAQ1M,EAAMC,GAClC,OAAO,EAGX,OAAO,GAEXyX,GAAI,SAAUnZ,EAAMmO,EAAQ1M,EAAMC,GAE9B,IAAIyC,EAAQ,+GAA2EJ,KAAK/D,GAG5F,IAAKmE,GAAS,aAAaxB,KAAK3C,EAAKzB,QAAS,CAC1C,IAAIwX,EAAW/V,EAAKP,MAAM,KAAK2Z,UAC/BjV,EAAQ,+GAA2EJ,KAAKgS,EAAShY,KAAK,MAG1G,GAAIoG,GAASA,EAAM,IAAMA,EAAM,GAAI,CAE/B,GAAI,eAAexB,KAAKwB,EAAM,GAAG5F,SAAW,eAAeoE,KAAKwB,EAAM,GAAG5F,QAAS,CAC9E4P,EAAOxP,KAAK,CACRqF,EAAGG,EAAM,GAAG5F,OAAQ0F,EAAGE,EAAM,GAAG5F,SAEpC4P,EAAOxP,KAAK,CACRsF,EAAGE,EAAM,GAAG5F,OAAQyF,EAAGG,EAAM,GAAG5F,SAGpCya,EAAStb,KAAK7C,KAAMsT,EAAQ1M,EAAMC,OAEjC,CAED,IAAI2X,EAAY,SAAUpV,GAItB,IAHA,IAAIqV,EAAOrV,EAAExE,MAAM,KAAK2Z,UAEpBG,EAAK,GACAC,EAAK,EAAGA,EAAKF,EAAKpd,OAAQsd,IAC/B,GAAuB,GAAnBF,EAAKE,GAAItd,OAAa,CACtBqd,EAAG5a,KAAK2a,EAAKE,IACbF,EAAKE,GAAM,GAInB,OAAOD,EAAGrd,OAAS,EAAIod,EAAKF,UAAUrb,KAAK,KAAKQ,OAAShD,KAAK2G,cAAgBqX,EAAGH,UAAUrb,KAAKxC,KAAK2G,eAAiBoX,EAAKF,UAAUrb,KAAK,KAAKQ,QAG/I,eAAeoE,KAAKwB,EAAM,GAAG5F,QAC7B4P,EAAOxP,KAAK,CACRqF,EAAGG,EAAM,GAAG5F,OAAQ0F,EAAGoV,EAAUlV,EAAM,GAAG5F,UAE7C4P,EAAOxP,KAAK,CACbsF,EAAGoV,EAAUlV,EAAM,GAAG5F,QAASyF,EAAGG,EAAM,GAAG5F,SAG/Cya,EAAStb,KAAK7C,KAAMsT,EAAQ1M,EAAMC,GAAO,GAG7C,OAAO,EAGX,OAAO,GAEXoP,GAAI,SAAU9Q,EAAMmO,EAAQ1M,EAAMC,GAE9B,IAAIyC,EAAQ,8GAA0EJ,KAAK/D,GAE3F,IAAKmE,EAAO,CACR,IAAI4R,EAAW/V,EAAKP,MAAM,KAAK2Z,UAC/BjV,EAAQ,+GAA2EJ,KAAKgS,EAAShY,KAAK,MAG1G,GAAIoG,EAAO,CAIP,IAHA,IAAIlG,EAAO,GAGFf,GADL6Y,EAAW/V,EAAKP,MAAM,KAAK2Z,UAClB,GAAGlc,EAAI6Y,EAAS7Z,OAAQgB,IACjC,GAAI,iBAAiByF,KAAKoT,EAAS7Y,GAAGqB,QAClCN,EAAK+F,EAAI+R,EAAS7Y,GAAGqB,YAEpB,GAAI,YAAYoE,KAAKoT,EAAS7Y,GAAGqB,QAClC,IAAwC,GAApCwX,EAAS7Y,GAAGqB,OAAO9B,QAAQ,KAC3BwB,EAAKgG,EAAI8R,EAAS7Y,GAAGqB,WAClB,CAcH,IAbA,IAAIkb,EAAY1D,EAAS7Y,GAAGqB,OAAOkB,MAAM,KAAK2Z,UAE1CM,EAAW,SAAUC,GAErB,GADQ,yIAAyI5V,KAAK4V,EAAEpb,QACjJ,CACHN,EAAK6B,EAAIiZ,EAAmBY,EAAEpb,QAC9B,OAAO,EAEX,OAAO,GAGPqb,EAAI,EACJ9Z,EAAI2Z,EAAUG,GAAGrb,OACdqb,EAAIH,EAAUvd,SAAWwd,EAAS5Z,MACrC8Z,EACQH,EAAUvd,SACd4D,GAAQ2Z,EAAUG,IAI1B,GAAI3b,EAAK6B,EAAG,CAER,IADA,IAAI+Z,EAAMJ,EACDzL,EAAI,EAAGA,EAAI6L,EAAI3d,OAAQ8R,IAAK,CAGjC,IADA,IAAI8L,GAAW,EACNH,EAAI,EAAGA,EAAIE,EAAI7L,GAAGvO,MAAM,IAAIvD,OAAQyd,IACrC1b,EAAK6B,EAAErD,QAAQod,EAAI7L,GAAG2L,KAAO,IAC7BG,GAAW,GAGnB,GAAIA,EAAU,CACDD,EAAI7L,GAEb6L,EAAI7L,GAAK,GACT,GAAI/P,EAAK6B,GAAKiZ,EAAmBjZ,GAC7B,OAIZ,GAAI,mFAA+C6C,KAAK8W,EAAUL,UAAUrb,KAAK,KAAKQ,QAAS,CAG3F,IAFA,IAAIgb,EAAK,GACLQ,EAAcN,EAAUL,UACnBY,EAAM,EAAGA,EAAMD,EAAY7d,OAAQ8d,IACxC,GAAsC,GAAlCD,EAAYC,GAAKzb,OAAOrC,OAAa,CACrCqd,EAAG5a,KAAKob,EAAYC,GAAKzb,QACzBwb,EAAYC,GAAO,GAI3B/b,EAAKgG,EAAIsV,EAAGrd,OAAS,EAAI6d,EAAYX,UAAUrb,KAAK,KAAKQ,OAAShD,KAAK2G,cAAgBqX,EAAGH,UAAUrb,KAAKxC,KAAK2G,eAAiB6X,EAAYX,UAAUrb,KAAK,KAAKQ,OAMnK4P,EAAOxP,KAAK,CACRqF,EAAG/F,EAAK+F,EACRC,EAAGhG,EAAKgG,EAAI,IAAMhG,EAAK6B,SAG3B7B,EAAKgG,EAAI8R,EAAS7Y,GAAGqB,OAMrC4P,EAAOxP,KAAKV,GACZ+a,EAAStb,KAAK7C,KAAMsT,EAAQ1M,EAAMC,GAClC,OAAO,EAGX,OAAO,GAEXqI,OAAQ,SAAU/J,EAAMmO,EAAQ1M,EAAMC,GAClC,IAAIyC,EAAQ,uFAAmDJ,KAAK/D,GACpE,GAAImE,GAASA,EAAM,GAAI,CACnB,GAAI1C,EAAM,CACN0M,EAAOxP,KAAK,CACRqF,EAAGG,EAAM,GAAG5F,SAGhB4P,EAAOxP,KAAK,CACRqF,EAAGvC,EACHwC,EAAGE,EAAM,GAAG5F,cAGf4P,EAAOxP,KAAK,CACbqF,EAAGG,EAAM,GAAG5F,SAEhB,OAAO,EAGX,OAAO,GAEX0b,GAAI,SAAUja,EAAMmO,EAAQ1M,EAAMC,GAC9B,IAAIyC,EAAQ,0NAAsLJ,KAAK/D,GACvM,GAAImE,GAASA,EAAM,IAAMA,EAAM,GAAI,CAC3B1C,EACA0M,EAAOxP,KAAK,CACRqF,EAAGvC,EACHwC,EAAGE,EAAM,GAAG5F,OACZuB,EAAGiZ,EAAmB5U,EAAM,GAAG5F,UAGnC4P,EAAOxP,KAAK,CACRqF,EAAGG,EAAM,GAAG5F,OACZ0F,EAAGE,EAAM,GAAG5F,SAGpB,OAAO,EAGX,OAAO,GAEX2b,IAAK,SAAUla,EAAMmO,EAAQ1M,EAAMC,GAC/B,IAAIyC,EAAQ,wKAAwKJ,KAAK/D,GACzL,GAAImE,GAASA,EAAM,IAAMA,EAAM,IAAM1C,EAAM,CACvC0M,EAAOxP,KAAK,CACRqF,EAAGvC,EACHwC,EAAGE,EAAM,GAAG5F,OACZuB,EAAGiZ,EAAmB5U,EAAM,GAAG5F,UAEnC,OAAO,EAGX,OAAO,IAMf,MAeMwa,EAAqB,SAAUtW,GA+DjC,IA9DA,IA2DI0X,EAAU,CAzDA,SAAU1X,GACpB,MAAO,yDAAyDE,KAAKF,IAgB7D,SAAUA,GAClB,MAAO,oCAAoCE,KAAKF,IAgBxC,SAAUA,GAClB,MAAO,yBAAyBE,KAAKF,IAW5B,SAAUA,GACnB,MAAO,oCAAoCE,KAAKF,KAWhD2X,EAAQ,CAvDD,SAAU3X,GACjB,IAAIc,EAAI,GACJ8W,EAAI,yDAAyDtW,KAAKtB,GACtE,GAAI4X,EAAG,CACH,IAAK,IAAInd,EAAI,EAAGA,EAAImd,EAAEne,OAAQgB,IACtBmd,EAAEnd,GAAGqB,OAAOrC,OAAS,GACrBqH,EAAE5E,KAAK0b,EAAEnd,GAAGqB,QAGpB,OAAOgF,EAAExF,KAAKxC,KAAK2G,eAEvB,OAAOO,GAMF,SAAUA,GACf,IAAIc,EAAI,GACJ8W,EAAI,oCAAoCtW,KAAKtB,GACjD,GAAI4X,EAAG,CACH,IAAK,IAAInd,EAAI,EAAGA,EAAImd,EAAEne,OAAQgB,IACtBmd,EAAEnd,GAAGqB,OAAOrC,OAAS,GACrBqH,EAAE5E,KAAK0b,EAAEnd,GAAGqB,QAGpB,OAAOgF,EAAExF,KAAKxC,KAAK2G,eAEvB,OAAOO,GAMF,SAAUA,GAEf,MADQ,yBAAyBsB,KAAKtB,GAE3B,MAEJA,GAOD,SAAUA,GACR,oCAAoCsB,KAAKtB,GACjD,OACWA,IAOX6X,EAAK,EACFA,EAAKF,EAAMle,SAAWie,EAAQG,GAAI5c,KAAKnC,KAAMkH,IAChD6X,IAGJ,OAAIA,EAAKF,EAAMle,OACJke,EAAME,GAAI5c,KAAKnC,KAAMkH,GACpBA,GAGVuW,EAAW,SAAU7K,EAAQ1M,EAAMC,EAAO6Y,GAC5C,MAAMhf,EAAOV,KAEb,GAAI4G,EAEA,IADA,IAAIvE,EAAIiR,EAAOjS,OACRgB,KACH,GAAKqd,EAwBDpM,EAAOxP,KAAK7D,GAAGW,KAAKC,OAAO,GAAIyS,EAAOjR,GAAI,CAAE8G,EAAGvC,UAvB/C,GAAI0M,EAAOjR,GAAG8G,EAAG,CACb,IAAIwW,EAAgBjf,EAAKgG,QAAQC,OAAOmK,UAAUtL,OAAO,SAAUwL,GAC/D,OAAOA,EAAKvO,MAAMb,QAAQlB,EAAKqd,kBAAkBzK,EAAOjR,GAAG8G,GAAGlB,gBAAkB,GAClF8G,KAAKrO,IAEqB,GAAxBif,EAActe,OACdiS,EAAOjR,GAAG8G,EAAIwW,EAAc,GAAGhe,GACxBge,EAActe,OAAS,EAE9Bse,EAAc5c,IAAI,SAAUiO,GACxB,IAAI4O,EAAY3f,GAAGW,KAAKC,OAAO,GAC5ByS,EAAOjR,IACVud,EAAUzW,EAAI6H,EAAKrP,GAEnB2R,EAAOxP,KAAK8b,KAGe,GAAxBD,EAActe,QAAewF,GACpCyM,EAAOuM,OAAOxd,EAAG,KAWnCyd,EAA8B,SAAUC,EAAc5a,GACxD,MAAMzE,EAAOV,KACP4G,EAAOlG,EAAKgG,QAAQC,QAAUjG,EAAKgG,QAAQC,OAAOC,MAAQ,GAC1DC,EAAQnG,EAAKgG,QAAQC,QAAUjG,EAAKgG,QAAQC,OAAOE,QAAS,EAElE,IAAIyM,EAAS,GAsBuB,MAHpCnO,EAAOA,EAAKzB,QAGHsc,OAAO7a,EAAK9D,OAAS,KAC1B8D,EAAOA,EAAKoE,UAAU,EAAGpE,EAAK9D,OAAS,IAG3C,GAxBa,WAQT,IAPA,IAAI4e,EAAQ,CAAC,SAAU9a,GACnB,OAAOA,EAAK9D,QAAU,GAE1B,SAAU8D,GACN,OAAO,QAAQ2C,KAAK3C,KAAiB,gBAAgB2C,KAAK3C,KAGrD9C,EAAI,EAAGA,EAAI4d,EAAM5e,OAAQgB,IAC9B,IAAK4d,EAAM5d,GAAGQ,KAAKnC,EAAMyE,GACrB,OAAO,EAGf,OAAO,EAWP2C,GAAY,CACZ,IAAIyX,EAAQ,GAUZ,GAAqB,KARrBA,EAAQQ,EAAahd,IAAI,SAAU0C,GAC/B,OAAO/E,EAAK+G,oBAAoBhC,KACjCD,OAAO,SAAUuD,GAChB,OAAOA,EAAWiG,uBACnBjM,IAAI,SAAUgG,GACb,OAAOA,EAAWiG,wBAGZ3N,OAAc,CACpBke,EAAQ,CAAC7e,EAAKuO,yBAAyB+O,IAAKtd,EAAKuO,yBAAyBmP,IAAK1d,EAAKuO,yBAAyBoP,KAAM3d,EAAKuO,yBAAyBqP,GAAI5d,EAAKuO,yBAAyBgH,IAE/KsJ,EADA3Y,GAAQzB,EAAKP,MAAM,KAAKvD,OAAS,EACzB,CAACX,EAAKuO,yBAAyBmQ,GAAI1e,EAAKuO,yBAAyBoQ,IAAK3e,EAAKuO,yBAAyBC,QAAQzN,OAAO8d,GAGnHA,EAAM9d,OAAO,CAACf,EAAKuO,yBAAyBmQ,GAAI1e,EAAKuO,yBAAyBoQ,IAAK3e,EAAKuO,yBAAyBC,SAIjI,IAAIuQ,EAAK,EACT,IACI,KAAOA,EAAKF,EAAMle,SAAWke,EAAME,GAAI5c,KAAKnC,EAAMyE,EAAMmO,EAAQ1M,EAAMC,IAClE4Y,IAGR,MAAOS,GACHjgB,GAAGkgB,MAAM,gCAA4Bhb,EAAMlF,GAAG0F,OAAOya,aAAaC,MAAO,yCAG7E,OAAO/M,EAGX,OAAO,MAGLgN,EAAe,SAAU/f,EAAMggB,EAAQC,EAAcpd,GAGvD,OAAOqd,MAAMlgB,EAAK0L,IAAK,CACnBiF,OAAQ,OACRwP,QAAS,CACLC,eAAgB,oDAEpBC,KAAMrgB,EAAKiF,OAAOmE,UAAUvG,GAC5Bmd,OAAQA,IAEPlP,KAAK,SAAUC,GACZ,GAAIA,EAASuP,GACT,OAAOvP,EAASnM,OAEhB,KAAM,+BAGbkM,KAAKmP,GACL/O,MAAM,SAAUqP,GACI,eAAbA,EAAInZ,KACJoZ,QAAQC,IAAI,gCAEZ/gB,GAAGkgB,MAAMW,GAGb,MAAMA,KAMlBtO,EAAS1D,iBAAmB,SAAUiR,EAAc1Z,GAChD,MAAM3F,EAAOV,KAEb,OAAO,IAAI2Q,QAAQ,CAACC,EAASC,KACzB,IAAIoQ,EAAU,GACVC,EAAgB,GAEpB7a,EAtOmB,SAAUuB,GAKjCA,EAJa5H,KAIA+d,kBAAkBnW,GAO/B,OAHIA,EARS5H,KAOJmS,gBAAgBC,aAAatK,KAAKF,GAC/BA,EAAMG,QARL/H,KAQkBmS,gBAAgBE,iBAAkB,IAErDzK,EAAMG,QAVL/H,KAUkBmS,gBAAgBG,SAAU,KAC5CrK,eA0NoBpF,KAAKnC,EAAM2F,GAExC0a,QAAQC,IAAI,gCAAkC3a,GAM9C,IAAI8a,EAAmB,eAAejY,KAAK7C,GAC3C,GAAI8a,GAAoBA,EAAiB9f,OAAS,EAAG,CAEjD4f,EAAUnB,EAA4Bjd,KAAKnC,EAAMqf,EAAcoB,EAAiB,KAAO,GAEvF,IAAIC,EAAkBtB,EAA4Bjd,KAAKnC,EAAMqf,EAAcoB,EAAiB,GAAK,IAAMA,EAAiB,KAAO,GAE/HF,EAAUA,EAAQxf,OAAO2f,QAEzBH,EAAUnB,EAA4Bjd,KAAKnC,EAAMqf,EAAc1Z,IAAY,GAG/E,GAAI4a,EAAQ5f,OAAS,EAAG,CACpB,IAAIggB,EAA2B,GAC3BC,EAAeC,GACRxB,EAAava,OAAO,SAAUxC,GACjC,OAAOuH,OAAOiX,KAAK9gB,EAAK+G,oBAAoBzE,GAAKiE,iBAAiB5F,SAAWkJ,OAAOiX,KAAKD,GAAalgB,SAG1GogB,EAAqB,GAEzB,IAAK,IAAIpf,EAAI,EAAGA,EAAI4e,EAAQ5f,OAAQgB,IAAK,CACrC,IAAIkf,EAAcN,EAAQ5e,GACtBqf,EAAQJ,EAAYC,GAExB,IAAK,IAAIlc,EAAI,EAAGA,EAAIqc,EAAMrgB,OAAQgE,IAAK,CACnC,IAAI9E,EAAOG,EAAK+G,oBAAoBia,EAAMrc,IAE1C,GAAIoc,EAAmB7f,QAAQrB,EAAKO,UAAY,EAAG,CAC/CugB,EAAyBvd,KAAKvD,EAAKgC,yBACnC8e,EAAyBvd,KAAK,iBAAmBvD,EAAKO,SAAW,kDAAoDJ,EAAKkC,gBAAgB,aAAe,sFAEzJ6e,EAAmB3d,KAAKvD,EAAKO,UAGjC,IAAI6gB,EAA+BrQ,GACxB/Q,EAAK4C,0BAA0BmO,GAG1C4P,EAAcpd,KAAKwc,EAAazd,KAAKnC,EAAMH,EAAMG,EAAKkhB,8BAA8BrB,OAAQoB,EAA6BJ,KAIjI,GAAIL,EAAc7f,OAAS,EAAG,CAC1BX,EAAKgY,YAAYmJ,WAAaR,EAAyBne,KAAK,IAC5DxC,EAAKiV,UAAUqE,cAAc,IAAI8H,YAAY,+BAE7CnR,QAAQoR,IAAIb,GACP7P,KAAMhO,IACH0d,QAAQC,IAAI,6CAEZpQ,EAAQ,GAAGnP,OAAOkK,MAAM,GAAItI,MAC7BoO,MAAO0O,IACNY,QAAQC,IAAI,sDACZnQ,WAGRA,SAGJA,OAKZ2B,EAASnC,QAAU,SAAUhK,GACzB,MAAM3F,EAAOV,KACb,OAAO,IAAI2Q,QAAQ,SAAUC,EAASC,GAElC,IADAxK,EAAUA,EAAQ3C,QACNrC,OAAS,EACjBuP,EAAQ,QACL,CACH,IAAIrQ,EAAOG,EAAK+G,oBAAoBxH,GAAG0F,OAAOoD,WAAWqH,MAGrD9G,EADc/I,EAAK6F,aACC8C,KAAK7C,GAC7B,GAAIiD,GAASA,EAAM,GAAI,CAEnB,IAAIkU,EAAWlU,EAAM,GAAKA,EAAM,GAAG5F,OAAS,IAAM4F,EAAM,GAAG5F,OAAS4F,EAAM,GAAG5F,OACzE4F,EAAM,IAAMA,EAAM,GAAGjI,OAAS,IAC9Bmc,EAAWA,EAAW,IAAMlU,EAAM,GAAG5F,QAGzChD,EAAKgY,YAAYmJ,UAAYthB,EAAKgC,wBAC9B,iBAAmBhC,EAAKO,SAAW,kDAAoDJ,EAAKkC,gBAAgB,aAAe,qFAC/HlC,EAAKiV,UAAUqE,cAAc,IAAI8H,YAAY,+BAE7Cf,QAAQC,IAAI,eACZP,MAAMlgB,EAAK0L,IAAM,IAAM1L,EAAKiF,OAAOmE,UAAU,CAAER,EAAGqU,IAAa,CAC3D+C,OAAQ7f,EAAKkhB,8BAA8BrB,SAC5ClP,KAAMC,IACL,GAAIA,EAASuP,GACT,OAAOvP,EAAS0Q,OAEhB,KAAM,0BAEX3Q,KAAMC,IACL,IAAIgC,EAAS,GAEb,GAAIhC,EAASC,cAAgB,EAAG,CAC5BD,EAASE,SAASzO,IAAI,SAAUkB,GAC5B,IAAII,EAAa9D,EAAK+D,iBACtB,IAAKgP,EAAO2O,KAAK,SAAUjR,GACvB,OAAQA,EAAK7L,MAAQlB,EAAQI,WAAWA,EAAW,MACnD,CACA,IAAI5B,EAAQlC,EAAKmE,kBAAkBQ,SAAS3E,EAAK+D,iBAAiBvB,IAAI,SAAUmf,GAC5E,OAAOje,EAAQI,WAAW6d,MAG1B/c,EAAO5E,EAAK+D,iBAAiBvB,IAAI,SAAUmf,GAC3C,OAAOje,EAAQI,WAAW6d,KAC3Bhf,KAAK,KAERoQ,EAAOxP,KAAK,CACRnC,GAAIpB,EAAKiE,eAAezB,IAAI,SAAUiO,GAClC,OAAO/M,EAAQI,WAAW2M,KAC3B9N,KAAK,KACRT,MAAOA,EACP0C,KAAMA,EACNR,UAAWV,EAAQtC,GAAGiD,MAAM,KAAK,GACjCa,SAAUlF,EAAKO,cAM3B8P,EAAQ0C,QAGRzC,MAELY,MAAM,SAAUrO,GAEfyN,WAIJA,QAMhB2B,EAAShC,MAAQ,SAAUnK,GACvB,IAAI3F,EAAOV,KACX,OAAO,IAAI2Q,QAAQ,SAAUC,EAASC,GAElC,IADAxK,EAAUA,EAAQ3C,QACNrC,OAAS,EACjBuP,EAAQ,QACL,CAEH,IAAIrQ,EAAOG,EAAK+G,oBAAoBxH,GAAG0F,OAAOoD,WAAWwH,QAGrDjH,EADgB/I,EAAK6F,aACC8C,KAAK7C,GAC/B,GAAIiD,GAASA,EAAM,IAAMA,EAAM,GAAI,CAE/B,IAAIkU,EAAWlU,EAAM,GAAKA,EAAM,GAAG5F,OAAS,IAAM4F,EAAM,GAAG5F,OAAS4F,EAAM,GAAG5F,OACzE4F,EAAM,IAAMA,EAAM,GAAGjI,OAAS,IAC9Bmc,EAAWA,EAAW,IAAMlU,EAAM,GAAG5F,QAGzChD,EAAKgY,YAAYmJ,UAAYthB,EAAKgC,wBAC9B,iBAAmBhC,EAAKO,SAAW,kDAAoDJ,EAAKkC,gBAAgB,aAAe,qFAC/HlC,EAAKiV,UAAUqE,cAAc,IAAI8H,YAAY,+BAE7Cf,QAAQC,IAAI,iBAEZP,MAAMlgB,EAAK0L,IAAM,IAAM1L,EAAKiF,OAAOmE,UAAU,CAAER,EAAGqU,EAAUpU,EAAGE,EAAM,GAAG5F,SAAW,CAC/E6c,OAAQ7f,EAAKkhB,8BAA8BrB,SAC5ClP,KAAMC,IACL,GAAIA,EAASuP,GACT,OAAOvP,EAAS0Q,OAEhB,KAAM,4BAEX3Q,KAAK,SAAUC,GACd,IAAIgC,EAAS,GACb,GAAIhC,EAASC,cAAgB,EAAG,CAC5BD,EAASE,SAASzO,IAAI,SAAUkB,GAC5B,IAAII,EAAa9D,EAAK+D,iBACtB,IAAKgP,EAAO2O,KAAK,SAAUjR,GACvB,OAAQA,EAAKvO,OAASwB,EAAQI,WAAWA,EAAW,MACpD,CACA,IAAIc,EAAO5E,EAAKmE,kBAAkBQ,SAAS3E,EAAK+D,iBAAiBvB,IAAI,SAAUmf,GAC3E,OAAOje,EAAQI,WAAW6d,MAE9B5O,EAAOxP,KAAK,CACRnC,GAAIpB,EAAKiE,eAAezB,IAAI,SAAUiO,GAClC,OAAO/M,EAAQI,WAAW2M,KAC3B9N,KAAK,KACRT,MAAO0C,EACPA,KAAMA,EACNR,UAAWV,EAAQtC,GAAGiD,MAAM,KAAK,GACjCa,SAAUlF,EAAKO,cAK3B8P,EAAQ0C,QAGRzC,MAELY,MAAM,SAAUrO,GAEfyN,WAIJA,QAMhB2B,EAASwG,OAAS,SAAU3S,EAAS0S,GACjC,IAAIrY,EAAOV,KAGX,IADAqG,EAAUA,EAAQ3C,QACNrC,OAAS,EAAG,CACpBgF,EAAUA,EAAQ4B,cAElB8Y,QAAQC,IAAI,cAAgB3a,GAExB3F,EAAKkhB,+BACLlhB,EAAKkhB,8BAA8BO,QAGvCzhB,EAAKgY,YAAYmJ,UAAY,GAC7BnhB,EAAKiV,UAAUqE,cAAc,IAAI8H,YAAY,+BAE7CphB,EAAK0b,sBAAwB,GAE7B,IAAIgG,GAAY,EACZC,EAAU,KACVtB,QAAQC,IAAI,2BAA6B3a,GAEzC+b,GAAY,EACZ1hB,EAAKkhB,8BAA8BrB,OAAO+B,oBAAoB,QAASD,IAG3E3hB,EAAKkhB,8BAAgC,IAAIW,gBACzC7hB,EAAKkhB,8BAA8BrB,OAAO5G,iBAAiB,QAAS0I,GAEpE,IAAIG,EAAW,EACXC,EAAe,KAEf,GAAiB,MADjBD,EACoB,CAEhB,GAAInc,IAAY3F,EAAKiV,UAAU/N,MAAMlE,OAAOuE,cACxC,OAGA,GAA0C,IAAtCvH,EAAK0b,sBAAsB/a,OAAc,CACzCX,EAAK4b,WAEL,IAAK5b,EAAKwT,OACLxT,EAAKwT,OAAwC,IAA/BxT,EAAKwT,MAAM1C,SAASnQ,OAAe,CAElDX,EAAKgY,YAAYmJ,UAAY,iBAAmBnhB,EAAK2U,oBAAsB,oCAAsC3U,EAAK0U,oBAAsB,YAC5I1U,EAAKiV,UAAUqE,cAAc,IAAI8H,YAAY,gCAIrDphB,EAAKgV,YAAc,KAK3BgN,EAAgC,KAChC,GAAIhiB,EAAK0b,sBAAuB,CAC5B1b,EAAK0b,sBAAwB1b,EAAK0b,sBAAsBhE,KAAK,SAAU7U,EAAGC,GACtE,IACImf,EADAtc,EAAU,QACNuc,EAAK,GACb,GAAIvc,EAAQyB,KAAKvE,EAAEd,QAAU4D,EAAQyB,KAAKtE,EAAEf,OAAQ,CAChDkgB,EAAKpf,EAAEd,MAAM6G,MAAMjD,GAAS,GAC5Buc,EAAKpf,EAAEf,MAAM6G,MAAMjD,GAAS,OACzB,CACHsc,EAAKpf,EAAEd,MACPmgB,EAAKpf,EAAEf,MAGX,OAAIkgB,EAAKC,EACE,EAEHD,EAAKC,GACG,EAED,IAInBliB,EAAK6S,QAAQnQ,KAAO1C,EAAK0b,sBAErBrD,GACAA,EAASrY,EAAK0b,yBAK1B1b,EAAKgR,mBAAmB1N,QAAQ,SAAU2N,GACtC,GAAIA,EAAQ5L,OAAQ,CAChByc,IAEAzB,QAAQC,IAAI,wBAA0BrP,EAAQ7Q,UAE9C6Q,EAAQ5L,OAAOlD,KAAKnC,EAAM2F,GACrBgL,KAAK,SAAU5L,EAAU6N,GAEtB,IAAIuP,EAA0B,KAC1B,IAAIC,EAAwBpiB,EAAKgY,YAAY3B,cAAc,gBAAkBtR,EAAW,MACxF,GAAIqd,EAAuB,CACvB,IAAIC,EAA6B3hB,MAAMqR,UAAU7Q,QAAQiB,KAAKigB,EAAsBhM,cAAckM,WAAYF,GAC1GG,EAAuBviB,EAAKgY,YAAYsK,WAAWD,EAA6B,GAEpFriB,EAAKgY,YAAYwK,YAAYD,GAC7BviB,EAAKgY,YAAYwK,YAAYJ,KAIrC/B,QAAQC,IAAI,oBAAsBvb,GAElC,GAAI6N,GAAUA,EAAOjS,OAAS,EAAG,CAG7B,IAAI8hB,EAAW7P,EAAO9N,OAAO,CAACxC,EAAKX,KAAkF,IAA5E3B,EAAK0b,sBAAsBgH,UAAWC,GAAWA,EAAO1hB,KAAOqB,EAAIrB,KAC5G,GAAIwhB,EAAS9hB,SAAWiS,EAAOjS,OAAQ,CACnCX,EAAK0b,sBAAwB1b,EAAK0b,sBAAsB3a,OAAO0hB,GAE/DT,SACyB,IAAlBpP,EAAOjS,QACdwhB,SAGJA,IAGJJ,KAGF1T,KAAKrO,EAAMiR,EAAQ7Q,WAAW2Q,MAAM,SAAUhM,GAE5Csb,QAAQC,IAAI,mBAAqBvb,GACjCgd,KACF1T,KAAKrO,EAAMiR,EAAQ7Q,gBAEzBigB,QAAQC,IAAI,sDAInB,CACDtgB,EAAKgV,YAAc,GAEnBhV,EAAK4b,aAcb9J,EAASyE,YAAc,SAAUtV,EAAI8D,GACjC,IAAI/E,EAAOV,KACPkO,EAAO,KAGPxN,EAAKkhB,+BACLlhB,EAAKkhB,8BAA8BO,QAGvC,OAAO,IAAIxR,QAAQ,SAAUC,EAASC,GAC7BnQ,EAAK4iB,UACN5iB,EAAK4iB,QAAU5iB,EAAKqC,IAAIwgB,mBAAmB,+BAA+B,IAE9E,IAAIC,EACJA,EAAO9iB,EAAK4iB,QAAQG,UAGpB,GAAIC,WAAW,qBAAqBhN,QAAS,CACzChW,EAAKiV,UAAUgO,OACfjjB,EAAKqC,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAMC,YAGrCtL,EAAK4b,WAEL,IAAIsH,GAAmB,EACnBC,GAAgB,EAEpBnjB,EAAKgR,mBAAmB1N,QAAQ,SAAU2N,GACtC,GAAIkS,EAEA,GAAKnjB,EAAKsM,qBAAqB2E,EAAQ7Q,UAWhC,CAEH,IAAIgjB,EAAKre,GAAY/E,EAAKyb,2BAA2BtZ,KAAKnC,EAAMiB,GAAI8D,SACpE,GAAIqe,EAAI,CAEJ,IAAI/a,EAAarI,EAAK+G,oBAAoBqc,GAE1C,GAAIpjB,EAAKsM,qBAAqB8W,IAAO/a,GAAcA,EAAWmF,KAE7C,QADbA,EAAOnF,EAAWmF,KAAKrL,KAAKnC,EAAMiB,EAAImiB,MAElCD,GAAgB,QAEjB,IAAKnjB,EAAKsM,qBAAqB8W,IAAO/a,GAAcA,EAAWmF,KAAM,CACxE0V,GAAmB,EAGN,QADb1V,EAAOnF,EAAWmF,KAAKrL,KAAKnC,EAAMiB,EAAImiB,MAElCD,GAAgB,QAEjB9C,QAAQC,IAAI,oDA5BvB,GAAIrP,EAAQzD,KAAM,CACd0V,GAAmB,EAGN,QADb1V,EAAOyD,EAAQzD,KAAKrL,KAAKnC,EAAMiB,MAE3BkiB,GAAgB,QAEjB9C,QAAQC,IAAI,gDA2B/BtgB,EAAK4iB,QAAQS,WAAWP,GAExB,GAAItV,EAAM,CAENxN,EAAKmZ,WAAWxI,KAAK,SAAU6C,GAC3B,QAAQ,GACJ,KAAKhG,EAAKrE,OAAOtJ,MAAQN,GAAG0F,OAAOkP,UAAUC,OACzC,IAAK,IAAIzS,EAAI,EAAGA,EAAI3B,EAAK6U,eAAelU,OAAQgB,IACxC6R,EAAM9R,eAAe1B,EAAK6U,eAAelT,YAClC6R,EAAMxT,EAAK6U,eAAelT,IAEzC,MACJ,KAAK6L,EAAKrE,OAAOtJ,MAAQN,GAAG0F,OAAOkP,UAAU7O,IACzC,IAAS3D,EAAI,EAAGA,EAAI3B,EAAK6U,eAAelU,OAAQgB,IAC5C6R,EAAMxT,EAAK6U,eAAelT,IAAM6L,EAAKrE,OAAOnJ,EAAK6U,eAAelT,IAGpEmhB,EAAO9iB,EAAK4iB,QAAQG,UAK5BvP,EAAM3T,KAAO2N,EAAKrE,OAAOtJ,KAEzBG,EAAKqC,IAAIihB,GAAG/jB,GAAG0F,OAAOoG,MAAMkI,YAAa,SAAUmC,GAC3CA,EAAElC,QAAUxT,EAAKwT,OArGd,SAAU1C,GAGjC,GAAIA,GAAYA,EAASnQ,OAAS,EAC9B,IAAK,IAAIgB,EAAI,EAAGA,EAAImP,EAASnQ,OAAQgB,IAC7BmP,EAASnP,GAAG4hB,YAJbjkB,KAIgC+R,oBAC/BP,EAASnP,GAAG4hB,WALbjkB,KAK+B+R,oBAgGDlP,KAAKnC,EAAM0V,EAAE5E,YAmE1C9Q,EAAKqC,IAAImhB,IAAIjkB,GAAG0F,OAAOoG,MAAMoY,YA9DH,SAAU/N,GAChC,GAAIA,EAAElC,OAASA,EAAO,CAElBxT,EAAKqC,IAAImhB,IAAIjkB,GAAG0F,OAAOoG,MAAMkI,YAAa,SAAUmC,GAChD,GAAIA,EAAElC,OAASA,EAAO,CAClB,IAAKkC,EAAElC,MAAM1C,UAAuC,GAA3B4E,EAAElC,MAAM1C,SAASnQ,QAAe+U,EAAElC,MAAMpO,KAAKoO,MAAMkQ,YAAY/H,cAAe,CACnG3b,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,QACjD,IAAIgL,EAASjO,EAAElC,MAAMpO,KAAKoO,MAAMkQ,YAAYE,YACxCvU,EAASqG,EAAElC,MAAMnR,IAAIvC,QAAQ+jB,kBAEjC,GAAIF,EAAO,GAAKA,EAAO,IAAO,EAAG,CAC7BA,EAAO,GAAKA,EAAO,GAAKtU,EACxBsU,EAAO,GAAKA,EAAO,GAAKtU,EAE5B,GAAIsU,EAAO,GAAKA,EAAO,IAAO,EAAG,CAC7BA,EAAO,GAAKA,EAAO,GAAKtU,EACxBsU,EAAO,GAAKA,EAAO,GAAKtU,EAE5BqG,EAAElC,MAAMnR,IAAIyhB,UAAUH,GAGtB3jB,EAAKqC,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAM0Y,OAAQ,CACrCC,OAAQL,EAAQnQ,MAAOkC,EAAElC,aAG5B,GAAIkC,EAAElC,MAAM1C,UAAY4E,EAAElC,MAAM1C,SAASnQ,OAAS,EAAG,CACtDX,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,QACjD3Y,EAAKwT,MAAMnR,IAAIgX,eAAe3D,EAAElC,MAAM1C,UAEtC9Q,EAAKqC,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAMkI,YAAa,CAAEC,MAAOxT,EAAKwT,MAAO1C,SAAU9Q,EAAKwT,MAAM1C,gBAErF,GAAI4E,EAAElC,MAAM1C,UAAuC,GAA3B4E,EAAElC,MAAM1C,SAASnQ,QAAe6M,EAAKrE,OAAOtJ,MAAQN,GAAG0F,OAAOkP,UAAU7O,IAAK,CACxGtF,EAAKgY,YAAYiM,MAAQzW,EAAK0W,gBAC9BlkB,EAAKiV,UAAUqE,cAAc,IAAI8H,YAAY,+BAE7CphB,EAAKqC,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAM4G,kBAGrCjS,EAAK4iB,QAAQS,WAAWP,MAIhC,GAAIpN,EAAElC,MAAM1C,UAAY4E,EAAElC,MAAM1C,SAASnQ,OAAS,EAAG,CACjDX,EAAKgY,YAAYQ,UAAUC,IAAIlZ,GAAG0F,OAAOyT,QAAQC,QACjD3Y,EAAKwT,MAAMnR,IAAIgX,eAAerZ,EAAKwT,MAAM1C,UAEzC9Q,EAAKqC,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAMkI,YAAa,CAAEC,MAAOxT,EAAKwT,MAAO1C,SAAU9Q,EAAKwT,MAAM1C,WAExF9Q,EAAK4iB,QAAQS,WAAWP,QACrB,GAAIpN,EAAElC,MAAM1C,UAAuC,GAA3B4E,EAAElC,MAAM1C,SAASnQ,QAAe6M,EAAKrE,OAAOtJ,MAAQN,GAAG0F,OAAOkP,UAAU7O,IAAK,CACxGtF,EAAKgY,YAAYmJ,UAAY3T,EAAK0W,gBAClClkB,EAAKiV,UAAUqE,cAAc,IAAI8H,YAAY,+BAEvC1L,EAAEyO,SAAWzO,EAAEyO,QAAQrT,UAAY4E,EAAEyO,QAAQrT,SAASnQ,OAAS,GACjEX,EAAKqC,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAM4G,kBAGrCjS,EAAK4iB,QAAQS,WAAWP,OAOpCtP,EAAM4Q,YAGVlU,EAAQ1C,OACL,CACH2C,EAAO7P,MAAM,sCACR4iB,GACDljB,EAAKqC,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAM4G,sBAMjDH,EAASuS,WAAa,SAAUpjB,EAAI8D,GAGhC,GAFWzF,KAEFyH,oBAAoBhC,GACzB,OAHOzF,KAGKiX,YAAYtV,EAAI8D,GAEzB,GALIzF,KAKKgN,qBAAqBvH,GAAW,CALrCzF,KAMF8R,qBAAqBrM,EANnBzF,KAMkCgN,qBAAqBvH,GANvDzF,MAOP,OAPOA,KAOKiX,YAAYtV,EAAI8D,GAE5Buf,MAAM,0CAAyCvf,IAyCvD+M,EAAShE,gBAAkB,SAAU7M,GACjC,IACIuM,EAAO,GACX,GAAI,6CAA6CpG,KAAKnG,IAAO,+DAA+DmG,KAAKnG,GAAK,CAElIuM,EAAKrE,OAAS,CACVtJ,KAAMN,GAAG0F,OAAOkP,UAAUC,OAC1BhT,OAAQ,CACJiT,OAAQ,CACJ9I,IARLjM,KAQewT,aAAazE,KAR5B/O,KAQuC,SAAU,OAAO,MAK/DkO,EAAK0W,gBAAkB,yCAbhB5kB,KAagEsV,aAAe,aAnD9E,SAAU3T,GACtB,IAAIjB,EAAOV,KAEXwjB,KAAO9iB,EAAK4iB,QAAQG,UAEpB,IAEI9gB,EACAsiB,EAHAzV,EAAQ9O,EAAK0c,SAASzb,GAK1B,GAAI6N,EAAO,CACP7M,EAAQjC,EAAK6c,SAAS5b,GACtBsjB,EAAUvkB,EAAKwT,MAAMgR,UAAU1V,EAAOvP,GAAGW,KAAKC,OAAO,GAAIH,EAAKqC,IAAIvC,QAAQsB,OAAO0N,MAAO,CAAE7M,MAAOA,EAAOwiB,MAAOxiB,SAC5G,CACH,IAAI2G,EAAQ,2DAA2DJ,KAAKvH,GAC5EA,EAAKjB,EAAK2L,IAAM/C,EAAM,GAAK5I,EAAK0L,IAAM9C,EAAM,GAG5C,GAFAkG,EAAQ9O,EAAK0c,SAASzb,GAEX,CACPgB,EAAQjC,EAAK6c,SAAS5b,GACtBsjB,EAAUvkB,EAAKwT,MAAMgR,UAAU1V,EAAOvP,GAAGW,KAAKC,OAAO,GAAIH,EAAKqC,IAAIvC,QAAQsB,OAAO0N,MAAO,CAAE7M,MAAOA,EAAOwiB,MAAOxiB,KAE/GjC,EAAKiV,UAAU/N,MAAQjF,GAI/BsiB,EAAQ5T,KAAK,SAAU+T,GACnB1kB,EAAKqC,IAAIiR,QAAQ/T,GAAG0F,OAAOoG,MAAMkI,YAAa,CAC1CC,MAAOxT,EAAKwT,MAAO1C,SAAU,CAAC4T,KAGlC1kB,EAAKqC,IAAIgX,eAAe,CAACqL,IAEzB1kB,EAAK4iB,QAAQS,WAAWP,UAoBd3gB,KAfH7C,KAec2B,GAErB,OAAOuM,EAGX,OAAO,MAGXsE,EAASrE,iBAAmB,SAAUxM,GAClC,IACIuM,EAAO,GAEP3F,EAAQ,IAAIC,OAAO,IAHZxI,KAGuB0M,IAAM,SAH7B1M,KAG6C2M,IAAM,aAHnD3M,KAGuE4M,IAAM,iBACxF,GAAIrE,EAAMT,KAAKnG,GAAK,CAChB,IAAI2H,EAAQf,EAAMW,KAAKvH,GAElB1B,GAAGuF,QACJvF,GAAGG,WAAWH,GAAGI,YAAc,aAGnC,IAAIE,EAXGP,KAWSyH,oBAAoBxH,GAAG0F,OAAOoD,WAAWkE,WAEzDiB,EAAKrE,OAAS,CACVtJ,KAAMN,GAAG0F,OAAOkP,UAAU7O,IAC1BiG,IAAK1L,EAAK0L,IACV/B,QAAS3J,EAAK2J,QACdiD,aAAc5M,EAAK4M,aACnBjH,cAAe3F,EAAK2F,cACpB/E,YAAaZ,EAAKY,YAClBkD,WAAY,IAAIpE,GAAGuF,OAAOkG,IACtB,IAAIzL,GAAGuF,OAAO+F,QAAQhL,EAAK0G,gBAAgBC,eAAgBoC,EAAM,GAAG5F,QACpE,IAAIzD,GAAGuF,OAAO+F,QAAQhL,EAAK0G,gBAAgBoC,gBAAiBC,EAAM,GAAG5F,QACrE,IAAIzD,GAAGuF,OAAO+F,QAAQhL,EAAK0G,gBAAgBuC,eAAgBF,EAAM,GAAG5F,SACxEgC,aAAcnF,EAAKmF,aACnB5D,OAAQvB,EAAKuB,QAGjBoM,EAAK0W,gBAAkB,iBA5BhB5kB,KA4BwCqV,oBAAsB,oCA5B9DrV,KA4ByGoV,oBAAsB,YAEtI,OAAOlH,EAGX,OAAO,MAGXsE,EAASlC,SAAW,SAAU3O,GAC1B,IACIuM,EAAO,GAEP3N,EAHOP,KAGKyH,oBAAoBxH,GAAG0F,OAAOoD,WAAWqH,MAEzDlC,EAAKrE,OAAS,CACVtJ,KAAMN,GAAG0F,OAAOkP,UAAU7O,IAC1BiG,IAAK1L,EAAK0L,IACV/B,QAAS3J,EAAK2J,QACdiD,aAAc5M,EAAK4M,aACnBjH,cAAe3F,EAAK2F,cACpB/E,YAAaZ,EAAKU,kBAClBokB,YAAa,IACbhhB,WAAY9D,EAAKiF,OAAOyF,cAActJ,GACtC+D,aAAcnF,EAAKmF,aACnB5D,OAAQvB,EAAKuB,QAGjBoM,EAAK0W,gBAAkB,iBAlBZ5kB,KAkBoCqV,oBAAsB,oCAlB1DrV,KAkBqGoV,oBAAsB,YAEtI,OAAOlH,GAGXsE,EAAS/B,OAAS,SAAU9O,GACxB,IACIuM,EAAO,GAEP3N,EAHOP,KAGKyH,oBAAoBxH,GAAG0F,OAAOoD,WAAWwH,QAEzDrC,EAAKrE,OAAS,CACVtJ,KAAMN,GAAG0F,OAAOkP,UAAU7O,IAC1BiG,IAAK1L,EAAK0L,IACV/B,QAAS3J,EAAK2J,QACdiD,aAAc5M,EAAK4M,aACnBjH,cAAe3F,EAAK2F,cACpB/E,YAAaZ,EAAKU,kBAClBokB,YAAa,IACbhhB,WAAY9D,EAAKiF,OAAOyF,cAActJ,GACtC+D,aAAcnF,EAAKmF,aACnB5D,OAAQvB,EAAKuB,QAGjBoM,EAAK0W,gBAAkB,iBAlBZ5kB,KAkBoCqV,oBAAsB,oCAlB1DrV,KAkBqGoV,oBAAsB,YAEtI,OAAOlH,GAGXsE,EAASrD,kBAAoB,SAAUxN,EAAI8D,GACvC,IACIyI,EAAO,GAEP3N,EAHOP,KAGKyH,oBAAoBhC,GAEpCyI,EAAKrE,OAAS,CACVtJ,KAAMN,GAAG0F,OAAOkP,UAAU7O,IAC1BiG,IAAK1L,EAAK0L,IACV/B,QAAS3J,EAAK2J,QACdiD,aAAc5M,EAAK4M,aACnBjH,cAAe3F,EAAK2F,cACpB/E,YAAaZ,EAAKU,kBAClBokB,YAAa,IACbhhB,WAAY9D,EAAKiF,OAAOyF,cAActJ,GACtC+D,aAAcnF,EAAKmF,aACnB5D,OAAQvB,EAAKuB,QAGjB,OAAOoM,GAGXsE,EAAS4K,SAAW,SAAU/W,GAC1B,IAEImJ,EADA8V,EADOtlB,KACS+C,IAAI+C,KAAKyf,QAEzBjc,EAAQ,qCAAqCJ,KAAK7C,GACtD,GAAIiD,GAA0B,IAAjBA,EAAMjI,OAAc,CAC7BmO,EAAQ,CAACgW,WAAWlc,EAAM,IAAKkc,WAAWlc,EAAM,KAC5Cgc,IACA9V,EAAQvP,GAAGW,KAAK6kB,UAAUjW,EAPvBxP,KAOmC+C,IAAIvC,QAAQklB,OAP/C1lB,KAO4D+C,IAAIua,UAGtE,CAED,IADAhU,EAAQ,+DAA+DJ,KAAK7C,KAC9C,IAAjBiD,EAAMjI,OAAc,CAC7BmO,EAAQ,CAACgW,WAAWlc,EAAM,IAAKkc,WAAWlc,EAAM,KAChD,IAAKgc,EACD,OAAOrlB,GAAGW,KAAK6kB,UAAUjW,EAf1BxP,KAesC+C,IAAIvC,QAAQmlB,OAflD3lB,KAe+D+C,IAAIua,KAK1E,IADAhU,EAAQ,+DAA+DJ,KAAK7C,KAC9C,IAAjBiD,EAAMjI,OAAc,CAC7BmO,EAAQ,CAACgW,WAAWlc,EAAM,IAAKkc,WAAWlc,EAAM,KAChD,IAAKgc,EACD,OAAOrlB,GAAGW,KAAK6kB,UAAUjW,EAvB1BxP,KAuBsC+C,IAAIvC,QAAQmlB,OAvBlD3lB,KAuB+D+C,IAAIua,MAK9E,OAAO9N,GAGXgD,EAAS6K,YAAc,SAAU7N,GAQ7B,QAN0B,SAAUkV,EAAQlV,GACxC,QAAIkV,aAAkBtjB,QACXoO,EAAM,IAAMkV,EAAO,IAAMlV,EAAM,IAAMkV,EAAO,IAAMlV,EAAM,IAAMkV,EAAO,IAAMlV,EAAM,IAAMkV,EAAO,GAIzGkB,CAPO5lB,KAOkB+C,IAAIvC,QAAQqlB,UAAWrW,IAOxDgD,EAASpM,WAAa,WAElB,OADWpG,KACC2V,UAAU/N,OAG1B4K,EAAS+K,SAAW,SAAU5b,GAC1B,IACI2R,EAAS3R,EACTmkB,EAAS7lB,GAAGW,KAAKmlB,aAFV/lB,KAE4B+C,KAEvC,GAAIpB,EAAG2H,MAAM,IAAId,OAAO,OAJbxI,KAI2BqM,IAAM,cAJjCrM,KAIsDkM,KAAO,WAAY,EAE5E5C,GADJgK,EAASA,EAAOvL,QALT/H,KAKsBqM,IALtBrM,KAKgCyM,WAAW1E,QAL3C/H,KAKwDoM,IAAK,IAL7DpM,KAKwEwM,WAAWzE,QALnF/H,KAKgGkM,KALhGlM,KAK2GsM,YAAYvE,QALvH/H,KAKoImM,KAAM,IAL1InM,KAKqJuM,aACzIjD,MAAM,IAAId,OAAO,IAN7BxI,KAMwCyM,UAAU/I,OAAS,0CAN3D1D,KAM4GwM,UAAU9I,OAAS,wCAGlI4P,GADAA,EAASA,EAAOvL,QAAQuB,EAAM,GAAIkc,WAAWlc,EAAM,IAAI0c,eAAeF,KACtD/d,QAAQuB,EAAM,GAAIkc,WAAWlc,EAAM,IAAI0c,eAAeF,KAG1E,IAAIG,EAAyB,IAAID,eAAeF,GAAQvc,UAAU,EAAG,GAErE,GADID,EAAQgK,EAAOhK,MAAM,IAAId,OAAO,IAb7BxI,KAawCsM,WAAW5I,OAAS,eAb5D1D,KAakFgS,SAAW,8BAb7FhS,KAakIuM,WAAW7I,OAAS,eAbtJ1D,KAa4KiS,SAAW,qBACnL,CACFiU,OAAOC,UAAUX,WAAWlc,EAAM,OACnCgK,EAASA,EAAOvL,QAAQuB,EAAM,GAAIA,EAAM,GAAGvB,QAAQ,IAAKke,KACvDC,OAAOC,UAAUX,WAAWlc,EAAM,OACnCgK,EAASA,EAAOvL,QAAQuB,EAAM,GAAIA,EAAM,GAAGvB,QAAQ,IAAKke,WAG7D,GAAItkB,EAAG2H,MAAM,IAAId,OAAO,OArBpBxI,KAqBkCoM,IAAM,YAAa,EAGxD9C,GAFJgK,EAASA,EAAOvL,QAtBT/H,KAsBsBoM,IAtBtBpM,KAsBgCwM,WAAWzE,QAtB3C/H,KAsBwDqM,IAAK,IAtB7DrM,KAsBwEyM,YAE5DnD,MAAM,IAAId,OAAO,IAxB7BxI,KAwBwCwM,UAAU9I,OAAS,0CAxB3D1D,KAwB4GyM,UAAU/I,OAAS,wCAGlI4P,GADAA,EAASA,EAAOvL,QAAQuB,EAAM,GAAIkc,WAAWlc,EAAM,IAAI0c,eAAeF,KACtD/d,QAAQuB,EAAM,GAAIkc,WAAWlc,EAAM,IAAI0c,eAAeF,UAGvE,GAAInkB,EAAG2H,MAAM,IAAId,OAAO,UA9BpBxI,KA8BqC0M,IAAM,cA9B3C1M,KA8BqE2M,IAAM,oBA9B3E3M,KA8BgH4M,IAAM,oBAA0B,CACvJ,IAAItD,EAAQ3H,EAAG2H,MAAM,IAAId,OAAO,UA/BzBxI,KA+B0C0M,IAAM,cA/BhD1M,KA+B0E2M,IAAM,oBA/BhF3M,KA+BqH4M,IAAM,oBAClI0G,EAhCOtT,KAgCO6M,UAAYvD,EAAM,GAAK,KAhC9BtJ,KAgC0C8M,UAAYxD,EAAM,GAAK,KAhCjEtJ,KAgC6E+M,UAAYzD,EAAM,GAE1G,OAAOgK,GAGXd,EAASuL,kBAAoB,SAAU5Y,GACnCA,EAAOA,GAAQ,GA0Bf,IAzBA,IAAImO,EAAS,IAAIlS,MAAM+D,EAAK9D,QACxB0B,EAAM,CACNqjB,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,IACLC,OAAK,KAEAplB,EAAI,EAAGqlB,EAAMviB,EAAK9D,OAAQgB,EAAIqlB,EAAKrlB,IACxCiR,EAAOjR,GAAKU,EAAIoC,EAAK6a,OAAO3d,KAAO8C,EAAK6a,OAAO3d,GAEnD,OAAOiR,EAAOpQ,KAAK,KAGvBsP,EAASmV,YAAc,WACnB,MAAMjnB,EAAOV,KACb,OAAIU,EAAKoL,aACE,CACHnK,GAAIjB,EAAKiB,GACTimB,WAAYlnB,EAAKiV,UAAU/N,MAC3BsM,MAAOxT,EAAKwT,MAAMyT,YAAY,CAC1BE,cAAc,KAInB,MAGXrV,EAASsV,YAAc,SAAUC,GAC7B,MAAMrnB,EAAOV,KACbU,EAAKiV,UAAU/N,MAAQmgB,EAAMH,WAC7BlnB,EAAKwT,MAAM4T,YAAYC,EAAM7T,OAAO7C,KAAK,WACrC3Q,EAAKwT,MAAM1C,SAASxN,QAAQ,SAAU0E,GAClCA,EAAEsf,SAAS,WAtvE3B,GA8vEKC,OAAOxV,UAAUvN,WAClB+iB,OAAOxV,UAAUvN,SAAW,WACxB,IAAIgjB,GAAQrc,WAAa,CAAC,KAAK,GAC/B,OAAO7L,KAAK+H,QAAQ,WAAY,SAAUuB,EAAO6e,GAC7C,YAA8B,IAAhBD,EAAKC,GACfD,EAAKC,GACH7e,MAOb2e,OAAOxV,UAAU2V,yBAClBH,OAAOxV,UAAU2V,uBAAyB,SAAUC,GAGhD,IAFA,IAAIC,EAAO,GACPzd,EAAM7K,KAAK4E,MAAMyjB,GACZhmB,EAAI,EAAGA,EAAIwI,EAAIxJ,OAAQgB,IACxBwI,EAAIxI,GAAGqB,OAAOrC,OAAS,GACvBinB,EAAKxkB,KAAK+G,EAAIxI,GAAGqB,QAEzB,OAAO4kB,IAKVL,OAAOxV,UAAUrN,cAClB6iB,OAAOxV,UAAUrN,YAAc,WAC3B,IAAImjB,EAASvoB,KAAKiI,cACdqB,EAAQtJ,KAAKiI,cAAcqB,MAAM,8GACrC,GAAIA,EACA,IAAK,IAAIjH,EAAI,EAAGA,EAAIiH,EAAMjI,OAAQgB,IAC1B,0BAA0ByF,KAAKwB,EAAMjH,MACrCkmB,EAASA,EAAOxgB,QAAQuB,EAAMjH,GAAIiH,EAAMjH,GAAG6F,gBAIvD,OAAOqgB,EAAOvI,OAAO,GAAG9X,cAAgBqgB,EAAOhf,UAAU,KAK5DnI,MAAMqR,UAAUrQ,eAAe,mBAChCmI,OAAOie,eAAepnB,MAAMqR,UAAW,iBAAkB,CACrDgW,YAAY,EACZC,UAAU,EACV9gB,MAAO,SAAUJ,EAAcI,GAC3B,IAAK,IAAIvF,EAAI,EAAGA,EAAIrC,KAAKqB,OAAQgB,IAC7B,GAAIrC,KAAKqC,GAAGmF,IAAiBI,EACzB,OAAO5H,KAAKqC,MAM3B4lB,OAAOxV,UAAUkW,WAClBV,OAAOxV,UAAUkW,SAAW,SAAUC,EAAcC,GAChD,IAAIC,EAAgB9oB,KAAKgI,YACD,iBAAb6gB,IAA0BE,SAASF,IAAaG,KAAKC,MAAMJ,KAAcA,GAAYA,EAAWC,EAAcznB,UACrHwnB,EAAWC,EAAcznB,QAE7BwnB,GAAYD,EAAavnB,OACzB,IAAI6nB,EAAYJ,EAAclnB,QAAQgnB,EAAcC,GACpD,OAAsB,IAAfK,GAAoBA,IAAcL","sourcesContent":["(function () {\r\n    // Polyfill window.performance.now\r\n    if (!window.performance) {\r\n        window.performance = {\r\n            offset: Date.now(),\r\n            now: function () {\r\n                return Date.now() - this.offset;\r\n            }\r\n        };\r\n    } else if (window.performance && !window.performance.now) {\r\n        window.performance.offset = Date.now();\r\n        window.performance.now = function () {\r\n            return Date.now() - window.performance.offset;\r\n        };\r\n    }\r\n}());\r\n\r\nTC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\n\r\nvar SearchType = function (type, options, parent) {\r\n    var self = this;\r\n\r\n    self.parent = parent;\r\n\r\n    self._featureTypes = [];\r\n\r\n    TC.Util.extend(self, options);\r\n\r\n    self.typeName = type;\r\n\r\n    self._throwConfigError = function () {\r\n        var self = this;\r\n\r\n        throw new Error('Error en la configuración de la búsqueda: ' + self.typeName);\r\n    };\r\n\r\n    self.getFeatureTypes = function (toFilter) {\r\n        var self = this;\r\n\r\n        if (toFilter) {\r\n            return self.featureType instanceof Array ? self.featureType : [self.featureType];\r\n        }\r\n\r\n        if (self._featureTypes.length === 0) {\r\n            var type_featureType = self.featureType instanceof Array ? self.featureType : [self.featureType];\r\n            var type_renderFeatureType = self.renderFeatureType ? self.renderFeatureType instanceof Array ? self.renderFeatureType : [self.renderFeatureType] : [];\r\n            self._featureTypes = type_featureType.concat(type_renderFeatureType);\r\n        }\r\n\r\n        return self._featureTypes;\r\n    };\r\n\r\n    self.isFeatureOfThisType = function (id) {\r\n        var self = this;\r\n\r\n        return self.getFeatureTypes().indexOf(id) > -1;\r\n    };\r\n\r\n    self.getStyleByFeatureType = function (featureType) {\r\n        var self = this;\r\n\r\n        if (self.getFeatureTypes().indexOf(featureType) > -1) {\r\n            return self.styles[self.getFeatureTypes().indexOf(featureType)];\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    var getColor = function (css, geomType, featureType) {\r\n        var self = this;\r\n\r\n        var getValue = function (style, geomType, css) {\r\n            if (geomType) {\r\n                if (style.hasOwnProperty(geomType) && style[geomType].hasOwnProperty(css)) {\r\n                    return style[geomType][css];\r\n                }\r\n            } else {\r\n                for (var geomType in style) {\r\n                    if (style[geomType].hasOwnProperty(css)) {\r\n                        return style[geomType][css];\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        if (featureType) {\r\n            var style = self.getStyleByFeatureType(featureType);\r\n            return getValue(style, geomType, css);\r\n        } else {\r\n            for (var i = 0; i < self.styles.length; i++) {\r\n                var style = self.styles[i];\r\n                var color = getValue(style, geomType, css);\r\n                if (color) {\r\n                    return color;\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    self.getSuggestionListHead = function () {\r\n        var self = this;\r\n\r\n        var headerData, label, color;\r\n\r\n        if (typeof self.suggestionListHead === \"function\") {\r\n            headerData = self.suggestionListHead();\r\n            label = headerData.label;\r\n            color = [{\r\n                color: headerData.color,\r\n                title: headerData.label\r\n            }];\r\n        } else {\r\n            headerData = self.suggestionListHead;\r\n            label = self.parent.getLocaleString(headerData.label);\r\n\r\n            // color es string que es el atributo CSS. El valor se obtiene de la 1º coincidencia encontrada en styles\r\n            if (typeof headerData.color === \"string\") {\r\n                color = [{\r\n                    color: getColor.call(self, headerData.color),\r\n                    title: label\r\n                }];\r\n            } else if (headerData.color instanceof Array) { // color es un array de objetos, con nombre de featureType como clave\r\n                var featureTypes = self.getFeatureTypes();\r\n                if (headerData.color.length === featureTypes.length) {\r\n                    color = headerData.color.map(function (elm, i) {\r\n                        return {\r\n                            color: getColor.call(self, elm[featureTypes[i]].color.css, elm[featureTypes[i]].color.geomType, featureTypes[i]),\r\n                            title: self.parent.getLocaleString(elm[featureTypes[i]].title) || label\r\n                        }\r\n                    });\r\n                } else {\r\n                    self._throwConfigError();\r\n                }\r\n            } else if (typeof headerData.color === \"object\") { // color es un objeto con atributo css y tipo de geometría\r\n                color = [{\r\n                    color: getColor.call(self, headerData.color.css, headerData.color.geomType),\r\n                    title: label\r\n                }];\r\n            }\r\n        }\r\n\r\n        if (label && color) {\r\n            var liHTML = '<li header><span class=\"header\">' + label + '</span>';\r\n\r\n            liHTML += color.map(function (elm) {\r\n                if (elm.color) {\r\n                    return '<span class=\"header-color\" title=\"' + elm.title + '\" style=\"color: ' + elm.color + ';\"></span>';\r\n                }\r\n            }).join('') + '</li>';\r\n\r\n            return liHTML;\r\n\r\n        } else {\r\n            self._throwConfigError();\r\n        }\r\n    };\r\n\r\n    self.getSuggestionListElements = function (data) {\r\n        var self = this;\r\n        var results = [];\r\n\r\n        var areSame = function (a, b) {\r\n            switch (true) {\r\n                case typeof (a) === \"number\":\r\n                    if (a === b) {\r\n                        return true;\r\n                    }\r\n                    break;\r\n                case typeof (a) === \"string\":\r\n                    if (!isNaN(a) || !isNaN(b)) {\r\n                        if (a === b) {\r\n                            return true;\r\n                        }\r\n                    } else {\r\n                        if (a.trim() === b.trim()) {\r\n                            return true;\r\n                        }\r\n                    }\r\n                    break;\r\n            }\r\n\r\n            return false;\r\n        };\r\n        var getUnique = function (inputArray) {\r\n            var outputArray = [];\r\n            for (var i = 0; i < inputArray.length; i++) {\r\n                if (outputArray.indexOf(inputArray[i]) === -1) {\r\n                    outputArray.push(inputArray[i]);\r\n                }\r\n            }\r\n\r\n            return outputArray;\r\n        };\r\n        var intoResults = function (compareData) {\r\n            for (var r = 0; r < results.length; r++) {\r\n                var length = 0;\r\n                var isThere = [];\r\n                for (var property in compareData) {\r\n                    isThere.push(areSame(compareData[property], results[r].properties[property]));\r\n                    length++;\r\n                }\r\n                if (isThere.filter(function (i) { return i; }).length === length) {\r\n                    return true;\r\n                }\r\n\r\n            }\r\n\r\n            return false;\r\n        };\r\n\r\n        var features = self.parseFeatures(data);\r\n\r\n        features.forEach(function (feature) {\r\n            var attributes = [], ids = [];\r\n            var valueToAdd = '';\r\n\r\n            var properties = self.outputProperties;\r\n            var dataIdProperties = self.dataIdProperty;\r\n\r\n            var strFormat = self.outputFormatLabel;\r\n            var dataLayer = feature.id.split('.').slice(0, 1).shift();\r\n\r\n            if (!(self.outputProperties instanceof Array)) {\r\n                properties = self.outputProperties[dataLayer];\r\n                dataIdProperties = self.dataIdProperty[dataLayer];\r\n                strFormat = strFormat[dataLayer];\r\n            }\r\n\r\n            for (var j = 0; j < properties.length; j++) {\r\n                attributes.push(feature.data[properties[j]]);\r\n            }\r\n\r\n            for (var j = 0; j < dataIdProperties.length; j++) {\r\n                ids.push(feature.data[dataIdProperties[j]]);\r\n            }\r\n\r\n            var compareData = {};\r\n            for (var p = 0; p < self.outputProperties.length; p++) {\r\n                compareData[self.outputProperties[p]] = attributes[p];\r\n            }\r\n\r\n            if (attributes instanceof Array && strFormat && getUnique(attributes).length > 1) {\r\n                valueToAdd = strFormat.tcFormat(attributes);\r\n            }\r\n            else if (attributes instanceof Array && getUnique(attributes).length == 1) {\r\n                valueToAdd = attributes[0];\r\n            }\r\n\r\n            var text = valueToAdd.toCamelCase();\r\n\r\n            if (!(intoResults(compareData))) {\r\n\r\n                results.push({\r\n                    text: text,\r\n                    label: text,\r\n                    id: ids.join('#'),\r\n                    dataRole: self.typeName,\r\n                    dataLayer: dataLayer,\r\n                    properties: compareData\r\n                });\r\n            }\r\n        });\r\n\r\n        return results;\r\n    };\r\n\r\n    self.parseFeatures = function (data) {\r\n        var parser;\r\n        if (self.outputFormat === TC.Consts.format.JSON) {\r\n            parser = new TC.wrap.parser.JSON();\r\n        }\r\n        else {\r\n            parser = new TC.wrap.parser.WFS({\r\n                featureNS: self.featurePrefix,\r\n                featureType: self.featureType\r\n            });\r\n        }\r\n        return parser.read(data);\r\n    };\r\n\r\n    self.getPattern = function () {\r\n        var self = this;\r\n\r\n        if (typeof self.pattern === \"function\") {\r\n            return self.pattern();\r\n        } else {\r\n            return self.pattern;\r\n        }\r\n    };\r\n\r\n    self.filter = (function (self) {\r\n\r\n        const bindRootFilterNode = function (filtersArr, dataT) {\r\n            var rootFilters = [];\r\n\r\n            if (dataT != self.parent.rootCfg.active.root) {\r\n                // GLS: Si llego aquí, significa que el usuario está indicando la población\r\n                if (dataT.indexOf('#') === -1 && !self.parent.rootCfg.active.limit) { // si no está limitada la búsqueda, indico la población\r\n\r\n                    var filterNode = self.parent.rootCfg.active.queryProperties.firstQueryWord.map(function (queryWord, index) {\r\n                        return self.filter.getFilterNode(queryWord, self.parent._LIKE_PATTERN + dataT + self.parent._LIKE_PATTERN);\r\n                    });\r\n\r\n                    if (filterNode.length > 1) {\r\n                        rootFilters.push('<ogc:And>');\r\n                        rootFilters = rootFilters.concat(filterNode);\r\n                        rootFilters.push('</ogc:And>');\r\n                    } else {\r\n                        rootFilters = rootFilters.concat(filterNode);\r\n                    }\r\n\r\n                } else { // por tanto no añado todas las raíces posibles, añado la población que ha indicado (validando antes contra rootLabel)                     \r\n                    var item = dataT.split('#');\r\n\r\n                    for (var j = 0; j < self.parent.rootCfg.active.dataIdProperty.length; j++) {\r\n\r\n                        if (j == 0 && self.parent.rootCfg.active.dataIdProperty.length > 1) {\r\n                            rootFilters.push('<ogc:And>');\r\n                        }\r\n\r\n                        rootFilters.push(self.filter.getFilterNode(self.parent.rootCfg.active.dataIdProperty[j], item.length > j ? item[j] : item[0]));\r\n\r\n                        if (j == self.parent.rootCfg.active.dataIdProperty.length - 1 && self.parent.rootCfg.active.dataIdProperty.length > 1) {\r\n                            rootFilters.push('</ogc:And>');\r\n                        }\r\n                    }\r\n                }\r\n            } else {\r\n                for (var i = 0; i < self.parent.rootCfg.active.root.length; i++) {\r\n                    var item = self.parent.rootCfg.active.root[i];\r\n\r\n                    if (i == 0 && self.parent.rootCfg.active.root.length > 1) {\r\n                        rootFilters.push('<ogc:Or>');\r\n                    }\r\n\r\n                    for (var j = 0; j < self.parent.rootCfg.active.dataIdProperty.length; j++) {\r\n\r\n                        if (j == 0 && self.parent.rootCfg.active.dataIdProperty.length > 1) {\r\n                            rootFilters.push('<ogc:And>');\r\n                        }\r\n\r\n                        rootFilters.push(self.filter.getFilterNode(self.parent.rootCfg.active.dataIdProperty[j], item.length > j ? item[j] : item[0]));\r\n\r\n                        if (j == self.parent.rootCfg.active.dataIdProperty.length - 1 && self.parent.rootCfg.active.dataIdProperty.length > 1) {\r\n                            rootFilters.push('</ogc:And>');\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (self.parent.rootCfg.active.root.length > 1) {\r\n                    rootFilters.push('</ogc:Or>');\r\n                }\r\n            }\r\n\r\n            return filtersArr.concat(rootFilters);\r\n        };\r\n\r\n        return {\r\n            getPropertyValue: function (role, propertyName) {\r\n                return self.getSearchTypeByRole(role)[propertyName];\r\n            },\r\n            getIsLikeNode: function (name, value) {\r\n                var toEscape = /([\\-\\\"\\.\\xba\\(\\)\\/])/g;\r\n                if (toEscape.test(value)) {\r\n                    value = value.replace(toEscape, \"\\\\$1\");\r\n                }\r\n\r\n                if (value.toString().indexOf(self.parent._LIKE_PATTERN) > -1)\r\n                    return '<Or><PropertyIsLike escape=\"\\\\\" singleChar=\"_\" wildCard=\"*\" matchCase=\"false\">' +\r\n                        '<PropertyName>' + name + '</PropertyName>' +\r\n                        '<Literal>' + value.toLowerCase().replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</Literal>' +\r\n                        '</PropertyIsLike>' +\r\n                        '<PropertyIsLike escape=\"\\\\\" singleChar=\"_\" wildCard=\"*\" matchCase=\"false\">' +\r\n                        '<PropertyName>' + name + '</PropertyName>' +\r\n                        '<Literal>' + value.toUpperCase().replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</Literal>' +\r\n                        '</PropertyIsLike></Or>';\r\n                else\r\n                    return '<PropertyIsEqualTo>' +\r\n                        '<PropertyName>' + name + '</PropertyName>' +\r\n                        '<Literal>' + value.replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</Literal>' +\r\n                        '</PropertyIsEqualTo>';\r\n            },\r\n            getFunctionStrMatches: function (name, value) {\r\n                var toEscape = /([\\-\\\"\\xba\\(\\)\\/])/g;\r\n                if (toEscape.test(value)) {\r\n                    value = value.replace(toEscape, \"\\\\$1\");\r\n                }\r\n\r\n                if (value.toString().indexOf(self.parent._LIKE_PATTERN) > -1) {\r\n\r\n                    var pattern = value;\r\n                    pattern = pattern.replace(/a/gi, \"[aáà]\");\r\n                    pattern = pattern.replace(/e/gi, \"[eéè]\");\r\n                    pattern = pattern.replace(/i/gi, \"[iíì]\");\r\n                    pattern = pattern.replace(/o/gi, \"[oóò]\");\r\n                    pattern = pattern.replace(/u/gi, \"[uúüù]\");\r\n\r\n                    return '<ogc:PropertyIsEqualTo> ' +\r\n                        '<ogc:Function name=\"strMatches\"> ' +\r\n                        '<ogc:PropertyName>' + name + '</ogc:PropertyName> ' +\r\n                        '<ogc:Literal>' + '(?i)' + pattern.replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</ogc:Literal> ' +\r\n                        '</ogc:Function> ' +\r\n                        '<ogc:Literal>true</ogc:Literal> ' +\r\n                        '</ogc:PropertyIsEqualTo>';\r\n                }\r\n                else {\r\n                    return '<PropertyIsEqualTo>' +\r\n                        '<PropertyName>' + name + '</PropertyName>' +\r\n                        '<Literal>' + value.replace(/\\</gi, \"&lt;\").replace(/\\>/gi, \"&gt;\") + '</Literal>' +\r\n                        '</PropertyIsEqualTo>';\r\n                }\r\n            },\r\n            getFilterNode: function (propertyName, propertyValue) {\r\n                var r;\r\n\r\n                var fn = self.filter.getIsLikeNode;\r\n\r\n                if (self.filterByMatch) {\r\n\r\n                    fn = self.filter.getFunctionStrMatches;\r\n\r\n                    var regex = new RegExp('\\\\' + self.parent._LIKE_PATTERN, 'gi');\r\n                    propertyValue = propertyValue.replace(regex, self.parent._MATCH_PATTERN);\r\n                }\r\n\r\n                if (!(propertyName instanceof Array) && (typeof propertyName !== 'string')) {\r\n                    var f = [];\r\n                    for (var key in propertyName) {\r\n                        if ((propertyName[key] instanceof Array) && propertyName[key].length > 1) {\r\n                            r = '<Or>';\r\n                            for (var i = 0; i < propertyName[key].length; i++) {\r\n                                r += fn(propertyName[key][i].trim(), propertyValue);\r\n                            }\r\n\r\n                            r += '</Or>';\r\n                            f.push('(<Filter xmlns=\"http://www.opengis.net/ogc\">' + r + '</Filter>)');\r\n                        } else {\r\n                            var propName = propertyName[key];\r\n                            if ((propertyName[key] instanceof Array) && propertyName[key].length == 1)\r\n                                propName = propertyName[key][0];\r\n\r\n                            f.push('(<Filter xmlns=\"http://www.opengis.net/ogc\">' +\r\n                                '<Or>' + fn(propName.trim(), propertyValue) + '</Or>' +\r\n                                '</Filter>)');\r\n                        }\r\n                    }\r\n\r\n                    return f.join('');\r\n\r\n                } else if (propertyName instanceof Array && propertyName.length > 1) {\r\n                    r = '<ogc:Or>';\r\n                    for (var i = 0; i < propertyName.length; i++) {\r\n                        r += fn(propertyName[i].trim(), propertyValue);\r\n                    }\r\n\r\n                    return r += '</ogc:Or>';\r\n                } else\r\n                    return fn((propertyName instanceof Array && propertyName.length === 1 ? propertyName[0].trim() : propertyName.trim()), propertyValue);\r\n            },\r\n            getFilter: function (data) {\r\n                var r = {};\r\n                r.multiL = false;\r\n                r.f = '';\r\n\r\n                var _f;\r\n\r\n                switch (true) {\r\n                    case self.typeName === TC.Consts.searchType.NUMBER:\r\n                        _f = [];\r\n                        if (!(self.parent.rootCfg.active) && (/(\\<|\\>|\\<\\>)/gi.exec(data.t) || /(\\<|\\>|\\<\\>)/gi.exec(data.s))) {\r\n                            var match = /(\\<|\\>|\\<\\>)/gi.exec(data.t);\r\n                            if (match)\r\n\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t.substring(0, data.t.indexOf(match[0])).trim() + self.parent._LIKE_PATTERN));\r\n                            else {\r\n                                if (self.parent.rootCfg.active) {\r\n                                    _f = bindRootFilterNode(_f, data.t);\r\n                                }\r\n                                else {\r\n                                    _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                                }\r\n                            }\r\n\r\n                            match = /(\\<|\\>|\\<\\>)/gi.exec(data.s);\r\n                            if (match)\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s.substring(0, data.s.indexOf(match[0])).trim() + self.parent._LIKE_PATTERN));\r\n                            else _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        }\r\n                        else {\r\n                            if (self.parent.rootCfg.active) {\r\n                                _f = bindRootFilterNode(_f, data.t);\r\n                            } else {\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                            }\r\n                            _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        }\r\n\r\n                        _f.push(self.filter.getFilterNode(self.queryProperties.thirdQueryWord, data.p + self.parent._LIKE_PATTERN));\r\n\r\n                        r.f = '<ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\">' + '<ogc:And>' + _f.join('') + '</ogc:And>' + '</ogc:Filter>';\r\n\r\n                        break;\r\n                    case self.typeName === TC.Consts.searchType.STREET:\r\n                        _f = [];\r\n\r\n                        if (!(self.parent.rootCfg.active) && (/(\\<|\\>|\\<\\>)/gi.exec(data.t) || /(\\<|\\>|\\<\\>)/gi.exec(data.s))) {\r\n                            var match = /(\\<|\\>|\\<\\>)/gi.exec(data.t);\r\n                            if (match)\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t.substring(0, data.t.indexOf(match[0])).trim() + self.parent._LIKE_PATTERN));\r\n                            else {\r\n                                if (self.parent.rootCfg.active) {\r\n                                    _f = bindRootFilterNode(_f, data.t);\r\n                                }\r\n                                else {\r\n                                    _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                                }\r\n                            }\r\n\r\n                            match = /(\\<|\\>|\\<\\>)/gi.exec(data.s);\r\n                            if (match)\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s.substring(0, data.s.indexOf(match[0])).trim() + self.parent._LIKE_PATTERN));\r\n                            else _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        } else {\r\n\r\n                            if (self.parent.rootCfg.active) {\r\n                                _f = bindRootFilterNode(_f, data.t);\r\n                            }\r\n                            else {\r\n                                _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                            }\r\n                            _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        }\r\n                        r.f = '<ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\">' + '<ogc:And>' + _f.join('') + '</ogc:And>' + '</ogc:Filter>';\r\n                        break;\r\n                    case self.typeName === TC.Consts.searchType.LOCALITY:\r\n                        r.f = self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN);\r\n                        r.multiL = true;\r\n                        break;                                            // GLS: consulta de 2 niveles (carretera con pk / topónimo con municipio)\r\n                    case self.queryProperties.hasOwnProperty('secondQueryWord'):\r\n                        var _f = [];\r\n                        _f.push(self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN));\r\n                        _f.push(self.filter.getFilterNode(self.queryProperties.secondQueryWord, self.parent._LIKE_PATTERN + data.s + self.parent._LIKE_PATTERN));\r\n                        r.f = '<ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\">' + '<ogc:And>' + _f.join('') + '</ogc:And>' + '</ogc:Filter>';\r\n                        break;\r\n                    default: // GLS: consulta de 1 único nivel (municipio, casco urbano, carretera)\r\n                        r.f = '<ogc:Filter xmlns:ogc=\"http://www.opengis.net/ogc\">' + self.filter.getFilterNode(self.queryProperties.firstQueryWord, self.parent._LIKE_PATTERN + data.t + self.parent._LIKE_PATTERN) + '</ogc:Filter>';\r\n                        break;\r\n                }\r\n\r\n                return r;\r\n            },\r\n            getParams: function (data) {\r\n                var filters = self.filter.getFilter(data);\r\n\r\n                var params = {\r\n                    REQUEST: 'GetFeature',\r\n                    SERVICE: 'WFS',\r\n                    MAXFEATURES: 500,\r\n                    VERSION: self.version,\r\n                    OUTPUTFORMAT: self.outputFormat\r\n                };\r\n\r\n                var featureTypes = self.getFeatureTypes(true);\r\n                if (!(featureTypes instanceof Array))\r\n                    params.TYPENAME = self.featurePrefix ? self.featurePrefix + ':' + featureTypes.trim() : featureTypes.trim();\r\n                else {\r\n                    var ft = [];\r\n                    for (var i = 0; i < featureTypes.length; i++) {\r\n                        ft.push(self.featurePrefix ?\r\n                            self.featurePrefix + ':' + featureTypes[i].trim() :\r\n                            featureTypes[i].trim());\r\n                    }\r\n\r\n                    params.TYPENAME = ft.join(',');\r\n                }\r\n\r\n                var _getProperties = function (properties) {\r\n                    if ((properties || '') !== '') {\r\n                        if (!(properties instanceof Array)) {\r\n                            var p = [];\r\n                            if (properties instanceof Object) {\r\n                                for (var key in properties) {\r\n                                    var prop = properties[key][0];\r\n                                    if (properties[key].length > 1)\r\n                                        prop = properties[key].join(',');\r\n\r\n                                    p.push(prop);\r\n                                }\r\n                            }\r\n                            return p;\r\n                        }\r\n                        else\r\n                            return properties.join(',');\r\n                    }\r\n                };\r\n                var _properties = _getProperties(self.outputProperties);\r\n                var _ids = _getProperties(self.dataIdProperty);\r\n\r\n                const removeDuplicates = (toCheck) => {\r\n                    const arr = toCheck.split(',');\r\n                    return arr.filter((item, i) => {\r\n                        return (arr.indexOf(item) === i);\r\n                    }).join(',');\r\n                };\r\n\r\n                if (_properties instanceof Array && _ids instanceof Array) {\r\n                    params.PROPERTYNAME = '';\r\n                    for (var i = 0; i < _properties.length; i++) {\r\n                        params.PROPERTYNAME += '(' + removeDuplicates(_properties[i] + ',' + _ids[i]) + ')';\r\n                    }\r\n                } else {\r\n                    params.PROPERTYNAME = removeDuplicates(_properties + ',' + _ids);\r\n                }\r\n\r\n                params.FILTER = filters.f;\r\n\r\n                return TC.Util.getParamString(params);\r\n            },\r\n            getGoToFilter: function (id) {\r\n                var props = [];\r\n                var _id = id.split('#');\r\n\r\n                var source = self.dataIdProperty;\r\n                var dataLayer = self.getFeatureTypes();\r\n\r\n                if (source && dataLayer) {\r\n\r\n                    if (id.indexOf('#') > -1 && dataLayer instanceof Array && dataLayer.length > 1) {\r\n                        for (var i = 0; i < dataLayer.length; i++) {\r\n\r\n                            for (var j = 0; j < source[dataLayer[i]].length; j++) {\r\n                                props.push({ name: source[dataLayer[i]][j], value: _id[j] });\r\n                            }\r\n                        }\r\n                    } else if (id.indexOf('#') == -1 && dataLayer instanceof Array) {\r\n                        var src = source;\r\n\r\n                        for (var i = 0; i < dataLayer.length; i++) {\r\n                            if (!props.hasOwnProperty(dataLayer[i])) {\r\n\r\n                                if (src instanceof Object && source.hasOwnProperty(dataLayer[i]))\r\n                                    src = source[dataLayer[i]];\r\n\r\n                                for (var j = 0; j < src.length; j++) {\r\n                                    if (j < _id.length)\r\n                                        props.push({ name: src[j], value: _id[j] });\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                    else {\r\n                        if (source instanceof Object && source.hasOwnProperty(dataLayer)) {\r\n                            source = source[dataLayer];\r\n                        }\r\n\r\n                        for (var i = 0; i < source.length; i++) {\r\n                            props.push({ name: source[i], value: _id[i] });\r\n                        }\r\n                    }\r\n                }\r\n\r\n                return self.filter.transformFilter(props);\r\n            },\r\n            transformFilter: function (properties) {\r\n                var self = this;\r\n\r\n                if (!TC.filter) {\r\n                    TC.syncLoadJS(TC.apiLocation + 'TC/Filter');\r\n                }\r\n\r\n                if (properties && properties instanceof Array) {\r\n                    var filters = properties.map(function (elm) {\r\n                        if (elm.hasOwnProperty(\"type\")) {\r\n                            switch (true) {\r\n                                case elm.type == TC.Consts.comparison.EQUAL_TO: {\r\n                                    return new TC.filter.equalTo(elm.name, elm.value);\r\n                                }\r\n                            }\r\n                        } else {\r\n                            return new TC.filter.equalTo(elm.name, elm.value);\r\n                        }\r\n                    });\r\n\r\n                    if (filters.length > 1) {\r\n                        return TC.filter.and.apply(null, filters);\r\n                    } else {\r\n                        return filters[0];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    })(self);\r\n};\r\n\r\nTC.control.Search = function () {\r\n    var self = this;\r\n    TC.Control.apply(self, arguments);\r\n\r\n    self.exportsState = true;\r\n\r\n    TC.Consts.event.TOOLSCLOSE = TC.Consts.event.TOOLSCLOSE || 'toolsclose.tc';\r\n\r\n    self.url = '//idena.navarra.es/ogc/wfs';\r\n    self.version = '1.1.0';\r\n    self.featurePrefix = 'IDENA';\r\n\r\n    if (self.options && self.options.url) {\r\n        self.url = self.options.url;\r\n    }\r\n\r\n    self._LIKE_PATTERN = '*';\r\n    self._MATCH_PATTERN = '.*';\r\n\r\n    self.UTMX = 'X';\r\n    self.UTMY = 'Y';\r\n    self.LON = 'Lon';\r\n    self.LAT = 'Lat';\r\n\r\n    self.UTMX_LABEL = 'X: ';\r\n    self.UTMY_LABEL = 'Y: ';\r\n    self.LON_LABEL = 'Lon: ';\r\n    self.LAT_LABEL = 'Lat: ';\r\n\r\n    self.MUN = 'Mun';\r\n    self.POL = 'Pol';\r\n    self.PAR = 'Par';\r\n\r\n    self.MUN_LABEL = 'Mun: ';\r\n    self.POL_LABEL = 'Pol: ';\r\n    self.PAR_LABEL = 'Par: ';\r\n\r\n    self.availableSearchTypes = {};\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.CADASTRAL] = {\r\n        suggestionRoot: null,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        searchWeight: 3,\r\n        featureType: ['CATAST_Pol_ParcelaUrba', 'CATAST_Pol_ParcelaRusti', 'CATAST_Pol_ParcelaMixta'],\r\n        municipality: {\r\n            featureType: 'CATAST_Pol_Municipio',\r\n            labelProperty: 'MUNICIPIO',\r\n            idProperty: 'CMUNICIPIO'\r\n        },\r\n        queryProperties: {\r\n            firstQueryWord: 'CMUNICIPIO',\r\n            secondQueryWord: 'POLIGONO',\r\n            thirdQueryWord: 'PARCELA'\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.cadastral\",\r\n            color: [\r\n                {\r\n                    CATAST_Pol_ParcelaUrba: {\r\n                        title: \"search.list.cadastral.urban\",\r\n                        color: {\r\n                            geomType: \"polygon\",\r\n                            css: \"strokeColor\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    CATAST_Pol_ParcelaRusti: {\r\n                        title: \"search.list.cadastral.rustic\",\r\n                        color: {\r\n                            geomType: \"polygon\",\r\n                            css: \"strokeColor\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    CATAST_Pol_ParcelaMixta: {\r\n                        title: \"search.list.cadastral.mixed\",\r\n                        color: {\r\n                            geomType: \"polygon\",\r\n                            css: \"strokeColor\"\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#136278',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            },\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#0c8b3d',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            },\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#e5475f',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                },\r\n            }\r\n        ],\r\n        parser: self.getCadastralRef,\r\n        goTo: self.goToCadastralRef,\r\n        goToIdFormat: self.MUN + '{0}' + self.POL + '{1}' + self.PAR + '{2}',\r\n        idPropertiesIdentifier: '#'\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.COORDINATES] = {\r\n        parser: self.getCoordinates,\r\n        goTo: self.goToCoordinates,\r\n        searchWeight: 4,\r\n        label: null,\r\n        suggestionListHead: function (text) {\r\n            return {\r\n                label: self.availableSearchTypes[TC.Consts.searchType.COORDINATES].label || self.getLocaleString('search.list.coordinates')\r\n            };\r\n        }\r\n    };\r\n\r\n    self.queryProperties = {\r\n        QUERYWORD: 'QueryWord',\r\n        FIRST: 'first',\r\n        SECOND: 'second',\r\n        THIRD: 'third'\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        url: '//idena.navarra.es/ogc/wfs',\r\n        featurePrefix: 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'CATAST_Pol_Municipio',\r\n        dataIdProperty: ['CMUNICIPIO'],\r\n        queryProperties: {\r\n            firstQueryWord: ['MUNINOAC', 'MUNICIPIO']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.municipality\",\r\n            color: \"strokeColor\"\r\n        },\r\n        outputProperties: ['MUNICIPIO'],\r\n        outputFormatLabel: '{0}',\r\n        searchWeight: 1,\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#fe06a5',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.MUNICIPALITY]),\r\n        stringPatternToCheck: self.stringPatternsValidators.s_or_t,\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    //self.availableSearchTypes[TC.Consts.searchType.LOCALITY] = {\r\n    //    root: null,\r\n    //    limit: false,\r\n    //    url: self.url || '//idena.navarra.es/ogc/wfs',\r\n    //    version: self.version || '1.1.0',\r\n    //    outputFormat: TC.Consts.format.JSON,\r\n    //    featurePrefix: self.featurePrefix || 'IDENA',\r\n    //    geometryName: 'the_geom',\r\n    //    featureType: ['CATAST_Pol_Municipio', 'ESTADI_Pol_EntidadPob'],\r\n    //    renderFeatureType: ['CATAST_Pol_Municipio'],\r\n    //    dataIdProperty: {\r\n    //        CATAST_Pol_Municipio: ['CMUNICIPIO'],\r\n    //        ESTADI_Pol_EntidadPob: ['CMUNICIPIO', 'CENTIDAD']\r\n    //    },\r\n    //    queryProperties: {\r\n    //        firstQueryWord: {\r\n    //            CATAST_Pol_Municipio: ['MUNINOAC', 'MUNICIPIO'],\r\n    //            ESTADI_Pol_EntidadPob: ['ENTINOAC', 'ENTIDAD']\r\n    //        }\r\n    //    },\r\n    //    suggestionListHead: {\r\n    //        label: \"search.list.locality\",\r\n    //        color: \"strokeColor\"\r\n    //    },\r\n    //    outputProperties: {\r\n    //        CATAST_Pol_Municipio: ['MUNICIPIO'],\r\n    //        ESTADI_Pol_EntidadPob: ['MUNICIPIO', 'ENTIDAD']\r\n    //    },\r\n    //    outputFormatLabel: {\r\n    //        CATAST_Pol_Municipio: '{0}',\r\n    //        ESTADI_Pol_EntidadPob: '{1} ({0})'\r\n    //    },\r\n    //    searchWeight: 1,\r\n    //    styles: [\r\n    //        {\r\n    //            polygon: {\r\n    //                fillColor: '#000000',\r\n    //                fillOpacity: 0,\r\n    //                strokeColor: '#ffffff',\r\n    //                strokeWidth: 5,\r\n    //                strokeOpacity: 1\r\n    //            }\r\n    //        },\r\n    //        {\r\n    //            polygon: {\r\n    //                fillColor: '#000000',\r\n    //                fillOpacity: 0.1,\r\n    //                strokeColor: '#feba1e',\r\n    //                strokeWidth: 2,\r\n    //                strokeOpacity: 1\r\n    //            }\r\n    //        }\r\n    //    ],\r\n    //    parser: self.getStringPattern.bind(this, [TC.Consts.searchType.LOCALITY]),\r\n    //    goTo: self.goToStringPattern\r\n    //};\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.COUNCIL] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'CATAST_Pol_Concejo',\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMUNICIPIO', 'CCONCEJO'],\r\n        queryProperties: {\r\n            firstQueryWord: ['CONCEJO']\r\n        },\r\n        outputProperties: ['MUNICIPIO', 'CONCEJO'],\r\n        outputFormatLabel: '{1} ({0})',\r\n        searchWeight: 4,\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.COUNCIL]),\r\n        stringPatternToCheck: self.stringPatternsValidators.s_or_t,\r\n        goTo: self.goToStringPattern,\r\n        idPropertiesIdentifier: '#',\r\n        suggestionListHead: {\r\n            label: \"search.list.council\",\r\n            color: \"strokeColor\"\r\n        },\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#49006a',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            }\r\n        ]\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.STREET] = {\r\n        root: null,\r\n        limit: null,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        renderFeatureType: 'CATAST_Txt_Calle',\r\n        featureType: 'CATAST_Lin_CalleEje',\r\n        dataIdProperty: ['CVIA'],\r\n        searchWeight: 5,\r\n        queryProperties: {\r\n            firstQueryWord: ['ENTINOAC', 'ENTIDADC'],\r\n            secondQueryWord: ['VIA', 'VIANOAC']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.street\",\r\n            color: \"strokeColor\"\r\n        },\r\n        outputProperties: ['ENTIDADC', 'VIA', 'CVIA', 'CENTIDADC', 'CMUNICIPIO'],\r\n        outputFormatLabel: '{1}, {0}',\r\n        styles: [\r\n            {\r\n                line: {\r\n                    strokeColor: \"#CB0000\",\r\n                    strokeOpacity: 1,\r\n                    strokeWidth: 2,\r\n                    strokeLinecap: \"round\",\r\n                    strokeDashstyle: \"solid\"\r\n                }\r\n            },\r\n            {\r\n                point: {\r\n                    label: \"VIA\",\r\n                    angle: \"CADANGLE\",\r\n                    fontColor: \"#000000\",\r\n                    fontSize: 10,\r\n                    fontWeight: \"bold\",\r\n                    labelOutlineColor: \"#FFFFFF\",\r\n                    labelOutlineWidth: 4\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.STREET]),\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.NUMBER] = {\r\n        root: null,\r\n        limit: null,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'CATAST_Txt_Portal',\r\n        renderFeatureType: '',\r\n        searchWeight: 6,\r\n        dataIdProperty: ['CMUNICIPIO', 'CENTIDADC', 'CVIA', 'PORTAL'],\r\n        queryProperties: {\r\n            firstQueryWord: ['ENTIDADC', 'ENTINOAC'],\r\n            secondQueryWord: ['VIA', 'VIANOAC'],\r\n            thirdQueryWord: ['PORTAL']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.number\",\r\n            color: \"fontColor\"\r\n        },\r\n        outputProperties: ['ENTIDADC', 'VIA', 'PORTAL', 'CVIA', 'CENTIDADC', 'CMUNICIPIO'],\r\n        outputFormatLabel: '{1} {2}, {0}',\r\n        styles: [\r\n            {\r\n                point: {\r\n                    radius: 0,\r\n                    label: \"PORTAL\",\r\n                    angle: \"CADANGLE\",\r\n                    fontColor: \"#CB0000\",\r\n                    fontSize: 14,\r\n                    labelOutlineColor: \"#FFFFFF\",\r\n                    labelOutlineWidth: 4\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.NUMBER]),\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.URBAN] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'ESTADI_Pol_EntidadPob',\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMUNICIPIO', 'CENTIDAD'],\r\n        idPropertiesIdentifier: '#',\r\n        queryProperties: {\r\n            firstQueryWord: ['ENTINOAC', 'ENTIDAD']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.urban\",\r\n            color: \"strokeColor\"\r\n        },\r\n        outputProperties: ['MUNICIPIO', 'ENTIDAD'],\r\n        outputFormatLabel: '{1} ({0})',\r\n        searchWeight: 2,\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#feba1e',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.URBAN]),\r\n        stringPatternToCheck: self.stringPatternsValidators.s_or_t,\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.PLACENAME] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'TOPONI_Txt_Toponimos',\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMUNICIPIO', 'CTOPONIMO'],\r\n        idPropertiesIdentifier: '#',\r\n        queryProperties: {\r\n            firstQueryWord: ['TOPONIMO', 'TOPONINOAC']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.placeName\",\r\n            color: \"fontColor\"\r\n        },\r\n        outputProperties: ['MUNICIPIO', 'TOPONIMO', 'CMUNICIPIO', 'CTOPONIMO'],\r\n        outputFormatLabel: '{1} ({0})',\r\n        searchWeight: 7,\r\n        /*filterByMatch: true, // si queremos que filtre por expresión regular */\r\n        styles: [\r\n            {\r\n                point: {\r\n                    radius: 0,\r\n                    label: \"TOPONIMO\",\r\n                    angle: \"CADANGLE\",\r\n                    fontColor: \"#ff5722\",\r\n                    fontSize: 14,\r\n                    labelOutlineColor: \"#FFFFFF\",\r\n                    labelOutlineWidth: 4\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.PLACENAME]),\r\n        stringPatternToCheck: self.stringPatternsValidators.s_or_t,\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.PLACENAMEMUNICIPALITY] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'TOPONI_Txt_Toponimos',\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMUNICIPIO', 'CTOPONIMO'],\r\n        idPropertiesIdentifier: '#',\r\n        queryProperties: {\r\n            firstQueryWord: ['MUNICIPIO', 'MUNINOAC'],\r\n            secondQueryWord: ['TOPONIMO', 'TOPONINOAC']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.placeName\",\r\n            color: \"fontColor\"\r\n        },\r\n        outputProperties: ['MUNICIPIO', 'TOPONIMO', 'CMUNICIPIO', 'CTOPONIMO'],\r\n        outputFormatLabel: '{1} ({0})',\r\n        searchWeight: 8,\r\n        /*filterByMatch: true, si queremos que filtre por expresión regular */\r\n        styles: [\r\n            {\r\n                point: {\r\n                    radius: 0,\r\n                    label: \"TOPONIMO\",\r\n                    angle: \"CADANGLE\",\r\n                    fontColor: \"#ff5722\",\r\n                    fontSize: 14,\r\n                    labelOutlineColor: \"#FFFFFF\",\r\n                    labelOutlineWidth: 4\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getStringPattern.bind(this, [TC.Consts.searchType.PLACENAMEMUNICIPALITY]),\r\n        goTo: self.goToStringPattern\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.COMMONWEALTH] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: ['POLUCI_Pol_MancoRSUg'],\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMANCOMUNI'],\r\n        queryProperties: {\r\n            firstQueryWord: ['MANCOMUNID']\r\n        },\r\n        outputProperties: ['MANCOMUNID'],\r\n        outputFormatLabel: '{0}',\r\n        searchWeight: 9,\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    fillColor: '#000000',\r\n                    fillOpacity: 0.1,\r\n                    strokeColor: '#fc4e2a',\r\n                    strokeWidth: 2,\r\n                    strokeOpacity: 1\r\n                }\r\n            }\r\n        ]\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.ROAD] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'INFRAE_Lin_CtraEje',\r\n        dataIdProperty: ['DCARRETERA'],\r\n        queryProperties: {\r\n            firstQueryWord: ['DCARRETERA']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.road\",\r\n            color: \"strokeColor\"\r\n        },\r\n        outputProperties: ['DCARRETERA'],\r\n        outputFormatLabel: self.getLocaleString('search.list.road.shorter') + ': ' + '{0}',\r\n        searchWeight: 10,\r\n        styles: [\r\n            {\r\n                polygon: {\r\n                    strokeColor: \"#00b2fc\",\r\n                    strokeOpacity: 1,\r\n                    strokeWidth: 5\r\n                },\r\n                line: {\r\n                    strokeColor: \"#00b2fc\",\r\n                    strokeOpacity: 1,\r\n                    strokeWidth: 5,\r\n                    strokeLinecap: \"round\",\r\n                    strokeDashstyle: \"solid\"\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getRoad,\r\n        goTo: self.goToRoad,\r\n        pattern: function () {\r\n            return new RegExp(\"^(?:(?:\" + self.getLocaleString(\"search.list.road\") + \"|\" + self.getLocaleString(\"search.list.road.shorter\") + \")\\\\:?)?\\\\s*((A?|AP?|N?|R?|E?|[A-Z]{2}?|[A-Z]{1}?)\\\\s*\\\\-?\\\\s*(\\\\d{1,4})\\\\s*\\\\-?\\\\s*(A?|B?|C?|R?))$\", \"i\")\r\n        }\r\n    };\r\n\r\n    self.availableSearchTypes[TC.Consts.searchType.ROADPK] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'INFRAE_Sym_CtraPK',\r\n        dataIdProperty: ['DCARRETERA', 'CPK'],\r\n        queryProperties: {\r\n            firstQueryWord: ['DCARRETERA'],\r\n            secondQueryWord: ['PK']\r\n        },\r\n        suggestionListHead: {\r\n            label: \"search.list.pk.larger\",\r\n            color: \"fontColor\"\r\n        },\r\n        outputProperties: ['DCARRETERA', 'PK'],\r\n        outputFormatLabel: self.getLocaleString('search.list.road.shorter') + ': {0} ' + self.getLocaleString('search.list.pk') + ': {1}',\r\n        searchWeight: 11,\r\n        styles: [\r\n            {\r\n                point: {\r\n                    label: [\"DCARRETERA\", \"PK\"],\r\n                    fontColor: \"#00b2fc\",\r\n                    fontSize: 14,\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 2\r\n                }\r\n            }\r\n        ],\r\n        parser: self.getPK,\r\n        goTo: self.goToPK,\r\n        pattern: function () {\r\n            return new RegExp(\"^(?:(?:\" + self.getLocaleString(\"search.list.road\") + \"|\" + self.getLocaleString(\"search.list.road.shorter\") + \")\\\\:?)?\\\\s*((A?|AP?|N?|R?|E?|[A-Z]{2}?|[A-Z]{1}?)\\\\s*\\\\-?\\\\s*(\\\\d{1,4})\\\\s*\\\\-?\\\\s*(A?|B?|C?|R?))\\\\s*\\\\,*\\\\s*(?:(?:\" + self.getLocaleString(\"search.list.pk\") + \"\\\\:?)|(?:P\\\\:?)|(?:K\\\\:?)|(?:KM\\\\:?)|(?:\\\\s+|\\\\,+))\\\\s*(\\\\d{1,4})$\", \"i\")\r\n        }\r\n    };\r\n\r\n    self.rootCfg = {};\r\n    self.rootCfg[TC.Consts.searchType.MUNICIPALITY] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: 'CATAST_Pol_Municipio',\r\n        dataIdProperty: ['CMUNICIPIO'],\r\n        queryProperties: {\r\n            firstQueryWord: ['MUNICIPIO']\r\n        },\r\n        outputProperties: ['MUNICIPIO'],\r\n        outputFormatLabel: '{0}',\r\n        getRootLabel: function () {\r\n            return new Promise(function (resolve, reject) {\r\n\r\n                if (self.rootCfg.active && !self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel) {\r\n\r\n                    var params = {};\r\n                    params.SERVICE = 'WFS';\r\n                    params.VERSION = self.rootCfg[TC.Consts.searchType.MUNICIPALITY].version;\r\n                    params.REQUEST = 'GetFeature';\r\n                    params.TYPENAME = self.rootCfg[TC.Consts.searchType.MUNICIPALITY].featurePrefix + ':' + self.rootCfg[TC.Consts.searchType.MUNICIPALITY].featureType;\r\n                    params.OUTPUTFORMAT = self.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputFormat;\r\n                    params.PROPERTYNAME = ['CMUNICIPIO'].concat(self.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties).join(',');\r\n\r\n                    params.CQL_FILTER = self.rootCfg[TC.Consts.searchType.MUNICIPALITY].root.map(function (elem) {\r\n                        return ['CMUNICIPIO'].map(function (id, index) {\r\n                            return id + '=' + elem[index];\r\n                        }).join(' AND ');\r\n                    });\r\n\r\n                    params.CQL_FILTER = params.CQL_FILTER.join(' OR ');\r\n\r\n                    TC.ajax({\r\n                        url: self.rootCfg[TC.Consts.searchType.MUNICIPALITY].url + '?' + TC.Util.getParamString(params),\r\n                        method: 'GET',\r\n                        responseType: TC.Consts.mimeType.JSON\r\n                    }).then(function (response) {\r\n                        const data = response.data;\r\n                        if (data.totalFeatures > 0) {\r\n\r\n                            self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel = data.features.map(function (feature) {\r\n                                return {\r\n                                    id: ['CMUNICIPIO'].map(function (elem) {\r\n                                        return feature.properties[elem];\r\n                                    }).join('#'),\r\n                                    label: feature.properties[self.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties[0]].toLowerCase()\r\n                                };\r\n                            });\r\n\r\n                            resolve(self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel);\r\n\r\n                        } else {\r\n                            self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel = [];\r\n                            resolve(self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel);\r\n                        }\r\n                    }).catch(function () {\r\n                        resolve([]);\r\n                    });\r\n                }\r\n                else {\r\n                    resolve(self.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel);\r\n                }\r\n            });\r\n        }\r\n    };\r\n    self.rootCfg[TC.Consts.searchType.LOCALITY] = {\r\n        root: null,\r\n        limit: false,\r\n        url: self.url || '//idena.navarra.es/ogc/wfs',\r\n        version: self.version || '1.1.0',\r\n        outputFormat: TC.Consts.format.JSON,\r\n        featurePrefix: self.featurePrefix || 'IDENA',\r\n        geometryName: 'the_geom',\r\n        featureType: ['ESTADI_Pol_EntidadPob'],\r\n        renderFeatureType: '',\r\n        dataIdProperty: ['CMUNICIPIO', 'CENTIDADC'],\r\n        queryProperties: {\r\n            firstQueryWord: ['ENTINOAC']\r\n        },\r\n        outputProperties: ['ENTINOAC'],\r\n        getRootLabel: function () {\r\n            return new Promise(function (resolve, reject) {\r\n                if (self.rootCfg.active && !self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel) {\r\n\r\n                    var params = {};\r\n                    params.SERVICE = 'WFS';\r\n                    params.VERSION = self.rootCfg[TC.Consts.searchType.LOCALITY].version;\r\n                    params.REQUEST = 'GetFeature';\r\n                    params.TYPENAME = self.rootCfg[TC.Consts.searchType.LOCALITY].featurePrefix + ':' + self.rootCfg[TC.Consts.searchType.LOCALITY].featureType;\r\n                    params.OUTPUTFORMAT = self.rootCfg[TC.Consts.searchType.LOCALITY].outputFormat;\r\n                    params.PROPERTYNAME = ['CMUNICIPIO', 'CENTIDAD'].concat(self.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties).join(',');\r\n\r\n                    params.CQL_FILTER = self.rootCfg[TC.Consts.searchType.LOCALITY].root.map(function (elem) {\r\n                        return ['CMUNICIPIO', 'CENTIDAD'].map(function (id, index) {\r\n                            return id + '=' + elem[index];\r\n                        }).join(' AND ');\r\n                    });\r\n\r\n                    params.CQL_FILTER = params.CQL_FILTER.join(' OR ');\r\n\r\n                    TC.ajax({\r\n                        url: self.rootCfg[TC.Consts.searchType.LOCALITY].url + '?' + TC.Util.getParamString(params),\r\n                        method: 'GET',\r\n                        responseType: TC.Consts.mimeType.JSON\r\n                    }).then(function (response) {\r\n                        const data = response.data;\r\n                        if (data.totalFeatures > 0) {\r\n\r\n                            self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel = data.features.map(function (feature) {\r\n                                return {\r\n                                    id: ['CMUNICIPIO', 'CENTIDAD'].map(function (elem) {\r\n                                        return feature.properties[elem];\r\n                                    }).join('#'),\r\n                                    label: feature.properties[self.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties[0]].toLowerCase()\r\n                                };\r\n                            });\r\n\r\n                            resolve(self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel);\r\n\r\n                        } else {\r\n                            self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel = [];\r\n                            resolve(self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel);\r\n                        }\r\n                    }).catch(function () {\r\n                        resolve([]);\r\n                    });\r\n                }\r\n                else {\r\n                    resolve(self.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel);\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    self.allowedSearchTypes = [];\r\n\r\n    if (self.options.allowedSearchTypes) {\r\n        for (var allowed in self.options.allowedSearchTypes) {\r\n\r\n            if (self.availableSearchTypes[allowed] && !TC.Util.isEmptyObject(self.options.allowedSearchTypes[allowed])) {\r\n\r\n                // GLS: gestionamos el override de featureType y renderFeatureType.\r\n                // Si por defecto cuenta con renderFeatureType y sobrescribe featureType y no renderFeatureType, \r\n                // elimino la propiedad renderFeatureType y elimino el último estilo definido, que se corresponde con el de renderFeatureType.\r\n                if (self.availableSearchTypes[allowed].renderFeatureType && self.availableSearchTypes[allowed].renderFeatureType.length > 0 &&\r\n                    self.options.allowedSearchTypes[allowed].featureType && !self.options.allowedSearchTypes[allowed].renderFeatureType) {\r\n\r\n                    delete self.availableSearchTypes[allowed].renderFeatureType;\r\n                    self.availableSearchTypes[allowed].styles = self.availableSearchTypes[allowed].styles.slice(0, self.availableSearchTypes[allowed].styles.length - 1);\r\n                }\r\n\r\n                // GLS: override de la configuración por defecto con la del config.JSON\r\n                TC.Util.extend(self.availableSearchTypes[allowed], self.options.allowedSearchTypes[allowed]);\r\n\r\n\r\n                // GLS: Limitamos la búsqueda en portales y calles cuando así se establezca en la configuración de las búsquedas\r\n                if (self.options.allowedSearchTypes[allowed].root &&\r\n                    (allowed != TC.Consts.searchType.MUNICIPALITY && self.options.allowedSearchTypes[allowed].rootType == TC.Consts.searchType.MUNICIPALITY) ||\r\n                    (allowed != TC.Consts.searchType.LOCALITY && self.options.allowedSearchTypes[allowed].rootType == TC.Consts.searchType.LOCALITY)) {\r\n\r\n                    self.rootCfg.active = self.rootCfg[self.options.allowedSearchTypes[allowed].rootType];\r\n                    self.rootCfg.active.root = self.options.allowedSearchTypes[allowed].root;\r\n                    self.rootCfg.active.limit = self.options.allowedSearchTypes[allowed].limit;\r\n\r\n                    self.availableSearchTypes[TC.Consts.searchType.STREET].queryProperties.firstQueryWord =\r\n                        self.availableSearchTypes[TC.Consts.searchType.NUMBER].queryProperties.firstQueryWord =\r\n                        self.rootCfg.active.dataIdProperty;\r\n                }\r\n            }\r\n\r\n            // Si esta a false lo borramos de las disponibles\r\n            if (!self.options.allowedSearchTypes[allowed]) {\r\n                delete self.options.allowedSearchTypes[allowed];\r\n            } else {\r\n                self.addAllowedSearchType(allowed, self.availableSearchTypes[allowed] ? self.availableSearchTypes[allowed] : self.options.allowedSearchTypes[allowed], self);\r\n            }\r\n        }\r\n    }\r\n\r\n    if (self.rootCfg.active) {\r\n        self.rootCfg.active.getRootLabel();\r\n    }\r\n\r\n    self.queryableFeatures = self.options.queryableFeatures || false;\r\n\r\n    self.UTMX_LEN = 6;\r\n    self.UTMY_LEN = 7;\r\n\r\n    self.wrap = new TC.wrap.control.Search(self);\r\n\r\n    self.interval = 500;\r\n\r\n    self.NORMAL_PATTERNS = {\r\n        ROMAN_NUMBER: /M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3}){1,}?\\S?\\./i,\r\n        ABSOLUTE_NOT_DOT: /[`~!@#$%^&*_|+\\=?;:'\"\\{\\}\\[\\]\\\\]/gi,\r\n        ABSOLUTE: /[`~!@#$%^&*_|+\\=?;:'.\\{\\}\\[\\]\\\\]/gi\r\n    };\r\n};\r\n\r\nTC.inherit(TC.control.Search, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Search.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-search';\r\n\r\n    TC.Consts.event.SEARCHQUERYEMPTY = TC.Consts.event.SEARCHQUERYEMPTY || 'searchqueryempty.tc';\r\n\r\n    ctlProto.template = TC.apiLocation + \"TC/templates/Search.html\";\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self._search = {\r\n            data: []\r\n        };\r\n\r\n        self.layerStyleFN = (function () {\r\n            function getFeatureType(idFeature) {\r\n                return idFeature.indexOf('.') > -1 ? idFeature.split('.')[0] : idFeature;\r\n            };\r\n            function getStyle(property, geomType, id) {\r\n\r\n                var type = self.getSearchTypeByFeature(id);\r\n                if (type) {\r\n                    var style = type.getStyleByFeatureType(getFeatureType(id));\r\n\r\n                    if (style && style.hasOwnProperty(geomType)) {\r\n                        return style[geomType][property];\r\n                    }\r\n                }\r\n\r\n                return TC.Cfg.styles[geomType][property];\r\n            };\r\n\r\n            return function (geomType, property, extractValue, f) {\r\n                var self = this;\r\n\r\n                if (TC.Feature && !(f instanceof TC.Feature)) {\r\n                    self.map.trigger(TC.Consts.event.FEATURESADD, { layer: self.layer, geom: f.geom });\r\n                }\r\n\r\n                var prop = getStyle(property, geomType, getFeatureType(f.id));\r\n                if (extractValue) {\r\n                    if (prop instanceof Array) {\r\n                        var values = prop.map(function (p) {\r\n                            return f.getData().hasOwnProperty(p) ? f.getData()[p] : '';\r\n                        });\r\n                        var searchType = this.getSearchTypeByFeature(getFeatureType(f.id));\r\n                        if (searchType) {\r\n                            return searchType.outputFormatLabel.tcFormat(values);\r\n                        } else {\r\n                            return values.join(' ');\r\n                        }\r\n                    } else {\r\n                        return f.getData().hasOwnProperty(prop) ? f.getData()[prop] : '';\r\n                    }\r\n                }\r\n                else {\r\n                    return prop;\r\n                }\r\n            };\r\n        }());\r\n\r\n        var styleFN = self.layerStyleFN;\r\n\r\n        self.layerPromise = map.addLayer({\r\n            id: self.getUID(),\r\n            title: 'Búsquedas',\r\n            owner: self,\r\n            stealth: true,\r\n            declutter: true,\r\n            type: TC.Consts.layerType.VECTOR,\r\n            styles: {\r\n                polygon: {\r\n                    fillColor: styleFN.bind(self, 'polygon', 'fillColor', false),\r\n                    fillOpacity: styleFN.bind(self, 'polygon', 'fillOpacity', false),\r\n                    strokeColor: styleFN.bind(self, 'polygon', 'strokeColor', false),\r\n                    strokeOpacity: styleFN.bind(self, 'polygon', 'strokeOpacity', false),\r\n                    strokeWidth: styleFN.bind(self, 'polygon', 'strokeWidth', false)\r\n                },\r\n                line: {\r\n                    strokeColor: styleFN.bind(self, 'line', 'strokeColor', false),\r\n                    strokeOpacity: styleFN.bind(self, 'line', 'strokeOpacity', false),\r\n                    strokeWidth: styleFN.bind(self, 'line', 'strokeWidth', false)\r\n                },\r\n                marker: {\r\n                    anchor: TC.Defaults.styles.marker.anchor,\r\n                    height: TC.Defaults.styles.marker.height,\r\n                    width: TC.Defaults.styles.marker.width\r\n                },\r\n                point: {\r\n                    radius: styleFN.bind(self, 'point', 'radius', false),\r\n                    height: styleFN.bind(self, 'point', 'height', false),\r\n                    width: styleFN.bind(self, 'point', 'width', false),\r\n                    fillColor: styleFN.bind(self, 'point', 'fillColor', false),\r\n                    fillOpacity: styleFN.bind(self, 'point', 'fillOpacity', false),\r\n                    strokeColor: styleFN.bind(self, 'point', 'strokeColor', false),\r\n                    strokeWidth: styleFN.bind(self, 'point', 'strokeWidth', false),\r\n                    fontSize: styleFN.bind(self, 'point', 'fontSize', false),\r\n                    fontColor: styleFN.bind(self, 'point', 'fontColor', false),\r\n                    labelOutlineColor: styleFN.bind(self, 'point', 'labelOutlineColor', false),\r\n                    labelOutlineWidth: styleFN.bind(self, 'point', 'labelOutlineWidth', false),\r\n                    label: styleFN.bind(self, 'point', 'label', true),\r\n                    angle: styleFN.bind(self, 'point', 'angle', true)\r\n                }\r\n            }\r\n        })\r\n            .then(function (layer) {\r\n                self.layer = layer;\r\n                return layer;\r\n            });\r\n\r\n        self.EMPTY_RESULTS_LABEL = self.getLocaleString('noResults');\r\n        self.EMPTY_RESULTS_TITLE = self.getLocaleString('checkCriterion');\r\n        self.OUTBBX_LABEL = self.getLocaleString('outsideOfLimits');\r\n\r\n        self.WFS_TYPE_ATTRS = [\"url\", \"version\", \"geometryName\", \"featurePrefix\", \"featureType\", \"properties\", \"outputFormat\"];\r\n\r\n        return result;\r\n    };\r\n\r\n    const highlighting = function (elm) {\r\n        const self = this;\r\n\r\n        var highlighted = elm.label;\r\n        var strReg = [];\r\n\r\n        // eliminamos caracteres extraños del patrón ya analizado\r\n\r\n        if (self.lastPattern.trim().length === 0 && self.textInput.value.trim().length > 0) {\r\n            self.lastPattern = self.textInput.value.trim();\r\n        }\r\n\r\n        var normalizedLastPattern = self.lastPattern;\r\n        if (self.NORMAL_PATTERNS.ROMAN_NUMBER.test(normalizedLastPattern))\r\n            normalizedLastPattern = normalizedLastPattern.replace(self.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT, '');\r\n        else\r\n            normalizedLastPattern = normalizedLastPattern.replace(self.NORMAL_PATTERNS.ABSOLUTE, '');\r\n\r\n\r\n        var querys = [];\r\n        var separatorChar = ',';\r\n        if (normalizedLastPattern.indexOf(separatorChar) == -1) {\r\n            separatorChar = ' ';\r\n        }\r\n\r\n        querys = normalizedLastPattern.trim().split(separatorChar);\r\n\r\n        // si estamos tratando con coordenadas el separador es el espacio, no la coma\r\n        if ((elm.label.indexOf(self.LAT_LABEL) > -1 && elm.label.indexOf(self.LON_LABEL) > -1) ||\r\n            (elm.label.indexOf(self.UTMX_LABEL) > -1 && elm.label.indexOf(self.UTMY_LABEL) > -1)) {\r\n            querys = self.lastPattern.split(' ');\r\n\r\n            for (var t = 0; t < querys.length; t++) {\r\n                if (querys[t].trim().slice(-1) == ',')\r\n                    querys[t] = querys[t].slice(0, -1);\r\n            }\r\n        }\r\n\r\n        for (var q = 0; q < querys.length; q++) {\r\n            if (querys[q].trim().length > 0) {\r\n                strReg.push('(' + querys[q].trim().replace(/\\(/gi, \"\").replace(/\\)/gi, \"\") + ')');\r\n                var match = /((\\<)|(\\>)|(\\<\\>))/gi.exec(querys[q].trim());\r\n                if (match) {\r\n                    var _strReg = querys[q].trim().replace(/((\\<)|(\\>)|(\\<\\>))/gi, '').split(' ');\r\n                    for (var st = 0; st < _strReg.length; st++) {\r\n                        if (_strReg[st].trim().length > 0)\r\n                            strReg.push('(' + _strReg[st].trim().replace(/\\(/gi, \"\\\\(\").replace(/\\)/gi, \"\\\\)\") + ')');\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        if (elm.dataRole == TC.Consts.searchType.ROAD || elm.dataRole == TC.Consts.searchType.ROADPK) {\r\n            var rPattern = self.getSearchTypeByRole(elm.dataRole).getPattern();\r\n            var match = rPattern.exec(self.lastPattern);\r\n\r\n            if (match) {\r\n                strReg = [];\r\n\r\n                if (match[2] && match[3] && match[4]) {\r\n                    strReg.push('(' + match[2] + \"-\" + match[3] + \"-\" + match[4] + ')');\r\n                } else if (match[2] && match[3]) {\r\n                    strReg.push('(' + match[2] + \"-\" + match[3] + ')');\r\n                } else if (match[3] && match[4]) {\r\n                    strReg.push('(' + match[3] + \"-\" + match[4] + ')');\r\n                } else if (match[2] || match[3]) {\r\n                    strReg.push('(' + (match[2] || match[3]) + ')');\r\n                }\r\n\r\n                if (match[5]) {\r\n                    strReg.push(\"(?:\" + self.getLocaleString(\"search.list.pk\") + \"\\\\:\\\\s\\\\d*)\" + \"(\" + match[5] + \")\" + \"\\\\d*\");\r\n                }\r\n            } else if (match && match[5]) {\r\n                strReg = [];\r\n\r\n                strReg.push(\"(?:\" + self.getLocaleString(\"search.list.pk\") + \"\\\\:\\\\s\\\\d*)\" + \"(\" + match[5] + \")\" + \"\\\\d*\");\r\n            }\r\n        }\r\n\r\n        var pattern = '(' + strReg.join('|') + ')';\r\n\r\n        pattern = pattern.replace(/á|à/gi, \"a\");\r\n        pattern = pattern.replace(/é|è/gi, \"e\");\r\n        pattern = pattern.replace(/í|ì/gi, \"i\");\r\n        pattern = pattern.replace(/ó|ò/gi, \"o\");\r\n        pattern = pattern.replace(/ú|ù/gi, \"u\");\r\n        pattern = pattern.replace(/ü/gi, \"u\");\r\n\r\n        pattern = pattern.replace(/a/gi, \"[a|á|à]\");\r\n        pattern = pattern.replace(/e/gi, \"[e|é|è]\");\r\n        pattern = pattern.replace(/i/gi, \"[i|í|ì]\");\r\n        pattern = pattern.replace(/o/gi, \"[o|ó|ò]\");\r\n        pattern = pattern.replace(/u/gi, \"[u|ú|ü|ù]\");\r\n        var rex = new RegExp(pattern, \"gi\");\r\n\r\n        var label = elm.label;\r\n\r\n        if (elm.dataRole !== TC.Consts.searchType.ROAD || elm.dataRole !== TC.Consts.searchType.ROADPK) {\r\n            highlighted = label.replace(rex,\r\n                function () {\r\n                    var params = Array.prototype.slice.call(arguments, 0);\r\n\r\n                    if (params[params.length - 3]) {\r\n                        return params[0].replace(params[params.length - 3], \"<b>\" + params[params.length - 3] + \"</b>\");\r\n                    } else {\r\n                        return \"<b>\" + params[0] + \"</b>\";\r\n                    }\r\n                });\r\n        } else {\r\n            highlighted = label.replace(rex, \"<b>$1</b>\");\r\n        }\r\n\r\n        return highlighted;\r\n    };\r\n\r\n    const selectionCallback = function (e) {\r\n        const self = this;\r\n        var _target = e.target;\r\n\r\n        if (_target.tagName.toLowerCase() !== 'a') {\r\n            let el = e.target;\r\n            const matchesSelector = el.matches || el.webkitMatchesSelector || el.mozMatchesSelector || el.msMatchesSelector;\r\n\r\n            while (el) {\r\n                if (matchesSelector.call(el, 'a')) {\r\n                    _target = el;\r\n                    break;\r\n                } else {\r\n                    el = el.parentElement;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (_target.querySelector('span[hidden]')) {\r\n            self.textInput.value = _target.querySelector('span[hidden]').textContent;\r\n            self.lastPattern = self.textInput.value;\r\n            self._goToResult(unescape(_target.getAttribute('href')).substring(1), _target.parentNode.getAttribute('dataRole'));\r\n            TC.UI.autocomplete.call(self.textInput, 'clear');\r\n        }\r\n    };\r\n\r\n    const sortAlphaNum = function (a, b) {\r\n        const reA = /[^a-zA-Z]/g;\r\n        const reN = /[^0-9]/g;\r\n\r\n        var AInt = parseInt(a, 10);\r\n        var BInt = parseInt(b, 10);\r\n\r\n        if (isNaN(AInt) && isNaN(BInt)) {\r\n            var aA = a.replace(reA, \"\");\r\n            var bA = b.replace(reA, \"\");\r\n            if (aA === bA) {\r\n                var aN = parseInt(a.replace(reN, \"\"), 10);\r\n                var bN = parseInt(b.replace(reN, \"\"), 10);\r\n                return aN === bN ? 0 : aN > bN ? 1 : -1;\r\n            } else {\r\n                return aA > bA ? 1 : -1;\r\n            }\r\n        } else if (isNaN(AInt)) {//A is not an Int\r\n            return 1;//to make alphanumeric sort first return -1 here\r\n        } else if (isNaN(BInt)) {//B is not an Int\r\n            return -1;//to make alphanumeric sort first return 1 here\r\n        } else {\r\n            return AInt > BInt ? 1 : -1;\r\n        }\r\n    };\r\n\r\n    const sortByRoleAndAlphabet = function (a, b) {\r\n        const self = this;\r\n\r\n        if (self.getSearchTypeByRole(a.dataRole).searchWeight && self.getSearchTypeByRole(b.dataRole).searchWeight) {\r\n            if ((self.getSearchTypeByRole(a.dataRole).searchWeight || 0) > (self.getSearchTypeByRole(b.dataRole).searchWeight || 0)) {\r\n                return 1;\r\n            } else if ((self.getSearchTypeByRole(a.dataRole).searchWeight || 0) < (self.getSearchTypeByRole(b.dataRole).searchWeight || 0)) {\r\n                return -1;\r\n            }\r\n            else {\r\n                return sortAlphaNum(a.label, b.label);\r\n            }\r\n        } else {\r\n            if (a.dataRole > b.dataRole) {\r\n                return 1;\r\n            }\r\n            else if (a.dataRole < b.dataRole)\r\n                return -1;\r\n            else {\r\n                return sortAlphaNum(a.label, b.label);\r\n            }\r\n        }\r\n    };\r\n\r\n    const sortByRoot = function (a, b) {\r\n        const self = this;\r\n\r\n        const sort_ = function () {\r\n            var first = self.rootCfg.active.root[0] instanceof Array ? self.rootCfg.active.root[0].join('-') : self.rootCfg.active.root[0];\r\n\r\n            var aRoot, bRoot;\r\n            if (a.properties && a.properties.length > 0 && b.properties && b.properties.length > 0) {\r\n                aRoot = self.rootCfg.active.dataIdProperty.map(function (elem) { return a.properties[elem].toString(); }).join('-');\r\n                bRoot = self.rootCfg.active.dataIdProperty.map(function (elem) { return b.properties[elem].toString(); }).join('-');\r\n            } else {\r\n                aRoot = a.id;\r\n                bRoot = b.id;\r\n            }\r\n\r\n            if (aRoot !== first && bRoot === first) {\r\n                return 1;\r\n            } else if (aRoot === first && bRoot !== first) {\r\n                return -1;\r\n            } else {\r\n                return sortAlphaNum(a.label, b.label);\r\n            }\r\n        }.bind(this);\r\n\r\n        if (self.getSearchTypeByRole(a.dataRole).searchWeight && self.getSearchTypeByRole(b.dataRole).searchWeight) {\r\n            if ((self.getSearchTypeByRole(a.dataRole).searchWeight || 0) > (self.getSearchTypeByRole(b.dataRole).searchWeight || 0)) {\r\n                return 1;\r\n            } else if ((self.getSearchTypeByRole(a.dataRole).searchWeight || 0) < (self.getSearchTypeByRole(b.dataRole).searchWeight || 0)) {\r\n                return -1;\r\n            }\r\n            else {\r\n                return sort_();\r\n            }\r\n        }\r\n        else {\r\n            return sort_();\r\n        }\r\n    };\r\n\r\n    const buildHTML = function (results) {\r\n        const self = this;\r\n\r\n        var html = [];\r\n        var dataRoles = [];\r\n\r\n        // ordenamos por roles y alfabéticamente\r\n        var data = results.results.sort(sortByRoleAndAlphabet.bind(self));\r\n\r\n        if (self.rootCfg.active) {// si hay root, aplicamos el orden por entidades \r\n            data = data.sort(sortByRoot.bind(self));\r\n        }\r\n\r\n        for (var i = 0; i < data.length; i++) {\r\n            var elm = data[i];\r\n\r\n            if (dataRoles.indexOf(elm.dataRole) == -1) {\r\n                html[html.length] = self.getSearchTypeByRole(elm.dataRole).getSuggestionListHead();\r\n                dataRoles.push(elm.dataRole);\r\n            }\r\n\r\n            html[html.length] = '<li dataRole=\"' + elm.dataRole + '\">' +\r\n                '<a href=\"' + '#' + encodeURIComponent(elm.id) + '\">' +\r\n                '<span hidden>' +\r\n                elm.label +\r\n                '</span>' +\r\n                highlighting.call(self, elm) +\r\n                '</a>' +\r\n                '</li>';\r\n        }\r\n\r\n        Array.prototype.map.call(self.resultsList.querySelectorAll('li[dataRole]'), (elm) => {\r\n            return elm.getAttribute('dataRole');\r\n        }).filter((dataRole, i, liDataRoles) => {\r\n            return liDataRoles.indexOf(dataRole) === i && !dataRoles.includes(dataRole);\r\n        }).forEach(dataRole => {\r\n            html[html.length] = self.getSearchTypeByRole(dataRole).getSuggestionListHead();\r\n            html[html.length] = '<li dataRole=\"' + dataRole + '\"><a class=\"tc-ctl-search-li-loading\" href=\"#\">' + self.getLocaleString('searching') + '<span class=\"tc-ctl-search-loading-spinner tc-ctl-search-loading\"></span></a></li>';\r\n        });\r\n        \r\n        return html.join('');\r\n    };\r\n\r\n    ctlProto.renderData = function (data, callback) {\r\n        var self = this;\r\n\r\n        self._search = self._search || {};\r\n\r\n        var _search = function () {\r\n            self.search(self.textInput.value, function (list) {\r\n                if (list.length === 1) {\r\n                    self.textInput.value = list[0].label;\r\n                    self._goToResult(list[0].id, self.resultsList.querySelector('li:not([header])').getAttribute('dataRole'));\r\n                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n                else if (list.length === 0) {\r\n                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            });\r\n        };\r\n\r\n        return TC.Control.prototype.renderData.call(self, data, function () {\r\n\r\n            // desde keypress y desde la lupa\r\n            var _research = function () {\r\n                self.textInput.value = self.resultsList.label || self.resultsList.querySelector('li:not([header]) > a > span').textContent;\r\n                self.lastPattern = self.textInput.value;\r\n                self._goToResult(self.resultsList.id || unescape(self.resultsList.querySelector('li:not([header]) > a').getAttribute('href')).substring(1), self.resultsList.querySelector('li:not([header])').getAttribute('dataRole'));\r\n                self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n            };\r\n\r\n            self.textInput = self.div.querySelector('input.tc-ctl-search-txt');\r\n            if (self.options && self.options.placeHolder) {\r\n                self.textInput.setAttribute('placeHolder', self.options.placeHolder.trim());\r\n            }\r\n\r\n            self.resultsList = self.div.querySelector('.tc-ctl-search-list');\r\n            self.button = self.div.querySelector('.tc-ctl-search-btn');\r\n            self.button.addEventListener(TC.Consts.event.CLICK, function () {\r\n                self.getLayer().then(function (l) {\r\n                    if (self.resultsList.querySelectorAll('li > a:not(.tc-ctl-search-li-loading):not(.tc-ctl-search-li-empty)').length > 1) { }\r\n                    else if (l.features.length > 0) {\r\n                        l.map.zoomToFeatures(l.features);\r\n                    }\r\n                    else if (self.resultsList.querySelectorAll('li > a:not(.tc-ctl-search-li-loading):not(.tc-ctl-search-li-empty)').length === 1) {\r\n                        _research();\r\n                    }\r\n                    else {\r\n                        self.textInput.dispatchEvent(new Event(\"keyup\"));\r\n                    }\r\n                });\r\n            });\r\n            if (self.options.instructions) {\r\n                self.textInput.setAttribute('title', self.options.instructions.trim());\r\n                self.button.setAttribute('title', self.options.instructions.trim());\r\n            }\r\n\r\n            // GLS: añadimos la funcionalidad al mensaje de \"No hay resultados\", al hacer click repliega el mensaje.\r\n            self.resultsList.addEventListener(TC.Consts.event.CLICK, TC.EventTarget.listenerBySelector('a.tc-ctl-search-li-empty', function () {\r\n                self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                self.textInput.focus();\r\n            }));\r\n\r\n            self.textInput.addEventListener('keypress', function (e) {\r\n                if (e.which == 13) {\r\n                    e.preventDefault();\r\n                    e.stopPropagation();\r\n\r\n                    self.lastPattern = \"\";\r\n\r\n                    if (self.resultsList.querySelectorAll('li > a:not(.tc-ctl-search-li-loading):not(.tc-ctl-search-li-empty)').length === 1) {\r\n                        _research();\r\n                    } else {\r\n                        _search();\r\n                    }\r\n                    return false;\r\n                }\r\n            });\r\n            self.textInput.addEventListener(\"search\", function () {\r\n                if (self.textInput.value.length === 0) {\r\n                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                    _search();\r\n                }\r\n            });\r\n            self.textInput.addEventListener(\"input\", function () {\r\n                if (self.textInput.value.length === 0) {\r\n                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                    _search();\r\n                }\r\n            });\r\n            self.textInput.addEventListener(\"targetCleared.autocomplete\", function () {\r\n                self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n            })\r\n            self.textInput.addEventListener(\"targetUpdated.autocomplete\", function () {\r\n                if (self.resultsList.querySelectorAll('li').length > 0) {\r\n                    self.resultsList.classList.remove(TC.Consts.classes.HIDDEN);\r\n                }\r\n            });\r\n\r\n            self.lastPattern = '';\r\n            self.retryTimeout = null;\r\n            TC.loadJS(\r\n                !TC.UI || !TC.UI.autocomplete,\r\n                [TC.apiLocation + 'TC/ui/autocomplete.js'],\r\n                function () {\r\n                    var searchDelay;\r\n\r\n                    const source = function (text, callback) {\r\n                        self.lastpress = performance.now();\r\n\r\n                        if (!searchDelay) {\r\n                            function step() {\r\n                                var criteria = self.textInput.value.trim();\r\n\r\n                                if (criteria.length > 0 &&\r\n                                    (!self.lastPattern || criteria != self.lastPattern) &&\r\n                                    performance.now() - self.lastpress > self.interval) {\r\n\r\n                                    window.cancelAnimationFrame(searchDelay);\r\n                                    searchDelay = undefined;\r\n\r\n                                    self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                                    // Pendiente de afinar\r\n                                    //if (self.lastPattern && criteria.substring(0, criteria.lastIndexOf(' ')) == self.lastPattern) {                                            \r\n\r\n                                    //    // Si el patrón de búsqueda anterior y actual es el mismo más algo nuevo (típico en la búsqueda de un portal), lo nuevo lo separo por coma\r\n                                    //    // self.lastPattern: \"Calle Cataluña/Katalunia Kalea, Pamplona\"\r\n                                    //    // text: \"Calle Cataluña/Katalunia Kalea, Pamplona 18\"\r\n\r\n                                    //    criteria = criteria.substring(0, criteria.lastIndexOf(' ')) + (self.lastPattern.trim().endsWith(',') ? \"\" : \",\") + criteria.substring(criteria.lastIndexOf(' '));\r\n                                    //}\r\n\r\n                                    self.lastPattern = criteria;\r\n\r\n                                    self.search(criteria, callback);\r\n                                } else {\r\n                                    searchDelay = requestAnimationFrame(step);\r\n                                }\r\n                            }\r\n\r\n                            searchDelay = requestAnimationFrame(step);\r\n                        }\r\n                    };\r\n\r\n                    TC.UI.autocomplete.call(self.textInput, {\r\n                        link: '#',\r\n                        target: self.resultsList,\r\n                        minLength: 2,\r\n                        ctx: self,\r\n                        source: source,\r\n                        callback: selectionCallback.bind(self),\r\n                        buildHTML: buildHTML.bind(self)\r\n                    });\r\n\r\n                    const getNextSibling = function (elem, selector) {\r\n                        // Get the next sibling element\r\n                        var sibling = elem.nextElementSibling;\r\n                        // If there's no selector, return the first sibling\r\n                        if (!selector) return sibling;\r\n                        // If the sibling matches our selector, use it\r\n                        // If not, jump to the next sibling and continue the loop\r\n                        while (sibling) {\r\n                            if (sibling.matches(selector)) return sibling;\r\n                            sibling = sibling.nextElementSibling\r\n                        }\r\n                    };\r\n\r\n                    const getPreviousSibling = function (elem, selector) {\r\n                        // Get the next sibling element\r\n                        var sibling = elem.previousElementSibling;\r\n                        // If there's no selector, return the first sibling\r\n                        if (!selector) return sibling;\r\n                        // If the sibling matches our selector, use it\r\n                        // If not, jump to the next sibling and continue the loop\r\n                        while (sibling) {\r\n                            if (sibling.matches(selector)) return sibling;\r\n                            sibling = sibling.previousElementSibling;\r\n                        }\r\n                    };\r\n\r\n                    // Detect up/down arrow\r\n                    const onKeydown = function (e) {\r\n                        if (!e.ctrlKey && !e.altKey && !e.shiftKey) {\r\n                            if (e.keyCode === 40) { // down arrow\r\n                                if (self.textInput == document.activeElement && self.resultsList.querySelector('li:not([header]) a')) {\r\n                                    // Scenario 1: We're focused on the search input; move down to the first li\r\n                                    self.resultsList.querySelector('li:not([header]) a').focus();\r\n                                } else if (self.resultsList.querySelector('li:not([header]):last-child a') === document.activeElement) { //} else if (self.resultsList.querySelector('li:not([header]):last a').is(':focus')) {\r\n                                    // Scenario 2: We're focused on the last li; move up to search input\r\n                                    self.textInput.focus();\r\n                                } else {\r\n                                    // Scenario 3: We're in the list but not on the last element, simply move down\r\n                                    getNextSibling(document.activeElement.parentElement, 'li:not([header])')\r\n                                        .querySelector('a').focus();\r\n                                }\r\n                                e.preventDefault(); // Stop page from scrolling\r\n                                e.stopPropagation();\r\n                            } else if (e.keyCode === 38) { // up arrow\r\n                                if (self.textInput == document.activeElement) {\r\n                                    // Scenario 1: We're focused on the search input; move down to the last li\r\n                                    self.resultsList.querySelector('li:not([header]):last-child a').focus();\r\n                                } else if (document.activeElement == self.resultsList.querySelector('li:not([header]) a')) {\r\n                                    self.resultsList.querySelector('li:not([header]):last-child a').focus();\r\n                                } else {\r\n                                    // Scenario 3: We're in the list but not on the first element, simply move up\r\n                                    getPreviousSibling(document.activeElement.parentElement, 'li:not([header])')\r\n                                        .querySelector('a').focus();\r\n                                }\r\n                                e.preventDefault(); // Stop page from scrolling\r\n                                e.stopPropagation();\r\n                            }\r\n                        }\r\n                        e.stopPropagation();\r\n                    };\r\n\r\n                    self.textInput.addEventListener('keydown', onKeydown);\r\n                    self.resultsList.addEventListener('keydown', onKeydown);\r\n                }\r\n            );\r\n\r\n            if (TC.Util.isFunction(callback)) {\r\n                callback();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.addAllowedSearchType = function (name, options) {\r\n        var self = this;\r\n\r\n        self.allowedSearchTypes.push(new SearchType(name, options, self));\r\n    };\r\n\r\n    ctlProto.getSearchTypeByRole = function (type) {\r\n        var self = this;\r\n\r\n        return self.allowedSearchTypes.filter(function (allowed) {\r\n            return allowed.typeName == type;\r\n        })[0];\r\n    };\r\n\r\n    ctlProto.getSearchTypeByFeature = function (id) {\r\n        var self = this;\r\n\r\n        var type = self.allowedSearchTypes.filter(function (allowed) {\r\n            return allowed.isFeatureOfThisType(id);\r\n        });\r\n\r\n        if (type.length > 0) {\r\n            return type[0];\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    ctlProto.getElementOnSuggestionList = function (id, dataRole) {\r\n        const self = this;\r\n\r\n        for (var i = 0; i < self.searchRequestsResults.length; i++) {\r\n            if (self.searchRequestsResults[i].id == id && (!dataRole || (dataRole && self.searchRequestsResults[i].dataRole === dataRole)))\r\n                return self.searchRequestsResults[i];\r\n        }\r\n    };\r\n\r\n    ctlProto.getLayer = function () {\r\n        const self = this;\r\n        return self.layerPromise;\r\n    };\r\n\r\n    ctlProto.getFeatures = function () {\r\n        const self = this;\r\n        return self.layer.features;\r\n    };\r\n\r\n    ctlProto.cleanMap = function () {\r\n        const self = this;\r\n\r\n        if (self.layer) {\r\n            const l = self.layer;\r\n            var features = l.features.slice();\r\n            l.clearFeatures();\r\n\r\n            self.map.trigger(TC.Consts.event.FEATUREREMOVE, { layer: l, feature: features });\r\n\r\n            for (var i = 0; i < self.WFS_TYPE_ATTRS.length; i++) {\r\n                if (l.hasOwnProperty(self.WFS_TYPE_ATTRS[i]))\r\n                    delete l[self.WFS_TYPE_ATTRS[i]];\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.getMunicipalities = function () {\r\n        var self = this;\r\n\r\n        TC.cache.search = TC.cache.search || {};\r\n        self._municipalitiesPromise = new Promise(function (resolve, reject) {\r\n            if (TC.cache.search.municipalities) {\r\n                resolve(TC.cache.search.municipalities);\r\n            }\r\n            else {\r\n                var type = self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL);\r\n\r\n                if (type.municipality && type.municipality.featureType && type.municipality.labelProperty && type.municipality.idProperty) {\r\n                    var params = {\r\n                        REQUEST: 'GetFeature',\r\n                        SERVICE: 'WFS',\r\n                        TYPENAME: type.municipality.featureType,\r\n                        VERSION: type.version,\r\n                        PROPERTYNAME: type.municipality.labelProperty + \",\" + type.municipality.idProperty,\r\n                        OUTPUTFORMAT: type.outputFormat\r\n                    };\r\n                    if (type.featurePrefix) {\r\n                        params.TYPENAME = type.featurePrefix + ':' + params.TYPENAME;\r\n                    }\r\n                    var url = type.url + '?' + TC.Util.getParamString(params);\r\n                    TC.ajax({\r\n                        url: url,\r\n                        method: 'GET',\r\n                        responseType: 'text'\r\n                    }).then(function (response) {\r\n                        const data = response.data;\r\n                        var parser;\r\n                        if (type.outputFormat === TC.Consts.format.JSON) {\r\n                            parser = new TC.wrap.parser.JSON();\r\n                        }\r\n                        else {\r\n                            parser = new TC.wrap.parser.WFS({\r\n                                featureNS: type.municipality.featurePrefix,\r\n                                featureType: type.municipality.featureType\r\n                            });\r\n                        }\r\n                        var features = parser.read(data);\r\n                        TC.cache.search.municipalities = [];\r\n                        for (var i = 0; i < features.length; i++) {\r\n                            var feature = features[i];\r\n                            TC.cache.search.municipalities.push({ label: feature.data[type.municipality.labelProperty], id: feature.data[type.municipality.idProperty] });\r\n                        }\r\n\r\n                        TC.cache.search.municipalities.sort(function (a, b) {\r\n                            var result;\r\n                            if (a.label < b.label) {\r\n                                result = -1;\r\n                            }\r\n                            else if (a.label > b.label) {\r\n                                result = 1;\r\n                            }\r\n                            else {\r\n                                result = 0;\r\n                            }\r\n                            return result;\r\n                        });\r\n\r\n                        resolve(TC.cache.search.municipalities);\r\n                    }).catch(function () {\r\n                        resolve();\r\n                    });\r\n                } else {\r\n                    throw new Error(\"Error en la configuración de la búsqueda: \" + type.typeName + \". Error en el objeto municipality\");\r\n                }\r\n            }\r\n        });\r\n        return self._municipalitiesPromise;\r\n    };\r\n\r\n    ctlProto.getCoordinates = function (pattern) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var match = pattern.match(new RegExp('^' + self.UTMX_LABEL.trim().toLowerCase() + '*\\\\s*([0-9]{' + self.UTMX_LEN + '}(?:[.,]\\\\d+)?)\\\\s*\\\\,?\\\\s*' + self.UTMY_LABEL.trim().toLowerCase() + '*\\\\s*([0-9]{' + self.UTMY_LEN + '}(?:[.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                pattern = match[1] + ' ' + match[2];\r\n            }\r\n\r\n            match = pattern.match(new RegExp('^' + self.LAT_LABEL.trim().toLowerCase() + '*\\\\s*([-+]?\\\\d{1,3}([.,]\\\\d+)?)\\\\,?\\\\s*' + self.LON_LABEL.trim().toLowerCase() + '*\\\\s*([-+]?\\\\d{1,2}([.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                pattern = match[1] + ' ' + match[3];\r\n            }\r\n\r\n            if (/\\d/.test(pattern) && (new RegExp('^([0-9]{' + self.UTMX_LEN + '}(?:[.,]\\\\d+)?)\\\\s*\\\\,?\\\\s*([0-9]{' + self.UTMY_LEN + '}(?:[.,]\\\\d+)?)$').test(pattern) || /^([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*([-+]?\\d{1,2}([.,]\\d+)?)$/.test(pattern))) {\r\n                match = /^([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*([-+]?\\d{1,2}([.,]\\d+)?)$/.exec(pattern);\r\n                if (match && (match[1].indexOf(',') > -1 || match[3].indexOf(',') > -1)) {\r\n                    match[1] = match[1].replace(',', '.');\r\n                    match[3] = match[3].replace(',', '.');\r\n\r\n                    pattern = match[1] + ' ' + match[3];\r\n                }\r\n\r\n                if (!match || match && ((match[1].indexOf(',') > -1 ? match[1].replace(',', '.') : match[1]) <= 180) && ((match[3].indexOf(',') > -1 ? match[3].replace(',', '.') : match[3]) <= 90)) {\r\n\r\n                    match = new RegExp('^([0-9]{' + self.UTMX_LEN + '}(?:[.,]\\\\d+)?)\\\\s*\\\\,?\\\\s*([0-9]{' + self.UTMY_LEN + '}(?:[.,]\\\\d+)?)$').exec(pattern);\r\n                    if (match && (match[1].indexOf(',') > -1 || match[2].indexOf(',') > -1)) {\r\n                        match[1] = match[1].replace(',', '.');\r\n                        match[2] = match[2].replace(',', '.');\r\n\r\n                        pattern = match[1] + ' ' + match[2];\r\n                    }\r\n\r\n                    // parse coordinates\r\n                    pattern = pattern.replace(self.UTMX_LABEL, '').replace(self.UTMY_LABEL, '').replace(self.LON_LABEL, '').replace(self.LAT_LABEL, '');\r\n                    var coords = TC.Util.parseCoords(pattern);\r\n                    if (coords) {\r\n                        var xValue = coords[0].value;\r\n                        var yValue = coords[1].value;\r\n                        var xLabel = (coords[0].type === TC.Consts.UTM) ? self.UTMX : self.LAT;\r\n                        var yLabel = (coords[1].type === TC.Consts.UTM) ? self.UTMY : self.LON;\r\n                        var id = xLabel + xValue + yLabel + yValue;\r\n\r\n                        var point = self.getPoint(id);\r\n                        if (point && !self.insideLimit(point)) {\r\n                            xValue = coords[1].value;\r\n                            yValue = coords[0].value;\r\n                            xLabel = (coords[1].type === TC.Consts.UTM) ? self.UTMX : self.LAT;\r\n                            yLabel = (coords[0].type === TC.Consts.UTM) ? self.UTMY : self.LON;\r\n                            id = xLabel + xValue + yLabel + yValue;\r\n                            point = self.getPoint(id);\r\n                        }\r\n\r\n                        if (point) {\r\n                            self.availableSearchTypes[TC.Consts.searchType.COORDINATES].label = /^X(\\d+(?:\\.\\d+)?)Y(\\d+(?:\\.\\d+)?)$/.test(id) ? self.getLocaleString('search.list.coordinates.utm') + self.map.crs : self.getLocaleString('search.list.coordinates.geo');\r\n\r\n                            //console.log('getCoordinates promise resuelta');\r\n                            resolve([{\r\n                                id: id, label: self.getLabel(id), dataRole: TC.Consts.searchType.COORDINATES\r\n                            }]);\r\n                        }\r\n                        else {\r\n                            //console.log('getCoordinates promise resuelta');\r\n                            reject();\r\n                        }\r\n                    } else {\r\n                        //console.log('getCoordinates promise resuelta');\r\n                        reject();\r\n                    }\r\n                } else {\r\n                    //console.log('getCoordinates promise resuelta');\r\n                    reject();\r\n                }\r\n            } else {\r\n                //console.log('getCoordinates promise resuelta');\r\n                reject();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getCadastralRef = function (pattern) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var match = pattern.match(new RegExp(self.MUN_LABEL.trim().toLowerCase() + '?\\\\s(.*)\\\\,\\\\s?' + self.POL_LABEL.trim().toLowerCase() + '?\\\\s(\\\\d{1,2})\\\\,\\\\s?' + self.PAR_LABEL.trim().toLowerCase() + '?\\\\s(\\\\d{1,4})'));\r\n            if (match) {\r\n                pattern = match[1] + ', ' + match[2] + ', ' + match[3];\r\n            }\r\n\r\n            var _pattern = pattern;\r\n            if (!(/^(.*)\\,(\\s*\\d{1,2}\\s*)\\,(\\s*\\d{1,4}\\s*)$/.test(pattern)) && self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot)\r\n                _pattern = self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot + ', ' + pattern;\r\n\r\n            if (/^(.*)\\,(\\s*\\d{1,2}\\s*)\\,(\\s*\\d{1,4}\\s*)$/.test(_pattern) && !(new RegExp('^([0-9]{' + self.UTMX_LEN + '})\\\\s*\\\\,\\\\s*([0-9]{' + self.UTMY_LEN + '})$').test(pattern))) {\r\n                self.getMunicipalities().then(function (list) {\r\n                    var match = /^(.*)\\,(\\s*\\d{1,2}\\s*)\\,(\\s*\\d{1,4}\\s*)$/.exec(_pattern);\r\n                    if (match) {\r\n                        var matcher = new RegExp(match[1].trim().replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, \"\\\\$&\"), \"i\");\r\n                        var results = [];\r\n\r\n                        const getItem = function (mun, munLabel, pol, par) {\r\n                            var properties = [];\r\n\r\n                            properties.push[self.MUN] = mun;\r\n                            properties.push[self.POL] = pol;\r\n                            properties.push[self.PAR] = par;\r\n\r\n                            return {\r\n                                id: self.MUN + mun + self.POL + pol + self.PAR + par,\r\n                                label: self.getLabel(self.MUN + munLabel + self.POL + pol + self.PAR + par),\r\n                                dataRole: TC.Consts.searchType.CADASTRAL,\r\n                                properties: properties\r\n                            };\r\n                        };\r\n\r\n                        results = list.filter(function (value) {\r\n                            value = value.label || value.id || value;\r\n                            return matcher.test(value) || matcher.test(self.removePunctuation(value));\r\n                        });\r\n\r\n                        if (results.length > 0) {\r\n                            for (var i = 0; i < results.length; i++) {\r\n                                results[i] = getItem(results[i].id, results[i].label, match[2].trim(), match[3].trim());\r\n                            }\r\n                        }\r\n\r\n                        if (/^[0-9]*$/g.test(match[1])) {\r\n\r\n                            if (match[1].trim() === self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot) {\r\n\r\n                                var suggestionRoot = list.filter(function (elm) {\r\n                                    return parseInt(elm.id) === parseInt(self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot);\r\n                                })[0];\r\n\r\n                                if (suggestionRoot) {\r\n                                    resolve([getItem(suggestionRoot.id, suggestionRoot.label, match[2].trim(), match[3].trim())]);\r\n                                }\r\n                            }\r\n\r\n                            results.push(getItem(match[1].trim(), match[1].trim(), match[2].trim(), match[3].trim()));\r\n                        }\r\n\r\n                        //console.log('getCadastralRef promise resuelta');\r\n                        resolve(results);\r\n                    }\r\n                });\r\n            } else {\r\n                //console.log('getCadastralRef promise resuelta - no es ref catastral');\r\n                reject();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.stringPatternsValidators = {\r\n        tsp: function (text, result, root, limit) {\r\n            // town, street, portal - street, town, portal\r\n            var match = /^([^0-9\\,]+)(?:\\s*\\,\\s*)(?:([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+))(?:\\s*\\,\\s*)(?:(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))$/i.exec(text);\r\n            if (match && match[1] && match[2]) {\r\n\r\n                var getPortal = function () {\r\n                    return formatStreetNumber((match[3] || match[4] || match[5] || match[6]).trim());\r\n                };\r\n                // ninguno contiene número duplicamos búsqueda\r\n                if (/^([^0-9]+)$/i.test(match[1].trim()) && /^([^0-9]+)$/i.test(match[2].trim())) {\r\n                    result.push({\r\n                        t: match[1].trim(), s: match[2].trim(), p: getPortal()\r\n                    });\r\n                    result.push({\r\n                        t: match[2].trim(), s: match[1].trim(), p: getPortal()\r\n                    });\r\n                }\r\n                else {  // indicamos como calle el criterio que contiene números, ya que no existen municipios con números pero sí calles\r\n                    if (/^([^0-9]+)$/i.test(match[1].trim())) result.push({\r\n                        t: match[1].trim(), s: match[2].trim(), p: getPortal()\r\n                    });\r\n                    else result.push({\r\n                        s: match[1].trim(), t: match[2].trim(), p: getPortal()\r\n                    });\r\n                }\r\n                bindRoot.call(this, result, root, limit);\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        spt: function (text, result, root, limit) {\r\n            // street, portal, town\r\n            var match = /^(?:([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+))(?:\\s*\\,\\s*)(?:(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))(?:\\s*\\,\\s*)([^0-9\\,]+)$/i.exec(text);\r\n            if (match && match[6] && match[1]) {\r\n\r\n                var getPortal = function () {\r\n                    return formatStreetNumber((match[2] || match[3] || match[4] || match[5]).trim());\r\n                };\r\n                // ninguno contiene número duplicamos búsqueda\r\n                if (/^([^0-9]+)$/i.test(match[6].trim()) && /^([^0-9]+)$/i.test(match[1].trim())) {\r\n                    result.push({\r\n                        t: match[6].trim(), s: match[1].trim(), p: getPortal()\r\n                    });\r\n                    result.push({\r\n                        t: match[1].trim(), s: match[6].trim(), p: getPortal()\r\n                    });\r\n                }\r\n                else {  // indicamos como calle el criterio que contiene números, ya que no existen municipios con números pero sí calles\r\n                    if (/^([^0-9]+)$/i.test(match[6].trim())) result.push({\r\n                        t: match[6].trim(), s: match[1].trim(), p: getPortal()\r\n                    });\r\n                    else result.push({\r\n                        s: match[6].trim(), t: match[1].trim(), p: getPortal()\r\n                    });\r\n                }\r\n                bindRoot.call(this, result, root, limit);\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        tnsp: function (text, result, root, limit) {\r\n            // town, numbers street, portal\r\n            var match = /^(?:([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+))(?:\\s*\\,\\s*)([^0-9\\,]+)(?:\\s*\\,\\s*)(?:(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))$/i.exec(text);\r\n\r\n            if (match && match[1] && match[2]) {\r\n                result.push({\r\n                    t: match[2].trim(), s: match[1].trim(), p: formatStreetNumber((match[3] || match[4] || match[5] || match[6]).trim())\r\n                });\r\n                bindRoot.call(this, result, root, limit);\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        ts: function (text, result, root, limit) {\r\n            // town, street\r\n            var match = /^([^0-9\\,]+)(?:\\s*\\,\\s*)(?:([^\\,][a-zñáéíóúüàèìòù\"\\s*\\-\\.\\(\\)\\/0-9]+))$/i.exec(text);\r\n\r\n            // topónimo, municipio\r\n            if (!match && /^[^0-9]*$/i.test(text.trim())) { // si no hay números reviso dándole la vuelta, si hay números que lo trate la función st\r\n                var criteria = text.split(',').reverse();\r\n                match = /^([^0-9\\,]+)(?:\\s*\\,\\s*)(?:([^\\,][a-zñáéíóúüàèìòù\"\\s*\\-\\.\\(\\)\\/0-9]+))$/i.exec(criteria.join(','));\r\n            }\r\n\r\n            if (match && match[1] && match[2]) {\r\n                // ninguno contiene número duplicamos búsqueda\r\n                if (/^([^0-9]+)$/i.test(match[1].trim()) && /^([^0-9]+)$/i.test(match[2].trim())) {\r\n                    result.push({\r\n                        t: match[1].trim(), s: match[2].trim()\r\n                    });\r\n                    result.push({\r\n                        s: match[1].trim(), t: match[2].trim()\r\n                    });\r\n\r\n                    bindRoot.call(this, result, root, limit);\r\n                }\r\n                else {  // indicamos como calle el criterio que contiene números, ya que no existen municipios con números pero sí calles\r\n\r\n                    var getStreet = function (s) {\r\n                        var revS = s.split(' ').reverse();\r\n                        // validamos si el criterio es compuesto \r\n                        var fs = [];\r\n                        for (var si = 0; si < revS.length; si++) {\r\n                            if (revS[si].length == 1) {\r\n                                fs.push(revS[si]);\r\n                                revS[si] = '';\r\n                            }\r\n                        }\r\n\r\n                        return fs.length > 0 ? revS.reverse().join(' ').trim() + self._LIKE_PATTERN + fs.reverse().join(self._LIKE_PATTERN) : revS.reverse().join(' ').trim();\r\n                    };\r\n\r\n                    if (/^([^0-9]+)$/i.test(match[1].trim()))\r\n                        result.push({\r\n                            t: match[1].trim(), s: getStreet(match[2].trim())\r\n                        });\r\n                    else result.push({\r\n                        s: getStreet(match[1].trim()), t: match[2].trim()\r\n                    });\r\n\r\n                    bindRoot.call(this, result, root, limit, true);\r\n                }\r\n\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        st: function (text, result, root, limit) {\r\n            // street, town\r\n            var match = /^(?:([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+))(?:\\s*\\,\\s*)([^0-9\\,]+)$/i.exec(text);\r\n\r\n            if (!match) {\r\n                var criteria = text.split(',').reverse();\r\n                match = /^([^0-9\\,]+)(?:\\s*\\,\\s*)(?:([^\\,][a-zñáéíóúüàèìòù\"\\s*\\-\\.\\(\\)\\/0-9]+))$/i.exec(criteria.join(','));\r\n            }\r\n\r\n            if (match) { // puede generar falsos positivos cuando el portal llega seguido de la calle -> calle mayor 14, pamplona\r\n                var data = {\r\n                };\r\n                var criteria = text.split(',').reverse();\r\n                for (var i = 0; i < criteria.length; i++) {\r\n                    if (/^([^0-9\\,]+)$/i.test(criteria[i].trim())) { // si no hay números se trata de municipio\r\n                        data.t = criteria[i].trim();\r\n                    }\r\n                    else if (/(\\s*\\d+)/i.test(criteria[i].trim())) { // si contiene número, puede ser calle o calle + portal\r\n                        if (criteria[i].trim().indexOf(' ') == -1) { // si no contiene espacios se trata de calle compuesta por números\r\n                            data.s = criteria[i].trim();\r\n                        } else { // si contiene espacio puede contener calle + portal\r\n                            var _criteria = criteria[i].trim().split(' ').reverse();\r\n\r\n                            var isPortal = function (c) {\r\n                                var m = /^(?:(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))$/i.exec(c.trim());\r\n                                if (m) {\r\n                                    data.p = formatStreetNumber(c.trim());\r\n                                    return true;\r\n                                }\r\n                                return false;\r\n                            };\r\n\r\n                            var x = 0;\r\n                            var p = _criteria[x].trim();\r\n                            while (x < _criteria.length && !isPortal(p)) {\r\n                                x++;\r\n                                if (x < _criteria.length)\r\n                                    p = p + _criteria[x];\r\n\r\n                            }\r\n\r\n                            if (data.p) {\r\n                                var _cr = _criteria;\r\n                                for (var h = 0; h < _cr.length; h++) {\r\n                                    // validamos que lo que hemos deducido como portal, está en portal para no añadirlo a calle\r\n                                    var inPortal = false;\r\n                                    for (var c = 0; c < _cr[h].split('').length; c++) {\r\n                                        if (data.p.indexOf(_cr[h][c]) > -1)\r\n                                            inPortal = true;\r\n                                    }\r\n\r\n                                    if (inPortal) {\r\n                                        var _p = _cr[h];\r\n\r\n                                        _cr[h] = '';\r\n                                        if (data.p == formatStreetNumber(p))\r\n                                            break;\r\n                                    }\r\n                                }\r\n\r\n                                if (/^([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9]+)$/i.test(_criteria.reverse().join(' ').trim())) {\r\n                                    var fs = [];\r\n                                    var criteriaRev = _criteria.reverse();\r\n                                    for (var chs = 0; chs < criteriaRev.length; chs++) {\r\n                                        if (criteriaRev[chs].trim().length == 1) {\r\n                                            fs.push(criteriaRev[chs].trim());\r\n                                            criteriaRev[chs] = '';\r\n                                        }\r\n                                    }\r\n\r\n                                    data.s = fs.length > 0 ? criteriaRev.reverse().join(' ').trim() + self._LIKE_PATTERN + fs.reverse().join(self._LIKE_PATTERN) : criteriaRev.reverse().join(' ').trim();\r\n                                }\r\n\r\n\r\n                                // nombre_de_calle = 137, 1, 20...\r\n                                // duplico la búsqueda para el caso de [Calle nombre_de_calle], municipio\r\n                                result.push({\r\n                                    t: data.t,\r\n                                    s: data.s + ' ' + data.p\r\n                                });\r\n                            } else {\r\n                                data.s = criteria[i].trim();\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                result.push(data);\r\n                bindRoot.call(this, result, root, limit);\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        s_or_t: function (text, result, root, limit) {\r\n            var match = /^([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/0-9\\<\\>]+)$/i.exec(text);\r\n            if (match && match[1]) {\r\n                if (root) {\r\n                    result.push({\r\n                        t: match[1].trim()\r\n                    });\r\n\r\n                    result.push({\r\n                        t: root,\r\n                        s: match[1].trim()\r\n                    });\r\n                }\r\n                else result.push({\r\n                    t: match[1].trim()\r\n                });\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        sp: function (text, result, root, limit) {\r\n            var match = /^([^\\,][a-zñáéíóúüàèìòù\\s*\\-\\.\\(\\)\\/]+)\\s*\\,?\\s*((\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4}))$/i.exec(text);\r\n            if (match && match[1] && match[2]) { // && text.indexOf(',') > -1 && text.split(',').length < 3) {\r\n                if (root)\r\n                    result.push({\r\n                        t: root,\r\n                        s: match[1].trim(),\r\n                        p: formatStreetNumber(match[2].trim())\r\n                    });\r\n                else\r\n                    result.push({\r\n                        t: match[1].trim(),\r\n                        s: match[2].trim()\r\n                    });\r\n\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        },\r\n        snp: function (text, result, root, limit) { // calle puede contener números con portal (cuando exista un municipio root establecido)\r\n            var match = /^([^\\,][0-9\\s*\\-\\.\\(\\)\\/]+)\\s*\\,?\\s*(\\d{1,3}\\s?\\-?\\s?[a-z]{0,4}\\s?\\-?\\s?[a-z]{0,4})|([a-z]{1,4}\\s?\\-?\\s?\\d{1,3})|(sn|S\\/N|s\\/n|s\\-n)|([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4})$/i.exec(text);\r\n            if (match && match[1] && match[2] && root) {\r\n                result.push({\r\n                    t: root,\r\n                    s: match[1].trim(),\r\n                    p: formatStreetNumber(match[2].trim())\r\n                });\r\n                return true;\r\n            }\r\n\r\n            return false;\r\n        }\r\n    };\r\n\r\n    /* métodos auxiliares de getStringPattern */\r\n\r\n    const normalizedCriteria = function (value) {\r\n        const self = this;\r\n\r\n        var _value = '';\r\n\r\n        value = self.removePunctuation(value);\r\n\r\n        // elimino los caracteres especiales\r\n        if (self.NORMAL_PATTERNS.ROMAN_NUMBER.test(value))\r\n            value = value.replace(self.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT, '');\r\n        else\r\n            value = value.replace(self.NORMAL_PATTERNS.ABSOLUTE, '');\r\n        return value.toLowerCase();\r\n    };\r\n\r\n    const formatStreetNumber = function (value) {\r\n        var result = value;\r\n\r\n        var is_nc_c = function (value) {\r\n            return /^(\\d{1,3})\\s?\\-?\\s?([a-z]{0,4})\\s?\\-?\\s?([a-z]{0,4})$/i.test(value);\r\n        }\r\n        var nc_c = function (value) {\r\n            var f = [];\r\n            var m = /^(\\d{1,3})\\s?\\-?\\s?([a-z]{0,4})\\s?\\-?\\s?([a-z]{0,4})$/i.exec(value);\r\n            if (m) {\r\n                for (var i = 1; i < m.length; i++) {\r\n                    if (m[i].trim().length > 0)\r\n                        f.push(m[i].trim());\r\n                }\r\n\r\n                return f.join(self._LIKE_PATTERN);\r\n            }\r\n            return value;\r\n        };\r\n\r\n        var is_cn = function (value) {\r\n            return /^([a-z]{1,4})\\s?\\-?\\s?(\\d{1,3})$/i.test(value);\r\n        };\r\n        var cn = function (value) {\r\n            var f = [];\r\n            var m = /^([a-z]{1,4})\\s?\\-?\\s?(\\d{1,3})$/i.exec(value);\r\n            if (m) {\r\n                for (var i = 1; i < m.length; i++) {\r\n                    if (m[i].trim().length > 0)\r\n                        f.push(m[i].trim());\r\n                }\r\n\r\n                return f.join(self._LIKE_PATTERN);\r\n            }\r\n            return value;\r\n        };\r\n\r\n        var is_sn = function (value) {\r\n            return /^(sn|S\\/N|s\\/n|s\\-n)$/i.test(value);\r\n        };\r\n        var sn = function (value) {\r\n            var m = /^(sn|S\\/N|s\\/n|s\\-n)$/i.exec(value);\r\n            if (m) {\r\n                return 's*n';\r\n            }\r\n            return value;\r\n        };\r\n\r\n\r\n        var is_cmc = function (value) {\r\n            return /^([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4})$/i.test(value);\r\n        };\r\n        var cmc = function (value) {\r\n            var m = /^([a-z]{1,4}\\s?\\+\\s?[a-z]{1,4})$/i.exec(value);\r\n            if (m) {\r\n                return value;\r\n            }\r\n            return value;\r\n        };\r\n\r\n        var isCheck = [is_nc_c, is_cn, is_sn, is_cmc];\r\n        var check = [nc_c, cn, sn, cmc];\r\n        var ch = 0;\r\n        while (ch < check.length && !isCheck[ch].call(self, value)) {\r\n            ch++;\r\n        }\r\n\r\n        if (ch < check.length)\r\n            return check[ch].call(self, value);\r\n        else return value;\r\n    };\r\n\r\n    const bindRoot = function (result, root, limit, addRoot) {\r\n        const self = this;\r\n\r\n        if (root) {\r\n            var i = result.length;\r\n            while (i--) {\r\n                if (!addRoot) {\r\n                    if (result[i].t) {\r\n                        var indicatedRoot = self.rootCfg.active.rootLabel.filter(function (elem) {\r\n                            return elem.label.indexOf(self.removePunctuation(result[i].t).toLowerCase()) > -1;\r\n                        }.bind(self));\r\n\r\n                        if (indicatedRoot.length == 1) {\r\n                            result[i].t = indicatedRoot[0].id;\r\n                        } else if (indicatedRoot.length > 1) {\r\n\r\n                            indicatedRoot.map(function (elem) {\r\n                                var newResult = TC.Util.extend({\r\n                                }, result[i]);\r\n                                newResult.t = elem.id;\r\n\r\n                                result.push(newResult);\r\n                            });\r\n\r\n                        } else if (indicatedRoot.length == 0 && limit) {\r\n                            result.splice(i, 1);\r\n                        }\r\n                    }\r\n                }\r\n                else {\r\n                    result.push(TC.Util.extend({}, result[i], { t: root }));\r\n                };\r\n            }\r\n        }\r\n    };\r\n\r\n    const getObjectsFromStringToQuery = function (allowedRoles, text) {\r\n        const self = this;\r\n        const root = self.rootCfg.active && self.rootCfg.active.root || '';\r\n        const limit = self.rootCfg.active && self.rootCfg.active.limit || false;\r\n\r\n        var result = [];\r\n\r\n        const test = function () {\r\n            var tests = [function (text) {\r\n                return text.length >= 3;\r\n            },\r\n            function (text) {\r\n                return /^\\d+$/.test(text) ? false : (/^\\d+\\,\\s*\\d+$/.test(text) ? false : true);\r\n            }];\r\n\r\n            for (var i = 0; i < tests.length; i++) {\r\n                if (!tests[i].call(self, text))\r\n                    return false;\r\n            }\r\n\r\n            return true;\r\n        };\r\n\r\n        // eliminamos espacios en blanco\r\n        text = text.trim();\r\n\r\n        // comprobamos si acaba con coma, si es así, la eliminamos\r\n        if (text.charAt(text.length - 1) == ',') {\r\n            text = text.substring(0, text.length - 1);\r\n        }\r\n\r\n        if (test(text)) {\r\n            var check = [];\r\n\r\n            check = allowedRoles.map(function (dataRole) {\r\n                return self.getSearchTypeByRole(dataRole);\r\n            }).filter(function (searchType) {\r\n                return searchType.stringPatternToCheck;\r\n            }).map(function (searchType) {\r\n                return searchType.stringPatternToCheck;\r\n            });\r\n\r\n            if (check.length === 0) {\r\n                check = [self.stringPatternsValidators.tsp, self.stringPatternsValidators.spt, self.stringPatternsValidators.tnsp, self.stringPatternsValidators.ts, self.stringPatternsValidators.st];\r\n                if (root && text.split(',').length < 3) {\r\n                    check = [self.stringPatternsValidators.sp, self.stringPatternsValidators.snp, self.stringPatternsValidators.s_or_t].concat(check);\r\n                }\r\n                else {\r\n                    check = check.concat([self.stringPatternsValidators.sp, self.stringPatternsValidators.snp, self.stringPatternsValidators.s_or_t]);\r\n                }\r\n            }\r\n\r\n            var ch = 0;\r\n            try {\r\n                while (ch < check.length && !check[ch].call(self, text, result, root, limit)) {\r\n                    ch++;\r\n                }\r\n            }\r\n            catch (ex) {\r\n                TC.error(\"Error según el patrón: \" + text, TC.Consts.msgErrorMode.EMAIL, \"Error en la búsqueda del callejero\");\r\n            }\r\n\r\n            return result;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    const requestToWFS = function (type, signal, doneCallback, data) {\r\n        const self = this;\r\n\r\n        return fetch(type.url, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'\r\n            },\r\n            body: type.filter.getParams(data),\r\n            signal: signal\r\n        })\r\n            .then(function (response) {\r\n                if (response.ok) {\r\n                    return response.text();\r\n                } else {\r\n                    throw \"Search: error requestToWFS\";\r\n                }\r\n            })\r\n            .then(doneCallback)\r\n            .catch(function (err) {\r\n                if (err.name === 'AbortError') {\r\n                    console.log('Search: petición abortada');\r\n                } else {\r\n                    TC.error(err);\r\n                }\r\n\r\n                throw err;\r\n\r\n                //console.log('getStringPattern promise resuelta - data.statusText: ' + data.statusText);\r\n            });\r\n    };\r\n\r\n    ctlProto.getStringPattern = function (allowedRoles, pattern) {\r\n        const self = this;\r\n\r\n        return new Promise((resolve, reject) => {\r\n            let toQuery = [];\r\n            let requestsQuery = [];\r\n\r\n            pattern = normalizedCriteria.call(self, pattern);\r\n\r\n            console.log('getStringPattern sartzen da: ' + pattern);\r\n\r\n            /* gestionamos:\r\n                Entidad de población: Irisarri Auzoa (Igantzi)\r\n                Topónimo: Aldabeko Bidea (Arbizu)\r\n            */\r\n            let combinedCriteria = /(.*)\\((.*)\\)/.exec(pattern);\r\n            if (combinedCriteria && combinedCriteria.length > 2) {\r\n                // búsqueda de entidad de población\r\n                toQuery = getObjectsFromStringToQuery.call(self, allowedRoles, combinedCriteria[1]) || [];\r\n                // búsqueda de topónimo\r\n                let toQueryCombined = getObjectsFromStringToQuery.call(self, allowedRoles, combinedCriteria[1] + ',' + combinedCriteria[2]) || [];\r\n\r\n                toQuery = toQuery.concat(toQueryCombined);\r\n            } else {\r\n                toQuery = getObjectsFromStringToQuery.call(self, allowedRoles, pattern) || [];\r\n            }\r\n\r\n            if (toQuery.length > 0) {\r\n                let pendingSuggestionLstHead = [];\r\n                let filterRoles = (dataToQuery) => {\r\n                    return allowedRoles.filter(function (elm) {\r\n                        return Object.keys(self.getSearchTypeByRole(elm).queryProperties).length === Object.keys(dataToQuery).length;\r\n                    });\r\n                };\r\n                let pendingHeaderRoles = [];\r\n\r\n                for (var i = 0; i < toQuery.length; i++) {\r\n                    let dataToQuery = toQuery[i];\r\n                    let roles = filterRoles(dataToQuery);\r\n\r\n                    for (var r = 0; r < roles.length; r++) {\r\n                        let type = self.getSearchTypeByRole(roles[r]);\r\n\r\n                        if (pendingHeaderRoles.indexOf(type.typeName) < 0) {\r\n                            pendingSuggestionLstHead.push(type.getSuggestionListHead());\r\n                            pendingSuggestionLstHead.push('<li dataRole=\"' + type.typeName + '\"><a class=\"tc-ctl-search-li-loading\" href=\"#\">' + self.getLocaleString('searching') + '<span class=\"tc-ctl-search-loading-spinner tc-ctl-search-loading\"></span></a></li>');\r\n\r\n                            pendingHeaderRoles.push(type.typeName);\r\n                        }\r\n\r\n                        let responseToSuggestionLstElmt = (response) => {\r\n                            return type.getSuggestionListElements(response);\r\n                        };\r\n\r\n                        requestsQuery.push(requestToWFS.call(self, type, self.searchRequestsAbortController.signal, responseToSuggestionLstElmt, dataToQuery));\r\n                    }\r\n                }\r\n\r\n                if (requestsQuery.length > 0) {\r\n                    self.resultsList.innerHTML += pendingSuggestionLstHead.join('');\r\n                    self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n\r\n                    Promise.all(requestsQuery)\r\n                        .then((results) => {\r\n                            console.log('denei espiatzen duben promesan sartzen da');\r\n                            //console.log('getStringPattern promise resuelta');                                  \r\n                            resolve([].concat.apply([], results));\r\n                        }).catch((error) => {\r\n                            console.log('denei espiatzen duben promesan catchien sartzen da');\r\n                            reject();\r\n                        });\r\n                } else {\r\n                    reject();\r\n                }\r\n            } else {\r\n                reject();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getRoad = function (pattern) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            pattern = pattern.trim();\r\n            if (pattern.length < 2) {\r\n                resolve([]);\r\n            } else {\r\n                var type = self.getSearchTypeByRole(TC.Consts.searchType.ROAD);\r\n\r\n                var roadPattern = type.getPattern();\r\n                var match = roadPattern.exec(pattern);\r\n                if (match && match[3]) {\r\n\r\n                    var _pattern = match[2] ? match[2].trim() + \"-\" + match[3].trim() : match[3].trim();\r\n                    if (match[4] && match[4].length > 0) {\r\n                        _pattern = _pattern + \"-\" + match[4].trim();\r\n                    }\r\n\r\n                    self.resultsList.innerHTML = type.getSuggestionListHead() +\r\n                        '<li dataRole=\"' + type.typeName + '\"><a class=\"tc-ctl-search-li-loading\" href=\"#\">' + self.getLocaleString('searching') + '<span class=\"tc-ctl-search-loading-spinner tc-ctl-search-loading\"></span></a></li>';\r\n                    self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n\r\n                    console.log('getRoad new');\r\n                    fetch(type.url + '?' + type.filter.getParams({ t: _pattern }), {\r\n                        signal: self.searchRequestsAbortController.signal\r\n                    }).then((response) => {\r\n                        if (response.ok) {\r\n                            return response.json();\r\n                        } else {\r\n                            throw \"Search: error getRoad\";\r\n                        }\r\n                    }).then((response) => {\r\n                        let result = [];\r\n\r\n                        if (response.totalFeatures > 0) {\r\n                            response.features.map(function (feature) {\r\n                                var properties = type.outputProperties;\r\n                                if (!result.some(function (elem) {\r\n                                    return (elem.text == feature.properties[properties[0]]);\r\n                                })) {\r\n                                    var label = type.outputFormatLabel.tcFormat(type.outputProperties.map(function (outputProperty) {\r\n                                        return feature.properties[outputProperty];\r\n                                    }));\r\n\r\n                                    var text = type.outputProperties.map(function (outputProperty) {\r\n                                        return feature.properties[outputProperty];\r\n                                    }).join('-');\r\n\r\n                                    result.push({\r\n                                        id: type.dataIdProperty.map(function (elem) {\r\n                                            return feature.properties[elem];\r\n                                        }).join('#'),\r\n                                        label: label,\r\n                                        text: text,\r\n                                        dataLayer: feature.id.split('.')[0],\r\n                                        dataRole: type.typeName\r\n                                    });\r\n                                }\r\n                            });\r\n\r\n                            //console.log('getRoad promise resuelta');\r\n                            resolve(result);\r\n                        } else {\r\n                            //console.log('getRoad promise resuelta');\r\n                            reject();\r\n                        }\r\n                    }).catch(function (data) {\r\n                        //console.log('getRoad promise resuelta - xhr fail');\r\n                        reject();\r\n                    });\r\n                } else {\r\n                    //console.log('getRoad promise resuelta - no encaja en road');\r\n                    reject();\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getPK = function (pattern) {\r\n        var self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            pattern = pattern.trim();\r\n            if (pattern.length < 3) {\r\n                resolve([]);\r\n            } else {\r\n\r\n                var type = self.getSearchTypeByRole(TC.Consts.searchType.ROADPK);\r\n\r\n                var roadPKPattern = type.getPattern();\r\n                var match = roadPKPattern.exec(pattern);\r\n                if (match && match[3] && match[5]) {\r\n\r\n                    var _pattern = match[2] ? match[2].trim() + \"-\" + match[3].trim() : match[3].trim();\r\n                    if (match[4] && match[4].length > 0) {\r\n                        _pattern = _pattern + \"-\" + match[4].trim();\r\n                    }\r\n\r\n                    self.resultsList.innerHTML = type.getSuggestionListHead() +\r\n                        '<li dataRole=\"' + type.typeName + '\"><a class=\"tc-ctl-search-li-loading\" href=\"#\">' + self.getLocaleString('searching') + '<span class=\"tc-ctl-search-loading-spinner tc-ctl-search-loading\"></span></a></li>';\r\n                    self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n\r\n                    console.log('getRoadPK new');\r\n\r\n                    fetch(type.url + '?' + type.filter.getParams({ t: _pattern, s: match[5].trim() }), {\r\n                        signal: self.searchRequestsAbortController.signal\r\n                    }).then((response) => {\r\n                        if (response.ok) {\r\n                            return response.json();\r\n                        } else {\r\n                            throw \"Search: error getRoadPK\";\r\n                        }\r\n                    }).then(function (response) {\r\n                        let result = [];\r\n                        if (response.totalFeatures > 0) {\r\n                            response.features.map(function (feature) {\r\n                                var properties = type.outputProperties;\r\n                                if (!result.some(function (elem) {\r\n                                    return (elem.label == feature.properties[properties[0]]);\r\n                                })) {\r\n                                    var text = type.outputFormatLabel.tcFormat(type.outputProperties.map(function (outputProperty) {\r\n                                        return feature.properties[outputProperty];\r\n                                    }));\r\n                                    result.push({\r\n                                        id: type.dataIdProperty.map(function (elem) {\r\n                                            return feature.properties[elem];\r\n                                        }).join('#'),\r\n                                        label: text,\r\n                                        text: text,\r\n                                        dataLayer: feature.id.split('.')[0],\r\n                                        dataRole: type.typeName\r\n                                    });\r\n                                }\r\n                            });\r\n                            //console.log('getRoadPK promise resuelta');\r\n                            resolve(result);\r\n                        } else {\r\n                            //console.log('getRoadPK promise resuelta');\r\n                            reject();\r\n                        }\r\n                    }).catch(function (data) {\r\n                        //console.log('getRoadPK promise resuelta - xhr fail');\r\n                        reject();\r\n                    });\r\n                } else {\r\n                    //console.log('getRoadPK promise resuelta - no encaja en pk');\r\n                    reject();\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.search = function (pattern, callback) {\r\n        var self = this;\r\n\r\n        pattern = pattern.trim();\r\n        if (pattern.length > 0) {\r\n            pattern = pattern.toLowerCase();\r\n\r\n            console.log('hasten ga: ' + pattern);\r\n\r\n            if (self.searchRequestsAbortController) {\r\n                self.searchRequestsAbortController.abort();\r\n            }\r\n\r\n            self.resultsList.innerHTML = '';\r\n            self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n\r\n            self.searchRequestsResults = [];\r\n\r\n            let isAborted = false;\r\n            let onAbort = () => {\r\n                console.log('bertan behera uzten du: ' + pattern);\r\n                \r\n                isAborted = true;\r\n                self.searchRequestsAbortController.signal.removeEventListener('abort', onAbort);\r\n            }\r\n\r\n            self.searchRequestsAbortController = new AbortController();\r\n            self.searchRequestsAbortController.signal.addEventListener('abort', onAbort);\r\n\r\n            let toRender = 0;\r\n            let renderingEnd = () => {\r\n                toRender--;\r\n                if (toRender === 0) {\r\n                    // si al término de las peticiones ya estamos con otro patrón no hacemos nada\r\n                    if (pattern !== self.textInput.value.trim().toLowerCase()) {\r\n                        return;\r\n                    }\r\n                    else {                        \r\n                        if (self.searchRequestsResults.length === 0) {\r\n                            self.cleanMap();\r\n\r\n                            if (!self.layer ||\r\n                                (self.layer && self.layer.features.length === 0)) {\r\n\r\n                                self.resultsList.innerHTML = '<li><a title=\"' + self.EMPTY_RESULTS_TITLE + '\" class=\"tc-ctl-search-li-empty\">' + self.EMPTY_RESULTS_LABEL + '</a></li>';\r\n                                self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n                            }\r\n                        }\r\n\r\n                        self.lastPattern = \"\";\r\n                    }\r\n                }\r\n            };\r\n\r\n            let renderResultsOnSuggestionList = () => {\r\n                if (self.searchRequestsResults) {\r\n                    self.searchRequestsResults = self.searchRequestsResults.sort(function (a, b) {\r\n                        var pattern = /(\\d+)/;\r\n                        var _a, _b = '';\r\n                        if (pattern.test(a.label) && pattern.test(b.label)) {\r\n                            _a = a.label.match(pattern)[1];\r\n                            _b = b.label.match(pattern)[1];\r\n                        } else {\r\n                            _a = a.label;\r\n                            _b = b.label;\r\n                        }\r\n\r\n                        if (_a > _b)\r\n                            return 1;\r\n                        else\r\n                            if (_a < _b)\r\n                                return -1;\r\n                            else\r\n                                return 0;\r\n                    });\r\n\r\n                    // compatibilidad hacia atrás\r\n                    self._search.data = self.searchRequestsResults;\r\n\r\n                    if (callback) {\r\n                        callback(self.searchRequestsResults);\r\n                    }\r\n                }\r\n            };\r\n\r\n            self.allowedSearchTypes.forEach(function (allowed) {\r\n                if (allowed.parser) {\r\n                    toRender++;\r\n\r\n                    console.log('registramos promesa: ' + allowed.typeName);\r\n\r\n                    allowed.parser.call(self, pattern)\r\n                        .then(function (dataRole, result) {\r\n\r\n                            let manageLoadingByDataRole = () => {\r\n                                let loadingElemOfDataRole = self.resultsList.querySelector('li[dataRole=\"' + dataRole + '\"]');\r\n                                if (loadingElemOfDataRole) {\r\n                                    let indexLoadingElemOfDataRole = Array.prototype.indexOf.call(loadingElemOfDataRole.parentElement.childNodes, loadingElemOfDataRole);\r\n                                    let headerElemOfDataRole = self.resultsList.childNodes[indexLoadingElemOfDataRole - 1];\r\n\r\n                                    self.resultsList.removeChild(headerElemOfDataRole);\r\n                                    self.resultsList.removeChild(loadingElemOfDataRole);\r\n                                }\r\n                            };\r\n\r\n                            console.log('resulta promesa: ' + dataRole);\r\n\r\n                            if (result && result.length > 0) {\r\n\r\n                                // caso topónimo con y sin municipio Irisarri Auzoa (Igantzi)\r\n                                let toConcat = result.filter((elm, i) => self.searchRequestsResults.findIndex((srrElm) => srrElm.id === elm.id) === -1);\r\n                                if (toConcat.length === result.length) {\r\n                                    self.searchRequestsResults = self.searchRequestsResults.concat(toConcat);\r\n\r\n                                    renderResultsOnSuggestionList();\r\n                                } else if (result.length === 1) {\r\n                                    manageLoadingByDataRole();\r\n                                }                                \r\n                            } else {\r\n                                manageLoadingByDataRole();\r\n                            }\r\n\r\n                            renderingEnd();\r\n\r\n                            //resolve(result);\r\n                        }.bind(self, allowed.typeName)).catch(function (dataRole) {\r\n                            //reject();\r\n                            console.log('reject promesa: ' + dataRole);\r\n                            renderingEnd();\r\n                        }.bind(self, allowed.typeName));\r\n                } else {\r\n                    console.log('Falta implementación del método parser');\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            self.lastPattern = \"\";\r\n\r\n            self.cleanMap();\r\n        }\r\n    };\r\n\r\n    var setQueryableFeatures = function (features) {\r\n        var self = this;\r\n\r\n        if (features && features.length > 0) {\r\n            for (var i = 0; i < features.length; i++) {\r\n                if (features[i].showsPopup != self.queryableFeatures)\r\n                    features[i].showsPopup = self.queryableFeatures;\r\n            }\r\n        }\r\n    };\r\n    ctlProto._goToResult = function (id, dataRole) {\r\n        var self = this;\r\n        var goTo = null;\r\n\r\n        //02/03/2020 cuando selecciona un elemento abortamos peticiones pendientes\r\n        if (self.searchRequestsAbortController) {\r\n            self.searchRequestsAbortController.abort();\r\n        }\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            if (!self.loading)\r\n                self.loading = self.map.getControlsByClass(\"TC.control.LoadingIndicator\")[0];\r\n\r\n            var wait;\r\n            wait = self.loading.addWait();\r\n\r\n            // en pantallas pequeñas, colapsamos el panel de herramientas\r\n            if (matchMedia('(max-width: 30em)').matches) {\r\n                self.textInput.blur();\r\n                self.map.trigger(TC.Consts.event.TOOLSCLOSE);\r\n            }\r\n\r\n            self.cleanMap();\r\n\r\n            var customSearchType = false;\r\n            var keepOnLooping = true;\r\n\r\n            self.allowedSearchTypes.forEach(function (allowed) {\r\n                if (keepOnLooping) {\r\n\r\n                    if (!self.availableSearchTypes[allowed.typeName]) {\r\n\r\n                        if (allowed.goTo) {\r\n                            customSearchType = true;\r\n\r\n                            goTo = allowed.goTo.call(self, id);\r\n                            if (goTo !== null) {\r\n                                keepOnLooping = false;\r\n                            }\r\n                        } else console.log('Falta implementación del método goTo');\r\n\r\n                    } else {\r\n\r\n                        var dr = dataRole || self.getElementOnSuggestionList.call(self, id).dataRole;\r\n                        if (dr) {\r\n\r\n                            var searchType = self.getSearchTypeByRole(dr);\r\n\r\n                            if (self.availableSearchTypes[dr] && searchType && searchType.goTo) {\r\n                                goTo = searchType.goTo.call(self, id, dr);\r\n                                if (goTo !== null) {\r\n                                    keepOnLooping = false;\r\n                                }\r\n                            } else if (!self.availableSearchTypes[dr] && searchType && searchType.goTo) {\r\n                                customSearchType = true;\r\n\r\n                                goTo = searchType.goTo.call(self, id, dr);\r\n                                if (goTo !== null) {\r\n                                    keepOnLooping = false;\r\n                                }\r\n                            } else console.log('Falta implementación del método goTo');\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            self.loading.removeWait(wait);\r\n\r\n            if (goTo) {\r\n\r\n                self.getLayer().then(function (layer) {\r\n                    switch (true) {\r\n                        case goTo.params.type == TC.Consts.layerType.VECTOR:\r\n                            for (var i = 0; i < self.WFS_TYPE_ATTRS.length; i++) {\r\n                                if (layer.hasOwnProperty(self.WFS_TYPE_ATTRS[i]))\r\n                                    delete layer[self.WFS_TYPE_ATTRS[i]];\r\n                            }\r\n                            break;\r\n                        case goTo.params.type == TC.Consts.layerType.WFS:\r\n                            for (var i = 0; i < self.WFS_TYPE_ATTRS.length; i++) {\r\n                                layer[self.WFS_TYPE_ATTRS[i]] = goTo.params[self.WFS_TYPE_ATTRS[i]];\r\n                            }\r\n\r\n                            wait = self.loading.addWait();\r\n                            break;\r\n                        default:\r\n                    }\r\n\r\n                    layer.type = goTo.params.type;\r\n\r\n                    self.map.on(TC.Consts.event.FEATURESADD, function (e) {\r\n                        if (e.layer === self.layer) {\r\n                            setQueryableFeatures.call(self, e.features);\r\n                        }\r\n                    });\r\n\r\n\r\n                    const layerEventHandler = function (e) {\r\n                        if (e.layer == layer) {\r\n                            // Salta cuando se pinta una feature que no es de tipo API porque la gestión de estilos salta antes (no es controlable)\r\n                            self.map.one(TC.Consts.event.FEATURESADD, function (e) {\r\n                                if (e.layer == layer) {\r\n                                    if (!e.layer.features || e.layer.features.length == 0 && e.layer.wrap.layer.getSource().getFeatures()) {\r\n                                        self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                                        var bounds = e.layer.wrap.layer.getSource().getExtent();\r\n                                        var radius = e.layer.map.options.pointBoundsRadius;\r\n\r\n                                        if (bounds[2] - bounds[0] === 0) {\r\n                                            bounds[0] = bounds[0] - radius;\r\n                                            bounds[2] = bounds[2] + radius;\r\n                                        }\r\n                                        if (bounds[3] - bounds[1] === 0) {\r\n                                            bounds[1] = bounds[1] - radius;\r\n                                            bounds[3] = bounds[3] + radius;\r\n                                        }\r\n                                        e.layer.map.setExtent(bounds);\r\n\r\n                                        // GLS: Necesito diferenciar un zoom programático de un zoom del usuario para la gestión del zoom en 3D\r\n                                        self.map.trigger(TC.Consts.event.ZOOMTO, {\r\n                                            extent: bounds, layer: e.layer\r\n                                        });\r\n                                    }\r\n                                    else if (e.layer.features && e.layer.features.length > 0) {\r\n                                        self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                                        self.layer.map.zoomToFeatures(e.layer.features);\r\n\r\n                                        self.map.trigger(TC.Consts.event.FEATURESADD, { layer: self.layer, features: self.layer.features });\r\n\r\n                                    } else if (e.layer.features && e.layer.features.length == 0 && goTo.params.type == TC.Consts.layerType.WFS) {\r\n                                        self.resultsList.inner = goTo.emptyResultHTML;\r\n                                        self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n\r\n                                        self.map.trigger(TC.Consts.event.SEARCHQUERYEMPTY);\r\n                                    }\r\n\r\n                                    self.loading.removeWait(wait);\r\n                                }\r\n                            });\r\n\r\n                            if (e.layer.features && e.layer.features.length > 0) {\r\n                                self.resultsList.classList.add(TC.Consts.classes.HIDDEN);\r\n                                self.layer.map.zoomToFeatures(self.layer.features);\r\n\r\n                                self.map.trigger(TC.Consts.event.FEATURESADD, { layer: self.layer, features: self.layer.features });\r\n\r\n                                self.loading.removeWait(wait);\r\n                            } else if (e.layer.features && e.layer.features.length == 0 && goTo.params.type == TC.Consts.layerType.WFS) {\r\n                                self.resultsList.innerHTML = goTo.emptyResultHTML;\r\n                                self.textInput.dispatchEvent(new CustomEvent(\"targetUpdated.autocomplete\"));\r\n\r\n                                if (!(e.newData && e.newData.features && e.newData.features.length > 0)) {\r\n                                    self.map.trigger(TC.Consts.event.SEARCHQUERYEMPTY);\r\n                                }\r\n\r\n                                self.loading.removeWait(wait);\r\n                            }\r\n                        }\r\n                    };\r\n\r\n                    self.map.one(TC.Consts.event.LAYERUPDATE, layerEventHandler);\r\n\r\n                    layer.refresh();\r\n                });\r\n\r\n                resolve(goTo);\r\n            } else {\r\n                reject(Error('Method goTo has no implementation'));\r\n                if (!customSearchType) {\r\n                    self.map.trigger(TC.Consts.event.SEARCHQUERYEMPTY);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.goToResult = function (id, dataRole) {\r\n        var self = this;\r\n        // si está habilitada\r\n        if (self.getSearchTypeByRole(dataRole)) {\r\n            return self._goToResult(id, dataRole);\r\n            // si no está habilitada pero está disponible\r\n        } else if (self.availableSearchTypes[dataRole]) {\r\n            self.addAllowedSearchType(dataRole, self.availableSearchTypes[dataRole], self);\r\n            return self._goToResult(id, dataRole);\r\n        } else {\r\n            alert('No se reconoce el tipo de búsqueda: ' + dataRole);\r\n        }\r\n    };\r\n\r\n    var drawPoint = function (id) {\r\n        var self = this;\r\n\r\n        wait = self.loading.addWait();\r\n\r\n        var point = self.getPoint(id);\r\n        var delta;\r\n        var title;\r\n        var promise;\r\n\r\n        if (point) {\r\n            title = self.getLabel(id);\r\n            promise = self.layer.addMarker(point, TC.Util.extend({}, self.map.options.styles.point, { title: title, group: title }));\r\n        } else {\r\n            var match = /^Lat((?:[+-]?)\\d+(?:\\.\\d+)?)Lon((?:[+-]?)\\d+(?:\\.\\d+)?)$/.exec(id);\r\n            id = self.LAT + match[2] + self.LON + match[1];\r\n            point = self.getPoint(id);\r\n\r\n            if (point) {\r\n                title = self.getLabel(id);\r\n                promise = self.layer.addMarker(point, TC.Util.extend({}, self.map.options.styles.point, { title: title, group: title }));\r\n\r\n                self.textInput.value = title;\r\n            }\r\n        }\r\n\r\n        promise.then(function (feat) {\r\n            self.map.trigger(TC.Consts.event.FEATURESADD, {\r\n                layer: self.layer, features: [feat]\r\n            });\r\n\r\n            self.map.zoomToFeatures([feat]);\r\n\r\n            self.loading.removeWait(wait);\r\n        });\r\n\r\n    };\r\n    ctlProto.goToCoordinates = function (id) {\r\n        var self = this;\r\n        var goTo = {};\r\n        if (/^X(\\d+(?:[\\.\\,]\\d+)?)Y(\\d+(?:[\\.\\,]\\d+)?)$/.test(id) || /^Lat((?:[+-]?)\\d+(?:[.,]\\d+)?)Lon((?:[+-]?)\\d+(?:[.,]\\d+)?)$/.test(id)) {\r\n\r\n            goTo.params = {\r\n                type: TC.Consts.layerType.VECTOR,\r\n                styles: {\r\n                    marker: {\r\n                        url: self.layerStyleFN.bind(self, 'marker', 'url', true)\r\n                    }\r\n                }\r\n            };\r\n\r\n            goTo.emptyResultHTML = '<li><a class=\"tc-ctl-search-li-empty\">' + self.OUTBBX_LABEL + '</a></li>';\r\n\r\n            drawPoint.call(self, id);\r\n\r\n            return goTo;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    ctlProto.goToCadastralRef = function (id) {\r\n        var self = this;\r\n        var goTo = {};\r\n\r\n        var regex = new RegExp(\"^\" + self.MUN + \"(\\\\d+)\" + self.POL + \"(\\\\d{1,2})\" + self.PAR + \"{1}(\\\\d{1,4})\");\r\n        if (regex.test(id)) {\r\n            var match = regex.exec(id);\r\n\r\n            if (!TC.filter) {\r\n                TC.syncLoadJS(TC.apiLocation + 'TC/Filter');\r\n            }\r\n\r\n            var type = self.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL);\r\n\r\n            goTo.params = {\r\n                type: TC.Consts.layerType.WFS,\r\n                url: type.url,\r\n                version: type.version,\r\n                geometryName: type.geometryName,\r\n                featurePrefix: type.featurePrefix,\r\n                featureType: type.featureType,\r\n                properties: new TC.filter.and(\r\n                    new TC.filter.equalTo(type.queryProperties.firstQueryWord, match[1].trim()),\r\n                    new TC.filter.equalTo(type.queryProperties.secondQueryWord, match[2].trim()),\r\n                    new TC.filter.equalTo(type.queryProperties.thirdQueryWord, match[3].trim())),\r\n                outputFormat: type.outputFormat,\r\n                styles: type.styles\r\n            };\r\n\r\n            goTo.emptyResultHTML = '<li><a title=\"' + self.EMPTY_RESULTS_TITLE + '\" class=\"tc-ctl-search-li-empty\">' + self.EMPTY_RESULTS_LABEL + '</a></li>';\r\n\r\n            return goTo;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    ctlProto.goToRoad = function (id) {\r\n        var self = this;\r\n        var goTo = {};\r\n\r\n        var type = self.getSearchTypeByRole(TC.Consts.searchType.ROAD);\r\n\r\n        goTo.params = {\r\n            type: TC.Consts.layerType.WFS,\r\n            url: type.url,\r\n            version: type.version,\r\n            geometryName: type.geometryName,\r\n            featurePrefix: type.featurePrefix,\r\n            featureType: type.getFeatureTypes(),\r\n            maxFeatures: 3000,\r\n            properties: type.filter.getGoToFilter(id),\r\n            outputFormat: type.outputFormat,\r\n            styles: type.styles\r\n        };\r\n\r\n        goTo.emptyResultHTML = '<li><a title=\"' + self.EMPTY_RESULTS_TITLE + '\" class=\"tc-ctl-search-li-empty\">' + self.EMPTY_RESULTS_LABEL + '</a></li>';\r\n\r\n        return goTo;\r\n    };\r\n\r\n    ctlProto.goToPK = function (id) {\r\n        var self = this;\r\n        var goTo = {};\r\n\r\n        var type = self.getSearchTypeByRole(TC.Consts.searchType.ROADPK);\r\n\r\n        goTo.params = {\r\n            type: TC.Consts.layerType.WFS,\r\n            url: type.url,\r\n            version: type.version,\r\n            geometryName: type.geometryName,\r\n            featurePrefix: type.featurePrefix,\r\n            featureType: type.getFeatureTypes(),\r\n            maxFeatures: 3000,\r\n            properties: type.filter.getGoToFilter(id),\r\n            outputFormat: type.outputFormat,\r\n            styles: type.styles\r\n        };\r\n\r\n        goTo.emptyResultHTML = '<li><a title=\"' + self.EMPTY_RESULTS_TITLE + '\" class=\"tc-ctl-search-li-empty\">' + self.EMPTY_RESULTS_LABEL + '</a></li>';\r\n\r\n        return goTo;\r\n    };\r\n\r\n    ctlProto.goToStringPattern = function (id, dataRole) {\r\n        var self = this;\r\n        var goTo = {};\r\n\r\n        var type = self.getSearchTypeByRole(dataRole);\r\n\r\n        goTo.params = {\r\n            type: TC.Consts.layerType.WFS,\r\n            url: type.url,\r\n            version: type.version,\r\n            geometryName: type.geometryName,\r\n            featurePrefix: type.featurePrefix,\r\n            featureType: type.getFeatureTypes(),\r\n            maxFeatures: 3000,\r\n            properties: type.filter.getGoToFilter(id),\r\n            outputFormat: type.outputFormat,\r\n            styles: type.styles\r\n        };\r\n\r\n        return goTo;\r\n    };\r\n\r\n    ctlProto.getPoint = function (pattern) {\r\n        var self = this;\r\n        var isMapGeo = self.map.wrap.isGeo();\r\n        var point;\r\n        var match = /^X(\\d+(?:\\.\\d+)?)Y(\\d+(?:\\.\\d+)?)$/.exec(pattern);\r\n        if (match && match.length === 3) {\r\n            point = [parseFloat(match[1]), parseFloat(match[2])];\r\n            if (isMapGeo) {\r\n                point = TC.Util.reproject(point, self.map.options.utmCrs, self.map.crs);\r\n            }\r\n        }\r\n        else {\r\n            match = /^Lat((?:[+-]?)\\d+(?:[.,]\\d+)?)Lon((?:[+-]?)\\d+(?:[.,]\\d+)?)$/.exec(pattern);\r\n            if (match && match.length === 3) {\r\n                point = [parseFloat(match[2]), parseFloat(match[1])];\r\n                if (!isMapGeo) {\r\n                    return TC.Util.reproject(point, self.map.options.geoCrs, self.map.crs);\r\n                }\r\n            }\r\n\r\n            match = /^Lon((?:[+-]?)\\d+(?:[.,]\\d+)?)Lat((?:[+-]?)\\d+(?:[.,]\\d+)?)$/.exec(pattern);\r\n            if (match && match.length === 3) {\r\n                point = [parseFloat(match[2]), parseFloat(match[1])];\r\n                if (!isMapGeo) {\r\n                    return TC.Util.reproject(point, self.map.options.geoCrs, self.map.crs);\r\n                }\r\n            }\r\n        }\r\n\r\n        return point;\r\n    };\r\n\r\n    ctlProto.insideLimit = function (point) {\r\n        var self = this;\r\n        var getIntersectsBounds = function (extent, point) {\r\n            if (extent instanceof Array)\r\n                return point[0] >= extent[0] && point[0] <= extent[2] && point[1] >= extent[1] && point[1] <= extent[3];\r\n            else return true;\r\n        };\r\n\r\n        if (getIntersectsBounds(self.map.options.maxExtent, point)) {\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    };\r\n\r\n    ctlProto.getPattern = function () {\r\n        var self = this;\r\n        return self.textInput.value;\r\n    };\r\n\r\n    ctlProto.getLabel = function (id) {\r\n        var self = this;\r\n        var result = id;\r\n        var locale = TC.Util.getMapLocale(self.map);\r\n\r\n        if (id.match(new RegExp('^(?:' + self.LAT + '[-\\\\d])|(?:' + self.UTMX + '[\\\\d])'))) {\r\n            result = result.replace(self.LAT, self.LAT_LABEL).replace(self.LON, ' ' + self.LON_LABEL).replace(self.UTMX, self.UTMX_LABEL).replace(self.UTMY, ' ' + self.UTMY_LABEL);\r\n            var match = result.match(new RegExp('^' + self.LAT_LABEL.trim() + '*\\\\s*([-+]?\\\\d{1,3}([.,]\\\\d+)?)\\\\,?\\\\s*' + self.LON_LABEL.trim() + '*\\\\s*([-+]?\\\\d{1,2}([.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                result = result.replace(match[1], parseFloat(match[1]).toLocaleString(locale));\r\n                result = result.replace(match[3], parseFloat(match[3]).toLocaleString(locale));\r\n            }\r\n\r\n            var localeDecimalSeparator = 1.1.toLocaleString(locale).substring(1, 2);\r\n            var match = result.match(new RegExp('^' + self.UTMX_LABEL.trim() + '*\\\\s*([0-9]{' + self.UTMX_LEN + '}(?:[.,]\\\\d+)?)\\\\s*\\\\,?\\\\s*' + self.UTMY_LABEL.trim() + '*\\\\s*([0-9]{' + self.UTMY_LEN + '}(?:[.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                if (!Number.isInteger(parseFloat(match[1])))\r\n                    result = result.replace(match[1], match[1].replace('.', localeDecimalSeparator));\r\n                if (!Number.isInteger(parseFloat(match[2])))\r\n                    result = result.replace(match[2], match[2].replace('.', localeDecimalSeparator));\r\n            }\r\n\r\n        } else if (id.match(new RegExp('^(?:' + self.LON + '[-\\\\d])'))) {\r\n            result = result.replace(self.LON, self.LON_LABEL).replace(self.LAT, ' ' + self.LAT_LABEL);\r\n\r\n            var match = result.match(new RegExp('^' + self.LON_LABEL.trim() + '*\\\\s*([-+]?\\\\d{1,3}([.,]\\\\d+)?)\\\\,?\\\\s*' + self.LAT_LABEL.trim() + '*\\\\s*([-+]?\\\\d{1,2}([.,]\\\\d+)?)$'));\r\n            if (match) {\r\n                result = result.replace(match[1], parseFloat(match[1]).toLocaleString(locale));\r\n                result = result.replace(match[3], parseFloat(match[3]).toLocaleString(locale));\r\n            }\r\n\r\n        } else if (id.match(new RegExp('^(?:(\\\\' + self.MUN + '{1})(.*)' + '(\\\\' + self.POL + '{1})' + '(\\\\d{1,2})' + '(\\\\' + self.PAR + '{1})' + '(\\\\d{1,4}))'))) {\r\n            var match = id.match(new RegExp('^(?:(\\\\' + self.MUN + '{1})(.*)' + '(\\\\' + self.POL + '{1})' + '(\\\\d{1,2})' + '(\\\\' + self.PAR + '{1})' + '(\\\\d{1,4}))'));\r\n            result = self.MUN_LABEL + match[2] + ', ' + self.POL_LABEL + match[4] + ', ' + self.PAR_LABEL + match[6];\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.removePunctuation = function (text) {\r\n        text = text || '';\r\n        var result = new Array(text.length);\r\n        var map = {\r\n            'á': 'a',\r\n            'à': 'a',\r\n            'Á': 'A',\r\n            'À': 'A',\r\n            'é': 'e',\r\n            'è': 'e',\r\n            'É': 'E',\r\n            'È': 'E',\r\n            'í': 'i',\r\n            'ì': 'i',\r\n            'Í': 'I',\r\n            'Ì': 'I',\r\n            'ó': 'o',\r\n            'ò': 'o',\r\n            'Ó': 'O',\r\n            'Ò': 'O',\r\n            'ú': 'u',\r\n            'ù': 'u',\r\n            'ü': 'u',\r\n            'Ú': 'U',\r\n            'Ù': 'U',\r\n            'Ü': 'U'\r\n        };\r\n        for (var i = 0, len = text.length; i < len; i++) {\r\n            result[i] = map[text.charAt(i)] || text.charAt(i);\r\n        }\r\n        return result.join('');\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState) {\r\n            return {\r\n                id: self.id,\r\n                searchText: self.textInput.value,\r\n                layer: self.layer.exportState({\r\n                    exportStyles: false\r\n                })\r\n            };\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        self.textInput.value = state.searchText;\r\n        self.layer.importState(state.layer).then(function () {\r\n            self.layer.features.forEach(function (f) {\r\n                f.setStyle(null); // Los estilos vienen dados exclusivamente por la capa, borramos estilos propios de la feature\r\n            });\r\n        });\r\n    };\r\n\r\n})();\r\n\r\n\r\nif (!String.prototype.tcFormat) {\r\n    String.prototype.tcFormat = function () {\r\n        var args = (arguments || [\"\"])[0];\r\n        return this.replace(/{(\\d+)}/g, function (match, number) {\r\n            return typeof args[number] != 'undefined' ?\r\n                args[number]\r\n                : match\r\n                ;\r\n        });\r\n    };\r\n}\r\n\r\n\r\nif (!String.prototype.splitRemoveWhiteSpaces) {\r\n    String.prototype.splitRemoveWhiteSpaces = function (separator) {\r\n        var _arr = [];\r\n        var arr = this.split(separator);\r\n        for (var i = 0; i < arr.length; i++)\r\n            if (arr[i].trim().length > 0)\r\n                _arr.push(arr[i].trim());\r\n\r\n        return _arr;\r\n    };\r\n}\r\n\r\n\r\nif (!String.prototype.toCamelCase) {\r\n    String.prototype.toCamelCase = function () {\r\n        var _value = this.toLowerCase();\r\n        var match = this.toLowerCase().match(/[^A-ZÁÉÍÓÚÜÀÈÌÒÙáéíóúüàèìòùa-z0-9_]+(.)/g);\r\n        if (match) {\r\n            for (var i = 0; i < match.length; i++) {\r\n                if (/[-;:.<>\\{\\}\\[\\]\\/\\s()]/g.test(match[i]))\r\n                    _value = _value.replace(match[i], match[i].toUpperCase());\r\n            }\r\n        }\r\n\r\n        return _value.charAt(0).toUpperCase() + _value.substring(1);\r\n    };\r\n}\r\n\r\n\r\nif (!Array.prototype.hasOwnProperty('findByProperty')) {\r\n    Object.defineProperty(Array.prototype, \"findByProperty\", {\r\n        enumerable: false,\r\n        writable: true,\r\n        value: function (propertyName, value) {\r\n            for (var i = 0; i < this.length; i++) {\r\n                if (this[i][propertyName] == value)\r\n                    return this[i];\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nif (!String.prototype.endsWith) {\r\n    String.prototype.endsWith = function (searchString, position) {\r\n        var subjectString = this.toString();\r\n        if (typeof position !== 'number' || !isFinite(position) || Math.floor(position) !== position || position > subjectString.length) {\r\n            position = subjectString.length;\r\n        }\r\n        position -= searchString.length;\r\n        var lastIndex = subjectString.indexOf(searchString, position);\r\n        return lastIndex !== -1 && lastIndex === position;\r\n    };\r\n}\r\n"]}