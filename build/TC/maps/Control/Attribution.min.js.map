{"version":3,"sources":["control/Attribution.js"],"names":["TC","control","Control","syncLoadJS","apiLocation","Attribution","self","this","apply","arguments","apiAttribution","mainDataAttribution","dataAttributions","options","Array","inherit","ctlProto","prototype","CLASS","template","dust","register","body_0","chk","ctx","w","f","get","x","block","body_1","body_5","body_6","s","body_7","__dustBody","h","$key","getPath","else","body_2","body_4","body_3","body_8","body_9","body_10","map","result","call","attribution","addData","obj","attr","getAttribution","test","name","site","textExists","i","length","push","removeData","Layer","workLayers","_wl","slice","reverse","url","getVisibility","checkRemoveData","index","reduce","prev","cur","idx","checkIsSameAttribution","toCheckName","baseLayer","wrap","filter","layer","type","Consts","layerType","WMS","WMTS","some","workLayerAttribution","splice","loaded","render","on","event","LAYERADD","e","isBase","BEFOREBASELAYERCHANGE","OVERVIEWBASELAYERCHANGE","newLayer","oldLayer","indexOf","ignoreLayer","LAYERREMOVE","TERRAINPROVIDERADD","terrainProvider","TERRAINPROVIDERREMOVE","LAYERVISIBILITY","callback","_set1stRenderPromise","renderData","api","getLocaleString","mainData","otherData","isCollapsed","div","querySelector","classList","contains","classes","COLLAPSED","cmd","addEventListener","CLICK","toggleOtherAttributions","toggle"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.control.Attribution = function () {\r\n    const self = this;\r\n\r\n    TC.Control.apply(self, arguments);\r\n\r\n    self.apiAttribution = '';\r\n    self.mainDataAttribution = null;\r\n    self.dataAttributions = [];\r\n    if (self.options.dataAttributions) {\r\n        self.dataAttributions = self.options.dataAttributions instanceof Array ? self.options.dataAttributions : [self.options.dataAttributions];\r\n    }\r\n};\r\n\r\nTC.inherit(TC.control.Attribution, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Attribution.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-attrib';\r\n\r\n    ctlProto.template = TC.apiLocation + \"TC/templates/Attribution.html\";\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self.apiAttribution = self.map.options.attribution || self.apiAttribution;\r\n\r\n        var addData = function (obj) {\r\n            if (obj) {\r\n                // TODO: sanitizer\r\n                var attr = obj.getAttribution();\r\n                if (attr) {\r\n                    if (/IDENA/.test(attr.name) || /Tracasa Instrumental/.test(attr.name)) {\r\n                        self.mainDataAttribution = {\r\n                            name: 'IDENA',\r\n                            site: 'http://idena.navarra.es/'\r\n                        };\r\n                    }\r\n                    else {\r\n                        var textExists = false;\r\n                        for (var i = 0; i < self.dataAttributions.length; i++) {\r\n                            if (attr.name === self.dataAttributions[i].name) {\r\n                                textExists = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (!textExists) {\r\n                            self.dataAttributions.push(attr);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        var removeData = function (obj) {\r\n            if (obj) {\r\n\r\n                var checkRemoveData = function () {\r\n                    if (obj.map.workLayers.length > 0) {\r\n                        var _wl = obj.map.workLayers.slice().reverse();\r\n                        for (var i = 0; i < _wl.length; i++) {\r\n                            if (_wl[i].url == obj.url && _wl[i].getVisibility())\r\n                                return false;\r\n                        }\r\n\r\n                        return true;\r\n                    }\r\n\r\n                    return true;\r\n                };\r\n\r\n                if (obj instanceof TC.Layer ? checkRemoveData() : true) {\r\n                    // TODO: sanitizer\r\n                    var attr = obj.getAttribution();\r\n\r\n                    if (attr) {\r\n                        var index = self.dataAttributions.reduce(function (prev, cur, idx) {\r\n                            if (cur.name === attr.name) {\r\n                                return idx;\r\n                            }\r\n                            return prev;\r\n                        }, -1);\r\n\r\n                        const checkIsSameAttribution = function (toCheckName) {\r\n                            return (/IDENA/.test(attr.name) || /Tracasa Instrumental/.test(attr.name)) &&\r\n                                (/IDENA/.test(toCheckName) || /Tracasa Instrumental/.test(toCheckName)) ||\r\n                                    (attr.name === toCheckName);\r\n                        };\r\n\r\n                        // Validamos si las atribuciones a borrar son también del mapa base\r\n                        if (self.map.baseLayer && self.map.baseLayer.wrap.getAttribution() && checkIsSameAttribution(self.map.baseLayer.wrap.getAttribution().name)) {\r\n                            return;\r\n                        } else {\r\n                            // Validamos si las atribuciones a borrar son también de alguna de las capas raster cargadas\r\n                            if (self.map.workLayers.filter(function (layer) {\r\n                                return layer.type === TC.Consts.layerType.WMS || layer.type === TC.Consts.layerType.WMTS;\r\n                            }).some(function (layer) {\r\n                                var workLayerAttribution = layer.wrap.getAttribution();\r\n                                return workLayerAttribution && checkIsSameAttribution(workLayerAttribution.name);\r\n                            })) {\r\n                                return;\r\n                            }\r\n                        }\r\n\r\n                        if (index > -1) {\r\n                            self.dataAttributions.splice(index, 1);\r\n                        } else if (/IDENA/.test(attr.name) || /Tracasa Instrumental/.test(attr.name)) {\r\n                            self.mainDataAttribution = null;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        };\r\n        //URI: Si las atribuciones están vacias evito hace una llamada al renderizado del control ya que lo obtendría sin datos.\r\n        //self.render();\r\n\r\n        map.loaded(function () {\r\n            if (map.baseLayer.wrap.getAttribution) {\r\n                addData(map.baseLayer.wrap);\r\n                self.render();\r\n            }\r\n        });\r\n\r\n        map.on(TC.Consts.event.LAYERADD, function (e) {\r\n            const layer = e.layer;\r\n            if (!layer.isBase && layer.wrap.getAttribution && layer.wrap.getAttribution()) {\r\n                addData(layer.wrap);\r\n                self.render();\r\n            }\r\n        });\r\n\r\n        map.on(TC.Consts.event.BEFOREBASELAYERCHANGE + \" \" + TC.Consts.event.OVERVIEWBASELAYERCHANGE, function (e) {\r\n            const type = e.type;\r\n            const newLayer = e.newLayer;\r\n            const oldLayer = e.oldLayer;\r\n            if (TC.Consts.event.OVERVIEWBASELAYERCHANGE.indexOf(type) > -1) {\r\n                self.ignoreLayer = newLayer;\r\n            }\r\n\r\n            if (oldLayer && oldLayer.wrap.getAttribution) {\r\n                removeData(oldLayer.wrap);\r\n            }\r\n\r\n            if (newLayer && newLayer.wrap.getAttribution) {\r\n                addData(newLayer.wrap);\r\n            }\r\n\r\n            self.render();\r\n        });\r\n\r\n        map.on(TC.Consts.event.LAYERREMOVE, function (e) {\r\n            const layer = e.layer;\r\n            if (layer.wrap.getAttribution) {\r\n                removeData(layer.wrap);\r\n                self.render();\r\n            }\r\n        });\r\n\r\n        map.on(TC.Consts.event.TERRAINPROVIDERADD, function (e) {\r\n            const terrainProvider = e.terrainProvider;\r\n            if (terrainProvider.getAttribution) {\r\n                addData(terrainProvider);\r\n                self.render();\r\n            }\r\n        });\r\n\r\n        map.on(TC.Consts.event.TERRAINPROVIDERREMOVE, function (e) {\r\n            const terrainProvider = e.terrainProvider;\r\n            if (terrainProvider.getAttribution) {\r\n                removeData(terrainProvider);\r\n                self.render();\r\n            }\r\n        });\r\n\r\n        map.on(TC.Consts.event.LAYERVISIBILITY, function (e) {\r\n            const layer = e.layer;\r\n            if (self.ignoreLayer === layer) {\r\n                return;\r\n            }\r\n\r\n            if (layer.wrap.getAttribution) {\r\n                if (layer.getVisibility()) {\r\n                    addData(layer.wrap);\r\n                } else {\r\n                    removeData(layer.wrap);\r\n                }\r\n                self.render();\r\n            }\r\n        });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;        \r\n\r\n        return self._set1stRenderPromise(self.renderData({\r\n            api: (typeof (self.apiAttribution) === 'function' ? self.apiAttribution.apply(self) : self.getLocaleString(self.apiAttribution)),\r\n            mainData: self.mainDataAttribution,\r\n            otherData: self.dataAttributions,\r\n            isCollapsed: self.div.querySelector('.' + self.CLASS + '-other') ? self.div.querySelector('.' + self.CLASS + '-other').classList.contains(TC.Consts.classes.COLLAPSED) : true\r\n        }, function () {\r\n            const cmd = self.div.querySelector('.' + self.CLASS + '-cmd');\r\n            cmd && cmd.addEventListener(TC.Consts.event.CLICK, function () {\r\n                self.toggleOtherAttributions();\r\n            });\r\n\r\n            if (typeof callback === 'function') {\r\n                callback();\r\n            }\r\n        }));\r\n    };\r\n\r\n    ctlProto.toggleOtherAttributions = function () {\r\n        const self = this;\r\n        const other = self.div.querySelector('.' + self.CLASS + '-other');\r\n        other.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n    };\r\n})();\r\n"]}