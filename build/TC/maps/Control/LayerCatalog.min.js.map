{"version":3,"sources":["control/LayerCatalog.js"],"names":["TC","control","ProjectionSelector","syncLoadJS","apiLocation","LayerCatalog","this","layers","searchInit","apply","arguments","_selectors","LAYER_ROOT","CLASS","Consts","classes","SELECTABLE","INCOMPATIBLE","ACTIVE","inherit","ctlProto","prototype","template","dust","register","body_0","chk","ctx","w","h","$key","x","get","block","body_1","else","body_4","body_8","p","rebase","getPath","__dustBody","body_2","body_3","body_5","body_6","s","body_7","f","body_9","key","value","showProjectionChangeDialog","ctl","layer","closeCallback","getLayerNodes","forEach","node","classList","remove","LOADING","querySelector","dataset","tooltip","getLocaleString","map","self","result","call","load","resolve","reject","Array","isArray","options","i","length","type","layerType","WMS","id","getUID","Util","isPlainObject","Raster","push","render","_readyPromise","Promise","waitLoad","e","baseLayer","off","event","LAYERUPDATE","loaded","state","Layer","IDLE","on","clickToAddText","BEFORELAYERADD","BEFOREUPDATEPARAMS","add","LAYERADD","UPDATEPARAMS","isBase","then","getLayerRootNode","updateControl","layerAlreadyAdded","len","lyr","url","layersToSetChecked","addLayer","layerNames","title","wrap","getServiceTitle","hideTitle","hideTree","LAYERERROR","reason","some","alert","LAYERREMOVE","CHECKED","list","querySelectorAll","li","getLayer","layerId","names","layerName","findResultNodes","layerRemoved","wlCtrl","getControlsByClass","WorkLayerManager","_markWorkLayersAsAdded","_refreshResultList","EXTERNALSERVICEADDED","div","COLLAPSED","PROJECTIONCHANGE","update","onCollapseButtonClick","target","blur","stopPropagation","parentElement","tagName","contains","toggle","document","evt","createEvent","initEvent","textInput","dispatchEvent","fireEvent","addLogicToNode","btn","addEventListener","span","parentNode","preventDefault","undefined","toString","_roots","root","redrawTime","test","navigator","userAgent","detectFirefox","getTree","element","setTimeout","offsetHeight","offsetWidth","addLayerToMap","onSpanClick","a","name","info","getInfo","hasOwnProperty","CLICK","showLayerInfo","hideLayerInfo","removeChild","compatibleLayers","indexOf","setAttribute","j","workLayers","wl","index","array","splice","getRenderedHtml","html","_dialogDiv","innerHTML","renderBranch","callback","promiseRenderResolve","getCapabilitiesPromise","sourceLayers","makeNodeVisible","childrenVisible","children","isVisible","getLayerTree","createElement","newChild","content","firstChild","oldChild","replaceChild","appendChild","childElementCount","isFunction","l","bind","catch","error","errorMessage","serviceName","liError","toast","msgType","ERROR","_set1stRenderPromise","renderData","layerTrees","enableSearch","layerCheckedList","_search","retryTimeout","loadJS","UI","autocomplete","link","minLength","source","text","item","trim","clearTimeout","results","_founds","searchSubLayers","service","founds","servicesFound","servicesLooked","interval","innerText","lastPattern","goToResult","unescape","hash","substring","buildHTML","data","container","k","alreadyAdded","Name","isCollapsed","ret","out","EventTarget","listenerBySelector","wasCollapsed","searchPane","treePane","infoPane","searchPaneMustShow","HIDDEN","focus","parent","serviceIndex","searchListElementSelector","matches","liParent","layerIdx","isCompatible","crs","$events","TILELOADERROR","code","removeLayer","rootNode","liLayer","toggleInfo","infoObj","err","formatDescriptions","ii","as","jj","n","metadata","md","formatDescription","format","getSimpleMimeType","getCompatibleLayers","removeAttribute","fromLayerCatalog","filter","getMap","reqGetMapOnCapabilities","replace","regex","PROTOCOL","configLayer","layerOptions","extend","newLayer","getAvailableCRS","getCompatibleCRS","concat","includeFallbacks","setProjection","loadProjDef","_layerToAdd","closeModal"],"mappings":"AAAAA,GAAGC,QAAUD,GAAGC,SAAW,GAEtBD,GAAGC,QAAQC,oBACZF,GAAGG,WAAWH,GAAGI,YAAc,kCAGnC,WAEIJ,GAAGC,QAAQI,aAAe,WACXC,KAENC,OAAS,GAFHD,KAGNE,YAAa,EAElBR,GAAGC,QAAQC,mBAAmBO,MALnBH,KAK+BI,WAL/BJ,KAONK,WAAa,CACdC,WAAY,OARLN,KAQmBO,MAAQ,cAR3BP,KAQgDO,MAAQ,gBARxDP,KAQ+EO,MAAQ,SAG7Fb,GAAGc,OAAOC,QAAQC,aACnBhB,GAAGc,OAAOC,QAAQC,WAAa,iBAE9BhB,GAAGc,OAAOC,QAAQE,eACnBjB,GAAGc,OAAOC,QAAQE,aAAe,mBAEhCjB,GAAGc,OAAOC,QAAQG,SACnBlB,GAAGc,OAAOC,QAAQG,OAAS,cAInClB,GAAGmB,QAAQnB,GAAGC,QAAQI,aAAcL,GAAGC,QAAQC,oBAE/C,IAAIkB,EAAWpB,GAAGC,QAAQI,aAAagB,UAEvCD,EAASP,MAAQ,cAEjBO,EAASE,SAAW,GACpBF,EAASE,SAASF,EAASP,OAAS,WAAWU,KAAKC,SAASJ,EAASP,MAAMY,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBC,EAAEJ,EAAIK,IAAI,CAAC,iBAAiB,GAAOL,EAAI,CAACM,MAAQC,GAAQ,IAAIN,EAAE,6JAAsKC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,yBAAyBF,EAAE,yDAA4DG,EAAEJ,EAAIK,IAAI,CAAC,eAAe,GAAOL,EAAI,CAACQ,KAAOC,EAAOH,MAAQI,GAAQ,IAAIT,EAAE,kDAAoDU,EAAE,mBAAmBX,EAAIA,EAAIY,OAAOZ,EAAIa,SAAQ,EAAM,KAAK,IAAIZ,EAAE,UAAWH,EAAOgB,YAAW,EAAG,SAASP,EAAOR,EAAIC,GAAK,OAAOD,EAAIK,EAAEJ,EAAIK,IAAI,CAAC,eAAe,GAAOL,EAAI,CAACM,MAAQS,GAAQ,IAAIX,EAAEJ,EAAIK,IAAI,CAAC,WAAW,GAAOL,EAAI,CAACM,MAAQU,GAAQ,IAAKT,EAAOO,YAAW,EAAG,SAASC,EAAOhB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,kDAAqDC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,uBAAuBF,EAAE,eAAiBc,EAAOD,YAAW,EAAG,SAASE,EAAOjB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,kDAAqDC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,uBAAuBF,EAAE,eAAiBe,EAAOF,YAAW,EAAG,SAASL,EAAOV,EAAIC,GAAK,OAAOD,EAAIK,EAAEJ,EAAIK,IAAI,CAAC,WAAW,GAAOL,EAAI,CAACQ,KAAOS,EAAOX,MAAQY,GAAQ,IAAKT,EAAOK,YAAW,EAAG,SAASG,EAAOlB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,kDAAoDC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,qBAAqBF,EAAE,oBAAqBgB,EAAOH,YAAW,EAAG,SAASI,EAAOnB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mCAAqCkB,EAAEnB,EAAIK,IAAI,CAAC,WAAW,GAAOL,EAAI,CAACM,MAAQc,GAAQ,IAAInB,EAAE,SAAUiB,EAAOJ,YAAW,EAAG,SAASM,EAAOrB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,uBAAwBoB,EAAErB,EAAIK,IAAI,CAAC,OAAO,GAAOL,EAAI,KAAKC,EAAE,aAAeC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,kBAAkBF,EAAE,wCAA2CoB,EAAErB,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,KAAKC,EAAE,SAAUmB,EAAON,YAAW,EAAG,SAASJ,EAAOX,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mCAAqCkB,EAAEnB,EAAIK,IAAI,CAAC,eAAe,GAAOL,EAAI,CAACM,MAAQgB,GAAQ,IAAIrB,EAAE,SAAUS,EAAOI,YAAW,EAAG,SAASQ,EAAOvB,EAAIC,GAAK,OAAOD,EAAIY,EAAE,qBAAqBX,EAAIA,EAAIY,OAAOZ,EAAIa,SAAQ,EAAM,KAAK,IAAKS,EAAOR,YAAW,EAAG,OAAOhB,GACvvEL,EAASE,SAASF,EAASP,MAAQ,WAAa,WAAWU,KAAKC,SAASJ,EAASP,MAAQ,UAAUY,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQG,EAAEJ,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACQ,KAAOD,EAAOD,MAAQS,GAAQ,IAAId,EAAE,sBAAuBoB,EAAErB,EAAIK,IAAI,CAAC,SAAS,GAAOL,EAAI,KAAKC,EAAE,sBAAwBoB,EAAErB,EAAIK,IAAI,CAAC,QAAQ,GAAOL,EAAI,KAAKC,EAAE,8DAAiEoB,EAAErB,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,KAAKC,EAAE,uDAAyDkB,EAAEnB,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACM,MAAQU,GAAQ,IAAIf,EAAE,cAAeH,EAAOgB,YAAW,EAAG,SAASP,EAAOR,EAAIC,GAAK,OAAOD,EAAIE,EAAE,6CAAgDM,EAAOO,YAAW,EAAG,SAASC,EAAOhB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,yCAA4Cc,EAAOD,YAAW,EAAG,SAASE,EAAOjB,EAAIC,GAAK,OAAOD,EAAIY,EAAE,mBAAmBX,EAAIA,EAAIY,OAAOZ,EAAIa,SAAQ,EAAM,KAAK,IAAKG,EAAOF,YAAW,EAAG,OAAOhB,GAC76BL,EAASE,SAASF,EAASP,MAAQ,SAAW,WAAWU,KAAKC,SAASJ,EAASP,MAAQ,QAAQY,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIK,EAAEJ,EAAIK,IAAI,CAAC,cAAc,GAAOL,EAAI,CAACM,MAAQC,GAAQ,IAAKT,EAAOgB,YAAW,EAAG,SAASP,EAAOR,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQG,EAAEJ,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACQ,KAAOO,EAAOT,MAAQU,GAAQ,IAAIf,EAAE,sBAAuBoB,EAAErB,EAAIK,IAAI,CAAC,SAAS,GAAOL,EAAI,KAAKC,EAAE,sBAAwBoB,EAAErB,EAAIK,IAAI,CAAC,QAAQ,GAAOL,EAAI,KAAKC,EAAE,MAAOG,EAAEJ,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACM,MAAQG,GAAQ,IAAIR,EAAE,wBAAyBG,EAAEJ,EAAIK,IAAI,CAAC,SAAS,GAAOL,EAAI,CAACM,MAAQW,GAAQ,IAAIhB,EAAE,MAAOoB,EAAErB,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,KAAKC,EAAE,WAAWG,EAAEJ,EAAIK,IAAI,CAAC,SAAS,GAAOL,EAAI,CAACM,MAAQY,GAAQ,IAAIjB,EAAE,gDAAkDkB,EAAEnB,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACM,MAAQc,GAAQ,IAAInB,EAAE,cAAeM,EAAOO,YAAW,EAAG,SAASC,EAAOhB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,6CAAgDc,EAAOD,YAAW,EAAG,SAASE,EAAOjB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,yCAA4Ce,EAAOF,YAAW,EAAG,SAASL,EAAOV,EAAIC,GAAK,OAAOD,EAAIE,EAAE,sDAAyDQ,EAAOK,YAAW,EAAG,SAASG,EAAOlB,EAAIC,GAAK,OAAOD,EAAIG,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAqBc,EAAOH,YAAW,EAAG,SAASI,EAAOnB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mBAAoBC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,sBAAsBF,EAAE,4CAAgDiB,EAAOJ,YAAW,EAAG,SAASM,EAAOrB,EAAIC,GAAK,OAAOD,EAAIY,EAAE,mBAAmBX,EAAIA,EAAIY,OAAOZ,EAAIa,SAAQ,EAAM,KAAK,IAAKO,EAAON,YAAW,EAAG,OAAOhB,GACrjDL,EAASE,SAASF,EAASP,MAAQ,SAAW,WAAWU,KAAKC,SAASJ,EAASP,MAAQ,QAAQY,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,8CAAgDC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,cAAcF,EAAE,uCAAyCoB,EAAErB,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,KAAKC,EAAE,SAASG,EAAEJ,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACM,MAAQC,GAAQ,IAAIH,EAAEJ,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACM,MAAQS,GAAQ,IAAKjB,EAAOgB,YAAW,EAAG,SAASP,EAAOR,EAAIC,GAAK,OAAOD,EAAIE,EAAE,0CAA4CC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,aAAaF,EAAE,mBAAmBoB,EAAErB,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,IAAI,CAAC,MAAMC,EAAE,sBAAuBM,EAAOO,YAAW,EAAG,SAASC,EAAOhB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,0CAA4CC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,aAAaF,EAAE,aAAakB,EAAEnB,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACM,MAAQU,GAAQ,IAAIf,EAAE,eAAgBc,EAAOD,YAAW,EAAG,SAASE,EAAOjB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,iBAAkBoB,EAAErB,EAAIK,IAAI,CAAC,QAAQ,GAAOL,EAAI,IAAI,CAAC,MAAMC,EAAE,YAAcoB,EAAErB,EAAIK,IAAI,CAAC,WAAW,GAAOL,EAAI,KAAKC,EAAE,aAAeoB,EAAErB,EAAIK,IAAI,CAAC,sBAAsB,GAAOL,EAAI,KAAKC,EAAE,sBAAyBoB,EAAErB,EAAIK,IAAI,CAAC,sBAAsB,GAAOL,EAAI,IAAI,CAAC,MAAMC,EAAE,aAAce,EAAOF,YAAW,EAAG,OAAOhB,GACzuCL,EAASE,SAASF,EAASP,MAAQ,YAAc,WAAWU,KAAKC,SAASJ,EAASP,MAAQ,WAAWY,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIoB,EAAEnB,EAAIK,IAAI,CAAC,kBAAkB,GAAOL,EAAI,CAACQ,KAAOD,EAAOD,MAAQS,GAAQ,IAAKjB,EAAOgB,YAAW,EAAG,SAASP,EAAOR,EAAIC,GAAK,OAAOD,EAAIE,EAAE,2CAA6CC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,cAAcF,EAAE,cAAeM,EAAOO,YAAW,EAAG,SAASC,EAAOhB,EAAIC,GAAK,OAAOD,EAAIG,EAAE,KAAKF,EAAI,CAACM,MAAQU,GAAQ,CAACO,IAAMvB,EAAIK,IAAI,CAAC,mBAAmB,GAAOmB,MAAQ,IAAIL,EAAEnB,EAAIK,IAAI,CAAC,WAAW,GAAOL,EAAI,CAACM,MAAQW,GAAQ,IAAIf,EAAE,KAAKF,EAAI,CAACM,MAAQgB,GAAQ,CAACC,IAAMvB,EAAIK,IAAI,CAAC,mBAAmB,GAAOmB,MAAQ,IAAKT,EAAOD,YAAW,EAAG,SAASE,EAAOjB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,wCAAyCG,EAAEJ,EAAIa,SAAQ,EAAO,CAAC,UAAU,gBAAgBb,EAAI,CAACM,MAAQG,GAAQ,IAAIR,EAAE,0BAA4BoB,EAAErB,EAAIa,SAAQ,EAAO,CAAC,UAAU,UAAUb,EAAI,KAAKC,EAAE,UAAWoB,EAAErB,EAAIa,SAAQ,EAAO,CAAC,UAAU,UAAUb,EAAI,KAAKC,EAAE,aAAce,EAAOF,YAAW,EAAG,SAASL,EAAOV,EAAIC,GAAK,OAAOD,EAAIE,EAAE,gBAAiBQ,EAAOK,YAAW,EAAG,SAASG,EAAOlB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,yBAA0BoB,EAAErB,EAAIK,IAAI,CAAC,SAAS,GAAOL,EAAI,KAAKC,EAAE,MAAOG,EAAEJ,EAAIK,IAAI,CAAC,iBAAiB,GAAOL,EAAI,CAACM,MAAQY,GAAQ,IAAIjB,EAAE,8BAAgCG,EAAEJ,EAAIK,IAAI,CAAC,iBAAiB,GAAOL,EAAI,CAACQ,KAAOY,EAAOd,MAAQI,GAAQ,IAAIT,EAAE,KAAKoB,EAAErB,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,KAAKC,EAAE,4DAA+DC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,sBAAsBF,EAAE,oBAAsBgB,EAAOH,YAAW,EAAG,SAASI,EAAOnB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,uBAA0BiB,EAAOJ,YAAW,EAAG,SAASM,EAAOrB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mBAAoBC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,oBAAoBF,EAAE,KAAOmB,EAAON,YAAW,EAAG,SAASJ,EAAOX,EAAIC,GAAK,OAAOD,EAAIE,EAAE,mBAAoBC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,sBAAsBF,EAAE,KAAOS,EAAOI,YAAW,EAAG,SAASQ,EAAOvB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,cAAeqB,EAAOR,YAAW,EAAG,OAAOhB,GAC78DL,EAASE,SAASF,EAASP,MAAQ,WAAa,WAAWU,KAAKC,SAASJ,EAASP,MAAQ,UAAUY,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,qKAA6KC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,cAAcF,EAAE,+EAAmFC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,yCAAyCF,EAAE,oJAA4JC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,UAAUF,EAAE,+BAAgCH,EAAOgB,YAAW,EAAG,OAAOhB,GAEzvB,MAAM2B,EAA6B,SAAUC,EAAKC,GAC9CD,EAAID,2BAA2B,CAC3BE,MAAOA,EACPC,cAAe,WACXF,EAAIG,cAAcF,GAAOG,QAAQ,SAAUC,GACvCA,EAAKC,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQ8C,SACxCH,EAAKI,cAAc,QAAQC,QAAQC,QAAUX,EAAIY,gBAAgB,yBAQjF7C,EAASI,SAAW,SAAU0C,GAC1B,MAAMC,EAAO7D,KAEP8D,EAASpE,GAAGC,QAAQC,mBAAmBmB,UAAUG,SAAS6C,KAAKF,EAAMD,GAErEI,EAAO,SAAUC,EAASC,GAC5B,GAAIC,MAAMC,QAAQP,EAAKQ,QAAQpE,QAAS,CACpC,IAAK,IAAIqE,EAAI,EAAGA,EAAIT,EAAKQ,QAAQpE,OAAOsE,OAAQD,IAAK,CACjD,IAAItB,EAAQa,EAAKQ,QAAQpE,OAAOqE,GAChC,IAAKtB,EAAMwB,MAAQxB,EAAMwB,OAAS9E,GAAGc,OAAOiE,UAAUC,IAAK,CAClD1B,EAAM2B,KACP3B,EAAM2B,GAAKjF,GAAGkF,UAEdlF,GAAGmF,KAAKC,cAAc9B,KACtBA,EAAQ,IAAItD,GAAGsD,MAAM+B,OAAO/B,IAEhCa,EAAK5D,OAAO+E,KAAKhC,IAGzBa,EAAKoB,OAAO,WACRhB,WAIJA,KAIRJ,EAAKqB,cAAgB,IAAIC,QAAQ,SAAUlB,EAASC,GAChD,MAAMkB,EAAW,SAAUC,GACvB,GAAIA,EAAErC,QAAUY,EAAI0B,UAAW,CAC3BtB,EAAKC,GACLL,EAAI2B,IAAI7F,GAAGc,OAAOgF,MAAMC,YAAaL,KAI7CxB,EAAI8B,OAAO,WACF9B,EAAI0B,UAAUK,OAAS/B,EAAI0B,UAAUK,QAAUjG,GAAGkG,MAAMD,MAAME,KAI/DjC,EAAIkC,GAAGpG,GAAGc,OAAOgF,MAAMC,YAAaL,GAHpCpB,EAAKC,OAkDjB,IAAI8B,EAAiBlC,EAAKF,gBAAgB,mBAE1CC,EACKkC,GAAGpG,GAAGc,OAAOgF,MAAMQ,eAAiB,IAAMtG,GAAGc,OAAOgF,MAAMS,mBAAoB,SAAUZ,GACrFxB,EAAKX,cAAcmC,EAAErC,OAAOG,QAAQ,SAAUC,GAC1CA,EAAKC,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQ8C,gBAC9BH,EAAKI,cAAc,QAAQC,QAAQC,YAGjDoC,GAAGpG,GAAGc,OAAOgF,MAAMW,SAAW,IAAMzG,GAAGc,OAAOgF,MAAMY,aAAc,SAAUf,GACzE,MAAMrC,EAAQqC,EAAErC,MACXA,EAAMqD,QAAUrD,EAAMwB,OAAS9E,GAAGc,OAAOiE,UAAUC,KACpDb,EAAK6B,SAASY,KAAK,WAEf,GAAIzC,EAAK0C,iBAAiBvD,GACtBwD,EAAczC,KAAKF,EAAMb,OAExB,CAGD,IADA,IAAIyD,GAAoB,EACfnC,EAAI,EAAGoC,EAAM7C,EAAK5D,OAAOsE,OAAQD,EAAIoC,EAAKpC,IAAK,CACpD,IAAIqC,EAAM9C,EAAK5D,OAAOqE,GACtB,GAAIqC,EAAInC,OAASxB,EAAMwB,MAAQmC,EAAItC,QAAQuC,MAAQ5D,EAAMqB,QAAQuC,IAAK,CAClEH,GAAoB,EACpB,OAKR,GAAIA,EAAmB,CACd5C,EAAKgD,qBACNhD,EAAKgD,mBAAqB,IAG9BhD,EAAKgD,mBAAmB7B,KAAKhC,QAE7Ba,EAAKiD,SAAS,IAAIpH,GAAGsD,MAAM+B,OAAO,CAC9B6B,IAAK5D,EAAMqB,QAAQuC,IACnBpC,KAAMxB,EAAMwB,KACZuC,WAAY,GACZC,MAAOhE,EAAMgE,OAAShE,EAAMiE,KAAKC,kBACjCC,WAAW,EACXC,UAAU,KACVd,KAAK,WACLE,EAAczC,KAAKF,EAAMb,UAOhD8C,GAAGpG,GAAGc,OAAOgF,MAAM6B,WAAY,SAAUhC,GACtC,MAAMiC,EAASjC,EAAEiC,OACjB,GAAIzD,EAAK5D,OAAOsH,KAAM7E,GAAeA,GAAK2C,EAAErC,OAAU,CAC9CsE,GACA5H,GAAG8H,MAAM3D,EAAKF,gBAAgB2D,EAAQ,CAAEV,IAAKvB,EAAErC,MAAM4D,OAEzD/C,EAAKX,cAAcmC,EAAErC,OAAOG,QAAQ,SAAUC,GAC1CA,EAAKC,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQ8C,cAInDuC,GAAGpG,GAAGc,OAAOgF,MAAMiC,YAAa,SAAUpC,GACvC,MAAMrC,EAAQqC,EAAErC,MAChBa,EAAKX,cAAcF,GAAOG,QAAQ,SAAUC,GACxCA,EAAKC,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQiH,SACxCtE,EAAKI,cAAc,QAAQC,QAAQC,QAAUqC,KA5GjC,SAAU/C,GAC9B,MAAMc,EAAS,GACf,IAAKd,EAAMqD,OAAQ,CACf,IAAIO,EAAM5D,EAAMqB,QAAQuC,IACpB/C,EAAK8D,MACL9D,EAAK8D,KAAKC,iBAAiB,MAAMzE,QAAQ,SAAU0E,GAC/C,MAAMlB,EAAM9C,EAAKiE,SAASD,EAAGpE,QAAQsE,SACrC,GAAIpB,GAAOA,EAAInC,OAASxB,EAAMwB,MAAQmC,EAAItC,QAAQuC,MAAQA,EACtD,IAAK,IAAItC,EAAI,EAAGA,EAAItB,EAAMgF,MAAMzD,OAAQD,IACpC,GAAIuD,EAAGpE,QAAQwE,YAAcjF,EAAMgF,MAAM1D,GAAI,CACzCR,EAAOkB,KAAK6C,GACZ,SAOxB,OAAO/D,GA4FHoE,CAAgBlF,GAAOG,QAAQ,SAAUC,GACrCA,EAAKC,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQiH,SACxCtE,EAAKI,cAAc,MAAMC,QAAQC,QAAUqC,KAxFxB,SAAUoC,GACrC,IAAIC,EAASvE,EAAKD,IAAIyE,mBAAmB3I,GAAGC,QAAQ2I,kBAAkB,GACtE,GAAIF,EAGA,IAFA,IAAInI,EAASmI,EAAOnI,OAEXqE,EAAI,EAAGA,EAAIrE,EAAOsE,OAAQD,IAAK,CACpC,IAAItB,EAAQ/C,EAAOqE,GAEftB,IAAUmF,GACVtE,EAAKX,cAAcF,GAAOG,QAAQ,SAAUC,GACxCA,EAAKC,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQiH,SACrCtE,EAAKI,cAAc,QAAQC,QAAQC,QAAUG,EAAKF,gBAAgB,wBAkF9E4E,CAAuBvF,GAGvBwF,EAAmBzE,KAAKF,KAE3BiC,GAAGpG,GAAGc,OAAOgF,MAAMiD,qBAAsB,SAAUpD,GAChD,GAAIA,GAAKA,EAAErC,MAAO,CACda,EAAKiD,SAASzB,EAAErC,OAChBa,EAAK6E,IAAIrF,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQkI,cAGnD7C,GAAGpG,GAAGc,OAAOgF,MAAMoD,iBAAkB,SAAUvD,GAC5CxB,EAAKgF,WAGb,OAAO/E,GAGX,MAAMgF,EAAwB,SAAUzD,GACpCA,EAAE0D,OAAOC,OACT3D,EAAE4D,kBACF,MAAMpB,EAAKxC,EAAE0D,OAAOG,cACpB,GAAmB,OAAfrB,EAAGsB,UAAqBtB,EAAGxE,UAAU+F,SAASvF,KAAKtD,MAAQ,SAAU,CACrEsH,EAAGxE,UAAUgG,OAAO3J,GAAGc,OAAOC,QAAQkI,WAC3Bd,EAAGrE,cAAc,MACzBH,UAAUgG,OAAO3J,GAAGc,OAAOC,QAAQkI,aAoUxCH,EAAqB,WACvB,MAAM3E,EAAO7D,KAEb,GAAI,gBAAiBsJ,SAAU,CAC3B,IAAIC,EAAMD,SAASE,YAAY,cAC/BD,EAAIE,UAAU,SAAS,GAAO,GAC1B5F,EAAK6F,WACL7F,EAAK6F,UAAUC,cAAcJ,QAI7B1F,EAAK6F,WACL7F,EAAK6F,UAAUE,UAAU,UAK/BpD,EAAgB,SAAUxD,GAC5B,MAAMa,EAAO7D,KAEb6D,EAAKX,cAAcF,GAAOG,QAAQ,SAAUC,GACxCA,EAAKC,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQ8C,SACxCH,EAAKC,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQiH,SACrCtE,EAAKI,cAAc,QAAQC,QAAQC,QAAUG,EAAKF,gBAAgB,uBAEtE6E,EAAmBzE,KAAKF,IAiBtBgG,EAAiB,SAAUzG,EAAMJ,GACnC,MAAMa,EAAO7D,KAEboD,EAAKwE,iBAAiB,eAAiB/D,EAAKtD,MAAQ,iBAAiB4C,QAAQ,SAAU2G,GACnFA,EAAIC,iBAAiB,QAASjB,KAGlC1F,EAAKwE,iBAAiB,QAAQzE,QAAQ,SAAU6G,GAC5CA,EAAKD,iBAAiB,QAAS,SAAU1E,IAlX7B,SAAUA,EAAGtC,GAC7B,MAAM8E,EAAKxC,EAAE0D,OAAOkB,WACpB,IAAKpC,EAAGxE,UAAU+F,SAAS1J,GAAGc,OAAOC,QAAQ8C,WAAasE,EAAGxE,UAAU+F,SAAS1J,GAAGc,OAAOC,QAAQiH,SAAU,CACxGrC,EAAE6E,eAEF,IAEIlH,EAFAiF,EAAYJ,EAAGpE,QAAQwE,UAC3BA,OAA2BkC,IAAdlC,EAA2BA,EAAUmC,WAAa,GAE/D,IAAK,IAAI9F,EAAI,EAAGoC,EAAM3D,EAAIsH,OAAO9F,OAAQD,EAAIoC,EAAKpC,IAAK,CACnD,MAAMgG,EAAOvH,EAAIsH,OAAO/F,GACxB,GAAIgG,EAAKlB,SAASvB,GAAK,CACnB7E,EAAQD,EAAI+E,SAASwC,EAAK7G,QAAQsE,SAClC,OAGH/E,IACDA,EAAQD,EAAI+E,SAASD,EAAGpE,QAAQsE,UAEpC,GAAI/E,GAASiF,EAAW,CACpB,IAAIsC,EAAa,EAEb,QAAQC,KAAKC,UAAUC,WACvBH,EAAa,GACR7K,GAAGmF,KAAK8F,kBACbJ,EAAa,KAEZvH,EAAMgE,QACPhE,EAAMgE,MAAQhE,EAAM4H,UAAU5D,OAGlCa,EAAGxE,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQ8C,SACnCsE,EAAGrE,cAAc,QAAQC,QAAQC,QAAU,IAElBmH,EAWlBhD,EAVI,IAAI1C,QAAQ,SAAUlB,EAASC,GAClC4G,WAAW,WACPD,EAAQE,aAAeF,EAAQE,aAC/BF,EAAQG,YAAcH,EAAQG,YAE9B/G,KACDsG,MAIAjE,KAAK,WACZvD,EAAIkI,cAAcjI,EAAOiF,KAE7B5C,EAAE4D,mBAda,IAAU4B,EAkVzBK,CAAY7F,EAAGxB,OAIvBA,EAAKwG,OAASxG,EAAK6E,IAAId,iBAAiB/D,EAAKxD,WAAWC,YAExD8C,EAAKK,QAAQsE,QAAU/E,EAAM2B,GAG7BvB,EAAKwE,iBAAiB,IAAM/D,EAAKtD,MAAQ,aAAa4C,QAAQ,SAAUgI,GACpE,MAAMnB,EAAOmB,EAAEjC,cAAc1F,cAAc,QACrC4H,EAAOD,EAAEjC,cAAczF,QAAQwE,UACrC,GAAImD,EAAM,CACNpB,EAAK3G,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQC,YACrC,IAAI2K,EAAOrI,EAAMiE,KAAKqE,QAAQF,GACzBC,EAAKE,eAAe,aAAgBF,EAAKE,eAAe,WAAcF,EAAKE,eAAe,YAI3FJ,EAAEpB,iBAAiBrK,GAAGc,OAAOgF,MAAMgG,MAAO,SAAUnG,GAChDA,EAAE4D,kBACUjJ,KACJqD,UAAUgG,OAAO3J,GAAGc,OAAOC,QAAQiH,SACvC7D,EAAK4H,cAAczI,EAAOoI,GAE1BvH,EAAK6H,kBATbP,EAAEjC,cAAcyC,YAAYR,GAahC,GAAInI,EAAM4I,kBAAoB5I,EAAM4I,iBAAiBC,QAAQT,GAAQ,EAAG,CACpEpB,EAAK3G,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQE,cACrCqJ,EAAK8B,aAAa,QAASjI,EAAKF,gBAAgB,uBAGpD,GAAIE,EAAKD,IACL,IAAK,IAAImI,EAAI,EAAGrF,EAAM7C,EAAKD,IAAIoI,WAAWzH,OAAQwH,EAAIrF,EAAKqF,IAAK,CAC5D,IAAIE,EAAKpI,EAAKD,IAAIoI,WAAWD,GAC7B,GAAIE,EAAGzH,OAAS9E,GAAGc,OAAOiE,UAAUC,KAAOuH,EAAGrF,MAAQ5D,EAAM4D,KAA2B,IAApBqF,EAAGjE,MAAMzD,QAAgB0H,EAAGjE,MAAM,KAAOoD,EAAM,CAC9GpB,EAAKd,cAAc7F,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQiH,SACnDsC,EAAKvG,QAAQC,QAAUG,EAAKF,gBAAgB,2BAKvD,CACDqG,EAAKvG,QAAQC,QAAU,GACvByH,EAAEjC,cAAcyC,YAAYR,OArET,WAC3B,MAAMtH,EAAO7D,KAET6D,EAAKgD,oBAAsBhD,EAAKgD,mBAAmBtC,OAAS,GAC5DV,EAAKgD,mBAAmB1D,QAAQ,SAAUH,EAAOkJ,EAAOC,GACpD,GAAItI,EAAK0C,iBAAiBvD,GAAQ,CAC9BwD,EAAczC,KAAKF,EAAMb,GAEzBmJ,EAAMC,OAAOF,EAAO,QAiETnI,KAAKF,GAE5BA,EAAKwI,gBAAgBxI,EAAKtD,MAAQ,UAAW,KAAM,SAAU+L,GACzDzI,EAAK0I,WAAWC,UAAYF,KAIpCxL,EAAS2L,aAAe,SAAUzJ,EAAO0J,EAAUC,GAC/C,MAAM9I,EAAO7D,KAEbgD,EAAM4J,yBACDtG,KAAK,SAAUxC,GAEZD,EAAKgJ,aAAa7H,KAAKhC,GAEvBa,EAAKwI,gBAAgBxI,EAAKtD,MAAQ,UAvIzB,SAAUyC,GAC3B,IAAIc,EAASd,EAAM4H,WACG,SAASkC,EAAgB1J,GAG3C,IAFA,IACI2J,GAAkB,EACbzI,EAAI,EAAGA,EAAIlB,EAAK4J,SAASzI,OAAQD,IAClCwI,EAAgB1J,EAAK4J,SAAS1I,MAC9ByI,GAAkB,GAGtB3J,EAAKmI,eAAe,eACpBnI,EAAK6J,WAAcjK,EAAMgF,QAAUhF,EAAMgF,MAAMzD,QAAWwI,GAAmB3J,EAAK6J,WAEtF,OAAO7J,EAAK6J,UAEhBH,CAAgBhJ,GAChB,OAAOA,EAuH8CoJ,CAAalN,MAAO,SAAUsM,GACvE,IAAItL,EAAWsI,SAAS6D,cAAc,YACtCnM,EAASwL,UAAYF,EAErB,IAAIc,EAAWpM,EAASqM,QAAUrM,EAASqM,QAAQC,WAAatM,EAASsM,WACrEC,EAAW1J,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,WAAWiD,cAAc,MAAQK,EAAKtD,MAAQ,gCAAkCP,KAAK2E,GAAK,MAE/I4I,EACA1J,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,WAAWiN,aAAaJ,EAAUG,GAE5E1J,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,WAAWkN,YAAYL,GAGrEvD,EAAe9F,KAAKF,EAAMuJ,EAAUpN,MAE2C,IAA3E6D,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,WAAWmN,mBACrDf,IAGAjN,GAAGmF,KAAK8I,WAAWjB,IAEnBA,EAAS7I,EAAKgJ,aAAahJ,EAAKgJ,aAAajJ,IAAI,SAAUgK,GAAK,OAAOA,EAAEjJ,KAAMkH,QAAQ7L,KAAK2E,OAGlGkJ,KAAK7N,QAET6N,KAAK7K,IACN8K,MAAM,SAAUC,GACb,IAAI7B,EAAQrI,EAAK5D,OAAO2D,IAAI,SAAUgK,GAAK,OAAOA,EAAEjJ,KAAMkH,QAAQ7L,KAAK2E,IACvEd,EAAK5D,OAAOmM,OAAOF,EAAO,GAE1B,IAAI8B,EAAenK,EAAKF,gBAAgB,2BAA4B,CAAEsK,YAAajO,KAAKgH,QACpFkH,EAAUrK,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,WAAWiD,cAAc,MAAQK,EAAKtD,MAAQ,gCAAkCP,KAAK2E,GAAK,MAClJuJ,EAAQ7K,UAAU6C,IAAI,SACtBgI,EAAQpC,aAAa,QAASkC,GAE9BnK,EAAKD,IAAIuK,MAAMH,EAAc,CAAExJ,KAAM9E,GAAGc,OAAO4N,QAAQC,SAEzDR,KAAK7K,KAGflC,EAASmE,OAAS,SAAUyH,GACxB,MAAM7I,EAAO7D,KAEb6D,EAAKgJ,aAAe,GAEpB,OAAOhJ,EAAKyK,qBAAqB,IAAInJ,QAAQ,SAAUlB,EAASC,GACjC,IAAvBL,EAAK5D,OAAOsE,OACZV,EAAK0K,WAAW,CAAEC,WAAY,GAAIC,cAAc,GAAS,WAEjD/O,GAAGmF,KAAK8I,WAAWjB,IACnBA,IAGJzI,MAGJJ,EAAK0K,WAAW,CAAEtO,OAAQ4D,EAAK5D,OAAQwO,cAAc,GAAQ,YAzbxC,WAC7B,MAAM5K,EAAO7D,KAEb6D,EAAK6F,UAAY7F,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,UAC3DsD,EAAK8D,KAAO9D,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,cAEtDsD,EAAK6F,UAAUK,iBAAiB,UAAW,SAAU1E,GAGhC,KAFFxB,EAAK6F,UAAU7G,OAQ9BiI,WAAW,WAGU,KAFFjH,EAAK6F,UAAU7G,QAG1BgB,EAAK8D,KAAK6E,UAAY,KAE3B,KAGP,IAAIkC,EAAmB,GAEvBhP,GAAGiP,QAAUjP,GAAGiP,SAAW,GAC3BjP,GAAGiP,QAAQC,aAAe,KAEdlP,GAAGmP,QACEnP,GAAGoP,KAAOpP,GAAGoP,GAAGC,aACjB,CAACrP,GAAGI,YAAc,yBAClB,WACIJ,GAAGoP,GAAGC,aAAahL,KAAKF,EAAK6F,UAAW,CACpCsF,KAAM,IACNjG,OAAQlF,EAAK8D,KACbsH,UAAW,EACXC,OAAQ,SAAUC,EAAMzC,GAEpBgC,EAAmB,GACnB7K,EAAKwG,OAAOlH,QAAQ,SAAUmH,GAC1BA,EAAK1C,iBAAiB,MAAQlI,GAAGc,OAAOC,QAAQiH,SAASvE,QAAQ,SAAUiM,GACvEV,EAAiB1J,KAAKoK,EAAK3L,QAAQwE,eAMvD,IADAkH,EAAOA,EAAKE,QACH9K,OAtSL,EAuSAV,EAAK8D,KAAK6E,UAAY,QAErB,GAAI2C,EAAK5K,QAzSV,EAySuC,CACnC7E,GAAGiP,QAAQC,cACXU,aAAa5P,GAAGiP,QAAQC,cAC5BlP,GAAGiP,QAAQC,aAAe9D,WAAW,WAEjC,IADA,IAAIyE,EAAU,GACLrD,EAAQ,EAAGA,EAAQrI,EAAKgJ,aAAatI,OAAQ2H,IAAS,CAC3D,IAAIsD,EAAU3L,EAAKgJ,aAAaX,GAAOuD,gBAAgBN,GACnDK,EAAQjL,QACRgL,EAAQvK,KAAK,CACT0K,QAAS,CACLxD,MAAOA,EACPlF,MAAOnD,EAAKgJ,aAAaX,GAAOlF,OAASnD,EAAKgJ,aAAaX,GAAOvH,IAEtEgL,OAAQH,IAIpB9C,EAAS,CAAEkD,cAAeL,EAASM,eAAgBhM,EAAKgJ,aAAatI,UACtE7E,GAAGiP,QAAQmB,YAGtBpD,SAAU,SAAUrH,GAChBxB,EAAK6F,UAAU7G,MAAQwC,EAAE0D,OAAOoG,MAAQ9J,EAAE0D,OAAOgH,UACjDrQ,GAAGiP,QAAQqB,YAAcnM,EAAK6F,UAAU7G,MACxCgB,EAAKoM,WAAWC,SAAS7K,EAAE0D,OAAOoH,MAAMC,UAAU,IAClD1Q,GAAGoP,GAAGC,aAAahL,KAAKF,EAAK6F,UAAW,UAE5C2G,UAAW,SAAUC,GACjB,IAAIC,EAAYvQ,KAAK+I,OAErB,GAAIuH,EAAKf,SAAWe,EAAKf,QAAQK,cAAcrL,OAAS,EAEpD,IADA,IAAIyH,EAAanI,EAAKD,IAAIsJ,eAAelB,WAChCwE,EAAI,EAAGA,EAAIF,EAAKf,QAAQK,cAAcrL,OAAQiM,IAAK,CAExD,IADA,IAAIb,EAASW,EAAKf,QAAQK,cAAcY,GAAGb,OAClC5D,EAAI,EAAGA,EAAI4D,EAAOpL,OAAQwH,IAAK,QAC7B4D,EAAO5D,GAAG0E,aACjB,IAAK,IAAInM,EAAI,EAAGA,EAAI0H,EAAWzH,OAAQD,IAEnC,GAAIoK,EAAiB7C,QAAQ8D,EAAO5D,GAAG2E,OAAS,EAAG,CAC/Cf,EAAO5D,GAAG0E,cAAe,EACzB,MAIR,IAAKd,EAAO5D,GAAG2E,KAAM,CACjBf,EAAOvD,OAAOL,EAAG,GACjBA,KAGHuE,EAAKf,QAAQK,cAAcY,GAAGb,OAAOpL,OAKtCV,EAAK6E,IAAId,iBAAiB,6BAA6B4I,KACvDF,EAAKf,QAAQK,cAAcY,GAAGd,QAAQiB,YAAc9M,EAAK6E,IAAId,iBAAiB,6BAA6B4I,GAAGnN,UAAU+F,SAAS1J,GAAGc,OAAOC,QAAQkI,YALnJ2H,EAAKf,QAAQK,cAAcxD,OAAOoE,EAAG,GASjD,IAAII,EAAM,GACV/M,EAAKwI,gBAAgBxI,EAAKtD,MAAQ,WAAY+P,EAAKf,SAASjJ,KAAK,SAAUuK,GACvEN,EAAU/D,UAAYoE,EAAMC,IAEhC,OAAOD,OAMvB,IAAK/M,EAAK3D,WAAY,CAElB2D,EAAK6E,IAAIqB,iBAAiB,QAASrK,GAAGoR,YAAYC,mBAAmB,YAAa,SAAU1L,GACxF,MAAM2L,EAAenN,EAAK6E,IAAIrF,UAAU+F,SAAS1J,GAAGc,OAAOC,QAAQkI,WACnE9E,EAAK6E,IAAIrF,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQkI,WAE5C,MAAMsI,EAAapN,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,WACvD2Q,EAAWrN,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,SACrD4Q,EAAWtN,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,SAErD6Q,KAAwBH,EAAW5N,UAAU+F,SAAS1J,GAAGc,OAAOC,QAAQ4Q,UAAWL,GACzFC,EAAW5N,UAAUgG,OAAO3J,GAAGc,OAAOC,QAAQ4Q,QAASD,GACvDF,EAAS7N,UAAUgG,OAAO3J,GAAGc,OAAOC,QAAQ4Q,OAAQD,GACpD/L,EAAE0D,OAAO1F,UAAUgG,OAAOxF,EAAKtD,MAAQ,YAAa6Q,GACpD/L,EAAE0D,OAAO1F,UAAUgG,OAAOxF,EAAKtD,MAAQ,eAAgB6Q,GACvD,GAAIA,EAAoB,CACpBvN,EAAK6F,UAAU4H,QACfjM,EAAE0D,OAAO+C,aAAa,QAASjI,EAAKF,gBAAgB,4BAI9B,IADAE,EAAK6E,IAAId,iBAAiB,4CAA4CrD,QAExF4M,EAAS9N,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQ4Q,YAG5C,CACDhM,EAAE0D,OAAO+C,aAAa,QAASjI,EAAKF,gBAAgB,uBAG9BE,EAAK6E,IAAId,iBAAiB,0CAA0CrD,OACtE,GAChB4M,EAAS9N,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQ4Q,YAQxDxN,EAAK6E,IAAIqB,iBAAiB,QAASrK,GAAGoR,YAAYC,mBAAmB,IAAMlN,EAAKtD,MAAQ,kBAAoBsD,EAAKtD,MAAQ,mBAAoB,SAAUgJ,GACnJA,EAAIN,kBACJ,MAAMF,EAASQ,EAAIR,OACnB,GAAKA,EAAO1F,UAAU+F,SAAS1J,GAAGc,OAAOC,QAAQiH,SAU1C,CACHqB,EAAO1F,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQiH,SAC1C7D,EAAK6H,oBAZkD,CACvD,MAAM7D,EAAKkB,EAAOG,cAClB,IAAIqI,EAAS1J,EACb,GACI0J,EAASA,EAAOrI,oBAEbqI,GAA6B,OAAnBA,EAAOpI,SACxBtF,EAAK4H,cAAc5H,EAAK5D,OAAOsE,OAAS,EAAIV,EAAK5D,OAAOsR,EAAO9N,QAAQ+N,cAAgB3N,EAAK5D,OAAO,GAAI4H,EAAGpE,QAAQwE,WAClHc,EAAO1F,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQiH,aAS/C,MAAM+J,EAA4B,IAAM5N,EAAKtD,MAAQ,aACrDsD,EAAK6E,IAAIqB,iBAAiB,QAASrK,GAAGoR,YAAYC,mBAAmBU,EAA2B,SAAUlI,GACtGA,EAAIN,kBAEJ,IADA,IAAIpB,EAAK0B,EAAIR,OACNlB,IAAOA,EAAG6J,QAAQD,IACrB5J,EAAKA,EAAGqB,cAEZ,IAAIrB,EAAGxE,UAAU+F,SAASvF,EAAKtD,MAAQ,eAGvC,GAAIsH,EAAGxE,UAAU+F,SAASvF,EAAKtD,MAAQ,iBACnCsH,EAAGxE,UAAUgG,OAAO3J,GAAGc,OAAOC,QAAQkI,eAD1C,CAIA,IAAIV,EAAYJ,EAAGpE,QAAQwE,UAC3B,GAAKA,GAK2B,KAFhCA,EAAYA,EAAUmC,YAERiF,OAAO9K,SAKjBsD,EAAGxE,UAAU+F,SAAS1J,GAAGc,OAAOC,QAAQiH,SAErC,CACH,IAAIiK,EAAW9J,EACf,GACI8J,EAAWA,EAASzI,oBAEjByI,IAAaA,EAASD,QAAQ,MAAQ7N,EAAKtD,MAAQ,kBAE1D,MAAMqR,EAAYD,EAAeA,EAASlO,QAAQ+N,aAArB,EACvB5K,EAAM/C,EAAK5D,OAAO2R,GAAUvN,QAAQuC,IACpCI,EAAQnD,EAAK5D,OAAO2R,GAAU5K,MAE9BhE,EAAQ,IAAItD,GAAGsD,MAAM+B,OAAO,CAC9BJ,GAAId,EAAKe,SACTgC,IAAKA,EACLI,MAAOA,EACPG,UAAWtD,EAAK5D,OAAO2R,GAAUzK,WAAatD,EAAK5D,OAAO2R,GAAUvN,QAAQ8C,UAC5EC,UAAU,EACVL,WAAY,CAACkB,KAEjB,GAAIjF,EAAM6O,aAAahO,EAAKD,IAAIkO,KAAM,CAClCjO,EAAKD,IAAIkD,SAAS9D,EAAO,SAAUA,GAC/B6E,EAAGpE,QAAQsE,QAAU/E,EAAM2B,GAC3B3B,EAAMiE,KAAK8K,QAAQjM,GAAGpG,GAAGc,OAAOgF,MAAMwM,cAAe,SAAUxM,GAC3D,IAAIxC,EAAQhD,KAAKuR,OACQ,MAArB/L,EAAMuI,MAAMkE,MAAqC,MAArBzM,EAAMuI,MAAMkE,MACxCjP,EAAMY,IAAIuK,MAAM3I,EAAMuI,MAAMoB,KAAM,CAAE3K,KAAM9E,GAAGc,OAAO4N,QAAQC,QAChErL,EAAMY,IAAIsO,YAAYlP,OAI9B6E,EAAGxE,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQiH,SACnCG,EAAGrE,cAAc,MAAMC,QAAQC,QAAUG,EAAKF,gBAAgB,0BAG9Db,EAA2Be,EAAMb,QAK7Ca,EAAK3D,YAAa,KAsMe6D,KAAKF,GAE9BA,EAAK5D,OAAOkD,QAAQ,SAAUH,GAC1Ba,EAAK4I,aAAazJ,EAAO0J,EAAUzI,WAOvDnD,EAASyF,iBAAmB,SAAUvD,GAClC,MAAMa,EAAO7D,KACb,IAAI8D,EAAS,KACb,IAAKd,EAAMqD,OAAQ,CACf,IAAIO,EAAM5D,EAAMqB,QAAQuC,IACpB/C,EAAKwG,QACLxG,EAAKwG,OAAOlH,QAAQ,SAAU0E,GAC1B,MAAMlB,EAAM9C,EAAKiE,SAASD,EAAGpE,QAAQsE,SACjCpB,GAAOA,EAAInC,OAASxB,EAAMwB,MAAQmC,EAAItC,QAAQuC,MAAQA,IACtD9C,EAAS+D,KAKzB,OAAO/D,GAGXhD,EAASoC,cAAgB,SAAUF,GAC/B,MACMc,EAAS,GACTqO,EAFOnS,KAESuG,iBAAiBvD,GACvC,GAAImP,EACA,IAAK,IAAI7N,EAAI,EAAGA,EAAItB,EAAMgF,MAAMzD,OAAQD,IAAK,CACzC,MAAM8N,EAAUD,EAAS3O,cAAc,uBAAyBR,EAAMgF,MAAM1D,GAAK,MACjF,GAAK8N,EAAL,CAGAtO,EAAOA,EAAOS,QAAU6N,EACxBA,EAAQxK,iBAAiB,MAAMzE,QAAQ,SAAU0E,GAC7C/D,EAAOA,EAAOS,QAAUsD,KAIpC,OAAO/D,GAGXhD,EAAS2K,cAAgB,SAAUzI,EAAOoI,GACtC,MAAMvH,EAAO7D,KACb,IAAI8D,EAAS,KAETuH,EAAOxH,EAAK6E,IAAIlF,cAAc,IAAMK,EAAKtD,MAAQ,SAErD,MAAM8R,EAAa,SAAUpK,EAAWqK,GACpC,IAAIxO,GAAS,EAMb,GAAIwO,EAAS,CACTxO,GAAS,EACTuH,EAAK5H,QAAQwE,UAAYA,EACzBoD,EAAKhI,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQ4Q,QACxCxN,EAAKwI,gBAAgBxI,EAAKtD,MAAQ,QAAS+R,GACtChM,KAAK,SAAUuK,GACZxF,EAAKmB,UAAYqE,EACjBxF,EAAK7H,cAAc,IAAMK,EAAKtD,MAAQ,eAAewJ,iBAAiBrK,GAAGc,OAAOgF,MAAMgG,MAAO,WACzF3H,EAAK6H,oBAGZoC,MAAM,SAAUyE,GACb7S,GAAGqO,MAAMwE,KAIrB,OAAOzO,GAGXD,EAAK6E,IAAId,iBAAiB,IAAM/D,EAAKtD,MAAQ,eAAiBsD,EAAKtD,MAAQ,oBAAoB4C,QAAQ,SAAU2G,GAC7GA,EAAIzG,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQiH,WAG3C,MAAM8K,EAAqB,GAC3B,IAAK,IAAIlO,EAAI,EAAGmO,EAAK5O,EAAKwG,OAAO9F,OAAQD,EAAImO,EAAInO,IAAK,CAClD,MAAMgG,EAAOzG,EAAKwG,OAAO/F,GACzB,GAAIgG,EAAK7G,QAAQsE,UAAY/E,EAAM2B,GAAI,CACnC,MAAM+N,EAAKpI,EAAK1C,iBAAiB,IAAM/D,EAAKtD,MAAQ,aACpD,IAAK,IAAIwL,EAAI,EAAG4G,EAAKD,EAAGnO,OAAQwH,EAAI4G,EAAI5G,IAAK,CAEzC,IAAI6G,EADMF,EAAG3G,GACH7C,cAAczF,QAAQwE,UAChC,GAAI2K,IAAMxH,EAAM,CACZ,MAAMC,EAAOrI,EAAMiE,KAAKqE,QAAQF,GAC5BC,EAAKwH,UACLxH,EAAKwH,SAAS1P,QAAQ,SAAU2P,GAC5BA,EAAGC,kBAAoBP,EAAmBM,EAAGE,QACzCR,EAAmBM,EAAGE,SACtBnP,EAAKF,gBAAgBjE,GAAGmF,KAAKoO,kBAAkBH,EAAGE,UAClDnP,EAAKF,gBAAgB,kBAGjBE,EAAK6E,IAAIlF,cAAc,wBAA0BoP,EAAI,eAAiB/O,EAAKtD,MAAQ,aAC3F8C,UAAUgG,OAAO3J,GAAGc,OAAOC,QAAQiH,QAAS2K,EAAWO,EAAGvH,IAClEvH,EAASuH,EACT,OAGR,OAIR,OAAOvH,GAGXhD,EAAS+H,OAAS,WACd,MAAMhF,EAAO7D,KACb6D,EAAKgJ,aAAa1J,QAAQ,SAAUH,GAChCA,EAAM4J,yBAAyBtG,KAAK,WAChCtD,EAAM4I,iBAAmB5I,EAAMiE,KAAKiM,oBAAoBrP,EAAKD,IAAIkO,KAEjE,MAAMK,EAAWtO,EAAK0C,iBAAiBvD,GACnCmP,GACAA,EACKvK,iBAAiB,uBACjBzE,QAAQ,SAAU0E,GACf,MAAMuD,EAAOvD,EAAGpE,QAAQwE,UAClB+B,EAAOnC,EAAGrE,cAAc,QAAU9D,GAAGc,OAAOC,QAAQC,YAC1D,GAAIsC,EAAM4I,iBAAiBC,QAAQT,GAAQ,EAAG,CAC1CpB,EAAK3G,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQE,cACrCqJ,EAAK8B,aAAa,QAASjI,EAAKF,gBAAgB,2BAE/C,CACDqG,EAAK3G,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQE,cACxCqJ,EAAKmJ,gBAAgB,iBAQjDrS,EAAS4K,cAAgB,WACV1L,KACN0I,IAAId,iBAAiB,IADf5H,KAC0BO,MAAQ,eADlCP,KACwDO,MAAQ,oBAAoB4C,QAAQ,SAAU2G,GAC7GA,EAAIzG,UAAUC,OAAO5D,GAAGc,OAAOC,QAAQiH,WAFhC1H,KAIN0I,IAAIlF,cAAc,IAJZxD,KAIuBO,MAAQ,SAAS8C,UAAU6C,IAAIxG,GAAGc,OAAOC,QAAQ4Q,SAGvFvQ,EAASgG,SAAW,SAAU9D,GAC1B,MAAMa,EAAO7D,KACb,OAAO,IAAImF,QAAQ,SAAUlB,EAASC,GAClC,IAAIkP,EAAmB,GAEnBvP,EAAKQ,QAAQpE,QAAU4D,EAAKQ,QAAQpE,OAAOsE,SAC3C6O,EAAmBvP,EAAKQ,QAAQpE,OAAOoT,OAAO,SAAUzF,GACpD,IAAI0F,EAAS5T,GAAGmF,KAAK0O,wBAAwB3F,EAAEhH,KAC/C,OAAO0M,GAAUA,EAAOE,QAAQ9T,GAAGmF,KAAK4O,MAAMC,WAAa1Q,EAAM4D,IAAI4M,QAAQ9T,GAAGmF,KAAK4O,MAAMC,aAIpE,GAA3BN,EAAiB7O,SACjB6O,EAAmBvP,EAAK5D,OAAOoT,OAAO,SAAUzF,GAC5C,OAAOA,EAAEhH,IAAI4M,QAAQ9T,GAAGmF,KAAK4O,MAAMC,WAAa1Q,EAAM4D,IAAI4M,QAAQ9T,GAAGmF,KAAK4O,MAAMC,aAGxF,GAA+B,GAA3BN,EAAiB7O,OAAa,CAC9BV,EAAK5D,OAAO+E,KAAKhC,GACjBA,EAAM4J,yBAAyBtG,KAAK,WAChCtD,EAAM4I,iBAAmB5I,EAAMiE,KAAKiM,oBAAoBrP,EAAKD,IAAIkO,KACjE9O,EAAMgE,MAAQhE,EAAMgE,OAAShE,EAAMiE,KAAKC,kBACxCrD,EAAK4I,aAAazJ,EAAO,WACrBiB,aAGHA,OAIjBnD,EAASgH,SAAW,SAAUnD,GAC1B,MAAMd,EAAO7D,KACb,IAAK,IAAIsE,EAAI,EAAGoC,EAAM7C,EAAK5D,OAAOsE,OAAQD,EAAIoC,EAAKpC,IAAK,CACpD,MAAMtB,EAAQa,EAAK5D,OAAOqE,GAC1B,GAAItB,EAAM2B,KAAOA,EAAI,CAGjB,IAAIgP,EAAc9P,EAAKQ,QAAQpE,OAAOoT,OAAOzF,GAAKA,EAAEjJ,KAAOA,GAEvDgP,EAAYpP,OAAS,EACrBvB,EAAMmE,UAAYnE,EAAMqB,QAAQ8C,UAAYwM,EAAY,GAAGxM,UAE3DnE,EAAMmE,UAAYnE,EAAMqB,QAAQ8C,WAAY,EAGhD,OAAOnE,GAGf,OAAO,MAGXlC,EAASmK,cAAgB,SAAUjI,EAAOiF,GACtC,MAAMpE,EAAO7D,KACP4T,EAAelU,GAAGmF,KAAKgP,OAAO,GAAI7Q,EAAMqB,SAC9CuP,EAAajP,GAAKd,EAAKe,SACvBgP,EAAa7M,WAAa,CAACkB,GAC3B2L,EAAa5M,MAAQhE,EAAMgE,MAC3B,MAAM8M,EAAW,IAAIpU,GAAGsD,MAAM+B,OAAO6O,GACjCE,EAASjC,aAAahO,EAAKD,IAAIkO,KAC/BjO,EAAKD,IAAIkD,SAAS8M,GAGlB9Q,EAA2Be,EAAMiQ,IAIzChT,EAAS4E,OAAS,WACd,OAAO1F,KAAKkF,eAGhBpE,EAASiT,gBAAkB,SAAU1P,GAEjCA,EAAUA,GAAW,GACrB,OAFarE,KAED4D,IAAIoQ,iBAAiB,CAC7B/T,OAHSD,KAGI4D,IAAIoI,WAAWiI,OAHnBjU,KAG+B4D,IAAI0B,UAAWjB,EAAQrB,OAC/DkR,kBAAkB,KAI1BpT,EAASqT,cAAgB,SAAU9P,GAC/B,MAAMR,EAAO7D,KACbqE,EAAUA,GAAW,GAErB3E,GAAG0U,YAAY,CACXtC,IAAKzN,EAAQyN,IACbpF,SAAU,WACN7I,EAAKD,IAAIuQ,cAAc9P,GAASiC,KAAK,WAC7BzC,EAAKwQ,aACLxQ,EAAKD,IAAIkD,SAASjD,EAAKwQ,aAE3B3U,GAAGmF,KAAKyP,mBAMxBxT,EAASgC,2BAA6B,SAAUuB,GAC/BrE,KACRqU,YAAchQ,EAAQrB,MAC3BtD,GAAGC,QAAQC,mBAAmBmB,UAAU+B,2BAA2BiB,KAFtD/D,KAEiEqE,IA39BtF","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.ProjectionSelector) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/ProjectionSelector');\r\n}\r\n\r\n(function () {\r\n\r\n    TC.control.LayerCatalog = function () {\r\n        var self = this;\r\n\r\n        self.layers = [];\r\n        self.searchInit = false;\r\n\r\n        TC.control.ProjectionSelector.apply(self, arguments);\r\n\r\n        self._selectors = {\r\n            LAYER_ROOT: 'div.' + self.CLASS + '-tree > ul.' + self.CLASS + '-branch > li.' + self.CLASS + '-node'\r\n        };\r\n\r\n        if (!TC.Consts.classes.SELECTABLE) {\r\n            TC.Consts.classes.SELECTABLE = 'tc-selectable';\r\n        }\r\n        if (!TC.Consts.classes.INCOMPATIBLE) {\r\n            TC.Consts.classes.INCOMPATIBLE = 'tc-incompatible';\r\n        }\r\n        if (!TC.Consts.classes.ACTIVE) {\r\n            TC.Consts.classes.ACTIVE = 'tc-active';\r\n        }\r\n    };\r\n\r\n    TC.inherit(TC.control.LayerCatalog, TC.control.ProjectionSelector);\r\n\r\n    var ctlProto = TC.control.LayerCatalog.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-lcat';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/LayerCatalog.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-branch'] = TC.apiLocation + \"TC/templates/LayerCatalogBranch.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-node'] = TC.apiLocation + \"TC/templates/LayerCatalogNode.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-info'] = TC.apiLocation + \"TC/templates/LayerCatalogInfo.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-results'] = TC.apiLocation + \"TC/templates/LayerCatalogResults.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/LayerCatalogDialog.html\";\r\n\r\n    const showProjectionChangeDialog = function (ctl, layer) {\r\n        ctl.showProjectionChangeDialog({\r\n            layer: layer,\r\n            closeCallback: function () {\r\n                ctl.getLayerNodes(layer).forEach(function (node) {\r\n                    node.classList.remove(TC.Consts.classes.LOADING);\r\n                    node.querySelector('span').dataset.tooltip = ctl.getLocaleString('clickToAddToMap');\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    var SEARCH_MIN_LENGTH = 3;\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        const result = TC.control.ProjectionSelector.prototype.register.call(self, map);\r\n\r\n        const load = function (resolve, reject) {\r\n            if (Array.isArray(self.options.layers)) {\r\n                for (var i = 0; i < self.options.layers.length; i++) {\r\n                    var layer = self.options.layers[i];\r\n                    if (!layer.type || layer.type === TC.Consts.layerType.WMS) {\r\n                        if (!layer.id) {\r\n                            layer.id = TC.getUID();\r\n                        }                        \r\n                        if (TC.Util.isPlainObject(layer)) {\r\n                            layer = new TC.layer.Raster(layer);\r\n                        }                        \r\n                        self.layers.push(layer);\r\n                    }\r\n                }\r\n                self.render(function () {\r\n                    resolve();\r\n                });\r\n            }\r\n            else {\r\n                resolve();\r\n            }\r\n        };\r\n\r\n        self._readyPromise = new Promise(function (resolve, reject) {\r\n            const waitLoad = function (e) {\r\n                if (e.layer === map.baseLayer) {\r\n                    load(resolve, reject);\r\n                    map.off(TC.Consts.event.LAYERUPDATE, waitLoad);\r\n                }\r\n            };\r\n\r\n            map.loaded(function () {\r\n                if (!map.baseLayer.state || map.baseLayer.state === TC.Layer.state.IDLE) {\r\n                    load(resolve, reject);\r\n                }\r\n                else {\r\n                    map.on(TC.Consts.event.LAYERUPDATE, waitLoad);\r\n                }\r\n            });\r\n        });\r\n\r\n        const findResultNodes = function (layer) {\r\n            const result = [];\r\n            if (!layer.isBase) {\r\n                var url = layer.options.url;\r\n                if (self.list) {\r\n                    self.list.querySelectorAll('li').forEach(function (li) {\r\n                        const lyr = self.getLayer(li.dataset.layerId);\r\n                        if (lyr && lyr.type === layer.type && lyr.options.url === url) {\r\n                            for (var i = 0; i < layer.names.length; i++) {\r\n                                if (li.dataset.layerName === layer.names[i]) {\r\n                                    result.push(li);\r\n                                    break;\r\n                                }\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n            return result;\r\n        };\r\n\r\n        /**\r\n         * Marca todas las capas del TOC como añadidas excepto la que se está borrando que se recibe como parámetro.\r\n         */\r\n        const _markWorkLayersAsAdded = function (layerRemoved) {\r\n            var wlCtrl = self.map.getControlsByClass(TC.control.WorkLayerManager)[0];\r\n            if (wlCtrl) {\r\n                var layers = wlCtrl.layers;\r\n\r\n                for (var i = 0; i < layers.length; i++) {\r\n                    var layer = layers[i];\r\n\r\n                    if (layer !== layerRemoved) {\r\n                        self.getLayerNodes(layer).forEach(function (node) {\r\n                            node.classList.add(TC.Consts.classes.CHECKED);\r\n                            node.querySelector('span').dataset.tooltip = self.getLocaleString('layerAlreadyAdded');\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        var clickToAddText = self.getLocaleString('clickToAddToMap');\r\n\r\n        map\r\n            .on(TC.Consts.event.BEFORELAYERADD + ' ' + TC.Consts.event.BEFOREUPDATEPARAMS, function (e) {\r\n                self.getLayerNodes(e.layer).forEach(function (node) {\r\n                    node.classList.add(TC.Consts.classes.LOADING);\r\n                    delete node.querySelector('span').dataset.tooltip;\r\n                });\r\n            })\r\n            .on(TC.Consts.event.LAYERADD + ' ' + TC.Consts.event.UPDATEPARAMS, function (e) {\r\n                const layer = e.layer;\r\n                if (!layer.isBase && layer.type === TC.Consts.layerType.WMS) {\r\n                    self.loaded().then(function () { // Esperamos a que cargue primero las capas de la configuración\r\n\r\n                        if (self.getLayerRootNode(layer)) {\r\n                            updateControl.call(self, layer);\r\n                        }\r\n                        else {\r\n                            // la capa no está renderizada, pero podría estar en proceso, comprobamos que no está en la lista de capas del control\r\n                            var layerAlreadyAdded = false;\r\n                            for (var i = 0, len = self.layers.length; i < len; i++) {\r\n                                var lyr = self.layers[i];\r\n                                if (lyr.type === layer.type && lyr.options.url === layer.options.url) {\r\n                                    layerAlreadyAdded = true;\r\n                                    break;\r\n                                }\r\n                            }\r\n\r\n                            // 12/03/2019 GLS la capa forma parte de los servicios configurados pero el nodo aún no se ha cargado, la guardamos\r\n                            if (layerAlreadyAdded) {\r\n                                if (!self.layersToSetChecked) {\r\n                                    self.layersToSetChecked = [];\r\n                                }\r\n\r\n                                self.layersToSetChecked.push(layer);\r\n                            } else {\r\n                                self.addLayer(new TC.layer.Raster({\r\n                                    url: layer.options.url,\r\n                                    type: layer.type,\r\n                                    layerNames: [],\r\n                                    title: layer.title || layer.wrap.getServiceTitle(),\r\n                                    hideTitle: true,\r\n                                    hideTree: false\r\n                                })).then(function () {\r\n                                    updateControl.call(self, layer);\r\n                                });\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            })\r\n            .on(TC.Consts.event.LAYERERROR, function (e) {\r\n                const reason = e.reason;\r\n                if (self.layers.some((f) => { return f == e.layer })) {\r\n                    if (reason) {\r\n                        TC.alert(self.getLocaleString(reason, { url: e.layer.url }));\r\n                    }\r\n                    self.getLayerNodes(e.layer).forEach(function (node) {\r\n                        node.classList.remove(TC.Consts.classes.LOADING);\r\n                    });\r\n                }                \r\n            })\r\n            .on(TC.Consts.event.LAYERREMOVE, function (e) {\r\n                const layer = e.layer;\r\n                self.getLayerNodes(layer).forEach(function (node) {\r\n                    node.classList.remove(TC.Consts.classes.CHECKED);\r\n                    node.querySelector('span').dataset.tooltip = clickToAddText;\r\n                });\r\n                findResultNodes(layer).forEach(function (node) {\r\n                    node.classList.remove(TC.Consts.classes.CHECKED);\r\n                    node.querySelector('h5').dataset.tooltip = clickToAddText;\r\n                });\r\n\r\n                //Marcamos como añadidas aquellas capas que estén en el control de capas cargadas. Esto previene que si borramos una capa padre, todas\r\n                //sus hijas aparezcan como no añadidas, a pesar que que alguna de ellas haya sido añadida previamente de manera individual\r\n                _markWorkLayersAsAdded(layer);\r\n\r\n                //refresh del searchList            \r\n                _refreshResultList.call(self);\r\n            })\r\n            .on(TC.Consts.event.EXTERNALSERVICEADDED, function (e) {\r\n                if (e && e.layer) {\r\n                    self.addLayer(e.layer);\r\n                    self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                }\r\n            })\r\n            .on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n                self.update();\r\n            });\r\n\r\n        return result;\r\n    };\r\n\r\n    const onCollapseButtonClick = function (e) {\r\n        e.target.blur();\r\n        e.stopPropagation();\r\n        const li = e.target.parentElement;\r\n        if (li.tagName === 'LI' && !li.classList.contains(self.CLASS + '-leaf')) {\r\n            li.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n            const ul = li.querySelector('ul');\r\n            ul.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n        }\r\n    };\r\n\r\n    const onSpanClick = function (e, ctl) {\r\n        const li = e.target.parentNode;\r\n        if (!li.classList.contains(TC.Consts.classes.LOADING) && !li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n            e.preventDefault;\r\n\r\n            var layerName = li.dataset.layerName;\r\n            layerName = (layerName !== undefined) ? layerName.toString() : '';\r\n            var layer;\r\n            for (var i = 0, len = ctl._roots.length; i < len; i++) {\r\n                const root = ctl._roots[i];\r\n                if (root.contains(li)) {\r\n                    layer = ctl.getLayer(root.dataset.layerId);\r\n                    break;\r\n                }\r\n            }\r\n            if (!layer) {\r\n                layer = ctl.getLayer(li.dataset.layerId);\r\n            }\r\n            if (layer && layerName) {\r\n                var redrawTime = 1;\r\n\r\n                if (/iPad/i.test(navigator.userAgent))\r\n                    redrawTime = 10;\r\n                else if (TC.Util.detectFirefox())\r\n                    redrawTime = 250;\r\n\r\n                if (!layer.title) {\r\n                    layer.title = layer.getTree().title;\r\n                }\r\n\r\n                li.classList.add(TC.Consts.classes.LOADING);\r\n                li.querySelector('span').dataset.tooltip = '';\r\n\r\n                const reDraw = function (element) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        setTimeout(function () {\r\n                            element.offsetHeight = element.offsetHeight;\r\n                            element.offsetWidth = element.offsetWidth;\r\n\r\n                            resolve();\r\n                        }, redrawTime);\r\n                    });\r\n                };\r\n\r\n                reDraw(li).then(function () {\r\n                    ctl.addLayerToMap(layer, layerName);\r\n                });\r\n                e.stopPropagation();\r\n            }\r\n        }\r\n    };\r\n\r\n    const createSearchAutocomplete = function () {\r\n        const self = this;\r\n\r\n        self.textInput = self.div.querySelector(\".\" + self.CLASS + \"-input\");\r\n        self.list = self.div.querySelector(\".\" + self.CLASS + \"-search ul\");\r\n        // Clear results list when x button is pressed in the search input\r\n        self.textInput.addEventListener('mouseup', function (e) {\r\n            var oldValue = self.textInput.value;\r\n\r\n            if (oldValue === '') {\r\n                return;\r\n            }\r\n\r\n            // When this event is fired after clicking on the clear button\r\n            // the value is not cleared yet. We have to wait for it.\r\n            setTimeout(function () {\r\n                var newValue = self.textInput.value;\r\n\r\n                if (newValue === '') {\r\n                    self.list.innerHTML = '';\r\n                }\r\n            }, 1);\r\n        });\r\n\r\n        var layerCheckedList = [];\r\n        //Definir el autocomplete del buscador de capas por texto\r\n        TC._search = TC._search || {};\r\n        TC._search.retryTimeout = null;\r\n\r\n                    TC.loadJS(\r\n                        !TC.UI || !TC.UI.autocomplete,\r\n                        [TC.apiLocation + 'TC/ui/autocomplete.js'],\r\n                        function () {\r\n                            TC.UI.autocomplete.call(self.textInput, {\r\n                                link: '#',\r\n                                target: self.list,\r\n                                minLength: 0,\r\n                                source: function (text, callback) {\r\n                                    //lista de capas marcadas\r\n                                    layerCheckedList = [];\r\n                                    self._roots.forEach(function (root) {\r\n                                        root.querySelectorAll(\"li.\" + TC.Consts.classes.CHECKED).forEach(function (item) {\r\n                                            layerCheckedList.push(item.dataset.layerName);\r\n                                        });\r\n                                    });\r\n\r\n                        //con texto vacío, limpiar  y ocultar la lista de resultados\r\n                        text = text.trim();\r\n                        if (text.length < SEARCH_MIN_LENGTH) {\r\n                            self.list.innerHTML = '';\r\n                        }\r\n                        else if (text.length >= SEARCH_MIN_LENGTH) {\r\n                            if (TC._search.retryTimeout)\r\n                                clearTimeout(TC._search.retryTimeout);\r\n                            TC._search.retryTimeout = setTimeout(function () {\r\n                                var results = [];\r\n                                for (var index = 0; index < self.sourceLayers.length; index++) {\r\n                                    var _founds = self.sourceLayers[index].searchSubLayers(text);\r\n                                    if (_founds.length) {\r\n                                        results.push({\r\n                                            service: {\r\n                                                index: index,\r\n                                                title: self.sourceLayers[index].title || self.sourceLayers[index].id\r\n                                            },\r\n                                            founds: _founds\r\n                                        });\r\n                                    }\r\n                                }\r\n                                callback({ servicesFound: results, servicesLooked: self.sourceLayers.length });\r\n                            }, TC._search.interval);\r\n                        }\r\n                    },\r\n                    callback: function (e) {\r\n                        self.textInput.value = e.target.text || e.target.innerText;\r\n                        TC._search.lastPattern = self.textInput.value;\r\n                        self.goToResult(unescape(e.target.hash).substring(1));\r\n                        TC.UI.autocomplete.call(self.textInput, 'clear');\r\n                    },\r\n                    buildHTML: function (data) {\r\n                        var container = this.target;\r\n                        //si hay resultados, mostramos la lista\r\n                        if (data.results && data.results.servicesFound.length > 0) {\r\n                            var workLayers = self.map.getLayerTree().workLayers;\r\n                            for (var k = 0; k < data.results.servicesFound.length; k++) {\r\n                                var founds = data.results.servicesFound[k].founds;\r\n                                for (var j = 0; j < founds.length; j++) {\r\n                                    delete founds[j].alreadyAdded;\r\n                                    for (var i = 0; i < workLayers.length; i++) {\r\n                                        //if (workLayers[i].title == data.results[j].Title ) {\r\n                                        if (layerCheckedList.indexOf(founds[j].Name) >= 0) {\r\n                                            founds[j].alreadyAdded = true;\r\n                                            break;\r\n                                        }\r\n                                    }\r\n                                    //Si la capa no tiene Name, no se puede añadir al TOC\r\n                                    if (!founds[j].Name) {\r\n                                        founds.splice(j, 1);\r\n                                        j--;\r\n                                    }\r\n                                }\r\n                                if (!data.results.servicesFound[k].founds.length) {\r\n                                    data.results.servicesFound.splice(k, 1);\r\n                                    continue;\r\n                                }\r\n                                //si estaba collapsado mantenemos el estado\r\n                                if (self.div.querySelectorAll(\".tc-ctl-lcat-search-group\")[k]) {\r\n                                    data.results.servicesFound[k].service.isCollapsed = self.div.querySelectorAll(\".tc-ctl-lcat-search-group\")[k].classList.contains(TC.Consts.classes.COLLAPSED);\r\n                                }\r\n                            }\r\n                        }\r\n                        var ret = ''\r\n                        self.getRenderedHtml(self.CLASS + '-results', data.results).then(function (out) {\r\n                            container.innerHTML = ret = out;\r\n                        });\r\n                        return ret;\r\n                    }\r\n                });\r\n            });\r\n\r\n\r\n        if (!self.searchInit) {\r\n            //botón de la lupa para alternar entre búsqueda y árbol\r\n            self.div.addEventListener('click', TC.EventTarget.listenerBySelector('h2 button', function (e) {\r\n                const wasCollapsed = self.div.classList.contains(TC.Consts.classes.COLLAPSED);\r\n                self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n\r\n                const searchPane = self.div.querySelector('.' + self.CLASS + '-search');\r\n                const treePane = self.div.querySelector('.' + self.CLASS + '-tree');\r\n                const infoPane = self.div.querySelector('.' + self.CLASS + '-info');\r\n\r\n                const searchPaneMustShow = !!(searchPane.classList.contains(TC.Consts.classes.HIDDEN) || wasCollapsed);\r\n                searchPane.classList.toggle(TC.Consts.classes.HIDDEN, !searchPaneMustShow);\r\n                treePane.classList.toggle(TC.Consts.classes.HIDDEN, searchPaneMustShow);\r\n                e.target.classList.toggle(self.CLASS + '-btn-tree', searchPaneMustShow);\r\n                e.target.classList.toggle(self.CLASS + '-btn-search', !searchPaneMustShow);\r\n                if (searchPaneMustShow) {\r\n                    self.textInput.focus();\r\n                    e.target.setAttribute('title', self.getLocaleString('viewAvailableLayersTree'));\r\n\r\n                    //Si no hay resultados resaltados en el buscador, ocultamos el panel de info\r\n                    const selectedCount = self.div.querySelectorAll('.tc-ctl-lcat-search li button.tc-checked').length;\r\n                    if (selectedCount === 0) {\r\n                        infoPane.classList.add(TC.Consts.classes.HIDDEN);\r\n                    }\r\n                }\r\n                else {\r\n                    e.target.setAttribute('title', self.getLocaleString('searchLayersByText'));\r\n\r\n                    //Si hay resaltados en el árbol, mostramos el panel de info\r\n                    const selectedCount = self.div.querySelectorAll('.tc-ctl-lcat-tree li button.tc-checked').length;\r\n                    if (selectedCount > 0) {\r\n                        infoPane.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    }\r\n                }\r\n            }));\r\n\r\n\r\n            //evento de expandir nodo de info\r\n            //self._$div.off(\"click\", \".tc-ctl-lcat-search button\");                        \r\n            self.div.addEventListener(\"click\", TC.EventTarget.listenerBySelector(\".\" + self.CLASS + \"-search button.\" + self.CLASS + \"-search-btn-info\", function (evt) {\r\n                evt.stopPropagation();\r\n                const target = evt.target;\r\n                if (!target.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                    const li = target.parentElement;\r\n                    var parent = li;\r\n                    do {\r\n                        parent = parent.parentElement;\r\n                    }\r\n                    while (parent && parent.tagName !== 'LI');\r\n                    self.showLayerInfo(self.layers.length > 1 ? self.layers[parent.dataset.serviceIndex] : self.layers[0], li.dataset.layerName);\r\n                    target.classList.add(TC.Consts.classes.CHECKED);\r\n\r\n                } else {\r\n                    target.classList.remove(TC.Consts.classes.CHECKED);\r\n                    self.hideLayerInfo();\r\n                }\r\n            }));\r\n\r\n                        //click en un resultado - añadir capa\r\n            const searchListElementSelector = '.' + self.CLASS + '-search li';\r\n            self.div.addEventListener('click', TC.EventTarget.listenerBySelector(searchListElementSelector, function (evt) {\r\n                evt.stopPropagation();\r\n                var li = evt.target;\r\n                while (li && !li.matches(searchListElementSelector)) {\r\n                    li = li.parentElement;\r\n                }\r\n                if (li.classList.contains(self.CLASS + '-no-results')) {\r\n                    return; //si clicko en el li de \"no hay resultados\" rompo el ciclo de ejecución\r\n                }\r\n                if (li.classList.contains(self.CLASS + '-search-group')) {\r\n                    li.classList.toggle(TC.Consts.classes.COLLAPSED);\r\n                    return;\r\n                }\r\n                var layerName = li.dataset.layerName;\r\n                if (!layerName) {\r\n                    return;\r\n                }\r\n                layerName = layerName.toString();\r\n\r\n                if (layerName.trim().length === 0) {\r\n                    return;\r\n                }\r\n\r\n                //si la capa ya ha sido anteriormente, no la añadimos y mostramos un mensaje\r\n                if (li.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                    return;\r\n                } else {\r\n                    var liParent = li;\r\n                    do {\r\n                        liParent = liParent.parentElement;\r\n                    }\r\n                    while (liParent && !liParent.matches('li.' + self.CLASS + '-search-group'));\r\n\r\n                    const layerIdx = !liParent ? 0 : liParent.dataset.serviceIndex;\r\n                    const url = self.layers[layerIdx].options.url;\r\n                    const title = self.layers[layerIdx].title;\r\n\r\n                    const layer = new TC.layer.Raster({\r\n                        id: self.getUID(),\r\n                        url: url,\r\n                        title: title,\r\n                        hideTitle: self.layers[layerIdx].hideTitle || self.layers[layerIdx].options.hideTitle,\r\n                        hideTree: false,\r\n                        layerNames: [layerName]\r\n                    });\r\n                    if (layer.isCompatible(self.map.crs)) {\r\n                        self.map.addLayer(layer, function (layer) {\r\n                            li.dataset.layerId = layer.id;\r\n                            layer.wrap.$events.on(TC.Consts.event.TILELOADERROR, function (event) {\r\n                                var layer = this.parent;\r\n                                if (event.error.code === 401 || event.error.code === 403)\r\n                                    layer.map.toast(event.error.text, { type: TC.Consts.msgType.ERROR });\r\n                                layer.map.removeLayer(layer);\r\n                            });\r\n                        });\r\n                        //marcamos el resultado como añadido\r\n                        li.classList.add(TC.Consts.classes.CHECKED);\r\n                        li.querySelector('h5').dataset.tooltip = self.getLocaleString('layerAlreadyAdded');\r\n                    }\r\n                    else {\r\n                        showProjectionChangeDialog(self, layer);\r\n                    }\r\n                }\r\n            }));\r\n\r\n            self.searchInit = true;\r\n        }\r\n    };\r\n\r\n    const getLayerTree = function (layer) {\r\n        var result = layer.getTree();\r\n        var makeNodeVisible = function makeNodeVisible(node) {\r\n            var result = false;\r\n            var childrenVisible = false;\r\n            for (var i = 0; i < node.children.length; i++) {\r\n                if (makeNodeVisible(node.children[i])) {\r\n                    childrenVisible = true;\r\n                }\r\n            }\r\n            if (node.hasOwnProperty('isVisible')) {\r\n                node.isVisible = (!layer.names || !layer.names.length) || childrenVisible || node.isVisible;\r\n            }\r\n            return node.isVisible;\r\n        };\r\n        makeNodeVisible(result);\r\n        return result;\r\n    };\r\n\r\n    const _refreshResultList = function () {\r\n        const self = this;\r\n\r\n        if (\"createEvent\" in document) {\r\n            var evt = document.createEvent(\"HTMLEvents\");\r\n            evt.initEvent(\"keyup\", false, true);\r\n            if (self.textInput) {\r\n                self.textInput.dispatchEvent(evt);\r\n            }\r\n        }\r\n        else {\r\n            if (self.textInput) {\r\n                self.textInput.fireEvent(\"keyup\");\r\n            }\r\n        }\r\n    };\r\n\r\n    const updateControl = function (layer) {\r\n        const self = this;\r\n\r\n        self.getLayerNodes(layer).forEach(function (node) {\r\n            node.classList.remove(TC.Consts.classes.LOADING);\r\n            node.classList.add(TC.Consts.classes.CHECKED);\r\n            node.querySelector('span').dataset.tooltip = self.getLocaleString('layerAlreadyAdded');\r\n        });\r\n        _refreshResultList.call(self);\r\n    };\r\n\r\n    const setCheckedLayersOnNode = function () {\r\n        const self = this;\r\n\r\n        if (self.layersToSetChecked && self.layersToSetChecked.length > 0) {\r\n            self.layersToSetChecked.forEach(function (layer, index, array) {\r\n                if (self.getLayerRootNode(layer)) {\r\n                    updateControl.call(self, layer);\r\n\r\n                    array.splice(index, 1);\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    const addLogicToNode = function (node, layer) {\r\n        const self = this;\r\n\r\n        node.querySelectorAll('li > button.' + self.CLASS + '-collapse-btn').forEach(function (btn) {\r\n            btn.addEventListener('click', onCollapseButtonClick);\r\n        });\r\n\r\n        node.querySelectorAll('span').forEach(function (span) {\r\n            span.addEventListener('click', function (e) {\r\n                onSpanClick(e, self);\r\n            });\r\n        });\r\n\r\n        self._roots = self.div.querySelectorAll(self._selectors.LAYER_ROOT);                \r\n        \r\n        node.dataset.layerId = layer.id;\r\n\r\n        var formatDescriptions = {};\r\n        node.querySelectorAll('.' + self.CLASS + '-btn-info').forEach(function (a) {\r\n            const span = a.parentElement.querySelector('span');\r\n            const name = a.parentElement.dataset.layerName;\r\n            if (name) {\r\n                span.classList.add(TC.Consts.classes.SELECTABLE);\r\n                var info = layer.wrap.getInfo(name);\r\n                if (!info.hasOwnProperty('abstract') && !info.hasOwnProperty('legend') && !info.hasOwnProperty('metadata')) {\r\n                    a.parentElement.removeChild(a);\r\n                }\r\n                else {                    \r\n                    a.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                        e.stopPropagation();\r\n                        const elm = this;\r\n                        if (elm.classList.toggle(TC.Consts.classes.CHECKED)) {\r\n                            self.showLayerInfo(layer, name);\r\n                        } else {\r\n                            self.hideLayerInfo();\r\n                        }\r\n                    });\r\n                }\r\n                if (layer.compatibleLayers && layer.compatibleLayers.indexOf(name) < 0) {\r\n                    span.classList.add(TC.Consts.classes.INCOMPATIBLE);\r\n                    span.setAttribute('title', self.getLocaleString('reprojectionNeeded'));\r\n                    //console.log(\"capa \" + name + \" incompatible\");\r\n                }\r\n                if (self.map) {\r\n                    for (var j = 0, len = self.map.workLayers.length; j < len; j++) {\r\n                        var wl = self.map.workLayers[j];\r\n                        if (wl.type === TC.Consts.layerType.WMS && wl.url === layer.url && wl.names.length === 1 && wl.names[0] === name) {\r\n                            span.parentElement.classList.add(TC.Consts.classes.CHECKED);\r\n                            span.dataset.tooltip = self.getLocaleString('layerAlreadyAdded');\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                span.dataset.tooltip = '';\r\n                a.parentElement.removeChild(a);\r\n            }\r\n        });        \r\n\r\n        setCheckedLayersOnNode.call(self);\r\n\r\n        self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n        });\r\n    };\r\n\r\n    ctlProto.renderBranch = function (layer, callback, promiseRenderResolve) {\r\n        const self = this;\r\n\r\n        layer.getCapabilitiesPromise()\r\n            .then(function (result) {\r\n\r\n                self.sourceLayers.push(layer);\r\n\r\n                self.getRenderedHtml(self.CLASS + '-branch', getLayerTree(this), function (html) {\r\n                    var template = document.createElement('template');\r\n                    template.innerHTML = html;\r\n\r\n                    var newChild = template.content ? template.content.firstChild : template.firstChild;\r\n                    var oldChild = self.div.querySelector('.' + self.CLASS + '-branch').querySelector('li.' + self.CLASS + '-loading-node[data-layer-id=\"' + this.id + '\"]');\r\n\r\n                    if (oldChild) {\r\n                        self.div.querySelector('.' + self.CLASS + '-branch').replaceChild(newChild, oldChild);\r\n                    } else {\r\n                        self.div.querySelector('.' + self.CLASS + '-branch').appendChild(newChild);\r\n                    }\r\n\r\n                    addLogicToNode.call(self, newChild, this);\r\n\r\n                    if (self.div.querySelector('.' + self.CLASS + '-branch').childElementCount === 1) {\r\n                        promiseRenderResolve();\r\n                    }\r\n\r\n                    if (TC.Util.isFunction(callback)) {\r\n                        // pasamos el callback el item \r\n                        callback(self.sourceLayers[self.sourceLayers.map(function (l) { return l.id }).indexOf(this.id)]);\r\n                    }\r\n\r\n                }.bind(this));\r\n\r\n            }.bind(layer))\r\n            .catch(function (error) {\r\n                var index = self.layers.map(function (l) { return l.id }).indexOf(this.id);\r\n                self.layers.splice(index, 1);\r\n\r\n                var errorMessage = self.getLocaleString(\"lyrCtlg.errorLoadingNode\", { serviceName: this.title });\r\n                var liError = self.div.querySelector('.' + self.CLASS + '-branch').querySelector('li.' + self.CLASS + '-loading-node[data-layer-id=\"' + this.id + '\"]');\r\n                liError.classList.add('error');\r\n                liError.setAttribute('title', errorMessage);\r\n\r\n                self.map.toast(errorMessage, { type: TC.Consts.msgType.ERROR });\r\n\r\n            }.bind(layer));\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n\r\n        self.sourceLayers = [];\r\n\r\n        return self._set1stRenderPromise(new Promise(function (resolve, reject) {\r\n            if (self.layers.length === 0) {\r\n                self.renderData({ layerTrees: [], enableSearch: false }, function () {\r\n\r\n                    if (TC.Util.isFunction(callback)) {\r\n                        callback();\r\n                    }\r\n\r\n                    resolve();\r\n                });\r\n            } else {\r\n                self.renderData({ layers: self.layers, enableSearch: true }, function () {\r\n\r\n                    createSearchAutocomplete.call(self);\r\n\r\n                    self.layers.forEach(function (layer) {\r\n                        self.renderBranch(layer, callback, resolve);\r\n                    });\r\n                });\r\n            }\r\n        }));\r\n    };\r\n\r\n    ctlProto.getLayerRootNode = function (layer) {\r\n        const self = this;\r\n        var result = null;\r\n        if (!layer.isBase) {\r\n            var url = layer.options.url;\r\n            if (self._roots) {\r\n                self._roots.forEach(function (li) {\r\n                    const lyr = self.getLayer(li.dataset.layerId);\r\n                    if (lyr && lyr.type === layer.type && lyr.options.url === url) {\r\n                        result = li;\r\n                    }\r\n                });\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.getLayerNodes = function (layer) {\r\n        const self = this;\r\n        const result = [];\r\n        const rootNode = self.getLayerRootNode(layer);\r\n        if (rootNode) {\r\n            for (var i = 0; i < layer.names.length; i++) {\r\n                const liLayer = rootNode.querySelector('li[data-layer-name=\"' + layer.names[i] + '\"]');\r\n                if (!liLayer) {\r\n                    continue;\r\n                }\r\n                result[result.length] = liLayer;\r\n                liLayer.querySelectorAll('li').forEach(function (li) {\r\n                    result[result.length] = li;\r\n                });\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.showLayerInfo = function (layer, name) {\r\n        const self = this;\r\n        var result = null;\r\n\r\n        var info = self.div.querySelector('.' + self.CLASS + '-info');\r\n\r\n        const toggleInfo = function (layerName, infoObj) {\r\n            var result = false;\r\n            //if (lName !== undefined && lName.toString() === layerName) {\r\n            //    info.dataset.layerName = '';\r\n            //    $info.removeClass(TC.Consts.classes.HIDDEN);\r\n            //}\r\n            //else {\r\n            if (infoObj) {\r\n                result = true;\r\n                info.dataset.layerName = layerName;\r\n                info.classList.remove(TC.Consts.classes.HIDDEN);\r\n                self.getRenderedHtml(self.CLASS + '-info', infoObj)\r\n                    .then(function (out) {\r\n                        info.innerHTML = out;\r\n                        info.querySelector('.' + self.CLASS + '-info-close').addEventListener(TC.Consts.event.CLICK, function () {\r\n                            self.hideLayerInfo();\r\n                        })\r\n                    })\r\n                    .catch(function (err) {\r\n                        TC.error(err);\r\n                    });\r\n            }\r\n            //}\r\n            return result;\r\n        };\r\n\r\n        self.div.querySelectorAll('.' + self.CLASS + '-btn-info, .' + self.CLASS + '-search-btn-info').forEach(function (btn) {\r\n            btn.classList.remove(TC.Consts.classes.CHECKED);\r\n        });\r\n\r\n        const formatDescriptions = {};\r\n        for (var i = 0, ii = self._roots.length; i < ii; i++) {\r\n            const root = self._roots[i];\r\n            if (root.dataset.layerId === layer.id) {\r\n                const as = root.querySelectorAll('.' + self.CLASS + '-btn-info');\r\n                for (var j = 0, jj = as.length; j < jj; j++) {\r\n                    const a = as[j];\r\n                    var n = a.parentElement.dataset.layerName;\r\n                    if (n === name) {\r\n                        const info = layer.wrap.getInfo(name);\r\n                        if (info.metadata) {\r\n                            info.metadata.forEach(function (md) {\r\n                                md.formatDescription = formatDescriptions[md.format] =\r\n                                    formatDescriptions[md.format] ||\r\n                                    self.getLocaleString(TC.Util.getSimpleMimeType(md.format)) ||\r\n                                    self.getLocaleString('viewMetadata');\r\n                            });\r\n                        }\r\n                        const infoBtn = self.div.querySelector('li [data-layer-name=\"' + n + '\"] > button.' + self.CLASS + '-btn-info');\r\n                        infoBtn.classList.toggle(TC.Consts.classes.CHECKED, toggleInfo(n, info));\r\n                        result = info;\r\n                        break;\r\n                    }\r\n                }\r\n                break;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.update = function () {\r\n        const self = this;\r\n        self.sourceLayers.forEach(function (layer) {\r\n            layer.getCapabilitiesPromise().then(function () {\r\n                layer.compatibleLayers = layer.wrap.getCompatibleLayers(self.map.crs);\r\n\r\n                const rootNode = self.getLayerRootNode(layer);\r\n                if (rootNode) {\r\n                    rootNode\r\n                        .querySelectorAll('li[data-layer-name]')\r\n                        .forEach(function (li) {\r\n                            const name = li.dataset.layerName;\r\n                            const span = li.querySelector('span.' + TC.Consts.classes.SELECTABLE);\r\n                            if (layer.compatibleLayers.indexOf(name) < 0) {\r\n                                span.classList.add(TC.Consts.classes.INCOMPATIBLE);\r\n                                span.setAttribute('title', self.getLocaleString('reprojectionNeeded'));\r\n                            }\r\n                            else {\r\n                                span.classList.remove(TC.Consts.classes.INCOMPATIBLE)\r\n                                span.removeAttribute('title');\r\n                            }\r\n                        });\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.hideLayerInfo = function () {\r\n        var self = this;\r\n        self.div.querySelectorAll('.' + self.CLASS + '-btn-info, .' + self.CLASS + '-search-btn-info').forEach(function (btn) {\r\n            btn.classList.remove(TC.Consts.classes.CHECKED);\r\n        });\r\n        self.div.querySelector('.' + self.CLASS + '-info').classList.add(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    ctlProto.addLayer = function (layer) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var fromLayerCatalog = [];\r\n\r\n            if (self.options.layers && self.options.layers.length) {\r\n                fromLayerCatalog = self.options.layers.filter(function (l) {\r\n                    var getMap = TC.Util.reqGetMapOnCapabilities(l.url);\r\n                    return getMap && getMap.replace(TC.Util.regex.PROTOCOL) == layer.url.replace(TC.Util.regex.PROTOCOL);\r\n                });\r\n            }\r\n\r\n            if (fromLayerCatalog.length == 0)\r\n                fromLayerCatalog = self.layers.filter(function (l) {\r\n                    return l.url.replace(TC.Util.regex.PROTOCOL) == layer.url.replace(TC.Util.regex.PROTOCOL);\r\n                });\r\n\r\n            if (fromLayerCatalog.length == 0) {\r\n                self.layers.push(layer);\r\n                layer.getCapabilitiesPromise().then(function () {\r\n                    layer.compatibleLayers = layer.wrap.getCompatibleLayers(self.map.crs);\r\n                    layer.title = layer.title || layer.wrap.getServiceTitle();\r\n                    self.renderBranch(layer, function () {\r\n                        resolve(); //ver linea 55 y por ahí\r\n                    });\r\n                });\r\n            } else { resolve(); }\r\n        });\r\n    };\r\n\r\n    ctlProto.getLayer = function (id) {\r\n        const self = this;\r\n        for (var i = 0, len = self.layers.length; i < len; i++) {\r\n            const layer = self.layers[i];\r\n            if (layer.id === id) {\r\n                // 10/04/2019 GLS: validamos si es una capa que viene de configuración o es un WMS externo o por estado \r\n                // para decidir si mostramos el título del servicio o no\r\n                var configLayer = self.options.layers.filter(l => l.id === id);\r\n\r\n                if (configLayer.length > 0) {\r\n                    layer.hideTitle = layer.options.hideTitle = configLayer[0].hideTitle;\r\n                } else {\r\n                    layer.hideTitle = layer.options.hideTitle = false;\r\n                }                \r\n                \r\n                return layer;\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.addLayerToMap = function (layer, layerName) {\r\n        const self = this;\r\n        const layerOptions = TC.Util.extend({}, layer.options);\r\n        layerOptions.id = self.getUID();\r\n        layerOptions.layerNames = [layerName];\r\n        layerOptions.title = layer.title;\r\n        const newLayer = new TC.layer.Raster(layerOptions);\r\n        if (newLayer.isCompatible(self.map.crs)) {\r\n            self.map.addLayer(layerOptions);\r\n        }\r\n        else {\r\n            showProjectionChangeDialog(self, newLayer);\r\n        }\r\n    };\r\n\r\n    ctlProto.loaded = function () {\r\n        return this._readyPromise;\r\n    };\r\n\r\n    ctlProto.getAvailableCRS = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n        return self.map.getCompatibleCRS({\r\n            layers: self.map.workLayers.concat(self.map.baseLayer, options.layer),\r\n            includeFallbacks: true\r\n        });\r\n    };\r\n\r\n    ctlProto.setProjection = function (options) {\r\n        const self = this;\r\n        options = options || {};\r\n\r\n        TC.loadProjDef({\r\n            crs: options.crs,\r\n            callback: function () {\r\n                self.map.setProjection(options).then(function () {\r\n                    if (self._layerToAdd) {\r\n                        self.map.addLayer(self._layerToAdd);\r\n                    }\r\n                    TC.Util.closeModal();\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.showProjectionChangeDialog = function (options) {\r\n        const self = this;\r\n        self._layerToAdd = options.layer;\r\n        TC.control.ProjectionSelector.prototype.showProjectionChangeDialog.call(self, options);\r\n    };\r\n\r\n})();"]}