{"version":3,"sources":["view/ThreeD.js"],"names":["TC","view","control","MapContents","syncLoadJS","apiLocation","viewProto","VIEWNAME","CLASS","Consts","BLANK_BASE","DEFAULT_TILE_SIZE","classes","MAPTHREED","LOADING","CAMERACTRARROWDISABLED","FOCUS","HIGHLIGHTED","DISABLED","OUTFOCUS","allowedControls","template","viewer","mapView","terrainProvider","getLocaleString","key","texts","locale","this","map","options","Cfg","Util","getRenderedHtml","templateId","data","callback","Control","prototype","call","isDebug","url","CESIUM","THREED","THREED_HIDDEN","event","TERRAINLOADED","TERRAINRECEIVING","TERRAIN404","dust","register","body_0","chk","ctx","w","h","$key","__dustBody","MapView","parent","self","Promise","resolve","getViewHTML","then","html","viewHTML","bind","metersPerUnit","getMetersPerUnit","maxResolution","_oldMapSetCenter","setCenter","coords","on3DView","view3D","flyToMapCoordinates","getCenter","getExtent","getResolution","getRotation","getMaxResolution","getResolutions","extent","baselayerExtent","getPixelFromCoordinate","center","setExtent","setResolution","resolution","setRotation","rotation","isCompatible","layer","crs","type","layerType","WMTS","wrap","getCompatibleMatrixSets","length","distanceSquared","p1","p2","dx","dy","getFarMapCoords","obj","nearMapCoords","nextPixel","bottomPixel","clone","y","Math","round","nextCoords","pickMapCoords","coordsArray","sort","a","b","cameraPosition","origin","nearPoint","angle","atan","PI","cos","sin","apply","pixel","pickPoint","pickOnTerrainOrEllipsoid","scene","Cesium","Cartographic","fromCartesian","view2DCRS","reproject","toDegrees","longitude","latitude","calcResolutionForDistance","distance","canvas","fovy","camera","frustum","visibleMeters","tan","relativeCircumference","abs","visibleMapUnits","clientHeight","resolutions","Array","i","ii","pow","rotateAroundAxis","axis","transform","opt_options","start","clamp","defaultValue","duration","easing","lastProgress","oldTransform","Matrix4","reject","requestAnimationFrame","animation","timestamp","progress","stepAngle","lookAtTransform","rotate","ray","getPickRay","target","globe","pick","pickEllipsoid","pickCenterPoint","Cartesian2","clientWidth","pickBottomPoint","bottom","setHeadingUsingBottomCenter","heading","bottomCenter","angleToZenith","computeAngleToZenith","right","quaternion","Quaternion","fromAxisAngle","Matrix3","fromQuaternion","vector","Cartesian3","subtract","position","zenith","multiplyByVector","add","fromTranslation","signedAngleBetween","first","second","normal","c","normalize","cross","cosine","dot","sine","magnitude","sign","atan2","pivot","fy","fovy2","direction","matrix","Ray","bottomFovRay","negate","Ellipsoid","WGS84","geocentricSurfaceNormal","left","CameraControls","cssRotate","element","coord","getBBox","value","x","width","height","document","getElementsByClassName","className","baseVal","setAttribute","outControlsEvents","detectMouse","outControls","e","isFocusingCameraCtrls","inControlsEvents","inControls","lastFocused","performance","now","div","classList","contains","remove","tiltIndicatorOuterCircle","tiltIndicatorOuterShellCircle","rotateIndicatorOuterCircle","rotateIndicatorOuterShellCircle","moveStart","moving","moveEnd","postRender","isLoadingTiles","customCollisionDetection","getCamera","positionCartographic","tiltIndicator","pitch","rotateIndicator","disableRotate","disableTilt","_coordsXY","_ovMap","getControlsByClass","renderPromise","bottomLeft","bottomRight","fovCoords","elm","filter","farCoordsLeft","farCoordsRight","draw3DCamera","fov","selectors","tilt","indicator","leftArrow","rightArrow","downArrow","upArrow","MIN_TILT","toRadians","MAX_TILT","render","addEventListener","forEach","rAFInOutControls","setOpacity","unbind","HIDDEN","removeEventListener","window","cancelAnimationFrame","undefined","getCameraState","cp","chpr","roll","bcpd","createElement","innerHTML","appendChild","tiltSelector","tiltIndicatorInner","querySelector","replace","CLICK","resetTilt","tiltIndicatorCircle","stopPropagation","preventDefault","vectorScratch","currentTarget","rectangle","getBoundingClientRect","top","clickLocation","clientX","clientY","draggingTilt","cancelBubble","returnValue","tiltUp","disabled","upEvent","tiltUpMouseUpFunction","tiltUpInterval","setInterval","isTiltUpDisabled","clearInterval","tiltDown","tiltDownMouseUpFunction","tiltDownInterval","isTiltDownDisabled","rotateSelector","rotateIndicatorInner","resetRotation","rotateIndicatorCircle","draggingRotate","rotateLeft","rotateLeftMouseUpFunction","rotateLeftInterval","rotateRight","rotateRightMouseUpFunction","rotateRightInterval","theta","toggle","isDisable","trackedEntity","rotateUp","lookUp","lookDown","PI_OVER_TWO","_angle","tiltElement","cursorVector","oldTransformScratch","newTransformScratch","tiltMouseMoveFunction","tiltMouseUpFunction","isTilting","tiltFrame","Transforms","northUpEastToFixedFrame","tiltIsLook","positionWC","startCursorAngle","initialCameraAngle","tiltRectangle","console","log","toString","angleDifference","newCameraAngle","zeroToTwoPi","currentCameraAngle","rotateElement","rotateMouseMoveFunction","rotateMouseUpFunction","rotateRectangle","rotateInitialCursorAngle","rotateInitialCameraAngle","rotateFrame","isRotating","viewCenter","eastNorthUpToFixedFrame","rotateIsLook","rotateInitialCameraDistance","currentRotation","fromDegrees","mag","scratchAdjustHeightTransform","scratchAdjustHeightCartographic","screenSpaceCameraController","minimumCollisionTerrainHeight","enableCollisionDetection","minimumZoomDistance","ellipsoid","mapProjection","equals","IDENTITY","_setTransform","cartographic","cartesianToCartographic","heightUpdated","getHeight","cartographicToCartesian","multiplyByScalar","max","up","limitCameraToInitExtent","pos","initExtent","west","east","south","north","maxHeight","maximumZoomDistance","padding","min","setView","destination","orientation","TwoDLinkedFeatureInfo","savedMode","pending","marker","ctlResultsPanel","ctlFeatureInfo","map2DgetResolutionFN","getResultsPanelCtl","ResultsPanel","resultsPanelOptions","content","titles","main","addControlPromise","controlContainer","POSITION","RIGHT","addControl","caller","resultsPanel","removeMarker","removeFeature","FeatureInfo","displayMode","setDisplayMode","FeatureInfoCommons","RESULTS_PANEL","on","RESULTSPANELCLOSE","getDisplayControl","querying","clear","closeResults","reset","send","pickedPosition","close","waiting","getLoadingIndicator","addWait","markerStyle","billboard","image","getBackgroundUrlFromCss","eyeOffset","verticalOrigin","VerticalOrigin","BOTTOM","heightReference","HeightReference","CLAMP_TO_GROUND","addNativeFeature","requestRender","setMarker","reprojected","pickedLocation","pixelTolerance","pickedTile","tilesRendered","_surface","_tilesToRender","textureIndex","tile","Rectangle","imageryTiles","imagery","terrainImagery","readyImagery","nativeRectangle","tilingScheme","tileXYToNativeRectangle","level","readyImageryToGetNativeRectangle","imageryLayer","isBaseLayer","west_south","east_north","xResolution","imageryProvider","tileWidth","yResolution","tileHeight","one","NOFEATUREINFO","FEATUREINFO","FEATURECLICK","savedIsActive","isActive","beforeRequest","xy","get2DMarker","filterFeature","isPending","RasterConverter","crsPattern","layerCrs","CustomResource","paths","CRS","TILEMATRIXSET","TILEMATRIXSETLABELS","getOfPath","p","hasOwnProperty","_obj","push","wmtsLayer","tileMatrixSetLabels","capsURL","isOnCapabilities","caps","capabilities","tileMatrixSet","getTileMatrixSetLabelByLayerOnCapabilities","urlPattern","layerNames","style","format","tileMatrixSetID","tileMatrixLabels","GeographicTilingScheme","WebMapTileServiceImageryProvider","xhrBlobSupported","xhr","XMLHttpRequest","open","responseType","fetchImage","resource","allowCrossOrigin","request","requestFunction","crossOrigin","isDataUri","isBlobUri","isCrossOriginUrl","deferred","when","defer","getWebGLUrl","Image","onload","onerror","TrustedServers","src","createImage","promise","RequestScheduler","defined","otherwise","customFetchImage","preferBlob","deprecationWarning","state","RequestState","ISSUED","ACTIVE","RuntimeError","UNISSUED","checkAndResetRequest","hasHeaders","blobPromise","fetchBlob","generatedBlobResource","generatedBlob","blob","blobUrl","URL","createObjectURL","Resource","revokeObjectURL","error","convert","map3DCRS","constructor","Object","create","result","cloned","_url","_queryParameters","_templateValues","headers","proxy","retryCallback","retryAttempts","_retryCount","defineCustomResource","WMS","layers","parameters","version","transparent","exBoundingBox","bbox","Capability","Layer","names","slice","_getEXBBox","nodes","name","n","compareNames","getName","EX_GeographicBoundingBox","exBBox","pop","bindEXBBox","geoBBox","WebMapServiceImageryProvider","FeatureConverter","toCesiumColor","hexStringColor","alpha","color","Color","fromCssColorString","withAlpha","setStyleProperties","styles","properties","feature","attr","prop","val","getFeatureStyle","Defaults","STYLETYPE","extend","getStyle","createLine","id","entity","Entity","polyline","positions","material","clampToGround","polygonConverter","polygon","opt","opacity","outlineColor","outlineOpacity","ColorGeometryInstanceAttribute","fromColor","MultiPolygon","CLASSNAME","geometryType","polygonHierarchy","getting","geomPolys","geomOutlines","getOutlineGeom","outlineCoords","res","rej","j","hierarchy","PolygonHierarchy","holes","GeometryInstance","geometry","PolygonGeometry","attributes","all","GroundPrimitive","releaseGeometryInstances","geometryInstances","Polygon","isArray","lineConverter","line","MultiPolyline","geomInstances","minx","miny","maxx","maxy","point","z","fromCartesianArray","neededCameraPosition","getRectangleCameraCoordinates","BoundingSphere","fromPoints","pixelSize","getPixelDimensions","drawingBufferWidth","drawingBufferHeight","getPixelSize","Polyline","pointConverter","label","fontSize","fontColor","outlineLabelColor","outlineLabelWidth","anchor","outlineWidth","radius","Marker","pixelOffset","text","font","horizontalOrigin","HorizontalOrigin","LEFT","fillColor","showBackground","Point","pinBuilder","PinBuilder","test","CENTER","BASELINE","BLACK","WHITE","LabelStyle","FILL_AND_OUTLINE","fromText","toDataURL","stringifyScratch","drawPin","context2D","size","rgbaColor","darken","toCssColorString","save","scale","strokeStyle","miterLimit","restore","fillStyle","lineWidth","lineJoin","beginPath","moveTo","lineTo","closePath","fill","stroke","translate","arc","createPin","_cache","JSON","stringify","item","getContext","strokeColor","scn","sourceCrs","targetCrs","converter","points","ringsOrPolylines","polygons","byPromise","cartesians","toCartesian","arr","forPoints","forRingsOrPolylines","Circle","circle","CircleGeometry","forPolygons","boundigSphere","provider","currentMapCfg","baseMap","baseMaps","baseVector","init","events","$events","divThreedMap","divMap","terrain","Error","terrainFallback","coverageName","noDataValue","trim","layerName","controls","PROJECTIONCHANGE","parser","DOMParser","overlay","parseFromString","body","firstChild","viewName","substr","toLowerCase","views","newCrs","toast","msgType","INFO","ctrlsToMng","ctls","len","ctl","toUpperCase","ctlsOnMap","CONTROLADD","ctrlClass","instance","Function","concat","container","loaded","removeWait","loadViewer","isBaseRaster","baseLayer","Raster","fallbackLayer","getFallbackLayer","_capabilitiesPromise","baseLayers","results","mustReproject","setCameraFromMapView","setBaseLayer","workLayers","elem","reverse","addLayer","readyPromise","cameraControls","animateRendering","flyTo","fromRadians","complete","pickBP","animationCallback","Camera","DEFAULT_VIEW_RECTANGLE","initialRectangle","computeViewRectangle","DEFAULT_VIEW_FACTOR","trigger","VIEWCHANGE","addHeight","finalCartographic","markers","entities","values","Property","getValueOrUndefined","JulianDate","billboardCollection","get","unapply","TERRAINPROVIDERREMOVE","fallbackProvider","setViewFromCameraView","destroy","rasterConverter","featureConverter","addFeature","csFeature","addedFeature","groundPrimitives","primitives","BillboardCollection","billboardAtCollection","getById","linkFeature","idLayer","vector2DFeatures","listenTo","BEFOREBASELAYERCHANGE","BASELAYERCHANGE","LAYERADD","LAYERREMOVE","LAYERVISIBILITY","LAYEROPACITY","LAYERORDER","FEATUREADD","FEATUREREMOVE","FEATURESCLEAR","ZOOMTO","geolocation_newPosition","trackingEntity","geolocation2D","linked2DControls","geolocation","track","layerTracking","features","entityTracking","CallbackProperty","time","newCartographicPositions","coordinate","updatedPositions","cartographicArrayToCartesianArray","PolylineDashMaterialProperty","fromAlpha","renderTrack","checked","gapColor","TRANSPARENT","geolocation_videoControls","Const","Event","IMPORTEDTRACK","indexOf","parentElement","Classes","SELECTEDTRACK","clock","shouldAnimate","currentTime","fromDate","Date","trackDataSource","removeById","chartProgressClear","custom","selectedTrack","getSelectedTrack","Selector","STOP","click","multiplier","simulate_speed","alterAllowedControls","ctrlsToMngCLASS","ctrl","mapCtrl","DEFAULT","enable","disable","querySelectorAll","featureInfo","onLeftClickOnCanvas","movement","getFeatureInfo","getInfoOnPickedPosition","pickedFeature","founded","layerId","feature2D","workLayer","showsPopup","onDrawTable","onTableClose","off","DRAWTABLE","eventHandler","ScreenSpaceEventHandler","setInputAction","ScreenSpaceEventType","LEFT_CLICK","onMouseMoveOnCanvas","endPosition","cursor","MOUSE_MOVE","Geolocation","commands","PAUSE","BACKWARD","FORWARD","DRAW","geolocation_videoControls_","lstEventListener","some","cls","setTracking","_setTracking","simulateTrack","_wrap_simulateTrack","showElevationMarker","_wrap_showElevationMarker","hideElevationMarker","_wrap_hideElevationMarker","_simulateTrack","elevationTrack","_elevationTrack","command","tracking","POSITIONCHANGE","li","resized","hasElevation","simulationOnPreUpdate","drawTrack","layerTrack","coordinates","layout","pointStyle","lineStyle","walkingSpeed","sampleTerrainMostDetailed","startTime","stopTime","totalDistance","ol","geom","GeometryLayout","XYZM","XYM","done","previuos_next","EllipsoidGeodesic","surfaceDistance","toISOString","czml","availability","epoch","cartographicRadians","updatedPosition","reduce","prev","curr","rgba","strokeWidth","coordinates2D","getGeometry","DataSourceCollection","dataSourceDisplay","DataSourceDisplay","dataSourceCollection","preRender","update","CzmlDataSource","load","czmlDataSource","stop","clockStep","ClockStep","TICK_DEPENDENT","clockRange","ClockRange","CLAMPED","trackEntity","tagLI","TimeIntervalCollection","TimeInterval","get2DHeightAtProgress","distanceCurrent","doneDistance","previous","current","heightIndex","XYZ","previousPosition","preUpdate","getAttribute","greaterThanOrEquals","isAvailable","currentPosition","chartSetProgress","d","_getTime","toDate","elevationChartData","getVisibility","getOpacity","elevationMarkerPosition","index","elevationMarker","override2DZoom","activate","zoom","amount","zoomToCartesian","initialExtent","sourceCRS","coordsXY","coordsXY2","flyToRectangle","zoomin","zoomout","NavBarHome","button","NavBar","customRender","vector2DLayers","surface","ready","loadJS","resourceBoundaries","fetchJson","bounds","ApproximateTerrainHeights","initialize","boundaries","arguments","MergeTerrainProvider","fallback","CesiumTerrainProvider","attributions","getAttribution","TERRAINPROVIDERADD","Globe","baseColor","enableLighting","tileCacheSize","maximumScreenSpaceError","Viewer","terrainExaggeration","timeline","fullscreenButton","baseLayerPicker","navigationInstructionsInitiallyVisible","navigationHelpButton","geocoder","homeButton","infoBox","sceneModePicker","selectionIndicator","skyBox","skyAtmosphere","requestRenderMode","maximumRenderTimeChange","Infinity","backgroundColor","imageryLayers","removeAll","errorEvent","statusCode","renderError","code","ERROR","tileLoadingHandler","EventHelper","tileLoadProgressEvent","allReady","removeChild","_event2DHandler","removeLayer","setRenderOptionsLayer","visibility","join","oldIndex","newIndex","lower","raise","splice","threedFeature","featureId","ZOOM","_canvasClientHeight","_canvasClientWidth","lastZoom","Vector","vectorLayer","get3DLayer","title","raiseToTop","isBase","relatedWMTS","getLayer","VECTOR","convertedLayer","enablePickFeatures","newImageryLayer","addImageryProvider","lowerToBottom","show","setRenderOptionsFeature","lonlat","cancelFlight","epsilon","EPSILON3","marginX","marginY","destinationCartesian","finalDestinationCartographic","pickRay","intersection","distanceMeasure","_zoomTo","setTimeout","toMove","toGo","intersectionToGo","easingFunction","EasingFunction","LINEAR_NONE","csfeature","newGeometry","geo","Billboard","cesiumFeature","latlon","carto","setCamera","moveBackward","tool","Elevation","elevationTool","getElevation","target_","targetCartographic","centerMapCRS","lookAt","eventTC","cesiumWidget","lat","lon","ele","movement3DtoPosition2D","MOUSEMOVE","detectMobile","getHeightFromMDT","geoCoords","cartesian","defaultBaseLayer","triggerEvent","showReprojectDialog","haveToChange","dialogOptions","BasemapSelector","Coordinates","closeCallback","showProjectionChangeDialog","getCRS","confirm","isGeo","factory"],"mappings":"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","sourcesContent":["var TC = TC || {};\r\nTC.view = TC.view || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n(function (namespace, signature, factory) {\r\n    namespace[signature] = factory();\r\n})(TC.view, \"ThreeD\", function () {\r\n\r\n    var viewProto = {\r\n        VIEWNAME: \"ThreeD\",\r\n        CLASS: 'tc-view-threed',\r\n        Consts: {\r\n            BLANK_BASE: 'blank',\r\n            DEFAULT_TILE_SIZE: 256\r\n        },\r\n        classes: {\r\n            MAPTHREED: 'tc-map-threed',\r\n            LOADING: 'tc-loading',\r\n            CAMERACTRARROWDISABLED: 'disabled-arrow',\r\n            FOCUS: 'focus',\r\n            HIGHLIGHTED: 'highlighted',\r\n            DISABLED: 'disabled',\r\n            OUTFOCUS: 'outfocus'\r\n        },\r\n        allowedControls: [],\r\n        template: {},\r\n\r\n        viewer: null,\r\n        mapView: null,\r\n        terrainProvider: null,\r\n\r\n        getLocaleString: function (key, texts) {\r\n            var self = this;\r\n            var locale = self.map ? self.map.options.locale : TC.Cfg.locale;\r\n            return TC.Util.getLocaleString(locale, key, texts);\r\n        },\r\n\r\n        getRenderedHtml: function (templateId, data, callback) {\r\n            return TC.Control.prototype.getRenderedHtml.call(this, templateId, data, callback);\r\n        }\r\n    };\r\n\r\n    if (TC.isDebug) {\r\n        TC.Consts.url.CESIUM = TC.apiLocation + 'lib/cesium/debug/Cesium.js';\r\n    }\r\n\r\n    TC.Consts.classes.THREED = TC.Consts.classes.THREED || \"tc-threed\";\r\n    TC.Consts.classes.THREED_HIDDEN = TC.Consts.classes.THREED_HIDDEN || \"tc-threed-hidden\";\r\n    TC.Consts.event.TERRAINLOADED = TC.Consts.event.TERRAINLOADED || \"terrainloaded.tc.threed\";\r\n    TC.Consts.event.TERRAINRECEIVING = TC.Consts.event.TERRAINRECEIVING || \"terrainreceiving.tc.threed\";\r\n    TC.Consts.event.TERRAIN404 = TC.Consts.event.TERRAIN404 || \"terrain404.tc.threed\";\r\n\r\n    viewProto.template[viewProto.CLASS] = TC.apiLocation + \"TC/templates/ThreeD.html\";\r\n    viewProto.template[viewProto.CLASS + '-overlay'] = TC.apiLocation + \"TC/templates/ThreeDOverlay.html\";\r\n    viewProto.template[viewProto.CLASS + '-cm-ctls'] = TC.apiLocation + \"TC/templates/ThreeDCameraControls.html\";\r\n\r\n    const MapView = function (map, parent) {\r\n        var self = this;\r\n        self.map = map;\r\n        self.parent = parent;\r\n\r\n        Promise.resolve(self.map.getViewHTML()).then(function (html) {\r\n            self.viewHTML = html;\r\n        }.bind(self));\r\n\r\n        self.metersPerUnit = map.getMetersPerUnit();\r\n\r\n        self.maxResolution = null;\r\n\r\n        //flacunza: modificamos TC.Map.setCenter para que se haga desde la vista 3D cuando está activa\r\n        //así evitamos parpadeos en el mapa de situación\r\n        self._oldMapSetCenter = map.setCenter;\r\n        map.setCenter = function (coords, options) {\r\n            if (map.on3DView) {\r\n                map.view3D.flyToMapCoordinates.call(parent, coords);\r\n            }\r\n            else {\r\n                self._oldMapSetCenter.call(map, coords, options);\r\n            }\r\n        };\r\n    };\r\n    MapView.prototype.getCenter = function () {\r\n        return this.map.getCenter();\r\n    };\r\n    MapView.prototype.getExtent = function () {\r\n        return this.map.getExtent();\r\n    };\r\n    MapView.prototype.getResolution = function () {\r\n        return this.map.getResolution();\r\n    };\r\n    MapView.prototype.getRotation = function () {\r\n        return this.map.getRotation();\r\n    };\r\n    MapView.prototype.getMaxResolution = function () {\r\n        if (this.maxResolution)\r\n            return this.maxResolution;\r\n\r\n        if (this.map.getResolutions() !== null)\r\n            this.maxResolution = this.map.getResolutions()[0];\r\n        else {\r\n            var extent = this.map.options.baselayerExtent;\r\n            this.maxResolution = (extent[2] - extent[0]) / this.parent.Consts.DEFAULT_TILE_SIZE;\r\n        }\r\n\r\n        return this.maxResolution;\r\n    };\r\n    MapView.prototype.getPixelFromCoordinate = function (coords) {\r\n        return this.map.getPixelFromCoordinate(coords);\r\n    };\r\n    MapView.prototype.setCenter = function (center) {\r\n        this._oldMapSetCenter.call(this.map, center);\r\n    };\r\n    MapView.prototype.setExtent = function (extent) {\r\n        this.map.setExtent(extent);\r\n    };\r\n    MapView.prototype.setResolution = function (resolution) {\r\n        this.map.setResolution(resolution);\r\n    };\r\n    MapView.prototype.setRotation = function (rotation) {\r\n        this.map.setRotation(rotation);\r\n    };\r\n\r\n\r\n    //  Funciones compatibilidad CRS\r\n    var isCompatible = function (layer, crs) {\r\n        return layer.type === TC.Consts.layerType.WMTS ?\r\n            layer.wrap.getCompatibleMatrixSets(crs).length > 0 :\r\n            layer.isCompatible(crs);\r\n    };\r\n\r\n    // Funciones para cálculo de FOV\r\n    var getFarCoords = function (origin, nearPoint) {\r\n        var radius = 1000000; // 1000 km\r\n        var dx = nearPoint[0] - origin[0];\r\n        var dy = nearPoint[1] - origin[1];\r\n        var angle = Math.atan(dy / dx);\r\n        // Math.atan solo da resultados entre -90º y 90º, si estamos mirando al hemisferio oeste hay que sumar 180º al ángulo\r\n        if (dx < 0) {\r\n            angle = angle + Math.PI;\r\n        }\r\n        return [origin[0] + radius * Math.cos(angle), origin[1] + radius * Math.sin(angle)];\r\n    };\r\n\r\n    var distanceSquared = function (p1, p2) {\r\n        var dx = p2[0] - p1[0];\r\n        var dy = p2[1] - p1[1];\r\n        return dx * dx + dy * dy;\r\n    };\r\n\r\n    var getFarMapCoords = function (obj) {\r\n        // Calculamos puntos lejanos cuando no los tenemos (cuando estamos mirando al horizonte).\r\n        // Cogemos un punto proyectado desde la esquina inferior del canvas, \r\n        // cogemos un segundo punto en el lateral del canvas inmediatamente por encima \r\n        // y prologamos la línea que pasa por ambos puntos proyectados.\r\n        var self = this;\r\n        obj = obj || {};\r\n        if (obj.nearMapCoords) {\r\n            var nextPixel = obj.bottomPixel.clone();\r\n            nextPixel.y = Math.round(nextPixel.y * 9 / 10);\r\n            var nextCoords = pickMapCoords.call(self, nextPixel);\r\n            if (nextCoords) {\r\n                // Ordenamos la dupla por distancia, porque si estamos mirando desde dentro de un monte \r\n                // el punto que se supone que es el más lejano en realidad está más cerca.\r\n                var coordsArray = [obj.nearMapCoords, nextCoords].sort(function (a, b) {\r\n                    return distanceSquared(obj.cameraPosition, a) - distanceSquared(obj.cameraPosition, b);\r\n                });\r\n                return getFarCoords.apply(this, coordsArray);\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    var pickMapCoords = function (pixel) {\r\n        var self = this;\r\n        var pickPoint = pickOnTerrainOrEllipsoid(self.viewer.scene, pixel);\r\n        if (pickPoint) {\r\n            pickPoint = Cesium.Cartographic.fromCartesian(pickPoint);\r\n            if (self.view3D.crs !== self.view3D.view2DCRS) {\r\n                return TC.Util.reproject([Cesium.Math.toDegrees(pickPoint.longitude), Cesium.Math.toDegrees(pickPoint.latitude)], self.view3D.crs, self.view3D.view2DCRS);\r\n            } else {\r\n                return [Cesium.Math.toDegrees(pickPoint.longitude), Cesium.Math.toDegrees(pickPoint.latitude)];\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // Funciones utilidades cámara\r\n    var calcDistanceForResolution = function (resolution, latitude) {\r\n        var self = this;\r\n\r\n        var fovy = self.viewer.camera.frustum.fovy;\r\n        var visibleMapUnits = resolution * self.mapView.viewHTML.getBoundingClientRect().height;\r\n        var relativeCircumference = Math.cos(Math.abs(latitude));\r\n        var visibleMeters = visibleMapUnits * self.mapView.metersPerUnit * relativeCircumference;\r\n\r\n        return (visibleMeters / 2) / Math.tan(fovy / 2);\r\n    };\r\n\r\n    var calcResolutionForDistance = function (distance, latitude) {\r\n        var self = this;\r\n\r\n        var canvas = self.viewer.scene.canvas;\r\n        var fovy = self.viewer.camera.frustum.fovy;\r\n\r\n        var visibleMeters = 2 * distance * Math.tan(fovy / 2);\r\n        var relativeCircumference = Math.cos(Math.abs(latitude));\r\n        var visibleMapUnits = visibleMeters / self.mapView.metersPerUnit / relativeCircumference;\r\n        var resolution = visibleMapUnits / canvas.clientHeight;\r\n\r\n        // validamos que la resolución calculada esté disponible en el array de resoluciones disponibles\r\n        // si no contamos con un array de resoluciones lo calculamos\r\n        var resolutions = self.map.getResolutions();\r\n        if (resolutions === null) {\r\n            resolutions = new Array(22);\r\n            for (var i = 0, ii = resolutions.length; i < ii; ++i) {\r\n                resolutions[i] = self.mapView.getMaxResolution() / Math.pow(2, i);\r\n            }\r\n        }\r\n\r\n        // obtenemos la resolución más próxima a la calculada\r\n        for (var i = 0; i < resolutions.length; i++) {\r\n            if (resolutions[i] < Math.abs(resolution)) {\r\n                resolution = resolutions[i - 1];\r\n                break;\r\n            } else if (resolutions[i] === Math.abs(resolution)) {\r\n                resolution = resolutions[i];\r\n                break;\r\n            } else if (i === resolutions.length - 1) {\r\n                resolution = resolutions[i];\r\n            }\r\n        }\r\n\r\n        return resolution;\r\n    };\r\n\r\n    var rotateAroundAxis = function (camera, angle, axis, transform, opt_options) {\r\n        var clamp = Cesium.Math.clamp;\r\n        var defaultValue = Cesium.defaultValue;\r\n\r\n        var options = opt_options || {};\r\n        var duration = defaultValue(options.duration, 500); // ms\r\n\r\n        var linear = function (a) {\r\n            return a\r\n        };\r\n        var easing = defaultValue(options.easing, linear);\r\n        var callback = options.callback;\r\n\r\n        var start;\r\n        var lastProgress = 0;\r\n        var oldTransform = new Cesium.Matrix4();\r\n\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            function animation(timestamp) {\r\n                if (!start)\r\n                    start = timestamp;\r\n\r\n                var progress = easing(clamp((timestamp - start) / duration, 0, 1));\r\n\r\n                camera.transform.clone(oldTransform);\r\n                var stepAngle = (progress - lastProgress) * angle;\r\n                lastProgress = progress;\r\n\r\n                camera.lookAtTransform(transform);\r\n                camera.rotate(axis, stepAngle);\r\n                camera.lookAtTransform(oldTransform);\r\n\r\n                if (progress < 1) {\r\n                    requestAnimationFrame(animation);\r\n                } else {\r\n                    if (callback) {\r\n                        callback();\r\n                    }\r\n                    resolve();\r\n                }\r\n\r\n            }\r\n\r\n            requestAnimationFrame(animation);\r\n        });\r\n    };\r\n\r\n    var pickOnTerrainOrEllipsoid = function (scene, pixel) {\r\n        var self = this;\r\n\r\n        var ray = scene.camera.getPickRay(pixel);\r\n        var target = scene.globe.pick(ray, scene);\r\n        return target || scene.camera.pickEllipsoid(pixel);\r\n    };\r\n\r\n    var pickCenterPoint = function (scene) {\r\n        var self = this;\r\n\r\n        var canvas = scene.canvas;\r\n        var center = new Cesium.Cartesian2(\r\n            canvas.clientWidth / 2,\r\n            canvas.clientHeight / 2);\r\n        return pickOnTerrainOrEllipsoid(scene, center);\r\n    };\r\n\r\n    var pickBottomPoint = function (scene) {\r\n        var self = this;\r\n\r\n        var canvas = scene.canvas;\r\n        var bottom = new Cesium.Cartesian2(\r\n            canvas.clientWidth / 2, canvas.clientHeight);\r\n        return pickOnTerrainOrEllipsoid(scene, bottom);\r\n    };\r\n\r\n    var bottomFovRay = function (scene) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        var fovy2 = camera.frustum.fovy / 2;\r\n        var direction = camera.direction;\r\n        var rotation = Cesium.Quaternion.fromAxisAngle(camera.right, fovy2);\r\n        var matrix = Cesium.Matrix3.fromQuaternion(rotation);\r\n        var vector = new Cesium.Cartesian3();\r\n        Cesium.Matrix3.multiplyByVector(matrix, direction, vector);\r\n        return new Cesium.Ray(camera.position, vector);\r\n    };\r\n\r\n    var setHeadingUsingBottomCenter = function (scene, heading, bottomCenter, opt_options) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        // Compute the camera position to zenith quaternion\r\n        var angleToZenith = computeAngleToZenith(scene, bottomCenter);\r\n        var axis = camera.right;\r\n        var quaternion = Cesium.Quaternion.fromAxisAngle(axis, angleToZenith);\r\n        var rotation = Cesium.Matrix3.fromQuaternion(quaternion);\r\n\r\n        // Get the zenith point from the rotation of the position vector\r\n        var vector = new Cesium.Cartesian3();\r\n        Cesium.Cartesian3.subtract(camera.position, bottomCenter, vector);\r\n        var zenith = new Cesium.Cartesian3();\r\n        Cesium.Matrix3.multiplyByVector(rotation, vector, zenith);\r\n        Cesium.Cartesian3.add(zenith, bottomCenter, zenith);\r\n\r\n        // Actually rotate around the zenith normal\r\n        var transform = Cesium.Matrix4.fromTranslation(zenith);\r\n        rotateAroundAxis(camera, heading, zenith, transform, opt_options);\r\n    };\r\n\r\n    var signedAngleBetween = function (first, second, normal) {\r\n        var self = this;\r\n\r\n        // We are using the dot for the angle.\r\n        // Then the cross and the dot for the sign.\r\n        var a = new Cesium.Cartesian3();\r\n        var b = new Cesium.Cartesian3();\r\n        var c = new Cesium.Cartesian3();\r\n        Cesium.Cartesian3.normalize(first, a);\r\n        Cesium.Cartesian3.normalize(second, b);\r\n        Cesium.Cartesian3.cross(a, b, c);\r\n\r\n        var cosine = Cesium.Cartesian3.dot(a, b);\r\n        var sine = Cesium.Cartesian3.magnitude(c);\r\n\r\n        // Sign of the vector product and the orientation normal\r\n        var sign = Cesium.Cartesian3.dot(normal, c);\r\n        var angle = Math.atan2(sine, cosine);\r\n        return sign >= 0 ? angle : -angle;\r\n    };\r\n\r\n    var computeAngleToZenith = function (scene, pivot) {\r\n        var self = this;\r\n\r\n        // This angle is the sum of the angles 'fy' and 'a', which are defined\r\n        // using the pivot point and its surface normal.\r\n        //        Zenith |    camera\r\n        //           \\   |   /\r\n        //            \\fy|  /\r\n        //             \\ |a/\r\n        //              \\|/pivot\r\n        var camera = scene.camera;\r\n        var fy = camera.frustum.fovy / 2;\r\n        var ray = bottomFovRay(scene);\r\n        var direction = Cesium.Cartesian3.clone(ray.direction);\r\n        Cesium.Cartesian3.negate(direction, direction);\r\n\r\n        var normal = new Cesium.Cartesian3();\r\n        Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(pivot, normal);\r\n\r\n        var left = new Cesium.Cartesian3();\r\n        Cesium.Cartesian3.negate(camera.right, left);\r\n\r\n        var a = signedAngleBetween(normal, direction, left);\r\n        return a + fy;\r\n    };\r\n\r\n    var computeSignedTiltAngleOnGlobe = function (scene) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        var ray = new Cesium.Ray(camera.position, camera.direction);\r\n        var target = scene.globe.pick(ray, scene);\r\n\r\n        if (!target) {\r\n            // no tiles in the area were loaded?\r\n            var ellipsoid = Cesium.Ellipsoid.WGS84;\r\n            var obj = Cesium.IntersectionTests.rayEllipsoid(ray, ellipsoid);\r\n            if (obj) {\r\n                target = Cesium.Ray.getPoint(ray, obj.start);\r\n            }\r\n        }\r\n\r\n        if (!target) {\r\n            return undefined;\r\n        }\r\n\r\n        var normal = new Cesium.Cartesian3();\r\n        Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(target, normal);\r\n\r\n        var angleBetween = signedAngleBetween;\r\n        var angle = angleBetween(camera.direction, normal, camera.right) - Math.PI;\r\n        return Cesium.Math.convertLongitudeRange(angle);\r\n    };\r\n\r\n    // Funciones CZML    \r\n    var toCZML = function (coordinates, layout, name, pointStyle, lineStyle, walkingSpeed) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            var positions = coordinates.map(function (coordinate) {\r\n                var reprojected = coordinate;\r\n                if (self.view3D.view2DCRS !== self.view3D.crs) {\r\n                    reprojected = TC.Util.reproject(coordinate, self.view3D.view2DCRS, self.view3D.crs);\r\n                }\r\n                return Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n            });\r\n\r\n            Cesium.when(self.viewer.terrainProvider.sampleTerrainMostDetailed(positions), function (updatedPositions) {\r\n                var startTime, stopTime, totalDistance = 0;\r\n\r\n                if (layout === ol.geom.GeometryLayout.XYZM) {\r\n                    startTime = coordinates[0][3];\r\n                    stopTime = coordinates[coordinates.length - 1][3];\r\n                } else if (layout === ol.geom.GeometryLayout.XYM) {\r\n                    startTime = coordinates[0][2];\r\n                    stopTime = coordinates[coordinates.length - 1][2];\r\n                } else {\r\n\r\n                    coordinates[0][3] = updatedPositions[0].time = Date.now();\r\n\r\n                    for (var i = 1; i < updatedPositions.length; i++) {\r\n                        var done;\r\n                        var previuos_next = [];\r\n\r\n                        updatedPositions[i].time = 0;\r\n\r\n                        if (i + 1 < updatedPositions.length) {\r\n                            previuos_next = updatedPositions.slice(i - 1, i + 1);\r\n                        } else {\r\n                            previuos_next = updatedPositions.slice(i - 1);\r\n                        }\r\n\r\n                        done = new Cesium.EllipsoidGeodesic(previuos_next[0], previuos_next[1]).surfaceDistance;\r\n\r\n                        totalDistance += done;\r\n\r\n                        coordinates[i][3] = updatedPositions[i].time = updatedPositions[i - 1].time + (3600000 * done / walkingSpeed);\r\n                    }\r\n\r\n                    startTime = updatedPositions[0].time;\r\n                    stopTime = updatedPositions[updatedPositions.length - 1].time;\r\n                }\r\n\r\n                if (totalDistance === 0) {\r\n                    for (var i = 1; i < updatedPositions.length; i++) {\r\n                        var previuos_next = [];\r\n\r\n                        if (i + 1 < updatedPositions.length) {\r\n                            previuos_next = updatedPositions.slice(i - 1, i + 1);\r\n                        } else {\r\n                            previuos_next = updatedPositions.slice(i - 1);\r\n                        }\r\n\r\n                        totalDistance += new Cesium.EllipsoidGeodesic(previuos_next[0], previuos_next[1]).surfaceDistance;\r\n                    }\r\n                }\r\n\r\n                startTime = new Date(startTime).toISOString();\r\n                stopTime = new Date(stopTime).toISOString();\r\n\r\n                var czml = [{\r\n                    \"id\": \"document\",\r\n                    \"name\": \"CZML Model\",\r\n                    \"version\": \"1.0\"\r\n                }, {\r\n                    \"id\": \"path\",\r\n                    \"name\": name,\r\n                    \"availability\": startTime + \"/\" + stopTime,\r\n                    \"position\": {\r\n                        \"epoch\": startTime,\r\n                        \"cartographicRadians\": updatedPositions.map(function (updatedPosition, i) {\r\n                            return layout === ol.geom.GeometryLayout.XYZM ? [new Date(coordinates[i][3]).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height] :\r\n                                layout === ol.geom.GeometryLayout.XYM ? [new Date(coordinates[i][2]).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height] :\r\n                                    [new Date(updatedPosition.time).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height];\r\n                        }).reduce(function (prev, curr) {\r\n                            return prev.concat(curr);\r\n                        })\r\n                    },\r\n                    \"point\": {\r\n                        \"heightReference\": \"CLAMP_TO_GROUND\",\r\n                        \"pixelSize\": pointStyle.radius,\r\n                        \"color\": {\r\n                            \"rgba\": pointStyle.fillColor\r\n                        },\r\n                        \"outlineColor\": {\r\n                            \"rgba\": pointStyle.strokeColor\r\n                        },\r\n                        \"outlineWidth\": pointStyle.strokeWidth\r\n                    }\r\n                }];\r\n\r\n                resolve({ czml: czml, totalDistance: totalDistance, coordinates2D: coordinates });\r\n            });\r\n        });\r\n    };\r\n\r\n    const CameraControls = function (parent) {\r\n        var self = this;\r\n\r\n        self.parent = parent;\r\n\r\n        var outHandler = function (e) {\r\n            var self = this;\r\n\r\n            self.isFocusingCameraCtrls = false;\r\n        };\r\n        var inHandler = function () {\r\n            var self = this;\r\n\r\n            self.isFocusingCameraCtrls = true;\r\n            self.lastFocused = performance.now();\r\n\r\n            if (self.div.classList.contains(self.parent.classes.OUTFOCUS)) {\r\n                self.div.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.tiltIndicatorOuterCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.tiltIndicatorOuterShellCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.rotateIndicatorOuterCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.rotateIndicatorOuterShellCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n            }\r\n        };\r\n\r\n        var moveStartHandler = function () {\r\n            var self = this;\r\n            self.moving = true;\r\n        };\r\n        var moveEndHandler = function () {\r\n            var self = this;\r\n            self.moving = false;\r\n        };\r\n        var postRenderHandler = function () {\r\n            var self = this;\r\n            var view = self.parent;\r\n\r\n            if (self.parent.view3D.isLoadingTiles.call(self.parent))\r\n                self.customCollisionDetection();\r\n\r\n            var camera = self.getCamera();\r\n            var position = camera.positionCartographic;\r\n\r\n            if (self.moving) {\r\n\r\n                cssRotate(self.tiltIndicator, camera.pitch);\r\n                cssRotate(self.rotateIndicator, -camera.heading);\r\n\r\n                self.disableRotate();\r\n                self.disableTilt(5);\r\n\r\n                if (view.view3D.crs !== view.view3D.view2DCRS) {\r\n                    self._coordsXY = TC.Util.reproject([Cesium.Math.toDegrees(position.longitude), Cesium.Math.toDegrees(position.latitude)], view.view3D.crs, view.view3D.view2DCRS);\r\n                } else {\r\n                    self._coordsXY = [Cesium.Math.toDegrees(position.longitude), Cesium.Math.toDegrees(position.latitude)];\r\n                }\r\n\r\n                view.mapView.setCenter(self._coordsXY);\r\n                view.mapView.setResolution(calcResolutionForDistance.call(view, position.height, position.latitude));\r\n\r\n                //view.mapView.setRotation(-camera.heading);\r\n            }\r\n\r\n            // flacunza: calculamos el polígono de FOV para dibujar en el mapa de situación\r\n            // Lo calculamos aunque no nos estemos moviendo porque el terreno puede estar cargándose\r\n            if (self._coordsXY) {\r\n                view._ovMap = view._ovMap || view.map.getControlsByClass('TC.control.OverviewMap')[0];\r\n                if (view._ovMap) {\r\n                    view._ovMap.renderPromise().then(function () {\r\n                        var scene = view.viewer.scene;\r\n                        var canvas = scene.canvas;\r\n                        var bottomLeft = new Cesium.Cartesian2(0, canvas.clientHeight - 1);\r\n                        var bottomRight = new Cesium.Cartesian2(canvas.clientWidth - 1, canvas.clientHeight - 1);\r\n                        var fovCoords = [\r\n                            bottomLeft,\r\n                            bottomRight,\r\n                            new Cesium.Cartesian2(canvas.clientWidth - 1, 0),\r\n                            new Cesium.Cartesian2(0, 0)\r\n                        ].map(function (elm) {\r\n                            return pickMapCoords.call(view, elm);\r\n                        }).filter(function (elm) {\r\n                            return elm !== null;\r\n                        });\r\n                        if (fovCoords.length && fovCoords.length < 4) { // Vemos horizonte\r\n                            // flacunza: Si vemos horizonte no tenemos puntos de terreno para las esquinas superiores, \r\n                            // por eso intentamos calcular unos puntos \"en el infinito\".\r\n                            var farCoordsLeft = getFarMapCoords.call(view, {\r\n                                nearMapCoords: fovCoords[0],\r\n                                bottomPixel: bottomLeft,\r\n                                cameraPosition: self._coordsXY\r\n                            });\r\n                            var farCoordsRight = getFarMapCoords.call(view, {\r\n                                nearMapCoords: fovCoords[1],\r\n                                bottomPixel: bottomRight,\r\n                                cameraPosition: self._coordsXY\r\n                            });\r\n                            if (farCoordsLeft && farCoordsRight) {\r\n                                fovCoords[2] = farCoordsRight;\r\n                                fovCoords[3] = farCoordsLeft;\r\n                            }\r\n\r\n                        }\r\n                        view._ovMap.wrap.draw3DCamera({ position: self._coordsXY, heading: camera.heading, fov: fovCoords });\r\n                    });\r\n                }\r\n            }\r\n\r\n        };\r\n        var cssRotate = function (element, angle) {\r\n            var coord = element.getBBox();\r\n            value = 'rotate(' + Cesium.Math.toDegrees(angle) + ' ' + (coord.x + (coord.width / 2)) + ' ' + (coord.y + (coord.height / 2)) + ')';\r\n            document.getElementsByClassName(element.className.baseVal)[0].setAttribute('transform', value);\r\n        };\r\n\r\n        self.outControlsEvents = TC.Util.detectMouse() ? ['mouseleave'] : ['touchleave', 'touchend'];\r\n        self.outControls = outHandler.bind(self);\r\n\r\n        self.inControlsEvents = TC.Util.detectMouse() ? ['mouseenter'] : ['touchmove', 'touchstart'];\r\n        self.inControls = inHandler.bind(self);\r\n\r\n        self.moveStart = moveStartHandler.bind(self);\r\n        self.moveEnd = moveEndHandler.bind(self);\r\n        self.postRender = postRenderHandler.bind(self);\r\n\r\n        self.selectors = {\r\n            tilt: '-cm-tilt',\r\n            rotate: '-cm-rotate',\r\n            indicator: '-indicator',\r\n            leftArrow: '-left',\r\n            rightArrow: '-right',\r\n            downArrow: '-down',\r\n            upArrow: '-up'\r\n        };\r\n\r\n        self.MIN_TILT = Cesium.Math.toRadians(-89);\r\n        self.MAX_TILT = Cesium.Math.toRadians(-1);\r\n\r\n        self.render();\r\n    };\r\n    CameraControls.prototype.bind = function () {\r\n        var self = this;\r\n\r\n        // conexión de los controles con el visor de cesium\r\n        self.getCamera().moveStart.addEventListener(self.moveStart);\r\n        self.getCamera().moveEnd.addEventListener(self.moveEnd);\r\n        self.parent.viewer.scene.postRender.addEventListener(self.postRender);\r\n\r\n        // gestionamos la opacidad de los controles pasados 5 segundos\r\n        self.outControlsEvents.forEach(function (event) {\r\n            self.div.addEventListener(event, self.outControls);\r\n        });\r\n        self.inControlsEvents.forEach(function (event) {\r\n            self.div.addEventListener(event, self.inControls);\r\n        });\r\n\r\n        function setOpacity() {\r\n            if (!self.lastFocused)\r\n                self.lastFocused = performance.now();\r\n\r\n            var progress = performance.now() - self.lastFocused;\r\n            if (progress > 5000 && self.isFocusingCameraCtrls !== true) {\r\n                if (!self.div.classList.contains(self.parent.classes.OUTFOCUS)) {\r\n                    self.div.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.tiltIndicatorOuterCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.tiltIndicatorOuterShellCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.rotateIndicatorOuterCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.rotateIndicatorOuterShellCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                }\r\n            }\r\n\r\n            self.rAFInOutControls = requestAnimationFrame(setOpacity);\r\n        }\r\n        self.rAFInOutControls = requestAnimationFrame(setOpacity);\r\n    };\r\n    CameraControls.prototype.unbind = function () {\r\n        var self = this;\r\n\r\n        self.div.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n        // conexión de los controles con el visor de cesium\r\n        self.getCamera().moveStart.removeEventListener(self.moveStart);\r\n        self.getCamera().moveEnd.removeEventListener(self.moveEnd);\r\n        self.parent.viewer.scene.postRender.removeEventListener(self.postRender);\r\n\r\n        // gestionamos la opacidad de los controles pasados 5 segundos\r\n        self.outControlsEvents.forEach(function (event) {\r\n            self.div.removeEventListener(event, self.outControls);\r\n        });\r\n        self.inControlsEvents.forEach(function (event) {\r\n            self.div.removeEventListener(event, self.inControls);\r\n        });\r\n        window.cancelAnimationFrame(self.rAFInOutControls);\r\n        self.lastFocused = undefined;\r\n        self.rAFInOutControls = undefined;\r\n    };\r\n    CameraControls.prototype.getCamera = function () {\r\n        var self = this;\r\n\r\n        return self.parent.viewer.scene.camera;\r\n    };\r\n    CameraControls.prototype.getCameraState = function () {\r\n        var self = this;\r\n\r\n        if (self.parent.viewer) {\r\n            var camera = self.parent.viewer.scene.camera;\r\n            var cameraPosition = camera.positionCartographic;\r\n\r\n            var bottomCenter = pickBottomPoint(self.parent.viewer.scene);\r\n            if (bottomCenter) {\r\n                var distance = Cesium.Cartesian3.distance(camera.position, bottomCenter);\r\n\r\n                return {\r\n                    cp: [cameraPosition.longitude, cameraPosition.latitude, cameraPosition.height],\r\n                    chpr: [camera.heading, camera.pitch, camera.roll],\r\n                    bcpd: distance\r\n                };\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.render = function () {\r\n        var self = this;\r\n\r\n        if (self.div) {\r\n            self.div.classList.remove(TC.Consts.classes.HIDDEN);\r\n            self.bind();\r\n        }\r\n        else {\r\n            self.parent.getRenderedHtml(self.parent.CLASS + '-cm-ctls', {}, function (html) {\r\n                // contenedor controles\r\n                self.div = document.createElement('div');\r\n                self.div.classList.add(self.parent.CLASS + '-cm-ctls');\r\n                self.div.innerHTML = html;\r\n                self.parent.map.div.appendChild(self.div);\r\n\r\n\r\n                // tilt\r\n                var tiltSelector = '.' + self.parent.CLASS + self.selectors.tilt;\r\n\r\n                self.tiltIndicatorInner = self.div.querySelector(\"[class^=\" + tiltSelector.replace('.', '') + \"-inner\" + \"]\");\r\n                self.tiltIndicatorInner.addEventListener(TC.Consts.event.CLICK, self.resetTilt.bind(self));\r\n\r\n                self.tiltIndicator = self.div.querySelector(tiltSelector + '-indicator');\r\n\r\n                self.tiltIndicatorOuterCircle = self.div.querySelector(tiltSelector + '-outer-circle');\r\n                self.tiltIndicatorOuterShellCircle = self.div.querySelector(tiltSelector + '-outer-shell-circle');\r\n\r\n                self.tiltIndicatorCircle = self.div.querySelector(\"[class^=\" + tiltSelector.replace('.', '') + \"-outer\" + \"]\");\r\n                self.tiltIndicatorCircle.addEventListener('mousedown', function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var vectorScratch = new Cesium.Cartesian2();\r\n                    var element = e.currentTarget;\r\n                    var rectangle = e.currentTarget.getBoundingClientRect();\r\n                    var center = new Cesium.Cartesian2((rectangle.right - rectangle.left) / 2.0, (rectangle.bottom - rectangle.top) / 2.0);\r\n                    var clickLocation = new Cesium.Cartesian2(e.clientX - rectangle.left, e.clientY - rectangle.top);\r\n                    var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n                    self.draggingTilt.call(self, element, vector);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // left\r\n                self.tiltUp = self.div.querySelector(tiltSelector + self.selectors.upArrow);\r\n                self.tiltUp.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.target.disabled) {\r\n                        if (e.stopPropagation) e.stopPropagation();\r\n                        if (e.preventDefault) e.preventDefault();\r\n\r\n                        e.cancelBubble = true;\r\n                        e.returnValue = false;\r\n                        return false;\r\n                    }\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n                    self.tiltUpMouseUpFunction = undefined;\r\n\r\n                    self.tilt.call(self, +5);\r\n\r\n                    self.tiltUpInterval = setInterval(function () {\r\n                        if (!self.isTiltUpDisabled) self.tilt.call(self, +5);\r\n                        else self.tiltUpMouseUpFunction();\r\n                    }.bind(self), 101);\r\n\r\n                    self.tiltUpMouseUpFunction = function () {\r\n                        clearInterval(self.tiltUpInterval);\r\n                        self.tiltUpInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n                        self.tiltUpMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // right\r\n                self.tiltDown = self.div.querySelector(tiltSelector + self.selectors.downArrow);\r\n                self.tiltDown.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n\r\n                    if (e.target.disabled) {\r\n                        if (e.stopPropagation) e.stopPropagation();\r\n                        if (e.preventDefault) e.preventDefault();\r\n\r\n                        e.cancelBubble = true;\r\n                        e.returnValue = false;\r\n                        return false;\r\n                    }\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n                    self.tiltDownMouseUpFunction = undefined;\r\n\r\n                    self.tilt.call(self, -5);\r\n\r\n                    self.tiltDownInterval = setInterval(function () {\r\n                        if (!self.isTiltDownDisabled) self.tilt.call(self, -5);\r\n                        else self.tiltDownMouseUpFunction();\r\n                    }.bind(self), 101);\r\n\r\n                    self.tiltDownMouseUpFunction = function () {\r\n                        clearInterval(self.tiltDownInterval);\r\n                        self.tiltDownInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n                        self.tiltDownMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // rotation\r\n                var rotateSelector = '.' + self.parent.CLASS + self.selectors.rotate;\r\n\r\n                self.rotateIndicatorInner = self.div.querySelector(\"[class^=\" + rotateSelector.replace('.', '') + \"-inner\" + \"]\");\r\n                self.rotateIndicatorInner.addEventListener(TC.Consts.event.CLICK, self.resetRotation.bind(self));\r\n\r\n                self.rotateIndicator = self.div.querySelector(rotateSelector + '-indicator');\r\n\r\n                self.rotateIndicatorOuterCircle = self.div.querySelector(rotateSelector + '-outer-circle');\r\n                self.rotateIndicatorOuterShellCircle = self.div.querySelector(rotateSelector + '-outer-shell-circle');\r\n\r\n                self.rotateIndicatorCircle = self.div.querySelector(\"[class^=\" + rotateSelector.replace('.', '') + \"-outer\" + \"]\");\r\n                self.rotateIndicatorCircle.addEventListener('mousedown', function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var vectorScratch = new Cesium.Cartesian2();\r\n                    var element = e.currentTarget;\r\n                    var rectangle = e.currentTarget.getBoundingClientRect();\r\n                    var center = new Cesium.Cartesian2((rectangle.right - rectangle.left) / 2.0, (rectangle.bottom - rectangle.top) / 2.0);\r\n                    var clickLocation = new Cesium.Cartesian2(e.clientX - rectangle.left, e.clientY - rectangle.top);\r\n                    var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n                    self.draggingRotate.call(self, element, vector);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // left\r\n                self.rotateLeft = self.div.querySelector(rotateSelector + self.selectors.leftArrow);\r\n                self.rotateLeft.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n                    self.rotateLeftMouseUpFunction = undefined;\r\n\r\n                    self.rotate.call(self, -15);\r\n\r\n                    self.rotateLeftInterval = setInterval(function () {\r\n                        self.rotate.call(self, -15);\r\n                    }.bind(self), 101);\r\n\r\n                    self.rotateLeftMouseUpFunction = function () {\r\n                        clearInterval(self.rotateLeftInterval);\r\n                        self.rotateLeftInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n                        self.rotateLeftMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n\r\n                }.bind(self));\r\n\r\n                self.rotateRight = self.div.querySelector(rotateSelector + self.selectors.rightArrow);\r\n                self.rotateRight.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n                    self.rotateRightMouseUpFunction = undefined;\r\n\r\n                    self.rotate.call(self, +15);\r\n\r\n                    self.rotateRightInterval = setInterval(function () {\r\n                        self.rotate.call(self, +15);\r\n                    }.bind(self), 101);\r\n\r\n                    self.rotateRightMouseUpFunction = function () {\r\n                        clearInterval(self.rotateRightInterval);\r\n                        self.rotateRightInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n                        self.rotateRightMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n\r\n                }.bind(self));\r\n\r\n                self.bind();\r\n\r\n            }.bind(this));\r\n        }\r\n    };\r\n    CameraControls.prototype.disableTilt = function (angle) {\r\n        var self = this;\r\n\r\n        var theta = Cesium.Math.toRadians(angle);\r\n        var tilt = self.getCamera().pitch;\r\n\r\n        self.isTiltDownDisabled = (tilt + -theta) < self.MIN_TILT;\r\n        self.isTiltUpDisabled = (tilt + theta) > self.MAX_TILT;\r\n\r\n        // left\r\n        self.tiltUp.disabled = self.isTiltUpDisabled;\r\n        self.tiltUp.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, self.isTiltUpDisabled);\r\n\r\n\r\n        // right\r\n        self.tiltDown.disabled = self.isTiltDownDisabled;\r\n        self.tiltDown.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, self.isTiltDownDisabled);\r\n    };\r\n    CameraControls.prototype.disableRotate = function () {\r\n        var self = this;\r\n\r\n        var isDisable = true;\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var canvas = scene.canvas;\r\n        var bottomLeft = new Cesium.Cartesian2(0, canvas.clientHeight - 1);\r\n        var bottomRight = new Cesium.Cartesian2(canvas.clientWidth - 1, canvas.clientHeight - 1);\r\n        var fovCoords = [bottomLeft, bottomRight, new Cesium.Cartesian2(canvas.clientWidth - 1, 0), new Cesium.Cartesian2(0, 0)]\r\n            .map(function (elm) {\r\n                return pickMapCoords.call(this, elm);\r\n            }.bind(self.parent))\r\n            .filter(function (elm) {\r\n                return elm !== null;\r\n            });\r\n\r\n        if (fovCoords.length && fovCoords.length >= 2) {\r\n            isDisable = false;\r\n        }\r\n\r\n        // reset\r\n        self.rotateIndicatorInner.disabled = isDisable;\r\n\r\n        // left\r\n        self.rotateLeft.disabled = isDisable;\r\n        self.rotateLeft.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, isDisable);\r\n\r\n        // right\r\n        self.rotateRight.disabled = isDisable;\r\n        self.rotateRight.classList.toggle(self.parent.classes.CAMERACTRARROWDISABLED, isDisable);\r\n\r\n        return isDisable;\r\n    };\r\n    CameraControls.prototype.tilt = function (angle) {\r\n        var self = this;\r\n\r\n        self.disableTilt(angle);\r\n\r\n        if (this.parent.viewer && this.parent.viewer.trackedEntity) {\r\n            self.getCamera().rotateUp(Cesium.Math.toRadians(angle));\r\n        } else {\r\n            if (pickCenterPoint(self.parent.viewer.scene) == undefined) {\r\n                if (angle > 0) self.getCamera().lookUp();\r\n                else self.getCamera().lookDown();\r\n            }\r\n\r\n            if ((angle >= Cesium.Math.PI_OVER_TWO && self.isTiltUpDisabled) ||\r\n                (angle <= -Cesium.Math.PI_OVER_TWO && self.isTiltDownDisabled)) {\r\n                return;\r\n            }\r\n\r\n            var _angle = Cesium.Math.toRadians(angle);\r\n            var pivot = pickCenterPoint(self.parent.viewer.scene);\r\n            if (pivot) {\r\n                var transform = Cesium.Matrix4.fromTranslation(pivot);\r\n                self.parent.view3D.rotateAroundAxis(self.getCamera(), -_angle, self.getCamera().right, transform, { duration: 100 });\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.rotate = function (angle) {\r\n        var self = this;\r\n\r\n        angle = Cesium.Math.toRadians(angle);\r\n\r\n        if (this.parent.viewer && this.parent.viewer.trackedEntity) {\r\n            self.getCamera().rotateRight(-angle);\r\n        } else {\r\n            var bottom = pickBottomPoint(self.parent.viewer.scene);\r\n            if (bottom) {\r\n                setHeadingUsingBottomCenter(self.parent.viewer.scene, angle, bottom, {\r\n                    duration: 100\r\n                });\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.draggingTilt = function (tiltElement, cursorVector) {\r\n        var self = this;\r\n\r\n        self.tiltIndicatorOuterCircle.classList.add(self.parent.classes.HIGHLIGHTED);\r\n\r\n        var oldTransformScratch = new Cesium.Matrix4();\r\n        var newTransformScratch = new Cesium.Matrix4();\r\n        var vectorScratch = new Cesium.Cartesian2();\r\n\r\n        document.removeEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n        document.removeEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n\r\n        self.tiltMouseMoveFunction = undefined;\r\n        self.tiltMouseUpFunction = undefined;\r\n\r\n        self.isTilting = true;\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = scene.camera;\r\n\r\n        var pivot = pickCenterPoint(scene);\r\n        if (!pivot) {\r\n            self.tiltFrame = Cesium.Transforms.northUpEastToFixedFrame(camera.positionWC, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.tiltIsLook = true;\r\n        } else {\r\n            self.tiltFrame = Cesium.Transforms.northUpEastToFixedFrame(pivot, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.tiltIsLook = false;\r\n        }\r\n\r\n        self.startCursorAngle = Math.atan2(-cursorVector.y, cursorVector.x);\r\n\r\n        var oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n        camera.lookAtTransform(self.tiltFrame);\r\n\r\n        self.initialCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n\r\n        camera.lookAtTransform(oldTransform);\r\n\r\n        self.tiltMouseMoveFunction = function (e) {\r\n            var self = this;\r\n\r\n            scene = self.parent.viewer.scene;\r\n            camera = scene.camera;\r\n\r\n            var tiltRectangle = tiltElement.getBoundingClientRect();\r\n            center = new Cesium.Cartesian2((tiltRectangle.right - tiltRectangle.left) / 2.0, (tiltRectangle.bottom - tiltRectangle.top) / 2.0);\r\n            var clickLocation = new Cesium.Cartesian2(e.clientX - tiltRectangle.left, e.clientY - tiltRectangle.top);\r\n            var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n            console.log('Entra: ' + vector.toString());\r\n\r\n            var angle = Math.atan2(-vector.y, vector.x);\r\n            var angleDifference = angle - self.startCursorAngle;\r\n            var newCameraAngle = Cesium.Math.zeroToTwoPi(self.initialCameraAngle - angleDifference);\r\n\r\n            try {\r\n                oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n                camera.lookAtTransform(self.tiltFrame);\r\n                var currentCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n                var theta = newCameraAngle - currentCameraAngle;\r\n\r\n                var tilt = camera.pitch;\r\n                tilt += theta;\r\n\r\n                if (tilt < self.MIN_TILT) {\r\n                    camera.rotate(camera.right, camera.pitch - self.MIN_TILT);\r\n                } else if (tilt > self.MAX_TILT) {\r\n                    camera.rotate(camera.right, camera.pitch - self.MAX_TILT);\r\n                } else {\r\n                    camera.rotate(camera.right, -theta);\r\n                }\r\n\r\n                self.disableTilt(5);\r\n                camera.lookAtTransform(oldTransform);\r\n\r\n            } catch (e) {\r\n                self.tiltMouseUpFunction();\r\n            }\r\n\r\n\r\n        }.bind(self);\r\n\r\n        self.tiltMouseUpFunction = function (e) {\r\n            self.tiltIndicatorOuterCircle.classList.remove(self.parent.classes.HIGHLIGHTED);\r\n\r\n            self.isTilting = false;\r\n            document.removeEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n            document.removeEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n\r\n            self.tiltMouseMoveFunction = undefined;\r\n            self.tiltMouseUpFunction = undefined;\r\n        };\r\n\r\n        document.addEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n        document.addEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n    };\r\n    CameraControls.prototype.draggingRotate = function (rotateElement, cursorVector) {\r\n        var self = this;\r\n\r\n        document.removeEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n        document.removeEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n\r\n        self.rotateMouseMoveFunction = undefined;\r\n        self.rotateMouseUpFunction = undefined;\r\n\r\n        self.rotateMouseMoveFunction = function (e) {\r\n            var rotateRectangle = rotateElement.getBoundingClientRect();\r\n            var center = new Cesium.Cartesian2((rotateRectangle.right - rotateRectangle.left) / 2.0, (rotateRectangle.bottom - rotateRectangle.top) / 2.0);\r\n            var clickLocation = new Cesium.Cartesian2(e.clientX - rotateRectangle.left, e.clientY - rotateRectangle.top);\r\n            var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n            var angle = Math.atan2(-vector.y, vector.x);\r\n\r\n            var angleDifference = angle - self.rotateInitialCursorAngle;\r\n            var newCameraAngle = Cesium.Math.zeroToTwoPi(self.rotateInitialCameraAngle - angleDifference);\r\n\r\n            camera = self.parent.viewer.scene.camera;\r\n\r\n            try {\r\n                oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n                camera.lookAtTransform(self.rotateFrame);\r\n                var currentCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n                camera.rotateRight(newCameraAngle - currentCameraAngle);\r\n                camera.lookAtTransform(oldTransform);\r\n            } catch (e) {\r\n                self.rotateMouseUpFunction();\r\n            }\r\n        };\r\n\r\n        self.rotateMouseUpFunction = function (e) {\r\n            self.isRotating = false;\r\n\r\n            self.rotateIndicatorOuterCircle.classList.remove(self.parent.classes.HIGHLIGHTED);\r\n\r\n            document.removeEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n            document.removeEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n\r\n            self.rotateMouseMoveFunction = undefined;\r\n            self.rotateMouseUpFunction = undefined;\r\n        };\r\n\r\n        if (self.disableRotate()) {\r\n            self.rotateMouseUpFunction();\r\n            return;\r\n        }\r\n\r\n        self.rotateIndicatorOuterCircle.classList.add(self.parent.classes.HIGHLIGHTED);\r\n\r\n        var oldTransformScratch = new Cesium.Matrix4();\r\n        var newTransformScratch = new Cesium.Matrix4();\r\n        var vectorScratch = new Cesium.Cartesian2();\r\n\r\n        self.isRotating = true;\r\n        self.rotateInitialCursorAngle = Math.atan2(-cursorVector.y, cursorVector.x);\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = scene.camera;\r\n\r\n        var viewCenter = pickCenterPoint(self.parent.viewer.scene);\r\n        if (viewCenter == null || viewCenter == undefined) {\r\n            viewCenter = pickBottomPoint(self.parent.viewer.scene);\r\n            if (viewCenter == null || viewCenter == undefined) {\r\n                self.rotateFrame = Cesium.Transforms.eastNorthUpToFixedFrame(camera.positionWC, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n                self.rotateIsLook = true;\r\n            } else {\r\n                self.rotateFrame = Cesium.Transforms.eastNorthUpToFixedFrame(viewCenter, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n                self.rotateIsLook = false;\r\n            }\r\n        } else {\r\n            self.rotateFrame = Cesium.Transforms.eastNorthUpToFixedFrame(viewCenter, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.rotateIsLook = false;\r\n        }\r\n\r\n        try {\r\n            var oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n            camera.lookAtTransform(self.rotateFrame);\r\n            self.rotateInitialCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n            self.rotateInitialCameraDistance = Cesium.Cartesian3.magnitude(new Cesium.Cartesian3(camera.position.x, camera.position.y, 0.0));\r\n            camera.lookAtTransform(oldTransform);\r\n        } catch (e) {\r\n            self.rotateMouseUpFunction();\r\n        }\r\n\r\n        document.addEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n        document.addEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n    };\r\n    CameraControls.prototype.resetTilt = function () {\r\n        var self = this;\r\n        // lo dejamos como al principio a 50 grados\r\n        var angle = -self.getCamera().pitch - Cesium.Math.toRadians(50);\r\n        self.tilt(Cesium.Math.toDegrees(angle));\r\n    };\r\n    CameraControls.prototype.resetRotation = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var currentRotation;\r\n            currentRotation = -self.getCamera().heading;\r\n\r\n            while (currentRotation < -Math.PI) {\r\n                currentRotation += 2 * Math.PI;\r\n            }\r\n            while (currentRotation > Math.PI) {\r\n                currentRotation -= 2 * Math.PI;\r\n            }\r\n\r\n            if (!options)\r\n                resolve();\r\n            else {\r\n                options.callback = function () {\r\n                    resolve();\r\n                };\r\n            }\r\n\r\n            if (this.parent.viewer && this.parent.viewer.trackedEntity) {\r\n                var camera = self.getCamera();\r\n                camera.rotate(Cesium.Cartesian3.fromDegrees(0, 90), currentRotation);\r\n            } else {\r\n                var bottom = pickBottomPoint(self.parent.viewer.scene);\r\n                if (bottom) {\r\n                    setHeadingUsingBottomCenter(self.parent.viewer.scene, currentRotation, bottom, options);\r\n                }\r\n            }\r\n        });\r\n    };\r\n    CameraControls.prototype.customCollisionDetection = function () {\r\n        var self = this;\r\n\r\n        var scratchAdjustHeightTransform = new Cesium.Matrix4();\r\n        var scratchAdjustHeightCartographic = new Cesium.Cartographic();\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = self.parent.viewer.scene.camera;\r\n\r\n        var screenSpaceCameraController = scene.screenSpaceCameraController;\r\n        var enableCollisionDetection = screenSpaceCameraController.enableCollisionDetection;\r\n        var minimumCollisionTerrainHeight = screenSpaceCameraController.minimumCollisionTerrainHeight;\r\n        var minimumZoomDistance = screenSpaceCameraController.minimumZoomDistance;\r\n        var globe = scene.globe;\r\n\r\n        var ellipsoid = globe.ellipsoid;\r\n        var projection = scene.mapProjection;\r\n\r\n        var transform;\r\n        var mag;\r\n        if (!Cesium.Matrix4.equals(camera.transform, Cesium.Matrix4.IDENTITY)) {\r\n            transform = Cesium.Matrix4.clone(camera.transform, scratchAdjustHeightTransform);\r\n            mag = Cesium.Cartesian3.magnitude(camera.position);\r\n            camera._setTransform(Cesium.Matrix4.IDENTITY);\r\n        }\r\n\r\n        var cartographic = scratchAdjustHeightCartographic;\r\n        ellipsoid.cartesianToCartographic(camera.position, cartographic);\r\n\r\n        var heightUpdated = false;\r\n        if (cartographic.height < minimumCollisionTerrainHeight) {\r\n            var height = globe.getHeight(cartographic);\r\n            if (height !== undefined && height !== null) {\r\n                height += minimumZoomDistance;\r\n                if (cartographic.height < height) {\r\n                    cartographic.height = height;\r\n                    ellipsoid.cartographicToCartesian(cartographic, camera.position);\r\n                    heightUpdated = true;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (transform !== undefined && transform !== null) {\r\n            camera._setTransform(transform);\r\n            if (heightUpdated) {\r\n                Cesium.Cartesian3.normalize(camera.position, camera.position);\r\n                Cesium.Cartesian3.negate(camera.position, camera.direction);\r\n                Cesium.Cartesian3.multiplyByScalar(camera.position, Math.max(mag, minimumZoomDistance), camera.position);\r\n                Cesium.Cartesian3.normalize(camera.direction, camera.direction);\r\n                Cesium.Cartesian3.cross(camera.direction, camera.up, camera.right);\r\n                Cesium.Cartesian3.cross(camera.right, camera.direction, camera.up);\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.limitCameraToInitExtent = function () {\r\n        var self = this;\r\n\r\n        var pos = self.viewer.camera.positionCartographic.clone();\r\n\r\n        if (!(pos.longitude >= self.initExtent.west &&\r\n            pos.longitude <= self.initExtent.east &&\r\n            pos.latitude >= self.initExtent.south &&\r\n            pos.latitude <= self.initExtent.north)) {\r\n            // add a padding based on the camera height\r\n            var maxHeight = self.viewer.scene.screenSpaceCameraController.maximumZoomDistance;\r\n            var padding = pos.height * 0.05 / maxHeight;\r\n            pos.longitude = Math.max(self.initExtent.west - padding, pos.longitude);\r\n            pos.latitude = Math.max(self.initExtent.south - padding, pos.latitude);\r\n            pos.longitude = Math.min(self.initExtent.east + padding, pos.longitude);\r\n            pos.latitude = Math.min(self.initExtent.north + padding, pos.latitude);\r\n            self.viewer.camera.setView({\r\n                destination: Cesium.Ellipsoid.WGS84.cartographicToCartesian(pos),\r\n                orientation: {\r\n                    heading: self.viewer.camera.heading,\r\n                    pitch: self.viewer.camera.pitch\r\n                }\r\n            });\r\n        }\r\n\r\n        // Set the minimumZoomDistance according to the camera height\r\n        self.viewer.scene.screenSpaceCameraController.minimumZoomDistance = pos.height > 1800 ? 400 : 200;\r\n    };\r\n\r\n    var TwoDLinkedFeatureInfo = function (map) {\r\n        var pending = false;\r\n        var marker = null;\r\n        var ctlResultsPanel = null;\r\n        var ctlFeatureInfo = null;\r\n\r\n        var savedMode;\r\n        var map2DgetResolutionFN = map.map.getResolution;\r\n\r\n        var getResultsPanelCtl = function (ctlFeatureInfo) {\r\n            return new Promise(function (resolve, reject) {\r\n\r\n                if (!ctlResultsPanel) {\r\n                    if (!TC.control.ResultsPanel) {\r\n                        TC.syncLoadJS(TC.apiLocation + 'TC/control/ResultsPanel');\r\n                    }\r\n\r\n                    const resultsPanelOptions = {\r\n                        \"content\": \"table\",\r\n                        \"titles\": {\r\n                            \"main\": TC.Util.getLocaleString(map.map.options.locale, \"threed.rs.panel.gfi\"),\r\n                            \"max\": TC.Util.getLocaleString(map.map.options.locale, \"threed.rs.panel.gfi\")\r\n                        }\r\n                    };\r\n\r\n                    var addControlPromise;\r\n                    var controlContainer = map.map.getControlsByClass('TC.control.ControlContainer')[0];\r\n                    if (controlContainer) {\r\n                        resultsPanelOptions.position = controlContainer.POSITION.RIGHT;\r\n                        addControlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                    } else {\r\n                        resultsPanelOptions.div = document.createElement('div');\r\n                        map.map.div.appendChild(resultsPanelOptions.div);\r\n                        addControlPromise = map.map.addControl('resultsPanel', resultsPanelOptions);\r\n                    }\r\n\r\n                    addControlPromise.then(function (control) {\r\n                        control.caller = ctlFeatureInfo;\r\n                        ctlResultsPanel = control;\r\n                        ctlFeatureInfo.resultsPanel = ctlResultsPanel;\r\n\r\n                        resolve();\r\n                    });\r\n                } else {\r\n                    resolve();\r\n                }\r\n            });\r\n        };\r\n        var setMarker = function (pickedPosition) {\r\n            if (!marker) {\r\n                var markerStyle = TC.control.FeatureInfoCommons.prototype.markerStyle;\r\n\r\n                var billboard = {\r\n                    position: pickedPosition,\r\n                    billboard: { /* revisar: no está bien la URL de la imagen - también revisar el GFI que salta en móvil sólo con navegar */\r\n                        image: TC.Util.getBackgroundUrlFromCss(map.CLASS + '-marker'),\r\n                        eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                    }\r\n                };\r\n\r\n                marker = map.view3D.addNativeFeature.call(map, billboard);\r\n\r\n            } else {\r\n                marker.position = pickedPosition;\r\n            }\r\n\r\n            map.viewer.scene.requestRender();\r\n        };\r\n        var removeMarker = function () {\r\n            map.view3D.removeFeature.call(map, marker);\r\n            marker = null;\r\n        };\r\n\r\n        ctlFeatureInfo = map.map.getControlsByClass(TC.control.FeatureInfo)[0];\r\n        if (ctlFeatureInfo) {\r\n\r\n            savedMode = ctlFeatureInfo.displayMode;\r\n\r\n            getResultsPanelCtl(ctlFeatureInfo).then(function () {\r\n                ctlFeatureInfo.setDisplayMode(TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL);\r\n\r\n                map.map.on(TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                    if (e.control === ctlFeatureInfo.getDisplayControl()) {\r\n                        if (!ctlFeatureInfo.querying) {\r\n                            removeMarker();\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        }\r\n        this.clear = function () {\r\n            ctlFeatureInfo.closeResults();\r\n            removeMarker();\r\n        };\r\n        this.reset = function () {\r\n            this.clear();\r\n            ctlFeatureInfo.setDisplayMode(savedMode);\r\n            map.map.getResolution = map2DgetResolutionFN;\r\n        };\r\n        this.send = function (pickedPosition) {\r\n            return new Promise(function (resolve, reject) {\r\n                pending = true;\r\n\r\n                if (ctlFeatureInfo.displayMode !== TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL) {\r\n                    ctlFeatureInfo.setDisplayMode(TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL);\r\n                }\r\n\r\n                if (ctlFeatureInfo.resultsPanel) {\r\n                    ctlFeatureInfo.resultsPanel.close();\r\n                }\r\n\r\n                if (!map.waiting)\r\n                    map.waiting = map.map.getLoadingIndicator().addWait();\r\n\r\n                setMarker(pickedPosition);\r\n\r\n                getResultsPanelCtl(ctlFeatureInfo).then(function () {\r\n                    var pickedLocation = Cesium.Ellipsoid.WGS84.cartesianToCartographic(pickedPosition);\r\n\r\n                    var reprojected;\r\n                    if (map.view3D.crs !== map.view3D.view2DCRS) {\r\n                        reprojected = TC.Util.reproject([Cesium.Math.toDegrees(pickedLocation.longitude), Cesium.Math.toDegrees(pickedLocation.latitude)], map.view3D.crs, map.view3D.view2DCRS);\r\n                    } else {\r\n                        reprojected = [Cesium.Math.toDegrees(pickedLocation.longitude), Cesium.Math.toDegrees(pickedLocation.latitude)];\r\n                    }\r\n\r\n\r\n                    var radius = (map.map.options.pixelTolerance || TC.Cfg.pixelTolerance);\r\n                    var mapWidth = 2 * radius + 1;\r\n\r\n                    var tilesRendered = map.viewer.scene.globe._surface._tilesToRender;\r\n                    var pickedTile;\r\n\r\n                    for (var textureIndex = 0; !pickedTile && textureIndex < tilesRendered.length; ++textureIndex) {\r\n                        var tile = tilesRendered[textureIndex];\r\n                        if (Cesium.Rectangle.contains(tile.rectangle, pickedLocation)) {\r\n                            pickedTile = tile;\r\n                        }\r\n                    }\r\n\r\n                    if (!pickedTile) {\r\n                        resolve();\r\n                        return;\r\n                    }\r\n\r\n                    var imageryTiles = pickedTile.data.imagery;\r\n                    for (var i = imageryTiles.length - 1; i >= 0; --i) {\r\n                        var terrainImagery = imageryTiles[i];\r\n                        var imagery = terrainImagery.readyImagery;\r\n                        if (!imagery) {\r\n                            resolve();\r\n                            return;\r\n                        }\r\n                    }\r\n\r\n                    var nativeRectangle = pickedTile.tilingScheme.tileXYToNativeRectangle(pickedTile.x, pickedTile.y, pickedTile.level);\r\n\r\n                    var readyImageryToGetNativeRectangle = (imageryTiles.filter(function (imagery) {\r\n                        return imagery.readyImagery.imageryLayer.isBaseLayer();\r\n                    })[0] || {}).readyImagery;\r\n\r\n                    map.map.getResolution = function () {\r\n\r\n                        var west_south = map.view3D.crs !== map.view3D.view2DCRS ? TC.Util.reproject([nativeRectangle.west, nativeRectangle.south], map.view3D.crs, map.view3D.view2DCRS) : [nativeRectangle.west, nativeRectangle.south];\r\n                        var east_north = map.view3D.crs !== map.view3D.view2DCRS ? TC.Util.reproject([nativeRectangle.east, nativeRectangle.north], map.view3D.crs, map.view3D.view2DCRS) : [nativeRectangle.east, nativeRectangle.north];\r\n\r\n                        var xResolution = (east_north[0] - west_south[0]) / (readyImageryToGetNativeRectangle && readyImageryToGetNativeRectangle.imageryLayer.imageryProvider.tileWidth || 256);\r\n                        var yResolution = (east_north[1] - west_south[1]) / (readyImageryToGetNativeRectangle && readyImageryToGetNativeRectangle.imageryLayer.imageryProvider.tileHeight || 256);\r\n\r\n                        return Math.max(xResolution, yResolution);\r\n\r\n                    }.bind(map, readyImageryToGetNativeRectangle, nativeRectangle);\r\n\r\n                    map.map.one(TC.Consts.event.NOFEATUREINFO, function (e) {\r\n                        pending = false;\r\n\r\n                        resolve(e);                        \r\n                    }.bind(ctlFeatureInfo));\r\n\r\n                    map.map.one(TC.Consts.event.FEATUREINFO, function (e) {\r\n                        pending = false;\r\n\r\n                        resolve(e);\r\n                    });\r\n\r\n                    map.map.on(TC.Consts.event.FEATURECLICK, function (e) {\r\n                        removeMarker();\r\n\r\n                        resolve(e);\r\n                    });\r\n\r\n                    savedIsActive = ctlFeatureInfo.isActive;\r\n                    ctlFeatureInfo.isActive = true;\r\n                    ctlFeatureInfo.beforeRequest({\r\n                        xy: [0, 0]\r\n                    }); // Es irrelevante dónde va a poner el marcador, no se va a ver                \r\n\r\n                    ctlFeatureInfo.callback(reprojected);\r\n                });\r\n            });\r\n        };\r\n        this.get2DMarker = function () {\r\n            return ctlFeatureInfo.filterFeature;\r\n        };\r\n        this.isPending = function () {\r\n            return pending;\r\n        };\r\n    };\r\n\r\n    var RasterConverter = function (crsPattern) {\r\n        this.layerCrs = null;\r\n\r\n        var crsPattern = crsPattern;\r\n\r\n        var paths = {\r\n            CRS: [\"Capability\", \"Layer\", \"CRS\"],\r\n            TILEMATRIXSET: [\"Contents\", \"TileMatrixSet\", \"Identifier\"],\r\n            TILEMATRIXSETLABELS: [\"Contents\", \"TileMatrixSet\"]\r\n        };\r\n        var getOfPath = function (obj, p, i) {\r\n            if (i < p.length - 1) {\r\n                if (obj.hasOwnProperty(p[i]))\r\n                    return getOfPath(obj[p[i]], p, ++i);\r\n                else return null;\r\n            } else {\r\n                if (obj instanceof Array) {\r\n                    var _obj = [];\r\n                    for (var a = 0; a < obj.length; a++) {\r\n                        if (obj[a].hasOwnProperty(p[i]))\r\n                            _obj.push(obj[a][p[i]]);\r\n                    }\r\n\r\n                    return _obj;\r\n                } else return obj[p[i]];\r\n            }\r\n        };\r\n        var getTileMatrixSetLabelByLayerOnCapabilities = function (layer, crs) {\r\n            if ((capsURL = TC.Util.isOnCapabilities(layer.url))) {\r\n                if ((caps = TC.capabilities[capsURL])) {\r\n                    var tileMatrixSet = getOfPath(caps, paths.TILEMATRIXSETLABELS, 0);\r\n                    for (var a = 0; a < tileMatrixSet.length; a++) {\r\n                        if (tileMatrixSet[a][\"Identifier\"] === crs) {\r\n                            return getOfPath(tileMatrixSet[a], [\"TileMatrix\", \"Identifier\"], 0);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            return null;\r\n        };\r\n\r\n        var wmtsLayer = function (layer) {\r\n            const self = this;\r\n            return new Promise(function (resolve, reject) {\r\n                var tileMatrixSetLabels = getTileMatrixSetLabelByLayerOnCapabilities(layer, self.layerCrs);\r\n\r\n                var options = {\r\n                    url: new CustomResource({\r\n                        url: layer.options.urlPattern\r\n                    }, layer),\r\n                    layer: layer.layerNames,\r\n                    style: 'default',\r\n                    format: layer.format || layer.options.format,\r\n                    tileMatrixSetID: self.layerCrs,\r\n                    tileMatrixLabels: tileMatrixSetLabels,\r\n                    tilingScheme: new Cesium.GeographicTilingScheme()\r\n                };\r\n\r\n                resolve(new Cesium.WebMapTileServiceImageryProvider(options));\r\n            });\r\n        }\r\n\r\n        var wmsLayer = function (layer) {\r\n            return new Promise(function (resolve, reject) {\r\n                var options = {\r\n                    url: new CustomResource({\r\n                        url: layer.url\r\n                    }, layer),\r\n                    layers: layer.layerNames,\r\n                    parameters: {\r\n                        version: \"1.3.0\",\r\n                        transparent: true,\r\n                        format: layer.format || layer.options.format\r\n                    }\r\n                };\r\n\r\n                var bindEXBBox = function () {\r\n                    var bbox = [];\r\n                    if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                        if (layer.names.length > 0) {\r\n                            var names = layer.names.slice(0);\r\n                            var _getEXBBox = function _getEXBBox(nodes, name) {\r\n                                if (nodes) {\r\n                                    for (var i = 0; i < nodes.length; i++) {\r\n                                        var n = nodes[i];\r\n                                        if (layer.compareNames(layer.wrap.getName(n), name)) {\r\n                                            return n.EX_GeographicBoundingBox;\r\n                                        }\r\n                                    }\r\n\r\n                                    return _getEXBBox(n.Layer, name);\r\n                                }\r\n                            };\r\n                            while (names.length > 0) {\r\n                                var exBBox = _getEXBBox([layer.capabilities.Capability.Layer], names.pop());\r\n                                if (exBBox !== null) {\r\n                                    bbox.push(exBBox);\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    return bbox;\r\n                };\r\n                var exBoundingBox = bindEXBBox();\r\n\r\n                if (exBoundingBox) {\r\n                    layer.geoBBox = exBoundingBox;\r\n                }\r\n\r\n                resolve(new Cesium.WebMapServiceImageryProvider(options));\r\n            });\r\n        };\r\n\r\n        var CustomResource;\r\n        var defineCustomResource = function () {\r\n            /* tengo que sobrescribir porque no valida nada... \r\n            Desde la version 1.42 han cambiado la definición de un proxy en las capas raster: si configuras con proxy, pide directamente desde el proxy y si da error no gestiona nada, \r\n            y si no configuras proxy, pide directamente sin tampoco gestionar los errores. Además la creación de una capa raster es síncrona, por lo que no encaja con el algoritmo de proxificación */\r\n            CustomResource = function (options, layer) {\r\n                Cesium.Resource.call(this, options);\r\n\r\n                this.layer = layer;\r\n            };\r\n            CustomResource.prototype.constructor = CustomResource;\r\n            CustomResource.prototype = Object.create(Cesium.Resource.prototype, {});\r\n            CustomResource.prototype.clone = function (result) {\r\n\r\n                var cloned = Cesium.Resource.prototype.clone.call(this, result);\r\n\r\n                if (!Cesium.defined(result)) {\r\n                    result = new CustomResource({\r\n                        url: this._url\r\n                    }, this.layer);\r\n                }\r\n\r\n                result._url = cloned._url;\r\n                result._queryParameters = cloned._queryParameters;\r\n                result._templateValues = cloned._templateValues;\r\n                result.headers = cloned.headers;\r\n                result.proxy = cloned.proxy;\r\n                result.retryCallback = cloned.retryCallback;\r\n                result.retryAttempts = cloned.retryAttempts;\r\n                result._retryCount = 0;\r\n\r\n                result.request = cloned.request;\r\n\r\n\r\n\r\n                return result;\r\n            };\r\n            CustomResource.prototype.fetchImage = customFetchImage;\r\n        };\r\n\r\n        /* inicio cesium Resource override */\r\n        var xhrBlobSupported = (function () {\r\n            try {\r\n                var xhr = new XMLHttpRequest();\r\n                xhr.open('GET', '#', true);\r\n                xhr.responseType = 'blob';\r\n                return xhr.responseType === 'blob';\r\n            } catch (e) {\r\n                return false;\r\n            }\r\n        })();\r\n\r\n        function checkAndResetRequest(request) {\r\n            if (request.state === Cesium.RequestState.ISSUED || request.state === Cesium.RequestState.ACTIVE) {\r\n                throw new Cesium.RuntimeError('The Resource is already being fetched.');\r\n            }\r\n\r\n            request.state = Cesium.RequestState.UNISSUED;\r\n            request.deferred = undefined;\r\n        }\r\n\r\n        function createImage(layer, url, crossOrigin, deferred) {\r\n            var getImage = function (url) {\r\n                var image = new Image();\r\n\r\n                image.onload = function (layer) {\r\n                    deferred.resolve(image);\r\n                }.bind(image, layer);\r\n\r\n                image.onerror = function (layer, e) {\r\n                    deferred.reject(e);\r\n                }.bind(image, layer);\r\n\r\n                if (crossOrigin) {\r\n                    if (Cesium.TrustedServers.contains(url)) {\r\n                        image.crossOrigin = 'use-credentials';\r\n                    } else {\r\n                        image.crossOrigin = '';\r\n                    }\r\n                }\r\n\r\n                image.src = url;\r\n            };\r\n\r\n            layer.getWebGLUrl.call(layer, url).then(getImage, function (e) {\r\n                deferred.reject(e);\r\n            });\r\n        };\r\n\r\n        function fetchImage(resource, allowCrossOrigin) {\r\n            var request = resource.request;\r\n            request.url = resource.url;\r\n            request.requestFunction = function () {\r\n                var url = resource.url;\r\n                var crossOrigin = false;\r\n\r\n                // data URIs can't have allowCrossOrigin set.\r\n                if (!resource.isDataUri && !resource.isBlobUri) {\r\n                    crossOrigin = resource.isCrossOriginUrl;\r\n                }\r\n\r\n                var deferred = Cesium.when.defer();\r\n\r\n                createImage(resource.layer, url, crossOrigin && allowCrossOrigin, deferred);\r\n\r\n                return deferred.promise;\r\n            };\r\n\r\n            var promise = Cesium.RequestScheduler.request(request);\r\n            if (!Cesium.defined(promise)) {\r\n                return;\r\n            }\r\n\r\n            return promise.otherwise(function (e) {\r\n                return Cesium.when.reject(e);\r\n            });\r\n        }\r\n\r\n        var customFetchImage = function (preferBlob, allowCrossOrigin) {\r\n            if (Cesium.defined(allowCrossOrigin)) {\r\n                Cesium.deprecationWarning('Resource.fetchImage.allowCrossOrigin', 'The allowCrossOrigin parameter has been deprecated and will be removed in Cesium 1.44. It no longer needs to be specified.');\r\n            }\r\n\r\n            preferBlob = Cesium.defaultValue(preferBlob, false);\r\n            allowCrossOrigin = Cesium.defaultValue(allowCrossOrigin, true);\r\n\r\n            checkAndResetRequest(this.request);\r\n\r\n            // We try to load the image normally if\r\n            // 1. Blobs aren't supported\r\n            // 2. It's a data URI\r\n            // 3. It's a blob URI\r\n            // 4. It doesn't have request headers and we preferBlob is false\r\n            if (!xhrBlobSupported || this.isDataUri || this.isBlobUri || (!this.hasHeaders && !preferBlob)) {\r\n                return fetchImage(this, allowCrossOrigin);\r\n            }\r\n\r\n            var blobPromise = this.fetchBlob();\r\n            if (!Cesium.defined(blobPromise)) {\r\n                return;\r\n            }\r\n\r\n            var generatedBlobResource;\r\n            var generatedBlob;\r\n            return blobPromise\r\n                .then(function (blob) {\r\n                    if (!Cesium.defined(blob)) {\r\n                        return;\r\n                    }\r\n                    generatedBlob = blob;\r\n                    var blobUrl = window.URL.createObjectURL(blob);\r\n                    generatedBlobResource = new Cesium.Resource({\r\n                        url: blobUrl\r\n                    });\r\n\r\n                    return fetchImage(generatedBlobResource);\r\n                })\r\n                .then(function (image) {\r\n                    if (!Cesium.defined(image)) {\r\n                        return;\r\n                    }\r\n                    window.URL.revokeObjectURL(generatedBlobResource.url);\r\n\r\n                    // This is because the blob object is needed for DiscardMissingTileImagePolicy\r\n                    // See https://github.com/AnalyticalGraphicsInc/cesium/issues/1353\r\n                    image.blob = generatedBlob;\r\n                    return image;\r\n                })\r\n                .otherwise(function (error) {\r\n                    if (Cesium.defined(generatedBlobResource)) {\r\n                        window.URL.revokeObjectURL(generatedBlobResource.url);\r\n                    }\r\n\r\n                    return Cesium.when.reject(error);\r\n                });\r\n        };\r\n        /* fin cesium Resource override */\r\n\r\n        this.convert = function (layer, map3DCRS) {\r\n            var csmLayer;\r\n\r\n            this.layerCrs = map3DCRS;\r\n\r\n            if (!CustomResource) { defineCustomResource(); }\r\n\r\n            switch (true) {\r\n                case TC.Consts.layerType.WMTS == layer.type:\r\n                    return wmtsLayer.call(this, layer);\r\n                case TC.Consts.layerType.WMS == layer.type:\r\n                    return wmsLayer.call(this, layer);\r\n                    break;\r\n            }\r\n        };\r\n    };\r\n    var FeatureConverter = function () {\r\n        var scene = null;\r\n        var toCesiumColor = function (hexStringColor, alpha) {\r\n            if (hexStringColor instanceof Array) {\r\n                hexStringColor = \"rgba(\" + hexStringColor[0] + \", \" + hexStringColor[1] + \", \" + hexStringColor[2] + \", \" + hexStringColor[3] + \")\";\r\n            }\r\n            var color = Cesium.Color.fromCssColorString(hexStringColor);\r\n            if (alpha !== undefined) {\r\n                return color.withAlpha(alpha);\r\n            }\r\n\r\n            return color;\r\n        }\r\n        var setStyleProperties = function (styles, properties, feature) {\r\n            for (var key in properties) { // recorremos el diccionario de propiedades que admitimos como estilo\r\n                var attr = styles[properties[key].prop];\r\n                if (attr !== undefined) {\r\n                    if (typeof (attr) === \"function\") { // si la propiedad del estilo es una función (como en el control de búsquedas) invocamos para obtener el valor\r\n                        var val = attr(feature);\r\n                        if (val) {\r\n                            properties[key].val = val;\r\n                        }\r\n                    } else {\r\n                        properties[key].val = attr; // obtenenemos el valor\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        var getPixelSize = function (coords) {\r\n            var rectangle;\r\n\r\n            if (coords.length == 1) {\r\n                var point = coords[0];\r\n                var delta = 1000;\r\n                var minx, miny, maxx, maxy;\r\n                minx = new Cesium.Cartesian3(point.x - delta, point.y, point.z);\r\n                miny = new Cesium.Cartesian3(point.x, point.y - delta, point.z);\r\n                maxx = new Cesium.Cartesian3(point.x + delta, point.y, point.z);\r\n                maxy = new Cesium.Cartesian3(point.x, point.y + delta, point.z);\r\n\r\n                rectangle = Cesium.Rectangle.fromCartesianArray([minx, miny, maxx, maxy], Cesium.Ellipsoid.WGS84);\r\n            } else {\r\n                rectangle = Cesium.Rectangle.fromCartesianArray(coords, Cesium.Ellipsoid.WGS84);\r\n            }\r\n\r\n            var neededCameraPosition = scene.camera.getRectangleCameraCoordinates(rectangle);\r\n            var distance = Cesium.Cartesian3.distance(neededCameraPosition, Cesium.BoundingSphere.fromPoints(coords).center);\r\n            var pixelSize = scene.camera.frustum.getPixelDimensions(scene.drawingBufferWidth, scene.drawingBufferHeight, distance, new Cesium.Cartesian2());\r\n            pixelSize = Math.max(pixelSize.x, pixelSize.y);\r\n            return Math.round(pixelSize) == 0 ? 1 : pixelSize;\r\n        };\r\n\r\n        var getFeatureStyle = function (feature) {\r\n            var self = this;\r\n            var styles;\r\n\r\n            if (!feature.layer || (feature.layer && !feature.layer.hasOwnProperty('styles'))) {\r\n                styles = TC.Defaults.styles;\r\n            } else {\r\n                styles = feature.layer.styles;\r\n            }\r\n\r\n            styles = styles[feature.STYLETYPE] == undefined ?\r\n                styles[(feature.STYLETYPE === \"polyline\" ? \"line\" : feature.STYLETYPE)] :\r\n                styles[(feature.STYLETYPE === \"multipolygon\" ? \"polygon\" : feature.STYLETYPE)];\r\n\r\n            styles = TC.Util.extend({}, styles, feature.options, feature.getStyle());\r\n\r\n            return styles;\r\n        }\r\n\r\n        function createLine(id, coords, options, callback) {\r\n            var entity = new Cesium.Entity({\r\n                name: id,\r\n                polyline: {\r\n                    positions: coords,\r\n                    width: options.width,\r\n                    material: options.material,\r\n                    clampToGround: true\r\n                }\r\n            });\r\n\r\n            callback(entity);\r\n        };\r\n\r\n        var circleConverter = function (feature) {\r\n            var self = this;\r\n            var circle = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            circle.options = function () {\r\n                var opt = {};\r\n\r\n                var properties = {\r\n                    color: { prop: 'strokeColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'fillColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = Cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                opt.outlineColor = Cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            circle.geometryType = function (coords, options) {\r\n\r\n                return new Cesium.GroundPrimitive({\r\n                    releaseGeometryInstances: false,\r\n                    geometryInstances: new Cesium.GeometryInstance({\r\n                        id: feature.id,\r\n                        geometry: new Cesium.CircleGeometry({\r\n                            center: coords[0],\r\n                            radius: feature.geometry[1]\r\n                        }),\r\n                        attributes: {\r\n                            color: options.color\r\n                        }\r\n                    })\r\n                });\r\n\r\n                // Para obtener el contorno de círculo \r\n                //var radius = feature.geometry[1];\r\n                //var outlineEllipse = Cesium.EllipseGeometryLibrary.computeEllipsePositions({\r\n                //    semiMinorAxis: radius,\r\n                //    semiMajorAxis: radius,\r\n                //    rotation: 0,\r\n                //    center: coords[0],\r\n                //    granularity: Cesium.Math.toRadians(0.5)\r\n                //}, false, true);\r\n\r\n                //var outerPositions = Cesium.Cartesian3.unpackArray(outlineEllipse.outerPositions);\r\n\r\n                //var outlineSize = getPixelSize(outerPositions);\r\n                //var metersPerPixel = scene.camera.getPixelSize(Cesium.BoundingSphere.fromPoints(outerPositions), scene.drawingBufferWidth, scene.drawingBufferHeight);\r\n                //var outlineInMeters = metersPerPixel * outlineSize;\r\n\r\n                //var outlineHoleEllipse = Cesium.EllipseGeometryLibrary.computeEllipsePositions({\r\n                //    semiMinorAxis: radius - outlineInMeters,\r\n                //    semiMajorAxis: radius - outlineInMeters,\r\n                //    rotation: 0,\r\n                //    center: coords[0],\r\n                //    granularity: Cesium.Math.toRadians(0.5)\r\n                //}, false, true);\r\n\r\n                //var innerPositions = Cesium.Cartesian3.unpackArray(outlineHoleEllipse.outerPositions);\r\n\r\n                //var outlineCircleGeom = new Cesium.GroundPrimitive({\r\n                //    geometryInstances: new Cesium.GeometryInstance({\r\n                //        id: feature.id + 'outline',\r\n                //        geometry: new Cesium.PolygonGeometry({\r\n                //            polygonHierarchy: new Cesium.PolygonHierarchy(outerPositions, [new Cesium.PolygonHierarchy(innerPositions)])\r\n                //        }),\r\n                //        attributes: {\r\n                //            color: options.outlineColor\r\n                //        }\r\n                //    })\r\n                //});\r\n            };\r\n\r\n            return circle;\r\n        };\r\n        var polygonConverter = function (feature) {\r\n            var self = this;\r\n            var polygon = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            polygon.options = function () {\r\n                var opt = {};\r\n                var properties = {\r\n                    color: { prop: 'fillColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'strokeColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = Cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                opt.outlineColor = color;\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.MultiPolygon && feature.CLASSNAME == \"TC.feature.MultiPolygon\") {\r\n                polygon.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var getting = [];\r\n\r\n                        var geomPolys = [];\r\n                        var geomOutlines = [];\r\n\r\n                        var getPolyGeom = function (polygonHierarchy) {\r\n                            return new Cesium.GeometryInstance({\r\n                                id: feature.id,\r\n                                geometry: new Cesium.PolygonGeometry({\r\n                                    polygonHierarchy: polygonHierarchy\r\n                                }),\r\n                                attributes: {\r\n                                    color: options.color\r\n                                }\r\n                            });\r\n                        };\r\n\r\n                        var getOutlineGeom = function (outlineCoords) {\r\n                            return new Promise(function (res, rej) {\r\n                                createLine(feature.id, outlineCoords, { material: options.outlineColor, width: options.width }, function (entity) {\r\n                                    geomOutlines.push(entity);\r\n                                    res();\r\n                                });\r\n                            });\r\n                        };\r\n\r\n                        for (var i = 0; i < coords.length; i++) {\r\n                            for (var j = 0; j < coords[i].length; j++) {\r\n                                var hierarchy;\r\n                                if (j == 0) {\r\n                                    getting.push(getOutlineGeom.call(this, coords[i][0]));\r\n                                    hierarchy = new Cesium.PolygonHierarchy(coords[i][0]);\r\n                                } else {\r\n                                    getting.push(getOutlineGeom.call(this, coords[i][j]));\r\n                                    hierarchy.holes.push(new Cesium.PolygonHierarchy(coords[i][j]));\r\n                                }\r\n                            }\r\n\r\n                            geomPolys.push(getPolyGeom(hierarchy));\r\n                        }\r\n\r\n                        Promise.all(getting).then(function () {\r\n                            getting = [];\r\n\r\n                            resolve(\r\n                                [new Cesium.GroundPrimitive({\r\n                                    releaseGeometryInstances: false,\r\n                                    geometryInstances: geomPolys\r\n                                }), geomOutlines]);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n            else if (TC.feature.Polygon && feature.CLASSNAME == \"TC.feature.Polygon\") {\r\n                polygon.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        if (Array.isArray(coords) && coords.length === 1 && Array.isArray(coords[0])) {\r\n                            coords = coords[0];\r\n                        }\r\n\r\n                        createLine(feature.id, coords, {\r\n                            material: options.outlineColor, width: options.width\r\n                        }, function (entity) {\r\n\r\n                            resolve([\r\n                                new Cesium.GroundPrimitive({\r\n                                    releaseGeometryInstances: false,\r\n                                    geometryInstances: new Cesium.GeometryInstance({\r\n                                        id: feature.id,\r\n                                        geometry: new Cesium.PolygonGeometry({\r\n                                            polygonHierarchy: new Cesium.PolygonHierarchy(coords)\r\n                                        }),\r\n                                        attributes: {\r\n                                            color: options.color\r\n                                        }\r\n                                    })\r\n                                }), entity]);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n\r\n            return polygon;\r\n        };\r\n        var lineConverter = function (feature) {\r\n            var self = this;\r\n            var line = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            line.options = function () {\r\n                var opt = {};\r\n                var properties = {\r\n                    color: { prop: 'strokeColor' },\r\n                    opacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = color;\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.MultiPolyline && feature.CLASSNAME == \"TC.feature.MultiPolyline\") {\r\n                line.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var geomInstances = [];\r\n\r\n                        var getting = [];\r\n\r\n                        if (coords.length == 1) {\r\n                            coords = coords[0];\r\n\r\n                            getting.push(new Promise(function (res, rej) {\r\n                                createLine(feature.id, coords, {\r\n                                    material: options.color, width: options.width\r\n                                }, function (entity) {\r\n                                    geomInstances.push(entity);\r\n                                    res();\r\n                                });\r\n                            }));\r\n\r\n\r\n                        } else {\r\n                            coords = coords.sort(function (a, b) {\r\n                                if (a.length > b.length) {\r\n                                    return -1;\r\n                                }\r\n                                if (a.length < b.length) {\r\n                                    return 1;\r\n                                }\r\n                                return 0;\r\n                            });\r\n                            var pixelSize = getPixelSize(coords[0]);\r\n                            for (var i = 0; i < coords.length; i++) {\r\n\r\n                                getting.push(new Promise(function (res, rej) {\r\n                                    createLine(feature.id, coords[i], {\r\n                                        material: options.color, width: options.width\r\n                                    }, function (entity) {\r\n                                        geomInstances.push(entity);\r\n                                        res();\r\n                                    });\r\n                                }));\r\n                            }\r\n                        }\r\n\r\n                        Promise.all(getting).then(function () {\r\n                            getting = [];\r\n\r\n                            resolve(geomInstances);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n            else if (TC.feature.Polyline && feature.CLASSNAME == \"TC.feature.Polyline\") {\r\n                line.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n\r\n                        createLine(feature.id, coords, {\r\n                            material: options.color, width: options.width\r\n                        }, function (entity) {\r\n                            resolve(entity);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n\r\n            return line;\r\n        };\r\n        var pointConverter = function (feature) {\r\n            var self = this;\r\n            var point = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            point.options = function () {\r\n                var opt = {};\r\n\r\n                var properties = {\r\n                    rotation: { prop: 'angle' },\r\n                    label: { prop: 'label' },\r\n                    fontSize: { prop: 'fontSize' },\r\n                    fontColor: { prop: 'fontColor' },\r\n                    outlineLabelColor: { prop: 'labelOutlineColor' },\r\n                    outlineLabelWidth: { prop: 'labelOutlineWidth' },\r\n                    anchor: { prop: 'anchor' },\r\n                    height: { prop: 'height' },\r\n                    width: { prop: 'width' },\r\n                    url: { prop: 'url' },\r\n                    color: { prop: 'fillColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'strokeColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    outlineWidth: { prop: 'strokeWidth' },\r\n                    radius: { prop: 'radius' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n\r\n                if (properties.anchor.hasOwnProperty('val')) {\r\n                    if (!(properties.url.hasOwnProperty('val')) && feature.options.url) {\r\n                        opt.url = feature.options.url;\r\n                    } else {\r\n                        opt.url = properties.url.val;\r\n                    }\r\n\r\n                    opt.anchor = properties.anchor.val;\r\n                }\r\n\r\n                if (properties.height.hasOwnProperty('val')) {\r\n                    opt.height = properties.height.val;\r\n                }\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                if (properties.rotation.hasOwnProperty('val')) {\r\n                    opt.rotation = properties.rotation.val;\r\n                }\r\n\r\n                if (properties.label.hasOwnProperty('val')) {\r\n                    opt.label = properties.label.val;\r\n                }\r\n\r\n                if (properties.fontSize.hasOwnProperty('val')) {\r\n                    opt.fontSize = properties.fontSize.val;\r\n                }\r\n\r\n                if (properties.fontColor.hasOwnProperty('val')) {\r\n                    opt.fontColor = toCesiumColor(properties.fontColor.val);\r\n                }\r\n\r\n                if (properties.outlineLabelColor.hasOwnProperty('val')) {\r\n                    opt.outlineLabelColor = toCesiumColor(properties.outlineLabelColor.val);\r\n                }\r\n\r\n                if (properties.outlineLabelWidth.hasOwnProperty('val')) {\r\n                    opt.outlineLabelWidth = properties.outlineLabelWidth.val;\r\n                }\r\n\r\n\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        opt.color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        opt.color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        opt.outlineColor = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        opt.outlineColor = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                if (properties.outlineWidth.hasOwnProperty('val')) {\r\n                    opt.outlineWidth = properties.outlineWidth.val;\r\n                }\r\n\r\n                if (properties.radius.hasOwnProperty('val')) {\r\n                    opt.radius = properties.radius.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.Marker && feature.CLASSNAME == \"TC.feature.Marker\") {\r\n                point.geometryType = function (coords, options) {\r\n                    var billboard = {\r\n                        name: feature.id,\r\n                        position: coords[0],\r\n                        billboard: {\r\n                            image: options.url,\r\n                            width: options.width,\r\n                            height: options.height,\r\n                            eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                        }\r\n                    };\r\n\r\n                    if (options.anchor && options.anchor.length > 0) {\r\n                        billboard.billboard.pixelOffset = new Cesium.Cartesian2(options.anchor[0], options.anchor[1]);\r\n                    }\r\n\r\n                    if (!options.label) {\r\n                        return new Cesium.Entity(billboard);\r\n                    } else {\r\n                        billboard.label = {\r\n                            text: options.label,\r\n                            font: '14pt sans-serif',\r\n                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,\r\n                            horizontalOrigin: Cesium.HorizontalOrigin.LEFT,\r\n                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                            fillColor: options.fontColor,\r\n                            showBackground: true,\r\n                            eyeOffset: new Cesium.Cartesian3(3000, 0, -100)\r\n                        };\r\n\r\n                        return new Cesium.Entity(billboard);\r\n                    }\r\n                };\r\n            }\r\n            else if (TC.feature.Point && feature.CLASSNAME == \"TC.feature.Point\") {\r\n                var pinBuilder = new Cesium.PinBuilder();\r\n\r\n                point.geometryType = function (coords, options) {\r\n                    var text = options.label;\r\n\r\n                    switch (true) {\r\n                        case (text && /^([A-Z])\\w+$/gi.test(text)):\r\n                        case (text && !/^[0-9]*\\-{0,1}[a-z]{0,4}$/gi.test(text)):\r\n\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                label: {\r\n                                    text: options.label,\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,\r\n                                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BASELINE,\r\n                                    font: '16' + 'px san-serif Helvetica',\r\n                                    fillColor: Cesium.Color.BLACK,\r\n                                    outlineColor: Cesium.Color.WHITE,\r\n                                    outlineWidth: 5,\r\n                                    style: Cesium.LabelStyle.FILL_AND_OUTLINE\r\n                                }\r\n                            });\r\n\r\n                            break;\r\n                        case (/^[0-9]*\\-{0,1}[a-z]{0,4}$/gi.test(text)):\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: pinBuilder.fromText(text, options.fontColor, 48).toDataURL(),\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                            break;\r\n                        case options.radius && options.radius > 0:\r\n                            var stringifyScratch = new Array(2);\r\n\r\n                            const drawPin = function (context2D, color, size) {\r\n\r\n                                color = color.darken(0.15, new Cesium.Color());\r\n                                var rgbaColor = color.toCssColorString().replace(\"rgb\", \"rgba\").replace(\")\", \",0)\");\r\n\r\n                                context2D.save();\r\n                                context2D.scale(size / 24, size / 24);\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.miterLimit = 4;\r\n                                context2D.font = \"normal normal 400 normal 15px / 21.4286px ''\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.save();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.font = \"   15px \";\r\n                                context2D.save();\r\n                                context2D.fillStyle = \"#b3b3b3\";\r\n                                context2D.fillStyle = \"rgba(179, 179, 179, 1)\";\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.lineWidth = 1.5;\r\n                                context2D.lineJoin = \"round\";\r\n                                context2D.miterLimit = \"4\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.beginPath();\r\n                                context2D.moveTo(11.578125, 11.71875);\r\n                                context2D.lineTo(12.421875, 11.71875);\r\n                                context2D.lineTo(12.421875, 24);\r\n                                context2D.lineTo(11.578125, 24);\r\n                                context2D.closePath();\r\n                                context2D.fill();\r\n                                context2D.stroke();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.fillStyle = color.toCssColorString().replace(\"rgb\", \"rgba\").replace(\")\", \", 1)\");\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.lineWidth = 1.5;\r\n                                context2D.lineJoin = \"round\";\r\n                                context2D.miterLimit = \"4\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.beginPath();\r\n                                context2D.moveTo(17, 7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 0, 1.5707963267948966, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 1.5707963267948966, 3.141592653589793, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 3.141592653589793, 4.71238898038469, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, -1.5707963267948966, 0, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.closePath();\r\n                                context2D.fill();\r\n                                context2D.stroke();\r\n                                context2D.restore();\r\n                            };\r\n\r\n                            const createPin = function (color, size) {\r\n                                if (!pinBuilder._cache) {\r\n                                    pinBuilder._cache = {};\r\n                                }\r\n\r\n                                stringifyScratch[0] = color;\r\n                                stringifyScratch[1] = size;\r\n                                var id = JSON.stringify(stringifyScratch);\r\n\r\n                                var item = pinBuilder._cache[id];\r\n                                if (item) {\r\n                                    return item;\r\n                                }\r\n\r\n                                var canvas = document.createElement('canvas');\r\n                                canvas.width = size;\r\n                                canvas.height = size;\r\n\r\n                                var context2D = canvas.getContext('2d');\r\n                                drawPin(context2D, color, size);\r\n\r\n                                pinBuilder._cache[id] = canvas;\r\n                                return canvas;\r\n                            }\r\n\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: createPin(Cesium.Color.fromCssColorString(feature.options.strokeColor ? feature.options.strokeColor : TC.Cfg.styles.point.strokeColor), 48).toDataURL(),\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                        default:\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: pinBuilder.fromColor(Cesium.Color.fromCssColorString(feature.options.fillColor ? feature.options.fillColor : TC.Cfg.styles.point.fillColor), 32).toDataURL(),\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                    }\r\n                };\r\n            }\r\n\r\n            return point;\r\n        };\r\n\r\n        this.convert = function (scn, feature, sourceCrs, targetCrs) {\r\n            scene = scn;\r\n\r\n            var byPromise = false;\r\n            var cartesians = [];\r\n            var toCartesian = function (coord, arr) {\r\n                if (!Array.isArray(coord)) {\r\n                    return;\r\n                }\r\n\r\n                if (sourceCrs !== targetCrs) {\r\n                    coord = TC.Util.reproject(coord, sourceCrs, targetCrs);\r\n                }\r\n\r\n                arr.push(coord.length > 2 ?\r\n                    Cesium.Cartesian3.fromDegrees(coord[0], coord[1], coord[2]) :\r\n                    Cesium.Cartesian3.fromDegrees(coord[0], coord[1]));\r\n            };\r\n\r\n            var obj;\r\n            var geometry = feature.geometry;\r\n            var converter;\r\n\r\n            var point,\r\n                points,\r\n                ringsOrPolylines,\r\n                polygons;\r\n\r\n            var forPoints = function (points, arr) {\r\n                if (Array.isArray(points)) {\r\n                    for (var i = 0; i < points.length; i++) {\r\n                        toCartesian(points[i], arr);\r\n                    }\r\n                }\r\n            };\r\n            var forRingsOrPolylines = function (ringsOrPolylines, arr) {\r\n                if (Array.isArray(ringsOrPolylines)) {\r\n                    for (var i = 0; i < ringsOrPolylines.length; i++) {\r\n                        arr.push([]);\r\n                        forPoints(ringsOrPolylines[i], arr[arr.length - 1]);\r\n                    }\r\n                }\r\n            };\r\n            var forPolygons = function (polygons) {\r\n                if (Array.isArray(polygons)) {\r\n                    for (var i = 0; i < polygons.length; i++) {\r\n                        cartesians.push([]);\r\n                        forRingsOrPolylines(polygons[i], cartesians[cartesians.length - 1]);\r\n                    }\r\n                }\r\n            };\r\n\r\n            switch (true) {\r\n                case (TC.feature.Circle && feature.CLASSNAME == \"TC.feature.Circle\"):\r\n                    forPoints(geometry, cartesians);\r\n                    converter = circleConverter.call(self, feature);\r\n                    break;\r\n                case (TC.feature.MultiPolygon && feature.CLASSNAME == \"TC.feature.MultiPolygon\"):\r\n                    polygons = geometry;\r\n                    if (Array.isArray(polygons)) {\r\n                        forPolygons(polygons);\r\n\r\n                        converter = polygonConverter.call(self, feature);\r\n                        byPromise = true;\r\n                    }\r\n                    break;\r\n                case ((TC.feature.Polygon && feature.CLASSNAME == \"TC.feature.Polygon\") || (TC.feature.MultiPolyline && feature.CLASSNAME == \"TC.feature.MultiPolyline\")):\r\n                    ringsOrPolylines = geometry;\r\n                    if (Array.isArray(ringsOrPolylines)) {\r\n                        forRingsOrPolylines(ringsOrPolylines, cartesians);\r\n\r\n                        if (feature.CLASSNAME == \"TC.feature.Polygon\") {\r\n                            converter = polygonConverter(feature);\r\n                            byPromise = true;\r\n                        }\r\n                        else if (feature.CLASSNAME == \"TC.feature.MultiPolyline\") {\r\n                            converter = lineConverter(feature);\r\n                            byPromise = true;\r\n                        }\r\n                    }\r\n                    break;\r\n                case (TC.feature.Polyline && feature.CLASSNAME == \"TC.feature.Polyline\"):\r\n                    points = geometry;\r\n                    if (Array.isArray(points)) {\r\n                        forPoints(points, cartesians);\r\n\r\n                        converter = lineConverter(feature);\r\n                        byPromise = true;\r\n                    }\r\n                    break;\r\n                case (TC.feature.Marker && feature.CLASSNAME == \"TC.feature.Marker\"):\r\n                    points = [geometry];\r\n                    forPoints(points, cartesians);\r\n\r\n                    converter = pointConverter(feature);\r\n                    break;\r\n                case (TC.feature.Point && feature.CLASSNAME == \"TC.feature.Point\"):\r\n                    points = [geometry];\r\n                    forPoints(points, cartesians);\r\n\r\n                    converter = pointConverter(feature);\r\n                    break;\r\n            }\r\n\r\n            if (cartesians.length == 0) {\r\n                return null;\r\n            }\r\n\r\n            obj = {\r\n                id: feature.id,\r\n                attributes: feature.data,\r\n                boundigSphere: Cesium.BoundingSphere.fromPoints(cartesians)\r\n            };\r\n\r\n            if (!byPromise) { // si estamos pintando líneas, obtenemos posiciones con altura\r\n                obj.geometry = converter.geometryType(cartesians, converter.options());\r\n            } else {\r\n                obj.geometry = function (provider) {\r\n                    converter.provider = provider;\r\n                    return converter.geometryType(cartesians, converter.options());\r\n                }\r\n            }\r\n\r\n            return obj;\r\n        };\r\n    };\r\n\r\n    const currentMapCfg = {\r\n        baseMap: '',\r\n        baseMaps: [],\r\n        baseVector: ''\r\n    };\r\n    const setMustReprojectOfBaseLayers = function (map) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var isBaseRaster = map.baseLayer instanceof TC.layer.Raster;\r\n\r\n            if (isBaseRaster) {\r\n                if (!isCompatible(map.baseLayer, self.view3D.crs)) {\r\n                    var fallbackLayer = map.baseLayer.getFallbackLayer();\r\n                    if (fallbackLayer) {\r\n                        fallbackLayer._capabilitiesPromise.then(function () {\r\n                            if (!fallbackLayer.isCompatible(self.view3D.crs)) {\r\n                                map.toast(self.getLocaleString('threed.baseLayerNoCompatible', { name: map.baseLayer.layerNames }));\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            } else {\r\n                currentMapCfg.baseVector = map.baseLayer;\r\n            }\r\n\r\n            if (currentMapCfg.baseMaps.length === 0) {\r\n\r\n                Promise.all(map.baseLayers.map(function (baseLayer) {\r\n                    if (!isCompatible(baseLayer, self.view3D.crs)) {\r\n                        var fallbackLayer = baseLayer.getFallbackLayer();\r\n                        if (fallbackLayer) {\r\n                            return fallbackLayer._capabilitiesPromise.then(function () {\r\n                                return !fallbackLayer.isCompatible(self.view3D.crs);\r\n                            });\r\n                        } else {\r\n                            return Promise.resolve(true);\r\n                        }\r\n                    } else {\r\n                        return Promise.resolve(false);\r\n                    }\r\n                })).then(function (results) {\r\n                    if (results.length > 0) {\r\n                        for (var i = 0; i < map.baseLayers.length; i++) {\r\n                            map.baseLayers[i].mustReproject = results[i];\r\n                        }\r\n\r\n                        //map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.THREED });\r\n                    }\r\n\r\n                    resolve();\r\n                });\r\n            }\r\n\r\n            currentMapCfg.baseMap = isBaseRaster ? map.baseLayer : self.Consts.BLANK_BASE;\r\n        });\r\n    };\r\n\r\n    viewProto.init = function (options) {\r\n        const self = this;\r\n\r\n        self.events = self.map.$events;\r\n\r\n        self.selectors = {\r\n            divThreedMap: options.divMap\r\n        };\r\n\r\n        if (options.terrain) {\r\n            self.terrain = options.terrain;\r\n        } else {\r\n            throw Error(\"Falta configuración del terreno\");\r\n        }\r\n\r\n        if (options.terrainFallback && options.terrainFallback.url && options.terrainFallback.coverageName && options.terrainFallback.noDataValue) {\r\n            self.terrainFallback = {\r\n                url: options.terrainFallback.url.trim(),\r\n                layerName: options.terrainFallback.coverageName,\r\n                format: options.terrainFallback.format,\r\n                noDataValue: options.terrainFallback.noDataValue\r\n            };\r\n        } else if (options.terrainFallback && (!options.terrainFallback.url || !options.terrainFallback.coverageName || !options.terrainFallback.noDataValue)) {\r\n            throw Error(\"Faltan datos sobre el terreno de respaldo\");\r\n        }\r\n\r\n        if (options.controls) {\r\n            self.allowedControls = options.controls;\r\n        }\r\n\r\n        self.mapView = new MapView(self.map, self);\r\n\r\n        self.map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n            self.mapView.metersPerUnit = self.map.getMetersPerUnit();\r\n        });\r\n\r\n        self.map.view3D = self.view3D;\r\n\r\n        /* provisional: no dispongo de getRenderedHtml porque ya no es un control */\r\n        self.getRenderedHtml(self.CLASS + '-overlay', {}, function (html) {\r\n            const parser = new DOMParser();\r\n            self.overlay = parser.parseFromString(html, 'text/html').body.firstChild;\r\n        });\r\n    };\r\n\r\n    viewProto.apply = function (options) {\r\n        const self = this;\r\n\r\n        options = options || {};\r\n\r\n        if (options.map) {\r\n            self.map = options.map;\r\n\r\n            if (!self.map.view3D) {\r\n                var viewName = self.VIEWNAME = self.VIEWNAME.substr(0, 1).toLowerCase() + self.VIEWNAME.substr(1);\r\n                if (self.map.options.views && self.map.options.views.hasOwnProperty(viewName)) {\r\n                    self.init(self.map.options.views[viewName]);\r\n                } else {\r\n                    throw Error('Falta configuración de la vista');\r\n                }\r\n            }\r\n\r\n            self.view3D.view2DCRS = options.map.crs;\r\n\r\n            options.map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n                self.view3D.view2DCRS = e.newCrs;\r\n            });\r\n        } else {\r\n            throw Error('Falta referencia al mapa 2D');\r\n        }\r\n\r\n        if (options.state) {\r\n            self.map.toast(TC.Util.getLocaleString(self.map.options.locale, 'threed.apply3DState'), { type: TC.Consts.msgType.INFO });\r\n        }\r\n\r\n        if (!self.waiting) {\r\n            self.waiting = self.map.getLoadingIndicator().addWait();\r\n        }\r\n\r\n        if (!self.ctrlsToMng) {\r\n            var ctls = [];\r\n            for (var i = 0, len = self.allowedControls.length; i < len; i++) {\r\n                var ctl = self.allowedControls[i];\r\n                ctl = ctl.substr(0, 1).toUpperCase() + ctl.substr(1);\r\n                var ctlsOnMap = self.map.getControlsByClass('TC.control.' + ctl);\r\n                if (ctlsOnMap.length === 0) { // si un control soportado aún no está en el mapa, nos suscribimos al addcontrol para controlarlo\r\n                    self.map.on(TC.Consts.event.CONTROLADD, function (ctrlClass, e) {\r\n                        var instance = new Function(\"return new \" + ctrlClass + \"()\")();\r\n                        if (instance.CLASS === e.control.CLASS) {\r\n                            self.ctrlsToMng.push(e.control);\r\n                        }\r\n                    }.bind(self, 'TC.control.' + ctl));\r\n                }\r\n                ctls = ctls.concat(ctlsOnMap);\r\n            }\r\n\r\n            self.ctrlsToMng = ctls;\r\n        }\r\n\r\n        self.map.on3DView = true;\r\n\r\n        self.map.div.classList.add(TC.Consts.classes.THREED);\r\n\r\n        self.divThreedMap = document.querySelector('#' + self.selectors.divThreedMap);\r\n        self.divThreedMap.classList.add(self.classes.MAPTHREED, self.classes.LOADING);\r\n\r\n        self.view3D.container = self.divThreedMap;\r\n\r\n        const loaded = function () {\r\n            self.map.getLoadingIndicator().removeWait(self.waiting);\r\n\r\n            delete self.waiting;\r\n\r\n            if (options.callback) {\r\n                options.callback();\r\n            }\r\n        };\r\n\r\n        try {\r\n            self.view3D.loadViewer.call(self).then(function () {\r\n\r\n                self.divThreedMap.classList.remove(self.CLASS + '-divMap-fadeOut');\r\n                self.divThreedMap.classList.add(self.CLASS + '-divMap-fadeIn');\r\n                self.mapView.viewHTML.classList.remove(self.CLASS + '-divMap-fadeIn');\r\n                self.mapView.viewHTML.classList.add(self.CLASS + '-divMap-fadeOut');\r\n\r\n                if (!options.state) {\r\n                    self.divThreedMap.classList.remove(self.classes.LOADING);\r\n                }\r\n\r\n                // mapas de fondo y capas\r\n                setMustReprojectOfBaseLayers.call(self, self.map).then(function () {\r\n\r\n                    // extent\r\n                    self.view3D.setCameraFromMapView.call(self);\r\n\r\n                    // mapa de fondo\r\n                    self.view3D.setBaseLayer.call(self, self.map.baseLayer);\r\n\r\n                    // capas de trabajo\r\n                    self.map.workLayers.filter(function (elem) {\r\n                        return elem.type === TC.Consts.layerType.WMTS || elem.type === TC.Consts.layerType.WMS;\r\n                    }).reverse().forEach(function (layer) {\r\n                        self.view3D.addLayer.call(self, layer);\r\n                    });\r\n\r\n                    self.viewer.readyPromise.then(function () {\r\n\r\n                        if (!self.view3D.cameraControls) self.view3D.cameraControls = new CameraControls(self);\r\n                        else self.view3D.cameraControls.render.call(self.view3D.cameraControls);\r\n\r\n                        if (!options.animateRendering && !options.state) {\r\n                            options.animateRendering = true;\r\n                        }\r\n\r\n                        if (options.state) {\r\n\r\n                            self.divThreedMap.classList.remove(self.classes.LOADING);\r\n\r\n                            var camera = self.view3D.cameraControls.getCamera();\r\n                            camera.flyTo({\r\n                                destination: Cesium.Cartesian3.fromRadians(options.state.cp[0], options.state.cp[1], options.state.cp[2]),\r\n                                orientation: {\r\n                                    heading: options.state.chpr[0],\r\n                                    pitch: options.state.chpr[1],\r\n                                    roll: options.state.chpr[2]\r\n                                },\r\n                                complete: loaded\r\n                            });\r\n\r\n                        } else if (options.animateRendering) {\r\n                            var angle = Cesium.Math.toRadians(50);\r\n                            var pickBP = pickBottomPoint(self.viewer.scene);\r\n\r\n                            var animationCallback = function () {\r\n\r\n                                Cesium.Camera.DEFAULT_VIEW_RECTANGLE = self.view3D.initialRectangle = self.viewer.camera.computeViewRectangle();\r\n                                Cesium.Camera.DEFAULT_VIEW_FACTOR = 0;\r\n\r\n                                loaded();\r\n                            };\r\n\r\n                            /* provisional: si llegamos aquí, es que el terreno está listo, por tanto, no entiendo porque da undefined */\r\n                            if (pickBP) {\r\n                                pickBP = Cesium.Matrix4.fromTranslation(pickBP);\r\n\r\n                                self.view3D.rotateAroundAxis(self.viewer.scene.camera, -angle, self.viewer.scene.camera.right, pickBP, {\r\n                                    duration: 2000,\r\n                                    callback: animationCallback\r\n                                });\r\n                            } else {\r\n                                animationCallback();\r\n                            }\r\n\r\n                        } else {\r\n                            loaded();\r\n                        }\r\n\r\n                        self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.THREED });\r\n\r\n                        self.events.on(TC.Consts.event.TERRAINLOADED, function () {\r\n\r\n                            const addHeight = function (position) {\r\n                                var cartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(position);\r\n                                var height = self.viewer.scene.globe.getHeight(cartographic) || 0;\r\n                                var finalCartographic = {\r\n                                    longitude: cartographic.longitude,\r\n                                    latitude: cartographic.latitude,\r\n                                    height: cartographic.height + height\r\n                                };\r\n\r\n                                return Cesium.Ellipsoid.WGS84.cartographicToCartesian(finalCartographic);\r\n                            };\r\n\r\n                            var markers = self.viewer.entities.values.filter(function (entity) {\r\n                                return entity.billboard;\r\n                            });\r\n\r\n                            if (markers.length > 0) {\r\n                                markers.forEach(function (marker) {\r\n                                    marker.position = addHeight(Cesium.Property.getValueOrUndefined(marker.position, Cesium.JulianDate.now));\r\n                                });\r\n                            }\r\n\r\n                            if (self.viewer.billboardCollection) {\r\n\r\n                                for (var i = 0; i < self.viewer.billboardCollection.length; i++) {\r\n                                    self.viewer.billboardCollection.get(i).position = addHeight(self.viewer.billboardCollection.get(i).position);\r\n                                }\r\n\r\n                                self.viewer.scene.requestRender();\r\n                            }\r\n\r\n                        });\r\n                    }.bind(self));\r\n                });\r\n            });\r\n        } catch (error) {\r\n            loaded();\r\n\r\n            throw error;\r\n        }\r\n    };\r\n\r\n    viewProto.unapply = function (options) {\r\n        const self = this;\r\n\r\n        if (!self.waiting) {\r\n            self.waiting = self.map.getLoadingIndicator().addWait();\r\n        }\r\n\r\n        self.map.on3DView = false;\r\n\r\n        //self.map.view3D = null;\r\n\r\n        self.view3D.cameraControls.resetRotation({ duration: 1000 }).then(function () {\r\n\r\n            var animationCallback = function () {\r\n\r\n                self.map.div.classList.remove(TC.Consts.classes.THREED);\r\n\r\n                /* atribuciones del terreno */\r\n                self.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE, { terrainProvider: self.viewer.scene.terrainProvider });\r\n\r\n                if (self.viewer.scene.terrainProvider.fallbackProvider) {\r\n                    self.viewer.scene.terrainProvider.fallbackProvider.forEach(function (provider) {\r\n                        self.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE, { terrainProvider: provider });\r\n                    });\r\n                }\r\n\r\n                self.view3D.setViewFromCameraView.call(self).then(function () {\r\n                    self.divThreedMap.classList.remove(self.classes.MAPTHREED, self.CLASS + '-divMap-fadeIn');\r\n                    self.divThreedMap.classList.add(self.CLASS + '-divMap-fadeOut');\r\n                    self.mapView.viewHTML.classList.remove(self.CLASS + '-divMap-fadeOut');\r\n                    self.mapView.viewHTML.classList.add(self.CLASS + '-divMap-fadeIn');\r\n\r\n                    self.view3D.destroy.call(self);\r\n\r\n                    self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                    delete self.waiting;\r\n\r\n                    if (options.callback) {\r\n                        options.callback();\r\n                    }\r\n                });\r\n\r\n                self.mapView.setRotation(0);\r\n                self._ovMap.wrap.draw3DCamera(null);\r\n            };\r\n\r\n            var bottom = pickBottomPoint(self.viewer.scene);\r\n            var transform = Cesium.Matrix4.fromTranslation(bottom);\r\n            var angle = computeAngleToZenith(self.viewer.scene, bottom);\r\n\r\n            self.view3D.rotateAroundAxis(self.viewer.scene.camera, -angle, self.viewer.scene.camera.right, transform, {\r\n                duration: 1500,\r\n                callback: animationCallback\r\n            });\r\n        });\r\n    };\r\n\r\n    viewProto.view3D = (function () {\r\n\r\n        var rasterConverter = new RasterConverter(/(EPSG\\:?4326)/i);\r\n        var featureConverter = new FeatureConverter();\r\n\r\n        var overrideDesktopZoom = function () {\r\n            var self = this;\r\n\r\n            if (!TC.Util.detectMobile()) {\r\n                self.viewer.scene.screenSpaceCameraController.enableZoom = false;\r\n\r\n                var element = self.viewer.scene.canvas;\r\n                // detect available wheel event\r\n                var wheelEvent;\r\n                if ('onwheel' in element) {\r\n                    // spec event type\r\n                    wheelEvent = 'wheel';\r\n                } else if (document.onmousewheel !== undefined) {\r\n                    // legacy event type\r\n                    wheelEvent = 'mousewheel';\r\n                } else {\r\n                    // older Firefox\r\n                    wheelEvent = 'DOMMouseScroll';\r\n                }\r\n                element.addEventListener(wheelEvent, function (event) {\r\n                    var delta;\r\n                    // standard wheel event uses deltaY.  sign is opposite wheelDelta.\r\n                    // deltaMode indicates what unit it is in.\r\n                    if (event.deltaY) {\r\n                        var deltaMode = event.deltaMode;\r\n                        if (deltaMode === event.DOM_DELTA_PIXEL) {\r\n                            delta = - event.deltaY;\r\n                        } else if (deltaMode === event.DOM_DELTA_LINE) {\r\n                            delta = - event.deltaY * 40;\r\n                        } else {\r\n                            // DOM_DELTA_PAGE\r\n                            delta = - event.deltaY * 120;\r\n                        }\r\n                    } else if (event.detail > 0) {\r\n                        // old Firefox versions use event.detail to count the number of clicks. The sign\r\n                        // of the integer is the direction the wheel is scrolled.\r\n                        delta = event.detail * -120;\r\n                    } else {\r\n                        delta = event.wheelDelta;\r\n                    }\r\n\r\n                    self.view3D.zoomToCartesian.call(self, self.view3D._lastMousePosition, delta);\r\n\r\n                }, false);\r\n\r\n                var eventHandler = new Cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas);\r\n                eventHandler.setInputAction(function (event) {\r\n                    self.view3D._lastMousePosition = event;\r\n                }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);\r\n                eventHandler.setInputAction(function (wheelZoomAmount) {\r\n                    self.view3D.zoomToCartesian.call(self, self.view3D._lastMousePosition, wheelZoomAmount);\r\n                }, Cesium.ScreenSpaceEventType.WHEEL);\r\n                var pinchCenterPosition = new Cesium.Cartesian2();\r\n                var pinchAmount = 0;\r\n                eventHandler.setInputAction(function (event) {\r\n                    Cesium.Cartesian2.lerp(event.position1, event.position2, 0.5, pinchCenterPosition);\r\n                }, Cesium.ScreenSpaceEventType.PINCH_START);\r\n                eventHandler.setInputAction(function (event) {\r\n                    var diff = event.distance.endPosition.y - event.distance.startPosition.y;\r\n                    var rangeWindowRatio = diff / self.viewer.scene.canvas.clientHeight;\r\n                    rangeWindowRatio = Math.min(rangeWindowRatio, self.viewer.scene.screenSpaceCameraController.maximumMovementRatio);\r\n                    pinchAmount = rangeWindowRatio;\r\n                }, Cesium.ScreenSpaceEventType.PINCH_MOVE);\r\n                eventHandler.setInputAction(function (event) {\r\n                    self.view3D.zoomToCartesian.call(self, { endPosition: pinchCenterPosition }, pinchAmount);\r\n                }, Cesium.ScreenSpaceEventType.PINCH_END);\r\n            }\r\n        };\r\n\r\n        var addFeature = function (csFeature) {\r\n            var addedFeature = csFeature;\r\n            switch (true) {\r\n                case csFeature instanceof Cesium.GroundPrimitive: {\r\n                    this.viewer.scene.groundPrimitives.add(csFeature);\r\n                    break;\r\n                }\r\n                case csFeature instanceof Object && csFeature.hasOwnProperty('billboard'): {\r\n                    if (!this.viewer.billboardCollection) {\r\n                        this.viewer.billboardCollection = this.viewer.scene.primitives.add(new Cesium.BillboardCollection({\r\n                            scene: this.viewer.scene\r\n                        }));\r\n                    }\r\n\r\n                    var billboardAtCollection = this.viewer.billboardCollection.add({\r\n                        position: csFeature.position,\r\n                        image: csFeature.billboard.image,\r\n                        verticalOrigin: csFeature.billboard.verticalOrigin,\r\n                        heightReference: csFeature.billboard.heightReference\r\n                    });\r\n\r\n                    addedFeature = billboardAtCollection;\r\n                    break;\r\n                }\r\n                case csFeature instanceof Object: {\r\n                    addedFeature = this.viewer.entities.getById(csFeature.id);\r\n                    if (!addedFeature) {\r\n                        addedFeature = this.viewer.entities.add(csFeature);\r\n                    }\r\n                    break;\r\n                }\r\n            }\r\n\r\n            this.viewer.scene.requestRender();\r\n\r\n            return addedFeature;\r\n        };\r\n        var linkFeature = function (map, idLayer, feature, id) {\r\n            if (!map.vector2DFeatures.hasOwnProperty(idLayer)) {\r\n                map.vector2DFeatures[idLayer] = {};\r\n                map.vector2DFeatures[idLayer][id] = [feature];\r\n            } else {\r\n                if (!map.vector2DFeatures[idLayer].hasOwnProperty(id)) {\r\n                    map.vector2DFeatures[idLayer][id] = [feature];\r\n                } else {\r\n                    map.vector2DFeatures[idLayer][id].push(feature);\r\n                }\r\n            }\r\n        };\r\n\r\n        var listenTo = [\r\n            TC.Consts.event.BEFOREBASELAYERCHANGE, TC.Consts.event.BASELAYERCHANGE,\r\n            TC.Consts.event.LAYERADD, TC.Consts.event.LAYERREMOVE, TC.Consts.event.LAYERVISIBILITY, TC.Consts.event.LAYEROPACITY, TC.Consts.event.LAYERORDER,\r\n            TC.Consts.event.FEATUREADD, TC.Consts.event.FEATUREREMOVE, TC.Consts.event.FEATURESCLEAR\r\n            /*, TC.Consts.event.ZOOM no encuentro en qué casos debemos escuchar el evento ZOOM de 2D, solo trae problemas */, TC.Consts.event.ZOOMTO];\r\n\r\n        var event2DHandler = function (e) {\r\n            var self = this;\r\n\r\n            switch (true) {\r\n                case e.type == TC.Consts.event.BEFOREBASELAYERCHANGE:\r\n                    if (!self.waiting)\r\n                        self.waiting = self.map.getLoadingIndicator().addWait();\r\n                    break;\r\n                case e.type == TC.Consts.event.BASELAYERCHANGE: {\r\n                    self.view3D.setBaseLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERADD: {\r\n                    self.view3D.addLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERREMOVE: {\r\n                    self.view3D.removeLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERVISIBILITY: {\r\n                    self.view3D.setRenderOptionsLayer.call(self, e.layer, { visibility: e.layer.getVisibility() });\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYEROPACITY: {\r\n                    self.view3D.setRenderOptionsLayer.call(self, e.layer, { opacity: e.layer.getOpacity() });\r\n                    self.viewer.scene.requestRender();\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERORDER: {\r\n                    for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                        if (self.view3D.workLayers[i].imageryProvider && self.view3D.workLayers[i].imageryProvider.layers.join(',') === e.layer.names.join(',')) {\r\n\r\n                            if (e.oldIndex > e.newIndex) {\r\n                                var positions = e.oldIndex - e.newIndex;\r\n                                for (var p = 0; p < positions; p++) {\r\n                                    self.viewer.scene.imageryLayers.lower(self.view3D.workLayers[i]);\r\n                                }\r\n\r\n                            } else {\r\n                                var positions = e.newIndex - e.oldIndex;\r\n                                for (var p = 0; p < positions; p++) {\r\n                                    self.viewer.scene.imageryLayers.raise(self.view3D.workLayers[i]);\r\n                                }\r\n                            }\r\n\r\n                            self.view3D.workLayers.splice(e.newIndex, 0, self.view3D.workLayers.splice(e.oldIndex, 1)[0]);\r\n                            break;\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATUREADD: {                    \r\n                    self.view3D.addFeature.call(self.view3D, e.feature);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATUREREMOVE: {\r\n\r\n                    if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(e.layer.id)) {\r\n\r\n                        const remove = function (feature) {\r\n                            if (self.view3D.vector2DFeatures[e.layer.id].hasOwnProperty(feature.id)) {\r\n                                var threedFeature = self.view3D.vector2DFeatures[e.layer.id][feature.id];\r\n                                for (var i = 0; i < threedFeature.length; i++) {\r\n                                    self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                                }\r\n\r\n                                delete self.view3D.vector2DFeatures[e.layer.id][feature.id];\r\n                            }\r\n                        };\r\n\r\n                        if (e.feature instanceof Array) {\r\n                            e.feature.forEach(remove);\r\n                        } else {\r\n                            remove(e.feature);\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATURESCLEAR: {\r\n\r\n                    if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(e.layer.id)) {\r\n\r\n                        for (var featureId in self.view3D.vector2DFeatures[e.layer.id]) {\r\n                            var threedFeature = self.view3D.vector2DFeatures[e.layer.id][featureId];\r\n\r\n                            for (var i = 0; i < threedFeature.length; i++) {\r\n                                self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                            }\r\n\r\n                            delete self.view3D.vector2DFeatures[e.layer.id][featureId];\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.ZOOM: {\r\n                    if (self.view3D.cameraControls && !self.view3D.cameraControls.moving) {\r\n\r\n                        var width = self.view3D.viewer.scene.canvas.clientWidth;\r\n                        var height = self.view3D.viewer.scene.canvas.clientHeight;\r\n\r\n\r\n                        /* Si hemos llegado aquí y hay un cambio en el tamaño del canvas, \r\n                           viene el evento del resize canvas del mapa de 2D así que paso y no hago nada */\r\n                        if (!self.view3D._canvasClientHeight ||\r\n                            !self.view3D._canvasClientWidth ||\r\n\r\n                            width !== self.view3D._canvasClientWidth ||\r\n                            height !== self.view3D._canvasClientHeight) {\r\n\r\n                            if (!self.view3D._canvasClientWidth) {\r\n                                self.view3D._canvasClientWidth = self.view3D.viewer.scene.canvas.clientWidth;\r\n                            }\r\n\r\n                            if (!self.view3D._canvasClientHeight) {\r\n                                self.view3D._canvasClientHeight = self.view3D.viewer.scene.canvas.clientHeight;\r\n                            }\r\n\r\n                            self.view3D._canvasClientWidth = width;\r\n                            self.view3D._canvasClientHeight = height;\r\n\r\n                            return;\r\n                        }\r\n\r\n                        self.view3D.flyToMapCoordinates.call(self, self.mapView.getCenter());\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.ZOOMTO: {\r\n\r\n                    if (self.lastZoom && performance.now() - self.lastZoom < 50) {\r\n                        return;\r\n                    }\r\n                    self.lastZoom = performance.now();\r\n\r\n                    var coordsXY = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(e.extent.slice(0, 2), self.view3D.view2DCRS, self.view3D.crs) : e.extent.slice(0, 2);\r\n                    var coordsXY2 = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(e.extent.slice(2), self.view3D.view2DCRS, self.view3D.crs) : e.extent.slice(2);\r\n                    var rectangle = Cesium.Rectangle.fromDegrees(coordsXY[0], coordsXY[1], coordsXY2[0], coordsXY2[1]);\r\n\r\n                    self.view3D.flyToRectangle.call(self, rectangle);\r\n                    break;\r\n                }\r\n            }\r\n        };\r\n\r\n        /* geolocation */\r\n        var geolocation_newPosition = function () {\r\n            var self = this;\r\n\r\n            if (!self.view3D.trackingEntity) {\r\n                var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n                var track = geolocation2D.layerTracking.features.filter(function (feature) {\r\n                    return feature.CLASSNAME == \"TC.feature.Polyline\";\r\n                });\r\n\r\n                if (track && track.length > 0) {\r\n\r\n                    var positions = [];\r\n\r\n                    var entityTracking = new Cesium.Entity({\r\n                        id: \"trackingEntity\",\r\n                        polyline: {\r\n                            positions: new Cesium.CallbackProperty(function (time, result) {\r\n                                if (track[0].geometry.length > positions.length) {\r\n                                    var newCartographicPositions = track[0].geometry.slice(positions.length).map(function (coordinate) {\r\n                                        var reprojected = coordinate;\r\n\r\n                                        if (this.view3D.view2DCRS !== this.view3D.crs) {\r\n                                            reprojected = TC.Util.reproject(coordinate, this.view3D.view2DCRS, this.view3D.crs);\r\n                                        }\r\n\r\n                                        return Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1], coordinate[2]);\r\n                                    }.bind(this));\r\n\r\n                                    var updatedPositions = [];\r\n                                    if (newCartographicPositions instanceof Array) {\r\n                                        updatedPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(newCartographicPositions);\r\n                                    } else {\r\n                                        updatedPositions = [Cesium.Ellipsoid.WGS84.cartographicToCartesian(newCartographicPositions)];\r\n                                    }\r\n\r\n                                    positions = positions.concat(updatedPositions);\r\n                                    return positions;\r\n                                }\r\n\r\n                                return positions;\r\n\r\n                            }.bind(this), false),\r\n                            clampToGround: true,\r\n                            width: 3,\r\n                            material: new Cesium.PolylineDashMaterialProperty({\r\n                                color: new Cesium.CallbackProperty(function (time, result) {\r\n                                    self.viewer.scene.requestRender();\r\n                                    return Cesium.Color.fromAlpha(new Cesium.Color(0, 255, 209), geolocation2D.track.renderTrack.checked ? 1 : 0);\r\n                                }.bind(this), false),\r\n                                gapColor: Cesium.Color.TRANSPARENT\r\n                            })\r\n                        }\r\n                    });\r\n\r\n                    self.view3D.trackingEntity = self.viewer.entities.add(entityTracking);\r\n                    self.viewer.scene.requestRender();\r\n                }\r\n            }\r\n        };\r\n        var geolocation_videoControls = function (event) {\r\n            var self = this;\r\n\r\n            var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n            switch (true) {\r\n                case geolocation2D.Const.Event.IMPORTEDTRACK.indexOf(event.type) > -1:\r\n                case event.target.className.indexOf('draw') > -1 && event.target.parentElement.classList.contains(geolocation2D.Const.Classes.SELECTEDTRACK):\r\n                case !(event.target.parentElement && event.target.parentElement.classList.contains(geolocation2D.Const.Classes.SELECTEDTRACK)):\r\n                case event.target.className.indexOf('stop') > -1:\r\n\r\n                    if (self.map.on3DView) {\r\n                        self.viewer.clock.shouldAnimate = false;\r\n                        self.viewer.clock.currentTime = Cesium.JulianDate.fromDate(new Date());\r\n                    }\r\n\r\n                    if (self.view3D.trackDataSource) {\r\n                        if (self.view3D.trackDataSource.length > 0) {\r\n                            var entity = self.view3D.trackDataSource.get(0).entities.values[0];\r\n                            self.viewer.entities.removeById(entity.id);\r\n                        }\r\n\r\n                        self.view3D.trackDataSource.destroy();\r\n                        delete self.view3D.trackDataSource;\r\n                    }\r\n\r\n                    geolocation2D.chartProgressClear();\r\n\r\n                    if (event.custom) {\r\n                        const selectedTrack = geolocation2D.getSelectedTrack();\r\n                        if (selectedTrack) {\r\n                            selectedTrack.querySelector(geolocation2D.Const.Selector.STOP).click();\r\n                        }\r\n                    }\r\n                    break;\r\n                case event.target.className.indexOf('play') > -1:\r\n                    self.viewer.clock.shouldAnimate = false;\r\n                    break;\r\n                case event.target.className.indexOf('pause') > -1:\r\n                    self.viewer.clock.shouldAnimate = true;\r\n                    break;\r\n                case event.target.className.indexOf('back') > -1:\r\n                case event.target.className.indexOf('for') > -1:\r\n                    self.viewer.clock.multiplier = geolocation2D.simulate_speed;\r\n                    break;\r\n            }\r\n        };\r\n        /* fin geolocation */\r\n\r\n        var alterAllowedControls = function (view) {\r\n            var self = this;\r\n\r\n            const ctrlsToMngCLASS = self.ctrlsToMng.map(function (ctrl) { return ctrl.CLASS });\r\n\r\n            self.map.controls.forEach(function (mapCtrl) {\r\n                if (ctrlsToMngCLASS.indexOf(mapCtrl.CLASS) < 0) {\r\n                    switch (true) {\r\n                        case (TC.Consts.view.DEFAULT == view):\r\n                            mapCtrl.enable();\r\n                            break;\r\n                        case (TC.Consts.view.THREED == view):\r\n                            mapCtrl.disable();\r\n                            break;\r\n                    }\r\n                }\r\n            });\r\n\r\n            switch (true) {\r\n                case (TC.Consts.view.DEFAULT == view):\r\n                    document.querySelectorAll('[data-no-3d]').forEach(function (elm) {\r\n                        elm.classList.remove(TC.Consts.classes.THREED_HIDDEN);\r\n                    });\r\n                    self.ctrlsToMng.forEach(function (ctl) {\r\n                        ctl.div.classList.remove(TC.Consts.classes.THREED);\r\n                    });\r\n                    break;\r\n                case (TC.Consts.view.THREED == view):\r\n                    document.querySelectorAll('[data-no-3d]').forEach(function (elm) {\r\n                        elm.classList.add(TC.Consts.classes.THREED_HIDDEN);\r\n                    });\r\n                    self.ctrlsToMng.forEach(function (ctl) {\r\n                        ctl.div.classList.add(TC.Consts.classes.THREED);\r\n                    });\r\n                    break;\r\n            }\r\n\r\n            if (TC.Consts.view.THREED === view) {\r\n\r\n                if (!self.view3D.linked2DControls.featureInfo) {\r\n                    self.view3D.linked2DControls.featureInfo = new TwoDLinkedFeatureInfo(self);\r\n                }\r\n\r\n                const onLeftClickOnCanvas = (movement) => {\r\n\r\n                    // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                    if (self.viewer.trackedEntity) {\r\n                        return;\r\n                    }\r\n\r\n                    const getFeatureInfo = function () {\r\n                        var ray = self.viewer.camera.getPickRay(movement.position);\r\n                        var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n                        if (position) {\r\n                            self.view3D.getInfoOnPickedPosition.call(self, position);\r\n                        }\r\n                    };\r\n\r\n                    var pickedFeature = self.viewer.scene.pick(movement.position);\r\n                    if (pickedFeature && pickedFeature.id) {\r\n                        var id = pickedFeature.id instanceof Cesium.Entity ? pickedFeature.id.name : pickedFeature.id;\r\n\r\n                        var founded = false;\r\n                        for (var layerId in self.view3D.vector2DFeatures) {\r\n                            if (self.view3D.vector2DFeatures[layerId].hasOwnProperty(id)) {\r\n                                var feature2D = self.map.workLayers.filter(function (workLayer) {\r\n                                    return workLayer.id === layerId;\r\n                                })[0].features.filter(function (feature) {\r\n                                    return id.indexOf(feature.id) > -1 && feature.showsPopup;\r\n                                });\r\n\r\n                                if (feature2D && feature2D.length > 0) {\r\n                                    founded = true;\r\n\r\n                                    if (feature2D.CLASSNAME !== \"TC.feature.Point\" && feature2D.CLASSNAME !== \"TC.feature.Marker\") {\r\n\r\n                                        var ray = self.viewer.camera.getPickRay(movement.position);\r\n                                        var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n\r\n                                        var marker = self.map.view3D.addNativeFeature.call(self.map, {\r\n                                            position: position,\r\n                                            billboard: {\r\n                                                image: TC.Util.getBackgroundUrlFromCss(self.CLASS + '-marker'),\r\n                                                eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                            }\r\n                                        });\r\n\r\n                                        const onDrawTable = function (e) {\r\n                                            if (e.control) {\r\n                                                const control = e.control;\r\n                                                const onTableClose = function (e) {\r\n                                                    if (e.control === control) {\r\n                                                        self.map.off(TC.Consts.event.RESULTSPANELCLOSE, onTableClose);\r\n                                                        self.map.view3D.removeFeature.call(self, marker);\r\n                                                    }\r\n                                                };\r\n                                                self.map.on(TC.Consts.event.RESULTSPANELCLOSE, onTableClose);\r\n                                                self.map.off(TC.Consts.event.DRAWTABLE, onDrawTable);\r\n                                            }\r\n                                        }\r\n                                        self.map.on(TC.Consts.event.DRAWTABLE, onDrawTable);\r\n                                    }\r\n\r\n                                    self.map.trigger(TC.Consts.event.FEATURECLICK, { feature: feature2D[0] });\r\n\r\n                                    break;\r\n                                }\r\n\r\n                            }\r\n                        }\r\n\r\n                        if (!founded) {\r\n                            getFeatureInfo();\r\n                        }\r\n                    } else {\r\n                        getFeatureInfo();\r\n                    }\r\n                };\r\n                var eventHandler = new Cesium.ScreenSpaceEventHandler(self.viewer.canvas, false);\r\n                eventHandler.setInputAction(onLeftClickOnCanvas, Cesium.ScreenSpaceEventType.LEFT_CLICK);\r\n\r\n                const onMouseMoveOnCanvas = (movement) => {\r\n                    // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                    if (self.viewer.trackedEntity) {\r\n                        return;\r\n                    }\r\n                    var pickedFeature = self.viewer.scene.pick(movement.endPosition);\r\n                    if (pickedFeature && pickedFeature.id) {\r\n                        self.viewer.canvas.style.cursor = 'pointer';\r\n                    } else {\r\n                        self.viewer.canvas.style.cursor = 'default';\r\n                    }\r\n                };\r\n                var eventHandler = new Cesium.ScreenSpaceEventHandler(self.viewer.canvas, false);\r\n                eventHandler.setInputAction(onMouseMoveOnCanvas, Cesium.ScreenSpaceEventType.MOUSE_MOVE);\r\n            }\r\n\r\n            if (!self.view3D.linked2DControls.geolocation && self.allowedControls.indexOf(\"geolocation\") > -1) {\r\n                self.view3D.linked2DControls.geolocation = self.ctrlsToMng.filter(function (ctrl) {\r\n                    return ctrl instanceof TC.control.Geolocation;\r\n                })[0];\r\n            }\r\n\r\n            if (self.view3D.linked2DControls.geolocation) {\r\n\r\n                var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n\r\n                if (TC.Consts.view.THREED === view) {\r\n\r\n                    var commands = [geolocation2D.Const.Selector.STOP,\r\n                    geolocation2D.Const.Selector.PAUSE,\r\n                    geolocation2D.Const.Selector.BACKWARD,\r\n                    geolocation2D.Const.Selector.FORWARD,\r\n                    geolocation2D.Const.Selector.DRAW];\r\n                    var geolocation_videoControls_ = geolocation_videoControls.bind(self);\r\n\r\n                    var lstEventListener = function (e) {\r\n                        var classes = commands;\r\n                        if (commands.some(function (cls) {\r\n                            return e.target.classList.contains(cls.replace('.', ''))\r\n                        })) {\r\n                            geolocation_videoControls_(e);\r\n                        }\r\n                    };\r\n\r\n                    geolocation2D.reset = function () {\r\n\r\n                        TC.wrap.control.Geolocation.prototype.setTracking = geolocation2D._setTracking;\r\n                        TC.wrap.control.Geolocation.prototype.simulateTrack = geolocation2D._wrap_simulateTrack;\r\n                        TC.wrap.control.Geolocation.prototype.showElevationMarker = geolocation2D._wrap_showElevationMarker;\r\n                        TC.wrap.control.Geolocation.prototype.hideElevationMarker = geolocation2D._wrap_hideElevationMarker;\r\n\r\n                        geolocation2D.simulateTrack = geolocation2D._simulateTrack;\r\n                        geolocation2D.elevationTrack = geolocation2D._elevationTrack;\r\n\r\n                        commands.forEach(function (command) {\r\n                            document.removeEventListener('click', lstEventListener);\r\n                        });\r\n\r\n                        geolocation2D.off(geolocation2D.Const.Event.IMPORTEDTRACK, geolocation_videoControls_);\r\n\r\n                    };\r\n\r\n                    document.addEventListener('click', lstEventListener);\r\n\r\n                    geolocation2D.on(geolocation2D.Const.Event.IMPORTEDTRACK, geolocation_videoControls_);\r\n\r\n                    /* provisional hasta el refactoring del panel de resultados */\r\n                    var _newPosition = false;\r\n                    geolocation2D._setTracking = TC.wrap.control.Geolocation.prototype.setTracking;\r\n                    TC.wrap.control.Geolocation.prototype.setTracking = function (tracking) {\r\n\r\n                        geolocation2D._setTracking.call(geolocation2D.wrap, tracking);\r\n\r\n                        if (tracking) {\r\n                            geolocation2D.on(geolocation2D.Const.Event.POSITIONCHANGE, geolocation_newPosition.bind(self));\r\n                        } else {\r\n                            _newPosition = false;\r\n                            geolocation2D.off(geolocation2D.Const.Event.POSITIONCHANGE, geolocation_newPosition.bind(self));\r\n                            if (self.view3D.trackingEntity) {\r\n                                self.viewer.entities.removeById(self.view3D.trackingEntity.id);\r\n                                delete self.view3D.trackingEntity;\r\n                            }\r\n                        }\r\n                    };\r\n\r\n                    geolocation2D._elevationTrack = geolocation2D.elevationTrack;\r\n                    geolocation2D.elevationTrack = function (li, resized) {\r\n\r\n                        if (resized) {\r\n                            geolocation_videoControls.call(self, { target: { className: 'stop' }, custom: true });\r\n                        }\r\n\r\n                        return geolocation2D._elevationTrack.call(geolocation2D, li, resized);\r\n                    };\r\n\r\n                    // Si en el paso de 2D a 3D hay perfil dibujado, lanzamos el resize\r\n                    const selectedTrack = geolocation2D.getSelectedTrack();\r\n                    if (selectedTrack && geolocation2D.hasElevation) {\r\n                        geolocation2D.elevationTrack.call(self, selectedTrack, true);\r\n                    }\r\n\r\n                    var simulationOnPreUpdate; // listener de la simulación.\r\n                    geolocation2D._simulateTrack = geolocation2D.simulateTrack;\r\n                    geolocation2D.simulateTrack = function (li) {\r\n                        var self = this.view3D.linked2DControls.geolocation;\r\n\r\n                        self.map.toast(self.getLocaleString('threed.interactionSimulation'), { type: TC.Consts.msgType.INFO });\r\n\r\n                        // tenemos una simulación activa\r\n                        if (this.viewer.clock.shouldAnimate && this.view3D.trackDataSource) {\r\n                            simulationOnPreUpdate();\r\n                            geolocation_videoControls.call(this, { target: { className: 'stop' }, custom: true });\r\n                        }\r\n\r\n                        self.simulate_speed = 1;\r\n                        self.drawTrack(li, false).then(function () {\r\n                            self.wrap.simulateTrack();\r\n\r\n                            if (self.layerTrack && self.layerTrack.features) {\r\n                                var track = self.layerTrack.features.filter(function (feature) {\r\n                                    return feature.CLASSNAME == \"TC.feature.Polyline\";\r\n                                })[0];\r\n\r\n                                if (track) {\r\n                                    toCZML.call(this, track.geometry, track.wrap.feature.getGeometry().layout, \"track\", self.markerStyle, self.lineStyle, self.walkingSpeed).then(function (result) {\r\n                                        var czml = result.czml, totalDistance = result.totalDistance, coordinates2D = result.coordinates2D;\r\n\r\n                                        this.view3D.trackDataSource = new Cesium.DataSourceCollection();\r\n                                        var dataSourceDisplay = new Cesium.DataSourceDisplay({\r\n                                            scene: this.viewer.scene,\r\n                                            dataSourceCollection: this.view3D.trackDataSource\r\n                                        });\r\n\r\n                                        this.viewer.scene.preRender.addEventListener(function (scene, time) {\r\n                                            dataSourceDisplay.update(time);\r\n                                        });\r\n\r\n                                        this.view3D.trackDataSource.add(Cesium.CzmlDataSource.load(czml)).then(function (layout, coordinates2D, czmlDataSource) {\r\n\r\n                                            this.viewer.clock.shouldAnimate = false;\r\n\r\n                                            var start, stop;\r\n                                            start = czmlDataSource.clock.startTime;\r\n                                            stop = czmlDataSource.clock.stopTime;\r\n\r\n                                            this.viewer.clock.startTime = start.clone();\r\n                                            this.viewer.clock.stopTime = stop.clone();\r\n                                            this.viewer.clock.currentTime = start.clone();\r\n                                            this.viewer.clock.clockStep = Cesium.ClockStep.TICK_DEPENDENT\r\n                                            this.viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;\r\n                                            this.viewer.clock.multiplier = 1;\r\n\r\n                                            var trackEntity = czmlDataSource.entities.values[0];\r\n\r\n                                            trackEntity.layout = layout;\r\n\r\n                                            trackEntity.tagLI = li; // tengo que guardar la relación con el HTML porque puede eliminar la selección del track mientras estamos creando la simulación del mismo, y no tengo forma de validarlo\r\n\r\n                                            trackEntity.availability = new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({\r\n                                                start: start,\r\n                                                stop: stop\r\n                                            })]);\r\n\r\n                                            if (this.viewer.trackedEntity) {\r\n                                                this.viewer.entities.removeById(this.viewer.trackedEntity.id);\r\n                                                this.viewer.trackedEntity = null;\r\n                                            }\r\n\r\n                                            this.viewer.entities.add(trackEntity);\r\n\r\n                                            this.viewer.flyTo(trackEntity).then(function () {\r\n\r\n                                                this.viewer.trackedEntity = trackEntity;\r\n\r\n                                                function get2DHeightAtProgress(coordinates2D, distanceCurrent) {\r\n                                                    var coordinate;\r\n\r\n                                                    var doneDistance = 0;\r\n\r\n                                                    var reprojected = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coordinates2D[0], this.view3D.view2DCRS, this.view3D.crs) : coordinates2D[0];\r\n                                                    var previous = new Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n\r\n                                                    for (var i = 1; i < coordinates2D.length; i++) {\r\n                                                        reprojected = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coordinates2D[i], this.view3D.view2DCRS, this.view3D.crs) : coordinates2D[i];\r\n                                                        var current = new Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n\r\n                                                        doneDistance += new Cesium.EllipsoidGeodesic(previous, current).surfaceDistance;\r\n                                                        previous = current;\r\n\r\n                                                        if (doneDistance > distanceCurrent) {\r\n                                                            coordinate = coordinates2D[i - 1];\r\n                                                            break;\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    if (coordinate) {\r\n                                                        var heightIndex = trackEntity.layout === ol.geom.GeometryLayout.XYZM ? 2 :\r\n                                                            trackEntity.layout === ol.geom.GeometryLayout.XYZ ? 2 : -1;\r\n                                                        if (heightIndex > -1) {\r\n                                                            return coordinate[heightIndex];\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    return 0;\r\n                                                };\r\n\r\n                                                var previousPosition, distanceCurrent = 0;\r\n                                                simulationOnPreUpdate = this.viewer.scene.preUpdate.addEventListener(function (scene, currentTime) {\r\n\r\n                                                    // mientras estamos preparando la simulación ha eliminado la selección de dicho track \r\n                                                    const selectedTrack = this.view3D.linked2DControls.geolocation.getSelectedTrack();\r\n                                                    if (!selectedTrack || selectedTrack.getAttribute('data-id') !== trackEntity.tagLI.getAttribute('data-id') ||\r\n                                                        // o hemos llegado al final\r\n                                                        Cesium.JulianDate.greaterThanOrEquals(currentTime, trackEntity.availability.stop)) {\r\n\r\n                                                        simulationOnPreUpdate();\r\n                                                        geolocation_videoControls.call(this, { target: { className: 'stop' }, custom: true });\r\n\r\n                                                    } else if (this.viewer.clock.shouldAnimate && trackEntity.isAvailable(currentTime)) {\r\n\r\n                                                        // gestionamos las posiciones anterior y actual\r\n                                                        if (!previousPosition) {\r\n                                                            previousPosition = Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(trackEntity.position, trackEntity.availability.start));\r\n                                                        }\r\n                                                        currentPosition = Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(trackEntity.position, currentTime));\r\n\r\n                                                        // progreso en el perfil (si lo hay)\r\n                                                        if (this.view3D.linked2DControls.geolocation.hasElevation) {\r\n                                                            var timeIndex = trackEntity.layout === ol.geom.GeometryLayout.XYZM ? 3 :\r\n                                                                trackEntity.layout === ol.geom.GeometryLayout.XYM ? 2 : 3;\r\n\r\n                                                            this.view3D.linked2DControls.geolocation.chartSetProgress({\r\n                                                                p: [previousPosition.longitude, previousPosition.latitude, previousPosition.height],\r\n                                                                d: distanceCurrent\r\n                                                            },\r\n                                                                [currentPosition.longitude, currentPosition.latitude, get2DHeightAtProgress.call(this, coordinates2D, distanceCurrent)],\r\n                                                                totalDistance, (trackEntity.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                                    trackEntity.layout === ol.geom.GeometryLayout.XYM ?\r\n                                                                    this.view3D.linked2DControls.geolocation._getTime(Cesium.JulianDate.toDate(trackEntity.availability.start), Cesium.JulianDate.toDate(currentTime)) : false));\r\n                                                        }\r\n\r\n                                                        // gestionamos las posiciones anterior y actual y la distancia\r\n                                                        distanceCurrent += new Cesium.EllipsoidGeodesic(previousPosition, currentPosition).surfaceDistance;\r\n                                                        previousPosition = currentPosition;\r\n\r\n                                                        this.viewer.scene.requestRender();\r\n                                                    }\r\n                                                }.bind(this));\r\n\r\n                                                this.viewer.clock.shouldAnimate = true;\r\n\r\n                                            }.bind(this));\r\n\r\n                                            //self.view3D.customRender.restart();\r\n                                            this.viewer.scene.requestRender();\r\n\r\n                                        }.bind(this, track.wrap.feature.getGeometry().layout, coordinates2D));\r\n                                    }.bind(this));\r\n                                }\r\n                            }\r\n                        }.bind(this));\r\n\r\n                    }.bind(self);\r\n\r\n                    geolocation2D._wrap_simulateTrack = TC.wrap.control.Geolocation.prototype.simulateTrack;\r\n                    TC.wrap.control.Geolocation.prototype.simulateTrack = function () {\r\n                        var self = this;\r\n\r\n                        //if (self.parent.hasElevation) {\r\n                        //    self.parent.chartProgressInit();\r\n                        //}\r\n                    };\r\n\r\n                    geolocation2D._wrap_showElevationMarker = TC.wrap.control.Geolocation.prototype.showElevationMarker;\r\n                    TC.wrap.control.Geolocation.prototype.showElevationMarker = function (data) {\r\n                        const self = this.view3D.linked2DControls.geolocation;\r\n                        const coords = self.elevationChartData.coords;\r\n\r\n                        // GLS: si la capa del track está visible mostramos marcamos punto del gráfico en el mapa\r\n                        if (self.layerTrack.getVisibility() && self.layerTrack.getOpacity() > 0) {\r\n\r\n                            var camera = this.viewer.camera;\r\n                            var elevationMarkerPosition = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coords[data[0].index], this.view3D.view2DCRS, this.view3D.crs) : coords[data[0].index];\r\n\r\n                            if (!self.elevationMarker) {\r\n\r\n                                var billboard = new Cesium.Entity({\r\n                                    position: Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1]),\r\n                                    name: 'elevationMarker',\r\n                                    billboard: {\r\n                                        image: \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AcdDDMq7Am38gAAAaFJREFUWMPtlj9rwkAYh3+R0lgKRSi4FCFmczBzp2i+gaMgmK0I3Tq0Y6HDDd0L0tJBSyGbAT9AxI+goFskumUUrDq9XVRi6WkS/xXquyRc7nie++XuOOBYx/rvJYQdqKoqNE1barMsC81mc/cCqqri+eWVfvt2f3sjBJE4CSMwn/kkXVpqj7bL0DQtUAqRTf9hhixkyAo9PnLoRbhWQNd1KIoSGqAoysrxkXXwh8cnMsw6McYCwxljMMw6GWadeBIrBSRJwnA0hivryOULgSQYY8jlC+TKOoajMWKx2Ga7wJV15OwKARCm06lv+FYX4TwJURS5fURR9A0PJBC3q0sSvH5eeLRd3t5BlEomALsKVy6CN7tJuoSJR3g4+tpeAt3eAKlkYpHEurRSycTmArVaDRfnZ7Poi74k5vBub4DT6zsAwFX8Eo7jBBdotVowjU8hbld8SXjhrlyctVXw8f4m8AR87+mO7VADWWogSx27T0S0eHrfO3bf088JdYAFkvDWzuB+JHYOXyWxNzhPYq9wfhJ7hP+UOAjc74XjWH++vgFLJ1bBWXZtUAAAAABJRU5ErkJggg==\",\r\n                                        eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                    }\r\n                                });\r\n\r\n                                self.elevationMarker = this.view3D.addNativeFeature.call(this, billboard);\r\n                            } else {\r\n                                self.elevationMarker.position = Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1], camera.positionCartographic.height);\r\n                                this.viewer.scene.requestRender();\r\n                            }\r\n\r\n                            // No ubicar la camara en el marker\r\n                            //var rectangle = camera.computeViewRectangle();\r\n                            //if (elevationMarkerPosition[0] >= rectangle.west && elevationMarkerPosition[0] <= rectangle.east && elevationMarkerPosition[1] >= rectangle.south && elevationMarkerPosition[1] <= rectangle.north) { }\r\n                            //else {\r\n                            //    var distance = Cesium.Cartesian3.distance(camera.position, Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1]));\r\n                            //    camera.setView({\r\n                            //        destination: Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1])\r\n                            //    });\r\n\r\n                            //    camera.moveBackward(distance);\r\n                            //}\r\n                        }\r\n                    }.bind(self);\r\n\r\n                    geolocation2D._wrap_hideElevationMarker = TC.wrap.control.Geolocation.prototype.hideElevationMarker;\r\n                    TC.wrap.control.Geolocation.prototype.hideElevationMarker = function () {\r\n                        const self = this.view3D.linked2DControls.geolocation;\r\n\r\n                        this.view3D.removeFeature.call(this, self.elevationMarker);\r\n                        self.elevationMarker = null;\r\n                    }.bind(self);\r\n\r\n\r\n\r\n                } else {\r\n                    // Si en el paso de 3D a 2D hay perfil dibujado, lanzamos el resize\r\n                    const selectedTrack = self.view3D.linked2DControls.geolocation.getSelectedTrack();\r\n                    if (selectedTrack && self.view3D.linked2DControls.geolocation.hasElevation) {\r\n\r\n                        geolocation2D._elevationTrack.call(self.view3D.linked2DControls.geolocation, selectedTrack, true);\r\n                    }\r\n                }\r\n            }\r\n\r\n        };\r\n\r\n        var draw2DDrawedFeatures = function () {\r\n            var self = this;\r\n\r\n            self.map.workLayers.filter(function (layer) {\r\n                return layer instanceof TC.layer.Vector;\r\n            }).forEach(function (vectorLayer) {\r\n                vectorLayer.features.forEach(function (feature) {\r\n                    self.view3D.addFeature.call(self.view3D, feature);\r\n                });\r\n            });\r\n        };\r\n\r\n        var initialExtent, zoomin, zoomout;\r\n        var override2DZoom = function (activate) {\r\n            var self = this;\r\n\r\n            var amount = 200.0;\r\n\r\n            var zoom = function (amount) {\r\n                var self = this;\r\n\r\n                var center = new Cesium.Cartesian2(\r\n                    self.viewer.scene.canvas.clientWidth / 2,\r\n                    self.viewer.scene.canvas.clientHeight / 2);\r\n\r\n                /*\r\n                var x = center.x;\r\n                var y = center.y;\r\n                var event = new window.WheelEvent (\"wheel\", {deltaY: -100,\r\n                    deltaMode: 0,\r\n                    DOM_DELTA_PIXEL: 0,\r\n                    DOM_DELTA_LINE: 1,\r\n                    detail: 0,\r\n                    wheelDelta: 120,\r\n                    layerX: x, layerY: y,\r\n                    clientX: x, clientY: y,\r\n                    offsetX: x, offsetY: y,\r\n                    pageX: x, pageY: y,\r\n                    screenX: x, screenY: y\r\n                });\r\n                self.viewer.scene.canvas.dispatchEvent(event);*/\r\n\r\n                self.view3D.zoomToCartesian.call(self, { endPosition: center }, amount);\r\n            };\r\n\r\n            if (activate) {\r\n                initialExtent = function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var sourceCRS = self.view3D.view2DCRS;\r\n                    if (self.map.options.crs !== self.view3D.view2DCRS) {\r\n                        sourceCRS = self.map.options.crs;\r\n                    }\r\n\r\n                    var coordsXY = TC.Util.reproject(self.map.options.initialExtent.slice(0, 2), sourceCRS, self.view3D.crs);\r\n                    var coordsXY2 = TC.Util.reproject(self.map.options.initialExtent.slice(2), sourceCRS, self.view3D.crs);\r\n                    var rectangle = Cesium.Rectangle.fromDegrees(coordsXY[0], coordsXY[1], coordsXY2[0], coordsXY2[1]);\r\n\r\n                    self.view3D.flyToRectangle.call(self, rectangle, { duration: 0.1 });\r\n\r\n                    return false;\r\n\r\n                }.bind(self);\r\n\r\n                zoomin = function (e) {\r\n                    zoom.call(self, amount);\r\n                }.bind(self);\r\n\r\n                zoomout = function (e) {\r\n                    zoom.call(self, -amount);\r\n                }.bind(self);\r\n\r\n                document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn').forEach(function (button) {\r\n                    button.addEventListener('click', initialExtent);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomin').forEach(function (button) {\r\n                    button.addEventListener('click', zoomin);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomout').forEach(function (button) {\r\n                    button.addEventListener('click', zoomout);\r\n                });\r\n            }\r\n            else {\r\n                document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn').forEach(function (button) {\r\n                    button.removeEventListener('click', initialExtent);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomin').forEach(function (button) {\r\n                    button.removeEventListener('click', zoomin);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomout').forEach(function (button) {\r\n                    button.removeEventListener('click', zoomout);\r\n                });\r\n            }\r\n        };\r\n\r\n        const fromTCtoCesiumEvent = function (eventTC) {\r\n            if (TC.Consts.event.MOUSEMOVE === eventTC) {\r\n                return TC.Util.detectMobile() ? Cesium.ScreenSpaceEventType.LEFT_CLICK : Cesium.ScreenSpaceEventType.MOUSE_MOVE;\r\n            } else if (TC.Consts.event.CLICK === eventTC) {\r\n                return Cesium.ScreenSpaceEventType.LEFT_CLICK;\r\n            }\r\n\r\n            return eventTC;\r\n        };\r\n\r\n        return {\r\n\r\n            container: null,\r\n\r\n            crs: 'EPSG:4326',\r\n            crsPattern: /(EPSG\\:?4326)/i,\r\n\r\n            view2DCRS: null,\r\n\r\n            customRender: null,\r\n\r\n            baseLayer: null,\r\n\r\n            workLayers: [],\r\n            vector2DLayers: [],\r\n            vector2DFeatures: {\r\n            },\r\n\r\n            linked2DControls: {\r\n            },\r\n\r\n            isLoadingTiles: function () {\r\n                var self = this;\r\n\r\n                var surface = self.viewer.scene.globe['_surface'];\r\n                return !surface['_tileProvider'].ready ||\r\n                    surface['_tileLoadQueueHigh'].length > 0 ||\r\n                    surface['_tileLoadQueueMedium'].length > 0 ||\r\n                    surface['_tileLoadQueueLow'].length > 0 ||\r\n                    surface['_debug']['tilesWaitingForChildren'] > 0;\r\n            },\r\n\r\n            loadViewer: function () {\r\n                const self = this;\r\n                return new Promise(function (resolve, reject) {\r\n                    if (!self.viewer) {\r\n\r\n                        TC.loadJS(!window.Cesium, TC.Consts.url.CESIUM, function () {\r\n\r\n                            var resourceBoundaries = Cesium.Resource.fetchJson({ url: TC.apiLocation + \"/dataSource/contornoNavarra.json\" }).then(function (bounds) {\r\n                                if (bounds && bounds.features && bounds.features.length > 0) {\r\n                                    return bounds.features[0].geometry.coordinates[0];\r\n                                } else {\r\n                                    return [];\r\n                                }\r\n                            });\r\n\r\n                            Cesium.when.all([Cesium.ApproximateTerrainHeights.initialize(), resourceBoundaries], function () {\r\n\r\n                                var boundaries = Array.prototype.slice.call(arguments[0])[1];\r\n\r\n                                var terrainFallback;\r\n                                if (self.terrainFallback) {\r\n                                    terrainFallback = {\r\n                                        url: self.terrainFallback.url.trim(),\r\n                                        layerName: self.terrainFallback.layerName,\r\n                                        format: self.terrainFallback.format,\r\n                                        noDataValue: self.terrainFallback.noDataValue\r\n                                    };\r\n                                }\r\n\r\n                                var terrainProvider;\r\n                                if (terrainFallback) {\r\n                                    terrainProvider = new Cesium.MergeTerrainProvider(self.terrain, self, {\r\n                                        boundaries: boundaries,\r\n                                        fallback: [terrainFallback]\r\n                                    });\r\n                                } else {\r\n                                    terrainProvider = new Cesium.CesiumTerrainProvider({\r\n                                        url: self.terrain.url.trim()\r\n                                    });\r\n\r\n                                    terrainProvider.sampleTerrainMostDetailed = function (positions) {\r\n                                        return Cesium.sampleTerrainMostDetailed(terrainProvider, positions);\r\n                                    };\r\n\r\n                                    terrainProvider.attributions = {\r\n                                    };\r\n\r\n                                    if (self.terrain.attributions) {\r\n\r\n                                        terrainProvider.getAttribution = function () {\r\n                                            return terrainProvider.attributions;\r\n                                        };\r\n\r\n                                        terrainProvider.attributions = self.terrain.attributions;\r\n                                        self.map.trigger(TC.Consts.event.TERRAINPROVIDERADD, { terrainProvider: terrainProvider });\r\n                                    }\r\n                                }\r\n\r\n                                var globe = new Cesium.Globe();\r\n                                globe.baseColor = Cesium.Color.WHITE;\r\n                                globe.enableLighting = false;\r\n\r\n                                /* carga más rápido pero consume RAM a cascoporro */\r\n                                globe.tileCacheSize = 1000;\r\n\r\n                                /* por defecto 2, a mayor número mayor rendimiento y peor calidad visual */\r\n                                globe.maximumScreenSpaceError = 5;\r\n\r\n                                self.viewer = self.view3D.viewer = new Cesium.Viewer(self.selectors.divThreedMap, {\r\n                                    terrainProvider: terrainProvider,\r\n                                    terrainExaggeration: 1.0,\r\n\r\n                                    animation: false,\r\n                                    timeline: false,\r\n                                    fullscreenButton: false,\r\n                                    baseLayerPicker: false,\r\n                                    imageryProvider: false,\r\n                                    navigationInstructionsInitiallyVisible: false,\r\n                                    navigationHelpButton: false,\r\n                                    geocoder: false,\r\n                                    homeButton: false,\r\n                                    infoBox: false,\r\n                                    sceneModePicker: false,\r\n                                    selectionIndicator: false,\r\n                                    globe: globe,\r\n\r\n                                    skyBox: false,\r\n                                    skyAtmosphere: false,\r\n\r\n                                    requestRenderMode: true,\r\n                                    maximumRenderTimeChange: Infinity\r\n                                });\r\n\r\n                                // personalización de la escena\r\n                                self.viewer.scene.backgroundColor = Cesium.Color.WHITE;\r\n                                self.viewer.scene.screenSpaceCameraController.enableCollisionDetection = true;\r\n                                self.viewer.scene.screenSpaceCameraController.maximumZoomDistance = 1000000;\r\n\r\n                                //// con false las líneas se manetienen sobre el terreno\r\n                                //self.viewer.scene.globe.depthTestAgainstTerrain = false;\r\n\r\n                                // borramos cualquier capa que haya\r\n                                self.viewer.scene.imageryLayers.removeAll();\r\n\r\n                                // registramos listeners para capturar errores del terreno y del render\r\n                                self.viewer.terrainProvider.errorEvent.addEventListener(function (e) {\r\n                                    var self = this;\r\n                                    if (e.error) {\r\n                                        switch (e.error.statusCode) {\r\n                                            case 403:\r\n                                            case 404:\r\n                                                console.log('es un 404 de terreno');\r\n                                                break;\r\n                                        }\r\n                                    }\r\n                                }, self);\r\n                                self.viewer.scene.renderError.addEventListener(function (target, error) {\r\n                                    var self = this;\r\n\r\n                                    if (error && error.code === 18) { // GLS: 18 - SECURITY_ERR                              \r\n\r\n                                    } else {\r\n                                        self.divThreedMap.classList.remove(self.classes.LOADING);\r\n                                        self.map.toast(self.getLocaleString(\"fi.error\"), { type: TC.Consts.msgType.ERROR });\r\n\r\n                                        self.unapply();\r\n                                    }\r\n                                }, self);\r\n\r\n                                self.viewer.readyPromise = new Promise(function (resolve, reject) {\r\n\r\n                                    // controlamos la carga de tiles para mostrar loading cuando pida tiles\r\n                                    self.view3D.tileLoadingHandler = new Cesium.EventHelper();\r\n                                    self.view3D.tileLoadingHandler.add(self.viewer.scene.globe.tileLoadProgressEvent, function (data) {\r\n                                        if (!self.waiting)\r\n                                            self.waiting = self.map.getLoadingIndicator().addWait();\r\n\r\n                                        if ((self.viewer.scene.terrainProvider.allReady ||\r\n                                            (!self.viewer.scene.terrainProvider.allReady && self.viewer.scene.terrainProvider.ready))\r\n                                            && data === 0) {\r\n                                            self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                                            delete self.waiting;\r\n\r\n                                            resolve();\r\n\r\n                                            self.events.trigger(TC.Consts.event.TERRAINLOADED, {});\r\n                                        } else {\r\n                                            self.events.trigger(TC.Consts.event.TERRAINRECEIVING, {});\r\n                                        }\r\n                                    }.bind(self));\r\n                                });\r\n\r\n                                // deshabilitamos el zoom por defecto y manejamos nosotros zoom con rueda\r\n                                //overrideDesktopZoom.call(self);\r\n                                // sobrescribimos el comportamiento de lo botones + /- y la casita\r\n                                override2DZoom.call(self, true);\r\n\r\n                                // eliminamos los creditos de cesium (no encuentro la manera de que no los ponga)\r\n                                document.querySelectorAll('.cesium-viewer-bottom').forEach(function (elm) {\r\n                                    elm.parentElement.removeChild(elm);\r\n                                });\r\n\r\n                                // enlazamos con los eventos del mapa 2D\r\n                                self.view3D._event2DHandler = event2DHandler.bind(self);\r\n                                self.map.on(listenTo.join(' '), self.view3D._event2DHandler);\r\n\r\n                                // modificamos los controles disponibles\r\n                                alterAllowedControls.call(self, TC.Consts.view.THREED);\r\n\r\n                                self.viewer.readyPromise.then(function () {\r\n                                    // pintamos las features que están en el mapa 2D\r\n                                    draw2DDrawedFeatures.call(self);\r\n                                });\r\n\r\n                                resolve(self.viewer);\r\n\r\n                            });\r\n\r\n                        });\r\n\r\n                    } else {\r\n                        resolve(self.viewer);\r\n                    }\r\n                });\r\n            },\r\n\r\n            setBaseLayer: function (layer) {\r\n                var self = this;\r\n\r\n                var get3DLayer = function (layer) {\r\n                    if (!isCompatible(layer, self.view3D.crs)) {\r\n                        if (layer.getFallbackLayer() !== null && isCompatible(layer.getFallbackLayer(), self.view3D.crs)) {\r\n                            layer = layer.getFallbackLayer();\r\n                        } else {\r\n                            self.map.toast(self.getLocaleString('threed.crsNoCompatible', { name: layer.title }));\r\n                            layer = null;\r\n                        }\r\n                    }\r\n\r\n                    return layer;\r\n                };\r\n\r\n                if (!self.view3D.baseLayer) {\r\n\r\n                    if (layer.type === TC.Consts.layerType.WMTS || layer.type === TC.Consts.layerType.WMS) {\r\n\r\n                        if (layer.options.relatedWMTS) {\r\n                            self.map.baseLayer = layer = self.map.getLayer(layer.options.relatedWMTS);\r\n                            self.map.trigger(TC.Consts.event.BASELAYERCHANGE, { layer: self.map.baseLayer });\r\n                        } else {\r\n\r\n                            layer = get3DLayer(layer);\r\n\r\n                            if (layer) {\r\n                                if (!layer.isBase) {\r\n                                    layer.isBase = true;\r\n                                }\r\n                                self.view3D.addLayer.call(self, layer);\r\n                            }\r\n                        }\r\n                    }\r\n                    else {\r\n                        self.view3D.baseLayer = self.Consts.BLANK_BASE;\r\n                    }\r\n                } else {\r\n\r\n                    if (self.viewer.scene.imageryLayers.contains(self.view3D.baseLayer)) {\r\n                        self.viewer.scene.imageryLayers.raiseToTop(self.view3D.baseLayer);\r\n                        self.viewer.scene.imageryLayers.remove(self.view3D.baseLayer, true);\r\n                    }\r\n\r\n                    if (layer instanceof TC.layer.Vector) {\r\n                        self.view3D.baseLayer = self.Consts.BLANK_BASE;\r\n\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    }\r\n                    else {\r\n                        layer = get3DLayer(layer);\r\n\r\n                        if (layer) {\r\n                            layer.map = self.map;\r\n                            layer.isBase = true;\r\n\r\n                            self.view3D.addLayer.call(self, layer);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                currentMapCfg.baseMap = self.map.baseLayer;\r\n            },\r\n\r\n            addLayer: function (layer) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n                        self.view3D.vector2DLayers.push(layer);\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        if (!layer.isBase && !layer.isCompatible(self.view3D.crs)) {\r\n                            self.map.toast(self.getLocaleString('threed.crsNoCompatible', { name: layer.layerNames }));\r\n                        } else {\r\n                            //var convertedLayer = rasterConverter.convert(layer, self.view3D.crs);\r\n                            rasterConverter.convert(layer, self.view3D.crs).then(function (convertedLayer) {\r\n                                if (convertedLayer) {\r\n\r\n                                    if (convertedLayer[\"enablePickFeatures\"] !== undefined) {\r\n                                        convertedLayer.enablePickFeatures = false;\r\n                                        convertedLayer[\"tcLayer\"] = layer;\r\n                                    }\r\n\r\n                                    if (layer.isBase && self.view3D.baseLayer) {\r\n                                        if (self.viewer.scene.imageryLayers.contains(self.view3D.baseLayer)) {\r\n                                            self.viewer.scene.imageryLayers.raiseToTop(self.view3D.baseLayer);\r\n                                            self.viewer.scene.imageryLayers.remove(self.view3D.baseLayer, true);\r\n                                        }\r\n                                    }\r\n\r\n                                    var newImageryLayer = self.viewer.scene.imageryLayers.addImageryProvider(convertedLayer);\r\n\r\n                                    if (layer.isBase) { // si la capa es el mapa de fondo lo envío al fondo de las capas en 3D\r\n                                        self.view3D.baseLayer = newImageryLayer;\r\n                                        self.viewer.scene.imageryLayers.lowerToBottom(newImageryLayer);\r\n                                    } else {\r\n                                        newImageryLayer.show = layer.getVisibility();\r\n                                        newImageryLayer.alpha = layer.getOpacity();\r\n\r\n                                        self.view3D.workLayers.push(newImageryLayer);\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n                        break;\r\n                    }\r\n                }\r\n            },\r\n            removeLayer: function (layer) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n\r\n                        if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(layer.id)) {\r\n\r\n                            for (var featureId in self.view3D.vector2DFeatures[layer.id]) {\r\n                                var threedFeature = self.view3D.vector2DFeatures[layer.id][featureId];\r\n\r\n                                for (var i = 0; i < threedFeature.length; i++) {\r\n                                    self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                                }\r\n                            }\r\n\r\n                            delete self.view3D.vector2DFeatures[layer.id];\r\n                        }\r\n\r\n                        // GLS revisar, debería estar en workLayers¿? \r\n                        // self.view3D.workLayers.splice(i, 1);\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                            if (layer.names && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.names.join(',') ||\r\n                                layer.title && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.title) {\r\n                                self.viewer.scene.imageryLayers.raiseToTop(self.view3D.workLayers[i]);\r\n                                self.viewer.scene.imageryLayers.remove(self.view3D.workLayers[i], true);\r\n\r\n                                self.view3D.workLayers.splice(i, 1);\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            setRenderOptionsLayer: function (layer, options) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n                        if (self.view3D.vector2DFeatures[layer.id]) {\r\n\r\n                            for (var featureId in self.view3D.vector2DFeatures[layer.id]) {\r\n                                var features = self.view3D.vector2DFeatures[layer.id][featureId];\r\n                                for (var i = 0; i < features.length; i++) {\r\n                                    self.view3D.setRenderOptionsFeature(features[i], { show: layer.getVisibility() });\r\n                                }\r\n                            }\r\n\r\n                            self.viewer.scene.requestRender();\r\n                        }\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                            if (layer.names && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.names.join(',') ||\r\n                                layer.title && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.title) {\r\n\r\n                                if (options.hasOwnProperty('visibility')) {\r\n                                    self.view3D.workLayers[i].show = options.visibility;\r\n                                }\r\n\r\n                                if (options.hasOwnProperty('opacity')) {\r\n                                    self.view3D.workLayers[i].alpha = options.opacity;\r\n                                }\r\n                                break;\r\n                            }\r\n                        }\r\n\r\n                        self.viewer.scene.requestRender();\r\n                    }\r\n                }\r\n            },\r\n\r\n            flyToMapCoordinates: function (coords) {\r\n                var self = this;\r\n\r\n                var lonlat = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(coords, self.view3D.view2DCRS, self.view3D.crs) : coords;\r\n                var destination = Cesium.Cartesian3.fromDegrees(lonlat[0], lonlat[1], self.viewer.camera.positionCartographic.height);\r\n\r\n                var camera = self.viewer.camera;\r\n                camera.flyTo({\r\n                    destination: destination,\r\n                    orientation: {\r\n                        heading: camera.heading,\r\n                        pitch: camera.pitch\r\n                    }\r\n                });\r\n            }.bind(viewProto),\r\n            flyToRectangle: function (rectangle, options) {\r\n                const self = this;\r\n                // lo primero de todo cancelar movimientos anteriores\r\n                self.viewer.scene.camera.cancelFlight();\r\n\r\n                return new Promise(function (resolve, reject) {\r\n                    options = options || {\r\n                    };\r\n\r\n                    var epsilon = Cesium.Math.EPSILON3;\r\n                    if (rectangle.east === rectangle.west) {\r\n                        rectangle.east += epsilon;\r\n                        rectangle.west -= epsilon;\r\n                    }\r\n\r\n                    if (rectangle.north === rectangle.south) {\r\n                        rectangle.north += epsilon;\r\n                        rectangle.south -= epsilon;\r\n                    }\r\n\r\n                    var enlargeFactor = 0.2;\r\n                    var marginX = rectangle.width * enlargeFactor / 2;\r\n                    var marginY = rectangle.height * enlargeFactor / 2;\r\n                    rectangle.east -= marginX;\r\n                    rectangle.west += marginY;\r\n                    rectangle.north += marginY;\r\n                    rectangle.south -= marginY;\r\n\r\n                    var scene = self.viewer.scene;\r\n                    var camera = scene.camera;\r\n\r\n                    var destinationCartesian = camera.getRectangleCameraCoordinates(rectangle);\r\n                    var destination = Cesium.Ellipsoid.WGS84.cartesianToCartographic(destinationCartesian);\r\n\r\n                    Cesium.when(scene.globe.terrainProvider.sampleTerrainMostDetailed([Cesium.Rectangle.center(rectangle)]), function (updatedPositions) {\r\n\r\n                        var finalDestinationCartographic = {\r\n                            longitude: destination.longitude,\r\n                            latitude: destination.latitude,\r\n                            height: destination.height + updatedPositions[0].height || 0\r\n                        };\r\n\r\n                        camera.flyTo({\r\n                            duration: options.duration || 1,\r\n                            destination: Cesium.Ellipsoid.WGS84.cartographicToCartesian(finalDestinationCartographic),\r\n                            complete: function () {\r\n                                var angle = Cesium.Math.toRadians(50);\r\n                                var pickBP = pickBottomPoint(this.viewer.scene);\r\n                                pickBP = Cesium.Matrix4.fromTranslation(pickBP);\r\n\r\n                                this.view3D.rotateAroundAxis(this.viewer.scene.camera, -angle, this.viewer.scene.camera.right, pickBP, {\r\n                                    duration: 250,\r\n                                    callback: function () {\r\n                                        resolve();\r\n                                    }\r\n                                });\r\n                            }.bind(self)\r\n                        });\r\n                    });\r\n                });\r\n            }.bind(viewProto),\r\n\r\n            zoomToCartesian: function (position, amount) {\r\n                var self = this;\r\n                var scene = self.viewer.scene;\r\n\r\n                if (!position || !position.endPosition) {\r\n                    var canvas = scene.canvas;\r\n                    var center = new Cesium.Cartesian2(\r\n                        canvas.clientWidth / 2,\r\n                        canvas.clientHeight / 2);\r\n                    position = {\r\n                        endPosition: center\r\n                    };\r\n                }\r\n\r\n                var pickRay = scene.camera.getPickRay(position.endPosition);\r\n                var intersection = scene.globe.pick(pickRay, scene);\r\n                if (intersection) {\r\n\r\n                    var distanceMeasure = Cesium.Cartesian3.distance(pickRay.origin, intersection);\r\n                    if (distanceMeasure < 1) {\r\n                        return;\r\n                    }\r\n                    else {\r\n                        if (!self.view3D._zoomTo) {\r\n                            self.view3D._zoomTo = {\r\n                                amount: 0\r\n                            };\r\n                        }\r\n                        self.view3D._zoomTo.direction = amount > 0 ? 1 : 0;\r\n                        self.view3D._zoomTo.amount += (distanceMeasure * 5 / 100);\r\n                        self.view3D._zoomTo.endPosition = position.endPosition;\r\n                    }\r\n                }\r\n\r\n                var setNewPosition = function (data) {\r\n                    var self = this;\r\n                    var scene = self.viewer.scene;\r\n\r\n                    var pickRay = scene.camera.getPickRay(position.endPosition || data.endPosition);\r\n                    var intersection = scene.globe.pick(pickRay, scene);\r\n                    if (intersection) {\r\n\r\n                        var distanceMeasure = Cesium.Cartesian3.distance(pickRay.origin, intersection);\r\n                        if (distanceMeasure < 1) {\r\n                            return;\r\n                        }\r\n                        else {\r\n\r\n                            var cameraPosition = scene.camera.position;\r\n                            var cameraDirection = scene.camera.direction;\r\n\r\n                            var toMove = toGo = new Cesium.Cartesian3();\r\n                            Cesium.Cartesian3.multiplyByScalar(pickRay.direction, data.direction == 1 ? data.amount : -data.amount, toMove);\r\n                            Cesium.Cartesian3.add(cameraPosition, toMove, toGo);\r\n\r\n                            var ray = new Cesium.Ray(toGo, pickRay.direction);\r\n                            var intersectionToGo = scene.globe.pick(ray, scene);\r\n                            if (intersectionToGo) {\r\n\r\n                                var reset = function () {\r\n                                    this.view3D._zoomTo = {\r\n                                        direction: 1,\r\n                                        amount: 0,\r\n                                        endPosition: {}\r\n                                    };\r\n\r\n                                    return;\r\n                                };\r\n\r\n                                if (Cesium.Cartesian3.distance(toGo, intersectionToGo) < 1 ||\r\n                                    Math.abs(Cesium.Ellipsoid.WGS84.cartesianToCartographic(toGo).height) < scene.screenSpaceCameraController.minimumZoomDistance) {\r\n                                    reset.call(self);\r\n                                }\r\n                                else {\r\n                                    self.viewer.camera.flyTo({\r\n                                        destination: toGo,\r\n                                        orientation: {\r\n                                            heading: scene.camera.heading,\r\n                                            pitch: scene.camera.pitch,\r\n                                            roll: scene.camera.roll\r\n                                        },\r\n                                        duration: 1,\r\n                                        easingFunction: Cesium.EasingFunction.LINEAR_NONE,\r\n                                        complete: function (distance) {\r\n                                            this.view3D._zoomTo = {\r\n                                                direction: 1,\r\n                                                amount: 0,\r\n                                                endPosition: {}\r\n                                            };\r\n                                        }.bind(self, Cesium.Cartesian3.distance(toGo, intersectionToGo))\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                };\r\n\r\n                setTimeout(function () { // GLS: No hemos encontrado otra forma para acumular pasos de la rueda\r\n                    setNewPosition.call(self, self.view3D._zoomTo);\r\n                }.bind(self), 50);\r\n            },\r\n\r\n            rotateAroundAxis: function (camera, angle, axis, transform, opt_options) {\r\n                return rotateAroundAxis(camera, angle, axis, transform, opt_options);\r\n            },\r\n\r\n            addFeature: function (feature, options) {\r\n                var self = this;\r\n\r\n                var add = function () {\r\n                    var csfeature = featureConverter.convert(self.viewer.scene, feature, self.view2DCRS, self.crs);\r\n                    if (csfeature) {\r\n                        if (typeof csfeature.geometry === 'function') {\r\n                            // estoy aquí // tengo que validar qué proveedor escoger, afecta, hay mucha diferencia de alturas, podría ir por capa?? búsquedas fijo por el de por defecto y track validar??\r\n                            csfeature.geometry(self.viewer.terrainProvider).then(function (newGeometry) {\r\n                                // es igual a cuando no es una función... a ver cómo lo gestiono\r\n                                if (newGeometry instanceof Array) {\r\n                                    newGeometry.forEach(function (geom) {\r\n                                        if (geom instanceof Array) {\r\n                                            geom.forEach(function (geo) {\r\n                                                geo = addFeature.call(self, geo);\r\n                                                linkFeature(self, feature.layer.id, geo, feature.id);\r\n                                            });\r\n                                        } else {\r\n                                            geom = addFeature.call(self, geom);\r\n                                            linkFeature(self, feature.layer.id, geom, feature.id);\r\n                                        }\r\n                                    });\r\n                                }\r\n                                else {\r\n                                    var geom = addFeature.call(self, newGeometry);\r\n                                    linkFeature(self, feature.layer.id, geom, feature.id);\r\n                                }\r\n                            });\r\n                        }\r\n                        else if (csfeature.geometry instanceof Array) {\r\n                            csfeature.geometry.forEach(function (geom) {\r\n                                geom = addFeature.call(self, geom);\r\n                                linkFeature(self, feature.layer.id, geom, feature.id);\r\n                            });\r\n                        }\r\n                        else {\r\n                            var geom = addFeature.call(self, csfeature.geometry);\r\n                            linkFeature(self, feature.layer.id, geom, feature.id);\r\n                        }\r\n                    }\r\n                };\r\n\r\n                // GLS: para no pintar la cruz-marker del FeatureInfo\r\n                if ((self.linked2DControls.featureInfo && self.linked2DControls.featureInfo.get2DMarker() === feature) ||\r\n                    (self.linked2DControls.featureInfo && self.linked2DControls.featureInfo.isPending())) {\r\n                    // GLS: llega antes aquí que al callback de la instrucción que crea la feature, por eso necesito el timeout\r\n                    setTimeout(function () {\r\n                        if (self.linked2DControls.featureInfo.get2DMarker() === feature) {\r\n                            return;\r\n                        } else {\r\n                            add();\r\n                        }\r\n                    }, 5);\r\n                } else if (self.linked2DControls.geolocation && self.linked2DControls.geolocation.layerTracking === feature.layer && feature instanceof TC.feature.Polyline) {\r\n                    return;\r\n                } else {\r\n                    add();\r\n                }\r\n            },\r\n            removeFeature: function (feature) {\r\n                var self = this;\r\n                if (self.viewer) {\r\n                    if (feature) {\r\n                        switch (true) {\r\n                            case feature instanceof Cesium.GroundPrimitive:\r\n                                self.viewer.scene.groundPrimitives.remove(feature);\r\n                                break;\r\n                            case feature instanceof Cesium.Billboard:\r\n                                self.viewer.billboardCollection.remove(feature);\r\n                                break;\r\n                            case feature instanceof Object:\r\n                                self.viewer.entities.removeById(feature.id);\r\n                                break;\r\n                        }\r\n\r\n                        self.viewer.scene.requestRender();\r\n                    }\r\n                }\r\n            },\r\n            setRenderOptionsFeature: function (feature, options) {\r\n                if (feature) {\r\n                    feature.show = options.show;\r\n                }\r\n            },\r\n\r\n            addNativeFeature: function (cesiumFeature) {\r\n                return addFeature.call(this.view3D, cesiumFeature);\r\n            },\r\n\r\n            setCameraFromMapView: function () {\r\n                var self = this;\r\n\r\n                self.viewer.scene.globe.terrainProvider.readyPromise.then(function () {\r\n                    var center = self.mapView.getCenter();\r\n\r\n                    if (!center) {\r\n                        return;\r\n                    }\r\n\r\n                    var latlon = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(center, self.view3D.view2DCRS, self.view3D.crs) : center;\r\n                    var distance = calcDistanceForResolution.call(self, self.mapView.getResolution() || 0, Cesium.Math.toRadians(latlon[0]));\r\n\r\n                    var latlon = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(center, self.view3D.view2DCRS, self.view3D.crs) : center;\r\n                    var carto = new Cesium.Cartographic(Cesium.Math.toRadians(latlon[0]), Cesium.Math.toRadians(latlon[1]));\r\n                    if (self.viewer.scene.globe) {\r\n                        carto.height = self.viewer.scene.globe.getHeight(carto) || 0;\r\n                    }\r\n\r\n                    var setCamera = function () {\r\n                        var destination = Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\r\n                        var orientation = {\r\n                            pitch: Cesium.Math.toRadians(-90),\r\n                            heading: -self.mapView.getRotation(),\r\n                            roll: 0.0\r\n                        };\r\n\r\n                        self.viewer.camera.setView({\r\n                            destination: destination,\r\n                            orientation: orientation\r\n                        });\r\n\r\n                        self.viewer.camera.moveBackward(distance);\r\n                    };\r\n\r\n                    if (carto.height === 0) {\r\n                        TC.loadJS(!TC.tool || !TC.tool.Elevation, TC.apiLocation + 'TC/tool/Elevation', function () {\r\n                            self.view3D.elevationTool = new TC.tool.Elevation();\r\n                            self.view3D.elevationTool.getElevation({\r\n                                crs: self.view3D.crs,\r\n                                coordinates: latlon\r\n                            }).then(function (result) {\r\n                                if (result && result.length > 0) {\r\n                                    carto.height = result[0][2] ? result[0][2] : 0;\r\n                                    setCamera();\r\n                                }\r\n                            });\r\n                        });\r\n                    } else {\r\n                        setCamera();\r\n                    }\r\n                });\r\n            },\r\n            setViewFromCameraView: function () {\r\n                const self = this;\r\n\r\n\r\n                var ellipsoid = Cesium.Ellipsoid.WGS84;\r\n                var scene = self.viewer.scene;\r\n                var target = target_ = pickCenterPoint(scene);\r\n\r\n                if (!target_) {\r\n                    var globe = self.viewer.scene.globe;\r\n                    var carto = self.viewer.camera.positionCartographic.clone();\r\n                    var height = globe.getHeight(carto);\r\n                    carto.height = height || 0;\r\n                    target_ = Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\r\n                }\r\n\r\n\r\n                var distance = Cesium.Cartesian3.distance(target_, self.viewer.camera.position);\r\n                var targetCartographic = ellipsoid.cartesianToCartographic(target_);\r\n\r\n                var centerMapCRS = self.view3D.crs !== self.view3D.view2DCRS ? TC.Util.reproject(\r\n                    [Cesium.Math.toDegrees(targetCartographic.longitude), Cesium.Math.toDegrees(targetCartographic.latitude)],\r\n                    self.view3D.crs, self.view3D.view2DCRS) : [Cesium.Math.toDegrees(targetCartographic.longitude), Cesium.Math.toDegrees(targetCartographic.latitude)];\r\n\r\n                self.mapView.setCenter(centerMapCRS);\r\n\r\n                self.mapView.setResolution(calcResolutionForDistance.call(self, distance, targetCartographic ? targetCartographic.latitude : 0));\r\n\r\n                // GLS: No tenemos la rotación del mapa activada por problemas con el iPad\r\n                //if (target) {\r\n                //    var pos = self.viewer.camera.position;\r\n\r\n                //    var targetNormal = new Cesium.Cartesian3();\r\n                //    ellipsoid.geocentricSurfaceNormal(target, targetNormal);\r\n\r\n                //    var targetToCamera = new Cesium.Cartesian3();\r\n                //    Cesium.Cartesian3.subtract(pos, target, targetToCamera);\r\n                //    Cesium.Cartesian3.normalize(targetToCamera, targetToCamera);\r\n\r\n                //    // HEADING\r\n                //    var up = self.viewer.camera.up;\r\n                //    var right = self.viewer.camera.right;\r\n                //    var normal = new Cesium.Cartesian3(-target.y, target.x, 0);\r\n                //    var heading = Cesium.Cartesian3.angleBetween(right, normal);\r\n                //    var cross = Cesium.Cartesian3.cross(target, up, new Cesium.Cartesian3());\r\n                //    var orientation = cross.z;\r\n\r\n                //    self.mapView.setRotation((orientation < 0 ? heading : -heading));\r\n                //    self.setViewFromCameraViewInProgress.resolve();\r\n                //}\r\n\r\n                return Promise.resolve();\r\n            },\r\n\r\n            lookAt: function (coords) {\r\n                const self = this;\r\n\r\n                if (self.crs !== self.view2DCRS) {\r\n                    coords = TC.Util.reproject(coords, self.view2DCRS, self.crs);\r\n                }\r\n\r\n                var camera = self.viewer.camera;\r\n                var positionCartographic = camera.positionCartographic;\r\n                var height = positionCartographic.height;\r\n                var cartographic = new Cesium.Cartographic(Cesium.Math.toRadians(coords[0]), Cesium.Math.toRadians(coords[1]), height)\r\n\r\n                camera.flyTo({\r\n                    destination: Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height),\r\n                    duration: 1.0\r\n                });\r\n            },\r\n\r\n            getInfoOnPickedPosition: function (pickedPosition) {\r\n                var self = this;\r\n\r\n                if (!pickedPosition) {\r\n                    return;\r\n                } else {\r\n\r\n                    self.map.one(TC.Consts.event.DRAWTABLE, function (e) {\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    });\r\n\r\n                    self.view3D.linked2DControls.featureInfo.send.call(self, pickedPosition).then(function (e) {\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    });\r\n                }\r\n            },\r\n\r\n            on: function (event, callback) {\r\n                const self = this;\r\n\r\n                const movement3DtoPosition2D = function (movement) {\r\n                    if (self.viewer && self.viewer.cesiumWidget) {\r\n                        var ray = self.viewer.camera.getPickRay(movement.endPosition || movement.position);\r\n                        var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n                        if (position) {\r\n                            var positionCartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(position);\r\n\r\n                            var lat, lon, ele;\r\n                            lat = Cesium.Math.toDegrees(positionCartographic.latitude);\r\n                            lon = Cesium.Math.toDegrees(positionCartographic.longitude);\r\n                            ele = Math.round(positionCartographic.height);\r\n\r\n                            return { lon: lon, lat: lat, ele: ele };\r\n                        }\r\n                    }\r\n\r\n                    return null;\r\n                };\r\n\r\n                var eventHandler = new Cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas, false);\r\n                eventHandler.setInputAction(function (event) {\r\n                    if (event.endPosition || event.position) {\r\n                        // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                        if (self.viewer.trackedEntity) {\r\n                            return;\r\n                        }\r\n\r\n                        callback(movement3DtoPosition2D(event));\r\n                    } else {\r\n                        callback(event);\r\n                    }\r\n\r\n                }, fromTCtoCesiumEvent(event));\r\n            },\r\n\r\n            getHeightFromMDT: function (geoCoords) {\r\n                const self = this;\r\n\r\n                var cartesian = new Cesium.Cartographic(Cesium.Math.toRadians(geoCoords[0]), Cesium.Math.toRadians(geoCoords[1]));\r\n                return self.viewer.scene.globe.getHeight(cartesian) || 0;\r\n            },\r\n\r\n            destroy: function () {\r\n                var self = this;\r\n\r\n                self.map.on3DView = false;\r\n                //self.map.view3D = null;\r\n\r\n                self.view3D.vector2DLayers = [];\r\n                self.view3D.vector2DFeatures = {\r\n                };\r\n\r\n                // eliminamos el enlace con los eventos del mapa 2D\r\n                self.map.off(listenTo.join(' '), self.view3D._event2DHandler);\r\n\r\n                // modificamos los controles disponibles\r\n                alterAllowedControls.call(self, TC.Consts.view.DEFAULT);\r\n\r\n                // sobrescribimos el comportamiento de lo botones + /- y la casita\r\n                override2DZoom.call(self, false);\r\n\r\n                //addNoCompatibleBaseLayers.call(self);\r\n\r\n                Promise.all(self.map.baseLayers.map(function (baseLayer) {\r\n                    return Promise.resolve(!isCompatible(baseLayer, self.view3D.view2DCRS));\r\n                })).then(function (results) {\r\n                    if (results.length > 0) {\r\n                        var defaultBaseLayer;\r\n                        for (var i = 0; i < self.map.baseLayers.length; i++) {\r\n                            if (!defaultBaseLayer && !results[i]) {\r\n                                defaultBaseLayer = self.map.baseLayers[i];\r\n                            }\r\n                            self.map.baseLayers[i].mustReproject = results[i];\r\n                        }\r\n                        var triggerEvent = true;\r\n                        const showReprojectDialog = function (haveToChange, baseLayer, fallbackLayer) {\r\n                            const dialogOptions = {\r\n                                layer: baseLayer\r\n                            };\r\n\r\n                            if (fallbackLayer) {\r\n                                dialogOptions.fallbackLayer = fallbackLayer;\r\n                            }\r\n\r\n                            var control = self.map.getControlsByClass(haveToChange ? TC.control.BasemapSelector : TC.control.Coordinates);\r\n                            if (control.length > 0) {\r\n                                // gestionamos que el control de coordenadas no se renderice en el cambio de vista porque borra el modal de cambio de CRS\r\n                                if (control[0] instanceof TC.control.Coordinates) {\r\n                                    triggerEvent = false;\r\n                                }\r\n                                dialogOptions.closeCallback = function () {\r\n                                    self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.DEFAULT });\r\n                                };\r\n                                control[0].showProjectionChangeDialog(dialogOptions);\r\n                            }\r\n                        };\r\n\r\n                        var baseLayer = currentMapCfg.baseMap == self.Consts.BLANK_BASE ? currentMapCfg.baseVector : currentMapCfg.baseMap;\r\n                        if (!baseLayer.isCompatible(self.map.getCRS())) {\r\n\r\n                            if (!baseLayer.fallbackLayer) {\r\n                                showReprojectDialog(true, baseLayer);\r\n                            } else {\r\n                                baseLayer.getFallbackLayer();\r\n                                if (baseLayer.getFallbackLayer().isCompatible(self.map.getCRS())) {\r\n\r\n                                    // antes de establecer como fondo la capa de respaldo, preguntar al usuario si prefiere cambiar de CRS o si quiere seguir reproyectando al vuelo.\r\n                                    TC.confirm(self.getLocaleString('threed.changeBaselayer'),\r\n                                        function () {\r\n                                            showReprojectDialog(false, baseLayer, baseLayer.fallbackLayer);\r\n                                        }, function () {\r\n                                            self.map.setBaseLayer(baseLayer.fallbackLayer);\r\n                                        });\r\n                                } else {\r\n                                    showReprojectDialog(true, baseLayer);\r\n                                }\r\n                            }\r\n                        } else {\r\n                            self.map.setBaseLayer(baseLayer);\r\n                        }\r\n                    }\r\n\r\n                    currentMapCfg.baseMap = '';\r\n\r\n                    self.view3D.baseLayer = null;\r\n\r\n                    self.view3D.workLayers = [];\r\n\r\n                    self.view3D.cameraControls.unbind();\r\n\r\n                    if (self.view3D.linked2DControls.featureInfo) {\r\n                        self.view3D.linked2DControls.featureInfo.reset();\r\n                    }\r\n\r\n                    if (self.view3D.linked2DControls.geolocation) {\r\n                        self.view3D.linked2DControls.geolocation.isGeo = false;\r\n                        self.view3D.linked2DControls.geolocation.reset();\r\n                    }\r\n\r\n                    self.view3D.tileLoadingHandler.removeAll();\r\n                    delete self.view3D.tileLoadingHandler;\r\n\r\n                    self.viewer.destroy();\r\n                    self.viewer = null;\r\n\r\n                    if (triggerEvent) { // si lanzamos sin más, el control de coordenadas se renderizada en el cambio de vista y borra el modal de cambio de CRS\r\n                        self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.DEFAULT });\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    })();\r\n\r\n    return {\r\n        init: viewProto.init.bind(viewProto),\r\n        apply: viewProto.apply.bind(viewProto),\r\n        unapply: viewProto.unapply.bind(viewProto),\r\n        VIEWNAME: viewProto.VIEWNAME\r\n    };\r\n});"]}