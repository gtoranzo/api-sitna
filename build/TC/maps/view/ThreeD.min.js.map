{"version":3,"sources":["view/ThreeD.js"],"names":["TC","view","control","MapContents","syncLoadJS","apiLocation","lastTime","vendors","hasPerformance","window","performance","now","x","max","length","requestAnimationFrame","cancelAnimationFrame","callback","element","currTime","Date","getTime","timeToCall","Math","id","setTimeout","clearTimeout","rAF","startTime","timestamp","viewProto","VIEWNAME","CLASS","Consts","BLANK_BASE","DEFAULT_TILE_SIZE","classes","MAPTHREED","LOADING","CAMERACTRARROWDISABLED","FOCUS","HIGHLIGHTED","DISABLED","OUTFOCUS","allowedControls","template","viewer","mapView","terrainProvider","getLocaleString","key","texts","locale","this","map","options","Cfg","Util","getRenderedHtml","templateId","data","self","Promise","resolve","reject","render","dust","cache","err","out","error","$","isFunction","loadJSInOrder","url","templating","ajax","method","then","html","tpl","compile","loadSource","isDebug","CESIUM","THREED","THREED_HIDDEN","event","TERRAINLOADED","TERRAINRECEIVING","TERRAIN404","register","body_0","chk","ctx","w","h","$key","__dustBody","MapView","parent","getViewHTML","viewHTML","bind","metersPerUnit","getMetersPerUnit","maxResolution","_oldMapSetCenter","setCenter","coords","on3DView","view3D","flyToMapCoordinates","call","prototype","getCenter","getExtent","getResolution","getRotation","getMaxResolution","getResolutions","extent","baselayerExtent","getPixelFromCoordinate","center","setExtent","setResolution","resolution","setRotation","rotation","isCompatible","layer","crs","type","layerType","WMTS","wrap","getCompatibleMatrixSets","distanceSquared","p1","p2","dx","dy","getFarMapCoords","obj","nearMapCoords","nextPixel","bottomPixel","clone","y","round","nextCoords","pickMapCoords","coordsArray","sort","a","b","cameraPosition","origin","nearPoint","angle","atan","PI","cos","sin","apply","pixel","pickPoint","pickOnTerrainOrEllipsoid","scene","Cesium","Cartographic","fromCartesian","view2DCRS","reproject","toDegrees","longitude","latitude","calcResolutionForDistance","distance","canvas","fovy","camera","frustum","visibleMeters","tan","relativeCircumference","abs","visibleMapUnits","clientHeight","resolutions","i","ii","Array","pow","rotateAroundAxis","axis","transform","opt_options","start","clamp","defaultValue","duration","easing","lastProgress","oldTransform","Matrix4","animation","progress","stepAngle","lookAtTransform","rotate","ray","getPickRay","target","globe","pick","pickEllipsoid","pickCenterPoint","Cartesian2","clientWidth","pickBottomPoint","bottom","setHeadingUsingBottomCenter","heading","bottomCenter","angleToZenith","computeAngleToZenith","right","quaternion","Quaternion","fromAxisAngle","Matrix3","fromQuaternion","vector","Cartesian3","subtract","position","zenith","multiplyByVector","add","fromTranslation","signedAngleBetween","first","second","normal","c","normalize","cross","cosine","dot","sine","magnitude","sign","atan2","pivot","fy","fovy2","direction","matrix","Ray","bottomFovRay","negate","Ellipsoid","WGS84","geocentricSurfaceNormal","left","CameraControls","cssRotate","coord","getBBox","value","width","height","document","getElementsByClassName","className","baseVal","setAttribute","outControlsEvents","detectMouse","outControls","e","isFocusingCameraCtrls","inControlsEvents","inControls","lastFocused","div","classList","contains","remove","tiltIndicatorOuterCircle","tiltIndicatorOuterShellCircle","rotateIndicatorOuterCircle","rotateIndicatorOuterShellCircle","moveStart","moving","moveEnd","postRender","isLoadingTiles","customCollisionDetection","getCamera","positionCartographic","tiltIndicator","pitch","rotateIndicator","disableRotate","disableTilt","_coordsXY","_ovMap","getControlsByClass","renderPromise","bottomLeft","bottomRight","fovCoords","elm","filter","farCoordsLeft","farCoordsRight","draw3DCamera","fov","selectors","tilt","indicator","leftArrow","rightArrow","downArrow","upArrow","MIN_TILT","toRadians","MAX_TILT","addEventListener","forEach","rAFInOutControls","setOpacity","unbind","HIDDEN","removeEventListener","undefined","getCameraState","cp","chpr","roll","bcpd","createElement","innerHTML","appendChild","tiltSelector","tiltIndicatorInner","querySelector","replace","CLICK","resetTilt","tiltIndicatorCircle","stopPropagation","preventDefault","vectorScratch","currentTarget","rectangle","getBoundingClientRect","top","clickLocation","clientX","clientY","draggingTilt","cancelBubble","returnValue","tiltUp","disabled","upEvent","tiltUpMouseUpFunction","tiltUpInterval","setInterval","isTiltUpDisabled","clearInterval","tiltDown","tiltDownMouseUpFunction","tiltDownInterval","isTiltDownDisabled","rotateSelector","rotateIndicatorInner","resetRotation","rotateIndicatorCircle","draggingRotate","rotateLeft","rotateLeftMouseUpFunction","rotateLeftInterval","rotateRight","rotateRightMouseUpFunction","rotateRightInterval","theta","isDisable","trackedEntity","rotateUp","lookUp","lookDown","PI_OVER_TWO","_angle","tiltElement","cursorVector","oldTransformScratch","newTransformScratch","tiltMouseMoveFunction","tiltMouseUpFunction","isTilting","tiltFrame","Transforms","northUpEastToFixedFrame","tiltIsLook","positionWC","startCursorAngle","initialCameraAngle","tiltRectangle","console","log","toString","angleDifference","newCameraAngle","zeroToTwoPi","currentCameraAngle","rotateElement","rotateMouseMoveFunction","rotateMouseUpFunction","rotateRectangle","rotateInitialCursorAngle","rotateInitialCameraAngle","rotateFrame","isRotating","viewCenter","eastNorthUpToFixedFrame","rotateIsLook","rotateInitialCameraDistance","currentRotation","fromDegrees","mag","scratchAdjustHeightTransform","scratchAdjustHeightCartographic","screenSpaceCameraController","minimumCollisionTerrainHeight","enableCollisionDetection","minimumZoomDistance","ellipsoid","mapProjection","equals","IDENTITY","_setTransform","cartographic","cartesianToCartographic","heightUpdated","getHeight","cartographicToCartesian","multiplyByScalar","up","limitCameraToInitExtent","pos","initExtent","west","east","south","north","maxHeight","maximumZoomDistance","padding","min","setView","destination","orientation","TwoDLinkedFeatureInfo","savedMode","pending","marker","ctlResultsPanel","ctlFeatureInfo","map2DgetResolutionFN","getResultsPanelCtl","ResultsPanel","resultsPanelOptions","content","titles","main","addControlPromise","controlContainer","side","SIDE","RIGHT","addControl","caller","resultsPanel","removeMarker","removeFeature","FeatureInfo","displayMode","setDisplayMode","FeatureInfoCommons","RESULTS_PANEL","on","RESULTSPANELCLOSE","getDisplayControl","querying","clear","closeResults","reset","send","pickedPosition","close","waiting","getLoadingIndicator","addWait","markerStyle","billboard","image","getBackgroundUrlFromCss","eyeOffset","verticalOrigin","VerticalOrigin","BOTTOM","heightReference","HeightReference","CLAMP_TO_GROUND","addNativeFeature","requestRender","setMarker","reprojected","pickedLocation","pixelTolerance","pickedTile","tilesRendered","_surface","_tilesToRender","textureIndex","tile","Rectangle","imageryTiles","imagery","terrainImagery","readyImagery","nativeRectangle","tilingScheme","tileXYToNativeRectangle","level","readyImageryToGetNativeRectangle","imageryLayer","isBaseLayer","west_south","east_north","xResolution","imageryProvider","tileWidth","yResolution","tileHeight","one","NOFEATUREINFO","onClear","filterLayer","off","FEATURESCLEAR","FEATUREINFO","FEATURECLICK","savedIsActive","isActive","beforeRequest","xy","get2DMarker","filterFeature","isPending","RasterConverter","crsPattern","layerCrs","CustomResource","paths","CRS","TILEMATRIXSET","TILEMATRIXSETLABELS","getOfPath","p","hasOwnProperty","_obj","push","wmtsLayer","tileMatrixSetLabels","capsURL","isOnCapabilities","caps","capabilities","tileMatrixSet","getTileMatrixSetLabelByLayerOnCapabilities","urlPattern","layerNames","style","format","tileMatrixSetID","tileMatrixLabels","GeographicTilingScheme","WebMapTileServiceImageryProvider","xhrBlobSupported","xhr","XMLHttpRequest","open","responseType","fetchImage","resource","allowCrossOrigin","request","requestFunction","crossOrigin","isDataUri","isBlobUri","isCrossOriginUrl","deferred","when","defer","getWebGLUrl","Image","onload","onerror","TrustedServers","src","createImage","promise","RequestScheduler","defined","otherwise","customFetchImage","preferBlob","deprecationWarning","state","RequestState","ISSUED","ACTIVE","RuntimeError","UNISSUED","checkAndResetRequest","hasHeaders","blobPromise","fetchBlob","generatedBlobResource","generatedBlob","blob","blobUrl","URL","createObjectURL","Resource","revokeObjectURL","convert","map3DCRS","constructor","Object","create","result","cloned","_url","_queryParameters","_templateValues","headers","proxy","retryCallback","retryAttempts","_retryCount","defineCustomResource","WMS","layers","parameters","version","transparent","exBoundingBox","bbox","Capability","Layer","names","slice","_getEXBBox","nodes","name","n","compareNames","getName","EX_GeographicBoundingBox","exBBox","pop","bindEXBBox","geoBBox","WebMapServiceImageryProvider","FeatureConverter","toCesiumColor","hexStringColor","alpha","color","Color","fromCssColorString","withAlpha","setStyleProperties","styles","properties","feature","attr","prop","val","getFeatureStyle","Defaults","STYLETYPE","extend","getStyle","createLine","entity","Entity","polyline","positions","material","clampToGround","polygonConverter","polygon","opt","opacity","outlineColor","outlineOpacity","ColorGeometryInstanceAttribute","fromColor","MultiPolygon","CLASSNAME","geometryType","polygonHierarchy","getting","geomPolys","geomOutlines","getOutlineGeom","outlineCoords","res","rej","j","hierarchy","PolygonHierarchy","holes","GeometryInstance","geometry","PolygonGeometry","attributes","all","GroundPrimitive","releaseGeometryInstances","geometryInstances","Polygon","isArray","lineConverter","line","MultiPolyline","geomInstances","minx","miny","maxx","maxy","point","z","fromCartesianArray","neededCameraPosition","getRectangleCameraCoordinates","BoundingSphere","fromPoints","pixelSize","getPixelDimensions","drawingBufferWidth","drawingBufferHeight","getPixelSize","Polyline","pointConverter","label","fontSize","fontColor","outlineLabelColor","outlineLabelWidth","anchor","outlineWidth","radius","Marker","pixelOffset","text","font","horizontalOrigin","HorizontalOrigin","LEFT","fillColor","showBackground","Point","pinBuilder","PinBuilder","test","CENTER","BASELINE","BLACK","WHITE","LabelStyle","FILL_AND_OUTLINE","fromText","toDataURL","stringifyScratch","drawPin","context2D","size","rgbaColor","darken","toCssColorString","save","scale","strokeStyle","miterLimit","restore","fillStyle","lineWidth","lineJoin","beginPath","moveTo","lineTo","closePath","fill","stroke","translate","arc","createPin","_cache","JSON","stringify","item","getContext","strokeColor","scn","sourceCrs","targetCrs","converter","points","ringsOrPolylines","polygons","byPromise","cartesians","toCartesian","arr","forPoints","forRingsOrPolylines","Circle","circle","CircleGeometry","forPolygons","boundigSphere","provider","currentMapCfg","baseMap","baseMaps","baseVector","init","events","$events","divThreedMap","divMap","terrain","Error","terrainFallback","coverageName","noDataValue","trim","layerName","controls","PROJECTIONCHANGE","parser","DOMParser","overlay","parseFromString","body","firstChild","viewName","substr","toLowerCase","views","toast","msgType","INFO","ctrlsToMng","ctls","len","ctl","toUpperCase","ctlsOnMap","CONTROLADD","ctrlClass","instance","Function","concat","container","loaded","removeWait","loadViewer","isBaseRaster","baseLayer","Raster","fallbackLayer","getFallbackLayer","_capabilitiesPromise","baseLayers","results","mustReproject","setCameraFromMapView","setBaseLayer","workLayers","elem","reverse","addLayer","readyPromise","cameraControls","animateRendering","flyTo","fromRadians","complete","pickBP","animationCallback","Camera","DEFAULT_VIEW_RECTANGLE","initialRectangle","computeViewRectangle","DEFAULT_VIEW_FACTOR","trigger","VIEWCHANGE","addHeight","finalCartographic","markers","entities","values","Property","getValueOrUndefined","JulianDate","billboardCollection","get","unapply","TERRAINPROVIDERREMOVE","fallbackProvider","setViewFromCameraView","destroy","rasterConverter","featureConverter","addFeature","csFeature","addedFeature","groundPrimitives","primitives","BillboardCollection","billboardAtCollection","getById","linkFeature","idLayer","vector2DFeatures","listenTo","BEFOREBASELAYERCHANGE","BASELAYERCHANGE","LAYERADD","LAYERREMOVE","LAYERVISIBILITY","LAYEROPACITY","LAYERORDER","FEATUREADD","FEATUREREMOVE","ZOOMTO","geolocation_newPosition","trackingEntity","geolocation2D","linked2DControls","geolocation","track","layerTracking","features","entityTracking","CallbackProperty","time","newCartographicPositions","coordinate","updatedPositions","cartographicArrayToCartesianArray","PolylineDashMaterialProperty","fromAlpha","renderTrack","checked","gapColor","TRANSPARENT","geolocation_videoControls","Const","Event","IMPORTEDTRACK","indexOf","parentElement","Classes","SELECTEDTRACK","clock","shouldAnimate","currentTime","fromDate","trackDataSource","removeById","chartProgressClear","custom","selectedTrack","getSelectedTrack","Selector","STOP","click","multiplier","simulate_speed","alterAllowedControls","ctrlsToMngCLASS","ctrl","mapCtrl","DEFAULT","enable","disable","querySelectorAll","featureInfo","eventHandler","ScreenSpaceEventHandler","setInputAction","movement","getFeatureInfo","getInfoOnPickedPosition","pickedFeature","founded","layerId","feature2D","workLayer","showsPopup","onDrawTable","onTableClose","DRAWTABLE","ScreenSpaceEventType","LEFT_CLICK","Geolocation","commands","PAUSE","BACKWARD","FORWARD","DRAW","geolocation_videoControls_","setTracking","_setTracking","simulateTrack","_wrap_simulateTrack","showElevationMarker","_wrap_showElevationMarker","hideElevationMarker","_wrap_hideElevationMarker","_simulateTrack","elevationTrack","_elevationTrack","command","_classSelector","tracking","POSITIONCHANGE","li","resized","hasElevation","simulationOnPreUpdate","drawTrack","layerTrack","coordinates","layout","pointStyle","lineStyle","walkingSpeed","sampleTerrainMostDetailed","stopTime","totalDistance","ol","geom","GeometryLayout","XYZM","XYM","done","previuos_next","EllipsoidGeodesic","surfaceDistance","toISOString","czml","availability","epoch","cartographicRadians","updatedPosition","reduce","prev","curr","rgba","strokeWidth","coordinates2D","getGeometry","DataSourceCollection","dataSourceDisplay","DataSourceDisplay","dataSourceCollection","preRender","update","CzmlDataSource","load","czmlDataSource","stop","clockStep","ClockStep","TICK_DEPENDENT","clockRange","ClockRange","CLAMPED","trackEntity","tagLI","TimeIntervalCollection","TimeInterval","previousPosition","distanceCurrent","preUpdate","getAttribute","greaterThanOrEquals","isAvailable","currentPosition","chartSetProgress","d","doneDistance","previous","current","heightIndex","XYZ","_getTime","toDate","chart","getVisibility","getOpacity","elevationMarkerPosition","index","elevationMarker","override2DZoom","activate","zoom","amount","zoomToCartesian","endPosition","initialExtent","sourceCRS","coordsXY","coordsXY2","flyToRectangle","zoomin","zoomout","NavBarHome","button","NavBar","customRender","vector2DLayers","surface","ready","loadJS","resourceBoundaries","fetchJson","bounds","ApproximateTerrainHeights","initialize","boundaries","arguments","MergeTerrainProvider","fallback","CesiumTerrainProvider","attributions","getAttribution","TERRAINPROVIDERADD","Globe","baseColor","enableLighting","tileCacheSize","maximumScreenSpaceError","Viewer","terrainExaggeration","timeline","fullscreenButton","baseLayerPicker","navigationInstructionsInitiallyVisible","navigationHelpButton","geocoder","homeButton","infoBox","sceneModePicker","selectionIndicator","skyBox","skyAtmosphere","requestRenderMode","maximumRenderTimeChange","Infinity","backgroundColor","imageryLayers","removeAll","errorEvent","statusCode","renderError","code","ERROR","tileLoadingHandler","EventHelper","tileLoadProgressEvent","allReady","removeChild","_event2DHandler","removeLayer","setRenderOptionsLayer","visibility","join","oldIndex","newIndex","lower","raise","splice","threedFeature","featureId","ZOOM","_canvasClientHeight","_canvasClientWidth","lastZoom","Vector","vectorLayer","get3DLayer","title","raiseToTop","isBase","relatedWMTS","getLayer","VECTOR","convertedLayer","enablePickFeatures","newImageryLayer","addImageryProvider","lowerToBottom","show","setRenderOptionsFeature","lonlat","cancelFlight","epsilon","EPSILON3","marginX","marginY","destinationCartesian","finalDestinationCartographic","pickRay","intersection","distanceMeasure","_zoomTo","toMove","toGo","intersectionToGo","easingFunction","EasingFunction","LINEAR_NONE","csfeature","newGeometry","geo","Billboard","cesiumFeature","latlon","carto","setCamera","moveBackward","tool","Elevation","elevationTool","getElevation","target_","targetCartographic","centerMapCRS","lookAt","eventTC","cesiumWidget","lat","lon","ele","movement3DtoPosition2D","MOUSEMOVE","detectMobile","MOUSE_MOVE","getHeightFromMDT","geoCoords","cartesian","defaultBaseLayer","triggerEvent","showReprojectDialog","haveToChange","dialogOptions","BasemapSelector","Coordinates","closeCallback","showProjectionChangeDialog","getCRS","confirm","isGeo","factory"],"mappings":"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","sourcesContent":["var TC = TC || {};\r\nTC.view = TC.view || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n(function () {\r\n    var lastTime = 0,\r\n        vendors = ['ms', 'moz', 'webkit', 'o'],\r\n        // Feature check for performance (high-resolution timers)\r\n        hasPerformance = !!(window.performance && window.performance.now);\r\n\r\n    for (var x = 0, max = vendors.length; x < max && !window.requestAnimationFrame; x += 1) {\r\n        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];\r\n        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']\r\n            || window[vendors[x] + 'CancelRequestAnimationFrame'];\r\n    }\r\n\r\n    if (!window.requestAnimationFrame) {\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            var currTime = new Date().getTime();\r\n            var timeToCall = Math.max(0, 16 - (currTime - lastTime));\r\n            var id = window.setTimeout(function () { callback(currTime + timeToCall); },\r\n                timeToCall);\r\n            lastTime = currTime + timeToCall;\r\n            return id;\r\n        };\r\n    }\r\n\r\n    if (!window.cancelAnimationFrame) {\r\n        window.cancelAnimationFrame = function (id) {\r\n            clearTimeout(id);\r\n        };\r\n    }\r\n\r\n    // Add new wrapper for browsers that don't have performance\r\n    if (!hasPerformance) {\r\n        // Store reference to existing rAF and initial startTime\r\n        var rAF = window.requestAnimationFrame,\r\n            startTime = +new Date;\r\n\r\n        // Override window rAF to include wrapped callback\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            // Wrap the given callback to pass in performance timestamp\r\n            var wrapped = function (timestamp) {\r\n                // Get performance-style timestamp\r\n                var performanceTimestamp = (timestamp < 1e12) ? timestamp : timestamp - startTime;\r\n\r\n                return callback(performanceTimestamp);\r\n            };\r\n\r\n            // Call original rAF with wrapped callback\r\n            rAF(wrapped, element);\r\n        }\r\n    }\r\n})();\r\n\r\n(function (namespace, signature, factory) {\r\n    namespace[signature] = factory();\r\n})(TC.view, \"ThreeD\", function () {\r\n\r\n    var viewProto = {\r\n        VIEWNAME: \"ThreeD\",\r\n        CLASS: 'tc-view-threed',\r\n        Consts: {\r\n            BLANK_BASE: 'blank',\r\n            DEFAULT_TILE_SIZE: 256\r\n        },\r\n        classes: {\r\n            MAPTHREED: 'tc-map-threed',\r\n            LOADING: 'tc-loading',\r\n            CAMERACTRARROWDISABLED: 'disabled-arrow',\r\n            FOCUS: 'focus',\r\n            HIGHLIGHTED: 'highlighted',\r\n            DISABLED: 'disabled',\r\n            OUTFOCUS: 'outfocus'\r\n        },\r\n        allowedControls: [],\r\n        template: {},\r\n\r\n        viewer: null,\r\n        mapView: null,\r\n        terrainProvider: null,\r\n\r\n        getLocaleString: function (key, texts) {\r\n            var self = this;\r\n            var locale = self.map ? self.map.options.locale : TC.Cfg.locale;\r\n            return TC.Util.getLocaleString(locale, key, texts);\r\n        },\r\n\r\n        getRenderedHtml: function (templateId, data, callback) {\r\n            const self = this;\r\n            return new Promise(function (resolve, reject) {\r\n                var render = function () {\r\n                    if (dust.cache[templateId]) {\r\n                        dust.render(templateId, data, function (err, out) {\r\n                            if (err) {\r\n                                TC.error(err);\r\n                                reject();\r\n                            }\r\n                            else {\r\n                                if ($.isFunction(callback)) {\r\n                                    callback(out);\r\n                                }\r\n                                resolve(out);\r\n                            }\r\n                        });\r\n                    }\r\n                };\r\n                TC.loadJSInOrder(\r\n                    !window.dust,\r\n                    TC.url.templating,\r\n                    function () {\r\n                        if (!dust.cache[templateId]) {\r\n                            var template = self.template[templateId];\r\n                            if (typeof template === 'string') {\r\n                                TC.ajax({\r\n                                    url: template,\r\n                                    method: \"get\"\r\n                                }).then(function (html) {\r\n                                    var tpl = dust.compile(html, templateId);\r\n                                    dust.loadSource(tpl);\r\n                                    render();\r\n                                });\r\n                            }\r\n                            else if ($.isFunction(template)) {\r\n                                template();\r\n                                render();\r\n                            }\r\n                        }\r\n                        else {\r\n                            render();\r\n                        }\r\n                    }\r\n                );\r\n            });\r\n        }\r\n    };\r\n\r\n    if (TC.isDebug) {\r\n        TC.Consts.url.CESIUM = TC.apiLocation + 'lib/cesium/debug/Cesium.js';\r\n    }\r\n\r\n    TC.Consts.classes.THREED = TC.Consts.classes.THREED || \"tc-threed\";\r\n    TC.Consts.classes.THREED_HIDDEN = TC.Consts.classes.THREED_HIDDEN || \"tc-threed-hidden\";\r\n    TC.Consts.event.TERRAINLOADED = TC.Consts.event.TERRAINLOADED || \"terrainloaded.tc.threed\";\r\n    TC.Consts.event.TERRAINRECEIVING = TC.Consts.event.TERRAINRECEIVING || \"terrainreceiving.tc.threed\";\r\n    TC.Consts.event.TERRAIN404 = TC.Consts.event.TERRAIN404 || \"terrain404.tc.threed\";\r\n\r\n    if (TC.isDebug) {\r\n        viewProto.template[viewProto.CLASS] = TC.apiLocation + \"TC/templates/ThreeD.html\";\r\n        viewProto.template[viewProto.CLASS + '-overlay'] = TC.apiLocation + \"TC/templates/ThreeDOverlay.html\";\r\n        viewProto.template[viewProto.CLASS + '-cm-ctls'] = TC.apiLocation + \"TC/templates/ThreeDCameraControls.html\";\r\n    } else {\r\n        viewProto.template[viewProto.CLASS + '-cm-ctls'] = function () { dust.register(viewProto.CLASS + '-cm-ctls', body_0); function body_0(chk, ctx) { return chk.w(\"<div><svg xmlns:dc=\\\"http://purl.org/dc/elements/1.1/\\\"xmlns:cc=\\\"http://creativecommons.org/ns#\\\"xmlns:rdf=\\\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\\\"xmlns:svg=\\\"http://www.w3.org/2000/svg\\\"xmlns=\\\"http://www.w3.org/2000/svg\\\"xmlns:sodipodi=\\\"http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd\\\"xmlns:inkscape=\\\"http://www.inkscape.org/namespaces/inkscape\\\"width=\\\"220\\\"height=\\\"135\\\"viewBox=\\\"0 0 63.40233 35.531682\\\"version=\\\"1.1\\\"id=\\\"threedControls\\\"><g inkscape:groupmode=\\\"layer\\\"id=\\\"backgroundLayer\\\"inkscape:label=\\\"backgroundLayer\\\"transform=\\\"translate(-2.3693123,-42.387899)\\\"><path style=\\\"fill:#ffffff;fill-opacity:0.23999999;stroke:none;stroke-width:0.2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:0.3169643;paint-order:stroke fill markers\\\"d=\\\"M 48.005285,42.387899 A 17.766048,17.766048 0 0 0 34.067635,49.16888 17.754217,17.754217 0 0 0 20.123267,42.399784 17.754217,17.754217 0 0 0 2.3693123,60.153739 a 17.754217,17.754217 0 0 0 17.7539547,17.75447 17.754217,17.754217 0 0 0 13.923699,-6.76961 17.766048,17.766048 0 0 0 13.958319,6.78098 17.766048,17.766048 0 0 0 17.766357,-17.76584 17.766048,17.766048 0 0 0 -17.766357,-17.76584 z\\\"id=\\\"background\\\"inkscape:connector-curvature=\\\"0\\\" /></g><g inkscape:label=\\\"tiltLayer\\\"inkscape:groupmode=\\\"layer\\\"id=\\\"tiltLayer\\\"transform=\\\"translate(-26.69084,-42.254264)\\\"style=\\\"display:inline\\\"><g class=\\\"tc-view-threed-cm-tilt-indicator\\\"><path class=\\\"tc-view-threed-cm-tilt-inner\\\"id=\\\"tiltInner\\\"d=\\\"m 44.44423,52.861576 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z\\\"inkscape:connector-curvature=\\\"0\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.tilt.reset\" }).w(\"</title></path><path class=\\\"tc-view-threed-cm-tilt-inner-image\\\"d=\\\"m 40.116095,64.124648 c -0.12075,-0.119221 -0.171366,-0.928328 -0.171366,-2.739326 0,-2.143319 0.03709,-2.606753 0.223349,-2.79065 0.19727,-0.194769 0.269957,-0.196719 0.622509,-0.01671 0.219537,0.112088 0.761654,0.542242 1.204705,0.955894 l 0.805547,0.752098 v 0.939855 c 0,0.51692 -0.06955,1.085596 -0.154558,1.263727 -0.173436,0.363428 -1.919571,1.804317 -2.186551,1.804317 -0.09475,0 -0.249383,-0.07614 -0.343635,-0.169192 z m 3.287741,-0.05029 c -0.307698,-0.212789 -0.317387,-0.295835 -0.317387,-2.721198 0,-1.757783 0.05096,-2.552024 0.171366,-2.670904 0.120776,-0.119243 0.941399,-0.169194 2.779684,-0.169194 2.432612,0 2.618273,0.01838 2.756146,0.27272 0.08484,0.156511 0.147831,1.267987 0.147831,2.608402 0,3.088986 0.189068,2.899662 -2.895738,2.899662 -1.872744,0 -2.3862,-0.04266 -2.641902,-0.219488 z m 0.586357,-6.180807 c -0.314529,-0.267117 -0.397432,-0.458143 -0.397432,-0.915756 0,-0.785501 0.427643,-1.207722 1.223233,-1.207722 1.162181,0 1.675866,1.23538 0.851939,2.048861 -0.522115,0.515494 -1.126934,0.542392 -1.67774,0.07462 z m 2.780604,-0.09201 c -0.374474,-0.369724 -0.423284,-0.501051 -0.3506,-0.943285 0.118405,-0.72038 0.53618,-1.088187 1.236028,-1.088187 0.699848,0 1.117624,0.367807 1.236028,1.088187 0.07269,0.442234 0.02388,0.573561 -0.3506,0.943285 -0.300932,0.297119 -0.573881,0.429526 -0.885428,0.429526 -0.311544,0 -0.584496,-0.132407 -0.885428,-0.429526 z\\\"id=\\\"tiltImage\\\"inkscape:connector-curvature=\\\"0\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.tilt.reset\" }).w(\"</title></path><path class=\\\"tc-view-threed-cm-tilt-outer tc-view-threed-cm-tilt-outer-circle\\\"id=\\\"tiltOuter\\\"d=\\\"m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z\\\"inkscape:connector-curvature=\\\"0\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.tilt.drag\" }).w(\"</title></path><path class=\\\"tc-view-threed-cm-tilt-outer tc-view-threed-cm-tilt-outer-shell-circle\\\"sodipodi:nodetypes=\\\"ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc\\\"inkscape:connector-curvature=\\\"0\\\"id=\\\"tiltShell\\\"d=\\\"m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 C 37.721509,56.11715 36.90502,57.97796 36.90502,60.0297 c 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 h 3.029207 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.tilt.drag\" }).w(\"</title></path></g></g><g id=\\\"rotateLayer\\\"inkscape:groupmode=\\\"layer\\\"inkscape:label=\\\"rotateLayer\\\"style=\\\"display:inline\\\"transform=\\\"translate(-2.3693123,-42.387899)\\\"><path class=\\\"tc-view-threed-cm-rotate-right\\\"sodipodi:nodetypes=\\\"cccccccc\\\"inkscape:connector-curvature=\\\"0\\\"id=\\\"right\\\"d=\\\"m 53.241331,72.907368 0.900176,1.930847 c 3.602027,-1.827343 6.291427,-4.493353 8.092762,-8.066897 l 0.969844,0.452626 -0.663464,-4.788009 -3.222445,2.974451 0.983506,0.459005 c -1.447339,3.107391 -3.949649,5.598011 -7.060379,7.037977 z\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.rotate.right\" }).w(\"</title></path><path class=\\\"tc-view-threed-cm-rotate-left\\\"sodipodi:nodetypes=\\\"cccccccc\\\"inkscape:connector-curvature=\\\"0\\\"id=\\\"left\\\"d=\\\"m 42.795431,72.906221 -0.900176,1.930846 c -3.602027,-1.827342 -6.291427,-4.493352 -8.092762,-8.066896 l -0.969844,0.452626 0.663465,-4.788009 3.222444,2.974451 -0.983506,0.459005 c 1.44734,3.107391 3.949649,5.598011 7.060379,7.037977 z\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.rotate.left\" }).w(\"</title></path><path class=\\\"tc-view-threed-cm-tilt-up\\\"sodipodi:nodetypes=\\\"cccccccc\\\"inkscape:connector-curvature=\\\"0\\\"id=\\\"up\\\"d=\\\"M 7.737296,54.610066 5.80645,53.70989 c 1.827342,-3.602027 4.493352,-6.291427 8.066896,-8.092762 l -0.452626,-0.969844 4.788009,0.663465 -2.974451,3.222444 -0.459005,-0.983506 c -3.107391,1.44734 -5.598011,3.949649 -7.037977,7.060379 z\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.tilt.left\" }).w(\"</title></path><path class=\\\"tc-view-threed-cm-tilt-down\\\"sodipodi:nodetypes=\\\"cccccccc\\\"inkscape:connector-curvature=\\\"0\\\"id=\\\"down\\\"d=\\\"m 7.684579,65.708846 -1.930847,0.900176 c 1.827343,3.602027 4.493353,6.291427 8.066897,8.092762 l -0.452626,0.969844 4.788009,-0.663464 -2.974451,-3.222445 -0.459005,0.983506 C 11.615165,71.321886 9.124545,68.819576 7.684579,65.708846 Z\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.tilt.right\" }).w(\"</title></path><g class=\\\"tc-view-threed-cm-rotate-indicator\\\"><path class=\\\"tc-view-threed-cm-rotate-inner\\\"inkscape:connector-curvature=\\\"0\\\"d=\\\"m 48.010487,52.995444 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z\\\"id=\\\"rotateInner\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.rotate.reset\" }).w(\"</title></path><path class=\\\"tc-view-threed-cm-rotate-inner-image\\\"d=\\\"m 45.461645,60.604061 c 0.860585,-1.857231 1.777009,-3.864779 2.036499,-4.461218 0.471802,-1.084433 0.471802,-1.084433 0.66474,-0.667935 2.070474,4.46957 3.86201,8.443545 3.825603,8.485934 -0.02561,0.02982 -0.943964,-0.165127 -2.040793,-0.433206 -1.994234,-0.487419 -1.994234,-0.487419 -3.881098,-0.01711 -1.037775,0.258673 -1.950491,0.470314 -2.028258,0.470314 -0.07777,0 0.562721,-1.519553 1.423307,-3.376784 z m 1.23418,2.027617 c 1.353421,-0.310159 1.353421,-0.310159 1.353421,-2.998288 0,-1.534227 -0.05572,-2.627602 -0.129797,-2.547123 -0.101525,0.110295 -2.316061,4.831583 -2.659547,5.670031 -0.09645,0.23543 -0.15884,0.240844 1.435923,-0.12462 z\\\"id=\\\"rotateImage\\\"inkscape:connector-curvature=\\\"0\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.rotate.reset\" }).w(\"</title></path><path class=\\\"tc-view-threed-cm-rotate-outer tc-view-threed-cm-rotate-outer-circle\\\"inkscape:connector-curvature=\\\"0\\\"d=\\\"m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z\\\"id=\\\"rotateOuter\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.rotate.drag\" }).w(\"</title></path><path class=\\\"tc-view-threed-cm-rotate-outer tc-view-threed-cm-rotate-outer-shell-circle\\\"d=\\\"m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 c -1.326946,1.360319 -2.143435,3.221129 -2.143435,5.272869 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 H 58.8088 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z\\\"id=\\\"rotateShell\\\"inkscape:connector-curvature=\\\"0\\\"sodipodi:nodetypes=\\\"ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc\\\"><title>\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.rotate.drag\" }).w(\"</title></path></g> </g></svg></div>\"); } body_0.__dustBody = !0; return body_0 };\r\n        viewProto.template[viewProto.CLASS + '-overlay'] = function () { dust.register(viewProto.CLASS + '-overlay', body_0); function body_0(chk, ctx) { return chk.w(\"<div class=\\\"tc-view-threed-overlay\\\" hidden><svg class=\\\"tc-view-threed-overlay-svg\\\"><defs><filter id=\\\"fGaussian\\\" x=\\\"0\\\" y=\\\"0\\\"><feGaussianBlur in=\\\"SourceGraphic\\\" stdDeviation=\\\"3\\\" /></filter></defs><rect width=\\\"100%\\\" height=\\\"100%\\\" fill=\\\"white\\\" fill-opacity=\\\"0.5\\\" filter=\\\"url(#fGaussian)\\\" /> </svg> </div>\"); } body_0.__dustBody = !0; return body_0 };\r\n        viewProto.template[viewProto.CLASS] = function () { dust.register(viewProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<button class=\\\"tc-ctl-threed-btn tc-beta-button\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"threed.tip\" }).w(\"\\\"></button>\"); } body_0.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    const MapView = function (map, parent) {\r\n        var self = this;\r\n        self.map = map;\r\n        self.parent = parent;\r\n\r\n        Promise.resolve(self.map.getViewHTML()).then(function (html) {\r\n            self.viewHTML = html;\r\n        }.bind(self));\r\n\r\n        self.metersPerUnit = map.getMetersPerUnit();\r\n\r\n        self.maxResolution;\r\n\r\n        //flacunza: modificamos TC.Map.setCenter para que se haga desde la vista 3D cuando está activa\r\n        //así evitamos parpadeos en el mapa de situación\r\n        self._oldMapSetCenter = map.setCenter;\r\n        map.setCenter = function (coords, options) {\r\n            if (map.on3DView) {\r\n                map.view3D.flyToMapCoordinates.call(parent, coords);\r\n            }\r\n            else {\r\n                self._oldMapSetCenter.call(map, coords, options);\r\n            }\r\n        };\r\n    };\r\n    MapView.prototype.getCenter = function () {\r\n        return this.map.getCenter();\r\n    };\r\n    MapView.prototype.getExtent = function () {\r\n        return this.map.getExtent();\r\n    };\r\n    MapView.prototype.getResolution = function () {\r\n        return this.map.getResolution();\r\n    };\r\n    MapView.prototype.getRotation = function () {\r\n        return this.map.getRotation();\r\n    };\r\n    MapView.prototype.getMaxResolution = function () {\r\n        if (this.maxResolution)\r\n            return this.maxResolution;\r\n\r\n        if (this.map.getResolutions() !== null)\r\n            this.maxResolution = this.map.getResolutions()[0];\r\n        else {\r\n            var extent = this.map.options.baselayerExtent;\r\n            this.maxResolution = (extent[2] - extent[0]) / this.parent.Consts.DEFAULT_TILE_SIZE;\r\n        }\r\n\r\n        return this.maxResolution;\r\n    };\r\n    MapView.prototype.getPixelFromCoordinate = function (coords) {\r\n        return this.map.getPixelFromCoordinate(coords);\r\n    };\r\n    MapView.prototype.setCenter = function (center) {\r\n        this._oldMapSetCenter.call(this.map, center);\r\n    };\r\n    MapView.prototype.setExtent = function (extent) {\r\n        this.map.setExtent(extent);\r\n    };\r\n    MapView.prototype.setResolution = function (resolution) {\r\n        this.map.setResolution(resolution);\r\n    };\r\n    MapView.prototype.setRotation = function (rotation) {\r\n        this.map.setRotation(rotation);\r\n    };\r\n\r\n\r\n    //  Funciones compatibilidad CRS\r\n    var isCompatible = function (layer, crs) {\r\n        return layer.type === TC.Consts.layerType.WMTS ?\r\n            layer.wrap.getCompatibleMatrixSets(crs).length > 0 :\r\n            layer.isCompatible(crs);\r\n    };\r\n\r\n    // Funciones para cálculo de FOV\r\n    var getFarCoords = function (origin, nearPoint) {\r\n        var radius = 1000000; // 1000 km\r\n        var dx = nearPoint[0] - origin[0];\r\n        var dy = nearPoint[1] - origin[1];\r\n        var angle = Math.atan(dy / dx);\r\n        // Math.atan solo da resultados entre -90º y 90º, si estamos mirando al hemisferio oeste hay que sumar 180º al ángulo\r\n        if (dx < 0) {\r\n            angle = angle + Math.PI;\r\n        }\r\n        return [origin[0] + radius * Math.cos(angle), origin[1] + radius * Math.sin(angle)];\r\n    };\r\n\r\n    var distanceSquared = function (p1, p2) {\r\n        var dx = p2[0] - p1[0];\r\n        var dy = p2[1] - p1[1];\r\n        return dx * dx + dy * dy;\r\n    };\r\n\r\n    var getFarMapCoords = function (obj) {\r\n        // Calculamos puntos lejanos cuando no los tenemos (cuando estamos mirando al horizonte).\r\n        // Cogemos un punto proyectado desde la esquina inferior del canvas, \r\n        // cogemos un segundo punto en el lateral del canvas inmediatamente por encima \r\n        // y prologamos la línea que pasa por ambos puntos proyectados.\r\n        var self = this;\r\n        obj = obj || {};\r\n        if (obj.nearMapCoords) {\r\n            var nextPixel = obj.bottomPixel.clone();\r\n            nextPixel.y = Math.round(nextPixel.y * 9 / 10);\r\n            var nextCoords = pickMapCoords.call(self, nextPixel);\r\n            if (nextCoords) {\r\n                // Ordenamos la dupla por distancia, porque si estamos mirando desde dentro de un monte \r\n                // el punto que se supone que es el más lejano en realidad está más cerca.\r\n                var coordsArray = [obj.nearMapCoords, nextCoords].sort(function (a, b) {\r\n                    return distanceSquared(obj.cameraPosition, a) - distanceSquared(obj.cameraPosition, b);\r\n                });\r\n                return getFarCoords.apply(this, coordsArray);\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    var pickMapCoords = function (pixel) {\r\n        var self = this;\r\n        var pickPoint = pickOnTerrainOrEllipsoid(self.viewer.scene, pixel);\r\n        if (pickPoint) {\r\n            pickPoint = Cesium.Cartographic.fromCartesian(pickPoint);\r\n            if (self.view3D.crs !== self.view3D.view2DCRS) {\r\n                return TC.Util.reproject([Cesium.Math.toDegrees(pickPoint.longitude), Cesium.Math.toDegrees(pickPoint.latitude)], self.view3D.crs, self.view3D.view2DCRS);\r\n            } else {\r\n                return [Cesium.Math.toDegrees(pickPoint.longitude), Cesium.Math.toDegrees(pickPoint.latitude)];\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // Funciones utilidades cámara\r\n    var calcDistanceForResolution = function (resolution, latitude) {\r\n        var self = this;\r\n\r\n        var fovy = self.viewer.camera.frustum.fovy;\r\n        var visibleMapUnits = resolution * self.mapView.viewHTML.getBoundingClientRect().height;\r\n        var relativeCircumference = Math.cos(Math.abs(latitude));\r\n        var visibleMeters = visibleMapUnits * self.mapView.metersPerUnit * relativeCircumference;\r\n\r\n        return (visibleMeters / 2) / Math.tan(fovy / 2);\r\n    };\r\n\r\n    var calcResolutionForDistance = function (distance, latitude) {\r\n        var self = this;\r\n\r\n        var canvas = self.viewer.scene.canvas;\r\n        var fovy = self.viewer.camera.frustum.fovy;\r\n\r\n        var visibleMeters = 2 * distance * Math.tan(fovy / 2);\r\n        var relativeCircumference = Math.cos(Math.abs(latitude));\r\n        var visibleMapUnits = visibleMeters / self.mapView.metersPerUnit / relativeCircumference;\r\n        var resolution = visibleMapUnits / canvas.clientHeight;\r\n\r\n        // validamos que la resolución calculada esté disponible en el array de resoluciones disponibles\r\n        // si no contamos con un array de resoluciones lo calculamos\r\n        var resolutions = self.map.getResolutions();\r\n        if (resolutions == null) {\r\n            resolutions = new Array(22);\r\n            for (var i = 0, ii = resolutions.length; i < ii; ++i) {\r\n                resolutions[i] = self.mapView.getMaxResolution() / Math.pow(2, i);\r\n            }\r\n        }\r\n\r\n        // obtenemos la resolución más próxima a la calculada\r\n        for (var i = 0; i < resolutions.length; i++) {\r\n            if (resolutions[i] < Math.abs(resolution)) {\r\n                resolution = resolutions[i - 1];\r\n                break;\r\n            } else if (resolutions[i] === Math.abs(resolution)) {\r\n                resolution = resolutions[i];\r\n                break;\r\n            } else if (i === resolutions.length - 1) {\r\n                resolution = resolutions[i];\r\n            }\r\n        }\r\n\r\n        return resolution;\r\n    };\r\n\r\n    var rotateAroundAxis = function (camera, angle, axis, transform, opt_options) {\r\n        var clamp = Cesium.Math.clamp;\r\n        var defaultValue = Cesium.defaultValue;\r\n\r\n        var options = opt_options || {};\r\n        var duration = defaultValue(options.duration, 500); // ms\r\n\r\n        var linear = function (a) {\r\n            return a\r\n        };\r\n        var easing = defaultValue(options.easing, linear);\r\n        var callback = options.callback;\r\n\r\n        var start;\r\n        var lastProgress = 0;\r\n        var oldTransform = new Cesium.Matrix4();\r\n\r\n        return new Promise(function (resolve, reject) {\r\n\r\n            function animation(timestamp) {\r\n                if (!start)\r\n                    start = timestamp;\r\n\r\n                var progress = easing(clamp((timestamp - start) / duration, 0, 1));\r\n\r\n                camera.transform.clone(oldTransform);\r\n                var stepAngle = (progress - lastProgress) * angle;\r\n                lastProgress = progress;\r\n\r\n                camera.lookAtTransform(transform);\r\n                camera.rotate(axis, stepAngle);\r\n                camera.lookAtTransform(oldTransform);\r\n\r\n                if (progress < 1) {\r\n                    requestAnimationFrame(animation);\r\n                } else {\r\n                    if (callback) {\r\n                        callback();\r\n                    }\r\n                    resolve();\r\n                }\r\n\r\n            }\r\n\r\n            requestAnimationFrame(animation);\r\n        });\r\n    };\r\n\r\n    var pickOnTerrainOrEllipsoid = function (scene, pixel) {\r\n        var self = this;\r\n\r\n        var ray = scene.camera.getPickRay(pixel);\r\n        var target = scene.globe.pick(ray, scene);\r\n        return target || scene.camera.pickEllipsoid(pixel);\r\n    };\r\n\r\n    var pickCenterPoint = function (scene) {\r\n        var self = this;\r\n\r\n        var canvas = scene.canvas;\r\n        var center = new Cesium.Cartesian2(\r\n            canvas.clientWidth / 2,\r\n            canvas.clientHeight / 2);\r\n        return pickOnTerrainOrEllipsoid(scene, center);\r\n    };\r\n\r\n    var pickBottomPoint = function (scene) {\r\n        var self = this;\r\n\r\n        var canvas = scene.canvas;\r\n        var bottom = new Cesium.Cartesian2(\r\n            canvas.clientWidth / 2, canvas.clientHeight);\r\n        return pickOnTerrainOrEllipsoid(scene, bottom);\r\n    };\r\n\r\n    var bottomFovRay = function (scene) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        var fovy2 = camera.frustum.fovy / 2;\r\n        var direction = camera.direction;\r\n        var rotation = Cesium.Quaternion.fromAxisAngle(camera.right, fovy2);\r\n        var matrix = Cesium.Matrix3.fromQuaternion(rotation);\r\n        var vector = new Cesium.Cartesian3();\r\n        Cesium.Matrix3.multiplyByVector(matrix, direction, vector);\r\n        return new Cesium.Ray(camera.position, vector);\r\n    };\r\n\r\n    var setHeadingUsingBottomCenter = function (scene, heading, bottomCenter, opt_options) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        // Compute the camera position to zenith quaternion\r\n        var angleToZenith = computeAngleToZenith(scene, bottomCenter);\r\n        var axis = camera.right;\r\n        var quaternion = Cesium.Quaternion.fromAxisAngle(axis, angleToZenith);\r\n        var rotation = Cesium.Matrix3.fromQuaternion(quaternion);\r\n\r\n        // Get the zenith point from the rotation of the position vector\r\n        var vector = new Cesium.Cartesian3();\r\n        Cesium.Cartesian3.subtract(camera.position, bottomCenter, vector);\r\n        var zenith = new Cesium.Cartesian3();\r\n        Cesium.Matrix3.multiplyByVector(rotation, vector, zenith);\r\n        Cesium.Cartesian3.add(zenith, bottomCenter, zenith);\r\n\r\n        // Actually rotate around the zenith normal\r\n        var transform = Cesium.Matrix4.fromTranslation(zenith);\r\n        rotateAroundAxis(camera, heading, zenith, transform, opt_options);\r\n    };\r\n\r\n    var signedAngleBetween = function (first, second, normal) {\r\n        var self = this;\r\n\r\n        // We are using the dot for the angle.\r\n        // Then the cross and the dot for the sign.\r\n        var a = new Cesium.Cartesian3();\r\n        var b = new Cesium.Cartesian3();\r\n        var c = new Cesium.Cartesian3();\r\n        Cesium.Cartesian3.normalize(first, a);\r\n        Cesium.Cartesian3.normalize(second, b);\r\n        Cesium.Cartesian3.cross(a, b, c);\r\n\r\n        var cosine = Cesium.Cartesian3.dot(a, b);\r\n        var sine = Cesium.Cartesian3.magnitude(c);\r\n\r\n        // Sign of the vector product and the orientation normal\r\n        var sign = Cesium.Cartesian3.dot(normal, c);\r\n        var angle = Math.atan2(sine, cosine);\r\n        return sign >= 0 ? angle : -angle;\r\n    };\r\n\r\n    var computeAngleToZenith = function (scene, pivot) {\r\n        var self = this;\r\n\r\n        // This angle is the sum of the angles 'fy' and 'a', which are defined\r\n        // using the pivot point and its surface normal.\r\n        //        Zenith |    camera\r\n        //           \\   |   /\r\n        //            \\fy|  /\r\n        //             \\ |a/\r\n        //              \\|/pivot\r\n        var camera = scene.camera;\r\n        var fy = camera.frustum.fovy / 2;\r\n        var ray = bottomFovRay(scene);\r\n        var direction = Cesium.Cartesian3.clone(ray.direction);\r\n        Cesium.Cartesian3.negate(direction, direction);\r\n\r\n        var normal = new Cesium.Cartesian3();\r\n        Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(pivot, normal);\r\n\r\n        var left = new Cesium.Cartesian3();\r\n        Cesium.Cartesian3.negate(camera.right, left);\r\n\r\n        var a = signedAngleBetween(normal, direction, left);\r\n        return a + fy;\r\n    };\r\n\r\n    var computeSignedTiltAngleOnGlobe = function (scene) {\r\n        var self = this;\r\n\r\n        var camera = scene.camera;\r\n        var ray = new Cesium.Ray(camera.position, camera.direction);\r\n        var target = scene.globe.pick(ray, scene);\r\n\r\n        if (!target) {\r\n            // no tiles in the area were loaded?\r\n            var ellipsoid = Cesium.Ellipsoid.WGS84;\r\n            var obj = Cesium.IntersectionTests.rayEllipsoid(ray, ellipsoid);\r\n            if (obj) {\r\n                target = Cesium.Ray.getPoint(ray, obj.start);\r\n            }\r\n        }\r\n\r\n        if (!target) {\r\n            return undefined;\r\n        }\r\n\r\n        var normal = new Cesium.Cartesian3();\r\n        Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(target, normal);\r\n\r\n        var angleBetween = signedAngleBetween;\r\n        var angle = angleBetween(camera.direction, normal, camera.right) - Math.PI;\r\n        return Cesium.Math.convertLongitudeRange(angle);\r\n    };\r\n\r\n    // Funciones CZML    \r\n    var toCZML = function (coordinates, layout, name, pointStyle, lineStyle, walkingSpeed) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            var positions = coordinates.map(function (coordinate) {\r\n                var reprojected = coordinate;\r\n                if (self.view3D.view2DCRS !== self.view3D.crs) {\r\n                    reprojected = TC.Util.reproject(coordinate, self.view3D.view2DCRS, self.view3D.crs);\r\n                }\r\n                return Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n            });\r\n\r\n            Cesium.when(self.viewer.terrainProvider.sampleTerrainMostDetailed(positions), function (updatedPositions) {\r\n                var startTime, stopTime, totalDistance = 0;\r\n\r\n                if (layout === ol.geom.GeometryLayout.XYZM) {\r\n                    startTime = coordinates[0][3];\r\n                    stopTime = coordinates[coordinates.length - 1][3];\r\n                } else if (layout === ol.geom.GeometryLayout.XYM) {\r\n                    startTime = coordinates[0][2];\r\n                    stopTime = coordinates[coordinates.length - 1][2];\r\n                } else {\r\n\r\n                    coordinates[0][3] = updatedPositions[0].time = Date.now();\r\n\r\n                    for (var i = 1; i < updatedPositions.length; i++) {\r\n                        var done;\r\n                        var previuos_next = [];\r\n\r\n                        updatedPositions[i].time = 0;\r\n\r\n                        if (i + 1 < updatedPositions.length) {\r\n                            previuos_next = updatedPositions.slice(i - 1, i + 1);\r\n                        } else {\r\n                            previuos_next = updatedPositions.slice(i - 1);\r\n                        }\r\n\r\n                        done = new Cesium.EllipsoidGeodesic(previuos_next[0], previuos_next[1]).surfaceDistance;\r\n\r\n                        totalDistance += done;\r\n\r\n                        coordinates[i][3] = updatedPositions[i].time = updatedPositions[i - 1].time + (3600000 * done / walkingSpeed);\r\n                    }\r\n\r\n                    startTime = updatedPositions[0].time;\r\n                    stopTime = updatedPositions[updatedPositions.length - 1].time;\r\n                }\r\n\r\n                if (totalDistance === 0) {\r\n                    for (var i = 1; i < updatedPositions.length; i++) {\r\n                        var previuos_next = [];\r\n\r\n                        if (i + 1 < updatedPositions.length) {\r\n                            previuos_next = updatedPositions.slice(i - 1, i + 1);\r\n                        } else {\r\n                            previuos_next = updatedPositions.slice(i - 1);\r\n                        }\r\n\r\n                        totalDistance += new Cesium.EllipsoidGeodesic(previuos_next[0], previuos_next[1]).surfaceDistance;\r\n                    }\r\n                }\r\n\r\n                startTime = new Date(startTime).toISOString();\r\n                stopTime = new Date(stopTime).toISOString();\r\n\r\n                var czml = [{\r\n                    \"id\": \"document\",\r\n                    \"name\": \"CZML Model\",\r\n                    \"version\": \"1.0\"\r\n                }, {\r\n                    \"id\": \"path\",\r\n                    \"name\": name,\r\n                    \"availability\": startTime + \"/\" + stopTime,\r\n                    \"position\": {\r\n                        \"epoch\": startTime,\r\n                        \"cartographicRadians\": updatedPositions.map(function (updatedPosition, i) {\r\n                            return layout === ol.geom.GeometryLayout.XYZM ? [new Date(coordinates[i][3]).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height] :\r\n                                layout === ol.geom.GeometryLayout.XYM ? [new Date(coordinates[i][2]).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height] :\r\n                                    [new Date(updatedPosition.time).toISOString(), updatedPosition.longitude, updatedPosition.latitude, updatedPosition.height];\r\n                        }).reduce(function (prev, curr) {\r\n                            return prev.concat(curr);\r\n                        })\r\n                    },\r\n                    \"point\": {\r\n                        \"heightReference\": \"CLAMP_TO_GROUND\",\r\n                        \"pixelSize\": pointStyle.radius,\r\n                        \"color\": {\r\n                            \"rgba\": pointStyle.fillColor\r\n                        },\r\n                        \"outlineColor\": {\r\n                            \"rgba\": pointStyle.strokeColor\r\n                        },\r\n                        \"outlineWidth\": pointStyle.strokeWidth\r\n                    }\r\n                }];\r\n\r\n                resolve({ czml: czml, totalDistance: totalDistance, coordinates2D: coordinates });\r\n            });\r\n        });\r\n    };\r\n\r\n    const CameraControls = function (parent) {\r\n        var self = this;\r\n\r\n        self.parent = parent;\r\n\r\n        var outHandler = function (e) {\r\n            var self = this;\r\n\r\n            self.isFocusingCameraCtrls = false;\r\n        };\r\n        var inHandler = function () {\r\n            var self = this;\r\n\r\n            self.isFocusingCameraCtrls = true;\r\n            self.lastFocused = performance.now();\r\n\r\n            if (self.div.classList.contains(self.parent.classes.OUTFOCUS)) {\r\n                self.div.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.tiltIndicatorOuterCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.tiltIndicatorOuterShellCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.rotateIndicatorOuterCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n                self.rotateIndicatorOuterShellCircle.classList.remove(self.parent.classes.OUTFOCUS);\r\n            }\r\n        };\r\n\r\n        var moveStartHandler = function () {\r\n            var self = this;\r\n            self.moving = true;\r\n        };\r\n        var moveEndHandler = function () {\r\n            var self = this;\r\n            self.moving = false;\r\n        };\r\n        var postRenderHandler = function () {\r\n            var self = this;\r\n            var view = self.parent;\r\n\r\n            if (self.parent.view3D.isLoadingTiles.call(self.parent))\r\n                self.customCollisionDetection();\r\n\r\n            var camera = self.getCamera();\r\n            var position = camera.positionCartographic;\r\n\r\n            if (self.moving) {\r\n\r\n                cssRotate(self.tiltIndicator, camera.pitch);\r\n                cssRotate(self.rotateIndicator, -camera.heading);\r\n\r\n                self.disableRotate();\r\n                self.disableTilt(5);\r\n\r\n                if (view.view3D.crs !== view.view3D.view2DCRS) {\r\n                    self._coordsXY = TC.Util.reproject([Cesium.Math.toDegrees(position.longitude), Cesium.Math.toDegrees(position.latitude)], view.view3D.crs, view.view3D.view2DCRS);\r\n                } else {\r\n                    self._coordsXY = [Cesium.Math.toDegrees(position.longitude), Cesium.Math.toDegrees(position.latitude)];\r\n                }\r\n\r\n                view.mapView.setCenter(self._coordsXY);\r\n                view.mapView.setResolution(calcResolutionForDistance.call(view, position.height, position.latitude));\r\n\r\n                //view.mapView.setRotation(-camera.heading);\r\n            }\r\n\r\n            // flacunza: calculamos el polígono de FOV para dibujar en el mapa de situación\r\n            // Lo calculamos aunque no nos estemos moviendo porque el terreno puede estar cargándose\r\n            if (self._coordsXY) {\r\n                view._ovMap = view._ovMap || view.map.getControlsByClass('TC.control.OverviewMap')[0];\r\n                if (view._ovMap) {\r\n                    view._ovMap.renderPromise().then(function () {\r\n                        var scene = view.viewer.scene;\r\n                        var canvas = scene.canvas;\r\n                        var bottomLeft = new Cesium.Cartesian2(0, canvas.clientHeight - 1);\r\n                        var bottomRight = new Cesium.Cartesian2(canvas.clientWidth - 1, canvas.clientHeight - 1);\r\n                        var fovCoords = [\r\n                            bottomLeft,\r\n                            bottomRight,\r\n                            new Cesium.Cartesian2(canvas.clientWidth - 1, 0),\r\n                            new Cesium.Cartesian2(0, 0)\r\n                        ].map(function (elm) {\r\n                            return pickMapCoords.call(view, elm);\r\n                        }).filter(function (elm) {\r\n                            return elm !== null;\r\n                        });\r\n                        if (fovCoords.length && fovCoords.length < 4) { // Vemos horizonte\r\n                            // flacunza: Si vemos horizonte no tenemos puntos de terreno para las esquinas superiores, \r\n                            // por eso intentamos calcular unos puntos \"en el infinito\".\r\n                            var farCoordsLeft = getFarMapCoords.call(view, {\r\n                                nearMapCoords: fovCoords[0],\r\n                                bottomPixel: bottomLeft,\r\n                                cameraPosition: self._coordsXY\r\n                            });\r\n                            var farCoordsRight = getFarMapCoords.call(view, {\r\n                                nearMapCoords: fovCoords[1],\r\n                                bottomPixel: bottomRight,\r\n                                cameraPosition: self._coordsXY\r\n                            });\r\n                            if (farCoordsLeft && farCoordsRight) {\r\n                                fovCoords[2] = farCoordsRight;\r\n                                fovCoords[3] = farCoordsLeft;\r\n                            }\r\n\r\n                        }\r\n                        view._ovMap.wrap.draw3DCamera({ position: self._coordsXY, heading: camera.heading, fov: fovCoords });\r\n                    });\r\n                }\r\n            }\r\n\r\n        };\r\n        var cssRotate = function (element, angle) {\r\n            var coord = element.getBBox();\r\n            value = 'rotate(' + Cesium.Math.toDegrees(angle) + ' ' + (coord.x + (coord.width / 2)) + ' ' + (coord.y + (coord.height / 2)) + ')';\r\n            document.getElementsByClassName(element.className.baseVal)[0].setAttribute('transform', value);\r\n        };\r\n\r\n        self.outControlsEvents = TC.Util.detectMouse() ? ['mouseleave'] : ['touchleave', 'touchend'];\r\n        self.outControls = outHandler.bind(self);\r\n\r\n        self.inControlsEvents = TC.Util.detectMouse() ? ['mouseenter'] : ['touchmove', 'touchstart'];\r\n        self.inControls = inHandler.bind(self);\r\n\r\n        self.moveStart = moveStartHandler.bind(self);\r\n        self.moveEnd = moveEndHandler.bind(self);\r\n        self.postRender = postRenderHandler.bind(self);\r\n\r\n        self.selectors = {\r\n            tilt: '-cm-tilt',\r\n            rotate: '-cm-rotate',\r\n            indicator: '-indicator',\r\n            leftArrow: '-left',\r\n            rightArrow: '-right',\r\n            downArrow: '-down',\r\n            upArrow: '-up'\r\n        };\r\n\r\n        self.MIN_TILT = Cesium.Math.toRadians(-89);\r\n        self.MAX_TILT = Cesium.Math.toRadians(-1);\r\n\r\n        self.render();\r\n    };\r\n    CameraControls.prototype.bind = function () {\r\n        var self = this;\r\n\r\n        // conexión de los controles con el visor de cesium\r\n        self.getCamera().moveStart.addEventListener(self.moveStart);\r\n        self.getCamera().moveEnd.addEventListener(self.moveEnd);\r\n        self.parent.viewer.scene.postRender.addEventListener(self.postRender);\r\n\r\n        // gestionamos la opacidad de los controles pasados 5 segundos\r\n        self.outControlsEvents.forEach(function (event) {\r\n            self.div.addEventListener(event, self.outControls);\r\n        });\r\n        self.inControlsEvents.forEach(function (event) {\r\n            self.div.addEventListener(event, self.inControls);\r\n        });\r\n\r\n        function setOpacity() {\r\n            if (!self.lastFocused)\r\n                self.lastFocused = performance.now();\r\n\r\n            var progress = performance.now() - self.lastFocused;\r\n            if (progress > 5000 && self.isFocusingCameraCtrls !== true) {\r\n                if (!self.div.classList.contains(self.parent.classes.OUTFOCUS)) {\r\n                    self.div.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.tiltIndicatorOuterCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.tiltIndicatorOuterShellCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.rotateIndicatorOuterCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                    self.rotateIndicatorOuterShellCircle.classList.add(self.parent.classes.OUTFOCUS);\r\n                }\r\n            }\r\n\r\n            self.rAFInOutControls = requestAnimationFrame(setOpacity);\r\n        }\r\n        self.rAFInOutControls = requestAnimationFrame(setOpacity);\r\n    };\r\n    CameraControls.prototype.unbind = function () {\r\n        var self = this;\r\n\r\n        self.div.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n        // conexión de los controles con el visor de cesium\r\n        self.getCamera().moveStart.removeEventListener(self.moveStart);\r\n        self.getCamera().moveEnd.removeEventListener(self.moveEnd);\r\n        self.parent.viewer.scene.postRender.removeEventListener(self.postRender);\r\n\r\n        // gestionamos la opacidad de los controles pasados 5 segundos\r\n        self.outControlsEvents.forEach(function (event) {\r\n            self.div.removeEventListener(event, self.outControls);\r\n        });\r\n        self.inControlsEvents.forEach(function (event) {\r\n            self.div.removeEventListener(event, self.inControls);\r\n        });\r\n        window.cancelAnimationFrame(self.rAFInOutControls);\r\n        self.lastFocused = undefined;\r\n        self.rAFInOutControls = undefined;\r\n    };\r\n    CameraControls.prototype.getCamera = function () {\r\n        var self = this;\r\n\r\n        return self.parent.viewer.scene.camera;\r\n    };\r\n    CameraControls.prototype.getCameraState = function () {\r\n        var self = this;\r\n\r\n        if (self.parent.viewer) {\r\n            var camera = self.parent.viewer.scene.camera;\r\n            var cameraPosition = camera.positionCartographic;\r\n\r\n            var bottomCenter = pickBottomPoint(self.parent.viewer.scene);\r\n            if (bottomCenter) {\r\n                var distance = Cesium.Cartesian3.distance(camera.position, bottomCenter);\r\n\r\n                return {\r\n                    cp: [cameraPosition.longitude, cameraPosition.latitude, cameraPosition.height],\r\n                    chpr: [camera.heading, camera.pitch, camera.roll],\r\n                    bcpd: distance\r\n                };\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.render = function () {\r\n        var self = this;\r\n\r\n        if (self.div) {\r\n            self.div.classList.remove(TC.Consts.classes.HIDDEN);\r\n            self.bind();\r\n        }\r\n        else {\r\n            self.parent.getRenderedHtml(self.parent.CLASS + '-cm-ctls', {}, function (html) {\r\n                // contenedor controles\r\n                self.div = document.createElement('div');\r\n                self.div.classList.add(self.parent.CLASS + '-cm-ctls');\r\n                self.div.innerHTML = html;\r\n                self.parent.map.div.appendChild(self.div);\r\n\r\n\r\n                // tilt\r\n                var tiltSelector = '.' + self.parent.CLASS + self.selectors.tilt;\r\n\r\n                self.tiltIndicatorInner = self.div.querySelector(\"[class^=\" + tiltSelector.replace('.', '') + \"-inner\" + \"]\");\r\n                self.tiltIndicatorInner.addEventListener(TC.Consts.event.CLICK, self.resetTilt.bind(self));\r\n\r\n                self.tiltIndicator = self.div.querySelector(tiltSelector + '-indicator');\r\n\r\n                self.tiltIndicatorOuterCircle = self.div.querySelector(tiltSelector + '-outer-circle');\r\n                self.tiltIndicatorOuterShellCircle = self.div.querySelector(tiltSelector + '-outer-shell-circle');\r\n\r\n                self.tiltIndicatorCircle = self.div.querySelector(\"[class^=\" + tiltSelector.replace('.', '') + \"-outer\" + \"]\");\r\n                self.tiltIndicatorCircle.addEventListener('mousedown', function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var vectorScratch = new Cesium.Cartesian2();\r\n                    var element = e.currentTarget;\r\n                    var rectangle = e.currentTarget.getBoundingClientRect();\r\n                    var center = new Cesium.Cartesian2((rectangle.right - rectangle.left) / 2.0, (rectangle.bottom - rectangle.top) / 2.0);\r\n                    var clickLocation = new Cesium.Cartesian2(e.clientX - rectangle.left, e.clientY - rectangle.top);\r\n                    var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n                    self.draggingTilt.call(self, element, vector);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // left\r\n                self.tiltUp = self.div.querySelector(tiltSelector + self.selectors.upArrow);\r\n                self.tiltUp.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.target.disabled) {\r\n                        if (e.stopPropagation) e.stopPropagation();\r\n                        if (e.preventDefault) e.preventDefault();\r\n\r\n                        e.cancelBubble = true;\r\n                        e.returnValue = false;\r\n                        return false;\r\n                    }\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n                    self.tiltUpMouseUpFunction = undefined;\r\n\r\n                    self.tilt.call(self, +5);\r\n\r\n                    self.tiltUpInterval = setInterval(function () {\r\n                        if (!self.isTiltUpDisabled) self.tilt.call(self, +5);\r\n                        else self.tiltUpMouseUpFunction();\r\n                    }.bind(self), 101);\r\n\r\n                    self.tiltUpMouseUpFunction = function () {\r\n                        clearInterval(self.tiltUpInterval);\r\n                        self.tiltUpInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n                        self.tiltUpMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.tiltUpMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // right\r\n                self.tiltDown = self.div.querySelector(tiltSelector + self.selectors.downArrow);\r\n                self.tiltDown.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n\r\n                    if (e.target.disabled) {\r\n                        if (e.stopPropagation) e.stopPropagation();\r\n                        if (e.preventDefault) e.preventDefault();\r\n\r\n                        e.cancelBubble = true;\r\n                        e.returnValue = false;\r\n                        return false;\r\n                    }\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n                    self.tiltDownMouseUpFunction = undefined;\r\n\r\n                    self.tilt.call(self, -5);\r\n\r\n                    self.tiltDownInterval = setInterval(function () {\r\n                        if (!self.isTiltDownDisabled) self.tilt.call(self, -5);\r\n                        else self.tiltDownMouseUpFunction();\r\n                    }.bind(self), 101);\r\n\r\n                    self.tiltDownMouseUpFunction = function () {\r\n                        clearInterval(self.tiltDownInterval);\r\n                        self.tiltDownInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n                        self.tiltDownMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.tiltDownMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // rotation\r\n                var rotateSelector = '.' + self.parent.CLASS + self.selectors.rotate;\r\n\r\n                self.rotateIndicatorInner = self.div.querySelector(\"[class^=\" + rotateSelector.replace('.', '') + \"-inner\" + \"]\");\r\n                self.rotateIndicatorInner.addEventListener(TC.Consts.event.CLICK, self.resetRotation.bind(self));\r\n\r\n                self.rotateIndicator = self.div.querySelector(rotateSelector + '-indicator');\r\n\r\n                self.rotateIndicatorOuterCircle = self.div.querySelector(rotateSelector + '-outer-circle');\r\n                self.rotateIndicatorOuterShellCircle = self.div.querySelector(rotateSelector + '-outer-shell-circle');\r\n\r\n                self.rotateIndicatorCircle = self.div.querySelector(\"[class^=\" + rotateSelector.replace('.', '') + \"-outer\" + \"]\");\r\n                self.rotateIndicatorCircle.addEventListener('mousedown', function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var vectorScratch = new Cesium.Cartesian2();\r\n                    var element = e.currentTarget;\r\n                    var rectangle = e.currentTarget.getBoundingClientRect();\r\n                    var center = new Cesium.Cartesian2((rectangle.right - rectangle.left) / 2.0, (rectangle.bottom - rectangle.top) / 2.0);\r\n                    var clickLocation = new Cesium.Cartesian2(e.clientX - rectangle.left, e.clientY - rectangle.top);\r\n                    var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n                    self.draggingRotate.call(self, element, vector);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n                }.bind(self));\r\n\r\n                // left\r\n                self.rotateLeft = self.div.querySelector(rotateSelector + self.selectors.leftArrow);\r\n                self.rotateLeft.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n                    self.rotateLeftMouseUpFunction = undefined;\r\n\r\n                    self.rotate.call(self, -15);\r\n\r\n                    self.rotateLeftInterval = setInterval(function () {\r\n                        self.rotate.call(self, -15);\r\n                    }.bind(self), 101);\r\n\r\n                    self.rotateLeftMouseUpFunction = function () {\r\n                        clearInterval(self.rotateLeftInterval);\r\n                        self.rotateLeftInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n                        self.rotateLeftMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.rotateLeftMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n\r\n                }.bind(self));\r\n\r\n                self.rotateRight = self.div.querySelector(rotateSelector + self.selectors.rightArrow);\r\n                self.rotateRight.addEventListener(TC.Util.detectMouse() ? 'mousedown' : 'touchstart', function (e) {\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    self.inControls(e);\r\n\r\n                    var upEvent = TC.Util.detectMouse() ? 'mouseup' : 'touchend';\r\n\r\n                    document.removeEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n                    self.rotateRightMouseUpFunction = undefined;\r\n\r\n                    self.rotate.call(self, +15);\r\n\r\n                    self.rotateRightInterval = setInterval(function () {\r\n                        self.rotate.call(self, +15);\r\n                    }.bind(self), 101);\r\n\r\n                    self.rotateRightMouseUpFunction = function () {\r\n                        clearInterval(self.rotateRightInterval);\r\n                        self.rotateRightInterval = undefined;\r\n\r\n                        document.removeEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n                        self.rotateRightMouseUpFunction = undefined;\r\n                    };\r\n\r\n                    document.addEventListener(upEvent, self.rotateRightMouseUpFunction, false);\r\n\r\n                    e.cancelBubble = true;\r\n                    e.returnValue = false;\r\n                    return false;\r\n\r\n                }.bind(self));\r\n\r\n                self.bind();\r\n\r\n            }.bind(this));\r\n        }\r\n    };\r\n    CameraControls.prototype.disableTilt = function (angle) {\r\n        var self = this;\r\n\r\n        var theta = Cesium.Math.toRadians(angle);\r\n        var tilt = self.getCamera().pitch;\r\n\r\n        self.isTiltDownDisabled = (tilt + -theta) < self.MIN_TILT;\r\n        self.isTiltUpDisabled = (tilt + theta) > self.MAX_TILT;\r\n\r\n        // left\r\n        self.tiltUp.disabled = self.isTiltUpDisabled;\r\n        if (self.isTiltUpDisabled) {\r\n            if (!self.tiltUp.classList.contains(self.parent.classes.CAMERACTRARROWDISABLED)) {\r\n                self.tiltUp.classList.add(self.parent.classes.CAMERACTRARROWDISABLED);\r\n            }\r\n        }\r\n        else {\r\n            self.tiltUp.classList.remove(self.parent.classes.CAMERACTRARROWDISABLED);\r\n        }\r\n\r\n\r\n        // right\r\n        self.tiltDown.disabled = self.isTiltDownDisabled;\r\n        if (self.isTiltDownDisabled) {\r\n            if (!self.tiltDown.classList.contains(self.parent.classes.CAMERACTRARROWDISABLED)) {\r\n                self.tiltDown.classList.add(self.parent.classes.CAMERACTRARROWDISABLED);\r\n            }\r\n        }\r\n        else {\r\n            self.tiltDown.classList.remove(self.parent.classes.CAMERACTRARROWDISABLED);\r\n        }\r\n\r\n    };\r\n    CameraControls.prototype.disableRotate = function () {\r\n        var self = this;\r\n\r\n        var isDisable = true;\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var canvas = scene.canvas;\r\n        var bottomLeft = new Cesium.Cartesian2(0, canvas.clientHeight - 1);\r\n        var bottomRight = new Cesium.Cartesian2(canvas.clientWidth - 1, canvas.clientHeight - 1);\r\n        var fovCoords = [bottomLeft, bottomRight, new Cesium.Cartesian2(canvas.clientWidth - 1, 0), new Cesium.Cartesian2(0, 0)]\r\n            .map(function (elm) {\r\n                return pickMapCoords.call(this, elm);\r\n            }.bind(self.parent))\r\n            .filter(function (elm) {\r\n                return elm !== null;\r\n            });\r\n\r\n        if (fovCoords.length && fovCoords.length >= 2) {\r\n            isDisable = false;\r\n        }\r\n\r\n        // reset\r\n        self.rotateIndicatorInner.disabled = isDisable;\r\n\r\n        // left\r\n        self.rotateLeft.disabled = isDisable;\r\n        if (isDisable) {\r\n            self.rotateLeft.classList.add(self.parent.classes.CAMERACTRARROWDISABLED);\r\n        }\r\n        else {\r\n            self.rotateLeft.classList.remove(self.parent.classes.CAMERACTRARROWDISABLED);\r\n        }\r\n\r\n        // right\r\n        self.rotateRight.disabled = isDisable;\r\n        if (isDisable) {\r\n            self.rotateRight.classList.add(self.parent.classes.CAMERACTRARROWDISABLED);\r\n        }\r\n        else {\r\n            self.rotateRight.classList.remove(self.parent.classes.CAMERACTRARROWDISABLED);\r\n        }\r\n\r\n        return isDisable;\r\n    };\r\n    CameraControls.prototype.tilt = function (angle) {\r\n        var self = this;\r\n\r\n        self.disableTilt(angle);\r\n\r\n        if (this.parent.viewer && this.parent.viewer.trackedEntity) {\r\n            self.getCamera().rotateUp(Cesium.Math.toRadians(angle));\r\n        } else {\r\n            if (pickCenterPoint(self.parent.viewer.scene) == undefined) {\r\n                if (angle > 0) self.getCamera().lookUp();\r\n                else self.getCamera().lookDown();\r\n            }\r\n\r\n            if ((angle >= Cesium.Math.PI_OVER_TWO && self.isTiltUpDisabled) ||\r\n                (angle <= -Cesium.Math.PI_OVER_TWO && self.isTiltDownDisabled)) {\r\n                return;\r\n            }\r\n\r\n            var _angle = Cesium.Math.toRadians(angle);\r\n            var pivot = pickCenterPoint(self.parent.viewer.scene);\r\n            if (pivot) {\r\n                var transform = Cesium.Matrix4.fromTranslation(pivot);\r\n                self.parent.view3D.rotateAroundAxis(self.getCamera(), -_angle, self.getCamera().right, transform, { duration: 100 });\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.rotate = function (angle) {\r\n        var self = this;\r\n\r\n        angle = Cesium.Math.toRadians(angle);\r\n\r\n        if (this.parent.viewer && this.parent.viewer.trackedEntity) {\r\n            self.getCamera().rotateRight(-angle);\r\n        } else {\r\n            var bottom = pickBottomPoint(self.parent.viewer.scene);\r\n            if (bottom) {\r\n                setHeadingUsingBottomCenter(self.parent.viewer.scene, angle, bottom, {\r\n                    duration: 100\r\n                });\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.draggingTilt = function (tiltElement, cursorVector) {\r\n        var self = this;\r\n\r\n        self.tiltIndicatorOuterCircle.classList.add(self.parent.classes.HIGHLIGHTED);\r\n\r\n        var oldTransformScratch = new Cesium.Matrix4();\r\n        var newTransformScratch = new Cesium.Matrix4();\r\n        var vectorScratch = new Cesium.Cartesian2();\r\n\r\n        document.removeEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n        document.removeEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n\r\n        self.tiltMouseMoveFunction = undefined;\r\n        self.tiltMouseUpFunction = undefined;\r\n\r\n        self.isTilting = true;\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = scene.camera;\r\n\r\n        var pivot = pickCenterPoint(scene);\r\n        if (!pivot) {\r\n            self.tiltFrame = Cesium.Transforms.northUpEastToFixedFrame(camera.positionWC, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.tiltIsLook = true;\r\n        } else {\r\n            self.tiltFrame = Cesium.Transforms.northUpEastToFixedFrame(pivot, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.tiltIsLook = false;\r\n        }\r\n\r\n        self.startCursorAngle = Math.atan2(-cursorVector.y, cursorVector.x);\r\n\r\n        var oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n        camera.lookAtTransform(self.tiltFrame);\r\n\r\n        self.initialCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n\r\n        camera.lookAtTransform(oldTransform);\r\n\r\n        self.tiltMouseMoveFunction = function (e) {\r\n            var self = this;\r\n\r\n            scene = self.parent.viewer.scene;\r\n            camera = scene.camera;\r\n\r\n            var tiltRectangle = tiltElement.getBoundingClientRect();\r\n            center = new Cesium.Cartesian2((tiltRectangle.right - tiltRectangle.left) / 2.0, (tiltRectangle.bottom - tiltRectangle.top) / 2.0);\r\n            var clickLocation = new Cesium.Cartesian2(e.clientX - tiltRectangle.left, e.clientY - tiltRectangle.top);\r\n            var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n\r\n            console.log('Entra: ' + vector.toString());\r\n\r\n            var angle = Math.atan2(-vector.y, vector.x);\r\n            var angleDifference = angle - self.startCursorAngle;\r\n            var newCameraAngle = Cesium.Math.zeroToTwoPi(self.initialCameraAngle - angleDifference);\r\n\r\n            try {\r\n                oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n                camera.lookAtTransform(self.tiltFrame);\r\n                var currentCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n                var theta = newCameraAngle - currentCameraAngle;\r\n\r\n                var tilt = camera.pitch;\r\n                tilt += theta;\r\n\r\n                if (tilt < self.MIN_TILT) {\r\n                    camera.rotate(camera.right, camera.pitch - self.MIN_TILT);\r\n                } else if (tilt > self.MAX_TILT) {\r\n                    camera.rotate(camera.right, camera.pitch - self.MAX_TILT);\r\n                } else {\r\n                    camera.rotate(camera.right, -theta);\r\n                }\r\n\r\n                self.disableTilt(5);\r\n                camera.lookAtTransform(oldTransform);\r\n\r\n            } catch (e) {\r\n                self.tiltMouseUpFunction();\r\n            }\r\n\r\n\r\n        }.bind(self);\r\n\r\n        self.tiltMouseUpFunction = function (e) {\r\n            self.tiltIndicatorOuterCircle.classList.remove(self.parent.classes.HIGHLIGHTED);\r\n\r\n            self.isTilting = false;\r\n            document.removeEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n            document.removeEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n\r\n            self.tiltMouseMoveFunction = undefined;\r\n            self.tiltMouseUpFunction = undefined;\r\n        };\r\n\r\n        document.addEventListener('mousemove', self.tiltMouseMoveFunction, false);\r\n        document.addEventListener('mouseup', self.tiltMouseUpFunction, false);\r\n    };\r\n    CameraControls.prototype.draggingRotate = function (rotateElement, cursorVector) {\r\n        var self = this;\r\n\r\n        document.removeEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n        document.removeEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n\r\n        self.rotateMouseMoveFunction = undefined;\r\n        self.rotateMouseUpFunction = undefined;\r\n\r\n        self.rotateMouseMoveFunction = function (e) {\r\n            var rotateRectangle = rotateElement.getBoundingClientRect();\r\n            var center = new Cesium.Cartesian2((rotateRectangle.right - rotateRectangle.left) / 2.0, (rotateRectangle.bottom - rotateRectangle.top) / 2.0);\r\n            var clickLocation = new Cesium.Cartesian2(e.clientX - rotateRectangle.left, e.clientY - rotateRectangle.top);\r\n            var vector = Cesium.Cartesian2.subtract(clickLocation, center, vectorScratch);\r\n            var angle = Math.atan2(-vector.y, vector.x);\r\n\r\n            var angleDifference = angle - self.rotateInitialCursorAngle;\r\n            var newCameraAngle = Cesium.Math.zeroToTwoPi(self.rotateInitialCameraAngle - angleDifference);\r\n\r\n            camera = self.parent.viewer.scene.camera;\r\n\r\n            try {\r\n                oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n                camera.lookAtTransform(self.rotateFrame);\r\n                var currentCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n                camera.rotateRight(newCameraAngle - currentCameraAngle);\r\n                camera.lookAtTransform(oldTransform);\r\n            } catch (e) {\r\n                self.rotateMouseUpFunction();\r\n            }\r\n        };\r\n\r\n        self.rotateMouseUpFunction = function (e) {\r\n            self.isRotating = false;\r\n\r\n            self.rotateIndicatorOuterCircle.classList.remove(self.parent.classes.HIGHLIGHTED);\r\n\r\n            document.removeEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n            document.removeEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n\r\n            self.rotateMouseMoveFunction = undefined;\r\n            self.rotateMouseUpFunction = undefined;\r\n        };\r\n\r\n        if (self.disableRotate()) {\r\n            self.rotateMouseUpFunction();\r\n            return;\r\n        }\r\n\r\n        self.rotateIndicatorOuterCircle.classList.add(self.parent.classes.HIGHLIGHTED);\r\n\r\n        var oldTransformScratch = new Cesium.Matrix4();\r\n        var newTransformScratch = new Cesium.Matrix4();\r\n        var vectorScratch = new Cesium.Cartesian2();\r\n\r\n        self.isRotating = true;\r\n        self.rotateInitialCursorAngle = Math.atan2(-cursorVector.y, cursorVector.x);\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = scene.camera;\r\n\r\n        var viewCenter = pickCenterPoint(self.parent.viewer.scene);\r\n        if (viewCenter == null || viewCenter == undefined) {\r\n            viewCenter = pickBottomPoint(self.parent.viewer.scene);\r\n            if (viewCenter == null || viewCenter == undefined) {\r\n                self.rotateFrame = Cesium.Transforms.eastNorthUpToFixedFrame(camera.positionWC, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n                self.rotateIsLook = true;\r\n            } else {\r\n                self.rotateFrame = Cesium.Transforms.eastNorthUpToFixedFrame(viewCenter, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n                self.rotateIsLook = false;\r\n            }\r\n        } else {\r\n            self.rotateFrame = Cesium.Transforms.eastNorthUpToFixedFrame(viewCenter, Cesium.Ellipsoid.WGS84, newTransformScratch);\r\n            self.rotateIsLook = false;\r\n        }\r\n\r\n        try {\r\n            var oldTransform = Cesium.Matrix4.clone(camera.transform, oldTransformScratch);\r\n            camera.lookAtTransform(self.rotateFrame);\r\n            self.rotateInitialCameraAngle = Math.atan2(camera.position.y, camera.position.x);\r\n            self.rotateInitialCameraDistance = Cesium.Cartesian3.magnitude(new Cesium.Cartesian3(camera.position.x, camera.position.y, 0.0));\r\n            camera.lookAtTransform(oldTransform);\r\n        } catch (e) {\r\n            self.rotateMouseUpFunction();\r\n        }\r\n\r\n        document.addEventListener('mousemove', self.rotateMouseMoveFunction, false);\r\n        document.addEventListener('mouseup', self.rotateMouseUpFunction, false);\r\n    };\r\n    CameraControls.prototype.resetTilt = function () {\r\n        var self = this;\r\n        // lo dejamos como al principio a 50 grados\r\n        var angle = -self.getCamera().pitch - Cesium.Math.toRadians(50);\r\n        self.tilt(Cesium.Math.toDegrees(angle));\r\n    };\r\n    CameraControls.prototype.resetRotation = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var currentRotation;\r\n            currentRotation = -self.getCamera().heading;\r\n\r\n            while (currentRotation < -Math.PI) {\r\n                currentRotation += 2 * Math.PI;\r\n            }\r\n            while (currentRotation > Math.PI) {\r\n                currentRotation -= 2 * Math.PI;\r\n            }\r\n\r\n            if (!options)\r\n                resolve();\r\n            else {\r\n                options.callback = function () {\r\n                    resolve();\r\n                };\r\n            }\r\n\r\n            if (this.parent.viewer && this.parent.viewer.trackedEntity) {\r\n                var camera = self.getCamera();\r\n                camera.rotate(Cesium.Cartesian3.fromDegrees(0, 90), currentRotation);\r\n            } else {\r\n                var bottom = pickBottomPoint(self.parent.viewer.scene);\r\n                if (bottom) {\r\n                    setHeadingUsingBottomCenter(self.parent.viewer.scene, currentRotation, bottom, options);\r\n                }\r\n            }\r\n        });\r\n    };\r\n    CameraControls.prototype.customCollisionDetection = function () {\r\n        var self = this;\r\n\r\n        var scratchAdjustHeightTransform = new Cesium.Matrix4();\r\n        var scratchAdjustHeightCartographic = new Cesium.Cartographic();\r\n\r\n        var scene = self.parent.viewer.scene;\r\n        var camera = self.parent.viewer.scene.camera;\r\n\r\n        var screenSpaceCameraController = scene.screenSpaceCameraController;\r\n        var enableCollisionDetection = screenSpaceCameraController.enableCollisionDetection;\r\n        var minimumCollisionTerrainHeight = screenSpaceCameraController.minimumCollisionTerrainHeight;\r\n        var minimumZoomDistance = screenSpaceCameraController.minimumZoomDistance;\r\n        var globe = scene.globe;\r\n\r\n        var ellipsoid = globe.ellipsoid;\r\n        var projection = scene.mapProjection;\r\n\r\n        var transform;\r\n        var mag;\r\n        if (!Cesium.Matrix4.equals(camera.transform, Cesium.Matrix4.IDENTITY)) {\r\n            transform = Cesium.Matrix4.clone(camera.transform, scratchAdjustHeightTransform);\r\n            mag = Cesium.Cartesian3.magnitude(camera.position);\r\n            camera._setTransform(Cesium.Matrix4.IDENTITY);\r\n        }\r\n\r\n        var cartographic = scratchAdjustHeightCartographic;\r\n        ellipsoid.cartesianToCartographic(camera.position, cartographic);\r\n\r\n        var heightUpdated = false;\r\n        if (cartographic.height < minimumCollisionTerrainHeight) {\r\n            var height = globe.getHeight(cartographic);\r\n            if (height !== undefined && height !== null) {\r\n                height += minimumZoomDistance;\r\n                if (cartographic.height < height) {\r\n                    cartographic.height = height;\r\n                    ellipsoid.cartographicToCartesian(cartographic, camera.position);\r\n                    heightUpdated = true;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (transform !== undefined && transform !== null) {\r\n            camera._setTransform(transform);\r\n            if (heightUpdated) {\r\n                Cesium.Cartesian3.normalize(camera.position, camera.position);\r\n                Cesium.Cartesian3.negate(camera.position, camera.direction);\r\n                Cesium.Cartesian3.multiplyByScalar(camera.position, Math.max(mag, minimumZoomDistance), camera.position);\r\n                Cesium.Cartesian3.normalize(camera.direction, camera.direction);\r\n                Cesium.Cartesian3.cross(camera.direction, camera.up, camera.right);\r\n                Cesium.Cartesian3.cross(camera.right, camera.direction, camera.up);\r\n            }\r\n        }\r\n    };\r\n    CameraControls.prototype.limitCameraToInitExtent = function () {\r\n        var self = this;\r\n\r\n        var pos = self.viewer.camera.positionCartographic.clone();\r\n\r\n        if (!(pos.longitude >= self.initExtent.west &&\r\n            pos.longitude <= self.initExtent.east &&\r\n            pos.latitude >= self.initExtent.south &&\r\n            pos.latitude <= self.initExtent.north)) {\r\n            // add a padding based on the camera height\r\n            var maxHeight = self.viewer.scene.screenSpaceCameraController.maximumZoomDistance;\r\n            var padding = pos.height * 0.05 / maxHeight;\r\n            pos.longitude = Math.max(self.initExtent.west - padding, pos.longitude);\r\n            pos.latitude = Math.max(self.initExtent.south - padding, pos.latitude);\r\n            pos.longitude = Math.min(self.initExtent.east + padding, pos.longitude);\r\n            pos.latitude = Math.min(self.initExtent.north + padding, pos.latitude);\r\n            self.viewer.camera.setView({\r\n                destination: Cesium.Ellipsoid.WGS84.cartographicToCartesian(pos),\r\n                orientation: {\r\n                    heading: self.viewer.camera.heading,\r\n                    pitch: self.viewer.camera.pitch\r\n                }\r\n            });\r\n        }\r\n\r\n        // Set the minimumZoomDistance according to the camera height\r\n        self.viewer.scene.screenSpaceCameraController.minimumZoomDistance = pos.height > 1800 ? 400 : 200;\r\n    };\r\n\r\n    var TwoDLinkedFeatureInfo = function (map) {\r\n        var pending = false;\r\n        var marker = null;\r\n        var ctlResultsPanel = null;\r\n        var ctlFeatureInfo = null;\r\n\r\n        var savedMode;\r\n        var map2DgetResolutionFN = map.map.getResolution;\r\n\r\n        var getResultsPanelCtl = function (ctlFeatureInfo) {\r\n            return new Promise(function (resolve, reject) {\r\n\r\n                if (!ctlResultsPanel) {\r\n                    if (!TC.control.ResultsPanel) {\r\n                        TC.syncLoadJS(TC.apiLocation + 'TC/control/ResultsPanel');\r\n                    }\r\n\r\n                    const resultsPanelOptions = {\r\n                        \"content\": \"table\",\r\n                        \"titles\": {\r\n                            \"main\": TC.Util.getLocaleString(map.map.options.locale, \"threed.rs.panel.gfi\"),\r\n                            \"max\": TC.Util.getLocaleString(map.map.options.locale, \"threed.rs.panel.gfi\")\r\n                        }\r\n                    };\r\n\r\n                    var addControlPromise;\r\n                    var controlContainer = map.map.getControlsByClass('TC.control.ControlContainer')[0];\r\n                    if (controlContainer) {\r\n                        resultsPanelOptions.side = controlContainer.SIDE.RIGHT;\r\n                        addControlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                    } else {\r\n                        resultsPanelOptions.div = document.createElement('div');\r\n                        map.map.div.appendChild(resultsPanelOptions.div);\r\n                        addControlPromise = map.map.addControl('resultsPanel', resultsPanelOptions);\r\n                    }\r\n\r\n                    addControlPromise.then(function (control) {\r\n                        control.caller = ctlFeatureInfo;\r\n                        ctlResultsPanel = control;\r\n                        ctlFeatureInfo.resultsPanel = ctlResultsPanel;\r\n\r\n                        resolve();\r\n                    });\r\n                } else {\r\n                    resolve();\r\n                }\r\n            });\r\n        };\r\n        var setMarker = function (pickedPosition) {\r\n            if (!marker) {\r\n                var markerStyle = TC.control.FeatureInfoCommons.prototype.markerStyle;\r\n\r\n                var billboard = {\r\n                    position: pickedPosition,\r\n                    billboard: { /* revisar: no está bien la URL de la imagen - también revisar el GFI que salta en móvil sólo con navegar */\r\n                        image: TC.Util.getBackgroundUrlFromCss(map.CLASS + '-marker'),\r\n                        eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                    }\r\n                };\r\n\r\n                marker = map.view3D.addNativeFeature.call(map, billboard);\r\n\r\n            } else {\r\n                marker.position = pickedPosition;\r\n            }\r\n\r\n            map.viewer.scene.requestRender();\r\n        };\r\n        var removeMarker = function () {\r\n            map.view3D.removeFeature.call(map, marker);\r\n            marker = null;\r\n        };\r\n\r\n        ctlFeatureInfo = map.map.getControlsByClass(TC.control.FeatureInfo)[0];\r\n        if (ctlFeatureInfo) {\r\n\r\n            savedMode = ctlFeatureInfo.displayMode;\r\n\r\n            getResultsPanelCtl(ctlFeatureInfo).then(function () {\r\n                ctlFeatureInfo.setDisplayMode(TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL);\r\n\r\n                map.map.on(TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                    if (e.control === ctlFeatureInfo.getDisplayControl()) {\r\n                        if (!ctlFeatureInfo.querying) {\r\n                            removeMarker();\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        }\r\n        this.clear = function () {\r\n            ctlFeatureInfo.closeResults();\r\n            removeMarker();\r\n        };\r\n        this.reset = function () {\r\n            this.clear();\r\n            ctlFeatureInfo.setDisplayMode(savedMode);\r\n            map.map.getResolution = map2DgetResolutionFN;\r\n        };\r\n        this.send = function (pickedPosition) {\r\n            return new Promise(function (resolve, reject) {\r\n                pending = true;\r\n\r\n                if (ctlFeatureInfo.displayMode !== TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL) {\r\n                    ctlFeatureInfo.setDisplayMode(TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL);\r\n                }\r\n\r\n                if (ctlFeatureInfo.resultsPanel) {\r\n                    ctlFeatureInfo.resultsPanel.close();\r\n                }\r\n\r\n                if (!map.waiting)\r\n                    map.waiting = map.map.getLoadingIndicator().addWait();\r\n\r\n                setMarker(pickedPosition);\r\n\r\n                getResultsPanelCtl(ctlFeatureInfo).then(function () {\r\n                    var pickedLocation = Cesium.Ellipsoid.WGS84.cartesianToCartographic(pickedPosition);\r\n\r\n                    var reprojected;\r\n                    if (map.view3D.crs !== map.view3D.view2DCRS) {\r\n                        reprojected = TC.Util.reproject([Cesium.Math.toDegrees(pickedLocation.longitude), Cesium.Math.toDegrees(pickedLocation.latitude)], map.view3D.crs, map.view3D.view2DCRS);\r\n                    } else {\r\n                        reprojected = [Cesium.Math.toDegrees(pickedLocation.longitude), Cesium.Math.toDegrees(pickedLocation.latitude)];\r\n                    }\r\n\r\n\r\n                    var radius = (map.map.options.pixelTolerance || TC.Cfg.pixelTolerance);\r\n                    var mapWidth = 2 * radius + 1;\r\n\r\n                    var tilesRendered = map.viewer.scene.globe._surface._tilesToRender;\r\n                    var pickedTile;\r\n\r\n                    for (var textureIndex = 0; !pickedTile && textureIndex < tilesRendered.length; ++textureIndex) {\r\n                        var tile = tilesRendered[textureIndex];\r\n                        if (Cesium.Rectangle.contains(tile.rectangle, pickedLocation)) {\r\n                            pickedTile = tile;\r\n                        }\r\n                    }\r\n\r\n                    if (!pickedTile) {\r\n                        resolve();\r\n                        return;\r\n                    }\r\n\r\n                    var imageryTiles = pickedTile.data.imagery;\r\n                    for (var i = imageryTiles.length - 1; i >= 0; --i) {\r\n                        var terrainImagery = imageryTiles[i];\r\n                        var imagery = terrainImagery.readyImagery;\r\n                        if (!imagery) {\r\n                            resolve();\r\n                            return;\r\n                        }\r\n                    }\r\n\r\n                    var nativeRectangle = pickedTile.tilingScheme.tileXYToNativeRectangle(pickedTile.x, pickedTile.y, pickedTile.level);\r\n\r\n                    var readyImageryToGetNativeRectangle = (imageryTiles.filter(function (imagery) {\r\n                        return imagery.readyImagery.imageryLayer.isBaseLayer();\r\n                    })[0] || {}).readyImagery;\r\n\r\n                    map.map.getResolution = function () {\r\n\r\n                        var west_south = map.view3D.crs !== map.view3D.view2DCRS ? TC.Util.reproject([nativeRectangle.west, nativeRectangle.south], map.view3D.crs, map.view3D.view2DCRS) : [nativeRectangle.west, nativeRectangle.south];\r\n                        var east_north = map.view3D.crs !== map.view3D.view2DCRS ? TC.Util.reproject([nativeRectangle.east, nativeRectangle.north], map.view3D.crs, map.view3D.view2DCRS) : [nativeRectangle.east, nativeRectangle.north];\r\n\r\n                        var xResolution = (east_north[0] - west_south[0]) / (readyImageryToGetNativeRectangle && readyImageryToGetNativeRectangle.imageryLayer.imageryProvider.tileWidth || 256);\r\n                        var yResolution = (east_north[1] - west_south[1]) / (readyImageryToGetNativeRectangle && readyImageryToGetNativeRectangle.imageryLayer.imageryProvider.tileHeight || 256);\r\n\r\n                        return Math.max(xResolution, yResolution);\r\n\r\n                    }.bind(map, readyImageryToGetNativeRectangle, nativeRectangle);\r\n\r\n                    var that = map;\r\n                    map.map.one(TC.Consts.event.NOFEATUREINFO, function (e) {\r\n                        pending = false;\r\n\r\n                        resolve(e);\r\n\r\n                        var onClear = function (e) {\r\n                            if (e.layer == this.filterLayer) {\r\n                                removeMarker();\r\n                                map.map.off(TC.Consts.event.FEATURESCLEAR, onClear);\r\n                            }\r\n                        }.bind(ctlFeatureInfo);\r\n\r\n                        map.map.on(TC.Consts.event.FEATURESCLEAR, onClear);\r\n                    }.bind(ctlFeatureInfo));\r\n\r\n                    map.map.one(TC.Consts.event.FEATUREINFO, function (e) {\r\n                        pending = false;\r\n\r\n                        resolve(e);\r\n                    });\r\n\r\n                    map.map.on(TC.Consts.event.FEATURECLICK, function (e) {\r\n\r\n\r\n\r\n                        removeMarker();\r\n\r\n                        resolve(e);\r\n                    });\r\n\r\n                    savedIsActive = ctlFeatureInfo.isActive;\r\n                    ctlFeatureInfo.isActive = true;\r\n                    ctlFeatureInfo.beforeRequest({\r\n                        xy: [0, 0]\r\n                    }); // Es irrelevante dónde va a poner el marcador, no se va a ver                \r\n\r\n                    ctlFeatureInfo.callback(reprojected);\r\n                });\r\n            });\r\n        };\r\n        this.get2DMarker = function () {\r\n            return ctlFeatureInfo.filterFeature;\r\n        };\r\n        this.isPending = function () {\r\n            return pending;\r\n        };\r\n    };\r\n\r\n    var RasterConverter = function (crsPattern) {\r\n        this.layerCrs = null;\r\n\r\n        var crsPattern = crsPattern;\r\n\r\n        var paths = {\r\n            CRS: [\"Capability\", \"Layer\", \"CRS\"],\r\n            TILEMATRIXSET: [\"Contents\", \"TileMatrixSet\", \"Identifier\"],\r\n            TILEMATRIXSETLABELS: [\"Contents\", \"TileMatrixSet\"]\r\n        };\r\n        var getOfPath = function (obj, p, i) {\r\n            if (i < p.length - 1) {\r\n                if (obj.hasOwnProperty(p[i]))\r\n                    return getOfPath(obj[p[i]], p, ++i);\r\n                else return null;\r\n            } else {\r\n                if (obj instanceof Array) {\r\n                    var _obj = [];\r\n                    for (var a = 0; a < obj.length; a++) {\r\n                        if (obj[a].hasOwnProperty(p[i]))\r\n                            _obj.push(obj[a][p[i]]);\r\n                    }\r\n\r\n                    return _obj;\r\n                } else return obj[p[i]];\r\n            }\r\n        };\r\n        var getTileMatrixSetLabelByLayerOnCapabilities = function (layer, crs) {\r\n            if ((capsURL = TC.Util.isOnCapabilities(layer.url))) {\r\n                if ((caps = TC.capabilities[capsURL])) {\r\n                    var tileMatrixSet = getOfPath(caps, paths.TILEMATRIXSETLABELS, 0);\r\n                    for (var a = 0; a < tileMatrixSet.length; a++) {\r\n                        if (tileMatrixSet[a][\"Identifier\"] === crs) {\r\n                            return getOfPath(tileMatrixSet[a], [\"TileMatrix\", \"Identifier\"], 0);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            return null;\r\n        };\r\n\r\n        var wmtsLayer = function (layer) {\r\n            const self = this;\r\n            return new Promise(function (resolve, reject) {\r\n                var tileMatrixSetLabels = getTileMatrixSetLabelByLayerOnCapabilities(layer, self.layerCrs);\r\n\r\n                var options = {\r\n                    url: new CustomResource({\r\n                        url: layer.options.urlPattern\r\n                    }, layer),\r\n                    layer: layer.layerNames,\r\n                    style: 'default',\r\n                    format: layer.format || layer.options.format,\r\n                    tileMatrixSetID: self.layerCrs,\r\n                    tileMatrixLabels: tileMatrixSetLabels,\r\n                    tilingScheme: new Cesium.GeographicTilingScheme()\r\n                };\r\n\r\n                resolve(new Cesium.WebMapTileServiceImageryProvider(options));\r\n            });\r\n        }\r\n\r\n        var wmsLayer = function (layer) {\r\n            return new Promise(function (resolve, reject) {\r\n                var options = {\r\n                    url: new CustomResource({\r\n                        url: layer.url\r\n                    }, layer),\r\n                    layers: layer.layerNames,\r\n                    parameters: {\r\n                        version: \"1.3.0\",\r\n                        transparent: true,\r\n                        format: layer.format || layer.options.format\r\n                    }\r\n                };\r\n\r\n                var bindEXBBox = function () {\r\n                    var bbox = [];\r\n                    if (layer.capabilities && layer.capabilities.Capability && layer.capabilities.Capability.Layer) {\r\n                        if (layer.names.length > 0) {\r\n                            var names = layer.names.slice(0);\r\n                            var _getEXBBox = function _getEXBBox(nodes, name) {\r\n                                if (nodes) {\r\n                                    for (var i = 0; i < nodes.length; i++) {\r\n                                        var n = nodes[i];\r\n                                        if (layer.compareNames(layer.wrap.getName(n), name)) {\r\n                                            return n.EX_GeographicBoundingBox;\r\n                                        }\r\n                                    }\r\n\r\n                                    return _getEXBBox(n.Layer, name);\r\n                                }\r\n                            };\r\n                            while (names.length > 0) {\r\n                                var exBBox = _getEXBBox([layer.capabilities.Capability.Layer], names.pop());\r\n                                if (exBBox !== null) {\r\n                                    bbox.push(exBBox);\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    return bbox;\r\n                };\r\n                var exBoundingBox = bindEXBBox();\r\n\r\n                if (exBoundingBox) {\r\n                    layer.geoBBox = exBoundingBox;\r\n                }\r\n\r\n                resolve(new Cesium.WebMapServiceImageryProvider(options));\r\n            });\r\n        };\r\n\r\n        var CustomResource;\r\n        var defineCustomResource = function () {\r\n            /* tengo que sobrescribir porque no valida nada... \r\n            Desde la version 1.42 han cambiado la definición de un proxy en las capas raster: si configuras con proxy, pide directamente desde el proxy y si da error no gestiona nada, \r\n            y si no configuras proxy, pide directamente sin tampoco gestionar los errores. Además la creación de una capa raster es síncrona, por lo que no encaja con el algoritmo de proxificación */\r\n            CustomResource = function (options, layer) {\r\n                Cesium.Resource.call(this, options);\r\n\r\n                this.layer = layer;\r\n            };\r\n            CustomResource.prototype.constructor = CustomResource;\r\n            CustomResource.prototype = Object.create(Cesium.Resource.prototype, {});\r\n            CustomResource.prototype.clone = function (result) {\r\n\r\n                var cloned = Cesium.Resource.prototype.clone.call(this, result);\r\n\r\n                if (!Cesium.defined(result)) {\r\n                    result = new CustomResource({\r\n                        url: this._url\r\n                    }, this.layer);\r\n                }\r\n\r\n                result._url = cloned._url;\r\n                result._queryParameters = cloned._queryParameters;\r\n                result._templateValues = cloned._templateValues;\r\n                result.headers = cloned.headers;\r\n                result.proxy = cloned.proxy;\r\n                result.retryCallback = cloned.retryCallback;\r\n                result.retryAttempts = cloned.retryAttempts;\r\n                result._retryCount = 0;\r\n\r\n                result.request = cloned.request;\r\n\r\n\r\n\r\n                return result;\r\n            };\r\n            CustomResource.prototype.fetchImage = customFetchImage;\r\n        };\r\n\r\n        /* inicio cesium Resource override */\r\n        var xhrBlobSupported = (function () {\r\n            try {\r\n                var xhr = new XMLHttpRequest();\r\n                xhr.open('GET', '#', true);\r\n                xhr.responseType = 'blob';\r\n                return xhr.responseType === 'blob';\r\n            } catch (e) {\r\n                return false;\r\n            }\r\n        })();\r\n\r\n        function checkAndResetRequest(request) {\r\n            if (request.state === Cesium.RequestState.ISSUED || request.state === Cesium.RequestState.ACTIVE) {\r\n                throw new Cesium.RuntimeError('The Resource is already being fetched.');\r\n            }\r\n\r\n            request.state = Cesium.RequestState.UNISSUED;\r\n            request.deferred = undefined;\r\n        }\r\n\r\n        function createImage(layer, url, crossOrigin, deferred) {\r\n            var getImage = function (url) {\r\n                var image = new Image();\r\n\r\n                image.onload = function (layer) {\r\n                    deferred.resolve(image);\r\n                }.bind(image, layer);\r\n\r\n                image.onerror = function (layer, e) {\r\n                    deferred.reject(e);\r\n                }.bind(image, layer);\r\n\r\n                if (crossOrigin) {\r\n                    if (Cesium.TrustedServers.contains(url)) {\r\n                        image.crossOrigin = 'use-credentials';\r\n                    } else {\r\n                        image.crossOrigin = '';\r\n                    }\r\n                }\r\n\r\n                image.src = url;\r\n            };\r\n\r\n            layer.getWebGLUrl.call(layer, url).then(getImage, function (e) {\r\n                deferred.reject(e);\r\n            });\r\n        };\r\n\r\n        function fetchImage(resource, allowCrossOrigin) {\r\n            var request = resource.request;\r\n            request.url = resource.url;\r\n            request.requestFunction = function () {\r\n                var url = resource.url;\r\n                var crossOrigin = false;\r\n\r\n                // data URIs can't have allowCrossOrigin set.\r\n                if (!resource.isDataUri && !resource.isBlobUri) {\r\n                    crossOrigin = resource.isCrossOriginUrl;\r\n                }\r\n\r\n                var deferred = Cesium.when.defer();\r\n\r\n                createImage(resource.layer, url, crossOrigin && allowCrossOrigin, deferred);\r\n\r\n                return deferred.promise;\r\n            };\r\n\r\n            var promise = Cesium.RequestScheduler.request(request);\r\n            if (!Cesium.defined(promise)) {\r\n                return;\r\n            }\r\n\r\n            return promise.otherwise(function (e) {\r\n                return Cesium.when.reject(e);\r\n            });\r\n        }\r\n\r\n        var customFetchImage = function (preferBlob, allowCrossOrigin) {\r\n            if (Cesium.defined(allowCrossOrigin)) {\r\n                Cesium.deprecationWarning('Resource.fetchImage.allowCrossOrigin', 'The allowCrossOrigin parameter has been deprecated and will be removed in Cesium 1.44. It no longer needs to be specified.');\r\n            }\r\n\r\n            preferBlob = Cesium.defaultValue(preferBlob, false);\r\n            allowCrossOrigin = Cesium.defaultValue(allowCrossOrigin, true);\r\n\r\n            checkAndResetRequest(this.request);\r\n\r\n            // We try to load the image normally if\r\n            // 1. Blobs aren't supported\r\n            // 2. It's a data URI\r\n            // 3. It's a blob URI\r\n            // 4. It doesn't have request headers and we preferBlob is false\r\n            if (!xhrBlobSupported || this.isDataUri || this.isBlobUri || (!this.hasHeaders && !preferBlob)) {\r\n                return fetchImage(this, allowCrossOrigin);\r\n            }\r\n\r\n            var blobPromise = this.fetchBlob();\r\n            if (!Cesium.defined(blobPromise)) {\r\n                return;\r\n            }\r\n\r\n            var generatedBlobResource;\r\n            var generatedBlob;\r\n            return blobPromise\r\n                .then(function (blob) {\r\n                    if (!Cesium.defined(blob)) {\r\n                        return;\r\n                    }\r\n                    generatedBlob = blob;\r\n                    var blobUrl = window.URL.createObjectURL(blob);\r\n                    generatedBlobResource = new Cesium.Resource({\r\n                        url: blobUrl\r\n                    });\r\n\r\n                    return fetchImage(generatedBlobResource);\r\n                })\r\n                .then(function (image) {\r\n                    if (!Cesium.defined(image)) {\r\n                        return;\r\n                    }\r\n                    window.URL.revokeObjectURL(generatedBlobResource.url);\r\n\r\n                    // This is because the blob object is needed for DiscardMissingTileImagePolicy\r\n                    // See https://github.com/AnalyticalGraphicsInc/cesium/issues/1353\r\n                    image.blob = generatedBlob;\r\n                    return image;\r\n                })\r\n                .otherwise(function (error) {\r\n                    if (Cesium.defined(generatedBlobResource)) {\r\n                        window.URL.revokeObjectURL(generatedBlobResource.url);\r\n                    }\r\n\r\n                    return Cesium.when.reject(error);\r\n                });\r\n        };\r\n        /* fin cesium Resource override */\r\n\r\n        this.convert = function (layer, map3DCRS) {\r\n            var csmLayer;\r\n\r\n            this.layerCrs = map3DCRS;\r\n\r\n            if (!CustomResource) { defineCustomResource(); }\r\n\r\n            switch (true) {\r\n                case TC.Consts.layerType.WMTS == layer.type:\r\n                    return wmtsLayer.call(this, layer);\r\n                case TC.Consts.layerType.WMS == layer.type:\r\n                    return wmsLayer.call(this, layer);\r\n                    break;\r\n            }\r\n        };\r\n    };\r\n    var FeatureConverter = function () {\r\n        var scene = null;\r\n        var toCesiumColor = function (hexStringColor, alpha) {\r\n            if (hexStringColor instanceof Array) {\r\n                hexStringColor = \"rgba(\" + hexStringColor[0] + \", \" + hexStringColor[1] + \", \" + hexStringColor[2] + \", \" + hexStringColor[3] + \")\";\r\n            }\r\n            var color = Cesium.Color.fromCssColorString(hexStringColor);\r\n            if (alpha !== undefined) {\r\n                return color.withAlpha(alpha);\r\n            }\r\n\r\n            return color;\r\n        }\r\n        var setStyleProperties = function (styles, properties, feature) {\r\n            for (var key in properties) { // recorremos el diccionario de propiedades que admitimos como estilo\r\n                var attr = styles[properties[key].prop];\r\n                if (attr !== undefined) {\r\n                    if (typeof (attr) === \"function\") { // si la propiedad del estilo es una función (como en el control de búsquedas) invocamos para obtener el valor\r\n                        var val = attr(feature);\r\n                        if (val) {\r\n                            properties[key].val = val;\r\n                        }\r\n                    } else {\r\n                        properties[key].val = attr; // obtenenemos el valor\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        var getPixelSize = function (coords) {\r\n            var rectangle;\r\n\r\n            if (coords.length == 1) {\r\n                var point = coords[0];\r\n                var delta = 1000;\r\n                var minx, miny, maxx, maxy;\r\n                minx = new Cesium.Cartesian3(point.x - delta, point.y, point.z);\r\n                miny = new Cesium.Cartesian3(point.x, point.y - delta, point.z);\r\n                maxx = new Cesium.Cartesian3(point.x + delta, point.y, point.z);\r\n                maxy = new Cesium.Cartesian3(point.x, point.y + delta, point.z);\r\n\r\n                rectangle = Cesium.Rectangle.fromCartesianArray([minx, miny, maxx, maxy], Cesium.Ellipsoid.WGS84);\r\n            } else {\r\n                rectangle = Cesium.Rectangle.fromCartesianArray(coords, Cesium.Ellipsoid.WGS84);\r\n            }\r\n\r\n            var neededCameraPosition = scene.camera.getRectangleCameraCoordinates(rectangle);\r\n            var distance = Cesium.Cartesian3.distance(neededCameraPosition, Cesium.BoundingSphere.fromPoints(coords).center);\r\n            var pixelSize = scene.camera.frustum.getPixelDimensions(scene.drawingBufferWidth, scene.drawingBufferHeight, distance, new Cesium.Cartesian2());\r\n            pixelSize = Math.max(pixelSize.x, pixelSize.y);\r\n            return Math.round(pixelSize) == 0 ? 1 : pixelSize;\r\n        };\r\n\r\n        var getFeatureStyle = function (feature) {\r\n            var self = this;\r\n            var styles;\r\n\r\n            if (!feature.layer || (feature.layer && !feature.layer.hasOwnProperty('styles'))) {\r\n                styles = TC.Defaults.styles;\r\n            } else {\r\n                styles = feature.layer.styles;\r\n            }\r\n\r\n            styles = styles[feature.STYLETYPE] == undefined ?\r\n                styles[(feature.STYLETYPE === \"polyline\" ? \"line\" : feature.STYLETYPE)] :\r\n                styles[(feature.STYLETYPE === \"multipolygon\" ? \"polygon\" : feature.STYLETYPE)];\r\n\r\n            styles = $.extend({}, styles, feature.options, feature.getStyle());\r\n\r\n            return styles;\r\n        }\r\n\r\n        function createLine(id, coords, options, callback) {\r\n            var entity = new Cesium.Entity({\r\n                name: id,\r\n                polyline: {\r\n                    positions: coords,\r\n                    width: options.width,\r\n                    material: options.material,\r\n                    clampToGround: true\r\n                }\r\n            });\r\n\r\n            callback(entity);\r\n        };\r\n\r\n        var circleConverter = function (feature) {\r\n            var self = this;\r\n            var circle = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            circle.options = function () {\r\n                var opt = {};\r\n\r\n                var properties = {\r\n                    color: { prop: 'strokeColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'fillColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = Cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                opt.outlineColor = Cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            circle.geometryType = function (coords, options) {\r\n\r\n                return new Cesium.GroundPrimitive({\r\n                    releaseGeometryInstances: false,\r\n                    geometryInstances: new Cesium.GeometryInstance({\r\n                        id: feature.id,\r\n                        geometry: new Cesium.CircleGeometry({\r\n                            center: coords[0],\r\n                            radius: feature.geometry[1]\r\n                        }),\r\n                        attributes: {\r\n                            color: options.color\r\n                        }\r\n                    })\r\n                });\r\n\r\n                // Para obtener el contorno de círculo \r\n                //var radius = feature.geometry[1];\r\n                //var outlineEllipse = Cesium.EllipseGeometryLibrary.computeEllipsePositions({\r\n                //    semiMinorAxis: radius,\r\n                //    semiMajorAxis: radius,\r\n                //    rotation: 0,\r\n                //    center: coords[0],\r\n                //    granularity: Cesium.Math.toRadians(0.5)\r\n                //}, false, true);\r\n\r\n                //var outerPositions = Cesium.Cartesian3.unpackArray(outlineEllipse.outerPositions);\r\n\r\n                //var outlineSize = getPixelSize(outerPositions);\r\n                //var metersPerPixel = scene.camera.getPixelSize(Cesium.BoundingSphere.fromPoints(outerPositions), scene.drawingBufferWidth, scene.drawingBufferHeight);\r\n                //var outlineInMeters = metersPerPixel * outlineSize;\r\n\r\n                //var outlineHoleEllipse = Cesium.EllipseGeometryLibrary.computeEllipsePositions({\r\n                //    semiMinorAxis: radius - outlineInMeters,\r\n                //    semiMajorAxis: radius - outlineInMeters,\r\n                //    rotation: 0,\r\n                //    center: coords[0],\r\n                //    granularity: Cesium.Math.toRadians(0.5)\r\n                //}, false, true);\r\n\r\n                //var innerPositions = Cesium.Cartesian3.unpackArray(outlineHoleEllipse.outerPositions);\r\n\r\n                //var outlineCircleGeom = new Cesium.GroundPrimitive({\r\n                //    geometryInstances: new Cesium.GeometryInstance({\r\n                //        id: feature.id + 'outline',\r\n                //        geometry: new Cesium.PolygonGeometry({\r\n                //            polygonHierarchy: new Cesium.PolygonHierarchy(outerPositions, [new Cesium.PolygonHierarchy(innerPositions)])\r\n                //        }),\r\n                //        attributes: {\r\n                //            color: options.outlineColor\r\n                //        }\r\n                //    })\r\n                //});\r\n            };\r\n\r\n            return circle;\r\n        };\r\n        var polygonConverter = function (feature) {\r\n            var self = this;\r\n            var polygon = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            polygon.options = function () {\r\n                var opt = {};\r\n                var properties = {\r\n                    color: { prop: 'fillColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'strokeColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = Cesium.ColorGeometryInstanceAttribute.fromColor(color);\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                opt.outlineColor = color;\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.MultiPolygon && feature.CLASSNAME == \"TC.feature.MultiPolygon\") {\r\n                polygon.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var getting = [];\r\n\r\n                        var geomPolys = [];\r\n                        var geomOutlines = [];\r\n\r\n                        var getPolyGeom = function (polygonHierarchy) {\r\n                            return new Cesium.GeometryInstance({\r\n                                id: feature.id,\r\n                                geometry: new Cesium.PolygonGeometry({\r\n                                    polygonHierarchy: polygonHierarchy\r\n                                }),\r\n                                attributes: {\r\n                                    color: options.color\r\n                                }\r\n                            });\r\n                        };\r\n\r\n                        var getOutlineGeom = function (outlineCoords) {\r\n                            return new Promise(function (res, rej) {\r\n                                createLine(feature.id, outlineCoords, { material: options.outlineColor, width: options.width }, function (entity) {\r\n                                    geomOutlines.push(entity);\r\n                                    res();\r\n                                });\r\n                            });\r\n                        };\r\n\r\n                        for (var i = 0; i < coords.length; i++) {\r\n                            for (var j = 0; j < coords[i].length; j++) {\r\n                                var hierarchy;\r\n                                if (j == 0) {\r\n                                    getting.push(getOutlineGeom.call(this, coords[i][0]));\r\n                                    hierarchy = new Cesium.PolygonHierarchy(coords[i][0]);\r\n                                } else {\r\n                                    getting.push(getOutlineGeom.call(this, coords[i][j]));\r\n                                    hierarchy.holes.push(new Cesium.PolygonHierarchy(coords[i][j]));\r\n                                }\r\n                            }\r\n\r\n                            geomPolys.push(getPolyGeom(hierarchy));\r\n                        }\r\n\r\n                        Promise.all(getting).then(function () {\r\n                            getting = [];\r\n\r\n                            resolve(\r\n                                [new Cesium.GroundPrimitive({\r\n                                    releaseGeometryInstances: false,\r\n                                    geometryInstances: geomPolys\r\n                                }), geomOutlines]);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n            else if (TC.feature.Polygon && feature.CLASSNAME == \"TC.feature.Polygon\") {\r\n                polygon.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        if ($.isArray(coords) && coords.length === 1 && $.isArray(coords[0])) {\r\n                            coords = coords[0];\r\n                        }\r\n\r\n                        createLine(feature.id, coords, {\r\n                            material: options.outlineColor, width: options.width\r\n                        }, function (entity) {\r\n\r\n                            resolve([\r\n                                new Cesium.GroundPrimitive({\r\n                                    releaseGeometryInstances: false,\r\n                                    geometryInstances: new Cesium.GeometryInstance({\r\n                                        id: feature.id,\r\n                                        geometry: new Cesium.PolygonGeometry({\r\n                                            polygonHierarchy: new Cesium.PolygonHierarchy(coords)\r\n                                        }),\r\n                                        attributes: {\r\n                                            color: options.color\r\n                                        }\r\n                                    })\r\n                                }), entity]);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n\r\n            return polygon;\r\n        };\r\n        var lineConverter = function (feature) {\r\n            var self = this;\r\n            var line = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            line.options = function () {\r\n                var opt = {};\r\n                var properties = {\r\n                    color: { prop: 'strokeColor' },\r\n                    opacity: { prop: 'strokeOpacity' },\r\n                    width: { prop: 'strokeWidth' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                opt.color = color;\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.MultiPolyline && feature.CLASSNAME == \"TC.feature.MultiPolyline\") {\r\n                line.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n                        var geomInstances = [];\r\n\r\n                        var getting = [];\r\n\r\n                        if (coords.length == 1) {\r\n                            coords = coords[0];\r\n\r\n                            getting.push(new Promise(function (res, rej) {\r\n                                createLine(feature.id, coords, {\r\n                                    material: options.color, width: options.width\r\n                                }, function (entity) {\r\n                                    geomInstances.push(entity);\r\n                                    res();\r\n                                });\r\n                            }));\r\n\r\n\r\n                        } else {\r\n                            coords = coords.sort(function (a, b) {\r\n                                if (a.length > b.length) {\r\n                                    return -1;\r\n                                }\r\n                                if (a.length < b.length) {\r\n                                    return 1;\r\n                                }\r\n                                return 0;\r\n                            });\r\n                            var pixelSize = getPixelSize(coords[0]);\r\n                            for (var i = 0; i < coords.length; i++) {\r\n\r\n                                getting.push(new Promise(function (res, rej) {\r\n                                    createLine(feature.id, coords[i], {\r\n                                        material: options.color, width: options.width\r\n                                    }, function (entity) {\r\n                                        geomInstances.push(entity);\r\n                                        res();\r\n                                    });\r\n                                }));\r\n                            }\r\n                        }\r\n\r\n                        Promise.all(getting).then(function () {\r\n                            getting = [];\r\n\r\n                            resolve(geomInstances);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n            else if (TC.feature.Polyline && feature.CLASSNAME == \"TC.feature.Polyline\") {\r\n                line.geometryType = function (coords, options) {\r\n                    return new Promise(function (resolve, reject) {\r\n\r\n                        createLine(feature.id, coords, {\r\n                            material: options.color, width: options.width\r\n                        }, function (entity) {\r\n                            resolve(entity);\r\n                        });\r\n                    });\r\n                };\r\n            }\r\n\r\n            return line;\r\n        };\r\n        var pointConverter = function (feature) {\r\n            var self = this;\r\n            var point = {};\r\n            var styles = getFeatureStyle(feature);\r\n\r\n            point.options = function () {\r\n                var opt = {};\r\n\r\n                var properties = {\r\n                    rotation: { prop: 'angle' },\r\n                    label: { prop: 'label' },\r\n                    fontSize: { prop: 'fontSize' },\r\n                    fontColor: { prop: 'fontColor' },\r\n                    outlineLabelColor: { prop: 'labelOutlineColor' },\r\n                    outlineLabelWidth: { prop: 'labelOutlineWidth' },\r\n                    anchor: { prop: 'anchor' },\r\n                    height: { prop: 'height' },\r\n                    width: { prop: 'width' },\r\n                    url: { prop: 'url' },\r\n                    color: { prop: 'fillColor' },\r\n                    opacity: { prop: 'fillOpacity' },\r\n                    outlineColor: { prop: 'strokeColor' },\r\n                    outlineOpacity: { prop: 'strokeOpacity' },\r\n                    outlineWidth: { prop: 'strokeWidth' },\r\n                    radius: { prop: 'radius' }\r\n                };\r\n\r\n                setStyleProperties(styles, properties, feature);\r\n\r\n                if (properties.anchor.hasOwnProperty('val')) {\r\n                    if (!(properties.url.hasOwnProperty('val')) && feature.options.url) {\r\n                        opt.url = feature.options.url;\r\n                    } else {\r\n                        opt.url = properties.url.val;\r\n                    }\r\n\r\n                    opt.anchor = properties.anchor.val;\r\n                }\r\n\r\n                if (properties.height.hasOwnProperty('val')) {\r\n                    opt.height = properties.height.val;\r\n                }\r\n\r\n                if (properties.width.hasOwnProperty('val')) {\r\n                    opt.width = properties.width.val;\r\n                }\r\n\r\n                if (properties.rotation.hasOwnProperty('val')) {\r\n                    opt.rotation = properties.rotation.val;\r\n                }\r\n\r\n                if (properties.label.hasOwnProperty('val')) {\r\n                    opt.label = properties.label.val;\r\n                }\r\n\r\n                if (properties.fontSize.hasOwnProperty('val')) {\r\n                    opt.fontSize = properties.fontSize.val;\r\n                }\r\n\r\n                if (properties.fontColor.hasOwnProperty('val')) {\r\n                    opt.fontColor = toCesiumColor(properties.fontColor.val);\r\n                }\r\n\r\n                if (properties.outlineLabelColor.hasOwnProperty('val')) {\r\n                    opt.outlineLabelColor = toCesiumColor(properties.outlineLabelColor.val);\r\n                }\r\n\r\n                if (properties.outlineLabelWidth.hasOwnProperty('val')) {\r\n                    opt.outlineLabelWidth = properties.outlineLabelWidth.val;\r\n                }\r\n\r\n\r\n                var color;\r\n                if (properties.color.hasOwnProperty('val')) {\r\n                    if (properties.opacity.hasOwnProperty('val')) {\r\n                        opt.color = toCesiumColor(properties.color.val, properties.opacity.val);\r\n                    } else {\r\n                        opt.color = toCesiumColor(properties.color.val);\r\n                    }\r\n                }\r\n\r\n                if (properties.outlineColor.hasOwnProperty('val')) {\r\n                    if (properties.outlineOpacity.hasOwnProperty('val')) {\r\n                        opt.outlineColor = toCesiumColor(properties.outlineColor.val, properties.outlineOpacity.val);\r\n                    } else {\r\n                        opt.outlineColor = toCesiumColor(properties.outlineColor.val);\r\n                    }\r\n                }\r\n\r\n                if (properties.outlineWidth.hasOwnProperty('val')) {\r\n                    opt.outlineWidth = properties.outlineWidth.val;\r\n                }\r\n\r\n                if (properties.radius.hasOwnProperty('val')) {\r\n                    opt.radius = properties.radius.val;\r\n                }\r\n\r\n                return opt;\r\n            };\r\n\r\n            if (TC.feature.Marker && feature.CLASSNAME == \"TC.feature.Marker\") {\r\n                point.geometryType = function (coords, options) {\r\n                    var billboard = {\r\n                        name: feature.id,\r\n                        position: coords[0],\r\n                        billboard: {\r\n                            image: options.url,\r\n                            width: options.width,\r\n                            height: options.height,\r\n                            eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                        }\r\n                    };\r\n\r\n                    if (options.anchor && options.anchor.length > 0) {\r\n                        billboard.billboard.pixelOffset = new Cesium.Cartesian2(options.anchor[0], options.anchor[1]);\r\n                    }\r\n\r\n                    if (!options.label) {\r\n                        return new Cesium.Entity(billboard);\r\n                    } else {\r\n                        billboard.label = {\r\n                            text: options.label,\r\n                            font: '14pt sans-serif',\r\n                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,\r\n                            horizontalOrigin: Cesium.HorizontalOrigin.LEFT,\r\n                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                            fillColor: options.fontColor,\r\n                            showBackground: true,\r\n                            eyeOffset: new Cesium.Cartesian3(3000, 0, -100)\r\n                        };\r\n\r\n                        return new Cesium.Entity(billboard);\r\n                    }\r\n                };\r\n            }\r\n            else if (TC.feature.Point && feature.CLASSNAME == \"TC.feature.Point\") {\r\n                var pinBuilder = new Cesium.PinBuilder();\r\n\r\n                point.geometryType = function (coords, options) {\r\n                    var text = options.label;\r\n\r\n                    switch (true) {\r\n                        case (text && /^([A-Z])\\w+$/gi.test(text)):\r\n                        case (text && !/^[0-9]*\\-{0,1}[a-z]{0,4}$/gi.test(text)):\r\n\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                label: {\r\n                                    text: options.label,\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,\r\n                                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BASELINE,\r\n                                    font: '16' + 'px san-serif Helvetica',\r\n                                    fillColor: Cesium.Color.BLACK,\r\n                                    outlineColor: Cesium.Color.WHITE,\r\n                                    outlineWidth: 5,\r\n                                    style: Cesium.LabelStyle.FILL_AND_OUTLINE\r\n                                }\r\n                            });\r\n\r\n                            break;\r\n                        case (/^[0-9]*\\-{0,1}[a-z]{0,4}$/gi.test(text)):\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: pinBuilder.fromText(text, options.fontColor, 48).toDataURL(),\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                            break;\r\n                        case options.radius && options.radius > 0:\r\n                            var stringifyScratch = new Array(2);\r\n\r\n                            const drawPin = function (context2D, color, size) {\r\n\r\n                                color = color.darken(0.15, new Cesium.Color());\r\n                                var rgbaColor = color.toCssColorString().replace(\"rgb\", \"rgba\").replace(\")\", \",0)\");\r\n\r\n                                context2D.save();\r\n                                context2D.scale(size / 24, size / 24);\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.miterLimit = 4;\r\n                                context2D.font = \"normal normal 400 normal 15px / 21.4286px ''\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.save();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.font = \"   15px \";\r\n                                context2D.save();\r\n                                context2D.fillStyle = \"#b3b3b3\";\r\n                                context2D.fillStyle = \"rgba(179, 179, 179, 1)\";\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.lineWidth = 1.5;\r\n                                context2D.lineJoin = \"round\";\r\n                                context2D.miterLimit = \"4\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.beginPath();\r\n                                context2D.moveTo(11.578125, 11.71875);\r\n                                context2D.lineTo(12.421875, 11.71875);\r\n                                context2D.lineTo(12.421875, 24);\r\n                                context2D.lineTo(11.578125, 24);\r\n                                context2D.closePath();\r\n                                context2D.fill();\r\n                                context2D.stroke();\r\n                                context2D.restore();\r\n                                context2D.save();\r\n                                context2D.fillStyle = color.toCssColorString().replace(\"rgb\", \"rgba\").replace(\")\", \", 1)\");\r\n                                context2D.strokeStyle = rgbaColor;\r\n                                context2D.lineWidth = 1.5;\r\n                                context2D.lineJoin = \"round\";\r\n                                context2D.miterLimit = \"4\";\r\n                                context2D.font = \"   15px \";\r\n                                context2D.beginPath();\r\n                                context2D.moveTo(17, 7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 0, 1.5707963267948966, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 1.5707963267948966, 3.141592653589793, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, 3.141592653589793, 4.71238898038469, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.translate(12, 7);\r\n                                context2D.rotate(0);\r\n                                context2D.arc(0, 0, 5, -1.5707963267948966, 0, 0);\r\n                                context2D.rotate(0);\r\n                                context2D.translate(-12, -7);\r\n                                context2D.closePath();\r\n                                context2D.fill();\r\n                                context2D.stroke();\r\n                                context2D.restore();\r\n                            };\r\n\r\n                            const createPin = function (color, size) {\r\n                                if (!pinBuilder._cache) {\r\n                                    pinBuilder._cache = {};\r\n                                }\r\n\r\n                                stringifyScratch[0] = color;\r\n                                stringifyScratch[1] = size;\r\n                                var id = JSON.stringify(stringifyScratch);\r\n\r\n                                var item = pinBuilder._cache[id];\r\n                                if (item) {\r\n                                    return item;\r\n                                }\r\n\r\n                                var canvas = document.createElement('canvas');\r\n                                canvas.width = size;\r\n                                canvas.height = size;\r\n\r\n                                var context2D = canvas.getContext('2d');\r\n                                drawPin(context2D, color, size);\r\n\r\n                                pinBuilder._cache[id] = canvas;\r\n                                return canvas;\r\n                            }\r\n\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: createPin(Cesium.Color.fromCssColorString(feature.options.strokeColor ? feature.options.strokeColor : TC.Cfg.styles.point.strokeColor), 48).toDataURL(),\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                        default:\r\n                            return new Cesium.Entity({\r\n                                name: feature.id,\r\n                                position: coords[0],\r\n                                billboard: {\r\n                                    image: pinBuilder.fromColor(Cesium.Color.fromCssColorString(feature.options.fillColor ? feature.options.fillColor : TC.Cfg.styles.point.fillColor), 32).toDataURL(),\r\n                                    eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,\r\n                                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                }\r\n                            });\r\n                    }\r\n                };\r\n            }\r\n\r\n            return point;\r\n        };\r\n\r\n        this.convert = function (scn, feature, sourceCrs, targetCrs) {\r\n            scene = scn;\r\n\r\n            var byPromise = false;\r\n            var cartesians = [];\r\n            var toCartesian = function (coord, arr) {\r\n                if (!$.isArray(coord)) {\r\n                    return;\r\n                }\r\n\r\n                if (sourceCrs !== targetCrs) {\r\n                    coord = TC.Util.reproject(coord, sourceCrs, targetCrs);\r\n                }\r\n\r\n                arr.push(coord.length > 2 ?\r\n                    Cesium.Cartesian3.fromDegrees(coord[0], coord[1], coord[2]) :\r\n                    Cesium.Cartesian3.fromDegrees(coord[0], coord[1]));\r\n            };\r\n\r\n            var obj;\r\n            var geometry = feature.geometry;\r\n            var converter;\r\n\r\n            var point,\r\n                points,\r\n                ringsOrPolylines,\r\n                polygons;\r\n\r\n            var forPoints = function (points, arr) {\r\n                if ($.isArray(points)) {\r\n                    for (var i = 0; i < points.length; i++) {\r\n                        toCartesian(points[i], arr);\r\n                    }\r\n                }\r\n            };\r\n            var forRingsOrPolylines = function (ringsOrPolylines, arr) {\r\n                if ($.isArray(ringsOrPolylines)) {\r\n                    for (var i = 0; i < ringsOrPolylines.length; i++) {\r\n                        arr.push([]);\r\n                        forPoints(ringsOrPolylines[i], arr[arr.length - 1]);\r\n                    }\r\n                }\r\n            };\r\n            var forPolygons = function (polygons) {\r\n                if ($.isArray(polygons)) {\r\n                    for (var i = 0; i < polygons.length; i++) {\r\n                        cartesians.push([]);\r\n                        forRingsOrPolylines(polygons[i], cartesians[cartesians.length - 1]);\r\n                    }\r\n                }\r\n            };\r\n\r\n            switch (true) {\r\n                case (TC.feature.Circle && feature.CLASSNAME == \"TC.feature.Circle\"):\r\n                    forPoints(geometry, cartesians);\r\n                    converter = circleConverter.call(self, feature);\r\n                    break;\r\n                case (TC.feature.MultiPolygon && feature.CLASSNAME == \"TC.feature.MultiPolygon\"):\r\n                    polygons = geometry;\r\n                    if ($.isArray(polygons)) {\r\n                        forPolygons(polygons);\r\n\r\n                        converter = polygonConverter.call(self, feature);\r\n                        byPromise = true;\r\n                    }\r\n                    break;\r\n                case ((TC.feature.Polygon && feature.CLASSNAME == \"TC.feature.Polygon\") || (TC.feature.MultiPolyline && feature.CLASSNAME == \"TC.feature.MultiPolyline\")):\r\n                    ringsOrPolylines = geometry;\r\n                    if ($.isArray(ringsOrPolylines)) {\r\n                        forRingsOrPolylines(ringsOrPolylines, cartesians);\r\n\r\n                        if (feature.CLASSNAME == \"TC.feature.Polygon\") {\r\n                            converter = polygonConverter(feature);\r\n                            byPromise = true;\r\n                        }\r\n                        else if (feature.CLASSNAME == \"TC.feature.MultiPolyline\") {\r\n                            converter = lineConverter(feature);\r\n                            byPromise = true;\r\n                        }\r\n                    }\r\n                    break;\r\n                case (TC.feature.Polyline && feature.CLASSNAME == \"TC.feature.Polyline\"):\r\n                    points = geometry;\r\n                    if ($.isArray(points)) {\r\n                        forPoints(points, cartesians);\r\n\r\n                        converter = lineConverter(feature);\r\n                        byPromise = true;\r\n                    }\r\n                    break;\r\n                case (TC.feature.Marker && feature.CLASSNAME == \"TC.feature.Marker\"):\r\n                    points = [geometry];\r\n                    forPoints(points, cartesians);\r\n\r\n                    converter = pointConverter(feature);\r\n                    break;\r\n                case (TC.feature.Point && feature.CLASSNAME == \"TC.feature.Point\"):\r\n                    points = [geometry];\r\n                    forPoints(points, cartesians);\r\n\r\n                    converter = pointConverter(feature);\r\n                    break;\r\n            }\r\n\r\n            if (cartesians.length == 0) {\r\n                return null;\r\n            }\r\n\r\n            obj = {\r\n                id: feature.id,\r\n                attributes: feature.data,\r\n                boundigSphere: Cesium.BoundingSphere.fromPoints(cartesians)\r\n            };\r\n\r\n            if (!byPromise) { // si estamos pintando líneas, obtenemos posiciones con altura\r\n                obj.geometry = converter.geometryType(cartesians, converter.options());\r\n            } else {\r\n                obj.geometry = function (provider) {\r\n                    converter.provider = provider;\r\n                    return converter.geometryType(cartesians, converter.options());\r\n                }\r\n            }\r\n\r\n            return obj;\r\n        };\r\n    };\r\n\r\n    const currentMapCfg = {\r\n        baseMap: '',\r\n        baseMaps: [],\r\n        baseVector: ''\r\n    };\r\n    const setMustReprojectOfBaseLayers = function (map) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var isBaseRaster = map.baseLayer instanceof TC.layer.Raster;\r\n\r\n            if (isBaseRaster) {\r\n                if (!isCompatible(map.baseLayer, self.view3D.crs)) {\r\n                    var fallbackLayer = map.baseLayer.getFallbackLayer();\r\n                    if (fallbackLayer) {\r\n                        fallbackLayer._capabilitiesPromise.then(function () {\r\n                            if (!fallbackLayer.isCompatible(self.view3D.crs)) {\r\n                                map.toast(self.getLocaleString('threed.baseLayerNoCompatible', { name: map.baseLayer.layerNames }));\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            } else {\r\n                currentMapCfg.baseVector = map.baseLayer;\r\n            }\r\n\r\n            if (currentMapCfg.baseMaps.length === 0) {\r\n\r\n                Promise.all(map.baseLayers.map(function (baseLayer) {\r\n                    if (!isCompatible(baseLayer, self.view3D.crs)) {\r\n                        var fallbackLayer = baseLayer.getFallbackLayer();\r\n                        if (fallbackLayer) {\r\n                            return fallbackLayer._capabilitiesPromise.then(function () {\r\n                                return !fallbackLayer.isCompatible(self.view3D.crs);\r\n                            });\r\n                        } else {\r\n                            return Promise.resolve(true);\r\n                        }\r\n                    } else {\r\n                        return Promise.resolve(false);\r\n                    }\r\n                })).then(function (results) {\r\n                    if (results.length > 0) {\r\n                        for (var i = 0; i < map.baseLayers.length; i++) {\r\n                            map.baseLayers[i].mustReproject = results[i];\r\n                        }\r\n\r\n                        //map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.THREED });\r\n                    }\r\n\r\n                    resolve();\r\n                });\r\n            }\r\n\r\n            currentMapCfg.baseMap = isBaseRaster ? map.baseLayer : self.Consts.BLANK_BASE;\r\n        });\r\n    };\r\n    var removeNoCompatibleBaseLayers = function (map) {\r\n        var selectNewBaseLayer = false;\r\n\r\n        if (currentMapCfg.baseMaps && currentMapCfg.baseMaps.length) {\r\n            for (var i = 0; i < currentMapCfg.baseMaps.length; i++) {\r\n                for (var j = 0; j < map.baseLayers.length; j++) {\r\n                    if (map.baseLayers[j] === currentMapCfg.baseMaps[i].l) {\r\n\r\n                        if (currentMapCfg.baseMap == map.baseLayers[j]) {\r\n                            // si uno de los mapas de fondo no soportados para 3d es el mapa de fondo seleccionado ahora mismo\r\n                            // seleciono otro de los que sí son soportados\r\n                            selectNewBaseLayer = true;\r\n                        }\r\n\r\n                        map.trigger(TC.Consts.event.LAYERREMOVE, { layer: map.baseLayers[j] });\r\n                        map.baseLayers.splice(j, 1);\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (selectNewBaseLayer) {\r\n                // si uno de los mapas de fondo no soportados para 3d es el mapa de fondo seleccionado ahora mismo\r\n                // seleciono otro de los que sí son soportados\r\n\r\n                map.baseLayer = map.baseLayers[0];\r\n                map.trigger(TC.Consts.event.BASELAYERCHANGE, { layer: map.baseLayer });\r\n            }\r\n        }\r\n    };\r\n    var addNoCompatibleBaseLayers = function (map) {\r\n        var self = this;\r\n\r\n        if (currentMapCfg.baseMaps && currentMapCfg.baseMaps.length) {\r\n            for (var i = 0; i < currentMapCfg.baseMaps.length; i++) {\r\n                self.map.trigger(TC.Consts.event.LAYERADD, { layer: currentMapCfg.baseMaps[i].l });\r\n                self.map.baseLayers.splice(currentMapCfg.baseMaps[i].i, 0, currentMapCfg.baseMaps[i].l);\r\n            }\r\n        }\r\n    };\r\n\r\n    viewProto.init = function (options) {\r\n        const self = this;\r\n\r\n        self.events = self.map.$events;\r\n\r\n        self.selectors = {\r\n            divThreedMap: options.divMap\r\n        };\r\n\r\n        if (options.terrain) {\r\n            self.terrain = options.terrain;\r\n        } else {\r\n            throw Error(\"Falta configuración del terreno\");\r\n        }\r\n\r\n        if (options.terrainFallback && options.terrainFallback.url && options.terrainFallback.coverageName && options.terrainFallback.noDataValue) {\r\n            self.terrainFallback = {\r\n                url: options.terrainFallback.url.trim(),\r\n                layerName: options.terrainFallback.coverageName,\r\n                format: options.terrainFallback.format,\r\n                noDataValue: options.terrainFallback.noDataValue\r\n            };\r\n        } else if (options.terrainFallback && (!options.terrainFallback.url || !options.terrainFallback.coverageName || !options.terrainFallback.noDataValue)) {\r\n            throw Error(\"Faltan datos sobre el terreno de respaldo\");\r\n        }\r\n\r\n        if (options.controls) {\r\n            self.allowedControls = options.controls;\r\n        }\r\n\r\n        self.mapView = new MapView(self.map, self);\r\n\r\n        self.map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n            self.mapView.metersPerUnit = self.map.getMetersPerUnit();\r\n        });\r\n\r\n        self.map.view3D = self.view3D;\r\n\r\n        /* provisional: no dispongo de getRenderedHtml porque ya no es un control */\r\n        self.getRenderedHtml(self.CLASS + '-overlay', {}, function (html) {\r\n            const parser = new DOMParser();\r\n            self.overlay = parser.parseFromString(html, 'text/html').body.firstChild;\r\n        });\r\n    };\r\n\r\n    viewProto.apply = function (options) {\r\n        const self = this;\r\n\r\n        options = options || {};\r\n\r\n        if (options.map) {\r\n            self.map = options.map;\r\n\r\n            if (!self.map.view3D) {\r\n                var viewName = self.VIEWNAME = self.VIEWNAME.substr(0, 1).toLowerCase() + self.VIEWNAME.substr(1);\r\n                if (self.map.options.views && self.map.options.views.hasOwnProperty(viewName)) {\r\n                    self.init(self.map.options.views[viewName]);\r\n                } else {\r\n                    throw Error('Falta configuración de la vista');\r\n                }\r\n            }\r\n\r\n            self.view3D.view2DCRS = options.map.crs;\r\n\r\n            options.map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n                self.view3D.view2DCRS = e.crs;\r\n            });\r\n        } else {\r\n            throw Error('Falta referencia al mapa 2D');\r\n        }\r\n\r\n        if (options.state) {\r\n            self.map.toast(TC.Util.getLocaleString(self.map.options.locale, 'threed.apply3DState'), { type: TC.Consts.msgType.INFO });\r\n        }\r\n\r\n        if (!self.waiting) {\r\n            self.waiting = self.map.getLoadingIndicator().addWait();\r\n        }\r\n\r\n        if (!self.ctrlsToMng) {\r\n            var ctls = [];\r\n            for (var i = 0, len = self.allowedControls.length; i < len; i++) {\r\n                var ctl = self.allowedControls[i];\r\n                ctl = ctl.substr(0, 1).toUpperCase() + ctl.substr(1);\r\n                var ctlsOnMap = self.map.getControlsByClass('TC.control.' + ctl);\r\n                if (ctlsOnMap.length === 0) { // si un control soportado aún no está en el mapa, nos suscribimos al addcontrol para controlarlo\r\n                    self.map.on(TC.Consts.event.CONTROLADD, function (ctrlClass, e) {\r\n                        var instance = new Function(\"return new \" + ctrlClass + \"()\")();\r\n                        if (instance.CLASS === e.control.CLASS) {\r\n                            self.ctrlsToMng.push(e.control);\r\n                        }\r\n                    }.bind(self, 'TC.control.' + ctl));\r\n                }\r\n                ctls = ctls.concat(ctlsOnMap);\r\n            }\r\n\r\n            self.ctrlsToMng = ctls;\r\n        }\r\n\r\n        self.map.on3DView = true;\r\n\r\n        self.map.div.classList.add(TC.Consts.classes.THREED);\r\n\r\n        self.divThreedMap = document.querySelector('#' + self.selectors.divThreedMap);\r\n        self.divThreedMap.classList.add(self.classes.MAPTHREED);\r\n        self.divThreedMap.classList.add(self.classes.LOADING);\r\n\r\n        self.view3D.container = self.divThreedMap;\r\n\r\n        const loaded = function () {\r\n            self.map.getLoadingIndicator().removeWait(self.waiting);\r\n\r\n            delete self.waiting;\r\n\r\n            if (options.callback) {\r\n                options.callback();\r\n            }\r\n        };\r\n\r\n        try {\r\n            self.view3D.loadViewer.call(self).then(function () {\r\n\r\n                self.divThreedMap.classList.remove(self.CLASS + '-divMap-fadeOut');\r\n                self.divThreedMap.classList.add(self.CLASS + '-divMap-fadeIn');\r\n                self.mapView.viewHTML.classList.remove(self.CLASS + '-divMap-fadeIn');\r\n                self.mapView.viewHTML.classList.add(self.CLASS + '-divMap-fadeOut');\r\n\r\n                if (!options.state) {\r\n                    self.divThreedMap.classList.remove(self.classes.LOADING);\r\n                }\r\n\r\n                // mapas de fondo y capas\r\n                setMustReprojectOfBaseLayers.call(self, self.map).then(function () {\r\n\r\n                    // extent\r\n                    self.view3D.setCameraFromMapView.call(self);\r\n\r\n                    // mapa de fondo\r\n                    self.view3D.setBaseLayer.call(self, self.map.baseLayer);\r\n\r\n                    // capas de trabajo\r\n                    self.map.workLayers.filter(function (elem) {\r\n                        return elem.type === TC.Consts.layerType.WMTS || elem.type === TC.Consts.layerType.WMS;\r\n                    }).reverse().forEach(function (layer) {\r\n                        self.view3D.addLayer.call(self, layer);\r\n                    });\r\n\r\n                    self.viewer.readyPromise.then(function () {\r\n\r\n                        if (!self.view3D.cameraControls) self.view3D.cameraControls = new CameraControls(self);\r\n                        else self.view3D.cameraControls.render.call(self.view3D.cameraControls);\r\n\r\n                        if (!options.animateRendering && !options.state) {\r\n                            options.animateRendering = true;\r\n                        }\r\n\r\n                        if (options.state) {\r\n\r\n                            self.divThreedMap.classList.remove(self.classes.LOADING);\r\n\r\n                            var camera = self.view3D.cameraControls.getCamera();\r\n                            camera.flyTo({\r\n                                destination: Cesium.Cartesian3.fromRadians(options.state.cp[0], options.state.cp[1], options.state.cp[2]),\r\n                                orientation: {\r\n                                    heading: options.state.chpr[0],\r\n                                    pitch: options.state.chpr[1],\r\n                                    roll: options.state.chpr[2]\r\n                                },\r\n                                complete: loaded\r\n                            });\r\n\r\n                        } else if (options.animateRendering) {\r\n                            var angle = Cesium.Math.toRadians(50);\r\n                            var pickBP = pickBottomPoint(self.viewer.scene);\r\n\r\n                            var animationCallback = function () {\r\n\r\n                                Cesium.Camera.DEFAULT_VIEW_RECTANGLE = self.view3D.initialRectangle = self.viewer.camera.computeViewRectangle();\r\n                                Cesium.Camera.DEFAULT_VIEW_FACTOR = 0;\r\n\r\n                                loaded();\r\n                            };\r\n\r\n                            /* provisional: si llegamos aquí, es que el terreno está listo, por tanto, no entiendo porque da undefined */\r\n                            if (pickBP) {\r\n                                pickBP = Cesium.Matrix4.fromTranslation(pickBP);\r\n\r\n                                self.view3D.rotateAroundAxis(self.viewer.scene.camera, -angle, self.viewer.scene.camera.right, pickBP, {\r\n                                    duration: 2000,\r\n                                    callback: animationCallback\r\n                                });\r\n                            } else {\r\n                                animationCallback();\r\n                            }\r\n\r\n                        } else {\r\n                            loaded();\r\n                        }\r\n\r\n                        self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.THREED });\r\n\r\n                        self.events.on(TC.Consts.event.TERRAINLOADED, function () {\r\n\r\n                            const addHeight = function (position) {\r\n                                var cartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(position);\r\n                                var height = self.viewer.scene.globe.getHeight(cartographic) || 0;\r\n                                var finalCartographic = {\r\n                                    longitude: cartographic.longitude,\r\n                                    latitude: cartographic.latitude,\r\n                                    height: cartographic.height + height\r\n                                };\r\n\r\n                                return Cesium.Ellipsoid.WGS84.cartographicToCartesian(finalCartographic);\r\n                            };\r\n\r\n                            var markers = self.viewer.entities.values.filter(function (entity) {\r\n                                return entity.billboard;\r\n                            });\r\n\r\n                            if (markers.length > 0) {\r\n                                markers.forEach(function (marker) {\r\n                                    marker.position = addHeight(Cesium.Property.getValueOrUndefined(marker.position, Cesium.JulianDate.now));\r\n                                });\r\n                            }\r\n\r\n                            if (self.viewer.billboardCollection) {\r\n\r\n                                for (var i = 0; i < self.viewer.billboardCollection.length; i++) {\r\n                                    self.viewer.billboardCollection.get(i).position = addHeight(self.viewer.billboardCollection.get(i).position);\r\n                                }\r\n\r\n                                self.viewer.scene.requestRender();\r\n                            }\r\n\r\n                        });\r\n                    }.bind(self));\r\n                });\r\n            });\r\n        } catch (error) {\r\n            loaded();\r\n\r\n            throw error;\r\n        }\r\n    };\r\n\r\n    viewProto.unapply = function (options) {\r\n        const self = this;\r\n\r\n        if (!self.waiting) {\r\n            self.waiting = self.map.getLoadingIndicator().addWait();\r\n        }\r\n\r\n        self.map.on3DView = false;\r\n\r\n        //self.map.view3D = null;\r\n\r\n        self.view3D.cameraControls.resetRotation({ duration: 1000 }).then(function () {\r\n\r\n            var animationCallback = function () {\r\n\r\n                self.map.div.classList.remove(TC.Consts.classes.THREED);\r\n\r\n                /* atribuciones del terreno */\r\n                self.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE, { terrainProvider: self.viewer.scene.terrainProvider });\r\n\r\n                if (self.viewer.scene.terrainProvider.fallbackProvider) {\r\n                    self.viewer.scene.terrainProvider.fallbackProvider.forEach(function (provider) {\r\n                        self.map.trigger(TC.Consts.event.TERRAINPROVIDERREMOVE, { terrainProvider: provider });\r\n                    });\r\n                }\r\n\r\n                self.view3D.setViewFromCameraView.call(self).then(function () {\r\n                    self.divThreedMap.classList.remove(self.classes.MAPTHREED);\r\n\r\n                    self.divThreedMap.classList.remove(self.CLASS + '-divMap-fadeIn');\r\n                    self.divThreedMap.classList.add(self.CLASS + '-divMap-fadeOut');\r\n                    self.mapView.viewHTML.classList.remove(self.CLASS + '-divMap-fadeOut');\r\n                    self.mapView.viewHTML.classList.add(self.CLASS + '-divMap-fadeIn');\r\n\r\n                    self.view3D.destroy.call(self);\r\n\r\n                    self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                    delete self.waiting;\r\n\r\n                    if (options.callback) {\r\n                        options.callback();\r\n                    }\r\n                });\r\n\r\n                self.mapView.setRotation(0);\r\n                self._ovMap.wrap.draw3DCamera(null);\r\n            };\r\n\r\n            var bottom = pickBottomPoint(self.viewer.scene);\r\n            var transform = Cesium.Matrix4.fromTranslation(bottom);\r\n            var angle = computeAngleToZenith(self.viewer.scene, bottom);\r\n\r\n            self.view3D.rotateAroundAxis(self.viewer.scene.camera, -angle, self.viewer.scene.camera.right, transform, {\r\n                duration: 1500,\r\n                callback: animationCallback\r\n            });\r\n        });\r\n    };\r\n\r\n    viewProto.view3D = (function () {\r\n\r\n        var rasterConverter = new RasterConverter(/(EPSG\\:?4326)/i);\r\n        var featureConverter = new FeatureConverter();\r\n\r\n        var overrideDesktopZoom = function () {\r\n            var self = this;\r\n\r\n            if (!TC.Util.detectMobile()) {\r\n                self.viewer.scene.screenSpaceCameraController.enableZoom = false;\r\n\r\n                var element = self.viewer.scene.canvas;\r\n                // detect available wheel event\r\n                var wheelEvent;\r\n                if ('onwheel' in element) {\r\n                    // spec event type\r\n                    wheelEvent = 'wheel';\r\n                } else if (document.onmousewheel !== undefined) {\r\n                    // legacy event type\r\n                    wheelEvent = 'mousewheel';\r\n                } else {\r\n                    // older Firefox\r\n                    wheelEvent = 'DOMMouseScroll';\r\n                }\r\n                element.addEventListener(wheelEvent, function (event) {\r\n                    var delta;\r\n                    // standard wheel event uses deltaY.  sign is opposite wheelDelta.\r\n                    // deltaMode indicates what unit it is in.\r\n                    if (event.deltaY) {\r\n                        var deltaMode = event.deltaMode;\r\n                        if (deltaMode === event.DOM_DELTA_PIXEL) {\r\n                            delta = - event.deltaY;\r\n                        } else if (deltaMode === event.DOM_DELTA_LINE) {\r\n                            delta = - event.deltaY * 40;\r\n                        } else {\r\n                            // DOM_DELTA_PAGE\r\n                            delta = - event.deltaY * 120;\r\n                        }\r\n                    } else if (event.detail > 0) {\r\n                        // old Firefox versions use event.detail to count the number of clicks. The sign\r\n                        // of the integer is the direction the wheel is scrolled.\r\n                        delta = event.detail * -120;\r\n                    } else {\r\n                        delta = event.wheelDelta;\r\n                    }\r\n\r\n                    self.view3D.zoomToCartesian.call(self, self.view3D._lastMousePosition, delta);\r\n\r\n                }, false);\r\n\r\n                var eventHandler = new Cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas);\r\n                eventHandler.setInputAction(function (event) {\r\n                    self.view3D._lastMousePosition = event;\r\n                }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);\r\n                eventHandler.setInputAction(function (wheelZoomAmount) {\r\n                    self.view3D.zoomToCartesian.call(self, self.view3D._lastMousePosition, wheelZoomAmount);\r\n                }, Cesium.ScreenSpaceEventType.WHEEL);\r\n                var pinchCenterPosition = new Cesium.Cartesian2();\r\n                var pinchAmount = 0;\r\n                eventHandler.setInputAction(function (event) {\r\n                    Cesium.Cartesian2.lerp(event.position1, event.position2, 0.5, pinchCenterPosition);\r\n                }, Cesium.ScreenSpaceEventType.PINCH_START);\r\n                eventHandler.setInputAction(function (event) {\r\n                    var diff = event.distance.endPosition.y - event.distance.startPosition.y;\r\n                    var rangeWindowRatio = diff / self.viewer.scene.canvas.clientHeight;\r\n                    rangeWindowRatio = Math.min(rangeWindowRatio, self.viewer.scene.screenSpaceCameraController.maximumMovementRatio);\r\n                    pinchAmount = rangeWindowRatio;\r\n                }, Cesium.ScreenSpaceEventType.PINCH_MOVE);\r\n                eventHandler.setInputAction(function (event) {\r\n                    self.view3D.zoomToCartesian.call(self, { endPosition: pinchCenterPosition }, pinchAmount);\r\n                }, Cesium.ScreenSpaceEventType.PINCH_END);\r\n            }\r\n        };\r\n\r\n        var addFeature = function (csFeature) {\r\n            var addedFeature = csFeature;\r\n            switch (true) {\r\n                case csFeature instanceof Cesium.GroundPrimitive: {\r\n                    this.viewer.scene.groundPrimitives.add(csFeature);\r\n                    break;\r\n                }\r\n                case csFeature instanceof Object && csFeature.hasOwnProperty('billboard'): {\r\n                    if (!this.viewer.billboardCollection) {\r\n                        this.viewer.billboardCollection = this.viewer.scene.primitives.add(new Cesium.BillboardCollection({\r\n                            scene: this.viewer.scene\r\n                        }));\r\n                    }\r\n\r\n                    var billboardAtCollection = this.viewer.billboardCollection.add({\r\n                        position: csFeature.position,\r\n                        image: csFeature.billboard.image,\r\n                        verticalOrigin: csFeature.billboard.verticalOrigin,\r\n                        heightReference: csFeature.billboard.heightReference\r\n                    });\r\n\r\n                    addedFeature = billboardAtCollection;\r\n                    break;\r\n                }\r\n                case csFeature instanceof Object: {\r\n                    addedFeature = this.viewer.entities.getById(csFeature.id);\r\n                    if (!addedFeature) {\r\n                        addedFeature = this.viewer.entities.add(csFeature);\r\n                    }\r\n                    break;\r\n                }\r\n            }\r\n\r\n            this.viewer.scene.requestRender();\r\n\r\n            return addedFeature;\r\n        };\r\n        var linkFeature = function (map, idLayer, feature, id) {\r\n            if (!map.vector2DFeatures.hasOwnProperty(idLayer)) {\r\n                map.vector2DFeatures[idLayer] = {};\r\n                map.vector2DFeatures[idLayer][id] = [feature];\r\n            } else {\r\n                if (!map.vector2DFeatures[idLayer].hasOwnProperty(id)) {\r\n                    map.vector2DFeatures[idLayer][id] = [feature];\r\n                } else {\r\n                    map.vector2DFeatures[idLayer][id].push(feature);\r\n                }\r\n            }\r\n        };\r\n\r\n        var listenTo = [\r\n            TC.Consts.event.BEFOREBASELAYERCHANGE, TC.Consts.event.BASELAYERCHANGE,\r\n            TC.Consts.event.LAYERADD, TC.Consts.event.LAYERREMOVE, TC.Consts.event.LAYERVISIBILITY, TC.Consts.event.LAYEROPACITY, TC.Consts.event.LAYERORDER,\r\n            TC.Consts.event.FEATUREADD, TC.Consts.event.FEATUREREMOVE, TC.Consts.event.FEATURESCLEAR\r\n            /*, TC.Consts.event.ZOOM no encuentro en qué casos debemos escuchar el evento ZOOM de 2D, solo trae problemas */, TC.Consts.event.ZOOMTO];\r\n\r\n        var event2DHandler = function (e) {\r\n            var self = this;\r\n            \r\n            switch (true) {\r\n                case e.type == TC.Consts.event.BEFOREBASELAYERCHANGE:\r\n                    if (!self.waiting)\r\n                        self.waiting = self.map.getLoadingIndicator().addWait();\r\n                    break;\r\n                case e.type == TC.Consts.event.BASELAYERCHANGE: {\r\n                    self.view3D.setBaseLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERADD: {\r\n                    self.view3D.addLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERREMOVE: {\r\n                    self.view3D.removeLayer.call(self, e.layer);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERVISIBILITY: {\r\n                    self.view3D.setRenderOptionsLayer.call(self, e.layer, { visibility: e.layer.getVisibility() });\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYEROPACITY: {\r\n                    self.view3D.setRenderOptionsLayer.call(self, e.layer, { opacity: e.layer.getOpacity() });\r\n                    self.viewer.scene.requestRender();\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.LAYERORDER: {\r\n                    for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                        if (self.view3D.workLayers[i].imageryProvider && self.view3D.workLayers[i].imageryProvider.layers.join(',') === e.layer.names.join(',')) {\r\n\r\n                            if (e.oldIndex > e.newIndex) {\r\n                                var positions = e.oldIndex - e.newIndex;\r\n                                for (var p = 0; p < positions; p++) {\r\n                                    self.viewer.scene.imageryLayers.lower(self.view3D.workLayers[i]);\r\n                                }\r\n\r\n                            } else {\r\n                                var positions = e.newIndex - e.oldIndex;\r\n                                for (var p = 0; p < positions; p++) {\r\n                                    self.viewer.scene.imageryLayers.raise(self.view3D.workLayers[i]);\r\n                                }\r\n                            }\r\n\r\n                            self.view3D.workLayers.splice(e.newIndex, 0, self.view3D.workLayers.splice(e.oldIndex, 1)[0]);\r\n                            break;\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATUREADD: {\r\n                    self.view3D.addFeature.call(self.view3D, e.feature);\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATUREREMOVE: {\r\n\r\n                    if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(e.layer.id)) {\r\n\r\n                        const remove = function (feature) {\r\n                            if (self.view3D.vector2DFeatures[e.layer.id].hasOwnProperty(feature.id)) {\r\n                                var threedFeature = self.view3D.vector2DFeatures[e.layer.id][feature.id];\r\n                                for (var i = 0; i < threedFeature.length; i++) {\r\n                                    self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                                }\r\n\r\n                                delete self.view3D.vector2DFeatures[e.layer.id][feature.id];\r\n                            }\r\n                        };\r\n\r\n                        if (e.feature instanceof Array) {\r\n                            e.feature.forEach(remove);\r\n                        } else {\r\n                            remove(e.feature);\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.FEATURESCLEAR: {\r\n\r\n                    if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(e.layer.id)) {\r\n\r\n                        for (var featureId in self.view3D.vector2DFeatures[e.layer.id]) {\r\n                            var threedFeature = self.view3D.vector2DFeatures[e.layer.id][featureId];\r\n\r\n                            for (var i = 0; i < threedFeature.length; i++) {\r\n                                self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                            }\r\n\r\n                            delete self.view3D.vector2DFeatures[e.layer.id][featureId];\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.ZOOM: {\r\n                    if (self.view3D.cameraControls && !self.view3D.cameraControls.moving) {\r\n\r\n                        var width = self.view3D.viewer.scene.canvas.clientWidth;\r\n                        var height = self.view3D.viewer.scene.canvas.clientHeight;\r\n\r\n\r\n                        /* Si hemos llegado aquí y hay un cambio en el tamaño del canvas, \r\n                           viene el evento del resize canvas del mapa de 2D así que paso y no hago nada */\r\n                        if (!self.view3D._canvasClientHeight ||\r\n                            !self.view3D._canvasClientWidth ||\r\n\r\n                            width !== self.view3D._canvasClientWidth ||\r\n                            height !== self.view3D._canvasClientHeight) {\r\n\r\n                            if (!self.view3D._canvasClientWidth) {\r\n                                self.view3D._canvasClientWidth = self.view3D.viewer.scene.canvas.clientWidth;\r\n                            }\r\n\r\n                            if (!self.view3D._canvasClientHeight) {\r\n                                self.view3D._canvasClientHeight = self.view3D.viewer.scene.canvas.clientHeight;\r\n                            }\r\n\r\n                            self.view3D._canvasClientWidth = width;\r\n                            self.view3D._canvasClientHeight = height;\r\n\r\n                            return;\r\n                        }\r\n\r\n                        self.view3D.flyToMapCoordinates.call(self, self.mapView.getCenter());\r\n                    }\r\n                    break;\r\n                }\r\n                case e.type == TC.Consts.event.ZOOMTO: {\r\n\r\n                    if (self.lastZoom && performance.now() - self.lastZoom < 50) {\r\n                        return;\r\n                    }\r\n                    self.lastZoom = performance.now();\r\n\r\n                    var coordsXY = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(e.extent.slice(0, 2), self.view3D.view2DCRS, self.view3D.crs) : e.extent.slice(0, 2);\r\n                    var coordsXY2 = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(e.extent.slice(2), self.view3D.view2DCRS, self.view3D.crs) : e.extent.slice(2);\r\n                    var rectangle = Cesium.Rectangle.fromDegrees(coordsXY[0], coordsXY[1], coordsXY2[0], coordsXY2[1]);\r\n\r\n                    self.view3D.flyToRectangle.call(self, rectangle);\r\n                    break;\r\n                }\r\n            }\r\n        };\r\n\r\n        /* geolocation */\r\n        var geolocation_newPosition = function () {\r\n            var self = this;\r\n\r\n            if (!self.view3D.trackingEntity) {\r\n                var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n                var track = geolocation2D.layerTracking.features.filter(function (feature) {\r\n                    return feature.CLASSNAME == \"TC.feature.Polyline\";\r\n                });\r\n\r\n                if (track && track.length > 0) {\r\n\r\n                    var positions = [];\r\n\r\n                    var entityTracking = new Cesium.Entity({\r\n                        id: \"trackingEntity\",\r\n                        polyline: {\r\n                            positions: new Cesium.CallbackProperty(function (time, result) {\r\n                                if (track[0].geometry.length > positions.length) {\r\n                                    var newCartographicPositions = track[0].geometry.slice(positions.length).map(function (coordinate) {\r\n                                        var reprojected = coordinate;\r\n\r\n                                        if (this.view3D.view2DCRS !== this.view3D.crs) {\r\n                                            reprojected = TC.Util.reproject(coordinate, this.view3D.view2DCRS, this.view3D.crs);\r\n                                        }\r\n\r\n                                        return Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1], coordinate[2]);\r\n                                    }.bind(this));\r\n\r\n                                    var updatedPositions = [];\r\n                                    if (newCartographicPositions instanceof Array) {\r\n                                        updatedPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(newCartographicPositions);\r\n                                    } else {\r\n                                        updatedPositions = [Cesium.Ellipsoid.WGS84.cartographicToCartesian(newCartographicPositions)];\r\n                                    }\r\n\r\n                                    positions = positions.concat(updatedPositions);\r\n                                    return positions;\r\n                                }\r\n\r\n                                return positions;\r\n\r\n                            }.bind(this), false),\r\n                            clampToGround: true,\r\n                            width: 3,\r\n                            material: new Cesium.PolylineDashMaterialProperty({\r\n                                color: new Cesium.CallbackProperty(function (time, result) {\r\n                                    self.viewer.scene.requestRender();\r\n                                    return Cesium.Color.fromAlpha(new Cesium.Color(0, 255, 209), geolocation2D.track.renderTrack.checked ? 1 : 0);\r\n                                }.bind(this), false),\r\n                                gapColor: Cesium.Color.TRANSPARENT\r\n                            })\r\n                        }\r\n                    });\r\n\r\n                    self.view3D.trackingEntity = self.viewer.entities.add(entityTracking);\r\n                    self.viewer.scene.requestRender();\r\n                }\r\n            }\r\n        };\r\n        var geolocation_videoControls = function (event) {\r\n            var self = this;\r\n\r\n            var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n            switch (true) {\r\n                case geolocation2D.Const.Event.IMPORTEDTRACK.indexOf(event.type) > -1:\r\n                case event.target.className.indexOf('draw') > -1 && event.target.parentElement.classList.contains(geolocation2D.Const.Classes.SELECTEDTRACK):\r\n                case !(event.target.parentElement && event.target.parentElement.classList.contains(geolocation2D.Const.Classes.SELECTEDTRACK)):\r\n                case event.target.className.indexOf('stop') > -1:\r\n\r\n                    if (self.map.on3DView) {\r\n                        self.viewer.clock.shouldAnimate = false;\r\n                        self.viewer.clock.currentTime = Cesium.JulianDate.fromDate(new Date());\r\n                    }\r\n\r\n                    if (self.view3D.trackDataSource) {\r\n                        if (self.view3D.trackDataSource.length > 0) {\r\n                            var entity = self.view3D.trackDataSource.get(0).entities.values[0];\r\n                            self.viewer.entities.removeById(entity.id);\r\n                        }\r\n\r\n                        self.view3D.trackDataSource.destroy();\r\n                        delete self.view3D.trackDataSource;\r\n                    }\r\n\r\n                    geolocation2D.chartProgressClear();\r\n\r\n                    if (event.custom) {\r\n                        const selectedTrack = geolocation2D.getSelectedTrack();\r\n                        if (selectedTrack) {\r\n                            selectedTrack.querySelector(geolocation2D.Const.Selector.STOP).click();\r\n                        }\r\n                    }\r\n                    break;\r\n                case event.target.className.indexOf('play') > -1:\r\n                    self.viewer.clock.shouldAnimate = false;\r\n                    break;\r\n                case event.target.className.indexOf('pause') > -1:\r\n                    self.viewer.clock.shouldAnimate = true;\r\n                    break;\r\n                case event.target.className.indexOf('back') > -1:\r\n                case event.target.className.indexOf('for') > -1:\r\n                    self.viewer.clock.multiplier = geolocation2D.simulate_speed;\r\n                    break;\r\n            }\r\n        };\r\n        /* fin geolocation */\r\n\r\n        var alterAllowedControls = function (view) {\r\n            var self = this;\r\n\r\n            const ctrlsToMngCLASS = self.ctrlsToMng.map(function (ctrl) { return ctrl.CLASS });\r\n\r\n            self.map.controls.forEach(function (mapCtrl) {\r\n                if (ctrlsToMngCLASS.indexOf(mapCtrl.CLASS) < 0) {\r\n                    switch (true) {\r\n                        case (TC.Consts.view.DEFAULT == view):\r\n                            mapCtrl.enable();\r\n                            break;\r\n                        case (TC.Consts.view.THREED == view):\r\n                            mapCtrl.disable();\r\n                            break;\r\n                    }\r\n                }\r\n            });\r\n\r\n            switch (true) {\r\n                case (TC.Consts.view.DEFAULT == view):\r\n                    document.querySelectorAll('[data-no-3d]').forEach(function (elm) {\r\n                        elm.classList.remove(TC.Consts.classes.THREED_HIDDEN);\r\n                    });\r\n                    self.ctrlsToMng.forEach(function (ctl) {\r\n                        ctl.div.classList.remove(TC.Consts.classes.THREED);\r\n                    });\r\n                    break;\r\n                case (TC.Consts.view.THREED == view):\r\n                    document.querySelectorAll('[data-no-3d]').forEach(function (elm) {\r\n                        elm.classList.add(TC.Consts.classes.THREED_HIDDEN);\r\n                    });\r\n                    self.ctrlsToMng.forEach(function (ctl) {\r\n                        ctl.div.classList.add(TC.Consts.classes.THREED);\r\n                    });\r\n                    break;\r\n            }\r\n\r\n            if (TC.Consts.view.THREED === view) {\r\n\r\n                if (!self.view3D.linked2DControls.featureInfo) {\r\n                    self.view3D.linked2DControls.featureInfo = new TwoDLinkedFeatureInfo(self);\r\n                }\r\n\r\n                var eventHandler = new Cesium.ScreenSpaceEventHandler(self.viewer.canvas, false);\r\n                eventHandler.setInputAction(function (movement) {\r\n                    // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                    if (self.viewer.trackedEntity) {\r\n                        return;\r\n                    }\r\n\r\n                    const getFeatureInfo = function () {\r\n                        var ray = self.viewer.camera.getPickRay(movement.position);\r\n                        var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n                        if (position) {\r\n                            self.view3D.getInfoOnPickedPosition.call(self, position);\r\n                        }\r\n                    };\r\n\r\n                    var pickedFeature = self.viewer.scene.pick(movement.position);\r\n                    if (pickedFeature && pickedFeature.id) {\r\n                        var id = pickedFeature.id instanceof Cesium.Entity ? pickedFeature.id.name : pickedFeature.id;\r\n\r\n                        var founded = false;\r\n                        for (var layerId in self.view3D.vector2DFeatures) {\r\n                            if (self.view3D.vector2DFeatures[layerId].hasOwnProperty(id)) {\r\n                                var feature2D = self.map.workLayers.filter(function (workLayer) {\r\n                                    return workLayer.id === layerId;\r\n                                })[0].features.filter(function (feature) {\r\n                                    return id.indexOf(feature.id) > -1 && feature.showsPopup;\r\n                                });\r\n\r\n                                if (feature2D && feature2D.length > 0) {\r\n                                    founded = true;\r\n\r\n                                    if (feature2D.CLASSNAME !== \"TC.feature.Point\" && feature2D.CLASSNAME !== \"TC.feature.Marker\") {\r\n\r\n                                        var ray = self.viewer.camera.getPickRay(movement.position);\r\n                                        var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n\r\n                                        var marker = self.map.view3D.addNativeFeature.call(self.map, {\r\n                                            position: position,\r\n                                            billboard: {\r\n                                                image: TC.Util.getBackgroundUrlFromCss(self.CLASS + '-marker'),\r\n                                                eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                            }\r\n                                        });\r\n\r\n                                        const onDrawTable = function (e) {\r\n                                            if (e.control) {\r\n                                                const control = e.control;\r\n                                                const onTableClose = function (e) {\r\n                                                    if (e.control === control) {\r\n                                                        self.map.off(TC.Consts.event.RESULTSPANELCLOSE, onTableClose);\r\n                                                        self.map.view3D.removeFeature.call(self, marker);\r\n                                                    }\r\n                                                };\r\n                                                self.map.on(TC.Consts.event.RESULTSPANELCLOSE, onTableClose);\r\n                                                self.map.off(TC.Consts.event.DRAWTABLE, onDrawTable);\r\n                                            }\r\n                                        }\r\n                                        self.map.on(TC.Consts.event.DRAWTABLE, onDrawTable);\r\n                                    }\r\n\r\n                                    self.map.trigger(TC.Consts.event.FEATURECLICK, { feature: feature2D[0] });\r\n\r\n                                    break;\r\n                                }\r\n\r\n                            }\r\n                        }\r\n\r\n                        if (!founded) {\r\n                            getFeatureInfo();\r\n                        }\r\n                    } else {\r\n                        getFeatureInfo();\r\n                    }\r\n\r\n                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);\r\n            }\r\n\r\n            if (!self.view3D.linked2DControls.geolocation && self.allowedControls.indexOf(\"geolocation\") > -1) {\r\n                self.view3D.linked2DControls.geolocation = self.ctrlsToMng.filter(function (ctrl) {\r\n                    return ctrl instanceof TC.control.Geolocation;\r\n                })[0];\r\n            }\r\n\r\n            if (self.view3D.linked2DControls.geolocation) {\r\n\r\n                var geolocation2D = self.view3D.linked2DControls.geolocation;\r\n\r\n                if (TC.Consts.view.THREED === view) {\r\n\r\n                    var commands = [geolocation2D.Const.Selector.STOP,\r\n                    geolocation2D.Const.Selector.PAUSE,\r\n                    geolocation2D.Const.Selector.BACKWARD,\r\n                    geolocation2D.Const.Selector.FORWARD,\r\n                    geolocation2D.Const.Selector.DRAW];\r\n                    var geolocation_videoControls_ = geolocation_videoControls.bind(self);\r\n\r\n                    geolocation2D.reset = function () {\r\n\r\n                        TC.wrap.control.Geolocation.prototype.setTracking = geolocation2D._setTracking;\r\n                        TC.wrap.control.Geolocation.prototype.simulateTrack = geolocation2D._wrap_simulateTrack;\r\n                        TC.wrap.control.Geolocation.prototype.showElevationMarker = geolocation2D._wrap_showElevationMarker;\r\n                        TC.wrap.control.Geolocation.prototype.hideElevationMarker = geolocation2D._wrap_hideElevationMarker;\r\n\r\n                        geolocation2D.simulateTrack = geolocation2D._simulateTrack;\r\n                        geolocation2D.elevationTrack = geolocation2D._elevationTrack;\r\n\r\n                        commands.forEach(function (command) {\r\n                            $(document).off(\"click\", self.view3D.linked2DControls.geolocation._classSelector + ' ' + command, geolocation_videoControls_);\r\n                        });\r\n\r\n                        geolocation2D.off(geolocation2D.Const.Event.IMPORTEDTRACK, geolocation_videoControls_);\r\n\r\n                    };\r\n\r\n                    commands.forEach(function (command) {\r\n                        $(document).on(\"click\", self.view3D.linked2DControls.geolocation._classSelector + ' ' + command, geolocation_videoControls_);\r\n                    });\r\n\r\n                    geolocation2D.on(geolocation2D.Const.Event.IMPORTEDTRACK, geolocation_videoControls_);\r\n\r\n                    var that = self;\r\n                    /* provisional hasta el refactoring del panel de resultados */\r\n                    var _newPosition = false;\r\n                    geolocation2D._setTracking = TC.wrap.control.Geolocation.prototype.setTracking;\r\n                    TC.wrap.control.Geolocation.prototype.setTracking = function (tracking) {\r\n\r\n                        geolocation2D._setTracking.call(geolocation2D.wrap, tracking);\r\n\r\n                        if (tracking) {\r\n                            geolocation2D.on(geolocation2D.Const.Event.POSITIONCHANGE, geolocation_newPosition.bind(self));\r\n                        } else {\r\n                            _newPosition = false;\r\n                            geolocation2D.off(geolocation2D.Const.Event.POSITIONCHANGE, geolocation_newPosition.bind(self));\r\n                            if (self.view3D.trackingEntity) {\r\n                                self.viewer.entities.removeById(self.view3D.trackingEntity.id);\r\n                                delete self.view3D.trackingEntity;\r\n                            }\r\n                        }\r\n                    };\r\n\r\n                    geolocation2D._elevationTrack = geolocation2D.elevationTrack;\r\n                    geolocation2D.elevationTrack = function (li, resized) {\r\n\r\n                        if (resized) {\r\n                            geolocation_videoControls.call(self, { target: { className: 'stop' }, custom: true });\r\n                        }\r\n\r\n                        geolocation2D._elevationTrack.call(geolocation2D, li, resized);\r\n                    };\r\n\r\n                    // Si en el paso de 2D a 3D hay perfil dibujado, lanzamos el resize\r\n                    const selectedTrack = geolocation2D.getSelectedTrack();\r\n                    if (selectedTrack && geolocation2D.hasElevation) {\r\n                        geolocation2D.elevationTrack.call(self, selectedTrack, true);\r\n                    }\r\n\r\n                    var simulationOnPreUpdate; // listener de la simulación.\r\n                    geolocation2D._simulateTrack = geolocation2D.simulateTrack;\r\n                    geolocation2D.simulateTrack = function (li) {\r\n                        var self = this.view3D.linked2DControls.geolocation;\r\n\r\n                        self.map.toast(self.getLocaleString('threed.interactionSimulation'), { type: TC.Consts.msgType.INFO });\r\n\r\n                        // tenemos una simulación activa\r\n                        if (this.viewer.clock.shouldAnimate && this.view3D.trackDataSource) {\r\n                            simulationOnPreUpdate();\r\n                            geolocation_videoControls.call(this, { target: { className: 'stop' }, custom: true });\r\n                        }\r\n\r\n                        self.simulate_speed = 1;\r\n                        self.drawTrack(li, false).then(function () {\r\n                            self.wrap.simulateTrack();\r\n\r\n                            if (self.layerTrack && self.layerTrack.features) {\r\n                                var track = self.layerTrack.features.filter(function (feature) {\r\n                                    return feature.CLASSNAME == \"TC.feature.Polyline\";\r\n                                })[0];\r\n\r\n                                if (track) {\r\n                                    toCZML.call(this, track.geometry, track.wrap.feature.getGeometry().layout, \"track\", self.markerStyle, self.lineStyle, self.walkingSpeed).then(function (result) {\r\n                                        var czml = result.czml, totalDistance = result.totalDistance, coordinates2D = result.coordinates2D;\r\n\r\n                                        this.view3D.trackDataSource = new Cesium.DataSourceCollection();\r\n                                        var dataSourceDisplay = new Cesium.DataSourceDisplay({\r\n                                            scene: this.viewer.scene,\r\n                                            dataSourceCollection: this.view3D.trackDataSource\r\n                                        });\r\n\r\n                                        this.viewer.scene.preRender.addEventListener(function (scene, time) {\r\n                                            dataSourceDisplay.update(time);\r\n                                        });\r\n\r\n                                        this.view3D.trackDataSource.add(Cesium.CzmlDataSource.load(czml)).then(function (layout, coordinates2D, czmlDataSource) {\r\n\r\n                                            this.viewer.clock.shouldAnimate = false;\r\n\r\n                                            var start, stop;\r\n                                            start = czmlDataSource.clock.startTime;\r\n                                            stop = czmlDataSource.clock.stopTime;\r\n\r\n                                            this.viewer.clock.startTime = start.clone();\r\n                                            this.viewer.clock.stopTime = stop.clone();\r\n                                            this.viewer.clock.currentTime = start.clone();\r\n                                            this.viewer.clock.clockStep = Cesium.ClockStep.TICK_DEPENDENT\r\n                                            this.viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;\r\n                                            this.viewer.clock.multiplier = 1;\r\n\r\n                                            var trackEntity = czmlDataSource.entities.values[0];\r\n\r\n                                            trackEntity.layout = layout;\r\n\r\n                                            trackEntity.tagLI = li; // tengo que guardar la relación con el HTML porque puede eliminar la selección del track mientras estamos creando la simulación del mismo, y no tengo forma de validarlo\r\n\r\n                                            trackEntity.availability = new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({\r\n                                                start: start,\r\n                                                stop: stop\r\n                                            })]);\r\n\r\n                                            if (this.viewer.trackedEntity) {\r\n                                                this.viewer.entities.removeById(this.viewer.trackedEntity.id);\r\n                                                this.viewer.trackedEntity = null;\r\n                                            }\r\n\r\n                                            this.viewer.entities.add(trackEntity);\r\n\r\n                                            this.viewer.flyTo(trackEntity).then(function () {\r\n\r\n                                                this.viewer.trackedEntity = trackEntity;\r\n\r\n                                                function get2DHeightAtProgress(coordinates2D, distanceCurrent) {\r\n                                                    var coordinate;\r\n\r\n                                                    var doneDistance = 0;\r\n\r\n                                                    var reprojected = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coordinates2D[0], this.view3D.view2DCRS, this.view3D.crs) : coordinates2D[0];\r\n                                                    var previous = new Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n\r\n                                                    for (var i = 1; i < coordinates2D.length; i++) {\r\n                                                        reprojected = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coordinates2D[i], this.view3D.view2DCRS, this.view3D.crs) : coordinates2D[i];\r\n                                                        var current = new Cesium.Cartographic.fromDegrees(reprojected[0], reprojected[1]);\r\n\r\n                                                        doneDistance += new Cesium.EllipsoidGeodesic(previous, current).surfaceDistance;\r\n                                                        previous = current;\r\n\r\n                                                        if (doneDistance > distanceCurrent) {\r\n                                                            coordinate = coordinates2D[i - 1];\r\n                                                            break;\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    if (coordinate) {\r\n                                                        var heightIndex = trackEntity.layout === ol.geom.GeometryLayout.XYZM ? 2 :\r\n                                                            trackEntity.layout === ol.geom.GeometryLayout.XYZ ? 2 : -1;\r\n                                                        if (heightIndex > -1) {\r\n                                                            return coordinate[heightIndex];\r\n                                                        }\r\n                                                    }\r\n\r\n                                                    return 0;\r\n                                                };\r\n\r\n                                                var previousPosition, distanceCurrent = 0;\r\n                                                simulationOnPreUpdate = this.viewer.scene.preUpdate.addEventListener(function (scene, currentTime) {\r\n\r\n                                                    // mientras estamos preparando la simulación ha eliminado la selección de dicho track \r\n                                                    const selectedTrack = this.view3D.linked2DControls.geolocation.getSelectedTrack();\r\n                                                    if (!selectedTrack || selectedTrack.getAttribute('data-id') !== trackEntity.tagLI.getAttribute('data-id') ||\r\n                                                        // o hemos llegado al final\r\n                                                        Cesium.JulianDate.greaterThanOrEquals(currentTime, trackEntity.availability.stop)) {\r\n\r\n                                                        simulationOnPreUpdate();\r\n                                                        geolocation_videoControls.call(this, { target: { className: 'stop' }, custom: true });\r\n\r\n                                                    } else if (this.viewer.clock.shouldAnimate && trackEntity.isAvailable(currentTime)) {\r\n\r\n                                                        // gestionamos las posiciones anterior y actual\r\n                                                        if (!previousPosition) {\r\n                                                            previousPosition = Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(trackEntity.position, trackEntity.availability.start));\r\n                                                        }\r\n                                                        currentPosition = Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(trackEntity.position, currentTime));\r\n\r\n                                                        // progreso en el perfil (si lo hay)\r\n                                                        if (this.view3D.linked2DControls.geolocation.hasElevation) {\r\n                                                            var timeIndex = trackEntity.layout === ol.geom.GeometryLayout.XYZM ? 3 :\r\n                                                                trackEntity.layout === ol.geom.GeometryLayout.XYM ? 2 : 3;\r\n\r\n                                                            this.view3D.linked2DControls.geolocation.chartSetProgress({\r\n                                                                p: [previousPosition.longitude, previousPosition.latitude, previousPosition.height],\r\n                                                                d: distanceCurrent\r\n                                                            },\r\n                                                                [currentPosition.longitude, currentPosition.latitude, get2DHeightAtProgress.call(this, coordinates2D, distanceCurrent)],\r\n                                                                totalDistance, (trackEntity.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                                                    trackEntity.layout === ol.geom.GeometryLayout.XYM ?\r\n                                                                    this.view3D.linked2DControls.geolocation._getTime(Cesium.JulianDate.toDate(trackEntity.availability.start), Cesium.JulianDate.toDate(currentTime)) : false));\r\n                                                        }\r\n\r\n                                                        // gestionamos las posiciones anterior y actual y la distancia\r\n                                                        distanceCurrent += new Cesium.EllipsoidGeodesic(previousPosition, currentPosition).surfaceDistance;\r\n                                                        previousPosition = currentPosition;\r\n\r\n                                                        this.viewer.scene.requestRender();\r\n                                                    }\r\n                                                }.bind(this));\r\n\r\n                                                this.viewer.clock.shouldAnimate = true;\r\n\r\n                                            }.bind(this));\r\n\r\n                                            //self.view3D.customRender.restart();\r\n                                            this.viewer.scene.requestRender();\r\n\r\n                                        }.bind(this, track.wrap.feature.getGeometry().layout, coordinates2D));\r\n                                    }.bind(this));\r\n                                }\r\n                            }\r\n                        }.bind(this));\r\n\r\n                    }.bind(self);\r\n\r\n                    geolocation2D._wrap_simulateTrack = TC.wrap.control.Geolocation.prototype.simulateTrack;\r\n                    TC.wrap.control.Geolocation.prototype.simulateTrack = function () {\r\n                        var self = this;\r\n\r\n                        //if (self.parent.hasElevation) {\r\n                        //    self.parent.chartProgressInit();\r\n                        //}\r\n                    };\r\n\r\n                    geolocation2D._wrap_showElevationMarker = TC.wrap.control.Geolocation.prototype.showElevationMarker;\r\n                    TC.wrap.control.Geolocation.prototype.showElevationMarker = function (data) {\r\n                        const self = this.view3D.linked2DControls.geolocation;\r\n                        const coords = self.chart.coordinates;\r\n\r\n                        // GLS: si la capa del track está visible mostramos marcamos punto del gráfico en el mapa\r\n                        if (self.layerTrack.getVisibility() && self.layerTrack.getOpacity() > 0) {\r\n\r\n                            var camera = this.viewer.camera;\r\n                            var elevationMarkerPosition = this.view3D.view2DCRS !== this.view3D.crs ? TC.Util.reproject(coords[data[0].index], this.view3D.view2DCRS, this.view3D.crs) : coords[data[0].index];\r\n\r\n                            if (!self.elevationMarker) {\r\n\r\n                                var billboard = new Cesium.Entity({\r\n                                    position: Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1]),\r\n                                    name: 'elevationMarker',\r\n                                    billboard: {\r\n                                        image: \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AcdDDMq7Am38gAAAaFJREFUWMPtlj9rwkAYh3+R0lgKRSi4FCFmczBzp2i+gaMgmK0I3Tq0Y6HDDd0L0tJBSyGbAT9AxI+goFskumUUrDq9XVRi6WkS/xXquyRc7nie++XuOOBYx/rvJYQdqKoqNE1barMsC81mc/cCqqri+eWVfvt2f3sjBJE4CSMwn/kkXVpqj7bL0DQtUAqRTf9hhixkyAo9PnLoRbhWQNd1KIoSGqAoysrxkXXwh8cnMsw6McYCwxljMMw6GWadeBIrBSRJwnA0hivryOULgSQYY8jlC+TKOoajMWKx2Ga7wJV15OwKARCm06lv+FYX4TwJURS5fURR9A0PJBC3q0sSvH5eeLRd3t5BlEomALsKVy6CN7tJuoSJR3g4+tpeAt3eAKlkYpHEurRSycTmArVaDRfnZ7Poi74k5vBub4DT6zsAwFX8Eo7jBBdotVowjU8hbld8SXjhrlyctVXw8f4m8AR87+mO7VADWWogSx27T0S0eHrfO3bf088JdYAFkvDWzuB+JHYOXyWxNzhPYq9wfhJ7hP+UOAjc74XjWH++vgFLJ1bBWXZtUAAAAABJRU5ErkJggg==\",\r\n                                        eyeOffset: new Cesium.Cartesian3(0, 0, -100),\r\n                                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\r\n                                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND\r\n                                    }\r\n                                });\r\n\r\n                                self.elevationMarker = this.view3D.addNativeFeature.call(this, billboard);\r\n                            } else {\r\n                                self.elevationMarker.position = Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1], camera.positionCartographic.height);\r\n                                this.viewer.scene.requestRender();\r\n                            }\r\n\r\n                            // No ubicar la camara en el marker\r\n                            //var rectangle = camera.computeViewRectangle();\r\n                            //if (elevationMarkerPosition[0] >= rectangle.west && elevationMarkerPosition[0] <= rectangle.east && elevationMarkerPosition[1] >= rectangle.south && elevationMarkerPosition[1] <= rectangle.north) { }\r\n                            //else {\r\n                            //    var distance = Cesium.Cartesian3.distance(camera.position, Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1]));\r\n                            //    camera.setView({\r\n                            //        destination: Cesium.Cartesian3.fromDegrees(elevationMarkerPosition[0], elevationMarkerPosition[1])\r\n                            //    });\r\n\r\n                            //    camera.moveBackward(distance);\r\n                            //}\r\n                        }\r\n                    }.bind(self);\r\n\r\n                    geolocation2D._wrap_hideElevationMarker = TC.wrap.control.Geolocation.prototype.hideElevationMarker;\r\n                    TC.wrap.control.Geolocation.prototype.hideElevationMarker = function () {\r\n                        const self = this.view3D.linked2DControls.geolocation;\r\n\r\n                        this.view3D.removeFeature.call(this, self.elevationMarker);\r\n                        self.elevationMarker = null;\r\n                    }.bind(self);\r\n\r\n\r\n\r\n                } else {\r\n                    // Si en el paso de 3D a 2D hay perfil dibujado, lanzamos el resize\r\n                    const selectedTrack = self.view3D.linked2DControls.geolocation.getSelectedTrack();\r\n                    if (selectedTrack && self.view3D.linked2DControls.geolocation.hasElevation) {\r\n\r\n                        geolocation2D._elevationTrack.call(self.view3D.linked2DControls.geolocation, selectedTrack, true);\r\n                    }\r\n                }\r\n            }\r\n\r\n        };\r\n\r\n        var draw2DDrawedFeatures = function () {\r\n            var self = this;\r\n\r\n            self.map.workLayers.filter(function (layer) {\r\n                return layer instanceof TC.layer.Vector;\r\n            }).forEach(function (vectorLayer) {\r\n                vectorLayer.features.forEach(function (feature) {\r\n                    self.view3D.addFeature.call(self.view3D, feature);\r\n                });\r\n            });\r\n        };\r\n\r\n        var initialExtent, zoomin, zoomout;\r\n        var override2DZoom = function (activate) {\r\n            var self = this;\r\n\r\n            var amount = 200.0;           \r\n\r\n            var zoom = function (amount) {\r\n                var self = this;\r\n\r\n                var center = new Cesium.Cartesian2(\r\n                    self.viewer.scene.canvas.clientWidth / 2,\r\n                    self.viewer.scene.canvas.clientHeight / 2);\r\n\r\n                /*\r\n                var x = center.x;\r\n                var y = center.y;\r\n                var event = new window.WheelEvent (\"wheel\", {deltaY: -100,\r\n                    deltaMode: 0,\r\n                    DOM_DELTA_PIXEL: 0,\r\n                    DOM_DELTA_LINE: 1,\r\n                    detail: 0,\r\n                    wheelDelta: 120,\r\n                    layerX: x, layerY: y,\r\n                    clientX: x, clientY: y,\r\n                    offsetX: x, offsetY: y,\r\n                    pageX: x, pageY: y,\r\n                    screenX: x, screenY: y\r\n                });\r\n                self.viewer.scene.canvas.dispatchEvent(event);*/\r\n\r\n                self.view3D.zoomToCartesian.call(self, { endPosition: center }, amount);\r\n            };\r\n\r\n            if (activate) {\r\n                initialExtent = function (e) {\r\n                    var self = this;\r\n\r\n                    if (e.stopPropagation) e.stopPropagation();\r\n                    if (e.preventDefault) e.preventDefault();\r\n\r\n                    var sourceCRS = self.view3D.view2DCRS;\r\n                    if (self.map.options.crs !== self.view3D.view2DCRS) {\r\n                        sourceCRS = self.map.options.crs;\r\n                    }\r\n\r\n                    var coordsXY = TC.Util.reproject(self.map.options.initialExtent.slice(0, 2), sourceCRS, self.view3D.crs);\r\n                    var coordsXY2 = TC.Util.reproject(self.map.options.initialExtent.slice(2), sourceCRS, self.view3D.crs);\r\n                    var rectangle = Cesium.Rectangle.fromDegrees(coordsXY[0], coordsXY[1], coordsXY2[0], coordsXY2[1]);\r\n\r\n                    self.view3D.flyToRectangle.call(self, rectangle, { duration: 0.1 });\r\n\r\n                    return false;\r\n\r\n                }.bind(self);\r\n\r\n                zoomin = function (e) {\r\n                    zoom.call(self, amount);\r\n                }.bind(self);\r\n\r\n                zoomout = function (e) {\r\n                    zoom.call(self, -amount);\r\n                }.bind(self);\r\n\r\n                document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn').forEach(function (button) {\r\n                    button.addEventListener('click', initialExtent);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomin').forEach(function (button) {\r\n                    button.addEventListener('click', zoomin);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomout').forEach(function (button) {\r\n                    button.addEventListener('click', zoomout);\r\n                });\r\n            }\r\n            else {\r\n                document.querySelectorAll('.' + TC.control.NavBarHome.prototype.CLASS + '-btn').forEach(function (button) {\r\n                    button.removeEventListener('click', initialExtent);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomin').forEach(function (button) {\r\n                    button.removeEventListener('click', zoomin);\r\n                });\r\n                document.querySelectorAll('.' + TC.control.NavBar.prototype.CLASS + '-btn-zoomout').forEach(function (button) {\r\n                    button.removeEventListener('click', zoomout);\r\n                });\r\n            }\r\n        };\r\n\r\n        const fromTCtoCesiumEvent = function (eventTC) {\r\n            if (TC.Consts.event.MOUSEMOVE === eventTC) {\r\n                return TC.Util.detectMobile() ? Cesium.ScreenSpaceEventType.LEFT_CLICK : Cesium.ScreenSpaceEventType.MOUSE_MOVE;\r\n            } else if (TC.Consts.event.CLICK === eventTC) {\r\n                return Cesium.ScreenSpaceEventType.LEFT_CLICK;\r\n            }\r\n\r\n            return eventTC;\r\n        };\r\n\r\n        return {\r\n\r\n            container: null,\r\n\r\n            crs: 'EPSG:4326',\r\n            crsPattern: /(EPSG\\:?4326)/i,\r\n\r\n            view2DCRS: null,\r\n\r\n            customRender: null,\r\n\r\n            baseLayer: null,\r\n\r\n            workLayers: [],\r\n            vector2DLayers: [],\r\n            vector2DFeatures: {\r\n            },\r\n\r\n            linked2DControls: {\r\n            },\r\n\r\n            isLoadingTiles: function () {\r\n                var self = this;\r\n\r\n                var surface = self.viewer.scene.globe['_surface'];\r\n                return !surface['_tileProvider'].ready ||\r\n                    surface['_tileLoadQueueHigh'].length > 0 ||\r\n                    surface['_tileLoadQueueMedium'].length > 0 ||\r\n                    surface['_tileLoadQueueLow'].length > 0 ||\r\n                    surface['_debug']['tilesWaitingForChildren'] > 0;\r\n            },\r\n\r\n            loadViewer: function () {\r\n                const self = this;\r\n                return new Promise(function (resolve, reject) {\r\n                    if (!self.viewer) {\r\n\r\n                        TC.loadJS(!window.Cesium, TC.Consts.url.CESIUM, function () {\r\n\r\n                            var resourceBoundaries = Cesium.Resource.fetchJson({ url: TC.apiLocation + \"/dataSource/contornoNavarra.json\" }).then(function (bounds) {\r\n                                if (bounds && bounds.features && bounds.features.length > 0) {\r\n                                    return bounds.features[0].geometry.coordinates[0];\r\n                                } else {\r\n                                    return [];\r\n                                }\r\n                            });\r\n\r\n                            Cesium.when.all([Cesium.ApproximateTerrainHeights.initialize(), resourceBoundaries], function () {\r\n\r\n                                var boundaries = Array.prototype.slice.call(arguments[0])[1];\r\n\r\n                                var terrainFallback;\r\n                                if (self.terrainFallback) {\r\n                                    terrainFallback = {\r\n                                        url: self.terrainFallback.url.trim(),\r\n                                        layerName: self.terrainFallback.layerName,\r\n                                        format: self.terrainFallback.format,\r\n                                        noDataValue: self.terrainFallback.noDataValue\r\n                                    };\r\n                                }\r\n\r\n                                var terrainProvider;\r\n                                if (terrainFallback) {\r\n                                    terrainProvider = new Cesium.MergeTerrainProvider(self.terrain, self, {\r\n                                        boundaries: boundaries,\r\n                                        fallback: [terrainFallback]\r\n                                    });\r\n                                } else {\r\n                                    terrainProvider = new Cesium.CesiumTerrainProvider({\r\n                                        url: self.terrain.url.trim()\r\n                                    });\r\n\r\n                                    terrainProvider.sampleTerrainMostDetailed = function (positions) {\r\n                                        return Cesium.sampleTerrainMostDetailed(terrainProvider, positions);\r\n                                    };\r\n\r\n                                    terrainProvider.attributions = {\r\n                                    };\r\n\r\n                                    if (self.terrain.attributions) {\r\n\r\n                                        terrainProvider.getAttribution = function () {\r\n                                            return terrainProvider.attributions;\r\n                                        };\r\n\r\n                                        terrainProvider.attributions = self.terrain.attributions;\r\n                                        self.map.trigger(TC.Consts.event.TERRAINPROVIDERADD, { terrainProvider: terrainProvider });\r\n                                    }\r\n                                }\r\n\r\n                                var globe = new Cesium.Globe();\r\n                                globe.baseColor = Cesium.Color.WHITE;\r\n                                globe.enableLighting = false;\r\n\r\n                                /* carga más rápido pero consume RAM a cascoporro */\r\n                                globe.tileCacheSize = 1000;\r\n\r\n                                /* por defecto 2, a mayor número mayor rendimiento y peor calidad visual */\r\n                                globe.maximumScreenSpaceError = 5;\r\n\r\n                                self.viewer = self.view3D.viewer = new Cesium.Viewer(self.selectors.divThreedMap, {\r\n                                    terrainProvider: terrainProvider,\r\n                                    terrainExaggeration: 1.0,\r\n\r\n                                    animation: false,\r\n                                    timeline: false,\r\n                                    fullscreenButton: false,\r\n                                    baseLayerPicker: false,\r\n                                    imageryProvider: false,\r\n                                    navigationInstructionsInitiallyVisible: false,\r\n                                    navigationHelpButton: false,\r\n                                    geocoder: false,\r\n                                    homeButton: false,\r\n                                    infoBox: false,\r\n                                    sceneModePicker: false,\r\n                                    selectionIndicator: false,\r\n                                    globe: globe,\r\n\r\n                                    skyBox: false,\r\n                                    skyAtmosphere: false,\r\n\r\n                                    requestRenderMode: true,\r\n                                    maximumRenderTimeChange: Infinity\r\n                                });\r\n\r\n                                // personalización de la escena\r\n                                self.viewer.scene.backgroundColor = Cesium.Color.WHITE;\r\n                                self.viewer.scene.screenSpaceCameraController.enableCollisionDetection = true;\r\n                                self.viewer.scene.screenSpaceCameraController.maximumZoomDistance = 1000000;\r\n\r\n                                //// con false las líneas se manetienen sobre el terreno\r\n                                //self.viewer.scene.globe.depthTestAgainstTerrain = false;\r\n\r\n                                // borramos cualquier capa que haya\r\n                                self.viewer.scene.imageryLayers.removeAll();\r\n\r\n                                // registramos listeners para capturar errores del terreno y del render\r\n                                self.viewer.terrainProvider.errorEvent.addEventListener(function (e) {\r\n                                    var self = this;\r\n                                    if (e.error) {\r\n                                        switch (e.error.statusCode) {\r\n                                            case 403:\r\n                                            case 404:\r\n                                                console.log('es un 404 de terreno');\r\n                                                break;\r\n                                        }\r\n                                    }\r\n                                }, self);\r\n                                self.viewer.scene.renderError.addEventListener(function (target, error) {\r\n                                    var self = this;\r\n\r\n                                    if (error && error.code === 18) { // GLS: 18 - SECURITY_ERR                              \r\n\r\n                                    } else {\r\n                                        self.divThreedMap.classList.remove(self.classes.LOADING);\r\n                                        self.map.toast(self.getLocaleString(\"fi.error\"), { type: TC.Consts.msgType.ERROR });\r\n\r\n                                        self.unapply();\r\n                                    }\r\n                                }, self);\r\n\r\n                                self.viewer.readyPromise = new Promise(function (resolve, reject) {\r\n\r\n                                    // controlamos la carga de tiles para mostrar loading cuando pida tiles\r\n                                    self.view3D.tileLoadingHandler = new Cesium.EventHelper();\r\n                                    self.view3D.tileLoadingHandler.add(self.viewer.scene.globe.tileLoadProgressEvent, function (data) {\r\n                                        if (!self.waiting)\r\n                                            self.waiting = self.map.getLoadingIndicator().addWait();\r\n\r\n                                        if ((self.viewer.scene.terrainProvider.allReady ||\r\n                                            (!self.viewer.scene.terrainProvider.allReady && self.viewer.scene.terrainProvider.ready))\r\n                                            && data === 0) {\r\n                                            self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                                            delete self.waiting;\r\n\r\n                                            resolve();\r\n\r\n                                            self.events.trigger(TC.Consts.event.TERRAINLOADED, {});\r\n                                        } else {\r\n                                            self.events.trigger(TC.Consts.event.TERRAINRECEIVING, {});\r\n                                        }\r\n                                    }.bind(self));\r\n                                });\r\n\r\n                                // deshabilitamos el zoom por defecto y manejamos nosotros zoom con rueda\r\n                                //overrideDesktopZoom.call(self);\r\n                                // sobrescribimos el comportamiento de lo botones + /- y la casita\r\n                                override2DZoom.call(self, true);\r\n\r\n                                // eliminamos los creditos de cesium (no encuentro la manera de que no los ponga)\r\n                                document.querySelectorAll('.cesium-viewer-bottom').forEach(function (elm) {\r\n                                    elm.parentElement.removeChild(elm);\r\n                                });\r\n\r\n                                // enlazamos con los eventos del mapa 2D\r\n                                self.view3D._event2DHandler = event2DHandler.bind(self);\r\n                                self.map.on(listenTo.join(' '), self.view3D._event2DHandler);\r\n\r\n                                // modificamos los controles disponibles\r\n                                alterAllowedControls.call(self, TC.Consts.view.THREED);\r\n\r\n                                self.viewer.readyPromise.then(function () {\r\n                                    // pintamos las features que están en el mapa 2D\r\n                                    draw2DDrawedFeatures.call(self);\r\n                                });\r\n\r\n                                resolve(self.viewer);\r\n\r\n                            });\r\n\r\n                        });\r\n\r\n                    } else {\r\n                        resolve(self.viewer);\r\n                    }\r\n                });\r\n            },\r\n\r\n            setBaseLayer: function (layer) {\r\n                var self = this;\r\n\r\n                var get3DLayer = function (layer) {\r\n                    if (!isCompatible(layer, self.view3D.crs)) {\r\n                        if (layer.getFallbackLayer() !== null && isCompatible(layer.getFallbackLayer(), self.view3D.crs)) {\r\n                            layer = layer.getFallbackLayer();\r\n                        } else {\r\n                            self.map.toast(self.getLocaleString('threed.crsNoCompatible', { name: layer.title }));\r\n                            layer = null;\r\n                        }\r\n                    }\r\n\r\n                    return layer;\r\n                };\r\n\r\n                if (!self.view3D.baseLayer) {\r\n\r\n                    if (layer.type === TC.Consts.layerType.WMTS || layer.type === TC.Consts.layerType.WMS) {\r\n\r\n                        if (layer.options.relatedWMTS) {\r\n                            self.map.baseLayer = layer = self.map.getLayer(layer.options.relatedWMTS);\r\n                            self.map.trigger(TC.Consts.event.BASELAYERCHANGE, { layer: self.map.baseLayer });\r\n                        } else {\r\n\r\n                            layer = get3DLayer(layer);\r\n\r\n                            if (layer) {\r\n                                if (!layer.isBase) {\r\n                                    layer.isBase = true;\r\n                                }\r\n                                self.view3D.addLayer.call(self, layer);\r\n                            }\r\n                        }\r\n                    }\r\n                    else {\r\n                        self.view3D.baseLayer = self.Consts.BLANK_BASE;\r\n                    }\r\n                } else {\r\n\r\n                    if (self.viewer.scene.imageryLayers.contains(self.view3D.baseLayer)) {\r\n                        self.viewer.scene.imageryLayers.raiseToTop(self.view3D.baseLayer);\r\n                        self.viewer.scene.imageryLayers.remove(self.view3D.baseLayer, true);\r\n                    }\r\n\r\n                    if (layer instanceof TC.layer.Vector) {\r\n                        self.view3D.baseLayer = self.Consts.BLANK_BASE;\r\n\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    }\r\n                    else {\r\n                        layer = get3DLayer(layer);\r\n\r\n                        if (layer) {\r\n                            layer.map = self.map;\r\n                            layer.isBase = true;\r\n\r\n                            self.view3D.addLayer.call(self, layer);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                currentMapCfg.baseMap = self.map.baseLayer;\r\n            },\r\n\r\n            addLayer: function (layer) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n                        self.view3D.vector2DLayers.push(layer);\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        if (!layer.isBase && !layer.isCompatible(self.view3D.crs)) {\r\n                            self.map.toast(self.getLocaleString('threed.crsNoCompatible', { name: layer.layerNames }));\r\n                        } else {\r\n                            //var convertedLayer = rasterConverter.convert(layer, self.view3D.crs);\r\n                            rasterConverter.convert(layer, self.view3D.crs).then(function (convertedLayer) {\r\n                                if (convertedLayer) {\r\n\r\n                                    if (convertedLayer[\"enablePickFeatures\"] !== undefined) {\r\n                                        convertedLayer.enablePickFeatures = false;\r\n                                        convertedLayer[\"tcLayer\"] = layer;\r\n                                    }\r\n\r\n                                    if (layer.isBase && self.view3D.baseLayer) {\r\n                                        if (self.viewer.scene.imageryLayers.contains(self.view3D.baseLayer)) {\r\n                                            self.viewer.scene.imageryLayers.raiseToTop(self.view3D.baseLayer);\r\n                                            self.viewer.scene.imageryLayers.remove(self.view3D.baseLayer, true);\r\n                                        }\r\n                                    }\r\n\r\n                                    var newImageryLayer = self.viewer.scene.imageryLayers.addImageryProvider(convertedLayer);\r\n\r\n                                    if (layer.isBase) { // si la capa es el mapa de fondo lo envío al fondo de las capas en 3D\r\n                                        self.view3D.baseLayer = newImageryLayer;\r\n                                        self.viewer.scene.imageryLayers.lowerToBottom(newImageryLayer);\r\n                                    } else {\r\n                                        newImageryLayer.show = layer.getVisibility();\r\n                                        newImageryLayer.alpha = layer.getOpacity();\r\n\r\n                                        self.view3D.workLayers.push(newImageryLayer);\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n                        break;\r\n                    }\r\n                }\r\n            },\r\n            removeLayer: function (layer) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n\r\n                        if (self.view3D.vector2DFeatures && self.view3D.vector2DFeatures.hasOwnProperty(layer.id)) {\r\n\r\n                            for (var featureId in self.view3D.vector2DFeatures[layer.id]) {\r\n                                var threedFeature = self.view3D.vector2DFeatures[layer.id][featureId];\r\n\r\n                                for (var i = 0; i < threedFeature.length; i++) {\r\n                                    self.view3D.removeFeature.call(self, threedFeature[i]);\r\n                                }\r\n                            }\r\n\r\n                            delete self.view3D.vector2DFeatures[layer.id];\r\n                        }\r\n\r\n                        // GLS revisar, debería estar en workLayers¿? \r\n                        // self.view3D.workLayers.splice(i, 1);\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                            if (layer.names && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.names.join(',') ||\r\n                                layer.title && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.title) {\r\n                                self.viewer.scene.imageryLayers.raiseToTop(self.view3D.workLayers[i]);\r\n                                self.viewer.scene.imageryLayers.remove(self.view3D.workLayers[i], true);\r\n\r\n                                self.view3D.workLayers.splice(i, 1);\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            setRenderOptionsLayer: function (layer, options) {\r\n                var self = this;\r\n\r\n                switch (true) {\r\n                    case TC.Consts.layerType.VECTOR == layer.type: {\r\n                        if (self.view3D.vector2DFeatures[layer.id]) {\r\n\r\n                            for (var featureId in self.view3D.vector2DFeatures[layer.id]) {\r\n                                var features = self.view3D.vector2DFeatures[layer.id][featureId];\r\n                                for (var i = 0; i < features.length; i++) {\r\n                                    self.view3D.setRenderOptionsFeature(features[i], { show: layer.getVisibility() });\r\n                                }\r\n                            }\r\n\r\n                            self.viewer.scene.requestRender();\r\n                        }\r\n                        break;\r\n                    }\r\n                    case TC.Consts.layerType.WMTS == layer.type:\r\n                    case TC.Consts.layerType.WMS == layer.type: {\r\n                        for (var i = 0; i < self.view3D.workLayers.length; i++) {\r\n                            if (layer.names && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.names.join(',') ||\r\n                                layer.title && self.view3D.workLayers[i].imageryProvider.layers.join(',') === layer.title) {\r\n\r\n                                if (options.hasOwnProperty('visibility')) {\r\n                                    self.view3D.workLayers[i].show = options.visibility;\r\n                                }\r\n\r\n                                if (options.hasOwnProperty('opacity')) {\r\n                                    self.view3D.workLayers[i].alpha = options.opacity;\r\n                                }\r\n                                break;\r\n                            }\r\n                        }\r\n\r\n                        self.viewer.scene.requestRender();\r\n                    }\r\n                }\r\n            },\r\n\r\n            flyToMapCoordinates: function (coords) {\r\n                var self = this;\r\n\r\n                var lonlat = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(coords, self.view3D.view2DCRS, self.view3D.crs) : coords;\r\n                var destination = Cesium.Cartesian3.fromDegrees(lonlat[0], lonlat[1], self.viewer.camera.positionCartographic.height);\r\n\r\n                var camera = self.viewer.camera;\r\n                camera.flyTo({\r\n                    destination: destination,\r\n                    orientation: {\r\n                        heading: camera.heading,\r\n                        pitch: camera.pitch\r\n                    }\r\n                });\r\n            }.bind(viewProto),\r\n            flyToRectangle: function (rectangle, options) {\r\n                const self = this;\r\n                // lo primero de todo cancelar movimientos anteriores\r\n                self.viewer.scene.camera.cancelFlight();\r\n\r\n                return new Promise(function (resolve, reject) {\r\n                    options = options || {\r\n                    };\r\n\r\n                    var epsilon = Cesium.Math.EPSILON3;\r\n                    if (rectangle.east === rectangle.west) {\r\n                        rectangle.east += epsilon;\r\n                        rectangle.west -= epsilon;\r\n                    }\r\n\r\n                    if (rectangle.north === rectangle.south) {\r\n                        rectangle.north += epsilon;\r\n                        rectangle.south -= epsilon;\r\n                    }\r\n\r\n                    var enlargeFactor = 0.2;\r\n                    var marginX = rectangle.width * enlargeFactor / 2;\r\n                    var marginY = rectangle.height * enlargeFactor / 2;\r\n                    rectangle.east -= marginX;\r\n                    rectangle.west += marginY;\r\n                    rectangle.north += marginY;\r\n                    rectangle.south -= marginY;\r\n\r\n                    var scene = self.viewer.scene;\r\n                    var camera = scene.camera;\r\n\r\n                    var destinationCartesian = camera.getRectangleCameraCoordinates(rectangle);\r\n                    var destination = Cesium.Ellipsoid.WGS84.cartesianToCartographic(destinationCartesian);\r\n\r\n                    Cesium.when(scene.globe.terrainProvider.sampleTerrainMostDetailed([Cesium.Rectangle.center(rectangle)]), function (updatedPositions) {\r\n\r\n                        var finalDestinationCartographic = {\r\n                            longitude: destination.longitude,\r\n                            latitude: destination.latitude,\r\n                            height: destination.height + updatedPositions[0].height || 0\r\n                        };\r\n\r\n                        camera.flyTo({\r\n                            duration: options.duration || 1,\r\n                            destination: Cesium.Ellipsoid.WGS84.cartographicToCartesian(finalDestinationCartographic),\r\n                            complete: function () {\r\n                                var angle = Cesium.Math.toRadians(50);\r\n                                var pickBP = pickBottomPoint(this.viewer.scene);\r\n                                pickBP = Cesium.Matrix4.fromTranslation(pickBP);\r\n\r\n                                this.view3D.rotateAroundAxis(this.viewer.scene.camera, -angle, this.viewer.scene.camera.right, pickBP, {\r\n                                    duration: 250,\r\n                                    callback: function () {\r\n                                        resolve();\r\n                                    }\r\n                                });\r\n                            }.bind(self)\r\n                        });\r\n                    });\r\n                });\r\n            }.bind(viewProto),\r\n\r\n            zoomToCartesian: function (position, amount) {\r\n                var self = this;\r\n                var scene = self.viewer.scene;\r\n\r\n                if (!position || !position.endPosition) {\r\n                    var canvas = scene.canvas;\r\n                    var center = new Cesium.Cartesian2(\r\n                        canvas.clientWidth / 2,\r\n                        canvas.clientHeight / 2);\r\n                    position = {\r\n                        endPosition: center\r\n                    };\r\n                }\r\n\r\n                var pickRay = scene.camera.getPickRay(position.endPosition);\r\n                var intersection = scene.globe.pick(pickRay, scene);\r\n                if (intersection) {\r\n\r\n                    var distanceMeasure = Cesium.Cartesian3.distance(pickRay.origin, intersection);\r\n                    if (distanceMeasure < 1) {\r\n                        return;\r\n                    }\r\n                    else {\r\n                        if (!self.view3D._zoomTo) {\r\n                            self.view3D._zoomTo = {\r\n                                amount: 0\r\n                            };\r\n                        }\r\n                        self.view3D._zoomTo.direction = amount > 0 ? 1 : 0;\r\n                        self.view3D._zoomTo.amount += (distanceMeasure * 5 / 100);\r\n                        self.view3D._zoomTo.endPosition = position.endPosition;\r\n                    }\r\n                }\r\n\r\n                var setNewPosition = function (data) {\r\n                    var self = this;\r\n                    var scene = self.viewer.scene;\r\n\r\n                    var pickRay = scene.camera.getPickRay(position.endPosition || data.endPosition);\r\n                    var intersection = scene.globe.pick(pickRay, scene);\r\n                    if (intersection) {\r\n\r\n                        var distanceMeasure = Cesium.Cartesian3.distance(pickRay.origin, intersection);\r\n                        if (distanceMeasure < 1) {\r\n                            return;\r\n                        }\r\n                        else {\r\n\r\n                            var cameraPosition = scene.camera.position;\r\n                            var cameraDirection = scene.camera.direction;\r\n\r\n                            var toMove = toGo = new Cesium.Cartesian3();\r\n                            Cesium.Cartesian3.multiplyByScalar(pickRay.direction, data.direction == 1 ? data.amount : -data.amount, toMove);\r\n                            Cesium.Cartesian3.add(cameraPosition, toMove, toGo);\r\n\r\n                            var ray = new Cesium.Ray(toGo, pickRay.direction);\r\n                            var intersectionToGo = scene.globe.pick(ray, scene);\r\n                            if (intersectionToGo) {\r\n\r\n                                var reset = function () {\r\n                                    this.view3D._zoomTo = {\r\n                                        direction: 1,\r\n                                        amount: 0,\r\n                                        endPosition: {}\r\n                                    };\r\n\r\n                                    return;\r\n                                };\r\n\r\n                                if (Cesium.Cartesian3.distance(toGo, intersectionToGo) < 1 ||\r\n                                    Math.abs(Cesium.Ellipsoid.WGS84.cartesianToCartographic(toGo).height) < scene.screenSpaceCameraController.minimumZoomDistance) {\r\n                                    reset.call(self);\r\n                                }\r\n                                else {\r\n                                    self.viewer.camera.flyTo({\r\n                                        destination: toGo,\r\n                                        orientation: {\r\n                                            heading: scene.camera.heading,\r\n                                            pitch: scene.camera.pitch,\r\n                                            roll: scene.camera.roll\r\n                                        },\r\n                                        duration: 1,\r\n                                        easingFunction: Cesium.EasingFunction.LINEAR_NONE,\r\n                                        complete: function (distance) {\r\n                                            this.view3D._zoomTo = {\r\n                                                direction: 1,\r\n                                                amount: 0,\r\n                                                endPosition: {}\r\n                                            };\r\n                                        }.bind(self, Cesium.Cartesian3.distance(toGo, intersectionToGo))\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                };\r\n\r\n                setTimeout(function () { // GLS: No hemos encontrado otra forma para acumular pasos de la rueda\r\n                    setNewPosition.call(self, self.view3D._zoomTo);\r\n                }.bind(self), 50);\r\n            },\r\n\r\n            rotateAroundAxis: function (camera, angle, axis, transform, opt_options) {\r\n                return rotateAroundAxis(camera, angle, axis, transform, opt_options);\r\n            },\r\n\r\n            addFeature: function (feature, options) {\r\n                var self = this;\r\n\r\n                var add = function () {\r\n                    var csfeature = featureConverter.convert(self.viewer.scene, feature, self.view2DCRS, self.crs);\r\n                    if (csfeature) {\r\n                        if (typeof csfeature.geometry === 'function') {\r\n                            // estoy aquí // tengo que validar qué proveedor escoger, afecta, hay mucha diferencia de alturas, podría ir por capa?? búsquedas fijo por el de por defecto y track validar??\r\n                            csfeature.geometry(self.viewer.terrainProvider).then(function (newGeometry) {\r\n                                // es igual a cuando no es una función... a ver cómo lo gestiono\r\n                                if (newGeometry instanceof Array) {\r\n                                    newGeometry.forEach(function (geom) {\r\n                                        if (geom instanceof Array) {\r\n                                            geom.forEach(function (geo) {\r\n                                                geo = addFeature.call(self, geo);\r\n                                                linkFeature(self, feature.layer.id, geo, feature.id);\r\n                                            });\r\n                                        } else {\r\n                                            geom = addFeature.call(self, geom);\r\n                                            linkFeature(self, feature.layer.id, geom, feature.id);\r\n                                        }\r\n                                    });\r\n                                }\r\n                                else {\r\n                                    var geom = addFeature.call(self, newGeometry);\r\n                                    linkFeature(self, feature.layer.id, geom, feature.id);\r\n                                }\r\n                            });\r\n                        }\r\n                        else if (csfeature.geometry instanceof Array) {\r\n                            csfeature.geometry.forEach(function (geom) {\r\n                                geom = addFeature.call(self, geom);\r\n                                linkFeature(self, feature.layer.id, geom, feature.id);\r\n                            });\r\n                        }\r\n                        else {\r\n                            var geom = addFeature.call(self, csfeature.geometry);\r\n                            linkFeature(self, feature.layer.id, geom, feature.id);\r\n                        }\r\n                    }\r\n                };\r\n\r\n                // GLS: para no pintar la cruz-marker del FeatureInfo\r\n                if ((self.linked2DControls.featureInfo && self.linked2DControls.featureInfo.get2DMarker() === feature) ||\r\n                    (self.linked2DControls.featureInfo && self.linked2DControls.featureInfo.isPending())) {\r\n                    // GLS: llega antes aquí que al callback de la instrucción que crea la feature, por eso necesito el timeout\r\n                    setTimeout(function () {\r\n                        if (self.linked2DControls.featureInfo.get2DMarker() === feature) {\r\n                            return;\r\n                        } else {\r\n                            add();\r\n                        }\r\n                    }, 5);\r\n                } else if (self.linked2DControls.geolocation && self.linked2DControls.geolocation.layerTracking === feature.layer && feature instanceof TC.feature.Polyline) {\r\n                    return;\r\n                } else {\r\n                    add();\r\n                }\r\n            },\r\n            removeFeature: function (feature) {\r\n                var self = this;\r\n                if (self.viewer) {\r\n                    if (feature) {\r\n                        switch (true) {\r\n                            case feature instanceof Cesium.GroundPrimitive:\r\n                                self.viewer.scene.groundPrimitives.remove(feature);\r\n                                break;\r\n                            case feature instanceof Cesium.Billboard:\r\n                                self.viewer.billboardCollection.remove(feature);\r\n                                break;\r\n                            case feature instanceof Object:\r\n                                self.viewer.entities.removeById(feature.id);\r\n                                break;\r\n                        }\r\n\r\n                        self.viewer.scene.requestRender();\r\n                    }\r\n                }\r\n            },\r\n            setRenderOptionsFeature: function (feature, options) {\r\n                if (feature) {\r\n                    feature.show = options.show;\r\n                }\r\n            },\r\n\r\n            addNativeFeature: function (cesiumFeature) {\r\n                return addFeature.call(this.view3D, cesiumFeature);\r\n            },\r\n\r\n            setCameraFromMapView: function () {\r\n                var self = this;\r\n\r\n                self.viewer.scene.globe.terrainProvider.readyPromise.then(function () {\r\n                    var center = self.mapView.getCenter();\r\n\r\n                    if (!center) {\r\n                        return;\r\n                    }\r\n\r\n                    var latlon = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(center, self.view3D.view2DCRS, self.view3D.crs) : center;\r\n                    var distance = calcDistanceForResolution.call(self, self.mapView.getResolution() || 0, Cesium.Math.toRadians(latlon[0]));\r\n\r\n                    var latlon = self.view3D.view2DCRS !== self.view3D.crs ? TC.Util.reproject(center, self.view3D.view2DCRS, self.view3D.crs) : center;\r\n                    var carto = new Cesium.Cartographic(Cesium.Math.toRadians(latlon[0]), Cesium.Math.toRadians(latlon[1]));\r\n                    if (self.viewer.scene.globe) {\r\n                        carto.height = self.viewer.scene.globe.getHeight(carto) || 0;\r\n                    }\r\n\r\n                    var setCamera = function () {\r\n                        var destination = Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\r\n                        var orientation = {\r\n                            pitch: Cesium.Math.toRadians(-90),\r\n                            heading: -self.mapView.getRotation(),\r\n                            roll: 0.0\r\n                        };\r\n\r\n                        self.viewer.camera.setView({\r\n                            destination: destination,\r\n                            orientation: orientation\r\n                        });\r\n\r\n                        self.viewer.camera.moveBackward(distance);\r\n                    };\r\n\r\n                    if (carto.height === 0) {\r\n                        TC.loadJS(!TC.tool || !TC.tool.Elevation, TC.apiLocation + 'TC/tool/Elevation', function () {\r\n                            self.view3D.elevationTool = new TC.tool.Elevation();\r\n                            self.view3D.elevationTool.getElevation({\r\n                                crs: self.view3D.crs,\r\n                                coordinates: latlon\r\n                            }).then(function (result) {\r\n                                if (result && result.length > 0) {\r\n                                    carto.height = result[0][2] ? result[0][2] : 0;\r\n                                    setCamera();\r\n                                }\r\n                            });\r\n                        });\r\n                    } else {\r\n                        setCamera();\r\n                    }\r\n                });\r\n            },\r\n            setViewFromCameraView: function () {\r\n                const self = this;\r\n\r\n\r\n                var ellipsoid = Cesium.Ellipsoid.WGS84;\r\n                var scene = self.viewer.scene;\r\n                var target = target_ = pickCenterPoint(scene);\r\n\r\n                if (!target_) {\r\n                    var globe = self.viewer.scene.globe;\r\n                    var carto = self.viewer.camera.positionCartographic.clone();\r\n                    var height = globe.getHeight(carto);\r\n                    carto.height = height || 0;\r\n                    target_ = Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\r\n                }\r\n\r\n\r\n                var distance = Cesium.Cartesian3.distance(target_, self.viewer.camera.position);\r\n                var targetCartographic = ellipsoid.cartesianToCartographic(target_);\r\n\r\n                var centerMapCRS = self.view3D.crs !== self.view3D.view2DCRS ? TC.Util.reproject(\r\n                    [Cesium.Math.toDegrees(targetCartographic.longitude), Cesium.Math.toDegrees(targetCartographic.latitude)],\r\n                    self.view3D.crs, self.view3D.view2DCRS) : [Cesium.Math.toDegrees(targetCartographic.longitude), Cesium.Math.toDegrees(targetCartographic.latitude)];\r\n\r\n                self.mapView.setCenter(centerMapCRS);\r\n\r\n                self.mapView.setResolution(calcResolutionForDistance.call(self, distance, targetCartographic ? targetCartographic.latitude : 0));\r\n\r\n                // GLS: No tenemos la rotación del mapa activada por problemas con el iPad\r\n                //if (target) {\r\n                //    var pos = self.viewer.camera.position;\r\n\r\n                //    var targetNormal = new Cesium.Cartesian3();\r\n                //    ellipsoid.geocentricSurfaceNormal(target, targetNormal);\r\n\r\n                //    var targetToCamera = new Cesium.Cartesian3();\r\n                //    Cesium.Cartesian3.subtract(pos, target, targetToCamera);\r\n                //    Cesium.Cartesian3.normalize(targetToCamera, targetToCamera);\r\n\r\n                //    // HEADING\r\n                //    var up = self.viewer.camera.up;\r\n                //    var right = self.viewer.camera.right;\r\n                //    var normal = new Cesium.Cartesian3(-target.y, target.x, 0);\r\n                //    var heading = Cesium.Cartesian3.angleBetween(right, normal);\r\n                //    var cross = Cesium.Cartesian3.cross(target, up, new Cesium.Cartesian3());\r\n                //    var orientation = cross.z;\r\n\r\n                //    self.mapView.setRotation((orientation < 0 ? heading : -heading));\r\n                //    self.setViewFromCameraViewInProgress.resolve();\r\n                //}\r\n\r\n                return Promise.resolve();\r\n            },\r\n\r\n            lookAt: function (coords) {\r\n                const self = this;\r\n\r\n                if (self.crs !== self.view2DCRS) {\r\n                    coords = TC.Util.reproject(coords, self.view2DCRS, self.crs);\r\n                }\r\n\r\n                var camera = self.viewer.camera;\r\n                var positionCartographic = camera.positionCartographic;\r\n                var height = positionCartographic.height;\r\n                var cartographic = new Cesium.Cartographic(Cesium.Math.toRadians(coords[0]), Cesium.Math.toRadians(coords[1]), height)\r\n\r\n                camera.flyTo({\r\n                    destination: Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height),\r\n                    duration: 1.0\r\n                });\r\n            },\r\n\r\n            getInfoOnPickedPosition: function (pickedPosition) {\r\n                var self = this;\r\n\r\n                if (!pickedPosition) {\r\n                    return;\r\n                } else {\r\n\r\n                    self.map.one(TC.Consts.event.DRAWTABLE, function (e) {\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    });\r\n\r\n                    self.view3D.linked2DControls.featureInfo.send.call(self, pickedPosition).then(function (e) {\r\n                        self.map.getLoadingIndicator().removeWait(self.waiting);\r\n                        delete self.waiting;\r\n                    });\r\n                }\r\n            },\r\n\r\n            on: function (event, callback) {\r\n                const self = this;\r\n\r\n                const movement3DtoPosition2D = function (movement) {\r\n                    if (self.viewer && self.viewer.cesiumWidget) {\r\n                        var ray = self.viewer.camera.getPickRay(movement.endPosition || movement.position);\r\n                        var position = self.viewer.scene.globe.pick(ray, self.viewer.scene);\r\n                        if (position) {\r\n                            var positionCartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(position);\r\n\r\n                            var lat, lon, ele;\r\n                            lat = Cesium.Math.toDegrees(positionCartographic.latitude);\r\n                            lon = Cesium.Math.toDegrees(positionCartographic.longitude);\r\n                            ele = Math.round(positionCartographic.height);\r\n\r\n                            return { lon: lon, lat: lat, ele: ele };\r\n                        }\r\n                    }\r\n\r\n                    return null;\r\n                };\r\n\r\n                var eventHandler = new Cesium.ScreenSpaceEventHandler(self.viewer.scene.canvas, false);\r\n                eventHandler.setInputAction(function (event) {\r\n                    if (event.endPosition || event.position) {\r\n                        // Si estamos anclados a una entidad ignoro los click en el terreno\r\n                        if (self.viewer.trackedEntity) {\r\n                            return;\r\n                        }\r\n\r\n                        callback(movement3DtoPosition2D(event));\r\n                    } else {\r\n                        callback(event);\r\n                    }\r\n\r\n                }, fromTCtoCesiumEvent(event));\r\n            },\r\n\r\n            getHeightFromMDT: function (geoCoords) {\r\n                const self = this;\r\n\r\n                var cartesian = new Cesium.Cartographic(Cesium.Math.toRadians(geoCoords[0]), Cesium.Math.toRadians(geoCoords[1]));\r\n                return self.viewer.scene.globe.getHeight(cartesian) || 0;\r\n            },\r\n\r\n            destroy: function () {\r\n                var self = this;\r\n\r\n                self.map.on3DView = false;\r\n                //self.map.view3D = null;\r\n\r\n                self.view3D.vector2DLayers = [];\r\n                self.view3D.vector2DFeatures = {\r\n                };\r\n\r\n                // eliminamos el enlace con los eventos del mapa 2D\r\n                self.map.off(listenTo.join(' '), self.view3D._event2DHandler);\r\n\r\n                // modificamos los controles disponibles\r\n                alterAllowedControls.call(self, TC.Consts.view.DEFAULT);\r\n\r\n                // sobrescribimos el comportamiento de lo botones + /- y la casita\r\n                override2DZoom.call(self, false);\r\n\r\n                //addNoCompatibleBaseLayers.call(self);\r\n\r\n                Promise.all(self.map.baseLayers.map(function (baseLayer) {\r\n                    return Promise.resolve(!isCompatible(baseLayer, self.view3D.view2DCRS));\r\n                })).then(function (results) {\r\n                    if (results.length > 0) {\r\n                        var defaultBaseLayer;\r\n                        for (var i = 0; i < self.map.baseLayers.length; i++) {\r\n                            if (!defaultBaseLayer && !results[i]) {\r\n                                defaultBaseLayer = self.map.baseLayers[i];\r\n                            }\r\n                            self.map.baseLayers[i].mustReproject = results[i];\r\n                        }\r\n                        var triggerEvent = true;\r\n                        const showReprojectDialog = function (haveToChange, baseLayer, fallbackLayer) {\r\n                            const dialogOptions = {\r\n                                layer: baseLayer\r\n                            };\r\n\r\n                            if (fallbackLayer) {\r\n                                dialogOptions.fallbackLayer = fallbackLayer;\r\n                            }\r\n\r\n                            var control = self.map.getControlsByClass(haveToChange ? TC.control.BasemapSelector : TC.control.Coordinates);\r\n                            if (control.length > 0) {\r\n                                // gestionamos que el control de coordenadas no se renderice en el cambio de vista porque borra el modal de cambio de CRS\r\n                                if (control[0] instanceof TC.control.Coordinates) {\r\n                                    triggerEvent = false;\r\n                                }\r\n                                dialogOptions.closeCallback = function () {\r\n                                    self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.DEFAULT });\r\n                                };\r\n                                control[0].showProjectionChangeDialog(dialogOptions);\r\n                            }\r\n                        };\r\n\r\n                        var baseLayer = currentMapCfg.baseMap == self.Consts.BLANK_BASE ? currentMapCfg.baseVector : currentMapCfg.baseMap;\r\n                        if (!baseLayer.isCompatible(self.map.getCRS())) {\r\n\r\n                            if (!baseLayer.fallbackLayer) {\r\n                                showReprojectDialog(true, baseLayer);\r\n                            } else {\r\n                                baseLayer.getFallbackLayer();\r\n                                if (baseLayer.getFallbackLayer().isCompatible(self.map.getCRS())) {\r\n\r\n                                    // antes de establecer como fondo la capa de respaldo, preguntar al usuario si prefiere cambiar de CRS o si quiere seguir reproyectando al vuelo.\r\n                                    TC.confirm(self.getLocaleString('threed.changeBaselayer'),\r\n                                        function () {\r\n                                            showReprojectDialog(false, baseLayer, baseLayer.fallbackLayer);\r\n                                        }, function () {\r\n                                            self.map.setBaseLayer(baseLayer.fallbackLayer);\r\n                                        });\r\n                                } else {\r\n                                    showReprojectDialog(true, baseLayer);\r\n                                }\r\n                            }\r\n                        } else {\r\n                            self.map.setBaseLayer(baseLayer);\r\n                        }\r\n                    }\r\n\r\n                    currentMapCfg.baseMap = '';\r\n\r\n                    self.view3D.baseLayer = null;\r\n\r\n                    self.view3D.workLayers = [];\r\n\r\n                    self.view3D.cameraControls.unbind();\r\n\r\n                    if (self.view3D.linked2DControls.featureInfo) {\r\n                        self.view3D.linked2DControls.featureInfo.reset();\r\n                    }\r\n\r\n                    if (self.view3D.linked2DControls.geolocation) {\r\n                        self.view3D.linked2DControls.geolocation.isGeo = false;\r\n                        self.view3D.linked2DControls.geolocation.reset();\r\n                    }\r\n\r\n                    self.view3D.tileLoadingHandler.removeAll();\r\n                    delete self.view3D.tileLoadingHandler;\r\n\r\n                    self.viewer.destroy();\r\n                    self.viewer = null;\r\n\r\n                    if (triggerEvent) { // si lanzamos sin más, el control de coordenadas se renderizada en el cambio de vista y borra el modal de cambio de CRS\r\n                        self.map.trigger(TC.Consts.event.VIEWCHANGE, { view: TC.Consts.view.DEFAULT });\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    })();\r\n\r\n    return {\r\n        init: viewProto.init.bind(viewProto),\r\n        apply: viewProto.apply.bind(viewProto),\r\n        unapply: viewProto.unapply.bind(viewProto),\r\n        VIEWNAME: viewProto.VIEWNAME\r\n    };\r\n});"],"file":"../../view/ThreeD.min.js"}