TC.control=TC.control||{};TC.control.TOC||TC.syncLoadJS(TC.apiLocation+"TC/control/TOC");TC.control.WorkLayerManager=function(e){TC.control.TOC.apply(this,arguments);this.layers=[];this.queries=this.options.queries};TC.inherit(TC.control.WorkLayerManager,TC.control.TOC);!function(){var e=TC.control.WorkLayerManager.prototype;e.CLASS="tc-ctl-wlm";e.CLICKEVENT="click";TC.Consts.classes.DRAG=TC.Consts.classes.DRAG||"tc-drag";TC.Consts.classes.DRAGEND=TC.Consts.classes.DRAGEND||"tc-dragend";TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/WorkLayerManager.html";e.template[e.CLASS+"-elm"]=TC.apiLocation+"TC/templates/WorkLayerManagerElement.html";e.template[e.CLASS+"-type-sgl"]=TC.apiLocation+"TC/templates/WorkLayerManagerTooltipSingle.html";e.template[e.CLASS+"-type-grp"]=TC.apiLocation+"TC/templates/WorkLayerManagerTooltipGroup.html";e.template[e.CLASS+"-type-grp-node"]=TC.apiLocation+"TC/templates/WorkLayerManagerTooltipGroupNode.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"loadedLayers"}).w('<span class="tc-ctl-wlm-n"></span><button class="tc-ctl-wlm-del-all tc-hidden" title="').h("i18n",t,{},{$key:"removeAllLayersFromMap"}).w('"></button></h2><div class="tc-ctl-wlm-empty">').h("i18n",t,{},{$key:"noData"}).w('</div><div class="tc-ctl-wlm-content tc-hidden"><form><ul>').s(t.get(["workLayers"],!1),t,{block:s},{}).w("</ul></form></div>")}t.__dustBody=!0;function s(e,t){return e.p("tc-ctl-wlm-elm",t,t.rebase(t.getPath(!0,[])),{})}s.__dustBody=!0;return t};e.template[e.CLASS+"-elm"]=function(){dust.register(e.CLASS+"-elm",t);function t(e,t){return e.w('<li class="tc-ctl-wlm-elm" tabindex="-1"><div class="tc-ctl-wlm-lyr">').x(t.get(["path"],!1),t,{block:s},{}).w('</div><div class="tc-ctl-wlm-type"></div><div class="tc-ctl-wlm-path" title="').s(t.get(["path"],!1),t,{else:n,block:a},{}).w('">').s(t.get(["path"],!1),t,{else:o,block:i},{}).w('</div><div class="tc-ctl-wlm-buttons"><div class="tc-ctl-wlm-btn-info" title="').h("i18n",t,{},{$key:"infoFromThisLayer"}).w('"></div><input type="range" value="').f(t.get(["opacity"],!1),t,"h").w('" title="').h("i18n",t,{},{$key:"transparencyOfThisLayer"}).w('" /><input type="checkbox" ').nx(t.get(["hide"],!1),t,{block:c},{}).w(' title="').h("i18n",t,{},{$key:"visibilityOfThisLayer"}).w('" /></div><div class="tc-ctl-wlm-info tc-hidden">').x(t.get(["abstract"],!1),t,{block:d},{}).x(t.get(["customLegend"],!1),t,{else:u,block:p},{}).x(t.get(["metadata"],!1),t,{block:y},{}).w('</div><div class="tc-ctl-wlm-dd ').x(t.get(["hide"],!1),t,{block:L},{}).w('" title="').h("i18n",t,{},{$key:"dragToReorder"}).w('"></div><div class="tc-ctl-wlm-del ').x(t.get(["unremovable"],!1),t,{block:g},{}).w(" ").nx(t.get(["hide"],!1),t,{block:h},{}).w('" ').nx(t.get(["unremovable"],!1),t,{block:v},{}).w("></div></li>")}t.__dustBody=!0;function s(e,t){return e.f(t.get(["title"],!1),t,"h")}s.__dustBody=!0;function n(e,t){return e.f(t.get(["title"],!1),t,"h")}n.__dustBody=!0;function a(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:r},{})}a.__dustBody=!0;function r(e,t){return e.w(" &bull; ")}r.__dustBody=!0;function o(e,t){return e.f(t.get(["title"],!1),t,"h")}o.__dustBody=!0;function i(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:l},{})}i.__dustBody=!0;function l(e,t){return e.w(" &bull; ")}l.__dustBody=!0;function c(e,t){return e.w('checked="checked"')}c.__dustBody=!0;function d(e,t){return e.w('<div class="tc-ctl-wlm-abstract"><h4>').h("i18n",t,{},{$key:"abstract"}).w("</h4><div><pre>").f(t.get(["abstract"],!1),t,"h",["s"]).w("</pre></div></div>")}d.__dustBody=!0;function u(e,t){return e.x(t.get(["legend"],!1),t,{block:C},{})}u.__dustBody=!0;function C(e,t){return e.w('<div class="tc-ctl-wlm-legend" data-tc-layer-name="').f(t.get(["layerNames"],!1),t,"h").w('"><h4>').h("i18n",t,{},{$key:"content"}).w("</h4>").s(t.get(["legend"],!1),t,{block:f},{}).w("</div>")}C.__dustBody=!0;function f(e,t){return e.w("<div><p>").f(t.get(["title"],!1),t,"h").w('</p><img data-tc-img="').f(t.get(["src"],!1),t,"h").w('" /></div>')}f.__dustBody=!0;function p(e,t){return e.w('<ul class="tc-ctl-wlm-custom-legend">').f(t.get(["customLegend"],!1),t,"h",["s"]).w("</ul>")}p.__dustBody=!0;function y(e,t){return e.w('<div class="tc-ctl-wlm-metadata"><h4>').h("i18n",t,{},{$key:"metadata"}).w("</h4><ul>").s(t.get(["metadata"],!1),t,{block:m},{}).w("</ul></div>")}y.__dustBody=!0;function m(e,t){return e.w('<li><a href="').f(t.get(["url"],!1),t,"h",["s"]).w('" type="').f(t.get(["format"],!1),t,"h").w('" title="').f(t.get(["formatDescription"],!1),t,"h").w('" target="_blank">').f(t.get(["formatDescription"],!1),t,"h").w("</a></li>")}m.__dustBody=!0;function L(e,t){return e.w("tc-hidden")}L.__dustBody=!0;function g(e,t){return e.w("disabled")}g.__dustBody=!0;function h(e,t){return e.w("tc-hidden")}h.__dustBody=!0;function v(e,t){return e.w('title="').h("i18n",t,{},{$key:"removeLayerFromMap"}).w('"')}v.__dustBody=!0;return t};e.template[e.CLASS+"-type-sgl"]=function(){dust.register(e.CLASS+"-type-sgl",t);function t(e,t){return e.h("i18n",t,{},{$key:"singleLayer"})}t.__dustBody=!0;return t};e.template[e.CLASS+"-type-grp"]=function(){dust.register(e.CLASS+"-type-grp",t);function t(e,t){return e.w("<div>").h("i18n",t,{},{$key:"groupLayerThatContains"}).w(":</div><ul>").s(t.get(["Layer"],!1),t,{block:s},{}).w("</ul>")}t.__dustBody=!0;function s(e,t){return e.p("tc-ctl-wlm-type-grp-node",t,t.rebase(t.getPath(!0,[])),{})}s.__dustBody=!0;return t};e.template[e.CLASS+"-type-grp-node"]=function(){dust.register(e.CLASS+"-type-grp-node",t);function t(e,t){return e.w('<li class="tc-ctl-wlm-tip-grp-elm"><span>').f(t.get(["Title"],!1),t,"h").w("</span><ul>").s(t.get(["Layer"],!1),t,{block:s},{}).w("</ul></li>")}t.__dustBody=!0;function s(e,t){return e.p("tc-ctl-wlm-type-grp-node",t,t.rebase(t.getPath(!0,[])),{})}s.__dustBody=!0;return t}}const t="tcLayer",s=function(e,s){return e.getLayerUIElements().filter(function(e){return $(e).data(t)===s})[0]};var n=function(e){return $.grep(e.map.workLayers,function(e){return!e.stealth}).length};const a=function(e){return!e.layers.some(function(e){return e.unremovable})},r=function(e,s,n,a,r){const o=e.getLayerUIElements();var i;if(a>n)i=o[a-1];else{if(!(a<n))return;i=o[a+1]}const l=$(s).data(t),c=$(i).data(t);for(var d=-1,u=0;u<e.map.layers.length;u++)if(c===e.map.layers[u]){d=u;break}d>=1&&d<e.map.layers.length&&e.map.insertLayer(l,d,r)};e.render=function(e,t){const s=this;return s._set1stRenderPromise(s.map?s.renderData(t?$.extend(s.map.getLayerTree(),t):s.map.getLayerTree(),function(){s.addUIEventListeners();TC.loadJS(!window.Sortable,[TC.apiLocation+"lib/sortable/Sortable.min.js"],function(){s.map.workLayers.filter(function(e){return!e.stealth}).forEach(function(e){s.updateLayerTree(e)});const t=s.div.querySelector("ul");s._sortable=Sortable.create(t,{handle:"."+s.CLASS+"-dd",animation:150,onSort:function(e){r(s,e.item,e.oldIndex,e.newIndex)}});t.addEventListener("keydown",TC.EventTarget.listenerBySelector("li",function(e){for(var t=e.target;"LI"!==t.tagName;)if(!(t=t.parentElement))return;const n=function(e,n){const a=s._sortable.toArray(),o=a[e];a[e]=a[n];a[n]=o;s._sortable.sort(a);r(s,t,e,n)},a=s.getLayerUIElements(),o=a.indexOf(t);switch(!0){case/Up$/.test(e.key):if(o>0){n(o,o-1);t.focus();e.stopPropagation()}break;case/Down$/.test(e.key):if(o<a.length-1){n(o,o+1);t.focus();e.stopPropagation()}break;case/Enter$/.test(e.key):t.blur();e.stopPropagation()}}));"function"==typeof e&&e()})}):Promise.reject())};e.register=function(t){const n=this;return new Promise(function(a,r){TC.control.TOC.prototype.register.call(n,t).then(function(){t.on(TC.Consts.event.LAYEROPACITY,function(e){const t=s(n,e.layer);t&&(t.querySelector("input[type=range]").value=Math.round(100*e.opacity))}).on(TC.Consts.event.FEATURESIMPORT,function(e){var s=e.fileName;if(e.features&&e.features.length>0){var a="."+TC.Consts.format.GPX.toLowerCase();if(e.fileName.toLowerCase().indexOf(a)===e.fileName.length-a.length)return;t.one(TC.Consts.event.LAYERADD,function(e){if(e&&e.layer&&e.layer.title==s){if(n.map&&n.map.layout&&n.map.layout.accordion&&n.div.classList.contains(TC.Consts.classes.COLLAPSED))for(var t=0;t<n.map.controls.length;t++)n.map.controls[t]!==n&&n.map.controls[t].div.classList.add(TC.Consts.classes.COLLAPSED);n.map.trigger(TC.Consts.event.TOOLSOPEN);n.div.classList.remove(TC.Consts.classes.COLLAPSED)}})}});if(n.queries){TC.control.WFSQuery||TC.syncLoadJS(TC.apiLocation+"TC/Control/WFSQuery");e.queryControl=new TC.control.WFSQuery(null,n.queries instanceof Object?n.queries:null);n.map.addControl(e.queryControl)}a(n)})})};e.onExternalServiceAdded=function(e,t){};e.addUIEventListeners=function(){const e=this;e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("input[type=checkbox]",function(s){const n=s.target;var a=n;do{a=a.parentElement}while(a&&!a.matches("li."+e.CLASS+"-elm"));$(a).data(t).setVisibility(n.checked);s.stopPropagation()}));const s=function(e){const s=e.target;var n=s;do{n=n.parentElement}while(n&&"LI"!==n.tagName);$(n).data(t).setOpacity(s.value/100)};e.div.addEventListener("change",TC.EventTarget.listenerBySelector("input[type=range]",s));e.div.addEventListener("input",TC.EventTarget.listenerBySelector("input[type=range]",s));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-del:not(.disabled)",function(s){var n=s.target;do{n=n.parentElement}while(n&&"LI"!==n.tagName);const a=$(n).data(t);e.map.removeLayer(a)}));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-del-all",function(s){TC.confirm(e.getLocaleString("layersRemove.confirm"),function(){e.getLayerUIElements().map(function(e){return $(e).data(t)}).forEach(function(t){e.map.removeLayer(t)})})}));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-btn-info",function(s){const n=s.target;var a=n;do{a=a.parentElement}while(a&&"LI"!==a.tagName);const r=a.querySelector("."+e.CLASS+"-info"),o=$(a).data(t);r.querySelectorAll("."+e.CLASS+"-legend img").forEach(function(t){e.styleLegendImage(t,o)});r.classList.contains(TC.Consts.classes.HIDDEN)?r.classList.remove(TC.Consts.classes.HIDDEN):r.classList.add(TC.Consts.classes.HIDDEN);if(a.querySelector('input[type="checkbox"]').checked){const t=a.querySelector("."+e.CLASS+"-dd");r.classList.contains(TC.Consts.classes.HIDDEN)?t.classList.remove(TC.Consts.classes.HIDDEN):t.classList.add(TC.Consts.classes.HIDDEN)}n.classList.contains(TC.Consts.classes.CHECKED)?n.classList.remove(TC.Consts.classes.CHECKED):n.classList.add(TC.Consts.classes.CHECKED)}));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-btn-query",function(s){if(s.target.classList.contains("tc-unavailable")||s.target.classList.contains("tc-loading"))return;var n=s.target;do{n=n.parentElement}while(n&&"LI"!==n.tagName);const a=$(n).data(t);e.queryControl.renderModalDialog(a)}))};e.updateLayerVisibility=function(e){const t=this,n=s(t,e);if(n){const s=e.getVisibility();n.querySelector('input[type="checkbox"]').checked=s;const a=n.querySelector("."+t.CLASS+"-del"),r=n.querySelector("."+t.CLASS+"-info"),o=n.querySelector("."+t.CLASS+"-dd");if(s){a.classList.add(TC.Consts.classes.HIDDEN);r.classList.contains(TC.Consts.classes.HIDDEN)&&o.classList.remove(TC.Consts.classes.HIDDEN)}else{a.classList.remove(TC.Consts.classes.HIDDEN);r.classList.contains(TC.Consts.classes.HIDDEN)&&o.classList.add(TC.Consts.classes.HIDDEN)}}};e.updateLayerTree=function(e){var s=this;if(!e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(s,e);for(var r=!1,i=0,l=s.layers.length;i<l;i++)if(e===s.layers[i]){r=!0;break}if(!r){var c=s.CLASS+"-elm";s.layers.push(e);TC.loadJSInOrder(!window.dust,TC.url.templating,function(){var n,a=e.title||e.wrap.getServiceTitle(),r={title:e.options.hideTitle?"":a,hide:!(!e.renderOptions||!e.renderOptions.hide),opacity:e.renderOptions&&e.renderOptions.opacity?100*e.renderOptions.opacity:100,customLegend:e.customLegend,unremovable:e.unremovable},i=e.isRaster();if(i){r.layerNames=e.layerNames;var l=e.getPath();l.shift();r.path=l;var d=e.names[0],u=e.wrap.getInfo(d);r.legend=u.legend;r.abstract=u.abstract;var C,f=u.hasOwnProperty("abstract")||u.hasOwnProperty("legend")||u.hasOwnProperty("metadata");if(e.tree&&e.tree.children&&e.tree.children.length&&e.tree.children[0].children&&e.tree.children[0].children.length)C=null;else if(C=u.metadata)for(var p=0,y=C.length;p<y;p++){var m=C[p];m.formatDescription=s.getLocaleString(TC.Util.getSimpleMimeType(m.format))||s.getLocaleString("viewMetadata")}r.metadata=C;s.queries&&(n=o(e))}(function(e){return new Promise(function(t,s){e&&e.options.method&&"POST"===e.options.method?e.getLegendGraphicImage().then(function(e){t(e)}).catch(function(e){TC.error(e)}):t()})})(e).then(function(a){a&&(legend.src=a);dust.render(c,r,function(a,r){const o=(new DOMParser).parseFromString(r,"text/html").body.firstChild;var l,c=!1;if(i&&!(c=e.names.length>1))for(var u=e.wrap.getAllLayerNodes(),C=0;C<u.length;C++){var p=u[C];if(e.wrap.getName(p)===d){l=p;e.wrap.getLayerNodes(p).length>0&&(c=!0);break}}const y=o.querySelector("."+s.CLASS+"-type"),m=c?s.CLASS+"-type-grp":s.CLASS+"-type-sgl";y.classList.add(m);f||o.querySelector("."+s.CLASS+"-btn-info").classList.add(TC.Consts.classes.HIDDEN);if(l){e.wrap.normalizeLayerNode(l);dust.render(m,l,function(e,t){var n;y.addEventListener("mouseover",function(e){const a=s.map.div,r=y.getBoundingClientRect();(n=document.createElement("div")).classList.add(s.CLASS+"-tip");n.innerHTML=t;n.style.top=r.top-a.offsetTop+"px";n.style.right=a.offsetWidth-(r.left-a.offsetLeft)+"px";a.appendChild(n)});y.addEventListener("mouseout",function(e){n.parentElement.removeChild(n)})})}const L=s.div.querySelector("ul");$(o).data(t,e);const g=s.getLayerUIElements(),h=s.map.workLayers.filter(function(e){return!e.stealth}),v=h.indexOf(e);for(var S=!1,T=(C=0,g.length);C<T;C++){const e=g[C],s=$(e).data(t);if(h.indexOf(s)<v){e.insertAdjacentElement("beforebegin",o);S=!0;break}}S||L.appendChild(o);n&&n(o);s.updateScale()})})});var d=n(s);const r=s.div.querySelector("."+s.CLASS+"-n"),i=s.div.querySelector("."+s.CLASS+"-empty"),l=s.div.querySelector("."+s.CLASS+"-content");r.textContent=d;if(d>0){r.classList.add(TC.Consts.classes.VISIBLE);i.classList.add(TC.Consts.classes.HIDDEN);l.classList.remove(TC.Consts.classes.HIDDEN)}else{r.classList.remove(TC.Consts.classes.VISIBLE);i.classList.remove(TC.Consts.classes.HIDDEN);l.classList.add(TC.Consts.classes.HIDDEN)}const u=s.div.querySelector("."+s.CLASS+"-del-all");a(s)?u.classList.remove(TC.Consts.classes.HIDDEN):u.classList.add(TC.Consts.classes.HIDDEN)}}};e.updateScale=function(){var e=this;e.getLayerUIElements().forEach(function(s){var n=$(s).data(t);if(n.names){for(var a=!1,r=0;r<n.names.length;r++)if(n.isVisibleByScale(n.names[r])){a=!0;break}const t=e.CLASS+"-elm-notvisible";a?s.classList.remove(t):s.classList.add(t)}})};e.updateLayerOrder=function(e,t,n){const a=this;a.map.workLayers.filter(function(e){return!e.stealth}).forEach(function(e){const t=s(a,e);t&&t.parentElement.firstChild.insertAdjacentElement("beforebegin",t)})};e.removeLayer=function(e){var s=this.layers.indexOf(e);s>=0&&this.layers.splice(s,1);this.getLayerUIElements().forEach(function(s){$(s).data(t)===e&&s.parentElement.removeChild(s)});const r=this.div.querySelector("."+this.CLASS+"-content"),o=this.div.querySelector("."+this.CLASS+"-empty"),i=this.div.querySelector("."+this.CLASS+"-n");var l=n(this);i.textContent=l;if(l>0){r.classList.remove(TC.Consts.classes.HIDDEN);o.classList.add(TC.Consts.classes.HIDDEN);i.classList.add(TC.Consts.classes.VISIBLE)}else{a(this)&&this.div.querySelector("."+this.CLASS+"-del-all").classList.add(TC.Consts.classes.HIDDEN);r.classList.add(TC.Consts.classes.HIDDEN);o.classList.remove(TC.Consts.classes.HIDDEN);i.classList.remove(TC.Consts.classes.VISIBLE)}};e.getLayerUIElements=function(){const e=this,t=[],s=e.div.querySelector("ul").children;for(var n=0,a=s.length;n<a;n++){child=s[n];child.matches("li."+e.CLASS+"-elm")&&(t[t.length]=child)}return t};const o=function(t){var s,n=null,a=new Promise(function(e,t){n=e});a.then(function(t){(s=document.createElement("div")).classList.add(e.CLASS+"-btn-query");s.classList.add(TC.Consts.classes.LOADING);s.setAttribute("title",e.getLocaleString("query.tooltipMagnifBtn"));t.querySelector("."+e.CLASS+"-btn-info").insertAdjacentElement("afterend",s)});var r=t.getWFSCapabilitiesPromise();const o=function(){if(s){s.classList.remove(TC.Consts.classes.LOADING);s.classList.add("tc-unavailable")}console.log("El servicio "+(t.title||t.tree.title)+" no tiene disponible el WFS")};Promise.all([r,a]).then(function(){var e=arguments[0][0];if(s){s.classList.remove(TC.Consts.classes.LOADING);var n=t.getDisgregatedLayerNames();if(1===n.length&&!e.FeatureTypes.hasOwnProperty(n[0].substring(n[0].indexOf(":")+1))){s.classList.add("tc-unavailable");console.log("El servicio WFS de "+(t.title||t.tree.title)+" no dispone de la capa "+n[0])}}}).catch(o);r.catch(o);return n}}();
//# sourceMappingURL=../maps/control/WorkLayerManager.min.js.map
