TC.control=TC.control||{};TC.control.TOC||TC.syncLoadJS(TC.apiLocation+"TC/control/TOC");TC.control.WorkLayerManager=function(e){TC.control.TOC.apply(this,arguments);this.layers=[];this.queries=this.options.queries};TC.inherit(TC.control.WorkLayerManager,TC.control.TOC);!function(){var e=TC.control.WorkLayerManager.prototype;e.CLASS="tc-ctl-wlm";e.CLICKEVENT="click";TC.Consts.classes.DRAG=TC.Consts.classes.DRAG||"tc-drag";TC.Consts.classes.DRAGEND=TC.Consts.classes.DRAGEND||"tc-dragend";TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/WorkLayerManager.html";e.template[e.CLASS+"-elm"]=TC.apiLocation+"TC/templates/WorkLayerManagerElement.html";e.template[e.CLASS+"-type-sgl"]=TC.apiLocation+"TC/templates/WorkLayerManagerTooltipSingle.html";e.template[e.CLASS+"-type-grp"]=TC.apiLocation+"TC/templates/WorkLayerManagerTooltipGroup.html";e.template[e.CLASS+"-type-grp-node"]=TC.apiLocation+"TC/templates/WorkLayerManagerTooltipGroupNode.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"loadedLayers"}).w('<span class="tc-ctl-wlm-n"></span><button class="tc-ctl-wlm-del-all tc-hidden" title="').h("i18n",t,{},{$key:"removeAllLayersFromMap"}).w('"></button></h2><div class="tc-ctl-wlm-empty">').h("i18n",t,{},{$key:"noData"}).w('</div><div class="tc-ctl-wlm-content tc-hidden"><form><ul>').s(t.get(["workLayers"],!1),t,{block:n},{}).w("</ul></form></div>")}t.__dustBody=!0;function n(e,t){return e.p("tc-ctl-wlm-elm",t,t.rebase(t.getPath(!0,[])),{})}n.__dustBody=!0;return t};e.template[e.CLASS+"-elm"]=function(){dust.register(e.CLASS+"-elm",t);function t(e,t){return e.w('<li class="tc-ctl-wlm-elm" tabindex="-1"><div class="tc-ctl-wlm-lyr">').x(t.get(["path"],!1),t,{block:n},{}).w('</div><div class="tc-ctl-wlm-type"></div><div class="tc-ctl-wlm-path" title="').s(t.get(["path"],!1),t,{else:s,block:a},{}).w('">').s(t.get(["path"],!1),t,{else:o,block:i},{}).w('</div><div class="tc-ctl-wlm-buttons"><div class="tc-ctl-wlm-btn-info" title="').h("i18n",t,{},{$key:"infoFromThisLayer"}).w('"></div><input type="range" value="').f(t.get(["opacity"],!1),t,"h").w('" title="').h("i18n",t,{},{$key:"transparencyOfThisLayer"}).w('" /><input type="checkbox" ').nx(t.get(["hide"],!1),t,{block:c},{}).w(' title="').h("i18n",t,{},{$key:"visibilityOfThisLayer"}).w('" /></div><div class="tc-ctl-wlm-info tc-hidden">').x(t.get(["abstract"],!1),t,{block:d},{}).x(t.get(["customLegend"],!1),t,{else:u,block:p},{}).x(t.get(["metadata"],!1),t,{block:f},{}).w('</div><div class="tc-ctl-wlm-dd ').x(t.get(["hide"],!1),t,{block:g},{}).w('" title="').h("i18n",t,{},{$key:"dragToReorder"}).w('"></div><div class="tc-ctl-wlm-del ').x(t.get(["unremovable"],!1),t,{block:L},{}).w(" ").nx(t.get(["hide"],!1),t,{block:h},{}).w('" ').nx(t.get(["unremovable"],!1),t,{block:S},{}).w("></div></li>")}t.__dustBody=!0;function n(e,t){return e.f(t.get(["title"],!1),t,"h")}n.__dustBody=!0;function s(e,t){return e.f(t.get(["title"],!1),t,"h")}s.__dustBody=!0;function a(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:r},{})}a.__dustBody=!0;function r(e,t){return e.w(" &bull; ")}r.__dustBody=!0;function o(e,t){return e.f(t.get(["title"],!1),t,"h")}o.__dustBody=!0;function i(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:l},{})}i.__dustBody=!0;function l(e,t){return e.w(" &bull; ")}l.__dustBody=!0;function c(e,t){return e.w('checked="checked"')}c.__dustBody=!0;function d(e,t){return e.w('<div class="tc-ctl-wlm-abstract"><h4>').h("i18n",t,{},{$key:"abstract"}).w("</h4><div><pre>").f(t.get(["abstract"],!1),t,"h",["s"]).w("</pre></div></div>")}d.__dustBody=!0;function u(e,t){return e.x(t.get(["legend"],!1),t,{block:y},{})}u.__dustBody=!0;function y(e,t){return e.w('<div class="tc-ctl-wlm-legend" data-layer-name="').f(t.get(["layerNames"],!1),t,"h").w('"><h4>').h("i18n",t,{},{$key:"content"}).w("</h4>").s(t.get(["legend"],!1),t,{block:C},{}).w("</div>")}y.__dustBody=!0;function C(e,t){return e.w("<div><p>").f(t.get(["title"],!1),t,"h").w('</p><img data-img="').f(t.get(["src"],!1),t,"h").w('" /></div>')}C.__dustBody=!0;function p(e,t){return e.w('<ul class="tc-ctl-wlm-custom-legend">').f(t.get(["customLegend"],!1),t,"h",["s"]).w("</ul>")}p.__dustBody=!0;function f(e,t){return e.w('<div class="tc-ctl-wlm-metadata"><h4>').h("i18n",t,{},{$key:"metadata"}).w("</h4><ul>").s(t.get(["metadata"],!1),t,{block:m},{}).w("</ul></div>")}f.__dustBody=!0;function m(e,t){return e.w('<li><a href="').f(t.get(["url"],!1),t,"h",["s"]).w('" type="').f(t.get(["format"],!1),t,"h").w('" title="').f(t.get(["formatDescription"],!1),t,"h").w('" target="_blank">').f(t.get(["formatDescription"],!1),t,"h").w("</a></li>")}m.__dustBody=!0;function g(e,t){return e.w("tc-hidden")}g.__dustBody=!0;function L(e,t){return e.w("disabled")}L.__dustBody=!0;function h(e,t){return e.w("tc-hidden")}h.__dustBody=!0;function S(e,t){return e.w('title="').h("i18n",t,{},{$key:"removeLayerFromMap"}).w('"')}S.__dustBody=!0;return t};e.template[e.CLASS+"-type-sgl"]=function(){dust.register(e.CLASS+"-type-sgl",t);function t(e,t){return e.h("i18n",t,{},{$key:"singleLayer"})}t.__dustBody=!0;return t};e.template[e.CLASS+"-type-grp"]=function(){dust.register(e.CLASS+"-type-grp",t);function t(e,t){return e.w("<div>").h("i18n",t,{},{$key:"groupLayerThatContains"}).w(":</div><ul>").s(t.get(["Layer"],!1),t,{block:n},{}).w("</ul>")}t.__dustBody=!0;function n(e,t){return e.p("tc-ctl-wlm-type-grp-node",t,t.rebase(t.getPath(!0,[])),{})}n.__dustBody=!0;return t};e.template[e.CLASS+"-type-grp-node"]=function(){dust.register(e.CLASS+"-type-grp-node",t);function t(e,t){return e.w('<li class="tc-ctl-wlm-tip-grp-elm"><span>').f(t.get(["Title"],!1),t,"h").w("</span><ul>").s(t.get(["Layer"],!1),t,{block:n},{}).w("</ul></li>")}t.__dustBody=!0;function n(e,t){return e.p("tc-ctl-wlm-type-grp-node",t,t.rebase(t.getPath(!0,[])),{})}n.__dustBody=!0;return t}}const t=function(e,t){return e.getLayerUIElements().filter(function(e){return e.dataset.layerId===t.id})[0]};var n=function(e){return e.layers.length};const s=function(e){return!e.layers.some(function(e){return e.unremovable})},a=function(e,t,n,s,a){const r=e.getLayerUIElements();var o;if(s>n)o=r[s-1];else{if(!(s<n))return;o=r[s+1]}const i=e.map.getLayer(t.dataset.layerId),l=e.map.getLayer(o.dataset.layerId);for(var c=-1,d=0;d<e.map.layers.length;d++)if(l===e.map.layers[d]){c=d;break}c>=1&&c<e.map.layers.length&&e.map.insertLayer(i,c,a)};e.render=function(e,t){const n=this;return n._set1stRenderPromise(n.map?n.renderData(t?TC.Util.extend(n.map.getLayerTree(),t):n.map.getLayerTree(),function(){n.addUIEventListeners();TC.loadJS(!window.Sortable,[TC.apiLocation+"lib/sortable/Sortable.min.js"],function(){n.map.workLayers.filter(function(e){return!e.stealth}).forEach(function(e){n.updateLayerTree(e)});const t=n.div.querySelector("ul");n._sortable=Sortable.create(t,{handle:"."+n.CLASS+"-dd",animation:150,onSort:function(e){a(n,e.item,e.oldIndex,e.newIndex)}});t.addEventListener("keydown",TC.EventTarget.listenerBySelector("li",function(e){for(var t=e.target;"LI"!==t.tagName;)if(!(t=t.parentElement))return;const s=function(e,s){const r=n._sortable.toArray(),o=r[e];r[e]=r[s];r[s]=o;n._sortable.sort(r);a(n,t,e,s)},r=n.getLayerUIElements(),o=r.indexOf(t);switch(!0){case/Up$/.test(e.key):if(o>0){s(o,o-1);t.focus();e.stopPropagation()}break;case/Down$/.test(e.key):if(o<r.length-1){s(o,o+1);t.focus();e.stopPropagation()}break;case/Enter$/.test(e.key):t.blur();e.stopPropagation()}}));"function"==typeof e&&e()})}):Promise.reject())};e.register=function(n){const s=this;return new Promise(function(a,r){TC.control.TOC.prototype.register.call(s,n).then(function(){n.loaded(function(){s.updateScale()});n.on(TC.Consts.event.LAYEROPACITY,function(e){const n=t(s,e.layer);n&&(n.querySelector("input[type=range]").value=Math.round(100*e.opacity))}).on(TC.Consts.event.FEATURESIMPORT,function(e){var t=e.fileName;if(e.features&&e.features.length>0){var a="."+TC.Consts.format.GPX.toLowerCase();if(e.fileName.toLowerCase().indexOf(a)===e.fileName.length-a.length)return;n.one(TC.Consts.event.LAYERADD,function(e){if(e&&e.layer&&e.layer.title==t){s.map&&s.map.layout&&s.map.layout.accordion&&s.div.classList.contains(TC.Consts.classes.COLLAPSED)&&s.map.controls.filter(function(e){return e!==s&&!e.containerControl}).forEach(function(e){e.div.classList.add(TC.Consts.classes.COLLAPSED)});s.map.trigger(TC.Consts.event.TOOLSOPEN);s.div.classList.remove(TC.Consts.classes.COLLAPSED)}})}});if(s.queries){TC.control.WFSQuery||TC.syncLoadJS(TC.apiLocation+"TC/Control/WFSQuery");e.queryControl=new TC.control.WFSQuery(null,s.queries instanceof Object?s.queries:null);s.map.addControl(e.queryControl)}a(s)})})};e.onExternalServiceAdded=function(e){};e.addUIEventListeners=function(){const e=this;e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("input[type=checkbox]",function(t){const n=t.target;var s=n;do{s=s.parentElement}while(s&&!s.matches("li."+e.CLASS+"-elm"));e.map.getLayer(s.dataset.layerId).setVisibility(n.checked);t.stopPropagation()}));const t=function(t){const n=t.target;var s=n;do{s=s.parentElement}while(s&&"LI"!==s.tagName);e.map.getLayer(s.dataset.layerId).setOpacity(n.value/100)};e.div.addEventListener("change",TC.EventTarget.listenerBySelector("input[type=range]",t));e.div.addEventListener("input",TC.EventTarget.listenerBySelector("input[type=range]",t));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-del:not(.disabled)",function(t){var n=t.target;do{n=n.parentElement}while(n&&"LI"!==n.tagName);const s=e.map.getLayer(n.dataset.layerId);e.map.removeLayer(s)}));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-del-all",function(t){TC.confirm(e.getLocaleString("layersRemove.confirm"),function(){e.getLayerUIElements().map(function(t){return e.map.getLayer(t.dataset.layerId)}).forEach(function(t){e.map.removeLayer(t)})})}));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-btn-info",function(t){const n=t.target;var s=n;do{s=s.parentElement}while(s&&"LI"!==s.tagName);const a=s.querySelector("."+e.CLASS+"-info"),r=e.map.getLayer(s.dataset.layerId);a.querySelectorAll("."+e.CLASS+"-legend img").forEach(function(t){e.styleLegendImage(t,r)});a.classList.toggle(TC.Consts.classes.HIDDEN);if(s.querySelector('input[type="checkbox"]').checked){s.querySelector("."+e.CLASS+"-dd").classList.toggle(TC.Consts.classes.HIDDEN,!a.classList.contains(TC.Consts.classes.HIDDEN))}n.classList.toggle(TC.Consts.classes.CHECKED)}));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-btn-query",function(t){if(t.target.classList.contains("tc-unavailable")||t.target.classList.contains("tc-loading"))return;var n=t.target;do{n=n.parentElement}while(n&&"LI"!==n.tagName);const s=e.map.getLayer(n.dataset.layerId);e.queryControl.renderModalDialog(s)}))};e.updateLayerVisibility=function(e){const n=this,s=t(n,e);if(s){const t=e.getVisibility();s.querySelector('input[type="checkbox"]').checked=t;const a=s.querySelector("."+n.CLASS+"-del"),r=s.querySelector("."+n.CLASS+"-info"),o=s.querySelector("."+n.CLASS+"-dd");if(t){a.classList.add(TC.Consts.classes.HIDDEN);r.classList.contains(TC.Consts.classes.HIDDEN)&&o.classList.remove(TC.Consts.classes.HIDDEN)}else{a.classList.remove(TC.Consts.classes.HIDDEN);r.classList.contains(TC.Consts.classes.HIDDEN)&&o.classList.add(TC.Consts.classes.HIDDEN)}}};e.updateLayerTree=function(e){var t=this;if(!e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(t,e);for(var a=!1,o=0,i=t.layers.length;o<i;o++)if(e===t.layers[o]){a=!0;break}if(!a){var l=t.CLASS+"-elm";t.layers.push(e);TC.loadJSInOrder(!window.dust,TC.url.templating,function(){var n,s=e.title||e.wrap.getServiceTitle(),a={title:e.options.hideTitle?"":s,hide:!(!e.renderOptions||!e.renderOptions.hide),opacity:e.renderOptions&&e.renderOptions.opacity?100*e.renderOptions.opacity:100,customLegend:e.customLegend,unremovable:e.unremovable},o=e.isRaster();if(o){a.layerNames=e.layerNames;var i=e.getPath();i.shift();a.path=i;var c=e.names[0],d=e.wrap.getInfo(c);a.legend=d.legend;a.abstract=d.abstract;var u,y=d.hasOwnProperty("abstract")||d.hasOwnProperty("legend")||d.hasOwnProperty("metadata");if(e.tree&&e.tree.children&&e.tree.children.length&&e.tree.children[0].children&&e.tree.children[0].children.length)u=null;else if(u=d.metadata)for(var C=0,p=u.length;C<p;C++){var f=u[C];f.formatDescription=t.getLocaleString(TC.Util.getSimpleMimeType(f.format))||t.getLocaleString("viewMetadata")}a.metadata=u;t.queries&&(n=r(e))}(function(e){return new Promise(function(t,n){e&&e.options.method&&"POST"===e.options.method?e.getLegendGraphicImage().then(function(e){t(e)}).catch(function(e){TC.error(e)}):t()})})(e).then(function(s){s&&(legend.src=s);dust.render(l,a,function(s,a){const r=(new DOMParser).parseFromString(a,"text/html").body.firstChild;var i,l=!1;if(o&&!(l=e.names.length>1))for(var d=e.wrap.getAllLayerNodes(),u=0;u<d.length;u++){var C=d[u];if(e.wrap.getName(C)===c){i=C;e.wrap.getLayerNodes(C).length>0&&(l=!0);break}}const p=r.querySelector("."+t.CLASS+"-type"),f=l?t.CLASS+"-type-grp":t.CLASS+"-type-sgl";p.classList.add(f);y||r.querySelector("."+t.CLASS+"-btn-info").classList.add(TC.Consts.classes.HIDDEN);if(i){e.wrap.normalizeLayerNode(i);dust.render(f,i,function(e,n){var s;p.addEventListener("mouseover",function(e){const a=t.map.div,r=p.getBoundingClientRect();(s=document.createElement("div")).classList.add(t.CLASS+"-tip");s.innerHTML=n;s.style.top=r.top-a.offsetTop+"px";s.style.right=a.offsetWidth-(r.left-a.offsetLeft)+"px";a.appendChild(s)});p.addEventListener("mouseout",function(e){s.parentElement.removeChild(s)})})}const m=t.div.querySelector("ul");r.dataset.layerId=e.id;const g=t.getLayerUIElements(),L=t.map.workLayers.filter(function(e){return!e.stealth}),h=L.indexOf(e);for(var S=!1,v=(u=0,g.length);u<v;u++){const e=g[u];if(L.indexOf(t.map.getLayer(e.dataset.layerId))<h){e.insertAdjacentElement("beforebegin",r);S=!0;break}}S||m.appendChild(r);n&&n(r);t.updateScale()})})});var c=n(t);const a=t.div.querySelector("."+t.CLASS+"-n"),o=t.div.querySelector("."+t.CLASS+"-empty"),i=t.div.querySelector("."+t.CLASS+"-content");a.textContent=c;if(c>0){a.classList.add(TC.Consts.classes.VISIBLE);o.classList.add(TC.Consts.classes.HIDDEN);i.classList.remove(TC.Consts.classes.HIDDEN)}else{a.classList.remove(TC.Consts.classes.VISIBLE);o.classList.remove(TC.Consts.classes.HIDDEN);i.classList.add(TC.Consts.classes.HIDDEN)}t.div.querySelector("."+t.CLASS+"-del-all").classList.toggle(TC.Consts.classes.HIDDEN,!s(t))}}};e.updateScale=function(){var e=this;e.getLayerUIElements().forEach(function(t){var n=e.map.getLayer(t.dataset.layerId);if(n.names){for(var s=!1,a=0;a<n.names.length;a++)if(n.isVisibleByScale(n.names[a])){s=!0;break}t.classList.toggle(e.CLASS+"-elm-notvisible",!s)}})};e.updateLayerOrder=function(e,n,s){const a=this;a.map.workLayers.filter(function(e){return!e.stealth}).forEach(function(e){const n=t(a,e);n&&n.parentElement.firstChild.insertAdjacentElement("beforebegin",n)})};e.removeLayer=function(e){var t=this.layers.indexOf(e);t>=0&&this.layers.splice(t,1);this.getLayerUIElements().forEach(function(t){t.dataset.layerId===e.id&&t.parentElement.removeChild(t)});const a=this.div.querySelector("."+this.CLASS+"-content"),r=this.div.querySelector("."+this.CLASS+"-empty"),o=this.div.querySelector("."+this.CLASS+"-n");var i=n(this);o.textContent=i;if(i>0){a.classList.remove(TC.Consts.classes.HIDDEN);r.classList.add(TC.Consts.classes.HIDDEN);o.classList.add(TC.Consts.classes.VISIBLE)}else{s(this)&&this.div.querySelector("."+this.CLASS+"-del-all").classList.add(TC.Consts.classes.HIDDEN);a.classList.add(TC.Consts.classes.HIDDEN);r.classList.remove(TC.Consts.classes.HIDDEN);o.classList.remove(TC.Consts.classes.VISIBLE)}};e.getLayerUIElements=function(){return Array.from(this.div.querySelectorAll(`ul > li.${this.CLASS}-elm`))};const r=function(t){var n,s=null,a=new Promise(function(e,t){s=e});a.then(function(t){(n=document.createElement("div")).classList.add(e.CLASS+"-btn-query");n.classList.add(TC.Consts.classes.LOADING);n.setAttribute("title",e.getLocaleString("query.tooltipMagnifBtn"));t.querySelector("."+e.CLASS+"-btn-info").insertAdjacentElement("afterend",n)});var r=t.getWFSCapabilitiesPromise();const o=function(){if(n){n.classList.remove(TC.Consts.classes.LOADING);n.classList.add("tc-unavailable")}console.log("El servicio "+(t.title||t.tree.title)+" no tiene disponible el WFS")};Promise.all([r,a]).then(function(){var e=arguments[0][0];if(n){n.classList.remove(TC.Consts.classes.LOADING);var s=t.getDisgregatedLayerNames();if(1===s.length&&!e.FeatureTypes.hasOwnProperty(s[0].substring(s[0].indexOf(":")+1))){n.classList.add("tc-unavailable");console.log("El servicio WFS de "+(t.title||t.tree.title)+" no dispone de la capa "+s[0])}}}).catch(o);r.catch(o);return s}}();
//# sourceMappingURL=../maps/control/WorkLayerManager.min.js.map