TC.control=TC.control||{};TC.control.TOC||TC.syncLoadJS(TC.apiLocation+"TC/control/TOC");TC.control.WorkLayerManager=function(e){TC.control.TOC.apply(this,arguments);this.layers=[];this.layerTools=[]};TC.inherit(TC.control.WorkLayerManager,TC.control.TOC);!function(){var e=TC.control.WorkLayerManager.prototype;e.CLASS="tc-ctl-wlm";e.CLICKEVENT="click";TC.Consts.classes.DRAG=TC.Consts.classes.DRAG||"tc-drag";TC.Consts.classes.DRAGEND=TC.Consts.classes.DRAGEND||"tc-dragend";TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc";e.template={};e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"loadedLayers"}).w('<span class="tc-ctl-wlm-n"></span><button class="tc-ctl-wlm-del-all tc-hidden" title="').h("i18n",t,{},{$key:"removeAllLayersFromMap"}).w('"></button></h2><div class="tc-ctl-wlm-empty">').h("i18n",t,{},{$key:"noData"}).w('</div><div class="tc-ctl-wlm-content tc-hidden"><form><ul>').s(t.get(["workLayers"],!1),t,{block:n},{}).w("</ul></form></div>")}t.__dustBody=!0;function n(e,t){return e.p("tc-ctl-wlm-elm",t,t.rebase(t.getPath(!0,[])),{})}n.__dustBody=!0;return t};e.template[e.CLASS+"-elm"]=function(){dust.register(e.CLASS+"-elm",t);function t(e,t){return e.w('<li class="tc-ctl-wlm-elm" tabindex="-1"><div class="tc-ctl-wlm-lyr">').x(t.get(["path"],!1),t,{block:n},{}).w('</div><div class="tc-ctl-wlm-type"></div><div class="tc-ctl-wlm-path" title="').s(t.get(["path"],!1),t,{else:s,block:r},{}).w('">').s(t.get(["path"],!1),t,{else:o,block:i},{}).w('</div><div class="tc-ctl-wlm-buttons"><div class="tc-ctl-wlm-btn-info" title="').h("i18n",t,{},{$key:"infoFromThisLayer"}).w('"></div><div class="tc-ctl-wlm-tools"></div><input type="range" value="').f(t.get(["opacity"],!1),t,"h").w('" title="').h("i18n",t,{},{$key:"transparencyOfThisLayer"}).w('" /><input id="tc-ctl-wlm-tools-visibility-').f(t.get(["id"],!1),t,"h").w('" type="checkbox" ').nx(t.get(["hide"],!1),t,{block:c},{}).w(' title="').h("i18n",t,{},{$key:"visibilityOfThisLayer"}).w('" /><label for="tc-ctl-wlm-tools-visibility-').f(t.get(["id"],!1),t,"h").w('" title="').h("i18n",t,{},{$key:"visibilityOfThisLayer"}).w('">').h("i18n",t,{},{$key:"visibilityOfThisLayer"}).w('</label><button class="tc-ctl-wlm-btn-del" ').x(t.get(["unremovable"],!1),t,{else:d,block:u},{}).w(">").h("i18n",t,{},{$key:"removeLayerFromMap"}).w('</button></div><div class="tc-ctl-wlm-info tc-hidden">').x(t.get(["abstract"],!1),t,{block:y},{}).x(t.get(["customLegend"],!1),t,{else:f,block:g},{}).x(t.get(["metadata"],!1),t,{block:h},{}).w('</div><div class="tc-ctl-wlm-dd" title="').h("i18n",t,{},{$key:"dragToReorder"}).w('"></div></li>')}t.__dustBody=!0;function n(e,t){return e.f(t.get(["title"],!1),t,"h")}n.__dustBody=!0;function s(e,t){return e.f(t.get(["title"],!1),t,"h")}s.__dustBody=!0;function r(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:a},{})}r.__dustBody=!0;function a(e,t){return e.w(" &bull; ")}a.__dustBody=!0;function o(e,t){return e.f(t.get(["title"],!1),t,"h")}o.__dustBody=!0;function i(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:l},{})}i.__dustBody=!0;function l(e,t){return e.w(" &bull; ")}l.__dustBody=!0;function c(e,t){return e.w('checked="checked"')}c.__dustBody=!0;function d(e,t){return e.w('title="').h("i18n",t,{},{$key:"removeLayerFromMap"}).w('"')}d.__dustBody=!0;function u(e,t){return e.w("disabled")}u.__dustBody=!0;function y(e,t){return e.w('<div class="tc-ctl-wlm-abstract"><h4>').h("i18n",t,{},{$key:"abstract"}).w("</h4><div><pre>").f(t.get(["abstract"],!1),t,"h",["s"]).w("</pre></div></div>")}y.__dustBody=!0;function f(e,t){return e.x(t.get(["legend"],!1),t,{block:p},{})}f.__dustBody=!0;function p(e,t){return e.w('<div class="tc-ctl-wlm-legend" data-layer-name="').f(t.get(["layerNames"],!1),t,"h").w('"><h4>').h("i18n",t,{},{$key:"content"}).w("</h4>").s(t.get(["legend"],!1),t,{block:m},{}).w("</div>")}p.__dustBody=!0;function m(e,t){return e.w("<div><p>").f(t.get(["title"],!1),t,"h").w('</p><img data-img="').f(t.get(["src"],!1),t,"h").w('" /></div>')}m.__dustBody=!0;function g(e,t){return e.w('<ul class="tc-ctl-wlm-custom-legend">').f(t.get(["customLegend"],!1),t,"h",["s"]).w("</ul>")}g.__dustBody=!0;function h(e,t){return e.w('<div class="tc-ctl-wlm-metadata"><h4>').h("i18n",t,{},{$key:"metadata"}).w("</h4><ul>").s(t.get(["metadata"],!1),t,{block:C},{}).w("</ul></div>")}h.__dustBody=!0;function C(e,t){return e.w('<li><a href="').f(t.get(["url"],!1),t,"h",["s"]).w('" type="').f(t.get(["format"],!1),t,"h").w('" title="').f(t.get(["formatDescription"],!1),t,"h").w('" target="_blank">').f(t.get(["formatDescription"],!1),t,"h").w("</a></li>")}C.__dustBody=!0;return t};e.template[e.CLASS+"-type-sgl"]=function(){dust.register(e.CLASS+"-type-sgl",t);function t(e,t){return e.h("i18n",t,{},{$key:"singleLayer"})}t.__dustBody=!0;return t};e.template[e.CLASS+"-type-grp"]=function(){dust.register(e.CLASS+"-type-grp",t);function t(e,t){return e.w("<div>").h("i18n",t,{},{$key:"groupLayerThatContains"}).w(":</div><ul>").s(t.get(["Layer"],!1),t,{block:n},{}).w("</ul>")}t.__dustBody=!0;function n(e,t){return e.p("tc-ctl-wlm-type-grp-node",t,t.rebase(t.getPath(!0,[])),{})}n.__dustBody=!0;return t};e.template[e.CLASS+"-type-grp-node"]=function(){dust.register(e.CLASS+"-type-grp-node",t);function t(e,t){return e.w('<li class="tc-ctl-ltoc-tip-grp-elm"><span>').f(t.get(["Title"],!1),t,"h").w("</span><ul>").s(t.get(["Layer"],!1),t,{block:n},{}).w("</ul></li>")}t.__dustBody=!0;function n(e,t){return e.p("tc-ctl-wlm-type-grp-node",t,t.rebase(t.getPath(!0,[])),{})}n.__dustBody=!0;return t};const t=function(e,t){return e.getLayerUIElements().filter(function(e){return e.dataset.layerId===t.id})[0]};var n=function(e){return e.layers.length};const s=function(e){return!e.layers.some(function(e){return e.unremovable})},r=function(e,t,n,s,r){const a=e.getLayerUIElements();var o;if(s>n)o=a[s-1];else{if(!(s<n))return;o=a[s+1]}const i=e.map.getLayer(t.dataset.layerId),l=e.map.getLayer(o.dataset.layerId);for(var c=-1,d=0;d<e.map.layers.length;d++)if(l===e.map.layers[d]){c=d;break}c>=1&&c<e.map.layers.length&&e.map.insertLayer(i,c,r)};e.render=function(e,t){const n=this;return n._set1stRenderPromise(n.map?n.renderData(t?TC.Util.extend(n.map.getLayerTree(),t):n.map.getLayerTree(),function(){n.addUIEventListeners();TC.loadJS(!window.Sortable,[TC.apiLocation+"lib/sortable/Sortable.min.js"],function(){n.map.workLayers.filter(function(e){return!e.stealth}).forEach(function(e){n.updateLayerTree(e)});const t=n.div.querySelector("ul");n._sortable=Sortable.create(t,{handle:"."+n.CLASS+"-dd",animation:150,onSort:function(e){r(n,e.item,e.oldIndex,e.newIndex)}});t.addEventListener("keydown",TC.EventTarget.listenerBySelector("li",function(e){for(var t=e.target;"LI"!==t.tagName;)if(!(t=t.parentElement))return;const s=function(e,s){const a=n._sortable.toArray(),o=a[e];a[e]=a[s];a[s]=o;n._sortable.sort(a);r(n,t,e,s)},a=n.getLayerUIElements(),o=a.indexOf(t);switch(!0){case/Up$/.test(e.key):if(o>0){s(o,o-1);t.focus();e.stopPropagation()}break;case/Down$/.test(e.key):if(o<a.length-1){s(o,o+1);t.focus();e.stopPropagation()}break;case/Enter$/.test(e.key):t.blur();e.stopPropagation()}}));"function"==typeof e&&e()})}):Promise.reject(Error("Cannot render: control has no map")))};e.register=function(e){const n=this;return new Promise(function(s,r){TC.control.TOC.prototype.register.call(n,e).then(function(){e.loaded(function(){n.updateScale()});e.on(TC.Consts.event.LAYEROPACITY,function(e){const s=t(n,e.layer);s&&(s.querySelector("input[type=range]").value=Math.round(100*e.opacity))}).on(TC.Consts.event.FEATURESIMPORT,function(t){var s=t.fileName;if(t.features&&t.features.length>0){var r="."+TC.Consts.format.GPX.toLowerCase();if(t.fileName.toLowerCase().indexOf(r)===t.fileName.length-r.length)return;e.one(TC.Consts.event.LAYERADD,function(e){if(e&&e.layer&&e.layer.title==s){n.map&&n.map.layout&&n.map.layout.accordion&&n.div.classList.contains(TC.Consts.classes.COLLAPSED)&&n.map.controls.filter(function(e){return e!==n&&!e.containerControl}).forEach(function(e){e.div.classList.add(TC.Consts.classes.COLLAPSED)});n.map.trigger(TC.Consts.event.TOOLSOPEN);n.div.classList.remove(TC.Consts.classes.COLLAPSED)}})}});s(n)})})};e.onExternalServiceAdded=function(e){};e.addUIEventListeners=function(){const e=this;e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("input[type=checkbox]",function(t){const n=t.target;var s=n;do{s=s.parentElement}while(s&&!s.matches("li."+e.CLASS+"-elm"));e.map.getLayer(s.dataset.layerId).setVisibility(n.checked);t.stopPropagation()}));const t=function(t){const n=t.target;var s=n;do{s=s.parentElement}while(s&&"LI"!==s.tagName);e.map.getLayer(s.dataset.layerId).setOpacity(n.value/100)};e.div.addEventListener("change",TC.EventTarget.listenerBySelector("input[type=range]",t));e.div.addEventListener("input",TC.EventTarget.listenerBySelector("input[type=range]",t));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector(`.${e.CLASS}-btn-del:not(.disabled)`,function(t){var n=t.target;do{n=n.parentElement}while(n&&"LI"!==n.tagName);const s=e.map.getLayer(n.dataset.layerId);e.map.removeLayer(s)}));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-del-all",function(t){TC.confirm(e.getLocaleString("layersRemove.confirm"),function(){e.getLayerUIElements().map(function(t){return e.map.getLayer(t.dataset.layerId)}).forEach(function(t){e.map.removeLayer(t)})})}));e.div.addEventListener(e.CLICKEVENT,TC.EventTarget.listenerBySelector("."+e.CLASS+"-btn-info",function(t){const n=t.target;var s=n;do{s=s.parentElement}while(s&&"LI"!==s.tagName);const r=s.querySelector("."+e.CLASS+"-info"),a=e.map.getLayer(s.dataset.layerId);r.querySelectorAll("."+e.CLASS+"-legend img").forEach(function(t){e.styleLegendImage(t,a)});r.classList.toggle(TC.Consts.classes.HIDDEN);if(s.querySelector('input[type="checkbox"]').checked){s.querySelector("."+e.CLASS+"-dd").classList.toggle(TC.Consts.classes.HIDDEN,!r.classList.contains(TC.Consts.classes.HIDDEN))}n.classList.toggle(TC.Consts.classes.CHECKED)}))};e.updateLayerVisibility=function(e){const n=t(this,e);if(n){const t=e.getVisibility();n.querySelector('input[type="checkbox"]').checked=t}};e.updateLayerTree=function(e){var t=this;if(!e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(t,e);for(var r=!1,a=0,o=t.layers.length;a<o;a++)if(e===t.layers[a]){r=!0;break}if(!r){t.layers.push(e);var i=e.title||e.wrap.getServiceTitle(),l={title:e.options.hideTitle?"":i,hide:!(!e.renderOptions||!e.renderOptions.hide),opacity:e.renderOptions&&e.renderOptions.opacity?100*e.renderOptions.opacity:100,customLegend:e.customLegend,unremovable:e.unremovable,id:e.id},c=e.isRaster();if(c){l.layerNames=e.layerNames;var d=e.getPath();d.shift();l.path=d;var u=e.names[0],y=e.wrap.getInfo(u);l.legend=y.legend;l.abstract=y.abstract;var f,p=y.hasOwnProperty("abstract")||y.hasOwnProperty("legend")||y.hasOwnProperty("metadata");if(e.tree&&e.tree.children&&e.tree.children.length&&e.tree.children[0].children&&e.tree.children[0].children.length)f=null;else if(f=y.metadata){var m=0;for(o=f.length;m<o;m++){var g=f[m];g.formatDescription=t.getLocaleString(TC.Util.getSimpleMimeType(g.format))||t.getLocaleString("viewMetadata")}}l.metadata=f}(function(e){return new Promise(function(t,n){e&&e.options.method&&"POST"===e.options.method?e.getLegendGraphicImage().then(function(e){t(e)}).catch(function(e){TC.error(e)}):t()})})(e).then(function(n){n&&(legend.src=n);t.getRenderedHtml(t.CLASS+"-elm",l).then(function(n){const s=(new DOMParser).parseFromString(n,"text/html").body.firstChild;var r,a=!1;if(c&&!(a=e.names.length>1))for(var o=e.wrap.getAllLayerNodes(),i=0;i<o.length;i++){var l=o[i];if(e.wrap.getName(l)===u){r=l;e.wrap.getLayerNodes(l).length>0&&(a=!0);break}}const d=s.querySelector("."+t.CLASS+"-type"),y=a?t.CLASS+"-type-grp":t.CLASS+"-type-sgl";d.classList.add(y);p||s.querySelector("."+t.CLASS+"-btn-info").classList.add(TC.Consts.classes.HIDDEN);if(r){e.wrap.normalizeLayerNode(r);t.getRenderedHtml(y,r).then(function(e){var n;d.addEventListener("mouseover",function(s){const r=t.map.div,a=d.getBoundingClientRect();(n=document.createElement("div")).classList.add(t.CLASS+"-tip");n.innerHTML=e;n.style.top=a.top-r.offsetTop+"px";n.style.right=r.offsetWidth-(a.left-r.offsetLeft)+"px";r.appendChild(n)});d.addEventListener("mouseout",function(e){n.parentElement.removeChild(n)})})}const f=t.div.querySelector("ul");s.dataset.layerId=e.id;const m=t.getLayerUIElements(),g=t.map.workLayers.filter(function(e){return!e.stealth}),h=g.indexOf(e);t.layerTools.forEach(e=>t.addLayerToolUI(s,e));for(var C=!1,L=(i=0,m.length);i<L;i++){const e=m[i];if(g.indexOf(t.map.getLayer(e.dataset.layerId))<h){e.insertAdjacentElement("beforebegin",s);C=!0;break}}C||f.appendChild(s);void 0;t.updateScale()})});var h=n(t);const r=t.div.querySelector("."+t.CLASS+"-n"),a=t.div.querySelector("."+t.CLASS+"-empty"),C=t.div.querySelector("."+t.CLASS+"-content");r.textContent=h;if(h>0){r.classList.add(TC.Consts.classes.VISIBLE);a.classList.add(TC.Consts.classes.HIDDEN);C.classList.remove(TC.Consts.classes.HIDDEN)}else{r.classList.remove(TC.Consts.classes.VISIBLE);a.classList.remove(TC.Consts.classes.HIDDEN);C.classList.add(TC.Consts.classes.HIDDEN)}t.div.querySelector("."+t.CLASS+"-del-all").classList.toggle(TC.Consts.classes.HIDDEN,!s(t))}}};e.updateScale=function(){var e=this;e.getLayerUIElements().forEach(function(t){var n=e.map.getLayer(t.dataset.layerId);if(n&&n.names){for(var s=!1,r=0;r<n.names.length;r++)if(n.isVisibleByScale(n.names[r])){s=!0;break}t.classList.toggle(e.CLASS+"-elm-notvisible",!s)}})};e.updateLayerOrder=function(e,n,s){const r=this;r.map.workLayers.filter(function(e){return!e.stealth}).forEach(function(e){const n=t(r,e);n&&n.parentElement.firstChild.insertAdjacentElement("beforebegin",n)})};e.removeLayer=function(e){var t=this.layers.indexOf(e);t>=0&&this.layers.splice(t,1);this.getLayerUIElements().forEach(function(t){t.dataset.layerId===e.id&&t.parentElement.removeChild(t)});const r=this.div.querySelector("."+this.CLASS+"-content"),a=this.div.querySelector("."+this.CLASS+"-empty"),o=this.div.querySelector("."+this.CLASS+"-n");var i=n(this);o.textContent=i;if(i>0){r.classList.remove(TC.Consts.classes.HIDDEN);a.classList.add(TC.Consts.classes.HIDDEN);o.classList.add(TC.Consts.classes.VISIBLE)}else{s(this)&&this.div.querySelector("."+this.CLASS+"-del-all").classList.add(TC.Consts.classes.HIDDEN);r.classList.add(TC.Consts.classes.HIDDEN);a.classList.remove(TC.Consts.classes.HIDDEN);o.classList.remove(TC.Consts.classes.VISIBLE)}};e.getLayerUIElements=function(){return Array.from(this.div.querySelectorAll(`ul > li.${this.CLASS}-elm`))};e.addLayerToolUI=function(e,t){const n=this;if(TC.Util.isFunction(t.renderFn)){const s=t.renderFn(e.querySelector(`.${n.CLASS}-tools`),e.dataset.layerId);if(s){TC.Util.isFunction(t.actionFn)&&s.addEventListener(TC.Consts.event.CLICK,function(e){e.preventDefault();t.actionFn.call(s)});TC.Util.isFunction(t.updateFn)&&t.updateEvents&&map.on(t.updateEvents.join(" "),function(e){e.layer&&e.layer.id!==s.dataset.layerId||t.updateFn.call(s,e)})}}};e.addLayerTool=function(e){const t=this;t.layerTools.push(e);t.getLayerUIElements().forEach(function(n){t.addLayerToolUI(n,e)})}}();
//# sourceMappingURL=../maps/control/WorkLayerManager.min.js.map