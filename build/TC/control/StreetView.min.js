TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){TC.Consts.url.GOOGLEMAPS="//maps.googleapis.com/maps/api/js?v=3";var e=TC.Consts.url.GOOGLEMAPS;TC.Cfg.proxyExceptions=TC.Cfg.proxyExceptions||[];TC.Cfg.proxyExceptions.push(TC.Consts.url.GOOGLEMAPS);TC.control.StreetView=function(){this._sv=null;this._mapActiveControl=null;TC.Control.apply(this,arguments);this.options.googleMapsKey&&(e+="&key="+this.options.googleMapsKey);this.viewDiv=null;this._startLonLat=null};TC.inherit(TC.control.StreetView,TC.Control);var t=TC.control.StreetView.prototype;t.CLASS="tc-ctl-sv";t.template={};t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(e,t){return e.w('<div class="tc-ctl-sv-btn" title="').h("i18n",t,{},{$key:"sv.tip"}).w('"><div class="tc-ctl-sv-drag"></div></div>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-view"]=function(){dust.register(t.CLASS+"-view",e);function e(e,t){return e.w('<div class="tc-ctl-sv-btn-close" title="').h("i18n",t,{},{$key:"closeStreetView"}).w('"></div>')}e.__dustBody=!0;return e};const i=function(){var e=document.createEvent("HTMLEvents");e.initEvent("resize",!0,!1);this.map.div.querySelector("canvas").dispatchEvent(e)};var s=function(e){const t=e.viewDiv,s=function(){t.removeEventListener("transitionend",s);i.call(e)};t.addEventListener("transitionend",s);setTimeout(function(){i.call(e)},1e3);e.layer.clearFeatures();e.div.querySelector("."+e.CLASS+"-btn").classList.remove(TC.Consts.classes.CHECKED);e.div.querySelector("."+e.CLASS+"-drag").classList.remove(TC.Consts.classes.HIDDEN);e.map.div.classList.remove(e.CLASS+"-active");e._startLonLat=null};t.register=function(e){const t=this;if(!t.viewDiv){t.viewDiv=TC.Util.getDiv(t.options.viewDiv);t.viewDiv.classList.add(t.CLASS+"-view",TC.Consts.classes.HIDDEN);t.options.viewDiv||e.div.insertAdjacentElement("beforebegin",t.viewDiv)}const i=TC.Control.prototype.register.call(t,e);t.layer=null;for(var o=t.getUID(),n=0;n<e.workLayers.length;n++){var r=e.workLayers[n];if(r.type===TC.Consts.layerType.VECTOR&&r.id===o){t.layer=r;break}}t.layer||e.loaded(function(){e.addLayer({id:o,owner:t,stealth:!0,type:TC.Consts.layerType.VECTOR}).then(function(e){t.layer=e})});t.renderPromise().then(function(){TC.loadJS(!window.Draggabilly,[TC.apiLocation+TC.Consts.url.DRAGGABILLY],function(){const e=new Draggabilly(t.div.querySelector("."+t.CLASS+"-drag"),{containment:t.map.div});e.on("dragStart",function(e){!function(e){e.div.querySelector("."+e.CLASS+"-btn").classList.add(TC.Consts.classes.CHECKED);e.map.div.classList.add(e.CLASS+"-active")}(t)});e.on("dragEnd",function(i){!function(e){var t=!1;const i=e.div.querySelector("."+e.CLASS+"-btn"),o=e.div.querySelector("."+e.CLASS+"-drag");var n=i.getBoundingClientRect(),r=o.getBoundingClientRect();o.classList.add(TC.Consts.classes.HIDDEN);if(r.top<n.top||r.top>n.bottom||r.left<n.left||r.left>n.right){t=!0;for(var a=e.map.getExtent(),l=[a[2],a[3]],c=0;c<16;c++)e.layer.addMarker(l,{cssClass:"tc-marker-sv-"+c,width:48,height:48,anchor:[0,1]});var v=e.map.div.getBoundingClientRect(),d=(r.left*window.devicePixelRatio+r.right*window.devicePixelRatio)/2-v.left*window.devicePixelRatio,p=r.bottom*window.devicePixelRatio-v.top*window.devicePixelRatio,C=e.map.wrap.getCoordinateFromPixel([d,p]);e.callback(C)}else s(e)}(t);e.setPosition(0,0)})});t.viewDiv.querySelector("."+t.CLASS+"-btn-close").addEventListener(TC.Consts.event.CLICK,function(e){e.stopPropagation();t.closeView()})},function(e,t,i){TC.error("Error de renderizado StreetView")});return i};t.render=function(){const e=this;return e._set1stRenderPromise(new Promise(function(t,i){e.renderData(null,function(){e.getRenderedHtml(e.CLASS+"-view",null).then(function(i){setTimeout(function(){e.viewDiv.innerHTML=i;t(e)},300)}).catch(function(e){TC.error(e)})})}))};var o=0;t.callback=function(t){var n=this,r=function(e){if(n._sv){var t=e.getBounds();lonLat=TC.Util.reproject([(t[0]+t[2])/2,(t[1]+t[3])/2],n.map.crs,"EPSG:4326");n._sv.setPosition({lng:lonLat[0],lat:lonLat[1]})}},a=function(e){if(n._sv){var t=e.getBounds();n._startLonLat=TC.Util.reproject([(t[0]+t[2])/2,(t[1]+t[3])/2],n.map.crs,"EPSG:4326")}},l=n.map.getLoadingIndicator();l&&(o=l.addWait(o));const c=n.map.div;var v=function(e,i){n.layer.clearFeatures();var s,o;if(e){var l=e.getPosition();s=TC.Util.reproject([l.lng(),l.lat()],"EPSG:4326",n.map.crs);o=e.getPov().heading}else{s=t;o=0}n.map.addMarker(s,{cssClass:"tc-marker-sv-"+(Math.round(16*o/360)+16)%16,width:48,height:48,anchor:[.4791666666666667,.7083333333333333],layer:n.layer,showsPopup:!1});Promise.all(n.map._markerPromises).then(function(){n.layer.wrap.setDraggable(!0,r,a)});if(i){var v=function(){n.map.setCenter(s)};c.classList.contains(TC.Consts.classes.COLLAPSED)?v():setTimeout(v,1200)}};TC.loadJS(!window.google||!google.maps,e,function(){if(window.google){v();const e=n.viewDiv,r=TC.Util.reproject(t,n.map.crs,"EPSG:4326"),a=new google.maps.LatLng(r[1],r[0]);(new google.maps.StreetViewService).getPanorama({location:a,preference:google.maps.StreetViewPreference.BEST},function(t,r){if(r!==google.maps.StreetViewStatus.OK){l&&l.removeWait(o);setTimeout(function(){TC.alert(r===google.maps.StreetViewStatus.ZERO_RESULTS?n.getLocaleString("noStreetView"):n.getLocaleString("streetViewUnknownError"));n.layer.wrap.setDraggable(!1);s(n)},100)}else{const t=function(s){if(n._transitioning&&("width"===s.propertyName||"height"===s.propertyName)){n._transitioning=!1;l&&l.removeWait(o);const s=document.createEvent("HTMLEvents");s.initEvent("resize",!1,!1);c.dispatchEvent(s);i.call(n);e.removeEventListener("transitionend",t);var r={position:a,pov:{heading:0,pitch:0},zoom:1,fullscreenControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},panControlOptions:{position:google.maps.ControlPosition.LEFT_TOP}};if(n._sv){n._sv.setOptions(r);n._sv.setVisible(!0)}else{n._sv=new google.maps.StreetViewPanorama(e,r);google.maps.event.addListener(n._sv,"position_changed",function(){v(n._sv,e.classList.contains(TC.Consts.classes.VISIBLE))});google.maps.event.addListener(n._sv,"pov_changed",function(){if(n.layer.features&&n.layer.features.length>0){var e=n.layer.features[0];delete e.options.url;e.options.cssClass="tc-marker-sv-"+(Math.round(16*n._sv.getPov().heading/360)+16)%16;e.setStyle(e.options);n.layer.refresh()}});google.maps.event.addListener(n._sv,"status_changed",function(){var e=n._sv.getStatus();if(e!==google.maps.StreetViewStatus.OK){n._sv.setVisible(!1);TC.alert(e===google.maps.StreetViewStatus.ZERO_RESULTS?n.getLocaleString("noStreetView"):n.getLocaleString("streetViewUnknownError"));if(n._startLonLat){n._sv.setVisible(!0);n._sv.setPosition({lng:n._startLonLat[0],lat:n._startLonLat[1]})}else{n.layer.wrap.setDraggable(!1);n.closeView()}}})}}};n._transitioning=!0;e.addEventListener("transitionend",t);if(!n.options.viewDiv){const e=c.getBoundingClientRect();n.viewDiv.style.height=e.height+"px";n.viewDiv.style.width=e.width+"px"}c.classList.add(TC.Consts.classes.COLLAPSED);e.style.left="";e.style.top="";e.classList.remove(TC.Consts.classes.HIDDEN);e.classList.add(TC.Consts.classes.VISIBLE);setTimeout(function(){t({propertyName:"width"})},1e3);const s=document.body.querySelector("header");s&&(s.style.display="none");if(n.map.activeControl){n._previousActiveControl=n.map.activeControl;n.map.activeControl.deactivate(!0)}v(n._sv)}})}else s(n)},!1,!0)};t.closeView=function(){const e=this,t=e.map.div,i=e.viewDiv,o=function(){t.classList.remove(TC.Consts.classes.COLLAPSED);const e=document.createEvent("HTMLEvents");e.initEvent("resize",!1,!1);t.dispatchEvent(e)},n=function(e){if("width"===e.propertyName||"height"===e.propertyName){i.removeEventListener("transitionend",n);o()}};i.removeEventListener("transitionend",n);i.addEventListener("transitionend",n);setTimeout(o,1e3);if(!e.options.viewDiv){e.viewDiv.style.removeProperty("height");e.viewDiv.style.removeProperty("width")}i.classList.add(TC.Consts.classes.HIDDEN);i.classList.remove(TC.Consts.classes.VISIBLE);e.div.querySelector("."+e.CLASS+"-drag").classList.remove(TC.Consts.classes.HIDDEN);e.layer.wrap.setDraggable(!1);s(e);e._sv.setVisible(!1);const r=document.body.querySelector("header");r&&(r.style.display="");e._previousActiveControl&&e._previousActiveControl.activate()}}();
//# sourceMappingURL=../maps/control/StreetView.min.js.map