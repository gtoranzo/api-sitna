TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){TC.Consts.url.GOOGLEMAPS="//maps.googleapis.com/maps/api/js?v=3";var e=TC.Consts.url.GOOGLEMAPS;TC.Cfg.proxyExceptions=TC.Cfg.proxyExceptions||[];TC.Cfg.proxyExceptions.push(TC.Consts.url.GOOGLEMAPS);TC.control.StreetView=function(){this._sv=null;this._mapActiveControl=null;TC.Control.apply(this,arguments);this.options.googleMapsKey&&(e+="&key="+this.options.googleMapsKey);this.viewDiv=null;this._startLonLat=null};TC.inherit(TC.control.StreetView,TC.Control);var t=TC.control.StreetView.prototype;t.CLASS="tc-ctl-sv";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/StreetView.html";t.template[t.CLASS+"-view"]=TC.apiLocation+"TC/templates/StreetViewView.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(e,t){return e.w('<div class="tc-ctl-sv-btn" title="').h("i18n",t,{},{$key:"sv.tip"}).w('"><div class="tc-ctl-sv-drag"></div></div>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-view"]=function(){dust.register(t.CLASS+"-view",e);function e(e,t){return e.w('<div class="tc-ctl-sv-btn-close" title="').h("i18n",t,{},{$key:"closeStreetView"}).w('"></div>')}e.__dustBody=!0;return e}}const s=function(){var e=document.createEvent("HTMLEvents");e.initEvent("resize",!0,!1);this.map.div.querySelector("canvas").dispatchEvent(e)};var n=function(e){const t=e.viewDiv,n=["webkitTransitionEnd","msTransitionEnd","oTransitionEnd","transitionend"],i=function(){TC.Util.detectSafari()||n.forEach(function(e){t.removeEventListener(e,i)});s.call(e)};TC.Util.detectSafari()?setTimeout(function(){s.call(e)},500):n.forEach(function(e){t.addEventListener(e,i)});e.layer.clearFeatures();e.div.querySelector("."+e.CLASS+"-btn").classList.remove(TC.Consts.classes.CHECKED);e.div.querySelector("."+e.CLASS+"-drag").classList.remove(TC.Consts.classes.HIDDEN);e.map.div.classList.remove(e.CLASS+"-active");e._startLonLat=null};t.register=function(e){const t=this;if(!t.viewDiv){t.viewDiv=TC.Util.getDiv(t.options.viewDiv);t.viewDiv.classList.add(t.CLASS+"-view");t.viewDiv.classList.add(TC.Consts.classes.HIDDEN);t.options.viewDiv||e.div.insertAdjacentElement("beforebegin",t.viewDiv)}const s=TC.Control.prototype.register.call(t,e);t.layer=null;for(var i=t.getUID(),o=0;o<e.workLayers.length;o++){var a=e.workLayers[o];if(a.type===TC.Consts.layerType.VECTOR&&a.id===i){t.layer=a;break}}t.layer||e.loaded(function(){e.addLayer({id:i,stealth:!0,type:TC.Consts.layerType.VECTOR}).then(function(e){t.layer=e})});t.renderPromise().then(function(){TC.loadJS(!window.Draggabilly,[TC.apiLocation+"lib/draggabilly/draggabilly.pkgd.min.js"],function(){const e=new Draggabilly(t.div.querySelector("."+t.CLASS+"-drag"),{containment:t.map.div});e.on("dragStart",function(e){!function(e){e.div.querySelector("."+e.CLASS+"-btn").classList.add(TC.Consts.classes.CHECKED);e.map.div.classList.add(e.CLASS+"-active")}(t)});e.on("dragEnd",function(s){!function(e){var t=!1;const s=e.div.querySelector("."+e.CLASS+"-btn"),i=e.div.querySelector("."+e.CLASS+"-drag");var o=s.getBoundingClientRect(),a=i.getBoundingClientRect();i.classList.add(TC.Consts.classes.HIDDEN);if(a.top<o.top||a.top>o.bottom||a.left<o.left||a.left>o.right){t=!0;for(var r=e.map.getExtent(),l=[r[2],r[3]],c=(new Array(16),0);c<16;c++)e.layer.addMarker(l,{cssClass:"tc-marker-sv-"+c,width:48,height:48,anchor:[0,1]});var v=e.map.div.getBoundingClientRect(),d=(a.left*window.devicePixelRatio+a.right*window.devicePixelRatio)/2-v.left*window.devicePixelRatio,C=a.bottom*window.devicePixelRatio-v.top*window.devicePixelRatio,p=e.map.wrap.getCoordinateFromPixel([d,C]);e.callback(p)}else n(e)}(t);e.setPosition(0,0)})});const e=t.viewDiv;e.querySelector("."+t.CLASS+"-btn-close").addEventListener(TC.Consts.event.CLICK,function(s){const i=t.map.div,o=function(){i.classList.remove(TC.Consts.classes.COLLAPSED);const e=document.createEvent("HTMLEvents");e.initEvent("resize",!1,!1);i.dispatchEvent(e)},a=function(t){if("width"===t.propertyName||"height"===t.propertyName){e.removeEventListener("transitionend",a);o()}};e.removeEventListener("transitionend",a);e.addEventListener("transitionend",a);setTimeout(o,1e3);e.classList.add(TC.Consts.classes.HIDDEN);e.classList.remove(TC.Consts.classes.VISIBLE);t.div.querySelector("."+t.CLASS+"-drag").classList.remove(TC.Consts.classes.HIDDEN);t.layer.wrap.setDraggable(!1);n(t);t._sv.setVisible(!1);s.stopPropagation();const r=document.body.querySelector("header");r&&(r.style.display="");t._previousActiveControl&&t._previousActiveControl.activate()})},function(e,t,s){TC.error("Error de renderizado StreetView")});return s};t.render=function(){const e=this;return e._set1stRenderPromise(new Promise(function(t,s){e.renderData(null,function(){if(dust.cache[e.CLASS+"-view"])dust.render(e.CLASS+"-view",null,function(s,n){setTimeout(function(){e.viewDiv.innerHTML=n;s&&TC.error(s);t(e)},300)});else{TC.error("No hay dust.cache para StreetView");t(e)}})}))};var i=0;t.callback=function(t){var o=this,a=function(e){if(o._sv){var t=e.getBounds();lonLat=TC.Util.reproject([(t[0]+t[2])/2,(t[1]+t[3])/2],o.map.crs,"EPSG:4326");o._sv.setPosition({lng:lonLat[0],lat:lonLat[1]})}},r=function(e){if(o._sv){var t=e.getBounds();o._startLonLat=[(t[0]+t[2])/2,(t[1]+t[3])/2]}},l=o.map.getLoadingIndicator();l&&(i=l.addWait(i));const c=o.map.div;var v=function(e,s){o.layer.clearFeatures();var n,i;if(e){var l=e.getPosition();n=TC.Util.reproject([l.lng(),l.lat()],"EPSG:4326",o.map.crs);i=e.getPov().heading}else{n=t;i=0}o.map.addMarker(n,{cssClass:"tc-marker-sv-"+(Math.round(16*i/360)+16)%16,width:48,height:48,anchor:[.4791666666666667,.7083333333333333],layer:o.layer,showsPopup:!1});Promise.all(o.map._markerPromises).then(function(){o.layer.wrap.setDraggable(!0,a,r)});if(s){var v=function(){o.map.setCenter(n)};c.classList.contains(TC.Consts.classes.COLLAPSED)?v():setTimeout(v,1200)}};TC.loadJS(!window.google||!google.maps,e,function(){if(window.google){v();const d=o.viewDiv;var e=TC.Util.reproject(t,o.map.crs,"EPSG:4326"),a=d.classList.contains(TC.Consts.classes.VISIBLE),r={position:new google.maps.LatLng(e[1],e[0]),pov:{heading:0,pitch:0},zoom:1,fullscreenControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},panControlOptions:{position:google.maps.ControlPosition.LEFT_TOP}};if(o._sv)o._sv.setOptions(r);else{o._sv=new google.maps.StreetViewPanorama(d,r);google.maps.event.addListener(o._sv,"position_changed",function(){v(o._sv,d.classList.contains(TC.Consts.classes.VISIBLE))});google.maps.event.addListener(o._sv,"pov_changed",function(){if(o.layer.features&&o.layer.features.length>0){var e=o.layer.features[0];delete e.options.url;e.options.cssClass="tc-marker-sv-"+(Math.round(16*o._sv.getPov().heading/360)+16)%16;e.setStyle(e.options);o.layer.refresh()}});google.maps.event.addListener(o._sv,"status_changed",function(){var e=o._sv.getStatus();l&&l.removeWait(i);if(e===google.maps.StreetViewStatus.OK){c.classList.add(TC.Consts.classes.COLLAPSED);const e=document.createEvent("HTMLEvents");e.initEvent("resize",!1,!1);c.dispatchEvent(e);const t=function(){google.maps.event.trigger(o._sv,"resize");s.call(o)};const n=function(e){if(("width"===e.propertyName||"height"===e.propertyName)&&!a){a=!0;d.removeEventListener("transitionend",n);t()}};d.removeEventListener("transitionend",n);d.addEventListener("transitionend",n);setTimeout(t,1e3);if(!d.classList.contains(TC.Consts.classes.VISIBLE)){o._sv.setVisible(!0);v(o._sv,!0);if(o.map.activeControl){o._previousActiveControl=o.map.activeControl;o.map.activeControl.deactivate(!0)}setTimeout(function(){d.style.left="";d.style.top="";d.classList.remove(TC.Consts.classes.HIDDEN);d.classList.add(TC.Consts.classes.VISIBLE)},200);const e=document.body.querySelector("header");e&&(e.style.display="none")}}else{TC.alert(e===google.maps.StreetViewStatus.ZERO_RESULTS?o.getLocaleString("noStreetView"):o.getLocaleString("streetViewUnknownError"));if(o._startLonLat)o.callback(o._startLonLat);else{o.layer.wrap.setDraggable(!1);n(o)}}})}v(o._sv)}else n(o)},!1,!0)}}();
//# sourceMappingURL=../maps/control/StreetView.min.js.map
