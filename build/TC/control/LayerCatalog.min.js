TC.control=TC.control||{};TC.control.ProjectionSelector||TC.syncLoadJS(TC.apiLocation+"TC/control/ProjectionSelector");!function(){TC.control.LayerCatalog=function(){this.layers=[];this.searchInit=!1;TC.control.ProjectionSelector.apply(this,arguments);this._selectors={LAYER_ROOT:"div."+this.CLASS+"-tree > ul."+this.CLASS+"-branch > li."+this.CLASS+"-node"};TC.Consts.classes.SELECTABLE||(TC.Consts.classes.SELECTABLE="tc-selectable");TC.Consts.classes.INCOMPATIBLE||(TC.Consts.classes.INCOMPATIBLE="tc-incompatible");TC.Consts.classes.ACTIVE||(TC.Consts.classes.ACTIVE="tc-active")};TC.inherit(TC.control.LayerCatalog,TC.control.ProjectionSelector);var t=TC.control.LayerCatalog.prototype;t.CLASS="tc-ctl-lcat";t.template={};t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"availableLayers"}).x(e.get(["enableSearch"],!1),e,{block:s},{}).w('</h2><div class="tc-ctl-lcat-search tc-hidden tc-collapsed"><div class="tc-group"><input type="search" class="tc-ctl-lcat-input tc-textbox" placeholder="').h("i18n",e,{},{$key:"textToSearchInLayers"}).w('"></div><ul></ul></div><div class="tc-ctl-lcat-tree">').x(e.get(["layerTrees"],!1),e,{else:r,block:i},{}).w('</div><div class="tc-ctl-lcat-info tc-hidden">').p("tc-ctl-lcat-info",e,e.rebase(e.getPath(!0,[])),{}).w("</div>")}e.__dustBody=!0;function s(t,e){return t.x(e.get(["layerTrees"],!1),e,{block:a},{}).x(e.get(["layers"],!1),e,{block:n},{})}s.__dustBody=!0;function a(t,e){return t.w('<button class="tc-ctl-lcat-btn-search" title="').h("i18n",e,{},{$key:"searchLayersByText"}).w('"></button>')}a.__dustBody=!0;function n(t,e){return t.w('<button class="tc-ctl-lcat-btn-search" title="').h("i18n",e,{},{$key:"searchLayersByText"}).w('"></button>')}n.__dustBody=!0;function r(t,e){return t.x(e.get(["layers"],!1),e,{else:o,block:l},{})}r.__dustBody=!0;function o(t,e){return t.w('<div class="tc-ctl tc-ctl-lcat-loading"><span>').h("i18n",e,{},{$key:"loadingLayerTree"}).w("...</span></div>")}o.__dustBody=!0;function l(t,e){return t.w('<ul class="tc-ctl-lcat-branch">').s(e.get(["layers"],!1),e,{block:c},{}).w("</ul>")}l.__dustBody=!0;function c(t,e){return t.w('<li data-layer-id="').f(e.get(["id"],!1),e,"h").w('" title="').h("i18n",e,{},{$key:"loadingLayers"}).w('" class="tc-ctl-lcat-loading-node"> ').f(e.get(["title"],!1),e,"h").w("</li>")}c.__dustBody=!0;function i(t,e){return t.w('<ul class="tc-ctl-lcat-branch">').s(e.get(["layerTrees"],!1),e,{block:d},{}).w("</ul>")}i.__dustBody=!0;function d(t,e){return t.p("tc-ctl-lcat-branch",e,e.rebase(e.getPath(!0,[])),{})}d.__dustBody=!0;return e};t.template[t.CLASS+"-branch"]=function(){dust.register(t.CLASS+"-branch",e);function e(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{else:s,block:a},{}).w(' data-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><button class="tc-ctl-lcat-collapse-btn"></button><span>').f(e.get(["title"],!1),e,"h").w('</span><ul class="tc-ctl-lcat-branch tc-collapsed">').s(e.get(["children"],!1),e,{block:n},{}).w("</ul></li>")}e.__dustBody=!0;function s(t,e){return t.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}s.__dustBody=!0;function a(t,e){return t.w('class="tc-ctl-lcat-node tc-collapsed"')}a.__dustBody=!0;function n(t,e){return t.p("tc-ctl-lcat-node",e,e.rebase(e.getPath(!0,[])),{})}n.__dustBody=!0;return e};t.template[t.CLASS+"-node"]=function(){dust.register(t.CLASS+"-node",e);function e(t,e){return t.x(e.get(["isVisible"],!1),e,{block:s},{})}e.__dustBody=!0;function s(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{else:a,block:n},{}).w(' data-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-layer-uid="').f(e.get(["uid"],!1),e,"h").w('">').x(e.get(["children"],!1),e,{block:r},{}).w('<span data-tooltip="').x(e.get(["name"],!1),e,{block:o},{}).w('">').f(e.get(["title"],!1),e,"h").w("</span>").x(e.get(["name"],!1),e,{block:l},{}).w('<ul class="tc-ctl-lcat-branch tc-collapsed">').s(e.get(["children"],!1),e,{block:c},{}).w("</ul></li>")}s.__dustBody=!0;function a(t,e){return t.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}a.__dustBody=!0;function n(t,e){return t.w('class="tc-ctl-lcat-node tc-collapsed"')}n.__dustBody=!0;function r(t,e){return t.w('<button class="tc-ctl-lcat-collapse-btn"></button>')}r.__dustBody=!0;function o(t,e){return t.h("i18n",e,{},{$key:"clickToAddToMap"})}o.__dustBody=!0;function l(t,e){return t.w('<button title="').h("i18n",e,{},{$key:"infoFromThisLayer"}).w('" class="tc-ctl-lcat-btn-info"></button>')}l.__dustBody=!0;function c(t,e){return t.p("tc-ctl-lcat-node",e,e.rebase(e.getPath(!0,[])),{})}c.__dustBody=!0;return e};t.template[t.CLASS+"-info"]=function(){dust.register(t.CLASS+"-info",e);function e(t,e){return t.w('<a class="tc-ctl-lcat-info-close"></a><h2>').h("i18n",e,{},{$key:"layerInfo"}).w('</h2><h3 class="tc-ctl-lcat-title">').f(e.get(["title"],!1),e,"h").w("</h3>").x(e.get(["abstract"],!1),e,{block:s},{}).x(e.get(["metadata"],!1),e,{block:a},{})}e.__dustBody=!0;function s(t,e){return t.w('<div class="tc-ctl-lcat-abstract"><h4>').h("i18n",e,{},{$key:"abstract"}).w("</h4><div><pre>").f(e.get(["abstract"],!1),e,"h",["s"]).w("</pre></div></div>")}s.__dustBody=!0;function a(t,e){return t.w('<div class="tc-ctl-lcat-metadata"><h4>').h("i18n",e,{},{$key:"metadata"}).w("</h4><ul>").s(e.get(["metadata"],!1),e,{block:n},{}).w("</ul></div>")}a.__dustBody=!0;function n(t,e){return t.w('<li><a href="').f(e.get(["url"],!1),e,"h",["s"]).w('" type="').f(e.get(["format"],!1),e,"h").w('" title="').f(e.get(["formatDescription"],!1),e,"h").w('" target="_blank">').f(e.get(["formatDescription"],!1),e,"h",["s"]).w("</a></li>")}n.__dustBody=!0;return e};t.template[t.CLASS+"-results"]=function(){dust.register(t.CLASS+"-results",e);function e(t,e){return t.s(e.get(["servicesFound"],!1),e,{else:s,block:a},{})}e.__dustBody=!0;function s(t,e){return t.w('<li class="tc-ctl-lcat-no-results"><h5>').h("i18n",e,{},{$key:"noMatches"}).w("</h5></li>")}s.__dustBody=!0;function a(t,e){return t.h("gt",e,{block:n},{key:e.get(["servicesLooked"],!1),value:1}).s(e.get(["founds"],!1),e,{block:o},{}).h("gt",e,{block:d},{key:e.get(["servicesLooked"],!1),value:1})}a.__dustBody=!0;function n(t,e){return t.w('<li class="tc-ctl-lcat-search-group ').x(e.getPath(!1,["service","isCollapsed"]),e,{block:r},{}).w('" data-service-index="').f(e.getPath(!1,["service","index"]),e,"h").w('"><h5>').f(e.getPath(!1,["service","title"]),e,"h").w("</h5><ul>")}n.__dustBody=!0;function r(t,e){return t.w("tc-collapsed")}r.__dustBody=!0;function o(t,e){return t.w('<li data-layer-name="').f(e.get(["Name"],!1),e,"h").w('" ').x(e.get(["alreadyAdded"],!1),e,{block:l},{}).w('><h5 class="tc-selectable"').x(e.get(["alreadyAdded"],!1),e,{else:c,block:i},{}).w(">").f(e.get(["Title"],!1),e,"h").w('</h5><button class="tc-ctl-lcat-search-btn-info" title="').h("i18n",e,{},{$key:"infoFromThisLayer"}).w('"></button></li>')}o.__dustBody=!0;function l(t,e){return t.w(' class="tc-checked"')}l.__dustBody=!0;function c(t,e){return t.w(' data-tooltip="').h("i18n",e,{},{$key:"clickToAddToMap"}).w('"')}c.__dustBody=!0;function i(t,e){return t.w(' data-tooltip="').h("i18n",e,{},{$key:"layerAlreadyAdded"}).w('"')}i.__dustBody=!0;function d(t,e){return t.w("</ul></li>")}d.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-lcat-crs-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"changeCRS"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",e,{},{$key:"wmsLayerNotCompatible.instructions|h"}).w('</p><ul class="tc-ctl-lcat-crs-list tc-crs-list"></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}e.__dustBody=!0;return e};const e=function(t,e){t.showProjectionChangeDialog({layer:e,closeCallback:function(){t.getLayerNodes(e).forEach(function(e){e.classList.remove(TC.Consts.classes.LOADING);e.querySelector("span").dataset.tooltip=t.getLocaleString("clickToAddToMap")})}})};t.register=function(t){const e=this,s=TC.control.ProjectionSelector.prototype.register.call(e,t),r=function(t,s){if(Array.isArray(e.options.layers)){for(var a=0;a<e.options.layers.length;a++){var n=e.options.layers[a];if(!n.type||n.type===TC.Consts.layerType.WMS){n.id||(n.id=TC.getUID());TC.Util.isPlainObject(n)&&(n=new TC.layer.Raster(n));e.layers.push(n)}}e.render(function(){t()})}else t()};e._readyPromise=new Promise(function(e,s){const a=function(s){if(s.layer===t.baseLayer){r(e);t.off(TC.Consts.event.LAYERUPDATE,a)}};t.loaded(function(){t.baseLayer.state&&t.baseLayer.state!==TC.Layer.state.IDLE?t.on(TC.Consts.event.LAYERUPDATE,a):r(e)})});var o=e.getLocaleString("clickToAddToMap");t.on(TC.Consts.event.BEFORELAYERADD+" "+TC.Consts.event.BEFOREUPDATEPARAMS,function(t){e.getLayerNodes(t.layer).forEach(function(t){t.classList.add(TC.Consts.classes.LOADING);delete t.querySelector("span").dataset.tooltip})}).on(TC.Consts.event.LAYERADD+" "+TC.Consts.event.UPDATEPARAMS,function(t){const s=t.layer;s.isBase||s.type!==TC.Consts.layerType.WMS||e.loaded().then(function(){if(e.getLayerRootNode(s))n.call(e,s);else{for(var t=!1,a=0,r=e.layers.length;a<r;a++){var o=e.layers[a];if(o.type===s.type&&o.options.url===s.options.url){t=!0;break}}if(t){e.layersToSetChecked||(e.layersToSetChecked=[]);e.layersToSetChecked.push(s)}else e.addLayer(new TC.layer.Raster({url:s.options.url,type:s.type,layerNames:[],title:s.title||s.wrap.getServiceTitle(),hideTitle:!0,hideTree:!1})).then(function(){n.call(e,s)})}})}).on(TC.Consts.event.LAYERERROR,function(t){const s=t.reason;if(e.layers.some(e=>e==t.layer)){s&&TC.alert(e.getLocaleString(s,{url:t.layer.url}));e.getLayerNodes(t.layer).forEach(function(t){t.classList.remove(TC.Consts.classes.LOADING)})}}).on(TC.Consts.event.LAYERREMOVE,function(t){const s=t.layer;e.getLayerNodes(s).forEach(function(t){t.classList.remove(TC.Consts.classes.CHECKED);t.querySelector("span").dataset.tooltip=o});(function(t){const s=[];if(!t.isBase){var a=t.options.url;e.list&&e.list.querySelectorAll("li").forEach(function(n){const r=e.getLayer(n.dataset.layerId);if(r&&r.type===t.type&&r.options.url===a)for(var o=0;o<t.names.length;o++)if(n.dataset.layerName===t.names[o]){s.push(n);break}})}return s})(s).forEach(function(t){t.classList.remove(TC.Consts.classes.CHECKED);t.querySelector("h5").dataset.tooltip=o});!function(t){var s=e.map.getControlsByClass(TC.control.WorkLayerManager)[0];if(s)for(var a=s.layers,n=0;n<a.length;n++){var r=a[n];r!==t&&e.getLayerNodes(r).forEach(function(t){t.classList.add(TC.Consts.classes.CHECKED);t.querySelector("span").dataset.tooltip=e.getLocaleString("layerAlreadyAdded")})}}(s);a.call(e)}).on(TC.Consts.event.EXTERNALSERVICEADDED,function(t){if(t&&t.layer){e.addLayer(t.layer);e.div.classList.remove(TC.Consts.classes.COLLAPSED)}}).on(TC.Consts.event.PROJECTIONCHANGE,function(t){e.update()});return s};const s=function(t){t.target.blur();t.stopPropagation();const e=t.target.parentElement;if("LI"===e.tagName&&!e.classList.contains(self.CLASS+"-leaf")){e.classList.toggle(TC.Consts.classes.COLLAPSED);e.querySelector("ul").classList.toggle(TC.Consts.classes.COLLAPSED)}},a=function(){const t=this;if("createEvent"in document){var e=document.createEvent("HTMLEvents");e.initEvent("keyup",!1,!0);t.textInput&&t.textInput.dispatchEvent(e)}else t.textInput&&t.textInput.fireEvent("keyup")},n=function(t){const e=this;e.getLayerNodes(t).forEach(function(t){t.classList.remove(TC.Consts.classes.LOADING);t.classList.add(TC.Consts.classes.CHECKED);t.querySelector("span").dataset.tooltip=e.getLocaleString("layerAlreadyAdded")});a.call(e)},r=function(t,e){const a=this;t.querySelectorAll("li > button."+a.CLASS+"-collapse-btn").forEach(function(t){t.addEventListener("click",s)});t.querySelectorAll("span").forEach(function(t){t.addEventListener("click",function(t){!function(t,e){const s=t.target.parentNode;if(!s.classList.contains(TC.Consts.classes.LOADING)&&!s.classList.contains(TC.Consts.classes.CHECKED)){t.preventDefault;var a,n=s.dataset.layerName;n=void 0!==n?n.toString():"";for(var r=0,o=e._roots.length;r<o;r++){const t=e._roots[r];if(t.contains(s)){a=e.getLayer(t.dataset.layerId);break}}a||(a=e.getLayer(s.dataset.layerId));if(a&&n){var l=1;/iPad/i.test(navigator.userAgent)?l=10:TC.Util.detectFirefox()&&(l=250);a.title||(a.title=a.getTree().title);s.classList.add(TC.Consts.classes.LOADING);s.querySelector("span").dataset.tooltip="";(c=s,new Promise(function(t,e){setTimeout(function(){c.offsetHeight=c.offsetHeight;c.offsetWidth=c.offsetWidth;t()},l)})).then(function(){e.addLayerToMap(a,n)});t.stopPropagation()}}var c}(t,a)})});a._roots=a.div.querySelectorAll(a._selectors.LAYER_ROOT);t.dataset.layerId=e.id;t.querySelectorAll("."+a.CLASS+"-btn-info").forEach(function(t){const s=t.parentElement.querySelector("span"),n=t.parentElement.dataset.layerName;if(n){s.classList.add(TC.Consts.classes.SELECTABLE);var r=e.wrap.getInfo(n);r.hasOwnProperty("abstract")||r.hasOwnProperty("legend")||r.hasOwnProperty("metadata")?t.addEventListener(TC.Consts.event.CLICK,function(t){t.stopPropagation();this.classList.toggle(TC.Consts.classes.CHECKED)?a.showLayerInfo(e,n):a.hideLayerInfo()}):t.parentElement.removeChild(t);if(e.compatibleLayers&&e.compatibleLayers.indexOf(n)<0){s.classList.add(TC.Consts.classes.INCOMPATIBLE);s.setAttribute("title",a.getLocaleString("reprojectionNeeded"))}if(a.map)for(var o=0,l=a.map.workLayers.length;o<l;o++){var c=a.map.workLayers[o];if(c.type===TC.Consts.layerType.WMS&&c.url===e.url&&1===c.names.length&&c.names[0]===n){s.parentElement.classList.add(TC.Consts.classes.CHECKED);s.dataset.tooltip=a.getLocaleString("layerAlreadyAdded")}}}else{s.dataset.tooltip="";t.parentElement.removeChild(t)}});(function(){const t=this;t.layersToSetChecked&&t.layersToSetChecked.length>0&&t.layersToSetChecked.forEach(function(e,s,a){if(t.getLayerRootNode(e)){n.call(t,e);a.splice(s,1)}})}).call(a);a.getRenderedHtml(a.CLASS+"-dialog",null,function(t){a._dialogDiv.innerHTML=t})};t.renderBranch=function(t,e,s){const a=this;t.getCapabilitiesPromise().then(function(n){a.sourceLayers.push(t);a.getRenderedHtml(a.CLASS+"-branch",function(t){var e=t.getTree();!function e(s){for(var a=!1,n=0;n<s.children.length;n++)e(s.children[n])&&(a=!0);s.hasOwnProperty("isVisible")&&(s.isVisible=!t.names||!t.names.length||a||s.isVisible);return s.isVisible}(e);return e}(this),function(t){var n=document.createElement("template");n.innerHTML=t;var o=n.content?n.content.firstChild:n.firstChild,l=a.div.querySelector("."+a.CLASS+"-branch").querySelector("li."+a.CLASS+'-loading-node[data-layer-id="'+this.id+'"]');l?a.div.querySelector("."+a.CLASS+"-branch").replaceChild(o,l):a.div.querySelector("."+a.CLASS+"-branch").appendChild(o);r.call(a,o,this);1===a.div.querySelector("."+a.CLASS+"-branch").childElementCount&&s();TC.Util.isFunction(e)&&e(a.sourceLayers[a.sourceLayers.map(function(t){return t.id}).indexOf(this.id)])}.bind(this))}.bind(t)).catch(function(t){var e=a.layers.map(function(t){return t.id}).indexOf(this.id);a.layers.splice(e,1);var s=a.getLocaleString("lyrCtlg.errorLoadingNode",{serviceName:this.title}),n=a.div.querySelector("."+a.CLASS+"-branch").querySelector("li."+a.CLASS+'-loading-node[data-layer-id="'+this.id+'"]');n.classList.add("error");n.setAttribute("title",s);a.map.toast(s,{type:TC.Consts.msgType.ERROR})}.bind(t))};t.render=function(t){const s=this;s.sourceLayers=[];return s._set1stRenderPromise(new Promise(function(a,n){0===s.layers.length?s.renderData({layerTrees:[],enableSearch:!1},function(){TC.Util.isFunction(t)&&t();a()}):s.renderData({layers:s.layers,enableSearch:!0},function(){(function(){const t=this;t.textInput=t.div.querySelector("."+t.CLASS+"-input");t.list=t.div.querySelector("."+t.CLASS+"-search ul");t.textInput.addEventListener("mouseup",function(e){""!==t.textInput.value&&setTimeout(function(){""===t.textInput.value&&(t.list.innerHTML="")},1)});var s=[];TC._search=TC._search||{};TC._search.retryTimeout=null;TC.loadJS(!TC.UI||!TC.UI.autocomplete,[TC.apiLocation+"TC/ui/autocomplete.js"],function(){TC.UI.autocomplete.call(t.textInput,{link:"#",target:t.list,minLength:0,source:function(e,a){s=[];t._roots.forEach(function(t){t.querySelectorAll("li."+TC.Consts.classes.CHECKED).forEach(function(t){s.push(t.dataset.layerName)})});if((e=e.trim()).length<3)t.list.innerHTML="";else if(e.length>=3){TC._search.retryTimeout&&clearTimeout(TC._search.retryTimeout);TC._search.retryTimeout=setTimeout(function(){for(var s=[],n=0;n<t.sourceLayers.length;n++){var r=t.sourceLayers[n].searchSubLayers(e);r.length&&s.push({service:{index:n,title:t.sourceLayers[n].title||t.sourceLayers[n].id},founds:r})}a({servicesFound:s,servicesLooked:t.sourceLayers.length})},TC._search.interval)}},callback:function(e){t.textInput.value=e.target.text||e.target.innerText;TC._search.lastPattern=t.textInput.value;t.goToResult(unescape(e.target.hash).substring(1));TC.UI.autocomplete.call(t.textInput,"clear")},buildHTML:function(e){var a=this.target;if(e.results&&e.results.servicesFound.length>0)for(var n=t.map.getLayerTree().workLayers,r=0;r<e.results.servicesFound.length;r++){for(var o=e.results.servicesFound[r].founds,l=0;l<o.length;l++){delete o[l].alreadyAdded;for(var c=0;c<n.length;c++)if(s.indexOf(o[l].Name)>=0){o[l].alreadyAdded=!0;break}if(!o[l].Name){o.splice(l,1);l--}}e.results.servicesFound[r].founds.length?t.div.querySelectorAll(".tc-ctl-lcat-search-group")[r]&&(e.results.servicesFound[r].service.isCollapsed=t.div.querySelectorAll(".tc-ctl-lcat-search-group")[r].classList.contains(TC.Consts.classes.COLLAPSED)):e.results.servicesFound.splice(r,1)}var i="";t.getRenderedHtml(t.CLASS+"-results",e.results).then(function(t){a.innerHTML=i=t});return i}})});if(!t.searchInit){t.div.addEventListener("click",TC.EventTarget.listenerBySelector("h2 button",function(e){const s=t.div.classList.contains(TC.Consts.classes.COLLAPSED);t.div.classList.remove(TC.Consts.classes.COLLAPSED);const a=t.div.querySelector("."+t.CLASS+"-search"),n=t.div.querySelector("."+t.CLASS+"-tree"),r=t.div.querySelector("."+t.CLASS+"-info"),o=!(!a.classList.contains(TC.Consts.classes.HIDDEN)&&!s);a.classList.toggle(TC.Consts.classes.HIDDEN,!o);n.classList.toggle(TC.Consts.classes.HIDDEN,o);e.target.classList.toggle(t.CLASS+"-btn-tree",o);e.target.classList.toggle(t.CLASS+"-btn-search",!o);if(o){t.textInput.focus();e.target.setAttribute("title",t.getLocaleString("viewAvailableLayersTree"));0===t.div.querySelectorAll(".tc-ctl-lcat-search li button.tc-checked").length&&r.classList.add(TC.Consts.classes.HIDDEN)}else{e.target.setAttribute("title",t.getLocaleString("searchLayersByText"));t.div.querySelectorAll(".tc-ctl-lcat-tree li button.tc-checked").length>0&&r.classList.remove(TC.Consts.classes.HIDDEN)}}));t.div.addEventListener("click",TC.EventTarget.listenerBySelector("."+t.CLASS+"-search button."+t.CLASS+"-search-btn-info",function(e){e.stopPropagation();const s=e.target;if(s.classList.contains(TC.Consts.classes.CHECKED)){s.classList.remove(TC.Consts.classes.CHECKED);t.hideLayerInfo()}else{const e=s.parentElement;var a=e;do{a=a.parentElement}while(a&&"LI"!==a.tagName);t.showLayerInfo(t.layers.length>1?t.layers[a.dataset.serviceIndex]:t.layers[0],e.dataset.layerName);s.classList.add(TC.Consts.classes.CHECKED)}}));const s="."+t.CLASS+"-search li";t.div.addEventListener("click",TC.EventTarget.listenerBySelector(s,function(a){a.stopPropagation();for(var n=a.target;n&&!n.matches(s);)n=n.parentElement;if(!n.classList.contains(t.CLASS+"-no-results"))if(n.classList.contains(t.CLASS+"-search-group"))n.classList.toggle(TC.Consts.classes.COLLAPSED);else{var r=n.dataset.layerName;if(r&&0!==(r=r.toString()).trim().length&&!n.classList.contains(TC.Consts.classes.CHECKED)){var o=n;do{o=o.parentElement}while(o&&!o.matches("li."+t.CLASS+"-search-group"));const s=o?o.dataset.serviceIndex:0,a=t.layers[s].options.url,l=t.layers[s].title,c=new TC.layer.Raster({id:t.getUID(),url:a,title:l,hideTitle:t.layers[s].hideTitle||t.layers[s].options.hideTitle,hideTree:!1,layerNames:[r]});if(c.isCompatible(t.map.crs)){t.map.addLayer(c,function(t){n.dataset.layerId=t.id;t.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(t){var e=this.parent;401!==t.error.code&&403!==t.error.code||e.map.toast(t.error.text,{type:TC.Consts.msgType.ERROR});e.map.removeLayer(e)})});n.classList.add(TC.Consts.classes.CHECKED);n.querySelector("h5").dataset.tooltip=t.getLocaleString("layerAlreadyAdded")}else e(t,c)}}}));t.searchInit=!0}}).call(s);s.layers.forEach(function(e){s.renderBranch(e,t,a)})})}))};t.getLayerRootNode=function(t){const e=this;var s=null;if(!t.isBase){var a=t.options.url;e._roots&&e._roots.forEach(function(n){const r=e.getLayer(n.dataset.layerId);r&&r.type===t.type&&r.options.url===a&&(s=n)})}return s};t.getLayerNodes=function(t){const e=[],s=this.getLayerRootNode(t);if(s)for(var a=0;a<t.names.length;a++){const n=s.querySelector('li[data-layer-name="'+t.names[a]+'"]');if(n){e[e.length]=n;n.querySelectorAll("li").forEach(function(t){e[e.length]=t})}}return e};t.showLayerInfo=function(t,e){const s=this;var a=null,n=s.div.querySelector("."+s.CLASS+"-info");const r=function(t,e){var a=!1;if(e){a=!0;n.dataset.layerName=t;n.classList.remove(TC.Consts.classes.HIDDEN);s.getRenderedHtml(s.CLASS+"-info",e).then(function(t){n.innerHTML=t;n.querySelector("."+s.CLASS+"-info-close").addEventListener(TC.Consts.event.CLICK,function(){s.hideLayerInfo()})}).catch(function(t){TC.error(t)})}return a};s.div.querySelectorAll("."+s.CLASS+"-btn-info, ."+s.CLASS+"-search-btn-info").forEach(function(t){t.classList.remove(TC.Consts.classes.CHECKED)});const o={};for(var l=0,c=s._roots.length;l<c;l++){const n=s._roots[l];if(n.dataset.layerId===t.id){const l=n.querySelectorAll("."+s.CLASS+"-btn-info");for(var i=0,d=l.length;i<d;i++){var u=l[i].parentElement.dataset.layerName;if(u===e){const n=t.wrap.getInfo(e);n.metadata&&n.metadata.forEach(function(t){t.formatDescription=o[t.format]=o[t.format]||s.getLocaleString(TC.Util.getSimpleMimeType(t.format))||s.getLocaleString("viewMetadata")});s.div.querySelector('li [data-layer-name="'+u+'"] > button.'+s.CLASS+"-btn-info").classList.toggle(TC.Consts.classes.CHECKED,r(u,n));a=n;break}}break}}return a};t.update=function(){const t=this;t.sourceLayers.forEach(function(e){e.getCapabilitiesPromise().then(function(){e.compatibleLayers=e.wrap.getCompatibleLayers(t.map.crs);const s=t.getLayerRootNode(e);s&&s.querySelectorAll("li[data-layer-name]").forEach(function(s){const a=s.dataset.layerName,n=s.querySelector("span."+TC.Consts.classes.SELECTABLE);if(e.compatibleLayers.indexOf(a)<0){n.classList.add(TC.Consts.classes.INCOMPATIBLE);n.setAttribute("title",t.getLocaleString("reprojectionNeeded"))}else{n.classList.remove(TC.Consts.classes.INCOMPATIBLE);n.removeAttribute("title")}})})})};t.hideLayerInfo=function(){this.div.querySelectorAll("."+this.CLASS+"-btn-info, ."+this.CLASS+"-search-btn-info").forEach(function(t){t.classList.remove(TC.Consts.classes.CHECKED)});this.div.querySelector("."+this.CLASS+"-info").classList.add(TC.Consts.classes.HIDDEN)};t.addLayer=function(t){const e=this;return new Promise(function(s,a){var n=[];e.options.layers&&e.options.layers.length&&(n=e.options.layers.filter(function(e){var s=TC.Util.reqGetMapOnCapabilities(e.url);return s&&s.replace(TC.Util.regex.PROTOCOL)==t.url.replace(TC.Util.regex.PROTOCOL)}));0==n.length&&(n=e.layers.filter(function(e){return e.url.replace(TC.Util.regex.PROTOCOL)==t.url.replace(TC.Util.regex.PROTOCOL)}));if(0==n.length){e.layers.push(t);t.getCapabilitiesPromise().then(function(){t.compatibleLayers=t.wrap.getCompatibleLayers(e.map.crs);t.title=t.title||t.wrap.getServiceTitle();e.renderBranch(t,function(){s()})})}else s()})};t.getLayer=function(t){const e=this;for(var s=0,a=e.layers.length;s<a;s++){const a=e.layers[s];if(a.id===t){var n=e.options.layers.filter(e=>e.id===t);n.length>0?a.hideTitle=a.options.hideTitle=n[0].hideTitle:a.hideTitle=a.options.hideTitle=!1;return a}}return null};t.addLayerToMap=function(t,s){const a=this,n=TC.Util.extend({},t.options);n.id=a.getUID();n.layerNames=[s];n.title=t.title;const r=new TC.layer.Raster(n);r.isCompatible(a.map.crs)?a.map.addLayer(n):e(a,r)};t.loaded=function(){return this._readyPromise};t.getAvailableCRS=function(t){t=t||{};return this.map.getCompatibleCRS({layers:this.map.workLayers.concat(this.map.baseLayer,t.layer),includeFallbacks:!0})};t.setProjection=function(t){const e=this;t=t||{};TC.loadProjDef({crs:t.crs,callback:function(){e.map.setProjection(t).then(function(){e._layerToAdd&&e.map.addLayer(e._layerToAdd);TC.Util.closeModal()})}})};t.showProjectionChangeDialog=function(t){this._layerToAdd=t.layer;TC.control.ProjectionSelector.prototype.showProjectionChangeDialog.call(this,t)}}();
//# sourceMappingURL=../maps/control/LayerCatalog.min.js.map