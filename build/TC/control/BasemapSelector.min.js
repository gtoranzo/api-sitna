TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents");!function(){TC.control.BasemapSelector=function(){var e=this;TC.control.MapContents.apply(e,arguments);e._cssClasses={LOAD_CRS_BUTTON:e.CLASS+"-crs-btn-load",CRS_DIALOG:e.CLASS+"-crs-dialog",CRS_LIST:e.CLASS+"-crs-list",CURRENT_CRS_NAME:e.CLASS+"-cur-crs-name",CURRENT_CRS_CODE:e.CLASS+"-cur-crs-code"};e._dialogDiv=TC.Util.getDiv(e.options.dialogDiv);e._$dialogDiv=$(e._dialogDiv);e.options.dialogDiv||document.body.appendChild(e._dialogDiv);e._dialogDiv.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector("button:not(.tc-modal-close)",function(a){if(a.target.classList.contains(e._cssClasses.LOAD_CRS_BUTTON)){e.loadFallbackProjections();return}TC.Util.closeModal();const s=a.target,o=s.dataset.crsCode,r=e._dialogDiv.querySelector("."+e.CLASS+"-crs-dialog");r.classList.add(TC.Consts.classes.HIDDEN);const n=e.getLayer(r.dataset.layerId);if(n)if(o)TC.loadProjDef({crs:o,callback:function(){e.map.setProjection({crs:o,baseLayer:n})}});else{const a=$(s).data(t.FALLBACK_LAYER);a&&e.map.setBaseLayer(a)}}))};TC.inherit(TC.control.BasemapSelector,TC.control.MapContents);var e=TC.control.BasemapSelector.prototype;e.CLASS="tc-ctl-bms";var t={FALLBACK_LAYER:"tcFallbackLayer"};e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/BasemapSelector.html";e.template[e.CLASS+"-node"]=TC.apiLocation+"TC/templates/BasemapSelectorNode.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/BasemapSelectorDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"backgroundMaps"}).w('</h2><div class="tc-ctl-bms-tree"><form><ul class="tc-ctl-bms-branch">').s(t.get(["baseLayers"],!1),t,{block:a},{}).s(t.get(["dialogMore"],!1),t,{block:s},{}).w("</ul></form></div>")}t.__dustBody=!0;function a(e,t){return e.p("tc-ctl-bms-node",t,t.rebase(t.getPath(!0,[])),{})}a.__dustBody=!0;function s(e,t){return e.w('<li class="tc-ctl-bms-node"><label class="tc-ctl-bms-more-node" title="').h("i18n",t,{},{$key:"moreBackgroundMaps"}).w('"><input type="radio" name="bms" value="moreLayers"><span></span></label></li>')}s.__dustBody=!0;return t};e.template[e.CLASS+"-node"]=function(){dust.register(e.CLASS+"-node",t);function t(e,t){return e.w('<li class="tc-ctl-bms-node" data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('" ><label').x(t.get(["legend"],!1),t,{block:a},{}).x(t.get(["thumbnail"],!1),t,{block:s},{}).w('><input type="radio" name="bms" value="').f(t.get(["name"],!1),t,"h").w('"').x(t.get(["mustReproject"],!1),t,{block:o},{}).w("><span>").f(t.get(["title"],!1),t,"h").w("</span></label></li>")}t.__dustBody=!0;function a(e,t){return e.w(' style="background-image: url(').f(t.getPath(!1,["legend","src"]),t,"h").w(')"')}a.__dustBody=!0;function s(e,t){return e.w(' style="background-image: url(').f(t.get(["thumbnail"],!1),t,"h").w(')"')}s.__dustBody=!0;function o(e,t){return e.w(' class="tc-disabled"')}o.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-bms-more-dialog tc-modal tc-hidden"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"backgroundMaps"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w('</button></div></div></div><div class="tc-ctl-bms-crs-dialog tc-modal tc-hidden"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"baseLayerNotCompatible"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",t,{},{$key:"baseLayerNotCompatible.instructions|h"}).w('</p><ul class="tc-ctl-bms-crs-list tc-crs-list"></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}t.__dustBody=!0;return t}}const a=function(e,t){for(;e&&!e.matches(t);)e=e.parentElement;return e},s=function(e,t){const s=this;var o=!0,r=e.target,n=s.getLayer(a(r,"li").dataset.layerId);if(s.options.dialogMore&&a(r,"."+s.CLASS+"-more-dialog")){const e=s.div.querySelectorAll("input[type=radio]");for(var l=0,i=e.length;l<i;l++){const t=s.getLayer(a(e[l],"li").dataset.layerId);if(t)switch(!0){case t.id===n.id:n=t}}}if(n!=s.map.getBaseLayer())if(n.mustReproject)if(s.map.on3DView){if(!n.getFallbackLayer()){s._currentSelection.checked=!0;e.stopPropagation();return}if(n.getFallbackLayer()){const e=n.getFallbackLayer();e&&e._capabilitiesPromise.then(function(){e.isCompatible(s.map.getCRS())&&s.map.setBaseLayer(n)});o=!0}}else{s._currentSelection&&(s._currentSelection.checked=!0);const e={layer:n},t=n.getFallbackLayer();t?t._capabilitiesPromise.then(function(){t.isCompatible(s.map.getCRS())&&(e.fallbackLayer=t);s.showProjectionChangeDialog(e)}):s.showProjectionChangeDialog(e);o=!1}else{(n.type===TC.Consts.layerType.WMS||n.type===TC.Consts.layerType.WMTS&&n.getProjection()!==s.map.crs)&&n.setProjection({crs:s.map.crs});s.map.setBaseLayer(n)}this._currentSelection&&(this._currentSelection.checked=!0);t&&t(o)};e.register=function(e){const t=this,a=TC.control.MapContents.prototype.register.call(t,e);t.options.dialogMore&&e.on(TC.Consts.event.VIEWCHANGE,function(){t._getMoreBaseLayers()});e.on(TC.Consts.event.BASELAYERCHANGE+" "+TC.Consts.event.PROJECTIONCHANGE+" "+TC.Consts.event.VIEWCHANGE,function(e){t.update(t.div,e.layer)});t.div.addEventListener("change",TC.EventTarget.listenerBySelector("input[type=radio]",function(e){"moreLayers"===e.target.value?t.showMoreLayersDialog():s.call(t,e);e.stopPropagation()}));return a};e.render=function(e){const t=this,a=TC.control.MapContents.prototype.render.call(t,e,t.options);t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._dialogDiv.innerHTML=e;if(t.options.dialogMore){t._dialogDiv.querySelector("."+t.CLASS+"-more-dialog").addEventListener("change",TC.EventTarget.listenerBySelector("input[type=radio]",function(e){s.call(t,e,function(e){e&&TC.Util.closeModal()});e.stopPropagation()}))}});return a};e.update=function(e,t){const a=this;(e=e||a.div).querySelector("ul."+a.CLASS+"-branch").querySelectorAll("li").forEach(function(e){const s=a.getLayer(e.dataset.layerId);if(s){const o=t||a.map.baseLayer,r=e.querySelector("input[type=radio]"),n=o&&(o===s||o.id===s.id||s.getFallbackLayer&&(o===s.getFallbackLayer()||s.getFallbackLayer()&&o.id===s.getFallbackLayer().id));if(a.map.on3DView&&s.mustReproject&&s.fallbackLayer&&s.getFallbackLayer)s.getFallbackLayer().getCapabilitiesPromise().then(function(){var t=!s.getFallbackLayer().isCompatible(a.map.getCRS());r.checked=n;if(t){r.classList.add(TC.Consts.classes.DISABLED);e.setAttribute("title",a.map.on3DView?a.getLocaleString("notAvailableTo3D"):a.getLocaleString("reprojectionNeeded"))}else{r.classList.remove(TC.Consts.classes.DISABLED);e.removeAttribute("title")}});else{r.checked=n;if(s.mustReproject){r.classList.add(TC.Consts.classes.DISABLED);e.setAttribute("title",a.map.on3DView?a.getLocaleString("notAvailableTo3D"):a.getLocaleString("reprojectionNeeded"))}else{r.classList.remove(TC.Consts.classes.DISABLED);e.removeAttribute("title")}}n&&(a._currentSelection=r)}});a.updateScale()};e.updateLayerTree=function(e){const t=this;if(e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(t,e);var a=t.CLASS+"-node";TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(a,t.layerTrees[e.id],function(a,s){const o=(new DOMParser).parseFromString(s,"text/html").body.firstChild;var r=o.dataset.tcLayerUid;const n=t.div.querySelector("."+t.CLASS+"-branch"),l=n.querySelector('li[data-tc-layer-uid="'+r+'"]');if(l)l.innerHTML=o.innerHTML;else{o.dataset.layerId=e.id;var i=t.map.baseLayers.filter(function(e){return!e.stealth}).map(function(e){return e.id}).indexOf(e.id);const a=n.querySelectorAll("li");i<0||i>=a.length?n.appendChild(o):n.insertBefore(o,a[i])}a&&TC.error(a)});t.update()})}};e.updateLayerOrder=function(e,t,a){};e.removeLayer=function(e){const t=this;if(e.isBase){const o=t.div.querySelector("."+t.CLASS+"-branch").querySelectorAll("li");for(var a=0,s=o.length;a<s;a++){const t=o[a];if(t.dataset.layerId===e.id){t.parentElement.removeChild(t);break}}}};e.onErrorLayer=function(e){const t=this;e.isBase&&!e.options.stealth&&t.map.toast(t.getLocaleString("baseLayerNotAvailable",{mapName:e.title}),{type:TC.Consts.msgType.ERROR})};e.loadFallbackProjections=function(){const e=this;e._dialogDiv.querySelector("."+e._cssClasses.CRS_DIALOG).querySelectorAll("ul."+e._cssClasses.CRS_LIST+" li").forEach(function(t){t.classList.remove(TC.Consts.classes.HIDDEN);t.querySelector("button."+e._cssClasses.LOAD_CRS_BUTTON)&&t.classList.add(TC.Consts.classes.HIDDEN)})};e.showProjectionChangeDialog=function(e){const a=this,s=(e=e||{}).layer,o=a._dialogDiv.querySelector("."+a.CLASS+"-crs-dialog"),r=o.querySelector(".tc-modal-body");r.classList.add(TC.Consts.classes.LOADING);const n=s.getCompatibleCRS();o.classList.remove(TC.Consts.classes.HIDDEN);o.dataset.layerId=s.id;const l=o.querySelector("ul."+a.CLASS+"-crs-list");l.innerHTML="";a.map.loadProjections({crsList:a.map.getCompatibleCRS({layers:a.map.workLayers.concat(s),includeFallbacks:!0}),orderBy:"name"}).then(function(s){var o=!1;const i=document.createDocumentFragment();s.forEach(function(s){const r=document.createElement("li"),l=document.createElement("button");if(0===n.filter(function(e){return TC.Util.CRSCodesEqual(e,s.code)}).length){o=!0;l.innerHTML=s.name+" ("+s.code+")";$(l).data(t.FALLBACK_LAYER,e.layer.fallbackLayer);l.dataset.crsCode=s.code;l.classList.add(TC.Consts.classes.WARNING);r.classList.add(TC.Consts.classes.HIDDEN)}else{l.innerHTML=a.getLocaleString("changeMapToCrs",{crs:s.name+" ("+s.code+")"});l.dataset.crsCode=s.code}r.appendChild(l);i.appendChild(r)});if(e.fallbackLayer){const s=document.createElement("li"),o=document.createElement("button");o.innerHTML=a.getLocaleString("reprojectOnTheFly");$(o).data(t.FALLBACK_LAYER,e.fallbackLayer);s.appendChild(o);i.appendChild(s)}if(o){const e=document.createElement("li"),t=document.createElement("button");t.classList.add(a._cssClasses.LOAD_CRS_BUTTON);t.innerHTML=a.getLocaleString("showOnTheFlyProjections");e.appendChild(t);i.appendChild(e)}l.appendChild(i);r.classList.remove(TC.Consts.classes.LOADING)});o.querySelector("."+a.CLASS+"-name").innerHTML=s.title||s.name;TC.Util.showModal(o)};e.showMoreLayersDialog=function(){const e=this,t=e._dialogDiv.querySelector("."+e.CLASS+"-more-dialog");e.map.on3DView?t.classList.add(TC.Consts.classes.THREED):t.classList.remove(TC.Consts.classes.THREED);const a=t.querySelector(".tc-modal-body");a.innerHTML="";a.classList.add(TC.Consts.classes.LOADING);t.classList.remove(TC.Consts.classes.HIDDEN);TC.Util.showModal(t,{closeCallback:function(){this._currentSelection.checked=!0;this.update()}.bind(e)});t.querySelector(".tc-modal-window").classList.add(e.CLASS+"-more-dialog");e._getMoreBaseLayers().then(function(){e.getRenderedHtml(e.CLASS,{baseLayers:e._moreBaseLayers},function(t){a.innerHTML=t;a.classList.remove(TC.Consts.classes.LOADING);a.querySelectorAll("li").forEach(function(t,a){t.dataset.layerId=e._moreBaseLayers[a].id});e.update(a)})})};e.getLayer=function(e){return this.map&&(this.map.getLayer(e)||this._moreBaseLayers&&this._moreBaseLayers.filter(function(t){return t.id===e})[0])};const o=function(e){return new Promise(function(t,a){Promise.all([e.getCapabilitiesPromise(),e.getFallbackLayer()?e.getFallbackLayer().getCapabilitiesPromise():Promise.resolve()]).then(function(){t()})})};e._getMoreBaseLayers=function(){const e=this;if(e._moreBaseLayers||e._moreBaseLayersPromise){if(e._moreBaseLayers)return new Promise(function(t,a){Promise.all(e._moreBaseLayers.filter(function(e){return e.type===TC.Consts.layerType.WMS||e.type===TC.Consts.layerType.WMTS}).map(function(t){return e.map.on3DView?o(t):t.getCapabilitiesPromise()})).then(function(){e._moreBaseLayers=e._moreBaseLayers.map(function(t){if(t.type===TC.Consts.layerType.WMTS){var a=t.wrap.getCompatibleMatrixSets(e.map.getCRS())[0];t.mustReproject=!a}else t.type===TC.Consts.layerType.WMS&&(t.mustReproject=!t.isCompatible(e.map.getCRS()));if(e.map.on3DView&&t.mustReproject&&t.getFallbackLayer&&t.getFallbackLayer()){t.mustReproject=!t.getFallbackLayer().isCompatible(e.map.getCRS());return t}return t});t(e._moreBaseLayers)})})}else e._moreBaseLayersPromise=new Promise(function(t,a){var s=TC.Cfg.availableBaseLayers.filter(function(e){return-1==TC.Cfg.availableBaseLayers.filter(function(e){return e.fallbackLayer}).map(function(e){return e.fallbackLayer}).indexOf(e.id)}).map(function(e){return e.type===TC.Consts.layerType.WMS||e.type===TC.Consts.layerType.WMTS?new TC.layer.Raster(e):e.type==TC.Consts.layerType.VECTOR?new TC.layer.Vector(e):void 0});Promise.all(s).then(function(a){e._moreBaseLayers=new Array(a.length);var s=a.length;const r=function(){e._moreBaseLayers=e._moreBaseLayers.filter(function(e){return null!==e});t(e._moreBaseLayers)},n=function(t){const a=this;a.map=e.map;a.isBase=a.options.isBase=!0;if(a.type===TC.Consts.layerType.WMTS){var o=a.wrap.getCompatibleMatrixSets(e.map.getCRS())[0];a.mustReproject=!o}else a.type===TC.Consts.layerType.WMS&&(a.mustReproject=!a.isCompatible(e.map.getCRS()));e.map.on3DView&&a.mustReproject&&a.getFallbackLayer&&a.getFallbackLayer()&&(a.mustReproject=!a.getFallbackLayer().isCompatible(e.map.getCRS()));e._moreBaseLayers.splice(t,1,a);0===--s&&r()};a.forEach(function(t,a){if(t.type===TC.Consts.layerType.WMS||t.type===TC.Consts.layerType.WMTS){(e.map.on3DView?o(t):t.getCapabilitiesPromise()).then(n.bind(t,a),function(t){e._moreBaseLayers.splice(a,1,null);0===--s&&r()})}else n.call(t,a)})})});return e._moreBaseLayersPromise}}();
//# sourceMappingURL=../maps/control/BasemapSelector.min.js.map
