TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");!function(){TC.Consts.classes.CONNECTION_OFFLINE=TC.Consts.classes.CONNECTION_OFFLINE||"tc-conn-offline";TC.Consts.classes.CONNECTION_WIFI=TC.Consts.classes.CONNECTION_WIFI||"tc-conn-wifi";TC.Consts.classes.CONNECTION_MOBILE=TC.Consts.classes.CONNECTION_MOBILE||"tc-conn-mobile";TC.Consts.classes.OFFLINE=TC.Consts.classes.OFFLINE||"tc-offline";TC.control.CacheBuilder=function(){var e=this;TC.control.SWCacheClient.apply(this,arguments);var s=e._classSelector="."+e.CLASS;e._selectors={DRAW:s+"-draw",DRAWING:s+"-drawing",PROGRESS:s+"-progress",NEW:s+"-new",LIST:s+"-list",LISTITEM:s+"-list > li",OKBTN:s+"-btn-ok",NEWBTN:s+"-btn-new",SAVEBTN:".tc-btn-save",CANCELBTN:".tc-btn-cancel",EDITBTN:".tc-btn-edit",VIEWBTN:".tc-btn-view",DELETEBTN:".tc-btn-delete",TILECOUNT:s+"-tile-count",NAMETB:s+"-txt-name",TEXTBOX:"input.tc-textbox",EXIT:s+"-link-exit",OFFPANEL:s+"-off-panel",BLLIST:s+"-bl-list",BLLISTITEM:s+"-bl-list > li",BLLISTTEXT:s+"-bl-panel-txt",RNGMAXRES:s+"-rng-maxres",SEARCH:s+"-map-available-srch",EMPTYLIST:s+"-map-available-empty",OFFLINEHIDDEN:"[data-no-cb]"};e.storedMaps=[];const n=TC.Util.getParameterByName(e.MAP_DEFINITION_PARAM_NAME),a=TC.Util.getParameterByName(e.MAP_EXTENT_PARAM_NAME);e.mapIsOffline=!!n;n&&(e.currentMapDefinition=JSON.parse(window.atob(decodeURIComponent(n))));a&&(e.currentMapExtent=t(a));try{e.localStorage=window.localStorage;const t="__delete_me__";e.localStorage.setItem(t,t);e.localStorage.removeItem(t)}catch(t){e.localStorage=null;TC.error(e.getLocaleString("couldNotAccessLocalStorage"))}if(e.localStorage){for(var r=0,o=e.localStorage.length;r<o;r++){var l=e.localStorage.key(r);if(0===l.indexOf(e.LOCAL_STORAGE_KEY_PREFIX)&&l!==e.LOCAL_STORAGE_KEY_PREFIX+e.ROOT_CACHE_NAME+".hash"){var i=e.localStorage.getItem(l).split(" "),c=t(i.shift()),d={name:i.join(" "),extent:c,url:decodeURIComponent(l.substr(e.LOCAL_STORAGE_KEY_PREFIX.length))};e.storedMaps.push(d)}}e.storedMaps.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0})}var u=TC.Util.extend({},o>1?arguments[1]:arguments[0]);e._dialogDiv=TC.Util.getDiv(u.dialogDiv);window.$&&(e._$dialogDiv=$(e._dialogDiv));u.dialogDiv||document.body.appendChild(e._dialogDiv);e.mapIsOffline&&document.querySelectorAll(e._selectors.OFFLINEHIDDEN).forEach(function(e){e.classList.add(TC.Consts.classes.HIDDEN)});TC.Control.apply(e,arguments);e.wrap=new TC.wrap.control.CacheBuilder(e);e.isDownloading=!1;e.baseLayers=[];e.options.avgTileSize=e.options.avgTileSize||TC.Cfg.avgTileSize;e.requestSchemas=[];e.minResolution=0;e.currentMap=null;e._loadedCount=0;var C=history.pushState;history.pushState=function(t){var s;s=C.apply(history,arguments);if(e._offlinePanelDiv){const t=TC.Util.getQueryStringParams();delete t[e.MAP_DEFINITION_PARAM_NAME];delete t[e.MAP_EXTENT_PARAM_NAME];delete t[e.SERVICE_WORKER_FLAG];var n=TC.Util.getParamString(t);n.length&&(n="?"+n);const s=location.pathname+n+location.hash;e._offlinePanelDiv.querySelector(e._selectors.EXIT).setAttribute("href",s)}return s};var f=navigator.connection||navigator.mozConnection||navigator.webkitConnection||{},T=function(){if(e._offlinePanelDiv){const t=e._offlinePanelDiv.querySelector(e._selectors.OFFPANEL);t.classList.remove(TC.Consts.classes.CONNECTION_OFFLINE,TC.Consts.classes.CONNECTION_MOBILE,TC.Consts.classes.CONNECTION_WIFI);switch(f.type){case 1:case 2:case void 0:t.classList.add(TC.Consts.classes.CONNECTION_WIFI);break;default:t.classList.add(TC.Consts.classes.CONNECTION_MOBILE)}}};f.addEventListener&&f.addEventListener("typechange",T);window.addEventListener("online",T);window.addEventListener("offline",function(){if(e._offlinePanelDiv){const t=e._offlinePanelDiv.querySelector(e._selectors.OFFPANEL);t.classList.add(TC.Consts.classes.CONNECTION_OFFLINE);t.classList.remove(TC.Consts.classes.CONNECTION_MOBILE,TC.Consts.classes.CONNECTION_WIFI)}})};TC.inherit(TC.control.CacheBuilder,TC.control.SWCacheClient);var e=TC.control.CacheBuilder.prototype;e.CLASS="tc-ctl-cbuild";e.MAP_DEFINITION_PARAM_NAME="map-def";e.MAP_EXTENT_PARAM_NAME="map-extent";e.LOCAL_STORAGE_KEY_PREFIX="TC.offline.map.";e.ROOT_CACHE_NAME="root";e.SERVICE_WORKER_FLAG="sw";e._states={READY:"ready",EDIT:"editing",DOWNLOADING:"downloading",DELETING:"deleting"};e._actions={CREATE:"create",DELETE:"delete"};e.offlineControls=["attribution","basemapSelector","cacheBuilder","click","coordinates","draw","edit","geolocation","loadingIndicator","measure","navBar","popup","print","scale","scaleBar","scaleSelector","state","fullScreen"];TC.Consts.event.MAPCACHEDOWNLOAD=TC.Consts.event.MAPCACHEDOWNLOAD||"mapcachedownload.tc";TC.Consts.event.MAPCACHEDELETE=TC.Consts.event.MAPCACHEDELETE||"mapcachedelete.tc";TC.Consts.event.MAPCACHEPROGRESS=TC.Consts.event.MAPCACHEPROGRESS||"mapcacheprogress.tc";TC.Consts.event.MAPCACHEERROR=TC.Consts.event.MAPCACHEERROR||"mapcacheerror.tc";e.template={};e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"offlineMaps"}).w('</h2><div class="tc-ctl-cbuild-content"><div class="tc-ctl-cbuild-draw tc-hidden"></div><i class="tc-ctl-cbuild-map-search-icon"></i><input type="search" list="').f(t.get(["listId"],!1),t,"h").w('" class="tc-ctl-cbuild-map-available-srch tc-textbox" placeholder="').h("i18n",t,{},{$key:"cb.filter.plhr"}).w('"').x(t.get(["storedMaps"],!1),t,{else:s,block:n},{}).w(' maxlength="200" />                <ul id="').f(t.get(["listId"],!1),t,"h").w('" class="tc-ctl-cbuild-list"><li class="tc-ctl-cbuild-map-available-empty"').x(t.get(["storedMaps"],!1),t,{block:a},{}).w("><span>").h("i18n",t,{},{$key:"cb.noMaps"}).w('</span></li><li class="tc-ctl-cbuild-map-not" hidden><span>').h("i18n",t,{},{$key:"noMatches"}).w("</span></li>").s(t.get(["storedMaps"],!1),t,{block:r},{}).w('</ul><div class="tc-ctl-cbuild-new"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-new" disabled title="').h("i18n",t,{},{$key:"newofflinemap"}).w('">').h("i18n",t,{},{$key:"newOfflineMap"}).w('</button></div><div class="tc-ctl-cbuild-drawing tc-hidden"><div class="tc-ctl-cbuild-tile-cmd"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-draw" title="').h("i18n",t,{},{$key:"cancel"}).w('">').h("i18n",t,{},{$key:"cancel"}).w('</button></div></div><div class="tc-ctl-cbuild-progress tc-hidden"><p>').h("i18n",t,{},{$key:"cb.DownloadingMap|s"}).w(': <span class="tc-ctl-cbuild-progress-count"></span></p><div class="tc-ctl-cbuild-progress-bar"><div class="tc-ctl-cbuild-progress-ratio" style="width:0"></div></div><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-dl" title="').h("i18n",t,{},{$key:"cancel"}).w('">').h("i18n",t,{},{$key:"cancel"}).w("</button></div></div>")}t.__dustBody=!0;function s(e,t){return e.w(" disabled")}s.__dustBody=!0;function n(e,t){return e}n.__dustBody=!0;function a(e,t){return e.w(" hidden")}a.__dustBody=!0;function r(e,t){return e.p("tc-ctl-cbuild-map-node",t,t.rebase(t.getPath(!0,[])),{})}r.__dustBody=!0;return t};e.template[e.CLASS+"-map-node"]=function(){dust.register(e.CLASS+"-map-node",t);function t(e,t){return e.w('<li data-extent="').f(t.get(["extent"],!1),t,"h").w('"><span><a href="').f(t.get(["url"],!1),t,"h").w('" title="').f(t.get(["name"],!1),t,"h").w('">').f(t.get(["name"],!1),t,"h").w('</a></span><input class="tc-textbox tc-hidden" type="text" value="').f(t.get(["name"],!1),t,"h").w('" /><button class="tc-btn-save tc-hidden" title="').h("i18n",t,{},{$key:"save"}).w('"></button><button class="tc-btn-cancel tc-hidden" title="').h("i18n",t,{},{$key:"cancel"}).w('"></button><button class="tc-btn-edit" title="').h("i18n",t,{},{$key:"editMapName"}).w('">').h("i18n",t,{},{$key:"editMapName"}).w('</button><button class="tc-btn-view" title="').h("i18n",t,{},{$key:"viewMapExtent"}).w('">').h("i18n",t,{},{$key:"viewMapExtent"}).w('</button><button class="tc-btn-delete" title="').h("i18n",t,{},{$key:"deleteMap"}).w('">').h("i18n",t,{},{$key:"deleteMap"}).w("</button></li>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-bl-node"]=function(){dust.register(e.CLASS+"-bl-node",t);function t(e,t){return e.w('<li class="tc-ctl-cbuild-bl-node" data-layer-uid="').f(t.get(["id"],!1),t,"h").w('"><label style="background-size: 100% 100%; background-image: url(').f(t.get(["thumbnail"],!1),t,"h").w(')"><input type="checkbox" name="cbbl" value="').f(t.get(["id"],!1),t,"h").w('" disabled><span>').f(t.get(["title"],!1),t,"h").w("</span></label></li>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-cbuild-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"newOfflineMap"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"><input type="text" class="tc-ctl-cbuild-txt-name" placeholder="').h("i18n",t,{},{$key:"nameRequired"}).w('" required /><div class="tc-ctl-cbuild-bl-panel"><h4>').h("i18n",t,{},{$key:"availableOfflineMaps"}).w('</h4><p class="tc-ctl-cbuild-bl-panel-txt">').h("i18n",t,{},{$key:"selectAtLeastOne"}).w('</p><ul class="tc-ctl-cbuild-bl-list"></ul></div><div class="tc-ctl-cbuild-res-panel"><h4>').h("i18n",t,{},{$key:"maxRes"}).w('</h4><div class="tc-ctl-cbuild-res"></div><input type="range" class="tc-ctl-cbuild-rng-maxres" disabled value="0" title="').h("i18n",t,{},{$key:"maxRes"}).w('"></div><div class="tc-ctl-cbuild-tile-count"></div></div><div class="tc-modal-footer"><button class="tc-button tc-modal-close tc-ctl-cbuild-btn-ok" disabled>').h("i18n",t,{},{$key:"ok"}).w('</button><button type="button" class="tc-button tc-modal-close tc-ctl-cbuild-btn-cancel">').h("i18n",t,{},{$key:"cancel"}).w("</button></div></div></div>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-off-panel"]=function(){dust.register(e.CLASS+"-off-panel",t);function t(e,t){return e.w('<div class="tc-ctl-cbuild-off-panel tc-conn-wifi"><span>').h("i18n",t,{},{$key:"offlineMap"}).w('</span> <a href="" class="tc-ctl-cbuild-link-exit" title="').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w('"><span>').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w("</span></a></div>")}t.__dustBody=!0;return t};const t=function(e){return decodeURIComponent(e).split(",").map(function(e){return parseFloat(e)})},s=function(e,t){t.querySelector("span").classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.TEXTBOX).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.SAVEBTN).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.CANCELBTN).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.EDITBTN).classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.VIEWBTN).classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.DELETEBTN).classList.remove(TC.Consts.classes.HIDDEN)};var n=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")},a=function(e,t){var s=t||{};const n=e._dialogDiv.querySelector(e._classSelector+"-res"),a=e._dialogDiv.querySelector(e._selectors.RNGMAXRES);var r,o,l,i=e.getResolutions();if(i.length){a.setAttribute("max",i.length-1);if(e.minResolution){if(void 0===s.rangeValue)for(var c=0,d=i.length;c<d;c++)if(e.minResolution>=i[c]){a.value=c;break}}else if(void 0===s.rangeValue){const t=e.map.getResolution();a.value=i.filter(e=>e>t).length}o=parseInt(a.value);var u=Math.floor(1e3*new Number(i[o]))/1e3;r=e.getLocaleString("metersPerPixel",{value:u.toLocaleString((e.map?e.map.options.locale:TC.Cfg.locale).replace("_","-"))});l=100*(o+1)/(i.length+1)+"%";a.disabled=!1;e.minResolution=i[a.value]}else{o=0;r="";a.value=0;l="0";e.minResolution=0;a.disabled=!0}n.style.left=l;n.innerHTML=r};const r=function(e){e._dialogDiv.querySelectorAll(e._classSelector+"-bl-node input[type=checkbox]").forEach(function(t,s){if(t.checked){var n=e.requestSchemas.filter(function(e){return e.layerId===t.value})[0];if(n){var a=function(e,t){for(var s=null,n=0,a=e.tileMatrixLimits.length;n<a&&!((s=e.tileMatrixLimits[n]).res<=t);n++);return s}(n,e.minResolution);if(a){var r=n.url;if(r.indexOf("{TileMatrix}")<0){var o=r.indexOf("?");o>=0&&(r=r.substr(0,o));for(var l=0,i=e.baseLayers.length;l<i;l++){var c=e.baseLayers[l];if(c.id===n.layerId){r=r+"?layer="+c.layerNames+"&style=default&tilematrixset="+c.matrixSet+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+c.format+"&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}";break}}}for(;t&&"LABEL"!==t.tagName;)t=t.parentElement;if(t){t.style.backgroundSize="auto";t.style.backgroundPosition="left bottom";t.style.backgroundImage="url("+r.replace("{TileMatrix}",a.mId).replace("{TileRow}",a.rt).replace("{TileCol}",a.cl)+")"}}}}})},o=function(e,t){return t<1?e.getLocaleString("lessThan1Mb"):e.getLocaleString("approxXMb",{quantity:n(t)})},l=function(e){var t="";e.tileCount=0;for(var s=0,a=e.requestSchemas.length;s<a;s++)for(var r=e.requestSchemas[s],l=0,i=r.tileMatrixLimits.length;l<i;l++){var c=r.tileMatrixLimits[l];e.tileCount+=(c.cr-c.cl+1)*(c.rb-c.rt+1);if(c.res<e.minResolution)break}if(e.tileCount){e.estimatedMapSize=Math.round(e.tileCount*e.options.avgTileSize/1048576);t=e.getLocaleString("xTiles",{quantity:n(e.tileCount)})+" ("+o(e,e.estimatedMapSize)+")"}e._dialogDiv.querySelector(e._selectors.TILECOUNT).innerHTML=t},i=function(e,t){var s=t.indexOf("#");s>=0&&(t=t.substr(0,s));const n=e.div.querySelectorAll(e._selectors.LISTITEM);for(var a=0,r=n.length;a<r;a++){const e=n[a],s=e.querySelector("a");if(s&&s.getAttribute("href")===t)return e}return null};var c=function(e,t){var s=!1;if(e.localStorage){e.localStorage.setItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t.url),t.extent+" "+t.name);s=!0}return s};const d=function(e,t){const s=e.findStoredMap({url:t});if(s){if(function(e,t){var s=!1;if(e.localStorage){e.localStorage.removeItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t));s=!0}return s}(e,t)){const t=function(e,t){const s=e.div.querySelectorAll(e._selectors.LISTITEM);for(var n=0,a=s.length;n<a;n++){const e=s[n],a=e.querySelector("a");if(a&&a.innerHTML===t)return e}return null}(e,s.name);t&&t.parentElement.removeChild(t)}var n=e.storedMaps.indexOf(s);e.storedMaps.splice(n,1);if(!e.storedMaps.length){e.div.querySelector(e._selectors.SEARCH).disabled=!0;e.div.querySelector(e._selectors.EMPTYLIST).removeAttribute("hidden")}return s.name}return null};e.render=function(e){const n=this;return n._set1stRenderPromise(new Promise(function(o,d){var u={storedMaps:n.storedMaps,listId:n.CLASS+"-list-"+TC.getUID()};n.getRenderedHtml(n.CLASS+"-dialog",null,function(e){n._dialogDiv.innerHTML=e;n._dialogDiv.querySelector(n._selectors.NAMETB).addEventListener(TC.Consts.event.CLICK,function(e){e.preventDefault();this.selectionStart=0;this.selectionEnd=this.value.length;this.focus()})}).then(function(){n.renderData(u,function(){n._dialogDiv.querySelector(n._selectors.OKBTN).addEventListener(TC.Consts.event.CLICK,function(){n.generateCache()});n._dialogDiv.querySelector(n._selectors.NAMETB).addEventListener("input",function(){n._updateReadyState()});n.div.querySelector(n._selectors.NEWBTN).addEventListener(TC.Consts.event.CLICK,function(){n.setEditState()});n.div.querySelector(n._classSelector+"-btn-cancel-draw").addEventListener(TC.Consts.event.CLICK,function(){n.setReadyState()});n.div.querySelector(n._classSelector+"-btn-cancel-dl").addEventListener(TC.Consts.event.CLICK,function(){n.cancelCacheRequest()});const o=n.div.querySelector(n._selectors.LIST);o.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(n._selectors.DELETEBTN,function(e){n.startDeleteMap(e.target.parentElement.querySelector("a").innerHTML)}));o.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(n._selectors.EDITBTN,function(e){!function(e,t){t.querySelector("span").classList.add(TC.Consts.classes.HIDDEN);const s=t.querySelector(e._selectors.TEXTBOX);s.classList.remove(TC.Consts.classes.HIDDEN);s.value=t.querySelector("span a").innerHTML;s.focus();t.querySelector(e._selectors.SAVEBTN).classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.CANCELBTN).classList.remove(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.EDITBTN).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.VIEWBTN).classList.add(TC.Consts.classes.HIDDEN);t.querySelector(e._selectors.DELETEBTN).classList.add(TC.Consts.classes.HIDDEN)}(n,e.target.parentElement)}));o.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(n._selectors.CANCELBTN,function(e){const t=e.target.parentElement;t.querySelector(n._selectors.TEXTBOX).value=t.querySelector("a").innerHTML;s(n,t)}));o.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(n._selectors.SAVEBTN,function(e){const t=e.target.parentElement;s(n,t);const a=t.querySelector("a"),r=(a.innerHTML,t.querySelector(n._selectors.TEXTBOX).value),o=n.findStoredMap({url:a.getAttribute("href")});if(o){o.name=r;a.innerHTML=r;a.setAttribute("title",r);c(n,o)}}));o.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(n._selectors.VIEWBTN,function(e){const s=e.target;var a=!s.classList.contains(TC.Consts.classes.ACTIVE);const r=n.div.querySelector(n._selectors.VIEWBTN);r.classList.remove(TC.Consts.classes.ACTIVE);r.parentElement.classList.remove(TC.Consts.classes.ACTIVE);const o=s.parentElement.querySelector("a").innerHTML;if(o){var l=n.findStoredMap({name:o});if(l){var i=t(l.extent);n.layer.clearFeatures();if(a){n.layer.addPolygon([[[i[0],i[1]],[i[0],i[3]],[i[2],i[3]],[i[2],i[1]]]],{showsPopup:!1}).then(function(){n.layer.map.zoomToFeatures(n.layer.features)});s.classList.add(TC.Consts.classes.ACTIVE);s.parentElement.classList.add(TC.Consts.classes.ACTIVE);s.setAttribute("title",n.getLocaleString("removeMapExtent"))}}}}));const d=n.div.querySelector(n._selectors.SEARCH),u=function(){!function(e){e=e.toLowerCase();const t=n.div.querySelectorAll(n._selectors.LISTITEM);t.forEach(function(e){e.style.display="none"});const s=[];t.forEach(function(e){e.matches("li:not([class]),li."+TC.Consts.classes.ACTIVE)&&s.push(e)});if(0===e.length){s.forEach(function(e){e.style.removeProperty("display")});n.div.querySelector(n._classSelector+"-map-search-icon").style.visibility="visible"}else{n.div.querySelector(n._classSelector+"-map-search-icon").style.visibility="hidden";var a=new RegExp(e,"i");s.forEach(function(e){e.style.display=a.test(e.querySelector("a").textContent)?"":"none"});s.some(function(e){return!e.hidden})||t.forEach(function(e){e.matches('[class^="tc-ctl-cbuild-map-not"]')&&e.style.removeProperty("display")})}}(this.value.toLowerCase().trim())};d.addEventListener("keyup",u);d.addEventListener("search",u);n._dialogDiv.querySelector(n._selectors.BLLIST).addEventListener("change",TC.EventTarget.listenerBySelector("input[type=checkbox]",function(e){const t=e.target;if(t.checked)n.baseLayers.push(n.map.getLayer(t.value));else for(var s=0,o=n.baseLayers.length;s<o;s++){if(n.baseLayers[s].id===t.value){n.baseLayers.splice(s,1);break}}n.updateRequestSchemas();a(n);r(n);n._updateReadyState();l(n)}));const C=n._dialogDiv.querySelector(n._selectors.RNGMAXRES),f=function(e){a(n,{rangeValue:e.target.value});r(n);l(n)};C.addEventListener("input",f);C.addEventListener("change",f);const T=i(n,location.href);T&&T.classList.add(TC.Consts.classes.ACTIVE);TC.Util.isFunction(e)&&e()}).then(function(){o()}).catch(function(e){d(e instanceof Error?e:Error(e))})});window.addEventListener("beforeunload",function(e){if(n.isDownloading){var t=n.getLocaleString("cb.mapDownloading.warning");e.returnValue=t;return t}},!0)}))};e.register=function(e){var t=this;const s=TC.control.SWCacheClient.prototype.register.call(t,e);t.getServiceWorker().then(function(){navigator.serviceWorker.ready.then(function(){navigator.serviceWorker.addEventListener("message",function(e){switch(e.data.event){case"progress":t.trigger(TC.Consts.event.MAPCACHEPROGRESS,{url:e.data.name,loaded:e.data.count,total:e.data.total});break;case"cached":t.trigger(TC.Consts.event.MAPCACHEDOWNLOAD,{url:e.data.name});break;case"deleted":t.trigger(TC.Consts.event.MAPCACHEDELETE,{url:e.data.name});break;case"error":e.data.action===t._actions.CREATE&&TC.error(t.getLocaleString("cb.resourceDownload.error",{url:e.data.url}))}})});navigator.onLine&&new Promise(function(e,t){var s=document.documentElement.getAttribute("manifest")||"manifest.appcache";s?TC.ajax({url:s,method:"GET",responseType:"text"}).then(function(t){var s=t.data;TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){var t=hex_md5(s),n=s.indexOf("NETWORK:");n>=0&&(s=s.substr(0,n));(n=s.indexOf("FALLBACK:"))>=0&&(s=s.substr(0,n));(n=s.indexOf("SETTINGS:"))>=0&&(s=s.substr(0,n));var a=s.split(/[\n\r]/).filter(function(e){return e.length>0&&0!==e.indexOf("#")&&"CACHE:"!==e});a.shift();e({hash:t,urls:a})})}).catch(function(e){t(e)}):t(Error("There is no manifest in document"))}).then(function(e){const s=t.LOCAL_STORAGE_KEY_PREFIX+t.ROOT_CACHE_NAME+".hash";var n;t.localStorage&&(n=t.localStorage.getItem(s));if(n!==e.hash){t.cacheUrlList(e.urls);t.one(TC.Consts.event.MAPCACHEDOWNLOAD,function(){const a=!n;t.localStorage&&t.localStorage.setItem(s,e.hash);a||TC.confirm(t.getLocaleString("newAppVersionAvailable"),function(){location.reload()})})}})},function(e){t.renderPromise().then(function(){const s=t.div.querySelector(`.${t.CLASS}-new`),n=document.createElement("div");n.classList.add("tc-alert","alert-warning");const a=document.createElement("p"),r=document.createElement("strong");r.innerHTML=t.getLocaleString("offlineMap.error");a.appendChild(r);const o=document.createElement("p");o.innerHTML=e.message;n.appendChild(a);n.appendChild(o);s.querySelector(t._selectors.NEWBTN).classList.add(TC.Consts.classes.HIDDEN);s.appendChild(n)})}).catch(()=>console.log("No SW available: no events handled"));if(t.mapIsOffline){e.div.classList.add(TC.Consts.classes.OFFLINE);t._offlinePanelDiv=TC.Util.getDiv(t.options.offlinePanelDiv);t.options.offlinePanelDiv||e.div.appendChild(t._offlinePanelDiv);t.getRenderedHtml(t.CLASS+"-off-panel",null,function(e){t._offlinePanelDiv.innerHTML=e;if(!navigator.onLine){const e=t._offlinePanelDiv.querySelector(t._selectors.OFFPANEL);e.classList.add(TC.Consts.classes.CONNECTION_OFFLINE);e.classList.remove(TC.Consts.classes.CONNECTION_MOBILE,TC.Consts.classes.CONNECTION_WIFI)}t._offlinePanelDiv.querySelector(t._selectors.EXIT).addEventListener(TC.Consts.event.CLICK,function(e){TC.confirm(t.getLocaleString("offlineMapExit.confirm"),null,function(){e.preventDefault()})})})}const n=t.getUID(),a=t.getUID();t.layerPromise=e.addLayer({id:a,type:TC.Consts.layerType.VECTOR,stealth:!0,owner:t,styles:{line:e.options.styles.line}});t.layer=null;Promise.all([t.layerPromise,t.renderPromise(),e.addControl("draw",{id:n,div:t.div.querySelector(t._selectors.DRAW),mode:TC.Consts.geom.RECTANGLE,persistent:!1})]).then(function(s){const n=t.layer=s[0],a=t.boxDraw=s[2];a.setLayer(n);a.on(TC.Consts.event.DRAWSTART,function(e){t.map.toast(t.getLocaleString("clickOnDownloadAreaOppositeCorner"),{type:TC.Consts.msgType.INFO})}).on(TC.Consts.event.DRAWEND,function(e){var s=e.feature.geometry[0],n=s[0],a=s[2],o=Math.min(n[0],a[0]),i=Math.max(n[0],a[0]),c=Math.min(n[1],a[1]),d=Math.max(n[1],a[1]);t.setExtent([o,c,i,d]);const u=t._dialogDiv.querySelectorAll("input[type=checkbox]");u.forEach(function(e){const s=t.map.getLayer(e.value);for(var n=e;n&&"LI"!==n.tagName;)n=n.parentElement;const a=t.wrap.getRequestSchemas({extent:t.extent,layers:[s]})[0].tileMatrixLimits;n.classList.toggle(TC.Consts.classes.HIDDEN,!a.length)});const C=t._dialogDiv.querySelector(t._selectors.BLLISTITEM+":not(."+TC.Consts.classes.HIDDEN+")");t._dialogDiv.querySelector(t._selectors.BLLISTTEXT).innerHTML=t.getLocaleString(C?"selectAtLeastOne":"cb.noMapsAtSelectedExtent");r(t);l(t);TC.Util.showModal(t._dialogDiv.querySelector(t._classSelector+"-dialog"),{openCallback:function(){setTimeout(function(){u.forEach(function(e){e.disabled=!1})},100);var e;if(Date.prototype.toLocaleString){var s={};s.year=s.month=s.day=s.hour=s.minute=s.second="numeric";e=(new Date).toLocaleString(t.map.options.locale.replace("_","-"),s)}else e=(new Date).toString();t._dialogDiv.querySelector(t._selectors.NAMETB).value=e;t._updateReadyState()},closeCallback:function(){u.forEach(function(e){e.disabled=!0});t.boxDraw.layer.clearFeatures()}})});e.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){a===e.control&&t._state===t._states.EDITING&&t.setReadyState()})});var o=function(e){var s=!1;const n=t._dialogDiv.querySelector(t._selectors.BLLIST),a=function(){return!!n.querySelector('li[data-layer-uid="'+e.id+'"]')};var r=e.type===TC.Consts.layerType.WMTS&&!e.mustReproject;TC.Util.detectSafari()&&TC.Util.detectIOS()&&(r=r&&TC.Util.isSameOrigin(e.url));if(r&&!a()){s=!0;t.getRenderedHtml(t.CLASS+"-bl-node",e,function(e){if(!a()){const t=new DOMParser;n.appendChild(t.parseFromString(e,"text/html").body.firstChild)}})}return s};e.on(TC.Consts.event.LAYERADD,function(e){if(e.layer.isBase&&t.mapIsOffline){const s=e.layer.getResolutions();if(s){const n=s.filter(e=>e>=t.currentMapDefinition.res);n.length&&e.layer.setResolutions(n)}}t.renderPromise().then(function(){o(e.layer)})}).on(TC.Consts.event.LAYERREMOVE,function(e){t.renderPromise().then(function(){const s=e.layer;if(s.type===TC.Consts.layerType.WMTS){const e=t._dialogDiv.querySelector(t._selectors.BLLIST).querySelector('li[data-layer-uid="'+s.id+'"]');e.parentElement.removeChild(e)}})});e.ready(function(){if(t.mapIsOffline){var s,n,a=[];for(s=0,n=t.offlineControls.length;s<n;s++){var r=t.offlineControls[s];r=r.substr(0,1).toUpperCase()+r.substr(1);a=a.concat(e.getControlsByClass("TC.control."+r))}for(s=0,n=e.controls.length;s<n;s++){var o=e.controls[s];a.indexOf(o)<0&&o.disable()}document.querySelectorAll(t._selectors.OFFLINEHIDDEN).forEach(function(e){e.classList.add(TC.Consts.classes.HIDDEN)})}});e.loaded(function(){t.layerPromise.then(function(t){e.putLayerOnTop(t)});t.renderPromise().then(function(){t.div.querySelector(t._selectors.NEWBTN).disabled=!1;e.baseLayers.forEach(o)});if(t.mapIsOffline){const s=t.currentMapDefinition,n=function(e,t){return(0===e.url.indexOf("//")?location.protocol+e.url:e.url)===s.url[t.urlIdx]&&e.layerNames===t.id&&e.matrixSet===s.tms[t.tmsIdx]},a=e.options.availableBaseLayers.filter(e=>e.type===TC.Consts.layerType.WMTS).filter(e=>s.layers.some(t=>n(e,t))).filter(t=>!e.baseLayers.some(e=>e.id===t.id));Promise.all(a.map(t=>e.addLayer(TC.Util.extend({},t,{isBase:!0})))).finally(function(){const a=[];for(var r=0,o=s.layers.length;r<o;r++)for(var l=0,i=e.baseLayers.length;l<i;l++){const t=e.baseLayers[l];if(t.type===TC.Consts.layerType.WMTS&&n(t,s.layers[r])){a.push(t);break}}a.length&&e.setBaseLayer(a[0],function(){for(var s=e.baseLayers.length-1;s>=0;s--){const t=e.baseLayers[s];t.type===TC.Consts.layerType.VECTOR||a.includes(t)||e.removeLayer(t)}e.setExtent(t.currentMapExtent,{animate:!1})})})}});t.on(TC.Consts.event.MAPCACHEDOWNLOAD,function(s){t.isDownloading=!1;const n=function(e){const t=e.indexOf("#");return t>=0?e.substr(0,t):e}(s.url),a=i(t,n);if(a&&!t.serviceWorkerEnabled){a.classList.remove(TC.Consts.classes.DISABLED);TC.alert(t.getLocaleString("cb.delete.error"))}else if(t.currentMap&&n===t.currentMap.url){!function(e){const t=e.currentMap;if(c(e,t)){e.getRenderedHtml(e.CLASS+"-map-node",{name:t.name,url:t.url},function(t){const s=new DOMParser;e.div.querySelector(e._selectors.LIST).appendChild(s.parseFromString(t,"text/html").body.firstChild);e.div.querySelector(e._selectors.EMPTYLIST).setAttribute("hidden","hidden");e.div.querySelector(e._selectors.SEARCH).disabled=!1});e.storedMaps.push(t)}}(t);e.toast(t.getLocaleString("mapDownloaded",{mapName:t.currentMap.name}))}t.currentMap=null;t.setReadyState()}).on(TC.Consts.event.MAPCACHEDELETE,function(s){t.isDownloading=!1;var n=d(t,s.url)||t.currentMap&&t.currentMap.name;t.currentMap=null;n&&e.toast(t.getLocaleString("mapDeleted",{mapName:n}));t.setReadyState()}).on(TC.Consts.event.MAPCACHEPROGRESS,function(e){var s=e.total;!s&&t.requestSchemas&&(s=t.requestSchemas[0].tileCount);var n=e.loaded;if(n)t._loadedCount=n;else{t._loadedCount+=1;n=t._loadedCount}t.showDownloadProgress(n,s)}).on(TC.Consts.event.MAPCACHEERROR,function(e){t.isDownloading=!1;t.setReadyState();var s=t.getLocaleString("cb.mapCreation.error"),n=!0;switch(e.reason){case"quota":s+=". "+t.getLocaleString("cb.mapCreation.error.reasonQuota");break;case"resource":s+=". "+t.getLocaleString("cb.mapCreation.error.reasonResource");break;case"manifest":"410"==e.status&&d(t,e.url);n=!1;break;case"already_exists":s+=". "+t.getLocaleString("cb.mapCreation.error.reasonAlreadyExists")}if(n)if(TC.Util.detectIE()){TC.error(s);TC.alert(t.getLocaleString("cb.mapCreation.error.reasonEdge"))}else TC.alert(s);t.currentMap=null});return s};e.setExtent=function(e){if(Array.isArray(e)&&e.length>=4){this.extent=e;this.updateRequestSchemas()}};e._updateReadyState=function(){this._dialogDiv.querySelector(this._selectors.OKBTN).disabled=!this.extent||0===this._dialogDiv.querySelector(this._selectors.NAMETB).value.length||this._dialogDiv.querySelector(this._selectors.RNGMAXRES).disabled};e.setReadyState=function(){const e=this;e._state=e._states.READY;e.showDownloadProgress(0,1);e.div.querySelector(e._selectors.DRAWING).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.PROGRESS).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.NEW).classList.remove(TC.Consts.classes.HIDDEN);e.div.querySelectorAll(e._selectors.LISTITEM).forEach(function(e){e.classList.remove(TC.Consts.classes.DISABLED)});e._dialogDiv.querySelector(e._selectors.OKBTN).disabled=!0;e.div.querySelector(e._selectors.NEWBTN).disabled=!1;e._dialogDiv.querySelector(e._selectors.TILECOUNT).innerHTML="";e.extent=null;e._loadedCount=0;e.boxDraw&&e.boxDraw.cancel()};e.setEditState=function(){this._state=this._states.EDITING;this.showDownloadProgress(0,1);this.div.querySelector(this._selectors.NEW).classList.add(TC.Consts.classes.HIDDEN);this.div.querySelector(this._selectors.PROGRESS).classList.add(TC.Consts.classes.HIDDEN);this.div.querySelector(this._selectors.DRAWING).classList.remove(TC.Consts.classes.HIDDEN);this.map.toast(this.getLocaleString("clickOnDownloadAreaFirstCorner"),{type:TC.Consts.msgType.INFO});this._dialogDiv.querySelector(this._selectors.OKBTN).disabled=!0;this.div.querySelector(this._selectors.NEWBTN).disabled=!0;this._dialogDiv.querySelector(this._selectors.NAMETB).value="";this.boxDraw.activate()};e.generateCache=function(){const e=this,t={mapName:e._dialogDiv.querySelector(e._selectors.NAMETB).value};if(e.findStoredMap({name:t.mapName}))TC.alert(e.getLocaleString("cb.mapNameAlreadyExists.error",t));else{var s=function(){e.div.querySelector(e._classSelector+"-name").innerHTML=t.mapName;e.map.toast(e.getLocaleString("downloadingMap",{mapName:t.mapName}));!function(e){e._state=e._states.DOWNLOADING;TC.Util.closeModal();e.showDownloadProgress(0,1);e.div.querySelector(e._selectors.NEW).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.DRAWING).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.PROGRESS).classList.remove(TC.Consts.classes.HIDDEN);e._dialogDiv.querySelector(e._selectors.OKBTN).disabled=!0;e.div.querySelector(e._selectors.NEWBTN).disabled=!0;e.layer.clearFeatures();e.boxDraw.cancel()}(e);e.requestCache(t)};navigator.storage&&navigator.storage.estimate?navigator.storage.estimate().then(function(n){const a=(n.quota-n.usage)/1048576;e.estimatedMapSize<a?s():TC.confirm(e.getLocaleString("cb.mapCreation.warning.reasonSize",{mapName:t.mapName,mapSize:o(e,e.estimatedMapSize),availableStorage:o(e,Math.round(a))}),s)}):s()}};e.cacheUrlList=function(e,t){var s=t||{};this.createCache(s.name||this.LOCAL_STORAGE_KEY_PREFIX+this.ROOT_CACHE_NAME,{urlList:e,silent:s.silent})};e.requestCache=function(e){var t=this,s=e||{};if(t.map){var n=s.extent||t.extent||t.map.getExtent();t.updateRequestSchemas({extent:n});if(t.requestSchemas){for(var a=function(e,s,n){var a=e.res>=t.minResolution;!a&&s>0&&(a=n[s-1].res>t.minResolution);return a},r=function(e){return{mId:e.mId,cl:e.cl,cr:e.cr,rt:e.rt,rb:e.rb}},o=t.requestSchemas.map(function(e){return{layerId:e.layerId,tileMatrixLimits:e.tileMatrixLimits.filter(a)}}),l=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],i=0,c=o.length;i<c;i++){var d=o[i],u=(M=d.tileMatrixLimits[d.tileMatrixLimits.length-1]).res*M.tSize;l[0]=Math.min(l[0],M.origin[0]+u*M.cl);l[1]=Math.min(l[1],M.origin[1]-u*(M.rb+1));l[2]=Math.max(l[2],M.origin[0]+u*(M.cr+1));l[3]=Math.max(l[3],M.origin[1]-u*M.rt);d.tileMatrixLimits=d.tileMatrixLimits.map(r)}var C=Math.pow(10,t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),f={bBox:l=l.map(function(e,t){return(t<3?Math.ceil:Math.floor)(e*C)/C}),res:Math.floor(1e3*t.minResolution)/1e3,url:[],tms:[],format:[],layers:new Array(t.baseLayers.length)};for(i=0,c=t.baseLayers.length;i<c;i++){var T=t.baseLayers[i],E=0===T.url.indexOf("//")?location.protocol+T.url:T.url,v=f.url.indexOf(E);v<0&&(v=f.url.push(E)-1);var m=f.tms.indexOf(T.matrixSet);m<0&&(m=f.tms.push(T.matrixSet)-1);var p=T.format.substr(T.format.indexOf("/")+1),S=f.format.indexOf(p);S<0&&(S=f.format.push(p)-1);f.layers[i]={urlIdx:v,id:T.layerNames,tmsIdx:m,formatIdx:S}}var h=TC.Util.getQueryStringParams(),g=h[t.MAP_EXTENT_PARAM_NAME]=l.toString();h[t.MAP_DEFINITION_PARAM_NAME]=btoa(JSON.stringify(f));t.serviceWorkerEnabled&&(h[t.SERVICE_WORKER_FLAG]=1);var y=location.origin+location.pathname.substr(0,location.pathname.lastIndexOf("/")+1)+"?"+TC.Util.getParamString(h);t.currentMap={name:s.mapName,extent:g,url:y};t.isDownloading=!0;if(t.serviceWorkerEnabled){const e=[];for(i=0,c=o.length;i<c;i++){for(var L=o[i],_=null,b=0,N=t.baseLayers.length;b<N;b++){var I=t.baseLayers[b];if(I.id===L.layerId){_=t.wrap.getGetTilePattern(I);I.getFallbackLayer&&I.getFallbackLayer();I.thumbnail&&e.push(I.thumbnail);break}}if(_)for(var D=0,A=L.tileMatrixLimits.length;D<A;D++)for(var M,O=(M=L.tileMatrixLimits[D]).rt;O<=M.rb;O++)for(var w=M.cl;w<=M.cr;w++)e.push(_.replace("{TileMatrix}",M.mId).replace("{TileCol}",w).replace("{TileRow}",O))}e.push(y);t.cacheUrlList(e,{name:y})}}}};e.cancelCacheRequest=function(){var e=this;e.currentMap&&e.deleteCache(e.currentMap.url).then(function(t){t||(e.currentMap=null)});e.isDownloading=!1;e.setReadyState()};e.deleteMap=function(e){var t=this.findStoredMap({name:e});t&&this.deleteCache(t.url)};e.startDeleteMap=function(e){const t=this;if(navigator.onLine){if(e){var s=t.getLocaleString("cb.delete.confirm",{mapName:e});t.serviceWorkerEnabled||(s=s+" "+t.getLocaleString("cb.delete.confirm.connect.warning"));if(confirm(s))if(navigator.onLine){!function(e){e._state=e._states.DELETING;e.showDownloadProgress(0,1);e.div.querySelector(e._selectors.DRAWING).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.PROGRESS).classList.add(TC.Consts.classes.HIDDEN);e.div.querySelector(e._selectors.NEW).classList.remove(TC.Consts.classes.HIDDEN);e.div.querySelectorAll(e._selectors.LISTITEM).forEach(function(e){e.classList.add(TC.Consts.classes.DISABLED)});e._dialogDiv.querySelector(e._selectors.OKBTN).disabled=!0;e.div.querySelector(e._selectors.NEWBTN).disabled=!1;e._dialogDiv.querySelector(e._selectors.TILECOUNT).innerHTML="";e.boxDraw.cancel()}(t);t.deleteMap(e)}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))}}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))};e.findStoredMap=function(e){return this.storedMaps.filter(function(t){var s=!0;e.name&&e.name!==t.name&&(s=!1);s&&e.url&&e.url!==t.url&&(s=!1);return s})[0]};e.showDownloadProgress=function(e,t){const s=this,n=s._classSelector,a=s.div.querySelector(n+"-progress-count");if(t){var r=Math.min(Math.round(100*e/t),100)+"%";s.div.querySelector(n+"-progress-ratio").style.width=r;a.innerHTML=r}else{s.div.querySelector(n+"-progress-bar").classList.add(TC.Consts.classes.HIDDEN);a.innerHTML=s.getLocaleString("xFiles",{quantity:e})}};e.updateRequestSchemas=function(e){var t=e||{};t.extent=t.extent||this.extent;t.layers=t.layers||this.baseLayers;this.requestSchemas=this.wrap.getRequestSchemas(t);return this.requestSchemas};e.getResolutions=function(){var e=[];const t=function(e){return e.res},s=this.requestSchemas.map(function(e){return e.tileMatrixLimits.map(t)});(e=e.concat.apply(e,s)).sort(function(e,t){return t-e});return e}}();
//# sourceMappingURL=../maps/control/CacheBuilder.min.js.map