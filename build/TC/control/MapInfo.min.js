TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.MapInfo=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.MapInfo,TC.Control);!function(){var t=TC.control.MapInfo.prototype;t.CLASS="tc-ctl-mi";t.register=function(t){const e=this,n=TC.Control.prototype.register.call(e,t);e.QR_MAX_URL_LENGTH=150;e.SHORTEN_URL_LENGTH=32715;e.exportsState=!1;e.includeControls=void 0===e.options.includeControls||e.options.includeControls;t.ready(function(){const n=t.state&&t.state.ctl;if(n&&!t._controlStatesLoaded){e.importControlStates(n);t._controlStatesLoaded=!0}});return n};t.exportControlStates=function(){const t=this;return t.map?t.map.controls.map(function(t){return t.exportState()}).filter(function(t){if(t)for(var e in t)if(t.hasOwnProperty(e))return!0;return!1}):[]};t.importControlStates=function(t){const e=this;e.map&&t.forEach(function(t){const n=e.map.getControlById(t.id);n&&e.map.loaded(function(){n.importState(t)})})};t.exportState=function(){const t=this;if(t.exportsState){const n={};if(t.featureToShare||t.sharedFeaturesLayer){var e;n.id=t.id;if(t.featureToShare){const n=t.featureToShare.clone();n.showsPopup=!0;e=t.featureToShare.layer.exportState({features:[n]})}else e=t.sharedFeaturesLayer.exportState();n.features=e.features;e.crs&&(n.crs=e.crs)}return n}return null};t.importState=function(t){const e=this;e.map&&t.features.length&&e.map.addLayer({id:e.getUID(),type:TC.Consts.layerType.VECTOR,title:e.getLocaleString("foi"),stealth:!0}).then(function(n){e.sharedFeaturesLayer=n;n.importState({features:t.features,crs:t.crs}).then(function(){e.map.zoomToFeatures(n.features)})})};t.manageMaxLengthExceed=function(){throw"Falta implementaci\xf3n del m\xe9todo manageMaxLengthExceed"};t.generateLink=function(){var t=window.location.href,e=t.indexOf("#");e>0&&(t=t.substring(0,e));if(this.extraParams){var n=TC.Util.getQueryStringParams(t);$.extend(n,this.extraParams);var o=t.indexOf("?");o>=0&&(t=t.substring(0,o));t=t.concat("?",$.param(n))}TC.Util.getParameterByName("lang").length>0&&(t=t.indexOf("&")>-1?t.replace("lang="+TC.Util.getParameterByName("lang")+"&",""):t.replace("?lang="+TC.Util.getParameterByName("lang"),""));const r=this.includeControls?this.exportControlStates():[];this.exportsState&&(this.featureToShare||this.sharedFeaturesLayer)&&r.push(this.exportState());const a=r.length?{ctl:r}:void 0;var i=this.map.getMapState(a),s=t.concat("#",i);this.manageMaxLengthExceed({browser:s.length>TC.Consts.URL_MAX_LENGTH,qr:s.length>this.SHORTEN_URL_LENGTH});return s};t.shortenedLink=function(){const t=this;var e;return new Promise(function(n,o){var r=function(){var e=t.generateLink(),n=e.indexOf("?"),o=e.indexOf("#");n>0&&(e=n<o?e.replace(e.substring(n,o),""):e.replace(e.substring(n,e.length-1),""));return e}();if(r.length>t.QR_MAX_URL_LENGTH&&r.length<t.SHORTEN_URL_LENGTH){e=t.map.getLoadingIndicator().addWait();(function(t){TC.tool&&TC.tool.Proxification||TC.syncLoadJS(TC.apiLocation+"TC/tool/Proxification");var e=new FormData;e.append("url",t);return new TC.tool.Proxification(TC.proxify,{allowedMixedContent:!1}).fetch("https://tinyurl.com/api-create.php",{type:"POST",data:e}).then(function(t){return t}).catch(function(t){return null})})(r).then(function(o){if(o&&o.responseText){t.map.getLoadingIndicator().removeWait(e);n(o.responseText.replace("http://","https://"))}else onerror()},onerror)}else{r.length>=t.SHORTEN_URL_LENGTH&&function(){t.map.toast(t.getLocaleString("urlTooLongForShortener"),{type:TC.Consts.msgType.ERROR});t.map.getLoadingIndicator().removeWait(e);n("")}();n("")}})};t.makeQRCode=function(t,e,n){const o=this;return new Promise(function(r,a){TC.loadJS("undefined"==typeof QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){o.shortenedLink().then(function(o){if((o=o||"").length>0){var a={text:o};if(e&&n){a.width=e;a.height=n}new MutationObserver(function(t,e){var n=t.filter(function(t){return"attributes"===t.type}).filter(function(t){return t.attributeName.indexOf("src")>-1});if(n.length>0){e.disconnect();r(n[0].target.src)}}).observe(t,{attributes:!0,childList:!0,subtree:!0});new QRCode(t,a)}else r()})})})};t.drawScaleBarIntoCanvas=function(t){var e,n=this.map.getControlsByClass(TC.control.ScaleBar);if(0==n.length)return null;var o=(e=(t=t||{}).canvas?t.canvas:document.createElement("CANVAS")).getContext("2d");o.save();var r,a,i=document.getElementsByClassName("ol-scale-line-inner").item(0),s=$.extend({},i.getBoundingClientRect()),l=i.textContent;o.beginPath();o.strokeStyle=window.getComputedStyle(i).borderColor;if(s.width>s.height){r=s.width;a=s.height}else{r=s.height;a=s.width}if(t.setSize){e.width=r;e.height=a}s.left=void 0!=t.left?t.left:15;s.top=void 0!=t.top?t.top:15;o.moveTo(s.left,s.top);o.lineTo(s.left,s.top+a);o.lineTo(s.left+r,s.top+a);o.lineTo(s.left+r,s.top);o.stroke();o.measureText(l);var c={x:s.left+r/2,y:s.top+a/2};t.fill&&function(e,o,r){var a=document.getElementsByClassName(n[0].CLASS).item(0),i=$.extend({},a.getBoundingClientRect());i.left=(t.left||15)-2;i.top=t.top||15;i.top--;e.globalAlpha=.5;e.fillStyle=window.getComputedStyle(a).backgroundColor;o+=4;r+=4;e.fillRect(i.left,i.top,o,r)}(o,r,a);o.globalAlpha=1;o.fillStyle=void 0!=t.textColor?t.textColor:window.getComputedStyle(i).color;o.font=void 0!=t.font?t.font:window.getComputedStyle(i).fontSize+" "+window.getComputedStyle(i).fontFamily;o.textAlign="center";o.textBaseline="middle";o.fillText(l,c.x,c.y);return e};t.registerListeners=function(){const t=this;if(!t.registeredListeners){t.map.on(TC.Consts.event.LAYERADD,t.generateLink.bind(t)).on(TC.Consts.event.LAYERREMOVE,t.generateLink.bind(t)).on(TC.Consts.event.FEATUREADD,t.generateLink.bind(t)).on(TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATURESCLEAR,t.generateLink.bind(t));t.registeredListeners=!0}}}();
//# sourceMappingURL=../maps/Control/MapInfo.min.js.map
