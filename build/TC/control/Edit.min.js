TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");TC.Consts.editMode={SELECT:"select",ADDPOINT:"addpoint",ADDLINE:"addline",ADDPOLYGON:"addpolygon"};TC.Consts.editStyles={NEW:"temporary",SELECTED:"select",DEFAULT:"default"};TC.Consts.event.POINT="point.tc";TC.Consts.event.BEFOREFEATUREMODIFY="beforefeaturemodify.tc";TC.Consts.event.FEATUREMODIFY="featuremodify.tc";TC.Consts.event.FEATURESSELECT="featureselect.tc";TC.Consts.event.FEATURESUNSELECT="featureunselect.tc";!function(){var e=0,t=function(e,t){return new Promise(function(n,o){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var a,i;switch(!0){case t instanceof TC.feature.Polygon:i=TC.Consts.geom.POLYGON;break;case t instanceof TC.feature.Polyline:i=TC.Consts.geom.POLYLINE;break;case t instanceof TC.feature.Point:i=TC.Consts.geom.POINT;break;case t instanceof TC.feature.MultiPolygon:i=TC.Consts.geom.MULTIPOLYGON;break;case t instanceof TC.feature.MultiPolyline:i=TC.Consts.geom.MULTIPOLYLINE}a={id:t.id||t.provId,attributes:t.data,type:i,geometry:t.geometry};localforage.setItem(e,a).then(function(){n({feature:t})}).catch(function(e){o({feature:t,error:e})})})})},n=function(e){return new Promise(function(t,n){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.removeItem(e).then(function(){t(e)}).catch(function(e){n(Error(e))})})})},o=function(e){return new Promise(function(t,n){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(e).then(function(n){t({key:e,feature:n})}).catch(function(e){n(e)})})})},a=function(e,t){return e.LOCAL_STORAGE_KEY_PREFIX+(t||e.layer.id)},i=function(e,t){return a(e,t)+e.LOCAL_STORAGE_ADDED_KEY_PREFIX},r=function(e,t){return a(e,t)+e.LOCAL_STORAGE_MODIFIED_KEY_PREFIX},s=function(e,t){return a(e,t)+e.LOCAL_STORAGE_REMOVED_KEY_PREFIX},l=function(e){var t=!1;(TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon||TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline)&&e.geometry.length>1&&(t=!0);return t},c=function(e,t){e._deleteBtn.disabled=0===t.length;e._joinBtn.disabled=t.length<2;e._splitBtn.disabled=0===t.filter(l).length},u=function(e,t){e._saveBtn.disabled=t;e._discardBtn.disabled=t;self.checkedOut=!t},d=function(e,t){void 0!==t?u(e,!t):TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var t=a(e);localforage.keys().then(function(n){if(n){for(var o=!0,a=0,i=n.length;a<i;a++)if(0===n[a].indexOf(t)){o=!1;break}u(e,o)}})})},f=function(e,t){return new Promise(function(n,o){var a=e._changesLayers[t.id];if(a)n(a);else{a=e._changesLayers[t.id]=new TC.layer.Vector({id:TC.getUID(),title:t.title+" - cambios pendientes",stealth:!0,styles:e.getChangesLayerStyle(t)});var i=e.map.layers.indexOf(t);e.map.insertLayer(a,i+1,function(){n(a)})}})};TC.control.Edit=function(){var o=this;TC.control.SWCacheClient.apply(this,arguments);o._classSelector="."+o.CLASS;o.wrap=new TC.wrap.control.Edit(o);o.layer=null;o.checkedOut=!1;o.callback=TC.Util.isFunction(arguments[2])?arguments[2]:o.options.callback?o.options.callback:null;o.multi=!!o.options.multi&&o.options.multi;o.eraseActionConfirmTxt=o.options.eraseText?o.options.eraseText:"\xbfEst\xe1 seguro de eliminar esta(s) geometr\xeda(s)?";o.cancelActionConfirmTxt=o.options.cancelText?o.options.eraseText:"Si continua todos los cambios se perder\xe1n. \xbfDesea continuar?";o.styles=o.options.styles;o.features={};o.attributeEditor=null;o.pointDraw=null;o.lineDraw=null;o.polygonDraw=null;o.snapping="boolean"!=typeof o.options.snapping||o.options.snapping;o._changesLayers={};o._showsChanges="boolean"!=typeof o.options.showChanges||o.options.showChanges;TC.Util.isFunction(o.options.getChangesLayerStyleFunction)&&(o.getChangesLayerStyleFunction=o.getChangesLayerStyle);o.on(TC.Consts.event.FEATUREADD,function(n){var a=n.feature;a.provId="NewFeature."+e++;var r=o._changesLayers[o.layer.id];o.features[o.layer.id].added.push(a);r.addFeature(a);t(i(o)+a.provId,a).then(function(){d(o,!0);TC.toast("Adici\xf3n guardada")},function(){TC.error("Fallo al guardar adici\xf3n")})}).on(TC.Consts.event.FEATUREREMOVE,function(e){var a=e.feature,l=a.provId||a.id,c=function(){d(o);TC.toast("Eliminaci\xf3n guardada")},u=function(){TC.error("Fallo al guardar eliminaci\xf3n")},f=o._changesLayers[o.layer.id],y=o.features[o.layer.id],h=y.added.indexOf(a);if(h<0){var C=s(o);if((h=y.modified.indexOf(a))<0){if((h=y.removed.indexOf(a))<0){y.removed.push(a);f.addFeature(a);t(C+a.id,a).then(c,u)}}else{y.modified.splice(h,1);y.removed.push(a);n(r(o)+a.id).then(function(){c();t(C+a.id,a).then(c,u)},u)}}else{f.removeFeature(a);y.added.splice(h,1);n(i(o)+l).then(c,u)}}).on(TC.Consts.event.FEATUREMODIFY,function(e){var n=e.feature,a=n.provId||n.id,s=function(){d(o,!0);TC.toast("Modificaci\xf3n guardada")},l=function(){TC.error("Fallo al guardar modificaci\xf3n")},c=o._changesLayers[o.layer.id],u=o.features[o.layer.id],f=u.added.indexOf(n);if(f<0){if((f=u.modified.indexOf(n))<0){c.addFeature(n);u.modified.push(n)}t(r(o)+a,n).then(s,l)}else t(i(o)+a,n).then(s,l)}).on(TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATUREMODIFY,function(e){if(o.serviceWorkerEnabled&&navigator.onLine){var t=o.layer.wrap.getGetFeatureUrl(),n=o.layer.wrap.getDescribeFeatureTypeUrl();t&&n&&o.createCache(o.LOCAL_STORAGE_KEY_PREFIX+o.layer.id,{urlList:[t,n]})}}).on(TC.Consts.event.CONTROLDEACTIVATE,function(e){}).on(TC.Consts.event.FEATURESSELECT,function(e){var t=o.getSelectedFeatures();c(o,t);t.length&&t[0].showPopup(o.attributeEditor)}).on(TC.Consts.event.FEATURESUNSELECT,function(e){c(o,o.getSelectedFeatures())})};TC.inherit(TC.control.Edit,TC.control.SWCacheClient);var y=TC.control.Edit.prototype;y.CLASS="tc-ctl-edit";y.LOCAL_STORAGE_KEY_PREFIX="TC.offline.edit.";y.LOCAL_STORAGE_ADDED_KEY_PREFIX=".added.";y.LOCAL_STORAGE_MODIFIED_KEY_PREFIX=".modified.";y.LOCAL_STORAGE_REMOVED_KEY_PREFIX=".removed.";y.template={};if(TC.isDebug){y.template[y.CLASS]=TC.apiLocation+"TC/templates/Edit.html";y.template[y.CLASS+"-attr"]=TC.apiLocation+"TC/templates/EditAttributes.html"}else{y.template[y.CLASS]=function(){dust.register(y.CLASS,e);function e(e,o){return e.w("<h2>").h("i18n",o,{},{$key:"featureEdit"}).w('</h2><div class="tc-ctl-edit-layer"><select class="tc-combo tc-ctl-edit-layer-sel"><option value="">').h("i18n",o,{},{$key:"selectLayerToEdit"}).w("</option>").s(o.get(["layers"],!1),o,{block:t},{}).w('</select><input type="checkbox" id="tc-ctl-edit-view-changes-cb"').x(o.get(["showChanges"],!1),o,{block:n},{}).w(' /><label class="tc-ctl-edit-view-changes" for="tc-ctl-edit-view-changes-cb">').h("i18n",o,{},{$key:"highlightUnsyncedChanges"}).w('</label></div><div class="tc-ctl-edit-mode"><form><label class="tc-ctl-edit-btn-select" title="').h("i18n",o,{},{$key:"select"}).w('"><input type="radio" name="mode" value="select" /><span>').h("i18n",o,{},{$key:"select"}).w('</span></label><label class="tc-ctl-edit-btn-point" title="').h("i18n",o,{},{$key:"newPoint"}).w('"><input type="radio" name="mode" value="addpoint" /><span>').h("i18n",o,{},{$key:"newPoint"}).w('</span></label><label class="tc-ctl-edit-btn-line" title="').h("i18n",o,{},{$key:"newLine"}).w('"><input type="radio" name="mode" value="addline" /><span>').h("i18n",o,{},{$key:"newLine"}).w('</span></label><label class="tc-ctl-edit-btn-polygon" title="').h("i18n",o,{},{$key:"newPolygon"}).w('"><input type="radio" name="mode" value="addpolygon" /><span>').h("i18n",o,{},{$key:"newPolygon"}).w('</span></label></form></div><div class="tc-ctl-edit-select tc-hidden"><button class="tc-ctl-btn tc-ctl-edit-btn-delete" disabled title="').h("i18n",o,{},{$key:"delete"}).w('">').h("i18n",o,{},{$key:"delete"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-join" disabled title="').h("i18n",o,{},{$key:"joinGeometries.tooltip"}).w('">').h("i18n",o,{},{$key:"joinGeometries"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-split" disabled title="').h("i18n",o,{},{$key:"splitGeometry"}).w('">').h("i18n",o,{},{$key:"splitGeometry"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-cancel" disabled title="').h("i18n",o,{},{$key:"cancel"}).w('">').h("i18n",o,{},{$key:"cancel"}).w('</button></div><div class="tc-ctl-edit-point tc-hidden"></div><div class="tc-ctl-edit-line tc-hidden"></div><div class="tc-ctl-edit-polygon tc-hidden"></div><div class="tc-ctl-edit-save"><button class="tc-button tc-icon-button tc-ctl-edit-btn-save" disabled title="').h("i18n",o,{},{$key:"syncChanges"}).w('">').h("i18n",o,{},{$key:"syncChanges"}).w('</button><button class="tc-button tc-icon-button tc-ctl-edit-btn-discard" disabled title="').h("i18n",o,{},{$key:"discardChanges"}).w('">').h("i18n",o,{},{$key:"discardChanges"}).w("</button></div>")}e.__dustBody=!0;function t(e,t){return e.w('<option value="').f(t.get(["id"],!1),t,"h").w('">').f(t.get(["title"],!1),t,"h").w("</option>")}t.__dustBody=!0;function n(e,t){return e.w(" checked")}n.__dustBody=!0;return e};y.template[y.CLASS+"-attr"]=function(){dust.register(y.CLASS+"-attr",t);var e={inputText:B,inputNumber:O,inputCheckbox:D,inputDate:F,inputTime:I,inputDatetime:N};function t(t,o){o=o.shiftBlocks(e);return t.w('<div class="tc-ctl-edit-attr"><h3>').h("i18n",o,{},{$key:"attributeEdit"}).w('</h3><div class="tc-ctl-edit-attr-body"><table><tbody>').s(o.get(["data"],!1),o,{block:n},{}).w('</tbody></table></div><div class="tc-ctl-edit-attr-footer"><button class="tc-button tc-ctl-edit-btn-attr-ok">').h("i18n",o,{},{$key:"ok"}).w('</button><button class="tc-button tc-ctl-edit-btn-attr-cancel">').h("i18n",o,{},{$key:"cancel"}).w("</button></div></div>")}t.__dustBody=!0;function n(t,n){n=n.shiftBlocks(e);return t.w("<tr><th>").f(n.get(["name"],!1),n,"h").w("</th><td>").x(n.get(["readOnly"],!1),n,{else:o,block:R},{}).w("</td></tr>")}n.__dustBody=!0;function o(t,n){n=n.shiftBlocks(e);return t.x(n.get(["availableValues"],!1),n,{block:a},{}).h("select",n,{block:r},{key:n.get(["type"],!1)})}o.__dustBody=!0;function a(t,n){n=n.shiftBlocks(e);return t.w('<select class="tc-combo" name="').f(n.get(["name"],!1),n,"h").w('"><option value=""></option>').s(n.get(["availableValues"],!1),n,{block:i},{}).w("</select>")}a.__dustBody=!0;function i(t,n){n=n.shiftBlocks(e);return t.w('<option value="').f(n.getPath(!0,[]),n,"h").w('">').f(n.getPath(!0,[]),n,"h").w("</option>")}i.__dustBody=!0;function r(t,n){n=n.shiftBlocks(e);return t.h("none",n,{block:s},{}).h("eq",n,{block:l},{value:"int"}).h("eq",n,{block:c},{value:"integer"}).h("eq",n,{block:u},{value:"double"}).h("eq",n,{block:d},{value:"boolean"}).h("eq",n,{block:f},{value:"date"}).h("eq",n,{block:h},{value:"time"}).h("eq",n,{block:C},{value:"dateTime"}).h("eq",n,{block:g},{value:"byte"}).h("eq",n,{block:p},{value:"long"}).h("eq",n,{block:v},{value:"negativeInteger"}).h("eq",n,{block:m},{value:"nonNegativeInteger"}).h("eq",n,{block:T},{value:"nonPositiveInteger"}).h("eq",n,{block:b},{value:"positiveInteger"}).h("eq",n,{block:_},{value:"short"}).h("eq",n,{block:E},{value:"unsignedLong"}).h("eq",n,{block:k},{value:"unsignedInt"}).h("eq",n,{block:L},{value:"unsignedShort"}).h("eq",n,{block:S},{value:"unsignedByte"}).h("eq",n,{block:w},{value:"float"}).h("eq",n,{block:A},{value:"decimal"})}r.__dustBody=!0;function s(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputText"),n,{},{})}s.__dustBody=!0;function l(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}l.__dustBody=!0;function c(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}c.__dustBody=!0;function u(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}u.__dustBody=!0;function d(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputCheckbox"),n,{},{})}d.__dustBody=!0;function f(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputDate"),n,{},{})}f.__dustBody=!0;function h(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputTime"),n,{},{})}h.__dustBody=!0;function C(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputDatetime"),n,{},{})}C.__dustBody=!0;function g(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}g.__dustBody=!0;function p(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}p.__dustBody=!0;function v(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}v.__dustBody=!0;function m(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}m.__dustBody=!0;function T(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}T.__dustBody=!0;function b(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}b.__dustBody=!0;function _(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}_.__dustBody=!0;function E(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}E.__dustBody=!0;function k(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}k.__dustBody=!0;function L(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}L.__dustBody=!0;function S(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}S.__dustBody=!0;function w(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}w.__dustBody=!0;function A(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}A.__dustBody=!0;function B(t,n){n=n.shiftBlocks(e);return t.w('<input type="text" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}B.__dustBody=!0;function O(t,n){n=n.shiftBlocks(e);return t.w('<input type="number" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}O.__dustBody=!0;function D(t,n){n=n.shiftBlocks(e);return t.w('<input type="checkbox" name="').f(n.get(["name"],!1),n,"h").w('"').x(n.get(["value"],!1),n,{block:P},{}).w("/>")}D.__dustBody=!0;function P(t,n){n=n.shiftBlocks(e);return t.w(" checked")}P.__dustBody=!0;function F(t,n){n=n.shiftBlocks(e);return t.w('<input type="date" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}F.__dustBody=!0;function I(t,n){n=n.shiftBlocks(e);return t.w('<input type="time" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}I.__dustBody=!0;function N(t,n){n=n.shiftBlocks(e);return t.w('<input type="datetime" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}N.__dustBody=!0;function R(t,n){n=n.shiftBlocks(e);return t.f(n.get(["value"],!1),n,"h")}R.__dustBody=!0;return t}}y.register=function(t){var n=this;const l=TC.control.SWCacheClient.prototype.register.call(n,t),c=n.getUID(),u=n.getUID(),d=n.getUID();t.addControl("popup",{closeButton:!0}).then(function(e){n.attributeEditor=e});t.on(TC.Consts.event.LAYERUPDATE,function(t){const l=t.layer;if(l.type===TC.Consts.layerType.WFS&&!l.options.stealth){var c=n.features[l.id]=n.features[l.id]||{added:[],modified:[],removed:[]};f(n,l).then(function(t){n.layer!==l&&t.setVisibility(!1);var u=a(n,l.id),d=i(n,l.id),f=r(n,l.id),y=s(n,l.id);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){TC.getUID();localforage.keys().then(function(n){if(n)for(var a=0,i=n.length;a<i;a++){var r=n[a];0===r.indexOf(u)&&o(r).then(function(n){var o,a=n.key;if(0===a.indexOf(y)){o=a.substr(y.length);var i=l.getFeatureById(o);l.removeFeature(i);t.addFeature(i);c.removed.push(i)}else if(0===a.indexOf(f)){o=a.substr(f.length);if(i=l.getFeatureById(o)){t.addFeature(i);c.modified.push(i);i.wrap.setGeometry(n.feature.geometry);i.setData(n.feature.attributes)}}else if(0===a.indexOf(d)){o=a.substr(d.length);var r,s=parseInt(o.substr(o.lastIndexOf(".")+1));e=Math.max(e,s+1);switch(n.feature.type){case TC.Consts.geom.POINT:r=l.addPoint(n.feature.geometry);break;case TC.Consts.geom.POLYLINE:r=l.addPolyline(n.feature.geometry);break;case TC.Consts.geom.POLYGON:r=l.addPolygon(n.feature.geometry);break;case TC.Consts.geom.MULTIPOLYLINE:r=l.addMultiPolyline(n.feature.geometry);break;case TC.Consts.geom.MULTIPOLYGON:r=l.addMultiPolygon(n.feature.geometry)}r.then(function(e){t.addFeature(e);c.added.push(e);e.provId=o;e.setData(n.feature.attributes)})}})}})})})}}).on(TC.Consts.event.LAYERADD,function(e){const t=e.layer;if(t.type===TC.Consts.layerType.WFS&&!t.options.stealth){n.features[t.id]=n.features[t.id]||{added:[],modified:[],removed:[]};const e=document.createElement("option");e.setAttribute("value",t.id);e.innerHTML=t.title||t.id;n._layerSelect.appendChild(e)}}).on(TC.Consts.event.LAYERREMOVE,function(e){const t=e.layer;if(t.type===TC.Consts.layerType.WFS&&!t.options.stealth){var o=n._layerSelect.querySelector("option[value="+t.id+"]");o.selected&&n.setLayer(null);o.parentElement.removeChild(o)}}).on(TC.Consts.event.POPUP,function(e){if(e.control===n.attributeEditor){for(var t=e.control.currentFeature,o=n.attributes.slice(),a={},i=n._joinedFeatureAttributes||[],r=0,s=o.length;r<s;r++){var l=t.getData()||{},c=o[r];c.value=l[c.name];"id"===c.name&&(c.readOnly=!0);c.availableValues=[];for(var u=0,d=i.length;u<d;u++){var f=i[u][c.name];void 0!==f&&""!==f&&(c.availableValues[c.availableValues.length]=f)}a[c.name]=c.type}o.sort(function(e,t){return(e.readOnly?!t.readOnly:t.readOnly)?!e.readOnly-!t.readOnly:e.name>t.name?1:e.name<t.name?-1:0});n.getRenderedHtml(n.CLASS+"-attr",{data:o},function(e){const o=n.attributeEditor.contentDiv;o.innerHTML=e;const i=o.querySelectorAll("input"),r=o.querySelectorAll("select");i.forEach(function(e){e.addEventListener("input",function(e){const t=e.target;for(var n=0,o=r.length;n<o;n++){const o=r[n];if(o.matches("[name="+e.target.getAttribute("name")+"]")&&o.value!==t.value){o.value="";break}}})});r.forEach(function(e){e.addEventListener("change",function(e){const t=e.target;for(var n=0,o=i.length;n<o;n++){const e=i[n];if(e.matches("[name="+t.getAttribute("name")+"]")){e.value=t.value;break}}})});o.querySelector("."+n.CLASS+"-btn-attr-ok").addEventListener("click",function(){var e={};i.forEach(function(t){var n=t.getAttribute("name"),o=t.value;switch(a[n]){case"int":case"integer":case"byte":case"long":case"negativeInteger":case"nonNegativeInteger":case"nonPositiveInteger":case"positiveInteger":case"short":case"unsignedLong":case"unsignedInt":case"unsignedShort":case"unsignedByte":o=parseInt(o);Number.isNaN(o)||(e[n]=o);break;case"double":case"float":case"decimal":o=parseFloat(o);Number.isNaN(o)||(e[n]=o);break;case"date":case"time":case"dateTime":e[n]=new Date(o);break;case"boolean":e[n]=!!o;break;case void 0:break;default:e[n]=o}});t.setData(e);n.trigger(TC.Consts.event.FEATUREMODIFY,{feature:t,layer:n.layer});n.attributeEditor.hide()});o.querySelector("."+n.CLASS+"-btn-attr-cancel").addEventListener("click",function(){n.attributeEditor.hide()})})}});t.loaded(function(){if(n.options.layer)n.setLayer(n.options.layer);else{var e=t.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WFS&&!e.options.stealth});1===e.length?n.setLayer(e[0].id):n.setLayer(null)}n.showChanges(n._showsChanges);n.renderPromise().then(function(){Promise.all([t.addControl("draw",{id:c,div:n.div.querySelector("."+n.CLASS+"-point"),mode:TC.Consts.geom.POINT,layer:!1}),t.addControl("draw",{id:u,div:n.div.querySelector("."+n.CLASS+"-line"),mode:TC.Consts.geom.POLYLINE,layer:!1}),t.addControl("draw",{id:d,div:n.div.querySelector("."+n.CLASS+"-polygon"),mode:TC.Consts.geom.POLYGON,layer:!1})]).then(function(e){n.pointDraw=e[0];n.lineDraw=e[1];n.polygonDraw=e[2];var t=function(e){var t,o=e.feature;switch(n.geometryType){case TC.Consts.geom.POINT:t=TC.feature.Point;break;case TC.Consts.geom.POLYLINE:t=TC.feature.Polyline;break;case TC.Consts.geom.POLYGON:t=TC.feature.Polygon;break;case TC.Consts.geom.MULTIPOLYLINE:t=TC.feature.MultiPolyline;break;case TC.Consts.geom.MULTIPOLYGON:t=TC.feature.MultiPolygon}t&&(o=new t(o.geometry,{geometryName:n.layer.options.geometryName}));n.layer.addFeature(o);n.trigger(TC.Consts.event.FEATUREADD,{feature:o})},o=function(){n.cancel()};n.pointDraw.on(TC.Consts.event.DRAWEND,t).on(TC.Consts.event.DRAWCANCEL,o);n.lineDraw.on(TC.Consts.event.DRAWEND,t).on(TC.Consts.event.DRAWCANCEL,o);n.polygonDraw.on(TC.Consts.event.DRAWEND,t).on(TC.Consts.event.DRAWCANCEL,o);n.options.modes&&Array.isArray(n.options.modes)&&1==n.options.modes.length&&n.setMode(n.options.modes[0],null)})})});return l};y.render=function(e){var t=this,n=[];if(t.map)for(var o=0,a=t.map.workLayers.length;o<a;o++){var i=t.map.workLayers[o];i.type!==TC.Consts.layerType.WFS||i.options.stealth||n.push({id:i.id,title:i.title||i.id})}return t._set1stRenderPromise(TC.Control.prototype.renderData.call(t,{layers:n,showChanges:t.showChanges},function(){t._layerDiv=t.div.querySelector(t._classSelector+"-layer");t._layerSelect=t._layerDiv.querySelector(t._classSelector+"-layer-sel");t._layerSelect.addEventListener("change",function(e){t.setLayer(t._layerSelect.value)});t._layerDiv.querySelector("#"+t.CLASS+"-view-changes-cb").addEventListener("change",function(e){t.showChanges(e.target.checked)});t._cancelBtn=t.div.querySelector(t._classSelector+"-btn-cancel");t._cancelBtn.addEventListener("click",function(){t.cancel()});t._deleteBtn=t.div.querySelector(t._classSelector+"-btn-delete");t._deleteBtn.addEventListener("click",function(){TC.confirm(t.eraseActionConfirmTxt,function(){t.deleteFeatures(t.getSelectedFeatures())})});t._joinBtn=t.div.querySelector(t._classSelector+"-btn-join");t._joinBtn.addEventListener("click",function(){t.joinFeatures(t.getSelectedFeatures())});t._splitBtn=t.div.querySelector(t._classSelector+"-btn-split");t._splitBtn.addEventListener("click",function(){t.splitFeatures(t.getSelectedFeatures())});t._saveBtn=t.div.querySelector(t._classSelector+"-btn-save");t._saveBtn.addEventListener("click",function(){t.applyEdits()});t._discardBtn=t.div.querySelector(t._classSelector+"-btn-discard");t._discardBtn.addEventListener("click",function(){t.discardEdits()});if(t.options.modes&&Array.isArray(t.options.modes)&&t.options.modes.length>0){for(var n in TC.Consts.editMode)if("string"==typeof n&&t.options.modes.indexOf(TC.Consts.editMode[n])<0){const e=t.div.querySelector("label"+t._classSelector+"-btn-"+TC.Consts.editMode[n]);e.parentElement.removeChild(e);const o=t.div.querySelector("div"+t._classSelector+"-"+TC.Consts.editMode[n]);o.parentElement.removeChild(o)}if(1===t.options.modes.length){var o=t.options.modes[0];t.div.querySelector("label"+t._classSelector+"-btn-"+o).style.display="none"}}t.div.querySelectorAll("input[type=radio][name=mode]").forEach(function(e){e.addEventListener("change",function(){var e=this.value,n=t.mode===e?void 0:e;t.setMode(n)})});TC.Util.isFunction(e)&&e()}))};y.setLayer=function(e){var t=this;t.layer=map.getLayer(e);t.setMode(null);if(t.layer){f(t,t.layer).then(function(e){for(var n in t._changesLayers){var o=t._changesLayers[n];o.setVisibility(t._showsChanges&&o===e)}});t.layer.describeFeatureType().then(function(e){t.attributes=e.filter(function(e){switch(e.type){case"gml:LinearRingPropertyType":case"gml:PolygonPropertyType":t.geometryType=TC.Consts.geom.POLYGON;return!1;case"gml:MultiPolygonPropertyType":case"gml:MultiSurfacePropertyType":t.geometryType=TC.Consts.geom.MULTIPOLYGON;return!1;case"gml:LineStringPropertyType":t.geometryType=TC.Consts.geom.POLYLINE;return!1;case"gml:MultiLineStringPropertyType":t.geometryType=TC.Consts.geom.MULTIPOLYLINE;return!1;case"gml:PointPropertyType":case"gml:MultiPointPropertyType":t.geometryType=TC.Consts.geom.POINT;return!1;case"gml:BoxPropertyType":t.geometryType=TC.Consts.geom.RECTANGLE;return!1;case"gml:GeometryCollectionPropertyType":case"gml:GeometryAssociationType":return!1;default:return!0}});for(var n=0,o=t.attributes.length;n<o;n++){var a=t.attributes[n];a.type=a.type.substr(a.type.indexOf(":")+1)}t.renderPromise().then(function(){d(t);t.div.querySelector(t._classSelector+"-layer-sel").value=t.layer.id;const e=t.div.querySelectorAll("input[type=radio][name=mode]");var n;switch(t.geometryType){case TC.Consts.geom.POINT:n="[value=select],[value="+TC.Consts.editMode.ADDPOINT+"]";break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:n="[value=select],[value="+TC.Consts.editMode.ADDLINE+"]";break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:n="[value=select],[value="+TC.Consts.editMode.ADDPOLYGON+"]";break;default:n="[value]"}e.forEach(function(e){e.disabled=!e.matches(n)})})})}else{t.renderPromise().then(function(){d(t,!1);t.div.querySelectorAll("input[type=radio][name=mode]").forEach(function(e){e.disabled=!0;e.checked=!1})});t.layer=null}};y.setMode=function(e){var t=this;t.mode=e;!function(e){e._deleteBtn.disabled=!0;e._joinBtn.disabled=!0;e._splitBtn.disabled=!0}(t);var n,o,a=function(e){if(e){t.snapping&&(e.snapping=t.layer);e.activate()}};switch(e){case TC.Consts.editMode.SELECT:n=t.div.querySelector(t._classSelector+"-select");o=t.div.querySelectorAll(t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon");t.activate();break;case TC.Consts.editMode.ADDPOINT:n=t.div.querySelector(t._classSelector+"-point");o=t.div.querySelectorAll(t._classSelector+"-select,"+t._classSelector+"-line,"+t._classSelector+"-polygon");a(t.pointDraw);break;case TC.Consts.editMode.ADDLINE:n=t.div.querySelector(t._classSelector+"-line");o=t.div.querySelectorAll(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-polygon");a(t.lineDraw);break;case TC.Consts.editMode.ADDPOLYGON:n=t.div.querySelector(t._classSelector+"-polygon");o=t.div.querySelectorAll(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-line");a(t.polygonDraw);break;default:n=null;o=t.div.querySelectorAll(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon");t.isActive&&t.deactivate();t.pointDraw&&t.pointDraw.isActive&&t.pointDraw.deactivate();t.lineDraw&&t.lineDraw.isActive&&t.lineDraw.deactivate();t.polygonDraw&&t.polygonDraw.isActive&&t.polygonDraw.deactivate()}if(e){t.div.querySelector("input[type=radio][name=mode][value="+e+"]").checked=!0}else t.div.querySelectorAll("input[type=radio][name=mode]").forEach(function(e){e.checked=!1});n&&n.classList.remove(TC.Consts.classes.HIDDEN);o.forEach(function(e){e.classList.add(TC.Consts.classes.HIDDEN)})};y.showChanges=function(e){this._showsChanges=e;for(var t in this._changesLayers){this._changesLayers[t].setVisibility(e&&this.layer&&t===this.layer.id)}};y.cancel=function(){this.options.modes&&Array.isArray(this.options.modes)&&1==this.options.modes.length?this.setMode(this.options.modes[0],null):this.setMode(null,!1);this.wrap.cancel(!0,this.cancelActionConfirmTxt)};y.onFeatureClick=function(e){self.activeControl&&self.activeControl.isExclusive()||e.feature.show()};y.activate=function(e){TC.Control.prototype.activate.call(this);var t=e||{};this._cancelBtn.disabled=!1;this.wrap.activate(t.mode?t.mode:this.mode);TC.Control.prototype.activate.call(this)};y.deactivate=function(){TC.Control.prototype.deactivate.call(this);this.wrap.cancel(!0);this._cancelBtn.disabled=!0;this.wrap.deactivate()};y.isExclusive=function(){return!0};y.joinFeatures=function(e){var t=this;if(t.geometryType===TC.Consts.geom.MULTIPOLYLINE||t.geometryType===TC.Consts.geom.MULTIPOLYGON||t.geometryType===TC.Consts.geom.MULTIPOINT){t._joinedFeatureAttributes=[];if(e.length>1){for(var n=e.map(function(e){t._joinedFeatureAttributes[t._joinedFeatureAttributes.length]=e.getData();return e.geometry}).reduce(function(e,t){return e.concat(t)}),o=new e[0].constructor(n),a=0,i=e.length;a<i;a++){var r=e[a];t.layer.removeFeature(r);t.trigger(TC.Consts.event.FEATUREREMOVE,{feature:r})}t.layer.addFeature(o).then(function(e){t.setSelectedFeatures([o]);t.trigger(TC.Consts.event.FEATUREADD,{feature:e});e.showPopup(t.attributeEditor)})}c(t,[o])}};y.splitFeatures=function(e){for(var t=this,n=e.filter(l),o=n.map(function(e){return e.geometry}),a=[],i=0,r=n.length;i<r;i++)for(var s=(h=n[i]).getData(),u=o[i],d=0,f=u.length;d<f;d++)a[a.length]=new h.constructor([u[d]],{data:s});i=0;for(var y=n.length;i<y;i++){var h=n[i];t.layer.removeFeature(h);t.trigger(TC.Consts.event.FEATUREREMOVE,{feature:h})}var C=new Array(a.length);for(i=0,y=a.length;i<y;i++){(C[i]=t.layer.addFeature(a[i])).then(function(e){t.trigger(TC.Consts.event.FEATUREADD,{feature:e})})}Promise.all(C).then(function(){t.setSelectedFeatures(a)});c(t,a)};y.deleteFeatures=function(e){this.wrap.deleteFeatures(e);0===this.layer.features.length&&(this._deleteBtn.disabled=!0)};y.applyEdits=function(){var e=this;if(e.layer){var t=e.features[e.layer.id];e.layer.applyEdits(t.added,t.modified,t.removed).then(function(){e.discardEdits();e.map.toast("Cambios sincronizados con \xe9xito con el servidor")},function(e){TC.error("Error ["+e.code+"] al guardar cambios: "+e.reason)})}};y.discardEdits=function(){var e=this;e._joinedFeatureAttributes=[];var t=a(e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(n){if(n){for(var o=0,a=n.length;o<a;o++){var i=n[o];0===i.indexOf(t)&&localforage.removeItem(i)}if(e.layer){var r=e.features[e.layer.id];r.added.length=0;r.modified.length=0;r.removed.length=0;e.setSelectedFeatures([]);e.attributeEditor.hide();e._changesLayers[e.layer.id].clearFeatures();e.deleteCache(t).then(function(){e.layer.refresh()})}d(e,!1)}})})};y.getSelectedFeatures=function(){return this.wrap.getSelectedFeatures()};y.setSelectedFeatures=function(e){return this.wrap.setSelectedFeatures(e)};y.getLayer=function(){return this.layer};y.getChangesLayerStyle=function(e){var t=function(t){for(var n,o=e.wrap.getRGBA(t),a=0;a<3;a++)o[a]=255-o[a];4===(n=(65536*o[0]+256*o[1]+o[2]).toString(16)).length?n="00"+n:5===n.length&&(n="0"+n);return"#"+n},n=[1,3],o=TC.Util.extend(!0,{},e.options.styles);if(o.point){o.point.strokeColor=t(o.point.strokeColor);o.point.lineDash=n}if(o.line){o.line.strokeColor=t(o.line.strokeColor);o.line.lineDash=n}if(o.polygon){o.polygon.strokeColor=t(o.polygon.strokeColor);o.polygon.lineDash=n}return o}}();
//# sourceMappingURL=../maps/control/Edit.min.js.map