TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){TC.control.Edit=function(){TC.Control.apply(this,arguments);this._classSelector="."+this.CLASS;this._selectors={MODE_RADIO_BUTTON:"input[type=radio][name=mode]"};this.wrap=new TC.wrap.control.Edit(this);this.layer=null;this.callback=TC.Util.isFunction(arguments[2])?arguments[2]:this.options.callback?this.options.callback:null;this.cancelActionConfirmTxt=this.options.cancelText?this.options.eraseText:"Si continua todos los cambios se perder\xe1n. \xbfDesea continuar?";this.styles=this.options.styles;this.layersEditData={};this.pointDrawControl=null;this.lineDrawControl=null;this.polygonDrawControl=null;this.modifyControl=null;this.snapping="boolean"!=typeof this.options.snapping||this.options.snapping};TC.inherit(TC.control.Edit,TC.Control);TC.control.Edit.mode={MODIFY:"modify",ADDPOINT:"addpoint",ADDLINE:"addline",ADDPOLYGON:"addpolygon",CUT:"cut",OTHER:"other"};const e=TC.control.Edit.prototype;e.CLASS="tc-ctl-edit";e.template={};e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"featureEditing"}).w('</h2><div class="tc-ctl-edit-tools"><div class="tc-ctl-edit-mode"><form><label class="tc-ctl-edit-btn-modify" title="').h("i18n",t,{},{$key:"select"}).w('"><input type="radio" name="mode" value="modify" /><span>').h("i18n",t,{},{$key:"select"}).w('</span></label><label class="tc-ctl-edit-btn-point" title="').h("i18n",t,{},{$key:"newPoint"}).w('"><input type="radio" name="mode" value="addpoint" /><span>').h("i18n",t,{},{$key:"newPoint"}).w('</span></label><label class="tc-ctl-edit-btn-line" title="').h("i18n",t,{},{$key:"newLine"}).w('"><input type="radio" name="mode" value="addline" /><span>').h("i18n",t,{},{$key:"newLine"}).w('</span></label><label class="tc-ctl-edit-btn-polygon" title="').h("i18n",t,{},{$key:"newPolygon"}).w('"><input type="radio" name="mode" value="addpolygon" /><span>').h("i18n",t,{},{$key:"newPolygon"}).w('</span></label><label class="tc-ctl-edit-btn-other" title="').h("i18n",t,{},{$key:"otherTools"}).w('"><input type="radio" name="mode" value="other" /><span>').h("i18n",t,{},{$key:"otherTools"}).w('</span></label></form></div><div class="tc-ctl-edit-modify tc-hidden"></div><div class="tc-ctl-edit-point tc-hidden"></div><div class="tc-ctl-edit-line tc-hidden"></div><div class="tc-ctl-edit-polygon tc-hidden"></div><div class="tc-ctl-edit-other tc-hidden"><button class="tc-button tc-ctl-edit-btn-import">').h("i18n",t,{},{$key:"importFromOtherLayer"}).w('</button><button class="tc-button tc-ctl-edit-btn-dl">').h("i18n",t,{},{$key:"download"}).w("</button></div></div>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-attr"]=function(){dust.register(e.CLASS+"-attr",o);var t={inputText:L,inputNumber:A,inputCheckbox:I,inputDate:O,inputTime:N,inputDatetime:F};function o(e,o){o=o.shiftBlocks(t);return e.w("<h3>").h("i18n",o,{},{$key:"attributeEdit"}).w('</h3><div class="tc-ctl-mod-attr-body"><table><tbody>').s(o.get(["data"],!1),o,{block:n},{}).w('</tbody></table></div><div class="tc-ctl-mod-attr-footer"><button class="tc-button tc-ctl-mod-btn-attr-ok">').h("i18n",o,{},{$key:"ok"}).w('</button><button class="tc-button tc-ctl-mod-btn-attr-cancel">').h("i18n",o,{},{$key:"cancel"}).w("</button></div>")}o.__dustBody=!0;function n(e,o){o=o.shiftBlocks(t);return e.w("<tr><th>").f(o.get(["name"],!1),o,"h").w("</th><td>").x(o.get(["readOnly"],!1),o,{else:r,block:q},{}).w("</td></tr>")}n.__dustBody=!0;function r(e,o){o=o.shiftBlocks(t);return e.x(o.get(["availableValues"],!1),o,{block:i},{}).h("select",o,{block:s},{key:o.get(["type"],!1)})}r.__dustBody=!0;function i(e,o){o=o.shiftBlocks(t);return e.w('<select class="tc-combo" name="').f(o.get(["name"],!1),o,"h").w('"><option value=""></option>').s(o.get(["availableValues"],!1),o,{block:l},{}).w("</select>")}i.__dustBody=!0;function l(e,o){o=o.shiftBlocks(t);return e.w('<option value="').f(o.getPath(!0,[]),o,"h").w('">').f(o.getPath(!0,[]),o,"h").w("</option>")}l.__dustBody=!0;function s(e,o){o=o.shiftBlocks(t);return e.h("none",o,{block:a},{}).h("eq",o,{block:c},{value:"int"}).h("eq",o,{block:u},{value:"integer"}).h("eq",o,{block:d},{value:"double"}).h("eq",o,{block:f},{value:"boolean"}).h("eq",o,{block:y},{value:"date"}).h("eq",o,{block:m},{value:"time"}).h("eq",o,{block:p},{value:"dateTime"}).h("eq",o,{block:h},{value:"byte"}).h("eq",o,{block:g},{value:"long"}).h("eq",o,{block:C},{value:"negativeInteger"}).h("eq",o,{block:v},{value:"nonNegativeInteger"}).h("eq",o,{block:T},{value:"nonPositiveInteger"}).h("eq",o,{block:b},{value:"positiveInteger"}).h("eq",o,{block:_},{value:"short"}).h("eq",o,{block:S},{value:"unsignedLong"}).h("eq",o,{block:P},{value:"unsignedInt"}).h("eq",o,{block:D},{value:"unsignedShort"}).h("eq",o,{block:w},{value:"unsignedByte"}).h("eq",o,{block:E},{value:"float"}).h("eq",o,{block:k},{value:"decimal"})}s.__dustBody=!0;function a(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputText"),o,{},{})}a.__dustBody=!0;function c(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}c.__dustBody=!0;function u(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}u.__dustBody=!0;function d(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}d.__dustBody=!0;function f(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputCheckbox"),o,{},{})}f.__dustBody=!0;function y(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputDate"),o,{},{})}y.__dustBody=!0;function m(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputTime"),o,{},{})}m.__dustBody=!0;function p(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputDatetime"),o,{},{})}p.__dustBody=!0;function h(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}h.__dustBody=!0;function g(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}g.__dustBody=!0;function C(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}C.__dustBody=!0;function v(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}v.__dustBody=!0;function T(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}T.__dustBody=!0;function b(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}b.__dustBody=!0;function _(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}_.__dustBody=!0;function S(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}S.__dustBody=!0;function P(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}P.__dustBody=!0;function D(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}D.__dustBody=!0;function w(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}w.__dustBody=!0;function E(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}E.__dustBody=!0;function k(e,o){o=o.shiftBlocks(t);return e.b(o.getBlock("inputNumber"),o,{},{})}k.__dustBody=!0;function L(e,o){o=o.shiftBlocks(t);return e.w('<input type="text" class="tc-textbox" name="').f(o.get(["name"],!1),o,"h").w('" value="').f(o.get(["value"],!1),o,"h").w('" />')}L.__dustBody=!0;function A(e,o){o=o.shiftBlocks(t);return e.w('<input type="number" class="tc-textbox" name="').f(o.get(["name"],!1),o,"h").w('" value="').f(o.get(["value"],!1),o,"h").w('" />')}A.__dustBody=!0;function I(e,o){o=o.shiftBlocks(t);return e.w('<input type="checkbox" name="').f(o.get(["name"],!1),o,"h").w('"').x(o.get(["value"],!1),o,{block:B},{}).w("/>")}I.__dustBody=!0;function B(e,o){o=o.shiftBlocks(t);return e.w(" checked")}B.__dustBody=!0;function O(e,o){o=o.shiftBlocks(t);return e.w('<input type="date" class="tc-textbox" name="').f(o.get(["name"],!1),o,"h").w('" value="').f(o.get(["value"],!1),o,"h").w('" />')}O.__dustBody=!0;function N(e,o){o=o.shiftBlocks(t);return e.w('<input type="time" class="tc-textbox" name="').f(o.get(["name"],!1),o,"h").w('" value="').f(o.get(["value"],!1),o,"h").w('" />')}N.__dustBody=!0;function F(e,o){o=o.shiftBlocks(t);return e.w('<input type="datetime" class="tc-textbox" name="').f(o.get(["name"],!1),o,"h").w('" value="').f(o.get(["value"],!1),o,"h").w('" />')}F.__dustBody=!0;function q(e,o){o=o.shiftBlocks(t);return e.f(o.get(["value"],!1),o,"h")}q.__dustBody=!0;return o};e.template[e.CLASS+"-import"]=function(){dust.register(e.CLASS+"-import",t);function t(e,t){return e.w('<div class="tc-ctl-edit-import"><div class="tc-ctl-edit-import-list"><ul class="tc-layers">').s(t.get(["layers"],!1),t,{block:o},{}).w('</ul><p class="tc-ctl-edit-import-empty-note">').h("i18n",t,{},{$key:"thereAreNoCompatibleFeatures"}).w('</p></div><div class="tc-ctl-edit-import-foot"><button class="tc-button tc-ctl-edit-import-btn-ok">').h("i18n",t,{},{$key:"ok"}).w("</button></div></div>")}t.__dustBody=!0;function o(e,t){return e.p("tc-ctl-edit-import-layer",t,t.rebase(t.getPath(!0,[])),{})}o.__dustBody=!0;return t};e.template[e.CLASS+"-import-layer"]=function(){dust.register(e.CLASS+"-import-layer",t);function t(e,t){return e.w('<li class="tc-layer" data-layer-id="').f(t.get(["id"],!1),t,"h").w('"><input type="checkbox" id="tc-ctl-edit-import-list-cb-').f(t.get(["id"],!1),t,"h").w('" value="').f(t.get(["id"],!1),t,"h").w('"> <label for="tc-ctl-edit-import-list-cb-').f(t.get(["id"],!1),t,"h").w('">').f(t.get(["title"],!1),t,"h").w('</label><ul class="tc-features">').s(t.get(["features"],!1),t,{block:o},{}).w("</ul></li>")}t.__dustBody=!0;function o(e,t){return e.p("tc-ctl-edit-import-feature",t,t.rebase(t.getPath(!0,[])),{})}o.__dustBody=!0;return t};e.template[e.CLASS+"-import-feature"]=function(){dust.register(e.CLASS+"-import-feature",t);function t(e,t){return e.w('<li class="tc-feature"><input type="checkbox" id="tc-ctl-edit-import-list-cb-').f(t.getPath(!1,["layer","id"]),t,"h").w("-").f(t.get(["id"],!1),t,"h").w('" value="').f(t.get(["id"],!1),t,"h").w('"> <label for="tc-ctl-edit-import-list-cb-').f(t.getPath(!1,["layer","id"]),t,"h").w("-").f(t.get(["id"],!1),t,"h").w('">').f(t.get(["id"],!1),t,"h").w("</label></li>")}t.__dustBody=!0;return t};e.register=function(e){const t=this;return new Promise(function(o,n){TC.Control.prototype.register.call(t,e).then(function(){t._pointDrawCtlPromise=e.addControl("draw",{id:t.getUID(),div:t.div.querySelector(`.${t.CLASS}-point`),mode:TC.Consts.geom.POINT,layer:!1});t._lineDrawCtlPromise=e.addControl("draw",{id:t.getUID(),div:t.div.querySelector(`.${t.CLASS}-line`),mode:TC.Consts.geom.POLYLINE,layer:!1});t._polygonDrawCtlPromise=e.addControl("draw",{id:t.getUID(),div:t.div.querySelector(`.${t.CLASS}-polygon`),mode:TC.Consts.geom.POLYGON,layer:!1});t._modifyCtlPromise=e.addControl("modify",{id:t.getUID(),div:t.div.querySelector(`.${t.CLASS}-modify`),snapping:t.snapping});Promise.all([t._pointDrawCtlPromise,t._lineDrawCtlPromise,t._polygonDrawCtlPromise,t._modifyCtlPromise]).then(function(n){t.pointDrawControl=n[0];t.lineDrawControl=n[1];t.polygonDrawControl=n[2];t.modifyControl=n[3];const r=function(e){e.feature.setStyle(null);t.trigger(TC.Consts.event.DRAWEND,{feature:e.feature})},i=function(){t.cancel()};t.pointDrawControl.on(TC.Consts.event.DRAWEND,r).on(TC.Consts.event.DRAWCANCEL,i);t.lineDrawControl.on(TC.Consts.event.DRAWEND,r).on(TC.Consts.event.DRAWCANCEL,i);t.polygonDrawControl.on(TC.Consts.event.DRAWEND,r).on(TC.Consts.event.DRAWCANCEL,i);t.modifyControl.on(TC.Consts.event.FEATUREMODIFY,function(e){t.trigger(TC.Consts.event.FEATUREMODIFY,{feature:e.feature,layer:e.layer})}).on(TC.Consts.event.FEATUREADD,function(e){t.trigger(TC.Consts.event.FEATUREADD,{feature:e.feature,layer:e.layer})}).on(TC.Consts.event.FEATUREREMOVE,function(e){t.trigger(TC.Consts.event.FEATUREREMOVE,{feature:e.feature,layer:e.layer})});t.modifyControl.displayAttributes=function(){const e=t.getSelectedFeatures(),o=e[e.length-1];if(o){t.modifyControl._editAttrBtn.classList.add(TC.Consts.classes.ACTIVE);const e=t.getLayerEditData(o.layer).attributes,n=Object.keys(e).map(t=>e[t]),r=t._joinedFeatureAttributes||[],i=o.getData()||{};n.forEach(function(e){e.value=i[e.name];"id"===e.name&&(e.readOnly=!0);e.availableValues=[];r.forEach(function(t){const o=t[e.name];void 0!==o&&""!==o&&(e.availableValues[e.availableValues.length]=o)})});n.sort(function(e,t){return(e.readOnly?!t.readOnly:t.readOnly)?!e.readOnly-!t.readOnly:e.name>t.name?1:e.name<t.name?-1:0});t.getRenderedHtml(t.CLASS+"-attr",{data:n},function(e){t.modifyControl._attributesSection;const o=t.getAttributeDisplayTarget();o.classList.remove(TC.Consts.classes.HIDDEN);o.innerHTML=e;const n=o.querySelectorAll("input"),r=o.querySelectorAll("select");n.forEach(function(e){e.addEventListener("input",function(e){const t=e.target;for(var o=0,n=r.length;o<n;o++){const n=r[o];if(n.matches(`[name=${e.target.getAttribute("name")}]`)&&n.value!==t.value){n.value="";break}}})});r.forEach(function(e){e.addEventListener("change",function(e){const t=e.target;for(var o=0,r=n.length;o<r;o++){const r=n[o];if(r.matches(`[name=${e.target.getAttribute("name")}]`)){r.value=t.value;break}}})});o.querySelector(`.${t.modifyControl.CLASS}-btn-attr-ok`).addEventListener(TC.Consts.event.CLICK,function(e){t.modifyControl._onAttrOK()});o.querySelector(`.${t.modifyControl.CLASS}-btn-attr-cancel`).addEventListener(TC.Consts.event.CLICK,function(){t.modifyControl.closeAttributes()})})}};t.modifyControl._onAttrOK=function(){const e=this,o=e.getSelectedFeatures()[0];if(o){const n={},r=t.getLayerEditData(o.layer).attributes;e.getAttributeDisplayTarget().querySelectorAll("input").forEach(function(e){var t=e.getAttribute("name"),o=e.value;switch(r[t].type){case"int":case"integer":case"byte":case"long":case"negativeInteger":case"nonNegativeInteger":case"nonPositiveInteger":case"positiveInteger":case"short":case"unsignedLong":case"unsignedInt":case"unsignedShort":case"unsignedByte":o=parseInt(o);Number.isNaN(o)||(n[t]=o);break;case"double":case"float":case"decimal":o=parseFloat(o);Number.isNaN(o)||(n[t]=o);break;case"date":case"time":case"dateTime":n[t]=new Date(o);break;case"boolean":n[t]=!!o;break;case void 0:break;default:n[t]=o}});o.setData(n);e.trigger(TC.Consts.event.FEATUREMODIFY,{feature:o,layer:e.layer});e.closeAttributes()}};Array.isArray(t.options.modes)&&1==t.options.modes.length&&t.setMode(t.options.modes[0],null);o(t);e.loaded(function(){t.setLayer(t.options.layer)});e.on(TC.Consts.event.RESULTSPANELCLOSE,function(e){if(e.control===t.featureImportPanel){t.featuresToImport=[];t.getHighlightsLayer().then(e=>e.clearFeatures())}}).on(TC.Consts.event.LAYERREMOVE+" "+TC.Consts.event.FEATURESCLEAR,function(e){t.featureImportPanel&&!t.featureImportPanel.div.classList.contains(TC.Consts.classes.HIDDEN)&&t.getHighlightsLayer().then(function(o){for(let n=t.featuresToImport.length-1;n>=0;n--){const r=t.featuresToImport[n];if(r.layer===e.layer||r.original&&r.original.layer===e.layer){t.featuresToImport.splice(n,1);o.removeFeature(r)}}const n=t.featureImportPanel.getInfoContainer().querySelector(`li[data-layer-id="${e.layer.id}"]`);n&&n.remove()})}).on(TC.Consts.event.FEATUREREMOVE,function(e){t.featureImportPanel&&!t.featureImportPanel.div.classList.contains(TC.Consts.classes.HIDDEN)&&t.getHighlightsLayer().then(function(o){for(let n=0,r=t.featuresToImport.length;n<r;n++){const r=t.featuresToImport[n];if(r===e.feature||r.original===e.feature){t.featuresToImport.splice(n,1);o.removeFeature(r);const i=t.featureImportPanel.getInfoContainer().querySelector(`li[data-layer-id="${e.layer.id}"]`);if(i){const t=i.querySelector(`#tc-ctl-edit-import-list-cb-${e.layer.id}-${e.feature.id}`);t&&t.remove();i.children.length||i.remove()}break}}})}).on(TC.Consts.event.LAYERUPDATE,function(e){if(t.featureImportPanel&&!t.featureImportPanel.div.classList.contains(TC.Consts.classes.HIDDEN)){const o=t.getAvailableFeaturesToImport().filter(t=>t.id===e.layer.id)[0];o&&t.getRenderedHtml(t.CLASS+"-import-layer",o,function(o){const n=t.featureImportPanel.getInfoContainer().querySelector(`.${t.CLASS}-import-list .tc-layers`);n.querySelector(`li[data-layer-id="${e.layer.id}"]`)||n.insertAdjacentHTML("beforeend",o)})}}).on(TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATURESADD,function(e){if(t.featureImportPanel&&!t.featureImportPanel.div.classList.contains(TC.Consts.classes.HIDDEN)){const o=e.layer,n=(e.feature?[e.feature]:e.features).filter(e=>t.isFeatureAllowed(e));n.length&&t.displayLayerToImport({id:o.id,title:o.title,features:n})}})})})})};e.render=function(e){const t=this;return t._set1stRenderPromise(TC.Control.prototype.render.call(t,function(){if(Array.isArray(t.options.modes)&&t.options.modes.length>0){for(var o in TC.control.Edit.mode)if("string"==typeof o&&t.options.modes.indexOf(TC.control.Edit.mode[o])<0){const e=t.div.querySelector(`label${t._classSelector}-btn-${TC.control.Edit.mode[o]}`);e.parentElement.removeChild(e);const n=t.div.querySelector(`div${t._classSelector}-${TC.control.Edit.mode[o]}`);n.parentElement.removeChild(n)}if(1===t.options.modes.length){var n=t.options.modes[0];const e=t.div.querySelector(`label${t._classSelector}-btn-${n}`);e.parentElement.removeChild(e)}}t.div.querySelectorAll(t._selectors.MODE_RADIO_BUTTON).forEach(function(e){e.addEventListener("change",function(){var e=this.value,o=t.mode===e?void 0:e;t.setMode(o)})});t.div.querySelector(t._classSelector+"-btn-import").addEventListener(TC.Consts.event.CLICK,function(e){t.showFeatureImportPanel()});t.div.querySelector(t._classSelector+"-btn-dl").addEventListener(TC.Consts.event.CLICK,function(e){t.getDownloadDialog().then(function(e){const o={title:t.getLocaleString("download"),fileName:t.layer.id.toLowerCase().replace(" ","_")+"_"+TC.Util.getFormattedDate((new Date).toString(),!0),elevation:t.options.downloadElevation};e.open(t.layer.features,o)})});TC.Util.isFunction(e)&&e()}))};e.getGeometryType=function(e){switch(e){case"gml:LinearRingPropertyType":case"gml:PolygonPropertyType":case"LinearRingPropertyType":case"PolygonPropertyType":return TC.Consts.geom.POLYGON;case"gml:MultiPolygonPropertyType":case"gml:MultiSurfacePropertyType":case"MultiPolygonPropertyType":case"MultiSurfacePropertyType":return TC.Consts.geom.MULTIPOLYGON;case"gml:LineStringPropertyType":case"gml:CurvePropertyType":case"LineStringPropertyType":case"CurvePropertyType":return TC.Consts.geom.POLYLINE;case"gml:MultiLineStringPropertyType":case"gml:MultiCurvePropertyType":case"MultiLineStringPropertyType":case"MultiCurvePropertyType":return TC.Consts.geom.MULTIPOLYLINE;case"gml:PointPropertyType":case"gml:MultiPointPropertyType":case"PointPropertyType":case"MultiPointPropertyType":return TC.Consts.geom.POINT;case"gml:BoxPropertyType":case"BoxPropertyType":return TC.Consts.geom.RECTANGLE;case"gml:GeometryCollectionPropertyType":case"gml:GeometryAssociationType":case"gml:GeometryPropertyType":case"GeometryCollectionPropertyType":case"GeometryAssociationType":case"GeometryPropertyType":return!0;default:return!1}};e.setLayer=function(e){const t=this;t.layer=t.map.getLayer(e);t.layer&&e.describeFeatureType().then(function(o){const n={attributes:{}};for(var r in o){const e=o[r],i=t.getGeometryType(e.type);if(i){n.geometryName=e.name;n.geometryType="boolean"==typeof i?null:i}else n.attributes[r]=e}for(var r in n.attributes){const e=n.attributes[r];e.type=e.type.substr(e.type.indexOf(":")+1)}t.layersEditData[e.id]=n}).catch(function(o){t.layersEditData[e.id]={geometryType:null,attributes:{}}});const o=e=>e.setLayer(t.layer);t.getModifyControl().then(o);t.getPointDrawControl().then(o);t.getLineDrawControl().then(o);t.getPolygonDrawControl().then(o);t.setMode(t.layer?TC.control.Edit.mode.MODIFY:null);n=t,r=t.layer,n.div.querySelectorAll(n._selectors.MODE_RADIO_BUTTON).forEach(e=>e.disabled=!r);var n,r};e.setMode=function(e){var t=this;t.mode=e;var o,n,r=function(e){if(e){t.snapping&&(e.snapping=t.layer);e.activate()}};Promise.all([t._pointDrawCtlPromise,t._lineDrawCtlPromise,t._polygonDrawCtlPromise,t._modifyCtlPromise]).then(function(i){const l=i[0],s=i[1],a=i[2],c=i[3];switch(e){case TC.control.Edit.mode.MODIFY:o=t.div.querySelector(t._classSelector+"-modify");n=t.div.querySelectorAll(t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon,"+t._classSelector+"-other");c.activate();break;case TC.control.Edit.mode.ADDPOINT:o=t.div.querySelector(t._classSelector+"-point");n=t.div.querySelectorAll(t._classSelector+"-modify,"+t._classSelector+"-line,"+t._classSelector+"-polygon,"+t._classSelector+"-other");r(l);break;case TC.control.Edit.mode.ADDLINE:o=t.div.querySelector(t._classSelector+"-line");n=t.div.querySelectorAll(t._classSelector+"-modify,"+t._classSelector+"-point,"+t._classSelector+"-polygon,"+t._classSelector+"-other");r(s);break;case TC.control.Edit.mode.ADDPOLYGON:o=t.div.querySelector(t._classSelector+"-polygon");n=t.div.querySelectorAll(t._classSelector+"-modify,"+t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-other");r(a);break;case TC.control.Edit.mode.OTHER:o=t.div.querySelector(t._classSelector+"-other");n=t.div.querySelectorAll(t._classSelector+"-modify,"+t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon");i.indexOf(t.map.activeControl)>=0&&t.map.activeControl.deactivate();break;default:o=null;n=t.div.querySelectorAll(t._classSelector+"-modify,"+t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon,"+t._classSelector+"-other");i.indexOf(t.map.activeControl)>=0&&t.map.activeControl.deactivate()}if(e){t.div.querySelector(`${t._selectors.MODE_RADIO_BUTTON}[value=${e}]`).checked=!0}else t.div.querySelectorAll(t._selectors.MODE_RADIO_BUTTON).forEach(function(e){e.checked=!1});o&&o.classList.remove(TC.Consts.classes.HIDDEN);n.forEach(function(e){e.classList.add(TC.Consts.classes.HIDDEN)})})};e.constrainModes=function(e){const t=this;Array.isArray(e)||(e=[]);t.modes=e.filter(function(e){for(var t in TC.control.Edit.mode)if(TC.control.Edit.mode[t]===e)return!0;return!1}).filter(function(e){return!Array.isArray(t.options.modes)||t.options.modes.indexOf(e)>=0});t.modes.indexOf(t.mode)<0&&t.setMode(null);const o=t.modes.map(e=>`[value=${e}]`).join()||"[value]";t.div.querySelectorAll(t._selectors.MODE_RADIO_BUTTON).forEach(function(e){e.disabled=!e.matches(o)})};e.isFeatureAllowed=function(e){const t=this;switch(!0){case TC.feature.Point&&e instanceof TC.feature.Point:return t.modes.indexOf(TC.control.Edit.mode.ADDPOINT)>=0;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:return t.modes.indexOf(TC.control.Edit.mode.ADDLINE)>=0;case TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline:return t.modes.indexOf(TC.control.Edit.mode.ADDLINE)>=0&&t.isMultiple;case TC.feature.Polygon&&e instanceof TC.feature.Polygon:return t.modes.indexOf(TC.control.Edit.mode.ADDPOLYGON)>=0;case TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon:return t.modes.indexOf(TC.control.Edit.mode.ADDPOLYGON)>=0&&t.isMultiple;default:return!0}};e.setComplexGeometry=function(e){this.isMultiple=e;this.getLineDrawControl().then(t=>t.setMode(e?TC.Consts.geom.MULTIPOLYLINE:TC.Consts.geom.POLYLINE));this.getPolygonDrawControl().then(t=>t.setMode(e?TC.Consts.geom.MULTIPOLYGON:TC.Consts.geom.POLYGON))};e.getLayerEditData=function(e){const t=e||this.layer;return t?this.layersEditData[t.id]=this.layersEditData[t.id]||{checkedOut:!1}:null};e.cancel=function(){Array.isArray(this.options.modes)&&1==this.options.modes.length?this.setMode(this.options.modes[0],null):this.setMode(null,!1);this.wrap.cancel(!0,this.cancelActionConfirmTxt)};e.onFeatureClick=function(e){self.activeControl&&self.activeControl.isExclusive()||e.feature.show()};e.activate=function(e){const t=this,o=function(e){e!==t.map.activeControl&&(t._previousActiveControl=t.map.activeControl)};switch((e=e||{}).mode){case TC.control.Edit.mode.ADDPOINT:t.getPointDrawControl().then(o);break;case TC.control.Edit.mode.ADDLINE:t.getLineDrawControl().then(o);break;case TC.control.Edit.mode.ADDPOLYGON:t.getPolygonDrawControl().then(o);break;default:t.getModifyControl().then(o)}};e.deactivate=function(){const e=this;if(e._previousActiveControl){e.map.previousActiveControl=e._previousActiveControl;switch(e.map.activeControl){case e.pointDrawControl:e.pointDrawControl.deactivate();break;case e.lineDrawControl:e.lineDrawControl.deactivate();break;case e.polygonDrawControl:e.polygonDrawControl.deactivate();break;case e.modifyControl:e.modifyControl.deactivate()}}e.modifyControl&&e.modifyControl.closeAttributes()};e.isExclusive=function(){return!0};e.getAttributeDisplayTarget=function(){return this.modifyControl._attributesSection};e.getSelectedFeatures=function(){return this.modifyControl.getSelectedFeatures()};e.setSelectedFeatures=function(e){return this.modifyControl.setSelectedFeatures(e)};e.getLayer=function(){return this.layer};e.getModifyControl=function(){const e=this;return e._modifyCtlPromise||new Promise(function(t,o){e.renderPromise().then(()=>t(e.modifyControl))})};e.getPointDrawControl=function(){const e=this;return e._pointDrawCtlPromise||new Promise(function(t,o){e.renderPromise().then(()=>t(e.pointDrawControl))})};e.getLineDrawControl=function(){const e=this;return e._lineDrawCtlPromise||new Promise(function(t,o){e.renderPromise().then(()=>t(e.lineDrawControl))})};e.getPolygonDrawControl=function(){const e=this;return e._polygonDrawCtlPromise||new Promise(function(t,o){e.renderPromise().then(()=>t(e.polygonDrawControl))})};e.getFeatureImportPanel=function(){const e=this;if(!e._featureImportPanelPromise){e._featureImportPanelPromise=e.map.addControl("resultsPanel",{titles:{main:e.getLocaleString("importFromOtherLayer")}});e._featureImportPanelPromise.then(t=>e.featureImportPanel=t)}return e._featureImportPanelPromise};e.getHighlightsLayer=function(){const e=this;if(!e._highlightsLayerPromise){e._highlightsLayerPromise=e.map.addLayer({id:e.getUID(),type:TC.Consts.layerType.VECTOR,title:"Highlights Layer",stealth:!0,styles:e.map.options.styles.selection||TC.Cfg.styles.selection});e._highlightsLayerPromise.then(t=>e.highlightsLayer=t)}return e._highlightsLayerPromise};e.highlightFeatures=function(e){const t=this;t.getHighlightsLayer().then(function(o){const n=t.featuresToImport.concat(e);o.features.slice().forEach(function(e){(!e.original||n.indexOf(e.original)<0)&&o.removeFeature(e)});o.addFeatures(n.filter(function(e){return!o.features.some(function(t){return t.original&&t.original===e})}).map(function(e){const t=e.clone();t.toggleSelectedStyle(!0);t.original=e;return t}))})};e.getAvailableFeaturesToImport=function(){const e=this;return e.map.workLayers.filter(e=>!e.isRaster()).filter(t=>t!==e.layer).filter(t=>t!==e.highlightsLayer).map(function(t){return{id:t.id,title:t.title,features:t.features.filter(function(t){return e.isFeatureAllowed(t)})}}).filter(e=>e.features.length)};e.getFeatureFromImportList=function(e){const t=e.querySelector("input"),o=this.map.getLayer(e.parentElement.parentElement.dataset.layerId);return o?o.getFeatureById(t.value):null};e.importFeatures=function(e){const t=this;let o=!1;const n=t.getLayerEditData();(e||t.featuresToImport||[]).filter(e=>{const n=t.isFeatureAllowed(e);n||(o=!0);return n}).map(function(e){let o;const r={data:e.data,geometryName:n.geometryName};if(t.isMultiple)switch(!0){case TC.feature.Polygon&&e instanceof TC.feature.Polygon:o=new TC.feature.MultiPolygon([e.geometry],r);break;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:o=new TC.feature.MultiPolyline([e.geometry],r);break;default:o=e.clone()}else switch(!0){case TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon:o=new TC.feature.Polygon(e.geometry[0],r);break;case TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline:o=new TC.feature.Polyline(e.geometry[0],r);break;default:o=e.clone()}o.setStyle(null);return o}).forEach(function(e){t.layer.addFeature(e);t.trigger(TC.Consts.event.FEATUREADD,{feature:e,layer:t.layer})});o&&t.map.toast(t.getLocaleString("importFromOtherLayer.warning"),{type:TC.Consts.msgType.WARNING})};const t=function(e,t){const o=e.getFeatureFromImportList(t.parentElement);if(t.checked)e.featuresToImport.push(o);else{const t=e.featuresToImport.indexOf(o);t>=0&&e.featuresToImport.splice(t,1)}};e._addImportLayerEvents=function(e){const o=this;e.querySelector("input").addEventListener("change",function(e){const n=this;n.parentElement.querySelectorAll("li.tc-feature input").forEach(function(e){if(e.checked!==n.checked){e.checked=n.checked;t(o,e)}});o.highlightFeatures([])});e.querySelectorAll("li.tc-feature").forEach(function(e){o._addImportFeatureEvents(e)})};e._addImportFeatureEvents=function(e){const o=this,n=function(e){const t=o.getFeatureFromImportList(this);t&&o.highlightFeatures([t])};e.addEventListener(TC.Consts.event.CLICK,n);e.addEventListener("mouseover",n);e.querySelector("input").addEventListener("change",function(e){t(o,this)})};e.showFeatureImportPanel=function(){const e=this;e.featuresToImport=[];e.getFeatureImportPanel().then(function(t){const o=t.getInfoContainer();e.getRenderedHtml(e.CLASS+"-import",{layers:e.getAvailableFeaturesToImport()},function(n){t.open(n,o);o.querySelector("ul").addEventListener("mouseout",function(t){e.highlightFeatures([])});o.querySelectorAll("li.tc-layer").forEach(function(t){e._addImportLayerEvents(t)});o.querySelector(`.${e.CLASS}-import-btn-ok`).addEventListener(TC.Consts.event.CLICK,function(t){e.importFeatures();e.featureImportPanel.close()})})})};e.displayLayerToImport=function(e){const t=this;return new Promise(function(o,n){if(t.featureImportPanel&&!t.featureImportPanel.div.classList.contains(TC.Consts.classes.HIDDEN)){const n=t.featureImportPanel.getInfoContainer().querySelector(`.${t.CLASS}-import-list .tc-layers`),r=`li[data-layer-id="${e.id}"]`,i=n.querySelector(r);if(i){features.forEach(function(e){t.isFeatureAllowed(e)&&t.getRenderedHtml(t.CLASS+"-import-feature",layerObj,function(e){i.insertAdjacentHTML("beforeend",e);t._addImportFeatureEvents(i.querySelector("li:last-child"))})});o(i)}else t.getRenderedHtml(t.CLASS+"-import-layer",{id:e.id,title:e.title,features:e.features},function(e){n.insertAdjacentHTML("beforeend",e);const i=n.querySelector(r);t._addImportLayerEvents(i);o(i)})}else o(null)})};e.getDownloadDialog=function(){const e=this;return e._downloadDialog?Promise.resolve(e._downloadDialog):new Promise(function(t,o){e.map.addControl("FeatureDownloadDialog").then(o=>{e._downloadDialog=o;t(o)})})}}();
//# sourceMappingURL=../maps/control/Edit.min.js.map