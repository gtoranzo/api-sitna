TC.control=TC.control||{};TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons");!function(){TC.control.FeatureInfo=function(){var e=this;TC.control.FeatureInfoCommons.apply(this,arguments);e.wrap=new TC.wrap.control.FeatureInfo(e);TC.Consts.classes.FROMLEFT="tc-fromleft";TC.Consts.classes.FROMRIGHT="tc-fromright";e.options.displayElevation&&TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){const t="boolean"==typeof e.options.displayElevation?{}:e.options.displayElevation;e.elevation=new TC.tool.Elevation(t)})};TC.inherit(TC.control.FeatureInfo,TC.control.FeatureInfoCommons);var e=TC.control.FeatureInfo.prototype,t=function e(t,r){var a;if(Array.isArray(t))for(var o=0,n=(a=t.slice()).length;o<n;o++)a[o]=e(a[o]);else a="number"==typeof t?Math.round(t.toFixed(r)):t;return a};e.register=function(e){const t=TC.control.FeatureInfoCommons.prototype.register.call(this,e);document.createElement("div").appendChild(this.div);return t};e.callback=function(e,t){var r=this;if(r.elevation){r.querying=!0;r.elevationRequest=r.elevation.getElevation({crs:r.map.crs,coordinates:e})}if(r.map&&r.filterLayer){var a=r.getLocaleString("featureInfo"),o=TC.Util.extend({},r.map.options.styles.marker,r.markerStyle,{title:a,set:a,showsPopup:!1});r.filterLayer.clearFeatures();r.filterFeature=null;r.filterLayer.addMarker(e,o).then(function(t){r.map.putLayerOnTop(r.filterLayer);r.querying=!0;r.filterFeature=t;for(var a=!1,o=0;o<r.map.workLayers.length;o++){var n=r.map.workLayers[o];if(n.type===TC.Consts.layerType.WMS&&n.getVisibility()&&n.names.length>0){a=!0;break}}var l=r.map.getResolution();if(a)r.wrap.getFeatureInfo(e,l);else{r.querying=!1;setTimeout(function(){r.responseCallback({coords:e})})}})}};e.responseCallback=function(e){const r=this;TC.control.FeatureInfoCommons.prototype.responseCallback.call(r,e);if(r.filterFeature){var a=e.services;if(a)for(var o=0;o<a.length;o++){for(var n=a[o],l=0;l<n.layers.length;l++)if(!n.layers[l].features.length){n.layers.splice(l,1);l-=1}if(!n.layers.length){a.splice(o,1);o-=1}}r.info.defaultFeature=e.defaultFeature;var s=r.map.options.locale||TC.Cfg.locale;e.isGeo=r.map.wrap.isGeo();r.elevationRequest&&(e.displayElevation=!0);if(e.coords){e.crs=r.map.crs;e.coords=e.coords.map(function(t){return TC.Util.formatNumber(t.toFixed(e.isGeo?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),s)})}if(a&&a.length||r.elevationRequest)r.renderData(e,function(){r.insertLinks();if(r.sharedFeatureInfo){r.div.querySelectorAll("ul."+r.CLASS+"-services li").forEach(function(e){e.classList.add(TC.Consts.classes.CHECKED)});for(var e,a=r.sharedFeatureInfo,o=0,n=r.info.services.length;o<n;o++){var l=r.info.services[o];if(l.mapLayers.some(function(e){return e.url===a.s})){for(var s=0,i=l.layers.length;s<i;s++){var u=l.layers[s];if(u.name===a.l){for(var f=0,c=u.features.length;f<c;f++){var C=u.features[f];if(C.id===a.f){e=C;var p=hex_md5(JSON.stringify({data:C.getData(),geometry:t(C.geometry,TC.Consts.DEGREE_PRECISION)}));a.h!==p&&TC.alert(r.getLocaleString("finfo.featureChanged.warning"));break}}break}}break}}if(e){r.highlightedFeature=e;r.map.addLayer({id:r.getUID(),type:TC.Consts.layerType.VECTOR,title:r.getLocaleString("foi"),stealth:!0}).then(function(t){r.sharedFeatureLayer=t;r.filterLayer.clearFeatures();r.filterFeature=null;t.addFeature(e);r.map.zoomToFeatures([e])})}delete r.sharedFeatureInfo}else r.displayResults()});else{r.resultsLayer.clearFeatures();r.filterLayer.clearFeatures();r.filterFeature=null}}};e.displayResultsCallback=function(){const e=this;TC.control.FeatureInfoCommons.prototype.displayResultsCallback.call(e);if(e.elevationRequest){const t=e.getDisplayControl();e.getDisplayTarget().querySelector(`.${e.CLASS}-elev`).classList.add(TC.Consts.classes.HIDDEN);e.elevationRequest.then(function(r){if(t.currentFeature){const a=t.currentFeature.geometry;if(a[0]===r[0][0]&&a[1]===r[0][1]){const t=r.length?r[0][2]:null;e.displayElevation(t)}}e.elevationRequest=null})}};e.displayElevation=function(e){const t=this.map.options.locale||TC.Cfg.locale,r=null===e?"-":TC.Util.formatNumber(Math.round(e),t)+" m",a=this.getDisplayTarget().querySelector(`.${this.CLASS}-elev`);a.classList.toggle(TC.Consts.classes.HIDDEN,null===e);a.querySelector(`.${this.CLASS}-coords-val`).innerHTML=r};e.loadSharedFeature=function(e){const t=this;if(e){if(0===t.map.workLayers.filter(function(t,r){return t.type===TC.Consts.layerType.WMS&&t.url===e.s&&t.getDisgregatedLayerNames().indexOf(e.l)>=0}).length){TC.error(t.getLocaleString("sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST);return}t.sharedFeatureInfo=e;TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){const r=[-100,-100];t.beforeRequest({xy:r});t.filterLayer.clearFeatures();t.filterFeature=null;t.filterLayer.addMarker(r).then(function(r){t.filterFeature=r;t.wrap.getFeatureInfo(e.xy,e.r,{serviceUrl:e.s,layerName:e.l,featureId:e.f})})})}}}();
//# sourceMappingURL=../maps/control/FeatureInfo.min.js.map