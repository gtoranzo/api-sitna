TC.control=TC.control||{};TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons");!function(){TC.control.FeatureInfo=function(){TC.control.FeatureInfoCommons.apply(this,arguments);this.wrap=new TC.wrap.control.FeatureInfo(this);TC.Consts.classes.FROMLEFT="tc-fromleft";TC.Consts.classes.FROMRIGHT="tc-fromright"};TC.inherit(TC.control.FeatureInfo,TC.control.FeatureInfoCommons);var e=TC.control.FeatureInfo.prototype,t=function e(t,o){var r;if(Array.isArray(t))for(var a=0,s=(r=t.slice()).length;a<s;a++)r[a]=e(r[a]);else r="number"==typeof t?Math.round(t.toFixed(o)):t;return r};e.register=function(e){const t=this,o=TC.control.FeatureInfoCommons.prototype.register.call(t,e);document.createElement("div").appendChild(t.div);(t.options.displayElevation||t.map.options.elevation)&&TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){const e=t.options.displayElevation?"boolean"==typeof t.options.displayElevation?{}:t.options.displayElevation:"boolean"==typeof t.map.options.elevation?{}:t.map.options.elevation;t.elevation=new TC.tool.Elevation(e)});return o};e.callback=function(e,t){const o=this;o.querying=!0;o.elevation&&(o.elevationRequest=o.elevation.getElevation({crs:o.map.crs,coordinates:e}));if(o.map&&o.filterLayer){var r=o.getLocaleString("featureInfo"),a=TC.Util.extend({},o.map.options.styles.marker,o.markerStyle,{title:r,set:r,showsPopup:!1});o.filterLayer.clearFeatures();o.highlightedFeature=null;o.filterFeature=null;o.filterLayer.addMarker(e,a).then(function(t){o.map.putLayerOnTop(o.filterLayer);o.filterFeature=t;o.renderResults({coords:t.geometry,displayElevation:o.elevation,loading:!0},function(){o.displayResults()});for(var r=!1,a=0;a<o.map.workLayers.length;a++){var s=o.map.workLayers[a];if(s.type===TC.Consts.layerType.WMS&&s.getVisibility()&&s.names.length>0){r=!0;break}}var n=o.map.getResolution();r?o.wrap.getFeatureInfo(e,n):setTimeout(function(){o.responseCallback({coords:e})})})}};e.responseCallback=function(e){const o=this;TC.control.FeatureInfoCommons.prototype.responseCallback.call(o,e);if(o.filterFeature){var r=e.services;if(r)for(var a=0;a<r.length;a++){for(var s=r[a],n=0;n<s.layers.length;n++)if(!s.layers[n].features.length){s.layers.splice(n,1);n-=1}if(!s.layers.length){r.splice(a,1);a-=1}}o.info.defaultFeature=e.defaultFeature;o.elevationRequest&&(e.displayElevation=!0);o.renderResults(e,function(){o.insertLinks();if(o.sharedFeatureInfo){o.div.querySelectorAll("ul."+o.CLASS+"-services li").forEach(function(e){e.classList.add(TC.Consts.classes.CHECKED)});for(var e,r=o.sharedFeatureInfo,a=0,s=o.info.services.length;a<s;a++){var n=o.info.services[a];if(n.mapLayers.some(function(e){return e.url===r.s})){for(var l=0,i=n.layers.length;l<i;l++){var c=n.layers[l];if(c.name===r.l){for(var f=0,u=c.features.length;f<u;f++){var C=c.features[f];if(C.id===r.f){e=C;var p=hex_md5(JSON.stringify({data:C.getData(),geometry:t(C.geometry,TC.Consts.DEGREE_PRECISION)}));r.h!==p&&TC.alert(o.getLocaleString("finfo.featureChanged.warning"));break}}break}}break}}if(e){o.highlightedFeature=e;o.map.addLayer({id:o.getUID(),type:TC.Consts.layerType.VECTOR,title:o.getLocaleString("foi"),owner:o,stealth:!0}).then(function(t){o.sharedFeatureLayer=t;o.filterLayer.clearFeatures();o.filterFeature=null;t.addFeature(e);o.map.zoomToFeatures([e])})}delete o.sharedFeatureInfo}else o.displayResults();o.div.querySelectorAll("ul."+o.CLASS+"-services label, ul."+o.CLASS+"-services a").forEach(function(e){e.addEventListener(TC.Consts.event.CLICK,function(e){e.stopPropagation()})})})}};e.displayResultsCallback=function(){const e=this;TC.control.FeatureInfoCommons.prototype.displayResultsCallback.call(e);if(e.elevationRequest){const t=e.getDisplayControl();e.getDisplayTarget().querySelector(`.${e.CLASS}-elev`).classList.add(TC.Consts.classes.HIDDEN);e.elevationRequest.then(function(o){if(t.currentFeature){const r=t.currentFeature.geometry;if(TC.Util.formatCoord(r[0],e.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)===TC.Util.formatCoord(o[0][0],e.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)&&TC.Util.formatCoord(r[1],e.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)===TC.Util.formatCoord(o[0][1],e.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)){const t=o.length?o[0][2]:null;e.displayElevation(t)}}})}else e.querying||e.info&&e.info.services||e.closeResults()};e.renderResults=function(e,t){const o=this;if(o.filterFeature){const r=o.filterFeature.geometry;if(e.coords&&r[0]===e.coords[0]&&r[1]===e.coords[1]){const r=o.map.options.locale||TC.Cfg.locale;e.isGeo=o.map.wrap.isGeo();if(e.coords){e.crs=o.map.crs;e.coords=e.coords.map(function(t){return TC.Util.formatNumber(t.toFixed(e.isGeo?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),r)})}o.renderData(e,t)}}};e.displayElevation=function(e){const t=this.map.options.locale||TC.Cfg.locale,o=null===e?"-":TC.Util.formatNumber(Math.round(e),t)+" m",r=this.getDisplayTarget().querySelector(`.${this.CLASS}-elev`);r.classList.toggle(TC.Consts.classes.HIDDEN,null===e);r.querySelector(`.${this.CLASS}-coords-val`).innerHTML=o};e.loadSharedFeature=function(e){const t=this;if(e){if(0===t.map.workLayers.filter(function(t,o){return t.type===TC.Consts.layerType.WMS&&t.url===e.s&&t.getDisgregatedLayerNames().indexOf(e.l)>=0}).length){TC.error(t.getLocaleString("sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST);return}t.sharedFeatureInfo=e;TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){const o=[-100,-100];t.beforeRequest({xy:o});t.filterLayer.clearFeatures();t.filterFeature=null;t.filterLayer.addMarker(o).then(function(o){t.filterFeature=o;t.wrap.getFeatureInfo(e.xy,e.r,{serviceUrl:e.s,layerName:e.l,featureId:e.f})})})}}}();
//# sourceMappingURL=../maps/control/FeatureInfo.min.js.map