TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.BEFOREFEATUREMODIFY="beforefeaturemodify.tc";TC.Consts.event.FEATUREMODIFY="featuremodify.tc";TC.Consts.event.FEATURESSELECT="featuresselect.tc";TC.Consts.event.FEATURESUNSELECT="featuresunselect.tc";TC.Consts.event.CHANGE="change";!function(){TC.control.Modify=function(){TC.Control.apply(this,arguments);if(!Modernizr.inputtypes.color&&!window.CP){TC.loadCSS(TC.apiLocation+"lib/color-picker/color-picker.min.css");TC.syncLoadJS(TC.apiLocation+"lib/color-picker/color-picker.min.js")}this.styles=$.extend(!0,TC.Cfg.styles.selection,this.options.styles);this.styles.text=this.styles.text||{fontSize:this.styles.line.fontSize,fontColor:this.styles.line.fontColor,labelOutlineColor:this.styles.line.labelOutlineColor,labelOutlineWidth:this.styles.line.labelOutlineWidth};this._classSelector="."+this.CLASS;this.wrap=new TC.wrap.control.Modify(this)};TC.inherit(TC.control.Modify,TC.Control);var t=TC.control.Modify.prototype;t.CLASS="tc-ctl-mod";TC.isDebug?t.template=TC.apiLocation+"TC/templates/Modify.html":t.template=function(){dust.register(t.CLASS,e);function e(t,e){return t.w('<button class="tc-ctl-btn tc-ctl-mod-btn-select" disabled title="').h("i18n",e,{},{$key:"select"}).w('">').h("i18n",e,{},{$key:"select"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-delete" disabled title="').h("i18n",e,{},{$key:"deleteSelection"}).w('">').h("i18n",e,{},{$key:"deleteSelection"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-join" disabled title="').h("i18n",e,{},{$key:"joinGeometries.tooltip"}).w('">').h("i18n",e,{},{$key:"joinGeometries"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-split" disabled title="').h("i18n",e,{},{$key:"splitGeometry"}).w('">').h("i18n",e,{},{$key:"splitGeometry"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-text" contenteditable="true" disabled title="').h("i18n",e,{},{$key:"addText"}).w('">').h("i18n",e,{},{$key:"addText"}).w('</button><div class="tc-ctl-mod-style tc-hidden"><input type="text" class="tc-ctl-mod-txt tc-textbox" placeholder="').h("i18n",e,{},{$key:"writeTextForSketch"}).w('" style="font-size:').f(e.get(["fontSize"],!1),e,"h").w("pt;font-color:").f(e.get(["fontColor"],!1),e,"h").w(";text-shadow: 0 0 ").f(e.get(["labelOutlineWidth"],!1),e,"h").w("px ").f(e.get(["labelOutlineColor"],!1),e,"h").w(';" />').h("i18n",e,{},{$key:"textColor"}).w('<input type="color" class="tc-ctl-mod-fnt-c" value="').f(e.get(["fontColor"],!1),e,"h").w('" />').h("i18n",e,{},{$key:"fontSize"}).w('<input type="number" class="tc-ctl-mod-fnt-s tc-textbox" value="').f(e.get(["fontSize"],!1),e,"h").w('" min="7" max="20" /></div>')}e.__dustBody=!0;return e};const e=function(t,e){t._deleteBtn.disabled=0===e.length;t._joinBtn.disabled=e.length<2;t._splitBtn.disabled=0===e.filter(n).length;t.displayLabelText()},n=function(t){var e=!1;(TC.feature.MultiPolygon&&t instanceof TC.feature.MultiPolygon||TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline)&&t.geometry.length>1&&(e=!0);return e};t.register=function(t){const n=this,o=TC.Control.prototype.register.call(n,t);if(n.options.layer){n.setLayer(n.options.layer);t.on(TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATURESADD,function(t){Promise.all([n.getLayer(),n.renderPromise()]).then(function(e){const o=e[0];if(t.layer===o){n._selectBtn.disabled=!1;n._textBtn.disabled=!1}})}).on(TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATURESCLEAR,function(t){const o=t.layer,l=t.feature;Promise.all([n.getLayer(),n.renderPromise()]).then(function(t){if(o===t[0]){l?n.unselectFeatures([l]):n.unselectFeatures();e(n,n.getSelectedFeatures());if(0===n.layer.features.length){n._selectBtn.disabled=!0;n.setTextMode(!1);n._textBtn.disabled=!0}}})});const o=function(){const t=n.getSelectedFeatures();e(n,t);n.layer.features.filter(function(e){return t.indexOf(e)<0}).forEach(function(t){t.toggleSelectedStyle(!1)});t.forEach(function(t){t.toggleSelectedStyle(!0)})};n.on(TC.Consts.event.FEATURESSELECT,o).on(TC.Consts.event.FEATURESUNSELECT,o)}return o};t.render=function(t){const e=this,n=function(){e._selectBtn=e.div.querySelector("."+e.CLASS+"-btn-select");e._selectBtn.addEventListener(TC.Consts.event.CLICK,function(t){t.target.disabled||(e.isActive?e.deactivate():e.activate())});e._deleteBtn=e.div.querySelector("."+e.CLASS+"-btn-delete");e._deleteBtn.addEventListener(TC.Consts.event.CLICK,function(){e.deleteSelectedFeatures()});e._textBtn=e.div.querySelector("."+e.CLASS+"-btn-text");e._textBtn.addEventListener(TC.Consts.event.CLICK,function(){e.setTextMode(!e.textActive)});e._joinBtn=e.div.querySelector("."+e.CLASS+"-btn-join");e._splitBtn=e.div.querySelector("."+e.CLASS+"-btn-split");e._textInput=e.div.querySelector("input."+e.CLASS+"-txt");e._textInput.addEventListener("input",function(t){e.labelFeatures(t.target.value)});e._styleSection=e.div.querySelector("."+e.CLASS+"-style");e._fontColorPicker=e.div.querySelector(e._classSelector+"-fnt-c");e._fontColorPicker.addEventListener(TC.Consts.event.CHANGE,function(t){e.setFontColor(t.target.value)});e._fontSizeSelector=e.div.querySelector("."+e.CLASS+"-fnt-s");e._fontSizeSelector.addEventListener(TC.Consts.event.CHANGE,function(t){e.setFontSize(t.target.value)});$.isFunction(t)&&t()},o={fontSize:e.styles.text.fontSize,fontColor:e.styles.text.fontColor,labelOutlineColor:e.styles.text.labelOutlineColor,labelOutlineWidth:e.styles.text.labelOutlineWidth};return Modernizr.inputtypes.color?e._set1stRenderPromise(e.renderData(o,n)):e._set1stRenderPromise(e.renderData(o,function(){const t=e.div.querySelector("input[type=color]");t.style.backgroundColor=t.value;t.style.color="transparent";const o=new CP(t,"click",document.body);t.onclick=function(t){t.preventDefault()};t.onfocus=function(t){this.blur()};t.onchange=function(t){this.style.backgroundColor=this.value};e.map.loaded(function(){o.on("change",function(t){e.setFontColor("#"+t)})});n()}))};t.activate=function(){this._selectBtn.classList.add(TC.Consts.classes.ACTIVE);TC.Control.prototype.activate.call(this);this.wrap.activate(this.mode)};t.deactivate=function(){const t=this;TC.Control.prototype.deactivate.call(t);t._selectBtn&&e(t,[]);t.wrap&&t.wrap.deactivate();if(t._selectBtn){t._selectBtn.classList.remove(TC.Consts.classes.ACTIVE);t.layer.features.forEach(function(t){t.toggleSelectedStyle(!1)})}};t.clear=function(){const t=this;t.layer&&t.layer.clearFatures();return t};t.isExclusive=function(){return!0};t.end=function(){this.wrap.end();return this};t.setMode=function(t,e){const n=this;t&&(n.mode=t);if(e&&t){n.layer&&n.layer.map.putLayerOnTop(n.layer);n.activate()}else n.deactivate();return n};t.getLayer=function(){return this.options&&"boolean"==typeof this.options.layer&&!this.options.layer?Promise.resolve(null):this.layer?Promise.resolve(this.layer):this._layerPromise};t.setLayer=function(t){var e=this;e.map&&(e._layerPromise=new Promise(function(n,o){if("string"==typeof t)e.map.loaded(function(){e.layer=e.map.getLayer(t);n(e.layer)});else{e.layer=t;n(e.layer)}}))};t.getSelectedFeatures=function(){return this.wrap.getSelectedFeatures()};t.setSelectedFeatures=function(t){const e=this.wrap.setSelectedFeatures(t);this.displayLabelText();return e};t.getActiveFeatures=function(){const t=this,e=t.getSelectedFeatures();!e.length&&t.layer.features.length&&e.push(t.layer.features[t.layer.features.length-1]);return e};t.unselectFeatures=function(t){t=t||[];this.wrap.unselectFeatures(t.map(function(t){return t.wrap.feature}));return this};t.deleteSelectedFeatures=function(){const t=this,e=t.getSelectedFeatures();t.wrap.unselectFeatures(e);e.forEach(function(e){t.layer.removeFeature(e)});return t};t.styleFunction=function(t,e){var n;const o=this.map.options.styles.selection;switch(!0){case TC.feature.Polygon&&t instanceof TC.feature.Polygon:case TC.feature.MultiPolygon&&t instanceof TC.feature.MultiPolygon:n=$.extend({},o.polygon);break;case TC.feature.Point&&t instanceof TC.feature.Point:case TC.feature.MultiPoint&&t instanceof TC.feature.MultiPoint:n=$.extend({},o.point);break;default:n=$.extend({},o.line)}const l=t.getStyle();if(l.label){n.label=l.label;n.fontSize=l.fontSize;n.fontColor=l.fontColor;n.labelOutlineColor=l.labelOutlineColor;n.labelOutlineWidth=l.labelOutlineWidth}return n};t.setTextMode=function(t){const e=this;e.textActive=t;if(t){e._textBtn.classList.add(TC.Consts.classes.ACTIVE);e._textBtn.classList.add(t)}else{e._textBtn.classList.remove(TC.Consts.classes.ACTIVE);e._textBtn.classList.remove(t)}t?e._styleSection.classList.remove(TC.Consts.classes.HIDDEN):e._styleSection.classList.add(TC.Consts.classes.HIDDEN);e.displayLabelText();return e};t.setFontColorWatch=function(t,e){const n=this;void 0===t&&(t=n.styles.text.fontColor);t=TC.Util.colorArrayToString(t);e=e||n.getLabelOutlineColor(t);n.renderPromise().then(function(){n._fontColorPicker.value=t;n._textInput.style.color=t;n._textInput.style.textShadow="0 0 "+n.styles.text.labelOutlineWidth+"px "+e;if(!Modernizr.inputtypes.color){n._fontColorPicker.style.backgroundColor=t;n._fontColorPicker.blur()}});return n};t.setFontColor=function(t){const e=this;e.styles.text.fontColor=t;e.styles.text.labelOutlineColor=e.getLabelOutlineColor(t);e.setFontColorWatch(t,e.styles.text.labelOutlineColor);e.getActiveFeatures().forEach(function(n){const o=n.getStyle();o.fontColor=t;o.labelOutlineColor=e.styles.text.labelOutlineColor;n.setStyle(o)});return e};t.setFontSizeWatch=function(t){const e=this;void 0===t&&(t=e.styles.text.fontSize);const n=parseInt(t);n!==Number.NaN&&e.renderPromise().then(function(){e._fontSizeSelector.value=n;e._textInput.style.fontSize=n+"pt"});return e};t.setFontSize=function(t){const e=this,n=parseInt(t);if(n!==Number.NaN){e.styles.text.fontSize=n;e.setFontSizeWatch(n);e.getActiveFeatures().forEach(function(t){const e=t.getStyle();e.fontSize=n;t.setStyle(e)})}return e};t.getLabelOutlineColor=function(t){if(t){const e=(t=TC.Util.colorArrayToString(t)).match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);e&&e.length&&(t="#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]);const n=t.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(n&&n.length){return(parseInt(n[1],16)+parseInt(n[2],16)+parseInt(n[3],16))/3<128?"#ffffff":"#000000"}}return"#ffffff"};t.displayLabelText=function(){const t=this,e=t.getSelectedFeatures();var n,o,l;if(t.isActive&&e.length){const t=e[e.length-1].getStyle();n=t.label;l=t.fontColor;o=t.fontSize}else{n="";l=t.styles.text.fontColor;o=t.styles.text.fontSize}t.renderPromise().then(function(){t.setFontSizeWatch(o).setFontColorWatch(l)._textInput.value=n});return t};t.labelFeatures=function(t){const e=this,n=e.getActiveFeatures();if(n.length){const o=n[0].getStyle();n.forEach(function(n){const l=$.extend({},e.styles.text,o);o.label=t;o.labelOffset=l.labelOffset;o.fontColor=l.fontColor;o.fontSize=l.fontSize;o.labelOutlineColor=l.labelOutlineColor;o.labelOutlineWidth=l.labelOutlineWidth;n.setStyle(o)})}return e}}();
//# sourceMappingURL=../maps/Control/Modify.min.js.map
