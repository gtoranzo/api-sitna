TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.BEFOREFEATUREMODIFY="beforefeaturemodify.tc";TC.Consts.event.FEATUREMODIFY="featuremodify.tc";TC.Consts.event.FEATURESSELECT="featuresselect.tc";TC.Consts.event.FEATURESUNSELECT="featuresunselect.tc";TC.Consts.event.CHANGE="change";TC.control.Modify=function(){TC.Control.apply(this,arguments);if(!TC.browserFeatures.inputTypeColor()&&!window.CP){TC.loadCSS(TC.apiLocation+"lib/color-picker/color-picker.min.css");TC.syncLoadJS(TC.apiLocation+"lib/color-picker/color-picker.min.js")}this.styles=TC.Util.extend(!0,TC.Cfg.styles.selection,this.options.styles);this.styles.text=this.styles.text||{fontSize:this.styles.line.fontSize,fontColor:this.styles.line.fontColor,labelOutlineColor:this.styles.line.labelOutlineColor,labelOutlineWidth:this.styles.line.labelOutlineWidth};this._classSelector="."+this.CLASS;this.wrap=new TC.wrap.control.Modify(this);this.snapping="boolean"!=typeof this.options.snapping||this.options.snapping};TC.inherit(TC.control.Modify,TC.Control);!function(){var t=TC.control.Modify.prototype;t.CLASS="tc-ctl-mod";t.template={};t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w('<button class="tc-ctl-btn tc-ctl-mod-btn-select" disabled title="').h("i18n",e,{},{$key:"select"}).w('">').h("i18n",e,{},{$key:"select"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-delete" disabled title="').h("i18n",e,{},{$key:"deleteSelectedFeatures"}).w('">').h("i18n",e,{},{$key:"deleteSelectedFeatures"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-join" disabled title="').h("i18n",e,{},{$key:"joinGeometries.tooltip"}).w('">').h("i18n",e,{},{$key:"joinGeometries"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-split" disabled title="').h("i18n",e,{},{$key:"splitGeometry"}).w('">').h("i18n",e,{},{$key:"splitGeometry"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-attr" disabled title="').h("i18n",e,{},{$key:"editAttributes"}).w('">').h("i18n",e,{},{$key:"editAttributes"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-text" contenteditable="true" disabled title="').h("i18n",e,{},{$key:"addText"}).w('">').h("i18n",e,{},{$key:"addText"}).w('</button><div class="tc-ctl-mod-style tc-hidden"><input type="text" class="tc-ctl-mod-txt tc-textbox" placeholder="').h("i18n",e,{},{$key:"writeTextForSketch"}).w('" style="font-size:').f(e.get(["fontSize"],!1),e,"h").w("pt;font-color:").f(e.get(["fontColor"],!1),e,"h").w(";text-shadow: 0 0 ").f(e.get(["labelOutlineWidth"],!1),e,"h").w("px ").f(e.get(["labelOutlineColor"],!1),e,"h").w(';" />').h("i18n",e,{},{$key:"textColor"}).w('<input type="color" class="tc-ctl-mod-fnt-c" value="').f(e.get(["fontColor"],!1),e,"h").w('" />').h("i18n",e,{},{$key:"fontSize"}).w('<input type="number" class="tc-ctl-mod-fnt-s tc-textbox" value="').f(e.get(["fontSize"],!1),e,"h").w('" min="7" max="20" /></div><div class="tc-ctl-mod-attr tc-hidden"></div>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-attr"]=function(){dust.register(t.CLASS+"-attr",e);function e(t,e){return t.w('<div class="tc-ctl-mod-attr"><h3>').h("i18n",e,{},{$key:"attributeEdit"}).w('</h3><div class="tc-ctl-mod-attr-body"><table><tbody>').s(e.get(["data"],!1),e,{block:n},{}).w('</tbody></table></div><div class="tc-ctl-mod-attr-footer"><button class="tc-button tc-ctl-mod-btn-attr-ok">').h("i18n",e,{},{$key:"ok"}).w('</button><button class="tc-button tc-ctl-mod-btn-attr-cancel">').h("i18n",e,{},{$key:"cancel"}).w("</button></div></div>")}e.__dustBody=!0;function n(t,e){return t.w("<tr><th>").f(e.get(["name"],!1),e,"h").w('</th><td><input type="text" class="tc-textbox" name="').f(e.get(["name"],!1),e,"h").w('" value="').f(e.get(["value"],!1),e,"h").w('" /></td></tr>')}n.__dustBody=!0;return e};const e=function(t,e){t._deleteBtn.disabled=0===e.length;t._editAttrBtn.disabled=1!==e.length;t._joinBtn.disabled=e.length<2;t._splitBtn.disabled=0===e.filter(n).length;t.displayLabelText()},n=function(t){var e=!1;(TC.feature.MultiPolygon&&t instanceof TC.feature.MultiPolygon||TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline)&&t.geometry.length>1&&(e=!0);return e};t.register=function(t){const n=this,o=TC.Control.prototype.register.call(n,t);n.options.layer&&n.setLayer(n.options.layer);t.on(TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATURESADD,function(t){Promise.all([n.getLayer(),n.renderPromise()]).then(function(e){const o=e[0];t.layer===o&&n.setSelectableState(!0)})}).on(TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATURESCLEAR,function(t){const o=t.layer,s=t.feature;Promise.all([n.getLayer(),n.renderPromise()]).then(function(t){if(o===t[0]){s?n.unselectFeatures([s]):n.unselectFeatures();e(n,n.getSelectedFeatures());if(0===n.layer.features.length){n.setSelectableState(!1);n.setTextMode(!1)}}})}).on(TC.Consts.event.LAYERUPDATE,function(t){const o=t.layer;Promise.all([n.getLayer(),n.renderPromise()]).then(function(t){o===t[0]&&e(n,n.getSelectedFeatures())})});n.on(TC.Consts.event.FEATURESSELECT+" "+TC.Consts.event.FEATURESUNSELECT,function(){const t=n.getSelectedFeatures();e(n,t);n.layer.features.filter(function(e){return t.indexOf(e)<0}).forEach(function(t){t.toggleSelectedStyle(!1)});t.forEach(function(t){t.toggleSelectedStyle(!0)});n.getAttributeDisplayTarget().classList.contains(TC.Consts.classes.HIDDEN)||n.displayAttributes();t.length||n.closeAttributes()});return o};t.render=function(t){const e=this,n=function(){e._selectBtn=e.div.querySelector("."+e.CLASS+"-btn-select");e._selectBtn.addEventListener(TC.Consts.event.CLICK,function(t){t.target.disabled||(e.isActive?e.deactivate():e.activate())});e._deleteBtn=e.div.querySelector("."+e.CLASS+"-btn-delete");e._deleteBtn.addEventListener(TC.Consts.event.CLICK,function(){e.deleteSelectedFeatures()});e._textBtn=e.div.querySelector("."+e.CLASS+"-btn-text");e._textBtn.addEventListener(TC.Consts.event.CLICK,function(){e.setTextMode(!e.textActive)});e._joinBtn=e.div.querySelector("."+e.CLASS+"-btn-join");e._splitBtn=e.div.querySelector("."+e.CLASS+"-btn-split");e._editAttrBtn=e.div.querySelector("."+e.CLASS+"-btn-attr");e._editAttrBtn.addEventListener(TC.Consts.event.CLICK,function(){e.toggleAttributes()});e._textInput=e.div.querySelector("input."+e.CLASS+"-txt");e._textInput.addEventListener("input",function(t){e.labelFeatures(t.target.value)});e._styleSection=e.div.querySelector("."+e.CLASS+"-style");e._fontColorPicker=e.div.querySelector(e._classSelector+"-fnt-c");e._fontColorPicker.addEventListener(TC.Consts.event.CHANGE,function(t){e.setFontColor(t.target.value)});e._fontSizeSelector=e.div.querySelector("."+e.CLASS+"-fnt-s");e._fontSizeSelector.addEventListener(TC.Consts.event.CHANGE,function(t){e.setFontSize(t.target.value)});e._attributesSection=e.div.querySelector("."+e.CLASS+"-attr");TC.Util.isFunction(t)&&t()},o={fontSize:e.styles.text.fontSize,fontColor:e.styles.text.fontColor,labelOutlineColor:e.styles.text.labelOutlineColor,labelOutlineWidth:e.styles.text.labelOutlineWidth};return TC.browserFeatures.inputTypeColor()?e._set1stRenderPromise(e.renderData(o,n)):e._set1stRenderPromise(e.renderData(o,function(){const t=e.div.querySelector("input[type=color]");t.style.backgroundColor=t.value;t.style.color="transparent";const o=new CP(t,"click",document.body);t.onclick=function(t){t.preventDefault()};t.onfocus=function(t){this.blur()};t.onchange=function(t){this.style.backgroundColor=this.value};e.map.loaded(function(){o.on("change",function(t){e.setFontColor("#"+t)})});n()}))};t.activate=function(){this._selectBtn.classList.add(TC.Consts.classes.ACTIVE);TC.Control.prototype.activate.call(this);this.wrap.activate(this.mode)};t.deactivate=function(){const t=this;TC.Control.prototype.deactivate.call(t);t._selectBtn&&e(t,[]);t.wrap&&t.wrap.deactivate();if(t._selectBtn){t._selectBtn.classList.remove(TC.Consts.classes.ACTIVE);t.layer&&t.layer.features.forEach(function(t){t.toggleSelectedStyle(!1)})}};t.clear=function(){const t=this;t.layer&&t.layer.clearFatures();return t};t.isExclusive=function(){return!0};t.end=function(){this.wrap.end();return this};t.setMode=function(t,e){const n=this;t&&(n.mode=t);if(e&&t){n.layer&&n.layer.map.putLayerOnTop(n.layer);n.activate()}else n.deactivate();return n};t.getLayer=function(){return this.options&&"boolean"==typeof this.options.layer&&!this.options.layer?Promise.resolve(null):this.layer?Promise.resolve(this.layer):this._layerPromise};t.setLayer=function(t){const e=this;if(e.map){e.setSelectedFeatures([]);e._layerPromise=new Promise(function(n,o){if("string"==typeof t)e.map.loaded(function(){e.layer=e.map.getLayer(t);n(e.layer)});else{e.layer=t;n(e.layer)}});Promise.all([e._layerPromise,e.renderPromise()]).then(function(t){const n=t[0];e.setSelectableState(n&&n.features.length>0)})}};t.setSelectableState=function(t){this._selectBtn.disabled=!t;this._textBtn.disabled=!t};t.getSelectedFeatures=function(){return this.wrap.getSelectedFeatures()};t.setSelectedFeatures=function(t){const e=this.wrap.setSelectedFeatures(t);this.displayLabelText();return e};t.getActiveFeatures=function(){const t=this,e=t.getSelectedFeatures();!e.length&&t.layer.features.length&&e.push(t.layer.features[t.layer.features.length-1]);return e};t.unselectFeatures=function(t){t=t||[];this.wrap.unselectFeatures(t.map(function(t){return t.wrap.feature}));return this};t.deleteSelectedFeatures=function(){const t=this,e=t.getSelectedFeatures();t.wrap.unselectFeatures(e);e.forEach(function(e){t.layer.removeFeature(e);t.trigger(TC.Consts.event.FEATUREREMOVE,{feature:e})});return t};t.styleFunction=function(t,e){var n;const o=this.map.options.styles.selection;switch(!0){case TC.feature.Polygon&&t instanceof TC.feature.Polygon:case TC.feature.MultiPolygon&&t instanceof TC.feature.MultiPolygon:n=TC.Util.extend({},o.polygon);break;case TC.feature.Point&&t instanceof TC.feature.Point:case TC.feature.MultiPoint&&t instanceof TC.feature.MultiPoint:n=TC.Util.extend({},o.point);break;default:n=TC.Util.extend({},o.line)}const s=t.getStyle();if(s.label){n.label=s.label;n.fontSize=s.fontSize;n.fontColor=s.fontColor;n.labelOutlineColor=s.labelOutlineColor;n.labelOutlineWidth=s.labelOutlineWidth}return n};t.setTextMode=function(t){const e=this;e.textActive=t;if(t){e._textBtn.classList.add(TC.Consts.classes.ACTIVE,t);e._styleSection.classList.remove(TC.Consts.classes.HIDDEN)}else{e._textBtn.classList.remove(TC.Consts.classes.ACTIVE,t);e._styleSection.classList.add(TC.Consts.classes.HIDDEN)}e.displayLabelText();return e};t.setFontColorWatch=function(t,e){const n=this;void 0===t&&(t=n.styles.text.fontColor);t=TC.Util.colorArrayToString(t);e=e||n.getLabelOutlineColor(t);n.renderPromise().then(function(){n._fontColorPicker.value=t;n._textInput.style.color=t;n._textInput.style.textShadow="0 0 "+n.styles.text.labelOutlineWidth+"px "+e;if(!TC.browserFeatures.inputTypeColor()){n._fontColorPicker.style.backgroundColor=t;n._fontColorPicker.blur()}});return n};t.setFontColor=function(t){const e=this;e.styles.text.fontColor=t;e.styles.text.labelOutlineColor=e.getLabelOutlineColor(t);e.setFontColorWatch(t,e.styles.text.labelOutlineColor);e.getActiveFeatures().forEach(function(n){const o=n.getStyle();o.fontColor=t;o.labelOutlineColor=e.styles.text.labelOutlineColor;n.setStyle(o)});return e};t.setFontSizeWatch=function(t){const e=this;void 0===t&&(t=e.styles.text.fontSize);const n=parseInt(t);n!==Number.NaN&&e.renderPromise().then(function(){e._fontSizeSelector.value=n;e._textInput.style.fontSize=n+"pt"});return e};t.setFontSize=function(t){const e=this,n=parseInt(t);if(n!==Number.NaN){e.styles.text.fontSize=n;e.setFontSizeWatch(n);e.getActiveFeatures().forEach(function(t){const e=t.getStyle();e.fontSize=n;t.setStyle(e)})}return e};t.getLabelOutlineColor=function(t){if(t){const e=(t=TC.Util.colorArrayToString(t)).match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);e&&e.length&&(t="#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]);const n=t.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(n&&n.length){return(parseInt(n[1],16)+parseInt(n[2],16)+parseInt(n[3],16))/3<128?"#ffffff":"#000000"}}return"#ffffff"};t.displayLabelText=function(){const t=this,e=t.getSelectedFeatures();var n,o,s;if(t.isActive&&e.length){const t=e[e.length-1].getStyle();n=t.label;s=t.fontColor;o=t.fontSize}else{n="";s=t.styles.text.fontColor;o=t.styles.text.fontSize}t.renderPromise().then(function(){t.setFontSizeWatch(o).setFontColorWatch(s)._textInput.value=n||""});return t};t.labelFeatures=function(t){const e=this,n=e.getActiveFeatures();if(n.length){const o=n[0].getStyle();n.forEach(function(n){const s=TC.Util.extend({},e.styles.text,o);o.label=t;o.labelOffset=s.labelOffset;o.fontColor=s.fontColor;o.fontSize=s.fontSize;o.labelOutlineColor=s.labelOutlineColor;o.labelOutlineWidth=s.labelOutlineWidth;n.setStyle(o)})}return e};t.getAttributeDisplayTarget=function(){return this._attributesSection};t.displayAttributes=function(){const t=this,e=t.getSelectedFeatures(),n=e[e.length-1];n&&t.getRenderedHtml(t.CLASS+"-attr",{data:n.getData()},function(e){const n=t.getAttributeDisplayTarget();n.innerHTML=e;n.classList.remove(TC.Consts.classes.HIDDEN);t._editAttrBtn.classList.add(TC.Consts.classes.ACTIVE);n.querySelector(`${t.CLASS}-btn-attr-ok`).addEventListener(TC.Consts.event.CLICK,function(e){t._onAttrOK()});n.querySelector(`.${t.modifyControl.CLASS}-btn-attr-cancel`).addEventListener(TC.Consts.event.CLICK,function(){t.closeAttributes()})})};t.closeAttributes=function(){this._attributesSection.classList.add(TC.Consts.classes.HIDDEN);this._editAttrBtn.classList.remove(TC.Consts.classes.ACTIVE)};t.toggleAttributes=function(){const t=this;t._editAttrBtn.classList.toggle(TC.Consts.classes.ACTIVE)?t.displayAttributes():t.closeAttributes()};t._onAttrOK=function(){const t=this,e=t.getSelectedFeatures()[0];if(e){const n={};t.getAttributeDisplayTarget().querySelectorAll("input").forEach(function(t){n[t.getAttribute("name")]=t.value});e.setData(n);t.trigger(TC.Consts.event.FEATUREMODIFY,{feature:e,layer:t.layer});t.closeAttributes()}};t.joinFeatures=function(t){const n=this;if(n.geometryType===TC.Consts.geom.MULTIPOLYLINE||n.geometryType===TC.Consts.geom.MULTIPOLYGON||n.geometryType===TC.Consts.geom.MULTIPOINT){n._joinedFeatureAttributes=[];if(t.length>1){for(var o=t.map(function(t){n._joinedFeatureAttributes[n._joinedFeatureAttributes.length]=t.getData();return t.geometry}).reduce(function(t,e){return t.concat(e)}),s=new t[0].constructor(o),l=0,i=t.length;l<i;l++){var r=t[l];n.layer.removeFeature(r);n.trigger(TC.Consts.event.FEATUREREMOVE,{feature:r})}n.layer.addFeature(s).then(function(t){n.setSelectedFeatures([s]);n.trigger(TC.Consts.event.FEATUREADD,{feature:t});t.showPopup(n.attributeEditor)})}e(n,[s])}}}();
//# sourceMappingURL=../maps/control/Modify.min.js.map