TC.control=TC.control||{};HTMLElement.prototype.appendHTML||(HTMLElement.prototype.appendHTML=function(e){var t=document.createElement("div");t.innerHTML=e;if(t.childNodes.length>1)for(var n=0;n<t.childNodes.length;n++)this.appendChild(t.childNodes[n]);t.childNodes.length>0&&this.appendChild(t.firstChild);return null});Document.prototype.createHTMLElement||(Document.prototype.createHTMLElement=function(e){var t=document.createElement("div");t.innerHTML=e;return t.childNodes.length>0?t.firstChild:null});HTMLElement.prototype.empty||(HTMLElement.prototype.empty=function(){for(;this.children.length;)this.removeChild(this.children[0])});"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),l=1;l<arguments.length;l++){var s=arguments[l];if(null!=s)for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(n[a]=s[a])}return n},writable:!0,configurable:!0});TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/filter");TC.control.WFSQuery=function(e){TC.Control.apply(this,arguments);this.styles=this.options.styles;this.highLightStyles=this.options.highLightStyles};TC.inherit(TC.control.WFSQuery,TC.Control);!function(){var e=TC.control.WFSQuery.prototype,t=null,n=null,l=null,s=null,a=(TC.Consts.logicalOperator.AND,null),i=null,r=null,o={eq:TC.filter.equalTo,not:TC.filter.notEqualTo,gt:TC.filter.greaterThan,lt:TC.filter.lessThan,ge:TC.filter.greaterThanOrEqualTo,le:TC.filter.lessThanOrEqualTo,like:TC.filter.like,contains:TC.filter.like,start:TC.filter.like,end:TC.filter.like,bw:TC.filter.between},c=null,u=null,d=null,y=null,f=null,m=null,h=null,p=function(){return null},g=function(){return null},C=null;e.CLASS="tc-ctl-wfsquery";e.template={};if(TC.isDebug){e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/WFSQueryDialog.html";e.template[e.CLASS+"-form"]=TC.apiLocation+"TC/templates/WFSQueryForm.html";e.template[e.CLASS+"-filter"]=TC.apiLocation+"TC/templates/WFSQueryfilter.html"}else{e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-wfsquery-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window tc-ctl-wfsquery-modal-window" ><div class="tc-modal-header"><h3>').f(t.get(["layerName"],!1),t,"h").w('</h3><div title="').h("i18n",t,{},{$key:"query.tooltipCloseDialogBtn"}).w('" class="tc-modal-close"></div></div><div class="tc-modal-body">').h("gt",t,{block:n},{key:t.getPath(!1,["layers","length"]),value:1}).w('<div class="tc-modal-form"></div><div class="tc-ctl-wfsquery-message tc-hidden"></div> </div><div class="tc-modal-footer"><button type="button" title="').h("i18n",t,{},{$key:"query.tooltipSendQueryBtn"}).w('" class="tc-button tc-ctl-wlm-btn-launch">').h("i18n",t,{},{$key:"query.sendQueryBtnText"}).w('</button><button type="button" title="').h("i18n",t,{},{$key:"query.cancelQueryTooltip"}).w('" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"query.cancelQueryButton"}).w("</button></div></div></div>")}t.__dustBody=!0;function n(e,t){return e.w(' <div><select class="tc-combo" name="availableLayers"><option value="">').h("i18n",t,{},{$key:"query.chooseALayerCombo"}).w("</option>").s(t.get(["layers"],!1),t,{block:l},{}).w("</select></div> ")}n.__dustBody=!0;function l(e,t){return e.w('<option value="').f(t.get(["name"],!1),t,"h").w('">').f(t.get(["title"],!1),t,"h").w("</option>")}l.__dustBody=!0;return t};e.template[e.CLASS+"-form"]=function(){dust.register(e.CLASS+"-form",t);function t(e,t){return e.w("<div>").h("countif",t,{else:n,block:l},{key:t.get(["attributes"],!1),excludedKeys:"the_geom,FEATURE"}).w('</div><div class="tc-ctl-wfsquery-operacion tc-hidden"><div class="tc-ctl-wfsquery tc-ctl-wfsquery-numeric tc-hidden"><input type="radio" id="cond_1" name="codicion" value="eq" /><label for="cond_1" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.equalToBtn"}).w('</label><input type="radio" id="cond_2" name="codicion" value="not" /><label for="cond_2" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.notEqualToBtn"}).w('</label><input type="radio" id="cond_3" name="codicion" value="gt" /><label for="cond_3" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.greatherThanBtn"}).w('</label><input type="radio" id="cond_4" name="codicion" value="lt" /><label for="cond_4" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.lowerThanBtn"}).w('</label><input type="radio" id="cond_5" name="codicion" value="ge" /><label for="cond_5" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.greatherOrEqualThanBtn"}).w('</label><input type="radio" id="cond_6" name="codicion" value="le" /><label for="cond_6" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.lowerOrEqualThanBtn"}).w('</label>\x3c!--<input type="radio" id="cond_7" name="codicion" value="like" /><label for="cond_7" class="tc-ctl-wfsquery-cond">es como</label>--\x3e</div><div class="tc-ctl-wfsquery tc-ctl-wfsquery-text tc-hidden"><input type="radio" id="cond_8" name="codicion" value="eq" /><label for="cond_8" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.equalToBtn"}).w('</label><input type="radio" id="cond_9" name="codicion" value="contains" /><label for="cond_9" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.containsBtn"}).w('</label><input type="radio" id="cond_10" name="codicion" value="start" /><label for="cond_10" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.startsByBtn"}).w('</label><input type="radio" id="cond_11" name="codicion" value="end" /><label for="cond_11" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.endsByBtn"}).w('</label></div><div class="tc-ctl-wfsquery tc-ctl-wfsquery-date tc-hidden"><input type="radio" id="cond_12" name="codicion" value="bw" /><label for="cond_12" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.equalToBtn"}).w('</label><input type="radio" id="cond_13" name="codicion" value="nbw" /><label for="cond_13" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.notEqualToBtn"}).w('</label><input type="radio" id="cond_14" name="codicion" value="gt" /><label for="cond_14" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.greatherThanBtn"}).w('</label><input type="radio" id="cond_15" name="codicion" value="lt" /><label for="cond_15" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.lowerThanBtn"}).w('</label><input type="radio" id="cond_16" name="codicion" value="ge" /><label for="cond_16" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.greatherOrEqualThanBtn"}).w('</label><input type="radio" id="cond_17" name="codicion" value="le" /><label for="cond_17" class="tc-ctl-btn tc-ctl-wfsquery-cond">').h("i18n",t,{},{$key:"query.lowerOrEqualThanBtn"}).w('</label>\x3c!--<input type="radio" id="cond_7" name="codicion" value="like" /><label for="cond_7" class="tc-ctl-wfsquery-cond">es como</label>--\x3e</div><div class="tc-ctl-wfsquery-where tc-hidden"><input type="search" placeholder="').h("i18n",t,{},{$key:"query.searchFieldPhd"}).w('" class="tc-textbox" /><button type="button" title="').h("i18n",t,{},{$key:"query.tooltipAddCondBtn"}).w('" class="tc-button">').h("i18n",t,{},{$key:"query.textAddCondBtn"}).w('</button><ul class="tc-ctl-wfsquery-list tc-ctl-search-list tc-hidden"></ul><div class="tc-ctl-wfsquery-key"><label>').h("i18n",t,{},{$key:"query.logicalOpLbl"}).w('</label></div><div class="tc-ctl-wfsquery-value"><input type="radio" id="log_op_1" class="tc-ctl-btn tc-ctl-wfsquery-logOpRadio" checked name="log_op" value="AND" /><label for="log_op_1" class="tc-ctl-btn tc-ctl-wfsquery-logOp">').h("i18n",t,{},{$key:"query.logicalOpAndLbl"}).w('</label><input type="radio" id="log_op_2" class="tc-ctl-btn tc-ctl-wfsquery-logOpRadio" name="log_op" value="OR" /><label for="log_op_2" class="tc-ctl-btn tc-ctl-wfsquery-logOp">').h("i18n",t,{},{$key:"query.logicalOpOrLbl"}).w('</label></div><div class="tc-ctl-wfsquery-whereList"></div></div></div>')}t.__dustBody=!0;function n(e,t){return e.w('<div class="tc-ctl-wfsquery-message tc-msg-warning">').h("i18n",t,{},{$key:"query.noAttributes"}).w("</div>")}n.__dustBody=!0;function l(e,t){return e.w('<select class="tc-combo" id="attributes" name="attributes"><option value="">').h("i18n",t,{},{$key:"query.chooseAttrCombo"}).w("</option>").h("iterate",t,{block:s},{on:t.get(["attributes"],!1),excludedKeys:"the_geom,FEATURE"}).w("</select>")}l.__dustBody=!0;function s(e,t){return e.w('<option value="').f(t.get(["key"],!1),t,"h").w('">').f(t.get(["key"],!1),t,"h").w("</option>")}s.__dustBody=!0;return t};e.template[e.CLASS+"-filter"]=function(){dust.register(e.CLASS+"-filter",t);function t(e,t){return e.s(t.get(["conditions"],!1),t,{block:n},{})}t.__dustBody=!0;function n(e,t){return e.w('<div class="tc-ctl-wfsquery-where-cond">').f(t.get(["field"],!1),t,"h").w("&nbsp;").f(t.get(["opText"],!1),t,"h").w("&nbsp;").x(t.get(["isString"],!1),t,{block:l},{}).f(t.get(["valueToShow"],!1),t,"h",["numberSeparator"]).x(t.get(["isString"],!1),t,{block:s},{}).w('</div><div class="tc-ctl-wfsquery-del-cond" title="').h("i18n",t,{},{$key:"query.tooltipRemoveCond"}).w('"></div>\t')}n.__dustBody=!0;function l(e,t){return e.w("&quot;")}l.__dustBody=!0;function s(e,t){return e.w("&quot;")}s.__dustBody=!0;return t}}var b=function(e){var t=document.createElement("input");t.setAttribute("type",e);return t.type==e},w=function(e){var n=e[0],l=e[1],s=e[2];u=n;y=s;m=s.Operations.DescribeFeatureType.DCP.HTTP.Get["xlink:href"];h=s.Operations.GetFeature.CountDefault?s.Operations.GetFeature.CountDefault.DefaultValue:null;var a=n.getDisgregatedLayerNames();if((a=a.filter(function(e){return s.FeatureTypes.hasOwnProperty(e.substring(e.indexOf(":")+1))})).length>1){t.classList.remove("tc-loading");l.getElementsByClassName("tc-combo")[0].addEventListener("change",function(){if(this.value){l.querySelector(".tc-modal-body .tc-ctl-wfsquery-message",l).classList.add(TC.Consts.classes.HIDDEN);f=this.options[this.selectedIndex].text;t.classList.add("tc-loading");v(this.value,s).then(function(e){S(e,l)},function(){var e=l.getElementsByClassName("tc-modal-body")[0];e.classList.remove("tc-loading");e.appendHTML('<div class="tc-ctl-wfsquery-message tc-msg-warning">'+C("query.LayerNotAvailable")+"</div>");e.empty()})}else{var e=l.getElementsByClassName("tc-modal-form")[0];e.empty();for(var n=0;n<e.children.length;n++)e.removeChild(e.children[n]);E()}})}else{if(s.FeatureTypes[a[0].substring(a[0].indexOf(":")+1)]){f=s.FeatureTypes[a[0].substring(a[0].indexOf(":")+1)].Title;v(a[0],s).then(function(e){S(e,l)},function(){var e=l.getElementsByClassName("tc-modal-body")[0];e.classList.remove("tc-loading");e.appendHTML('<div class="tc-ctl-wfsquery-message tc-msg-warning">'+C("query.LayerNotAvailable")+"</div>");e.empty()})}else{var i=l.getElementsByClassName("tc-modal-body")[0];i.classList.remove("tc-loading");i.appendHTML('<div class="tc-ctl-wfsquery-message tc-msg-warning">'+C("query.LayerNotAvailable")+"</div>")}}},v=function(e,t){d=e;return new Promise(function(n,l){if(t.Operations.DescribeFeatureType){var s=t.Operations.DescribeFeatureType.DCP.HTTP.Get["xlink:href"]+"?REQUEST=DescribeFeatureType&TYPENAME="+e+"&OUTPUTFORMAT="+t.Operations.DescribeFeatureType.outputFormat;u.toolProxification.fetchXML(s).then(function(t){var s=xml2json(t),a=s[e.substring(e.indexOf(":")+1)];if(a){var i=a.type;n(s[i.substring(i.indexOf(":")+1)].complexContent.extension.sequence)}else l()}).catch(function(e){TC.error(e)})}else TC.error("No est\xe1 habilitado DescribeFeatureType en este servicio",TC.Consts.msgErrorMode.TOAST)})},T=null,q=null,L=function(e){if(b("date"))e.type="date";else{e.type="search";new Promise(function(e,t){"undefined"!=typeof IMask?setTimeout(function(){e()},10):TC.loadJS(!0,[TC.apiLocation+"/lib/polyfill/IMask"+(TC.isDebug?"":".min")+".js"],function(){console.log("Imask loaded");e()})}).then(function(){T=new IMask(e,{mask:Date,pattern:r&&"es-ES"!==r?"eu-ES"===r?"Y/`m/`d":"m/`d/`Y":"d/`m/`Y",lazy:!1,format:function(e){var t=e.getDate(),n=e.getMonth()+1,l=e.getFullYear();t<10&&(t="0"+t);n<10&&(n="0"+n);switch(r){case"eu-ES":return[l,n,t].join("/");case"en-US":return[n,t,l].join("/");case"es-ES":default:return[t,n,l].join("/")}},parse:function(e){switch(r){case"eu-ES":return new Date(e.split("/")[1]+"/"+e.split("/")[2]+"/"+e.split("/")[0]);case"en-US":return new Date(e);case"es-ES":default:return new Date(e.split("/")[1]+"/"+e.split("/")[0]+"/"+e.split("/")[2])}},blocks:{d:{mask:IMask.MaskedRange,from:1,to:31,maxLength:2},m:{mask:IMask.MaskedRange,from:1,to:12,maxLength:2},Y:{mask:IMask.MaskedRange,from:1900,to:9999}}})})}},k=function(){if(T){var e=T.el.input;T.destroy();T=null;e.value="";e.type="search"}},S=function(n,l){E();_internalGetDataTypes=function(){return n};e.getRenderedHtml(e.CLASS+"-form",{attributes:n},function(s){var a=l.getElementsByClassName("tc-modal-form")[0];a.empty();a.appendHTML(s);t.classList.remove("tc-loading");TC.loadJS(!0,[TC.apiLocation+"TC/ui/autocomplete.js"],function(){console.log("autocomplete loaded")});var i=null,c=a.getElementsByClassName("tc-combo");if(0==c.length)l.getElementsByClassName("tc-button tc-ctl-wlm-btn-launch")[0].setAttribute("disabled","");else{l.getElementsByClassName("tc-button tc-ctl-wlm-btn-launch")[0].removeAttribute("disabled");c[0].addEventListener("change",function(){var t=a.querySelector(".tc-ctl-wfsquery-where .tc-textbox");t.dataset.autocomplete&&TC.UI.autocomplete.call(t,"clear");if(n[this.value]){i=n[this.value].type;a.getElementsByClassName("tc-ctl-wfsquery-operacion")[0].classList.remove("tc-hidden");TC.UI.autocomplete.call(t,"clear");!function(){if(q){var e=q.el.input;q.destroy();q=null;e.value="";e.type="search"}}();t.type="search";switch(!0){case i.indexOf("int")>=0:case i.indexOf("float")>=0:case i.indexOf("double")>=0:case i.indexOf("long")>=0:case i.indexOf("decimal")>=0:a.getElementsByClassName("tc-ctl-wfsquery-numeric")[0].classList.remove("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-text")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-date")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-where")[0].classList.remove("tc-hidden");0===a.querySelectorAll("tc-ctl-wfsquery-numeric input:checked").length&&(a.querySelector(".tc-ctl-wfsquery-numeric :first-child").checked=!0);k();if(b("number"))if(TC.Util.detectIE()){t.type="text";new Promise(function(e,t){"undefined"!=typeof IMask?setTimeout(function(){e()},10):TC.loadJS(!0,[TC.apiLocation+"/lib/polyfill/IMask"+(TC.isDebug?"":".min")+".js"],function(){console.log("Imask loaded");e()})}).then(function(){q=new IMask(t,{mask:Number,scale:i.indexOf("int")>=0||i.indexOf("long")>=0?0:2,signed:!1,thousandsSeparator:r&&"en-US"===r?",":".",padFractionalZeros:!1,normalizeZeros:!0,radix:r&&"en-US"===r?".":","})})}else{t.type="number";i.indexOf("int")>=0||i.indexOf("long")>=0?t.step="1":t.step="0.0001"}break;case i.indexOf("dateTime")>=0:a.getElementsByClassName("tc-ctl-wfsquery-numeric")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-text")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-date")[0].classList.remove("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-where")[0].classList.remove("tc-hidden");0===a.querySelectorAll("tc-ctl-wfsquery-date input:checked").length&&(a.querySelector(".tc-ctl-wfsquery-date :first-child").checked=!0);L(t);break;case i.indexOf("string")>=0:a.getElementsByClassName("tc-ctl-wfsquery-numeric")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-text")[0].classList.remove("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-date")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-where")[0].classList.remove("tc-hidden");0===a.querySelectorAll("tc-ctl-wfsquery-text input:checked").length&&(a.querySelector(".tc-ctl-wfsquery-text :first-child").checked=!0);k();D(t,this.value,a.getElementsByClassName(e.CLASS+"-list tc-ctl-search-list")[0])}}else{a.getElementsByClassName("tc-ctl-wfsquery-numeric")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-date")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-text")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-where")[0].classList.add("tc-hidden");a.getElementsByClassName("tc-ctl-wfsquery-operacion")[0].classList.add("tc-hidden")}});a.querySelector(".tc-ctl-wfsquery-where  input[type='radio']").addEventListener("change",function(){"OR"===this.value?TC.Consts.logicalOperator.OR:TC.Consts.logicalOperator.AND;a.getElementsByClassName("tc-ctl-wfsquery-whereList-op")[0].innerHTML=this.nextElementSibling.innerHTML});a.querySelector(".tc-button").addEventListener("click",function(){var e=a.querySelector("input.tc-textbox");TC.UI.autocomplete.call(e,"clear");q&&q.masked.remove();if(O(a)){var t,n,l=a.querySelector(".tc-combo").value,s=a.querySelector('.tc-ctl-wfsquery input[type="radio"]:checked'),c=s.value,u=s.nextElementSibling.innerText,d=(t=e,q?q.unmaskedValue:T?T.unmaskedValue.substring(4)+"-"+T.unmaskedValue.substring(2,4)+"-"+T.unmaskedValue.substring(0,2):t.value),y=function(e){if(q)return q.value;if(T)return T.value;if("date"===e.type)return new Date(e.value).toLocaleDateString(r);if("number"===e.type){var t=1.1.toLocaleString(r).substring(1,2);return e.value.replace(".",t)}return e.value}(e);a.querySelector('.tc-ctl-wfsquery-where  input[type="radio"]:checked').nextElementSibling.innerText;d=d.replace("<","&lt;").replace(">","&gt;");(n=i.indexOf("dateTime")>=0?"nbw"!==c?new o[c](l,d+"T00:00:00Z",d+"T23:59:59Z"):new TC.filter.not(TC.filter.between(l,d+"T00:00:00Z",d+"T23:59:59Z")):new o[c](l,("end"===c||"contains"===c?"*":"")+d+("start"===c||"contains"===c?"*":""))).matchCase=!1;whereObjList.push(n);switch(!0){case i.indexOf("int")>=0:y=parseInt(d,10);break;case i.indexOf("float")>=0:case i.indexOf("double")>=0:case i.indexOf("long")>=0:case i.indexOf("decimal")>=0:y=parseFloat(d,10)}whereFilterList.push({field:l,opText:u,isString:i.indexOf("string")>=0,valueToShow:y});x(a);e.value=""}})}})},x=function(t){dust.filters.numberSeparator||(dust.filters.numberSeparator=function(e){return e.toLocaleString(r)});t.getElementsByClassName("tc-ctl-wfsquery-whereList")[0].empty();e.getRenderedHtml(e.CLASS+"-filter",{conditions:whereFilterList},function(e){t.getElementsByClassName("tc-ctl-wfsquery-whereList")[0].innerHTML=e;for(var n=t.getElementsByClassName("tc-ctl-wfsquery-del-cond"),l=0;l<n.length;l++)n[l].addEventListener("click",function(){var e=Array.prototype.indexOf.call(n,this);whereObjList.splice(e,1);whereFilterList.splice(e,1);x(t)})})},E=function(){whereObjList=[];whereFilterList=[]},O=function(e){var t,n=e.querySelector('.tc-ctl-wfsquery input[type="radio"]:checked');if(T&&!T.masked.isComplete){!1===/^(?=\d)(?:(?:31(?!.(?:0?[2469]|11))|(?:30|29)(?!.0?2)|29(?=.0?2.(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00)))(?:\x20|$))|(?:2[0-8]|1\d|0?[1-9]))([-.\/])(?:1[012]|0?[1-9])\1(?:1[6-9]|[2-9]\d)?\d\d(?:(?=\x20\d)\x20|$))?(((0?[1-9]|1[012])(:[0-5]\d){0,2}(\x20[AP]M))|([01]\d|2[0-3])(:[0-5]\d){1,2})?$/.test(str)&&R("Fecha "+str+" inv\xe1lida",TC.Consts.msgType.ERROR);return!1}if(0==n.length){R(C("query.msgNoCondition"));return!1}if(e.querySelectorAll("input[type='date']").length&&!e.querySelector("input[type='date']").checkValidity()){R(C("query.msgNoValidDate"));return!1}if(e.querySelectorAll("input[type='number']").length&&null!=(t=e.querySelector("input[type='number']"))&&!t.checkValidity()){"1"===t.step?R(C("query.msgNoValidNumberMustInt")):R(C("query.msgNoValidNumber"));return!1}if(""===e.querySelector("input.tc-textbox").value.trim()){R(C("query.msgNoValueCondition"));return!1}return!0},N=function(){if(M()){n.getElementsByClassName("tc-modal-body")[0].classList.add("tc-loading");var e=function(){var e=B();A(f);u.toolProxification.cacheHost.getAction(m).then(function(t){const n=t.action(m);if(s){s.setVisibility(!1);s.clearFeatures();c.off(TC.Consts.event.LAYERUPDATE,F);c.on(TC.Consts.event.LAYERUPDATE,F);s.url=n;s.featurePrefix=d.substring(0,d.indexOf(":"));s.featureType=d.substring(d.indexOf(":")+1);s.maxFeatures=h;s.properties=e;s.setVisibility(!0);s.refresh()}else{_({id:"WFSQueryResults",type:TC.Consts.layerType.WFS,url:n,version:"1.1.0",stealth:!0,geometryName:"the_geom",featurePrefix:d.substring(0,d.indexOf(":")),featureType:d.substring(d.indexOf(":")+1),maxFeatures:h,properties:e,outputFormat:TC.Consts.format.JSON,styles:p()});c.on(TC.Consts.event.RESULTSPANELCLOSE,function(e){if(e.control===l){TC.browserFeatures.touch()&&TC.Util.swipe(e.control.div,"enable");s.clearFeatures();s.setVisibility(!1);c.off(TC.Consts.event.LAYERUPDATE,F)}})}})};h?$(c).then(e,function(e){n.getElementsByClassName("tc-modal-body")[0].classList.remove("tc-loading");if("NumMaxFeatures"===e.err)R(C("query.msgTooManyResults",{limit:e.limit}),TC.Consts.msgType.WARNING);else if("Empty"===e.err)R(C("query.msgNoResults"),TC.Consts.msgType.INFO);else{console.error(e.errorThrown);R(C("query.errorUndefined"),TC.Consts.msgType.ERROR)}}):e()}else R(C("query.msgNoQueryFilter"))},_=function(e){c.addLayer(e).then(function(e){s=e;e.map.on(TC.Consts.event.LAYERUPDATE,F)})},B=function(){if(whereObjList.length>1){var e=document.querySelector(".tc-ctl-wfsquery-logOpRadio:checked").value;return TC.filter[TC.Consts.logicalOperator[e]].apply(null,whereObjList)}return 0===whereObjList.length?null:whereObjList[0]},F=function(e){if(e.layer==s){var t=e.layer.features;if(t.length>0){c.zoomToFeatures(t);P(t.length>1?t.reduce(function(e,t,n){return(e instanceof Array?e:[e.data]).concat([t.data])}):[t[0].data],s,f)}else{n.getElementsByClassName("tc-modal-body")[0].classList.remove("tc-loading");R("No hay resultados",TC.Consts.msgType.INFO)}e.layer.map.off(TC.Consts.event.LAYERUPDATE,F)}},A=function(e){var t=e;new Promise(function(e,t){TC.control.ResultsPanel?e(TC.control.ResultsPanel):TC.loadJS(!0,TC.apiLocation+"TC/control/ResultsPanel",function(){e(TC.control.ResultsPanel)})}).then(function(e){if(l){l.options.save.fileName=t+".xls";l.options.titles.max=l.getLocaleString("geo.trk.chart.exp")}else{var n=function(e){l=e;delete dust.cache[l.CLASS+"-table"];if(!TC.isDebug){l.template[l.CLASS+"-table"]=dust.register(l.CLASS+"-table",t);function t(e,t){return e.w('<table class="table"><thead>').s(t.get(["columns"],!1),t,{block:n},{}).w("</thead><tbody>").s(t.get(["results"],!1),t,{block:s},{}).w("</tbody></table>")}t.__dustBody=!0;function n(e,t){return e.w("<th>").f(t.getPath(!0,[]),t,"h").w("</th>")}n.__dustBody=!0;function s(e,t){return e.w('<tr title="').h("i18n",t,{},{$key:"zoomToFeature"}).w('" data-id="').f(t.get(["Id"],!1),t,"h").w('" data-index="').f(t.get(["$idx"],!1),t,"h").w('" class="tc-selectable">').h("iterate",t,{block:a},{on:t.getPath(!0,[])}).w("</tr>")}s.__dustBody=!0;function a(e,t){return e.h("select",t,{block:i},{key:t.get(["key"],!1)})}a.__dustBody=!0;function i(e,t){return e.w('<td class="').f(t.get(["key"],!1),t,"h",["removeAccents","downcase"]).w('">').h("startsWith",t,{else:r,block:o},{key:t.get(["value"],!1),value:"http"}).w("</td>")}i.__dustBody=!0;function r(e,t){return e.f(t.get(["value"],!1),t,"h",["numberSeparator"])}r.__dustBody=!0;function o(e,t){return e.w('<a href="').f(t.get(["value"],!1),t,"h").w('" target="_blank" title="').h("i18n",t,{},{$key:"query.linkOpenAtNewTab"}).w('">').h("i18n",t,{},{$key:"query.linkText"}).w("</a>")}o.__dustBody=!0;return t}l.template[l.CLASS+"-table"]=TC.apiLocation+"TC/templates/WFSQueryResultsTable.html";l.options.titles.max=l.getLocaleString("geo.trk.chart.exp")},s=c.getControlsByClass(TC.control.ControlContainer);0==s.length?c.addControl("ResultsPanel",{content:"table",titles:{main:"",max:""},save:{fileName:t+".xls"}}).then(n):s[0].addControl("ResultsPanel",{content:"table",titles:{main:"",max:""},save:{fileName:t+".xls"},side:"right"}).then(n)}})},P=function(e,t,s){l.div.querySelector(".prpanel-title-text").innerText=l.getLocaleString(e.length>1?"query.titleResultPaneMany":"query.titleResultPanelOne",{numero:e.length,layerName:s});l.div.classList.add("tc-ctl-wfsquery-results");n.parentElement.removeChild(n);l.openTable({data:e,css:{trClass:"trClass",tdClass:"tdClass",thClass:"thClass"},callback:function(n){l.maximize();console.log("render del panel de resultados");var s=n.getElementsByTagName("tr"),a=_internalGetDataTypes(),i=1;for(var r in e[0]){if(a.hasOwnProperty(r)&&(a[r].type.indexOf("int")>=0||a[r].type.indexOf("float")>=0||a[r].type.indexOf("double")>=0||a[r].type.indexOf("long")>=0||a[r].type.indexOf("decimal")>=0))for(var o=n.querySelectorAll("td:nth-child("+i+")"),c=0;c<o.length;c++)o[c].classList.add("tc-numeric");i++}for(r=0;r<s.length;r++){s[r].addEventListener("click",function(e){e.stopPropagation();var n=this.dataset.index;null!=n&&t.map.zoomToFeatures([t.features[n]])});s[r].addEventListener("mouseenter",function(){var e=this.dataset.index;if(null!=e){var n=t.features[e];n&&n.geometry&&I(n);for(var l=0;l<this.children.length;l++){var s=this.children[l];s.offsetWidth<s.scrollWidth&&(s.title=s.innerText)}}});s[r].addEventListener("mouseleave",function(){var e=this.dataset.index;if(null!=e){var n=t.features[e];n&&n.geometry&&U(n)}})}TC.browserFeatures.touch()&&TC.Util.swipe(l.div,"disable")}})},M=function(){return whereObjList.length>0},R=function(e,n){var l=t.getElementsByClassName("tc-ctl-wfsquery-message")[0];if(a)clearTimeout(a);else{l.innerHTML=e;switch(n){case TC.Consts.msgType.INFO:l.classList.add("tc-msg-info");break;case TC.Consts.msgType.WARNING:l.classList.add("tc-msg-warning");break;case TC.Consts.msgType.ERROR:default:l.classList.add("tc-msg-error")}l.classList.remove(TC.Consts.classes.HIDDEN)}a=setTimeout(function(){a=null;l.classList.add(TC.Consts.classes.HIDDEN)},3e3)},D=function(e,t,n){TC.UI.autocomplete.call(e,{minLength:3,target:n,source:function(e,n){var l,s,a=this;a.target.innerHTML='<li><a class="tc-ctl-search-li-loading" href="#">'+C("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>';a.target.classList.remove("tc-hidden");(l=t,s=e,new Promise(function(e,t){var n=Object.assign({},y);n.version="1.1.0";switch(document.querySelector(".tc-ctl-wfsquery.tc-ctl-wfsquery-text input:checked").value){case"start":s+="*";break;case"contains":case"eq":s="*"+s+"*";break;case"end":s="*"+s}i&&(i=null);(i=u.toolProxification.fetchJSON(m+"?"+Date.now().toString(),{data:TC.Util.WFSQueryBuilder([d],TC.filter.like(l,s,void 0,void 0,void 0,!1),n,"JSON",!1),contentType:"application/xml",method:"POST"})).then(function(n){if(n.features&&n.features.length>0){var s;1===n.features.length&&(s=[n.features[0].properties[l]]);n.features.length>1&&(s=n.features.reduce(function(e,t){return e&&e instanceof Array?e.indexOf(t.properties[l])<0?e.concat(t.properties[l]):e:e.properties[l]===t.properties[l]?[e.properties[l]]:[e.properties[l],t.properties[l]]}));e(s)}else t(null)})})).then(n).catch(function(){a.target.classList.add("tc-hidden")})},callback:function(t){e.value=t.currentTarget.dataset.value;this.target.classList.add("tc-hidden")},buildHTML:function(t){var n=e.value;this.target.style.maxHeight="";return t.results.length>1?t.results.reduce(function(e,t,l){return(l>1?e:H(e,n))+H(t,n)}):H(t.results[0],n)}});e.addEventListener("targetCleared.autocomplete",function(){n.classList.add("tc-hidden")});e.addEventListener("keypress",function(t){13==t.which&&TC.UI.autocomplete.call(e,"clear")});e.addEventListener("search",function(t){0===e.value.length&&TC.UI.autocomplete.call(e,"clear")});e.addEventListener("input",function(t){0===e.value.length&&TC.UI.autocomplete.call(e,"clear")})},H=function(e,t){t=new RegExp(t,"gi");return'<li><a href="#" data-value="'+e+'">'+e.replace(t,"<b>$&</b>")+"</a></li>"},$=function(e){return new Promise(function(t,n){var l=B(),s=Object.assign({},y);s.version="1.1.0";u.toolProxification.fetchXML(m,{data:TC.Util.WFSQueryBuilder([d],l,s,null,!0,e.getCRS()),method:"POST"}).then(function(e){var l=xml2json(e);if(l.Exception)n({err:l.Exception.exceptionCode,errorThrown:l.Exception.ExceptionText});else{var s=parseInt(l.numberMatched||l.numberOfFeatures,10);isNaN(s)||s>=parseInt(h,10)?n({err:"NumMaxFeatures",limit:h}):isNaN(s)||0!==s?t():n({err:"Empty"})}}).catch(function(e,t,l){n({err:t,errorThrown:l})})})},I=function(e){var t=function(e,t){var n;t instanceof TC.feature.Point?n=e.addPoint(t.getCoords()):t instanceof TC.feature.Polyline?n=e.addPolyline(t.getCoords()):t instanceof TC.feature.Polygon?n=e.addPolygon(t.getCoords()):t instanceof TC.feature.MultiPolygon?n=e.addMultiPolygon(t.getCoords()):t instanceof TC.feature.MultiPolyline&&(n=e.addMultiPolyline(t.getCoords()));return n};if(e.layer){var n=e.layer.map.getLayer("WFSQueryResultsHighlight");n?t(n,e):e.layer.map.addLayer({id:"WFSQueryResultsHighlight",type:TC.Consts.layerType.VECTOR,stealth:!0,styles:g()},function(n){t(n,e)})}},U=function(e){var t=e.layer.map.getLayer("WFSQueryResultsHighlight");t&&t.clearFeatures()};e.render=function(e){return TC.Control.prototype.render.call(this,e)};e.register=function(e){const t=this;c=e;return new Promise(function(e){dust.helpers.countif=function(e,t,n,l){l=l||{};var s=n.block,a=n.else,i=l.key||t.current(),r=null!=l.excludedKeys?l.excludedKeys.split(","):null,o=0;for(var c in i)(null==r||r.indexOf(c)<0)&&o++;o>0?e=e.render(s,t):a&&(e=e.render(a,t));return e};TC.Control.prototype.register.call(t,c).then(function(){p=function(){var e=TC.Util.extend(!0,{},TC.Cfg.styles,{polygon:{fillColor:"#ffffff",fillOpacity:0,strokeColor:"#ff0000",strokeWidth:2},polyline:{strokeColor:"#ff0000",strokeWidth:2},point:{strokeColor:"#ff0000"}});return t.styles?Object.assign(e,t.styles):e};g=function(){var e=TC.Util.extend(!0,{},TC.Cfg.styles,{polygon:{fillColor:"#0099FF",fillOpacity:0,strokeColor:"#0099FF",strokeWidth:4},polyline:{strokeColor:"#0099FF",strokeWidth:4},point:{strokeColor:"#0099FF"}});return t.highLightStyles?Object.assign(e,t.highLightStyles):e};r=c.options.locale;C=function(e,t){return TC.Util.getLocaleString(r,e,t)};e()})})};e.renderModalDialog=function(l){var s=l.getPath(),a=new Promise(function(a,i){l.getWFSCapabilitiesPromise().then(function(i){!function(l,s,a,i){var r=[];l.getDisgregatedLayerNames().forEach(function(e,t){var n=l.getPath(e);a.FeatureTypes.hasOwnProperty(e.substring(e.indexOf(":")+1))&&r.push({name:e,title:n[n.length-1]})});r.sort(function(e,t){return e.title<t.title?-1:e.title>t.title?1:0});e.getRenderedHtml(e.CLASS+"-dialog",{layerName:C("query.titleDialog",{layerName:s}),layers:r},function(e){var l=document.createHTMLElement(e);document.body.appendChild(l);(t=l.getElementsByClassName("tc-modal-body")[0]).classList.add("tc-loading");TC.Util.showModal(l,{closeCallback:function(){l.parentElement.removeChild(l)}});if(TC.Util.detectIE()){var s=1;switch(!0){case document.body.clientWidth>768&&document.body.clientWidth<document.body.clientHeight:case document.body.clientWidth>1024:s=.8;case document.body.clientWidth>1140:s=.7}t.style.maxHeight=document.body.clientHeight*s-t.nextElementSibling.clientHeight-t.previousElementSibling.clientHeight}n=l;l.getElementsByClassName("tc-button tc-ctl-wlm-btn-launch")[0].addEventListener("click",function(){N()});i&&i(l)})}(l,s[s.length-1],i,function(e){a(e)})})});Promise.all([l,a,l.getWFSCapabilitiesPromise()]).then(w)}}();
//# sourceMappingURL=../maps/control/WFSQuery.min.js.map