TC.control=TC.control||{};TC.control.MapInfo||TC.syncLoadJS(TC.apiLocation+"TC/control/MapInfo");TC.control.PrintMap=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.PrintMap,TC.control.MapInfo);!function(){var t=TC.control.PrintMap.prototype;t.CLASS="tc-ctl-printMap";const e="portrait",n="landscape",i="A4",r="A3";var a={logoWidth:60,logoHeight:30,layoutPDF:{pageSize:{width:595,height:842},pageMargins:[29.5,14,29.5,22.5],content:[{columns:[{image:null,height:22,margin:[0,0,0,6]},{text:"",width:489,alignment:"center",margin:[0,10,0,0]},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:534,height:775.5}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]},reset:function(){this.layoutPDF.content=[{columns:[{image:null,height:22,margin:[0,0,0,6]},{text:"",width:489,alignment:"center",margin:[0,10,0,0]},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:534,height:775.5}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]}},o={logoWidth:60,logoHeight:30,layoutPDF:{pageSize:{width:842,height:595},pageMargins:[30,14,30,22],content:[{columns:[{image:null,height:22,margin:[0,0,0,6]},{text:"",alignment:"center",margin:[0,10,0,0],width:600},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:780,height:528}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]},reset:function(){this.layoutPDF.content=[{columns:[{image:null,height:22,margin:[0,0,0,6]},{text:"",alignment:"center",margin:[0,10,0,0],width:600},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:780,height:528}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]}},l={logoWidth:60,logoHeight:30,layoutPDF:{pageSize:{width:841.89,height:1190.55},pageMargins:[29.954,14,29.954,21.55],content:[{columns:[{image:null,height:22,width:45,margin:[0,0,0,6]},{text:"",width:489,margin:[0,10,0,0],alignment:"center"},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:780,height:1125}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]},reset:function(){this.layoutPDF.content=[{columns:[{image:null,height:22,width:45,margin:[0,0,0,6]},{text:"",width:489,margin:[0,10,0,0],alignment:"center"},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:780,height:1125}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]}},c={logoWidth:60,logoHeight:30,layoutPDF:{pageSize:{width:1190.55,height:841.89},pageMargins:[28.775,14,28.775,14.89],content:[{columns:[{image:null,height:22,width:45,margin:[0,0,0,6]},{text:"",alignment:"center",margin:[0,10,0,0],width:600},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:1131,height:783}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]},reset:function(){this.layoutPDF.content=[{columns:[{image:null,height:22,width:45,margin:[0,0,0,6]},{text:"",alignment:"center",margin:[0,10,0,0],width:600},{alignment:"right",margin:[0,10,0,0]}]},{table:{widths:["*"],body:[[{image:null,width:1131,height:783}]]},layout:{paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}}}]}};const s=function(t,s){switch(t){case e:switch(s){case i:return a;case r:return l}break;case n:switch(s){case i:return o;case r:return c}break;default:return a}},d=function(t){return t.layoutPDF.content[0].columns[0]},u=function(t){return t.layoutPDF.content[0].columns[2]},g={sideLength:85};t.template={};t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"print"}).w('</h2><div><div class="tc-ctl-printMap-div"><div class="tc-group tc-ctl-printMap-cnt"><label>').h("i18n",e,{},{$key:"title"}).w(':</label><input type="text" class="tc-ctl-printMap-title tc-textbox" maxlength="30" placeholder="').h("i18n",e,{},{$key:"mapTitle"}).w('" /></div><div class="tc-group tc-ctl-printMap-cnt"><label>').h("i18n",e,{},{$key:"layout"}).w(':</label><select id="print-design" class="tc-combo"><option value="landscape">').h("i18n",e,{},{$key:"landscape"}).w('</option><option value="portrait">').h("i18n",e,{},{$key:"portrait"}).w('</option></select></div><div class="tc-group tc-ctl-printMap-cnt"><label>').h("i18n",e,{},{$key:"size"}).w(':</label><select id="print-size" class="tc-combo"><option value="a4">A4</option><option value="a3">A3</option></select></div><div class="tc-group tc-ctl-printMap-cnt tc-ctl-printMap-cnt-btn"><input id="tc-ctl-printMap-image-qr" class="tc-hidden" type="checkbox" checked style="display:none;" /><label for="tc-ctl-printMap-image-qr" class="tc-ctl-printMap-image-qr-label" title="').h("i18n",e,{},{$key:"createQrCodeToImage"}).w('">').h("i18n",e,{},{$key:"appendQRCode"}).w('</label><button class="tc-ctl-printMap-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"printMap"}).w('">').h("i18n",e,{},{$key:"print"}).w('</button></div><div class="tc-group tc-ctl-printMap-cnt"><div class="tc-ctl-printMap-alert tc-alert alert-warning tc-hidden"><p>').h("i18n",e,{},{$key:"qrAdvice|s"}).w("</p></div></div></div></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-view"]=function(){dust.register(t.CLASS+"-view",e);function e(t,e){return t.w('<div class="tc-ctl-printMap-view">    </div>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-tools"]=function(){dust.register(t.CLASS+"-tools",e);function e(t,e){return t.w('<div class="tc-ctl-printMap-tools"><div class="tc-ctl-printMap-btn-pdf" title="').h("i18n",e,{},{$key:"printpdf"}).w('"></div><div class="tc-ctl-printMap-btn-close" title="').h("i18n",e,{},{$key:"close"}).w('"></div></div>    ')}e.__dustBody=!0;return e};const p=function(){return this.map.workLayers.some(function(t){return t.type===TC.Consts.layerType.WMS&&t.getVisibility()})};t.register=function(t){const n=this,i=TC.control.MapInfo.prototype.register.call(n,t);n.map.mustBeExportable=!0;const r=function(){s(n.orientation||e,n.format.toString().toUpperCase()||"A4").reset()};n.div.addEventListener("click",TC.EventTarget.listenerBySelector("."+n.CLASS+"-btn",function(){n.map.setView(TC.Consts.view.PRINTING);var t=document.querySelector("."+n.CLASS+"-qrcode");if(document.querySelector("#"+n.CLASS+"-image-qr").checked){if(!t){(t=document.createElement("div")).classList.add(n.CLASS+"-qrcode");n.map.div.appendChild(t)}t.innerHTML="";n.makeQRCode(t,g.sideLength,g.sideLength)}else t&&(t.innerHTML="");const i="."+n.CLASS+"-btn";n.map.on(TC.Consts.event.STARTLOADING,function(){const t=n.div.querySelector(i);t.classList.add("disabled");t.disabled=!0});n.map.on(TC.Consts.event.STOPLOADING,function(){const t=n.div.querySelector(i);t.classList.remove("disabled");t.disabled=!1});p.call(n)&&n.map.on(TC.Consts.event.ZOOM,r);const a=function(t){if(t){n.map.div.classList.add(t);var e=n.map.div.getBoundingClientRect();Number.isInteger(e.width)||(n.map.div.style.width=Math.round(e.width)+"px");Number.isInteger(e.height)||(n.map.div.style.height=Math.round(e.height)+"px");n.map.toast(n.getLocaleString("print.advice.title")+": "+n.getLocaleString("print.advice.desc"),{type:TC.Consts.msgType.INFO,duration:7e3})}n.map.wrap.map.updateSize()},o=function(){s(n.orientation||e,n.format.toString().toUpperCase()||"A4").reset();p.call(n)&&n.map.off(TC.Consts.event.ZOOM,r);n.map.toastHide(n.getLocaleString("print.advice.title")+": "+n.getLocaleString("print.advice.desc"));n.map.div.classList.remove(n.currentFormat,n.CLASS+"-printing");n.map.div.style.removeProperty("width");n.map.div.style.removeProperty("height");a();n.map.setView(TC.Consts.view.DEFAULT);n._viewDiv.classList.add(TC.Consts.classes.HIDDEN)};if(!n._viewDiv){n._viewDiv=TC.Util.getDiv();document.body.appendChild(n._viewDiv);n.getRenderedHtml(n.CLASS+"-view",null,function(t){n._viewDiv.innerHTML=t});n.getRenderedHtml(n.CLASS+"-tools",null,function(t){n.map.div.insertAdjacentHTML("beforeend",t);n.map.div.querySelector("."+n.CLASS+"-btn-close").addEventListener("click",o);n.map.div.querySelector("."+n.CLASS+"-btn-pdf").addEventListener("click",n.createPdf.bind(n))})}n.orientation=n.div.querySelector("#print-design").value;n.format=n.div.querySelector("#print-size").value;n.currentFormat=n.CLASS+"-"+n.orientation+"-"+n.format;n._viewDiv.classList.remove(TC.Consts.classes.HIDDEN);n.map.div.classList.add(n.CLASS+"-printing");a(n.currentFormat)}));n.div.addEventListener("click",TC.EventTarget.listenerBySelector("#"+n.CLASS+"-image-qr",function(t){n.generateLink()}));n.div.addEventListener("click",TC.EventTarget.listenerBySelector("h2",function(t){n.generateLink();n.registerListeners()}));return i};t.createPdf=function(){var t=this,n=t.map.getControlsByClass(TC.control.LoadingIndicator)[0],i=n.addWait();TC.loadJS(!window.pdfMake,[TC.Consts.url.PDFMAKE],function(){const r=t.map.div.querySelectorAll(".ol-viewport");for(var a=0,o=r.length;a<o;a++){const e=r[a];if(!e.parentElement.classList.contains("ol-overviewmap-map")){t.canvas=e.querySelector("canvas");break}}var l=s(t.orientation||e,t.format.toString().toUpperCase()||"A4"),c=l.layoutPDF;const p=function(e){var r=window.location.host+"_",a=t.div.querySelector("."+t.CLASS+"-title").value.trim();if(a)r+=a;else{r+=TC.Util.getFormattedDate((new Date).toString(),!0)}try{pdfMake.createPdf(e).download(r.replace(/[\\\/:*?"<>\|]/g,"")+".pdf")}catch(e){t.map.toast(t.getLocaleString("print.error"),{type:TC.Consts.msgType.ERROR});TC.error(e.message+"  "+e.stack,TC.Consts.msgErrorMode.EMAIL)}n.removeWait(i)},h=function(e){TC.error(t.getLocaleString("print.error"));TC.error("No se ha podido generar el base64 correspondiente a la imagen: "+e,TC.Consts.msgErrorMode.EMAIL,"Error en la impresi\xf3n")},m=function(){var e=[],n=t.map.workLayers.filter(function(t){return t.type===TC.Consts.layerType.WMS&&t.getVisibility()}),i=[],r=function(t,e,n){if(e.isVisibleByScale(t.name)){var i,r;e.options&&e.options.params&&e.options.params.base64LegendSrc?r=e.options.params.base64LegendSrc:t.legend&&(i=t.legend.src);result.push({src:i,title:t.title,level:n,srcBase64:r})}},a=function(t,e,n,i){if(Array.isArray(t))for(var r=0;r<t.length;r++)a(t[r],e,n,i);else if(t&&t.hasOwnProperty("children")&&t.children.length>0){t.title&&t.name&&result.push({header:t.title,level:i});a(t.children,e,n,++i)}if(t&&t.hasOwnProperty("children")&&0==t.children.length){e.apply(this,[t,n,i]);i--}};n.forEach(function(t){result=[];var e=t.options.hideTree;t.tree=null;t.options.hideTree=!0;a(t.getTree(),r,t,0);t.options.hideTree=e;result.length>0&&i.push({title:t.title,layers:result})});return new Promise(function(t,n){Promise.all(function(){for(var t=[],e=0;e<i.length;e++)for(var n=i[e].layers,r=0;r<n.length;r++)!function(n,r){var a=i[e].layers[r],o=a.src||a.srcBase64;if(o){TC.tool&&TC.tool.Proxification||TC.syncLoadJS(TC.apiLocation+"TC/tool/Proxification");t.push(new Promise(function(t,e){new TC.tool.Proxification(TC.proxify,{allowedMixedContent:!0}).fetchImage(o,{exportable:!0}).then(function(e){if(e.complete){var n=TC.Util.imgTagToDataUrl(e,"image/png");a.image={base64:n.base64,canvas:n.canvas}}else h(o);t()},function(t){h(o);e(t)})}))}}(0,r);return t}()).then(function(){i.map(function(t,e){return{groupIndex:e,height:t.layers.filter(function(t){return t.image&&t.image.canvas}).reduce(function(t,e,n,i){return t+i[n].image.canvas.height},0)}}).sort(function(t,e){return t.height>e.height?1:t.height<e.height?-1:0}).forEach(function(t,n){!function(t,n){var i=[[{text:t.title,colSpan:2,alignment:"left",fontSize:11,margin:[0,n>0?10:0,0,5]},{}]];const r=(i=i.concat(t.layers.filter(function(e){return e.hasOwnProperty("header")&&e.header.trim().toLowerCase()!==t.title.trim().toLowerCase()}).map(function(t){return[{text:t.header.trim(),colSpan:2,alignment:"left",margin:[10*t.level,0,0,3]},{}]}))).length;var a=null,o=null;t.layers.forEach(function(t,e){if(t.header){a=t;o&&(o=null)}else{o||(o=1);var n;a&&(n=i.map(function(t){return t[0].text}).indexOf(a.header)+o++);if(t.image){var r=t.image.canvas.width/2,l=r*t.image.canvas.height/t.image.canvas.width,c=[{text:t.title,fontSize:9,width:"auto",margin:[10*t.level,0,0,2]},{image:t.image.base64,width:r,height:l,margin:[10*t.level,0,0,2]}];n?i.splice(n,0,c):i.push(c)}else{c=[{text:t.title,fontSize:9,colSpan:2,margin:[10*t.level,0,0,2]},{}];n?i.splice(n,0,c):i.push(c)}}});e.push({layout:"noBorders",table:{dontBreakRows:!0,keepWithHeaderRows:1,headerRows:r,body:i}})}(i[t.groupIndex],n)});t(e)},function(){n([])})})},f=[function(){const e=function(){var t=d(l);delete t.image;t.text="";return t};return t.options.logo?TC.Util.imgToDataUrl(t.options.logo,"image/png").then(function(t){const e=t.canvas,n=t.dataUrl;TC.Util.calculateAspectRatioFit(e.width,e.height,l.logoWidth,l.logoHeight);var i=d(l);i.width||(i.width=e.width/e.height*i.height);i.image=n;return i},function(){h(t.options.logo);return e()}):e()},function(){var e=function(t){return t.layoutPDF.content[0].columns[1]}(l);e.text=t.div.querySelector("."+t.CLASS+"-title").value.trim();return e},function(){const e=function(){var t=u(l);delete t.image;t.text="";t.width="auto";return t};var n=t.map.getControlsByClass(TC.control.ScaleBar)[0];if(n){var i=document.getElementsByClassName("ol-scale-line-inner"),r=i[0].getBoundingClientRect();if(r){var a=getComputedStyle(i[0],null),o=parseInt(a.getPropertyValue("border-left-width").replace("px",""))||0,c=parseInt(a.getPropertyValue("border-right-width").replace("px",""))||0,s=u(l);s.table={widths:[.75*((r.width>r.height?r.width:r.height)-o-c)],body:[[{border:[!0,!1,!0,!0],text:n.getText(),fontSize:10,alignment:"center"}]]};s.layout={paddingLeft:function(t,e){return 0},paddingRight:function(t,e){return 0},paddingTop:function(t,e){return 0},paddingBottom:function(t,e){return 0}};return s}return e()}return e()},function(){if(document.querySelector("#"+t.CLASS+"-image-qr").checked){const e=document.querySelector("."+t.CLASS+"-qrcode");e.innerHTML="";return t.makeQRCode(e,g.sideLength,g.sideLength).then(function(e){if(e)return TC.Util.addToCanvas(t.canvas,e,{x:t.canvas.width-g.sideLength,y:t.canvas.height-g.sideLength},{width:g.sideLength,height:g.sideLength}).then(function(t){return t});TC.error(t.getLocaleString("print.qr.error"));return t.canvas})}return t.canvas}];Promise.all(f.map(function(t){return t()})).then(function(e){e[2].table&&(l.layoutPDF.content[0].columns[1].width=l.layoutPDF.pageSize.width-(l.layoutPDF.pageMargins[0]+l.layoutPDF.pageMargins[2])-l.layoutPDF.content[0].columns[0].width-(l.layoutPDF.content[0].columns[2].table.widths[0]+2));var n=function(t){return t.layoutPDF.content[1].table.body[0][0]}(l),i=e[3]||t.canvas;n.image=i.toDataURL();if(t.options.legend&&t.options.legend.visible&&function(){return this.map.workLayers.some(function(t){if(t.type===TC.Consts.layerType.WMS&&t.getVisibility()){for(var e=0;e<t.names.length;e++)if(t.isVisibleByScale(t.names[e]))return!0;return!1}return!1})}.call(t)&&2==c.content.length){const e=t.div.querySelector("."+t.CLASS+"-title").value.trim();c.content.push({pageBreak:"before",pageOrientation:t.options.legend.orientation||"portrait",text:e.length>0?e:"",fontSize:14,margin:[0,20,0,10]});m().then(function(t){c.content=c.content.concat(t);p(c)})}else p(c)})})};t.manageMaxLengthExceed=function(t){const e=this.div.querySelector("."+this.CLASS+"-alert");document.querySelector("#"+this.CLASS+"-image-qr").checked?e.classList.toggle(TC.Consts.classes.HIDDEN,!t.qr):e.classList.add(TC.Consts.classes.HIDDEN)}}();
//# sourceMappingURL=../maps/control/PrintMap.min.js.map