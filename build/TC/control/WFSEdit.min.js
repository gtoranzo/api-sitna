TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");TC.control.WFSEdit=function(){const e=this;TC.control.SWCacheClient.apply(this,arguments);e._classSelector="."+e.CLASS;e.layer=null;e.callback=TC.Util.isFunction(arguments[2])?arguments[2]:e.options.callback?e.options.callback:null;e.layersEditData={};e.showsOriginalFeatures="boolean"==typeof e.options.showOriginalFeatures&&e.options.showOriginalFeatures;e.highlightsAdded=e.highlightsModified=e.highlightsRemoved="boolean"!=typeof e.options.highlightChanges||e.options.highlightChanges;TC.Util.isFunction(e.options.getBeforeEditLayerStyleFunction)||(e.getBeforeEditLayerStyleFunction=e.getBeforeEditLayerStyle);e.styles=e.options.styles||{point:{fillColor:"#0000aa",fillOpacity:.1,strokeColor:"#0000aa",strokeWidth:2,strokeOpacity:1,radius:6},line:{strokeColor:"#0000aa",strokeWidth:2,strokeOpacity:1},polygon:{fillColor:"#0000aa",fillOpacity:.1,strokeColor:"#0000aa",strokeWidth:2,strokeOpacity:1}}};TC.inherit(TC.control.WFSEdit,TC.control.SWCacheClient);!function(){var e=0;const t=function(e){const t=e.getLayerEditData();e._saveBtn.disabled=!(navigator.onLine&&t&&t.checkedOut)||e.isSyncing},r=function(e,t){e.div.querySelector(e._classSelector+"-view").classList.toggle(TC.Consts.classes.HIDDEN,!t||!e.layer||!(e.layer.type===TC.Consts.layerType.WFS||e.layer.type===TC.Consts.layerType.WMS));if(e.layer&&e.layer.wfsLayer){const t=TC.filter&&TC.filter.Bbox&&e.layer.wfsLayer.properties instanceof TC.filter.Bbox;e._recropBtn.classList.toggle(TC.Consts.classes.HIDDEN,!t)}e.div.querySelector(e._classSelector+"-edit").classList.toggle(TC.Consts.classes.HIDDEN,!t)},o=function(e){t(e);const r=e.getLayerEditData();e._discardBtn.disabled=!r||!r.checkedOut},a=function(e,t){if(e.layer){const r=e.getLayerEditData();if(void 0!==t){r.checkedOut=t;o(e)}else TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var t=s(e);localforage.keys().then(function(a){if(a){for(var n=!0,i=0,s=a.length;i<s;i++)if(0===a[i].indexOf(t)){n=!1;break}r.checkedOut=!n;o(e)}})})}else o(e)},n=function(e,t){return new Promise(function(r,o){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var a,n;switch(!0){case t instanceof TC.feature.Polygon:n=TC.Consts.geom.POLYGON;break;case t instanceof TC.feature.Polyline:n=TC.Consts.geom.POLYLINE;break;case t instanceof TC.feature.Point:n=TC.Consts.geom.POINT;break;case t instanceof TC.feature.MultiPolygon:n=TC.Consts.geom.MULTIPOLYGON;break;case t instanceof TC.feature.MultiPolyline:n=TC.Consts.geom.MULTIPOLYLINE}a={id:t.id||t.provId,attributes:t.data,type:n,geometry:t.geometry};localforage.setItem(e,a).then(function(){r({feature:t})}).catch(function(e){o({feature:t,error:e})})})})},i=function(e){return new Promise(function(t,r){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.removeItem(e).then(function(){t(e)}).catch(function(e){r(Error(e))})})})},s=function(e,t){return e.LOCAL_STORAGE_KEY_PREFIX+function(e){let t=e.options.featureType[0];t.indexOf(":")<0&&(t=e.options.featureNS+":"+t);return t+"@"+e.options.url}(t||e.layer.wfsLayer||e.layer)},l=function(e,t){return s(e,t)+e.LOCAL_STORAGE_ADDED_KEY_PREFIX},d=function(e,t){return s(e,t)+e.LOCAL_STORAGE_MODIFIED_KEY_PREFIX},c=function(e,t){return s(e,t)+e.LOCAL_STORAGE_REMOVED_KEY_PREFIX},y=function(e){return e.getPath?e.getPath().join(" \u2022 "):e.title||e.id},u=TC.control.WFSEdit.prototype;u.CLASS="tc-ctl-wfsedit";u.template=function(){dust.register(u.CLASS,e);function e(e,i){return e.w("<h2>").h("i18n",i,{},{$key:"featureEditing"}).w('</h2><div class="tc-ctl-wfsedit-layer"><select class="tc-combo tc-ctl-wfsedit-layer-sel" disabled><option value="">').h("i18n",i,{},{$key:"selectLayerToEdit"}).w("</option>").s(i.get(["layers"],!1),i,{block:t},{}).w('</select></div><div class="tc-ctl-wfsedit-view tc-hidden"><table><tbody><tr><th><img class="tc-ctl-wfsedit-view-watch" /></th><td>').h("i18n",i,{},{$key:"featuresInEditedLayer"}).w('</td></tr><tr><th><img class="tc-ctl-wfsedit-view-original-watch" /></th><td><input type="checkbox" id="tc-ctl-wfsedit-view-original-cb-').f(i.get(["controlId"],!1),i,"h").w('"').x(i.get(["showOriginalFeatures"],!1),i,{block:r},{}).w(' /><label class="tc-ctl-wfsedit-view-original" for="tc-ctl-wfsedit-view-original-cb-').f(i.get(["controlId"],!1),i,"h").w('">').h("i18n",i,{},{$key:"featuresAsBeforeEditing"}).w('</label></td></tr><tr><th><input type="color" id="tc-ctl-wfsedit-view-clr-added-').f(i.get(["controlId"],!1),i,"h").w('" class="tc-clt-wfsedit-view-clr-added" /><label for="tc-ctl-wfsedit-view-clr-added-').f(i.get(["controlId"],!1),i,"h").w('" title="').h("i18n",i,{},{$key:"clickToChangeColor"}).w('"><img class="tc-ctl-wfsedit-view-added-watch" /></label></th><td><input type="checkbox" id="tc-ctl-wfsedit-view-added-cb-').f(i.get(["controlId"],!1),i,"h").w('"').x(i.get(["highlightChanges"],!1),i,{block:o},{}).w(' /><label class="tc-ctl-wfsedit-view-added" for="tc-ctl-wfsedit-view-added-cb-').f(i.get(["controlId"],!1),i,"h").w('">').h("i18n",i,{},{$key:"unsyncedAdded"}).w('</label></td></tr><tr><th><input type="color" id="tc-ctl-wfsedit-view-clr-modified-').f(i.get(["controlId"],!1),i,"h").w('" class="tc-clt-wfsedit-view-clr-modified" /><label for="tc-ctl-wfsedit-view-clr-modified-').f(i.get(["controlId"],!1),i,"h").w('" title="').h("i18n",i,{},{$key:"clickToChangeColor"}).w('"><img class="tc-ctl-wfsedit-view-modified-watch" /></label></th><td><input type="checkbox" id="tc-ctl-wfsedit-view-modified-cb-').f(i.get(["controlId"],!1),i,"h").w('"').x(i.get(["highlightChanges"],!1),i,{block:a},{}).w(' /><label class="tc-ctl-wfsedit-view-modified" for="tc-ctl-wfsedit-view-modified-cb-').f(i.get(["controlId"],!1),i,"h").w('">').h("i18n",i,{},{$key:"unsyncedModified"}).w('</label></td></tr><tr><th><input type="color" id="tc-ctl-wfsedit-view-clr-removed-').f(i.get(["controlId"],!1),i,"h").w('" class="tc-clt-wfsedit-view-clr-removed" /><label for="tc-ctl-wfsedit-view-clr-removed-').f(i.get(["controlId"],!1),i,"h").w('" title="').h("i18n",i,{},{$key:"clickToChangeColor"}).w('"><img class="tc-ctl-wfsedit-view-removed-watch" /></label></th><td><input type="checkbox" id="tc-ctl-wfsedit-view-removed-cb-').f(i.get(["controlId"],!1),i,"h").w('"').x(i.get(["highlightChanges"],!1),i,{block:n},{}).w(' /><label class="tc-ctl-wfsedit-view-removed" for="tc-ctl-wfsedit-view-removed-cb-').f(i.get(["controlId"],!1),i,"h").w('">').h("i18n",i,{},{$key:"unsyncedRemoved"}).w('</label></td></tr></tbody></table><button class="tc-ctl-wfsedit-btn-crop tc-hidden" title="').h("i18n",i,{},{$key:"refreshLayerToCurrentExtent"}).w('">').h("i18n",i,{},{$key:"refreshLayerToCurrentExtent"}).w('</button></div><div class="tc-ctl-wfsedit-edit tc-hidden"></div><div class="tc-ctl-wfsedit-save"><button class="tc-button tc-icon-button tc-ctl-wfsedit-btn-save" disabled title="').h("i18n",i,{},{$key:" syncChanges"}).w('">').h("i18n",i,{},{$key:"syncChanges"}).w('</button><button class="tc-button tc-icon-button tc-ctl-wfsedit-btn-discard" disabled title="').h("i18n",i,{},{$key:" discardChanges"}).w('">').h("i18n",i,{},{$key:"discardChanges"}).w("</button></div>")}e.__dustBody=!0;function t(e,t){return e.w('<option value="').f(t.get(["id"],!1),t,"h").w('">').f(t.get(["title"],!1),t,"h").w("</option>")}t.__dustBody=!0;function r(e,t){return e.w(" checked")}r.__dustBody=!0;function o(e,t){return e.w(" checked")}o.__dustBody=!0;function a(e,t){return e.w(" checked")}a.__dustBody=!0;function n(e,t){return e.w(" checked")}n.__dustBody=!0;return e};u.LOCAL_STORAGE_KEY_PREFIX="TC.offline.edit.";u.LOCAL_STORAGE_ADDED_KEY_PREFIX=".added.";u.LOCAL_STORAGE_MODIFIED_KEY_PREFIX=".modified.";u.LOCAL_STORAGE_REMOVED_KEY_PREFIX=".removed.";u.register=function(e){const r=this;return new Promise(function(o,i){TC.control.SWCacheClient.prototype.register.call(r,e).then(function(){window.addEventListener("online",function(){t(r)});window.addEventListener("offline",function(){t(r)});r._editPromise=e.addControl("edit",{id:r.getUID(),div:r.div.querySelector(`.${r.CLASS}-edit`),styles:r.styles,downloadElevation:r.options.downloadElevation,snapping:r.options.snapping});r._editPromise.then(function(t){r.editControl=t;r.editControl.getAvailableFeaturesToImport=function(){const t=Object.getPrototypeOf(r.editControl).getAvailableFeaturesToImport.call(r.editControl),o=r.getLayerEditData();return t.filter(t=>{const r=e.getLayer(t.id);return r!==o.addedFeaturesLayer&&r!==o.modifiedFeaturesLayer&&r!==o.removedFeaturesLayer&&r!==o.beforeEditLayer})};r.editControl.importFeatures=function(e){const t=e||this.featuresToImport||[],o=r.getLayerEditData(),a=o.attributes?t.map(function(e){const t={};for(let r in o.attributes)t[r]=e.data[r];return new e.constructor(e.geometry,{geometryName:o.geometryName,data:t})}):e;Object.getPrototypeOf(r.editControl).importFeatures.call(r.editControl,a)};r.editControl.on(TC.Consts.event.DRAWEND,function(e){r.getLayerEditData().serializable&&r._storeFeatureAdd(e.feature)}).on(TC.Consts.event.FEATUREMODIFY,function(e){const t=e.feature,o=t.provId||t.id,i=function(){a(r,!0)},s=function(){TC.error(r.getLocaleString("failedWhenSavingModifyOperationInSession"))},c=r.getLayerEditData();if(c.serializable){let e=c.addedFeaturesLayer.getFeatureById(o);if(e){e.setCoords(t.geometry);e.setData(t.getData());n(l(r)+o,t).then(i,s)}else{if(e=c.modifiedFeaturesLayer.getFeatureById(o)){e.setCoords(t.geometry);e.setData(t.getData())}else c.modifiedFeaturesLayer.addFeature(r._createAuxFeature(t));n(d(r)+o,t).then(i,s)}}}).on(TC.Consts.event.FEATUREADD,function(e){r.getLayerEditData().serializable&&r._storeFeatureAdd(e.feature)}).on(TC.Consts.event.FEATUREREMOVE,function(e){r.getLayerEditData().serializable&&r._storeFeatureRemove(e.feature)});e.workLayers.forEach(e=>r.addLayer(e));e.on(TC.Consts.event.LAYERUPDATE,function(e){const t=e.layer;t.type!==TC.Consts.layerType.WFS||t.options.readOnly||r.getEditableLayer(t).then(e=>r.cacheLayer(e))}).on(TC.Consts.event.ZOOM,function(t){e.workLayers.filter(e=>e.wfsLayer).filter(e=>r.layer!==e).forEach(function(e){e.wfsLayer=null;r.getEditableLayer(e)})}).on(TC.Consts.event.LAYERADD,function(e){r.addLayer(e.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){const t=e.layer;if(r._removingLayer===t)return;(r.layer===t||t.wmsLayer&&r.layer===t.wmsLayer)&&r.setLayer(null);const o=r._layerSelect.querySelector(`option[value="${t.id}"]`);o&&o.parentElement.removeChild(o)}).on(TC.Consts.event.LAYERERROR,function(t){const o=t.layer;if(o.type===TC.Consts.layerType.WFS&&!o.options.readOnly){t.reason===TC.Consts.WFSErrors.MAX_NUM_FEATURES&&e.toast(r.getLocaleString("query.msgTooManyResults",{limit:t.data.limit}),{type:TC.Consts.msgType.WARNING});if(r.layer===o||r.layer&&r.layer.wfsLayer===o){delete r.layersEditData[r.layer.id];r.setLayer(null)}if(o.wmsLayer){e.removeLayer(o);o.wmsLayer.wfsLayer=null}}});o(r)});e.loaded(function(){r._layerSelect.disabled=!1;if(r.options.layer)r.setLayer(r.options.layer);else{const t=e.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WFS&&!e.options.stealth});1===t.length?r.setLayer(t[0].id):r.setLayer(null)}r.showOriginalFeatures(r.showsOriginalFeatures)});e.ready(function(){e.getControlsByClass("TC.control.WorkLayerManager").forEach(function(t){t.addLayerTool({renderFn:function(t,o){const a=r.CLASS+"-btn-edit";let n=t.querySelector("button."+a);if(!n){const i=r.getLocaleString("featureEditing");(n=document.createElement("button")).innerHTML=i;n.setAttribute("title",i);n.classList.add(a);n.dataset.layerId=o;t.appendChild(n);const s=e.getLayer(o);if(s.type===TC.Consts.layerType.WMS){n.classList.add(TC.Consts.classes.LOADING);s.getWFSCapabilities().catch(()=>n.classList.add(TC.Consts.classes.HIDDEN)).finally(()=>n.classList.remove(TC.Consts.classes.LOADING))}}return n},updateEvents:[TC.Consts.event.BEFORELAYERUPDATE,TC.Consts.event.LAYERUPDATE,TC.Consts.event.LAYERERROR,TC.Consts.event.CONTROLACTIVATE,TC.Consts.event.CONTROLDEACTIVATE],updateFn:function(t){const o=this,a=e.getLayer(o.dataset.layerId);setTimeout(()=>{o.classList.toggle(TC.Consts.classes.ACTIVE,r.layer===a)},500);o.disabled=!a||a.isRaster()&&1!==a.names.length},actionFn:function(){const t=e.getLayer(this.dataset.layerId),o=r.layer;this.classList.remove(TC.Consts.classes.ACTIVE);(t.names&&1===t.names.length||!t.isRaster())&&(t&&o!==t?r.setLayer(t).then(()=>{r.openEditSession()}):r.setLayer(null))}})})})})})};u.render=function(e){const t=this;var o=[];if(t.map)for(var a=0,n=t.map.workLayers.length;a<n;a++){var i=t.map.workLayers[a];i.type!==TC.Consts.layerType.WFS||i.options.stealth||o.push({id:i.id,title:i.title||i.id})}return t._set1stRenderPromise(TC.Control.prototype.renderData.call(t,{layers:o,showOriginalFeatures:t.showsOriginalFeatures,highlightChanges:t.highlightsAdded||t.highlightsModified||t.highlightsRemoved,controlId:t.id},function(){t._layerDiv=t.div.querySelector(t._classSelector+"-layer");t._layerSelect=t._layerDiv.querySelector(t._classSelector+"-layer-sel");t._layerSelect.addEventListener("change",function(e){r(t,!1);t.getEditableLayer(t._layerSelect.value).then(function(e){t.setLayer(e.wmsLayer||e).then(function(){t.layer&&t.openEditSession()})}).catch(()=>{t.setLayer(null)})});const o=t.div.querySelector(t._classSelector+"-view");t._editingWatch=o.querySelector(`.${t.CLASS}-view-watch`);t._beforeEditLayerWatch=o.querySelector(`.${t.CLASS}-view-original-watch`);t._addedWatch=o.querySelector(`.${t.CLASS}-view-added-watch`);t._modifiedWatch=o.querySelector(`.${t.CLASS}-view-modified-watch`);t._removedWatch=o.querySelector(`.${t.CLASS}-view-removed-watch`);o.querySelector(`#${t.CLASS}-view-original-cb-${t.id}`).addEventListener("change",function(e){t.showOriginalFeatures(e.target.checked)});o.querySelector(`#${t.CLASS}-view-added-cb-${t.id}`).addEventListener("change",function(e){t.highlightAdded(e.target.checked)});o.querySelector(`#${t.CLASS}-view-modified-cb-${t.id}`).addEventListener("change",function(e){t.highlightModified(e.target.checked)});o.querySelector(`#${t.CLASS}-view-removed-cb-${t.id}`).addEventListener("change",function(e){t.highlightRemoved(e.target.checked)});const a=new RegExp(`${t.CLASS}-view-clr-(.+)-${t.id}`),n=function(e){const r=this.parentElement.querySelector("input[type=color]"),o=t.getLayerEditData(),n=o[r.id.match(a)[1]+"FeaturesLayer"];switch(o.geometryType){case TC.Consts.geom.POINT:r.value=n.styles.point.strokeColor;break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:r.value=n.styles.line.strokeColor;break;default:r.value=n.styles.polygon.strokeColor}r.click()},i=function(e){const r=e.target,o=t.getLayerEditData(),n=r.id.match(a)[1],i=o[n+"FeaturesLayer"],s=o[n+"CustomColor"]=r.value;switch(o.geometryType){case TC.Consts.geom.POINT:i.styles.point.strokeColor=s;break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:i.styles.line.strokeColor=s;break;default:i.styles.polygon.strokeColor=s;i.styles.polygon.fillColor=s}i.setStyles(i.styles);t[`_${n}Watch`].src=f(i,o.geometryType)},s=`${t.CLASS}-view-clr-added-${t.id}`;o.querySelector(`label[for="${s}"]`).addEventListener(TC.Consts.event.CLICK,n);document.getElementById(s).addEventListener("change",i);const l=`${t.CLASS}-view-clr-modified-${t.id}`;o.querySelector(`label[for="${l}"]`).addEventListener(TC.Consts.event.CLICK,n);document.getElementById(l).addEventListener("change",i);const d=`${t.CLASS}-view-clr-removed-${t.id}`;o.querySelector(`label[for="${d}"]`).addEventListener(TC.Consts.event.CLICK,n);document.getElementById(d).addEventListener("change",i);t._saveBtn=t.div.querySelector(t._classSelector+"-btn-save");t._saveBtn.addEventListener(TC.Consts.event.CLICK,function(){TC.confirm(t.getLocaleString("edit.applyEdits.confirm",{layerTitle:y(t.layer)}),function(){t.applyEdits()})});t._discardBtn=t.div.querySelector(t._classSelector+"-btn-discard");t._discardBtn.addEventListener(TC.Consts.event.CLICK,function(){TC.confirm(t.getLocaleString("edit.discardEdits.confirm",{layerTitle:y(t.layer)}),function(){t.discardEdits()})});t._recropBtn=t.div.querySelector(`.${t.CLASS}-view button.${t.CLASS}-btn-crop`);t._recropBtn.addEventListener(TC.Consts.event.CLICK,function(){if(t.layer){const e=()=>{if(t.layer&&t.layer.wfsLayer&&TC.filter&&TC.filter.Bbox&&t.layer.wfsLayer.properties instanceof TC.filter.Bbox){const e=t.getLayerEditData();t.layer.wfsLayer.properties=new TC.filter.Bbox(null,t.map.getExtent(),t.map.getCRS());t.layer.wfsLayer.refresh();if(e.beforeEditLayer){e.beforeEditLayer.properties=t.layer.wfsLayer.properties;e.beforeEditLayer.refresh()}}},r=t.getLayerEditData(),o=r.addedFeaturesLayer.features.concat(r.modifiedFeaturesLayer.features,r.removedFeaturesLayer.features);o.length?TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry",function(){let r=!1;const a=t.map.getExtent(),n=[[a[0],a[1]],[a[0],a[3]],[a[2],a[3]],[a[2],a[1]]];for(var i=0,s=o.length;i<s;i++)if(!TC.Geometry.intersects(o[i].geometry,n)){r=!0;break}r?TC.confirm(t.getLocaleString("refreshLayerToCurrentExtent.confirm"),function(){e()}):e()}):e()}});TC.Util.isFunction(e)&&e()}))};u.addLayer=function(e){const t=this;e.isBase||e.options.readOnly||e.options.stealth||t.getEditableLayer(e).then(function(r){!e.isRaster()&&r.wmsLayer||function(e){const r=document.createElement("option");r.setAttribute("value",e.id);r.innerHTML=y(e);t.renderPromise().then(function(){t._layerSelect.appendChild(r)})}(e)}).catch(t=>console.log(`Layer ${e.id} not editable. Reason: ${t.message}`))};u.setLayer=function(e){const t=this;return new Promise(function(o,a){const n=t.map,i=t.div.querySelector(t._classSelector+"-layer-sel");e=n.getLayer(e);const s=n.workLayers.filter(t=>t===e)[0],l=function(){if(s)t.getEditableLayer(s).then(function(e){const r=function(){t.layer=s;t._enableEditSerialization(s).then(function(){t.getEditControl().then(r=>{i.value=t.layer.id;r.setMode(null);r.setLayer(e);o(t.layer)})}).catch(e=>{t.setLayer(null);a(e)})};n.workLayers.indexOf(e)>=0?r():n.addLayer(e).then(r)}).catch(()=>{t.setLayer(null);o(null)});else{t.layer&&t.layer.wfsLayer&&(t._removingLayer=t.layer.wfsLayer);t.getEditControl().then(e=>{r(t,!1);t.closeEditSession().then(()=>{i.value="";e.setMode(null);e.setLayer(null);t.layer=null;o(null)}).finally(()=>{delete t._removingLayer})})}};if(null!==e&&t.layer){t.layer.wfsLayer&&(t._removingLayer=t.layer.wfsLayer);t.closeEditSession().then(()=>{s&&l()})}else l()})};u._storeFeatureAdd=function(t){const r=this;t.provId="NewFeature."+e++;const o=r.getLayerEditData(),i=r._createAuxFeature(t);o.addedFeaturesLayer.addFeature(i);n(l(r)+t.provId,i).then(function(){a(r,!0)},function(){TC.error(r.getLocaleString("failedWhenSavingAddOperationInSession"))})};u._storeFeatureRemove=function(e){const t=this;var r=e.provId||e.id,o=function(){a(t)},s=function(){TC.error(t.getLocaleString("failedWhenSavingRemoveOperationInSession"))};const y=t.getLayerEditData();if(y.serializable){let a=y.addedFeaturesLayer.getFeatureById(r);if(a){y.addedFeaturesLayer.removeFeature(a);i(l(t)+r).then(o,s)}else{var u=c(t);if(a=y.modifiedFeaturesLayer.getFeatureById(r)){y.modifiedFeaturesLayer.removeFeature(a);y.removedFeaturesLayer.addFeature(t._createAuxFeature(e));i(d(t)+r).then(function(){o();n(u+r,e).then(o,s)},s)}else if(!(a=y.removedFeaturesLayer.getFeatureById(r))){y.removedFeaturesLayer.addFeature(t._createAuxFeature(e));n(u+r,e).then(o,s)}}}};u._createAuxFeature=function(e){const t=e.provId||e.id,r=this.getLayerEditData(),o=new e.constructor(e.geometry,{geometryName:r.geometryName,data:e.getData()});o.setStyle(null);o.setId(t);return o};u.getEditControl=function(){const e=this;return e._editPromise||new Promise(function(t,r){e.renderPromise().then(()=>t(e.editControl))})};u.cacheLayer=function(e){const t=this;return new Promise(function(r,o){t.getServiceWorker().then(function(){if(navigator.onLine){const a=e.wrap.getGetFeatureUrl(),n=e.getDescribeFeatureTypeUrl();a&&n?t.createCache(s(t,e),{urlList:[a,n]}).then(()=>r(),e=>o(e)):r()}else r()}).catch(e=>o(e))})};u.getFeatureType=function(e){const t=this;return new Promise(function(r,o){e=e||t.layer;const a=map.getLoadingIndicator(),n=a&&a.addWait();e.describeFeatureType().then(function(o){t.getEditControl().then(function(a){const n=t.getLayerEditData(e);n.attributes={};for(var i in o){const e=o[i],t=a.getGeometryType(e.type);if(t){n.geometryName=e.name;n.geometryType="boolean"==typeof t?null:t}else n.attributes[i]=e}for(var i in n.attributes){const e=n.attributes[i];e.type=e.type.substr(e.type.indexOf(":")+1)}r(n)})}).catch(function(e){o(e)}).finally(()=>a&&a.removeWait(n))})};u._addAuxLayersToMap=function(e){const t=this;return new Promise(function(r,o){e=e||t.layer;const a=t.getLayerEditData(e),n=a.beforeEditLayer;if(n){const o=a.addedFeaturesLayer,i=a.modifiedFeaturesLayer,s=a.removedFeaturesLayer;Promise.all([map.addLayer(n),map.addLayer(o),map.addLayer(i),map.addLayer(s)]).then(function(){t.getEditableLayer(e).then(function(e){let l=map.layers.indexOf(e);n.setVisibility(t.showsOriginalFeatures);o.setVisibility(t.highlightsAdded);i.setVisibility(t.highlightsModified);s.setVisibility(t.highlightsRemoved);t.map.insertLayer(n,++l,function(){const d=l+1;map.insertLayer(o,d);map.insertLayer(i,d);map.insertLayer(s,d);n.setStyles(t.getBeforeEditLayerStyle(e));o.setStyles(t.getAddedFeaturesLayerStyle(e));i.setStyles(t.getModifiedFeaturesLayerStyle(e));s.setStyles(t.getRemovedFeaturesLayerStyle(e));t._editingWatch.src=f(e,a.geometryType);t._beforeEditLayerWatch.src=f(n,a.geometryType);t._addedWatch.src=f(o,a.geometryType);t._modifiedWatch.src=f(i,a.geometryType);t._removedWatch.src=f(s,a.geometryType);r()})})})}else o(new Error(`No auxiliary layers for ${e.id}`))})};u.openEditSession=function(){const e=this;return e.layer?new Promise(function(t,o){e.getFeatureType().then(function(n){e.getEditControl().then(function(i){e.getEditableLayer(e.layer).then(function(s){i.setLayer(s);switch(n.geometryType){case TC.Consts.geom.MULTIPOLYLINE:case TC.Consts.geom.MULTIPOLYGON:i.setComplexGeometry(!0);break;default:i.setComplexGeometry(!1)}i.activate();r(e,!0);a(e);const l=[TC.control.Edit.mode.MODIFY,TC.control.Edit.mode.OTHER];switch(n.geometryType){case TC.Consts.geom.POINT:l.push(TC.control.Edit.mode.ADDPOINT);break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:l.push(TC.control.Edit.mode.ADDLINE);break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:l.push(TC.control.Edit.mode.ADDPOLYGON)}i.constrainModes(l);i.setMode(TC.control.Edit.mode.MODIFY);e._addAuxLayersToMap().then(()=>t()).catch(e=>o(e))})})}).catch(function(a){e.layer&&e.layer.type===TC.Consts.layerType.VECTOR?e.getEditControl().then(function(o){o.activate();r(e,!0);o.setMode(TC.control.Edit.mode.MODIFY);t()}):o(a)})}):Promise.reject(Error("No layer set for editing"))};u.closeEditSession=function(){const e=this;return new Promise(function(t,r){e.renderPromise().then(function(){a(e,!1);e.getEditControl().then(e=>e.deactivate());const r=e.getLayerEditData();if(r&&r.beforeEditLayer){e._editingWatch.src=TC.Consts.BLANK_IMAGE;e._beforeEditLayerWatch.src=TC.Consts.BLANK_IMAGE;e._addedWatch.src=TC.Consts.BLANK_IMAGE;e._modifiedWatch.src=TC.Consts.BLANK_IMAGE;e._removedWatch.src=TC.Consts.BLANK_IMAGE;const o=e.layer;e.getEditableLayer(e.layer).then(function(e){const a=[],n=function(e){map.workLayers.indexOf(e)>=0&&a.push(map.removeLayer(e))};n(r.beforeEditLayer);n(r.beforeEditLayer);n(r.addedFeaturesLayer);n(r.modifiedFeaturesLayer);n(r.removedFeaturesLayer);if(o!==e){o.wfsLayer=null;n(e)}Promise.all(a).then(()=>t())})}else t()})})};u.getEditableLayer=function(e){const t=this;return new Promise(function(r,o){const a=`Layer ${e.id} not editable`;(e=t.map?map.getLayer(e):e)?e.type!==TC.Consts.layerType.WFS||!e.wmsLayer&&(e.options.stealth||e.options.readOnly)?e.type===TC.Consts.layerType.WMS?e.wfsLayer?e.wfsLayer.getCapabilitiesPromise().then(()=>r(e.wfsLayer)):e.getWFSCapabilities().then(function(n){const i=e.getDisgregatedLayerNames(),s=i[0],l=s.indexOf(":"),d=s.substring(l+1);1!==i.length||n.FeatureTypes.hasOwnProperty(d)?TC.loadJS(!TC.layer.Vector,TC.apiLocation+"TC/layer/Vector",function(){const o={id:t.getUID(),type:TC.Consts.layerType.WFS,url:e.options.url.replace(/wms/gi,"wfs"),properties:t.map?new TC.filter.Bbox(null,map.getExtent(),map.getCRS()):null,outputFormat:TC.Consts.format.JSON,title:`${e.getPath().join(" \u2022 ")} - ${t.getLocaleString("featureEditing")}`,geometryName:"geom",featureType:[s],featureNS:"Edicion",styles:t.styles,stealth:!0};e.wfsLayer=new TC.layer.Vector(o);e.wfsLayer.wmsLayer=e;r(e.wfsLayer)}):o(new Error(a))}).catch(e=>o(e)):e.type===TC.Consts.layerType.VECTOR?r(e):o(new Error(a)):e.getCapabilitiesPromise().then(()=>r(e)):o(new Error("No layer to edit"))})};u.isLayerEdited=function(e){const t=this;return new Promise(function(r,o){const a=s(t,e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(e){r(!!e&&e.some(e=>0===e.indexOf(a)))})})})};u.getLayerEditData=function(e){const t=e||this.layer;return t?this.layersEditData[t.id]=this.layersEditData[t.id]||{checkedOut:!1}:null};const f=function(e,t){switch(t){case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:return TC.Util.getLegendImageFromStyle(e.styles.point,{geometryType:TC.Consts.geom.POINT});case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:return TC.Util.getLegendImageFromStyle(e.styles.line,{geometryType:TC.Consts.geom.POLYLINE});default:return TC.Util.getLegendImageFromStyle(e.styles.polygon,{geometryType:TC.Consts.geom.POLYGON})}};u._enableEditSerialization=function(t){const r=this;return new Promise(function(o,a){r.getEditableLayer(t).then(function(a){const n=function(){const n=r.getLayerEditData(t),i=t.getPath?t.getPath().join(" \u2022 "):t.title||t.id;var y=n.beforeEditLayer;y||(y=n.beforeEditLayer=new TC.layer.Vector(TC.Util.extend({},a.options,{id:r.getUID(),title:`${i} - ${r.getLocaleString("dataBeforeEdits")}`,readOnly:!0,owner:r,stealth:!0})));var u=n.addedFeaturesLayer;let f=!0;if(!u){f=!1;u=n.addedFeaturesLayer=new TC.layer.Vector({id:r.getUID(),title:`${i} - ${r.getLocaleString("addedFeatures")}`,owner:r,stealth:!0,zIndex:2})}var g=n.modifiedFeaturesLayer;let C=!0;if(!g){C=!1;g=n.modifiedFeaturesLayer=new TC.layer.Vector({id:r.getUID(),title:`${i} - ${r.getLocaleString("modifiedFeatures")}`,owner:r,stealth:!0,zIndex:2})}var h=n.removedFeaturesLayer;let L=!0;if(!h){L=!1;h=n.removedFeaturesLayer=new TC.layer.Vector({id:r.getUID(),title:`${i} - ${r.getLocaleString("removedFeatures")}`,owner:r,stealth:!0,zIndex:2})}const m=[];if(f&&C&&L){h.features.forEach(function(e){const t=a.getFeatureById(e.id);t&&a.removeFeature(t)});g.features.forEach(function(e){const t=a.getFeatureById(e.id);if(t){t.setCoords(e.geometry);t.setData(e.getData())}});u.features.forEach(function(e){a.getFeatureById(e.id)||m.push(a.addFeature(r._createAuxFeature(e)))});Promise.all(m).then(()=>{n.serializable=!0;o(a)})}else{const t=s(r,a),i=l(r,a),y=d(r,a),f=c(r,a);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(r){r&&r.filter(e=>0===e.indexOf(t)).forEach(function(t){m.push(new Promise(function(r,o){(function(e){return new Promise(function(t,r){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(e).then(function(r){t({key:e,feature:r})}).catch(function(e){r(e)})})})})(t).then(function(t){var o,n=t.key;if(0===n.indexOf(f)){o=n.substr(f.length);const e=a.getFeatureById(o);a.removeFeature(e);h.addFeature(e).then(()=>r(e))}else if(0===n.indexOf(y)){o=n.substr(y.length);const e=a.getFeatureById(o);if(e){e.setCoords(t.feature.geometry);e.setData(t.feature.attributes);const o=e.clone();o.setId(e.id);g.addFeature(o).then(()=>r(e))}else r(e)}else if(0===n.indexOf(i)){o=n.substr(i.length);var s,l=parseInt(o.substr(o.lastIndexOf(".")+1));e=Math.max(e,l+1);switch(t.feature.type){case TC.Consts.geom.POINT:s=a.addPoint(t.feature.geometry);break;case TC.Consts.geom.POLYLINE:s=a.addPolyline(t.feature.geometry);break;case TC.Consts.geom.POLYGON:s=a.addPolygon(t.feature.geometry);break;case TC.Consts.geom.MULTIPOLYLINE:s=a.addMultiPolyline(t.feature.geometry);break;case TC.Consts.geom.MULTIPOLYGON:s=a.addMultiPolygon(t.feature.geometry)}s.then(function(e){e.provId=o;e.setData(t.feature.attributes);const a=e.clone();a.setStyle(null);a.setId(e.provId);u.addFeature(a).then(()=>r(a))})}})}))});Promise.all(m).then(()=>{n.serializable=!0;o(a)})})})}};if(a.type===TC.Consts.layerType.WFS)if(a.state===TC.Layer.state.IDLE)n();else{const e=function(t){if(t.layer===a){n();r.map.off(TC.Consts.event.LAYERUPDATE,e)}};r.map.on(TC.Consts.event.LAYERUPDATE,e)}else o(a)})})};u.applyEdits=function(){const e=this;if(e.layer){const r=e.getLayerEditData();if(r.serializable){e.isSyncing=!0;t(e);const o=e.map.getLoadingIndicator(),a=o&&o.addWait(),n=r.modifiedFeaturesLayer.features.map(function(e){const t=new e.constructor(e.geometry,{geometryName:r.geometryName}),o=r.beforeEditLayer.features.filter(t=>t.id===e.id)[0];let a;if(o){a={};for(var n in e.data)if("id"!==n){const t=o.data[n],r=e.data[n];t!==r&&(a[n]=r)}}else a=e.data;t.setData(a);t.setId(e.id);return t});e.getEditableLayer(e.layer).then(function(i){i.applyEdits(r.addedFeaturesLayer.features,n,r.removedFeaturesLayer.features).then(function(t){if(t.transactionSummary.totalInserted!==r.addedFeaturesLayer.features.length||t.transactionSummary.totalUpdated!==n.length||t.transactionSummary.totalDeleted!==r.removedFeaturesLayer.features.length){TC.error("Error de concordancia de n\xfamero de entidades en transacci\xf3n");console.log(t,r.addedFeaturesLayer,n,r.removedFeaturesLayer);throw new Error(`Error en transacci\xf3n: Insertados ${t.transactionSummary.totalInserted}, hay ${r.addedFeaturesLayer.features.length} en capa`)}e.layer.type===TC.Consts.layerType.WMS&&e.layer.refresh();e.deleteCache(s(e)).then(function(){e.cacheLayer(i).then(function(){e.isSyncing=!1;o&&o.removeWait(a);e.discardEdits();e.map.toast(e.getLocaleString("changesSuccessfullySyncedWithServer"),{type:TC.Consts.msgType.INFO})})})}).catch(function(r){e.isSyncing=!1;t(e);TC.error(e.getLocaleString("errorSyncingChanges",{code:r.code,reason:r.reason}),{type:TC.Consts.msgType.ERROR})})})}}};u.discardEdits=function(){var e=this;e._joinedFeatureAttributes=[];var t=s(e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(r){if(r){for(var o=0,n=r.length;o<n;o++){var i=r[o];0===i.indexOf(t)&&localforage.removeItem(i)}if(e.layer){const t=e.getLayerEditData();if(t.serializable){t.addedFeaturesLayer.clearFeatures();t.modifiedFeaturesLayer.clearFeatures();t.removedFeaturesLayer.clearFeatures();e.editControl.setSelectedFeatures([]);e.editControl.modifyControl.closeAttributes();e.getEditableLayer(e.layer).then(e=>e.refresh())}}a(e,!1)}});e.editControl.setMode(null)})};u.showOriginalFeatures=function(e){this.showsOriginalFeatures=e;const t=this.getLayerEditData();t&&t.beforeEditLayer.setVisibility(e)};u.highlightAdded=function(e){this.highlightsAdded=e;const t=this.getLayerEditData();t&&t.addedFeaturesLayer&&t.addedFeaturesLayer.setVisibility(e)};u.highlightModified=function(e){this.highlightsModified=e;const t=this.getLayerEditData();t&&t.modifiedFeaturesLayer&&t.modifiedFeaturesLayer.setVisibility(e)};u.highlightRemoved=function(e){this.highlightsRemoved=e;const t=this.getLayerEditData();t&&t.removedFeaturesLayer&&t.removedFeaturesLayer.setVisibility(e)};const g=function(e,t){const r={};switch(e.getLayerEditData(t.wmsLayer||t).geometryType){case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:r.polygon=t.map.options.styles.polygon;break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:r.line=t.map.options.styles.line;break;default:r.point=t.map.options.styles.point}return r};u.getBeforeEditLayerStyle=function(e){const t=function(t){const r=e.wrap.getRGBA(t);for(var o=0;o<3;o++)r[o]=255-r[o];return"#"+(65536*r[0]+256*r[1]+r[2]).toString(16).padStart(6,"0")},r=[1,3],o=TC.Util.extend(!0,{},e.options.styles||g(this,e));if(o.point){o.point.strokeColor=t(o.point.strokeColor);o.point.lineDash=r}if(o.line){o.line.strokeColor=t(o.line.strokeColor);o.line.lineDash=r}if(o.polygon){o.polygon.strokeColor=t(o.polygon.strokeColor);o.polygon.lineDash=r}return o};const C=function(e,t,r){const o=TC.Util.extend(!0,{},t.options.styles||g(e,t));if(o.point){o.point.strokeColor=r;o.point.fillColor=r}o.line&&(o.line.strokeColor=r);if(o.polygon){o.polygon.strokeColor=r;o.polygon.fillColor=r}return o};u.getAddedFeaturesLayerStyle=function(e){const t=this.getLayerEditData(e.wmsLayer||e);return C(this,e,t.addedCustomColor||"#00ff00")};u.getModifiedFeaturesLayerStyle=function(e){const t=this.getLayerEditData(e.wmsLayer||e);return C(this,e,t.modifiedCustomColor||"#ff7f00")};u.getRemovedFeaturesLayerStyle=function(e){const t=this.getLayerEditData(e.wmsLayer||e);return C(this,e,t.removedCustomColor||"#ff0000")}}();
//# sourceMappingURL=../maps/control/WFSEdit.min.js.map