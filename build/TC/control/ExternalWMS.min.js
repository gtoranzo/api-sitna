TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.ExternalWMS=function(e){if(TC.isLegacy)console.warn("El control ExternalWMS no soporta modo legacy");else{this.count=0;this._addedUrls=[];TC.Control.apply(this,arguments);this.allowReprojection="boolean"!=typeof this.options.allowReprojection||this.options.allowReprojection}};TC.inherit(TC.control.ExternalWMS,TC.Control);!function(){var e=TC.control.ExternalWMS.prototype;e.CLASS="tc-ctl-xwms";e.markServicesAsSelected=function(e){if(e.length>0){const t=e[0];t.disabled=!0;t.classList.add("tc-ctl-xwms-option-selected")}};e.register=function(e){if(TC.isLegacy){console.warn("El control ExternalWMS no soporta modo legacy");return}const t=this,r=TC.Control.prototype.register.call(t,e);t.div.addEventListener("change",TC.EventTarget.listenerBySelector("select",function(e){if(""!==e.target.value){var r=e.target.value;0===r.indexOf("//")&&(r=location.protocol+r);t.div.querySelector("input").value=r;e.target.value=""}}));t.div.addEventListener("click",TC.EventTarget.listenerBySelector('button[name="agregar"]',function(e){var r=t.div.querySelector("input").value.trim();if(r)if(/^((https?|ftp):)?(\/\/)?(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(r))if(t._addedUrls.some(function(e){return e.replace(/https?:\/\/|\/\//,"")===r.replace(/https?:\/\/|\/\//,"")}))TC.alert(t.getLocaleString("serviceAlreadyAdded"));else{var o=t.map.getControlsByClass("TC.control.LoadingIndicator")[0];o.show();var n=TC.Util.getQueryStringParams(r);/https?:\/\/|\/\//i.test(r)||(r="//"+r);var i=["version","service","request"],a=function(e,t){for(var r=0;r<t.length;r++)e=TC.Util.removeURLParameter(e,t[r]);e.match(/\?$/)&&(e=e.substr(0,e.length-1));return e}(r,Object.keys(n));for(var l in n)i.indexOf(l.toLowerCase())>=0&&delete n[l];const e=t.div.querySelector("button");e.disabled=!0;for(var u={id:"xwms"+ ++t.count,type:"WMS",url:a,hideTree:!1,queryParams:n},s=0;s<t.options.suggestions.length;s++){var d=$.grep(t.options.suggestions[s].items,function(e,t){return e.url===r});if(d.length>0&&d[0].layerNames){u.layerNames=d[0].layerNames;break}}var c=new TC.layer.Raster(u);c.getCapabilitiesPromise().then(function(n){if(void 0!==n.Capability){var i=n.Capability.Layer;if(i.CRS&&-1==i.CRS.indexOf(t.map.crs)&&!t.allowReprojection){TC.alert(t.getLocaleString("serviceSrsNotCompatible"));o.hide();e.disabled=!1;return}t.map.trigger(TC.Consts.event.EXTERNALSERVICEADDED,{layer:c});t.div.querySelector("input").value="";const a=[];t.div.querySelectorAll("select option").forEach(function(e){e.value.replace(/https?:\/\/|\/\//,"")===r.replace(/https?:\/\/|\/\//,"")&&a.push(e)});t.markServicesAsSelected(a);t._addedUrls.push(r);o.hide();e.disabled=!1}else{TC.alert(t.getLocaleString("noLayersFoundInService"));o.hide();e.disabled=!1}},function(r){TC.alert(t.getLocaleString("serviceCouldNotBeLoaded")+":\n"+r);o.hide();e.disabled=!1})}else TC.alert(t.getLocaleString("typeAValidAddress"));else TC.alert(t.getLocaleString("typeAnAddress"))}));e.on(TC.Consts.event.LAYERADD,function(e){const r=e.layer;if(r&&!r.isBase){var o=r.url;if(o){t.pending_markServicesAsSelected=t.pending_markServicesAsSelected||[];0===t.div.querySelectorAll("select option").length&&o&&-1===t.pending_markServicesAsSelected.indexOf(o)&&t.pending_markServicesAsSelected.push(o);const e=[];t.div.querySelectorAll("select option").forEach(function(t){t.value.replace(/https?:\/\/|\/\//,"")===o.replace(/https?:\/\/|\/\//,"")&&e.push(t)});t.markServicesAsSelected(e);t._addedUrls.push(o)}}});return r};e.template={};TC.isDebug?e.template[e.CLASS]=TC.apiLocation+"TC/templates/ExternalWMS.html":e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.x(t.get(["title"],!1),t,{block:r},{}).w('<div><div class="tc-group tc-ctl-xwms-cnt"> <select id="add-wms-select" class="tc-combo" title="WMS (Web Map Service)"><option value="">WMS</option>').s(t.get(["suggestions"],!1),t,{block:o},{}).w('</select><input type="url" class="tc-textbox" placeholder="').h("i18n",t,{},{$key:"writeAddressOrSelect"}).w('" /></div><div class="tc-group tc-group tc-ctl-xwms-cnt" style="text-align:right;"><button type="button" class="tc-button tc-icon-button" title="').h("i18n",t,{},{$key:"addService.title"}).w('" name="agregar">').h("i18n",t,{},{$key:"addService"}).w("</button></div></div>")}t.__dustBody=!0;function r(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"addMaps"}).w("</h2>")}r.__dustBody=!0;function o(e,t){return e.x(t.get(["group"],!1),t,{block:n},{}).s(t.get(["items"],!1),t,{block:i},{}).x(t.get(["group"],!1),t,{block:a},{})}o.__dustBody=!0;function n(e,t){return e.w('<optgroup label="').f(t.get(["group"],!1),t,"h").w('">')}n.__dustBody=!0;function i(e,t){return e.w('<option value="').f(t.get(["url"],!1),t,"h").w('">').f(t.get(["name"],!1),t,"h").w("</option>")}i.__dustBody=!0;function a(e,t){return e.w("\t</optgroup>")}a.__dustBody=!0;return t};e.render=function(e){const t=this;return t._set1stRenderPromise(t.renderData(t.options,function(){t.pending_markServicesAsSelected=t.pending_markServicesAsSelected||[];t.pending_markServicesAsSelected.forEach(function(e){const r=[];t.div.querySelectorAll("select option").forEach(function(t){TC.Util.addProtocol(t.value)===TC.Util.addProtocol(e)&&r.push(t)});t.markServicesAsSelected(r);t._addedUrls.push(e)});t.pending_markServicesAsSelected=[]}))}}();
//# sourceMappingURL=../maps/Control/ExternalWMS.min.js.map
