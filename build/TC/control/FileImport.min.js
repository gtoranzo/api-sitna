TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.FileImport=function(){TC.Control.apply(this,arguments);$.isArray(this.options.formats)?this.formats=this.options.formats:this.formats=[TC.Consts.format.KML,TC.Consts.format.GML,TC.Consts.format.GML2,TC.Consts.format.GEOJSON,TC.Consts.format.WKT,TC.Consts.format.GPX];this.layers=[];this.apiAttribution="";this.mainDataAttribution="";this.dataAttributions=[];this.exportsState=!0};TC.inherit(TC.control.FileImport,TC.Control);!function(){var t=TC.control.FileImport.prototype;t.CLASS="tc-ctl-file";TC.isDebug?t.template=TC.apiLocation+"TC/templates/FileImport.html":t.template=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"openFile"}).w("</h2><div><p>").h("i18n",e,{},{$key:"fileImport.instructions"}).w('</p><div class="tc-ctl-file-open"><label class="tc-button tc-ctl-file-open-label tc-icon-button"><input type="file" class="tc-ctl-file-open-ipt tc-button" accept="').s(e.get(["formats"],!1),e,{block:n},{}).w('" />').h("i18n",e,{},{$key:"openFile"}).w("</label></div></div>")}e.__dustBody=!0;function n(t,e){return t.w(".").f(e.getPath(!0,[]),e,"h").h("sep",e,{block:o},{})}n.__dustBody=!0;function o(t,e){return t.w(",")}o.__dustBody=!0;return e};t.register=function(t){var e=this;const n=TC.Control.prototype.register.call(e,t);e.options.enableDragAndDrop&&t.wrap.enableDragAndDrop(e.options);t.on(TC.Consts.event.FEATURESIMPORT,function(n){const o=n.fileName,r=n.dropTarget,a=n.features;var s="."+TC.Consts.format.GPX.toLowerCase();o.toLowerCase().indexOf(s)===o.length-s.length||r!==e.map.div&&r!==e||t.addLayer({id:e.getUID(),title:o,type:TC.Consts.layerType.VECTOR}).then(function(n){e.layers.push(n);const o=function(t,e){return t.concat(e)};for(var r=function(t){var n=t.geometry;if(n){var r;switch(!0){case TC.feature.Point&&t instanceof TC.feature.Point:r=[n];break;case TC.feature.MultiPoint&&t instanceof TC.feature.MultiPoint:case TC.feature.Polyline&&t instanceof TC.feature.Polyline:r=n;break;case TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline:case TC.feature.Polygon&&t instanceof TC.feature.Polygon:r=n.reduce(o);break;case TC.feature.MultiPolygon&&t instanceof TC.feature.MultiPolygon:r=n.reduce(o).reduce(o)}r.every(function(t){return Math.abs(t[0])<=180&&Math.abs(t[1])<=90})&&t.setCoords(TC.Util.reproject(n,"EPSG:4326",e.map.crs))}return t},s=0,i=a.length;s<i;s++){var l=r(a[s]);n.addFeature(l)}setTimeout(function(){t.zoomToFeatures(n.features)},100)})}).on(TC.Consts.event.FEATURESIMPORTERROR,function(t){var n,o=t.file.name;n=".kmz"===o.toLowerCase().substr(o.length-4)?"fileImport.error.reasonKmz":"fileImport.error.reasonUnknown";TC.error(e.getLocaleString(n,{fileName:o}),TC.Consts.msgErrorMode.TOAST);var r=new FileReader;r.onload=function(t){TC.error("Nombre del archivo: "+o+" \n Contenido del archivo: \n\n"+t.target.result,TC.Consts.msgErrorMode.EMAIL,"Error en la subida de un archivo")};r.readAsText(t.file)}).on(TC.Consts.event.FEATUREREMOVE,function(t){const n=t.layer;e.layers.indexOf(n)>=0&&(n.features.length||e.map.removeLayer(n))}).on(TC.Consts.event.LAYERREMOVE,function(t){const n=e.layers.indexOf(t.layer);n>=0&&e.layers.splice(n,1)});return n};t.render=function(){const t=this;return t._set1stRenderPromise(t.renderData({formats:t.formats},function(){const e=t.div.querySelector("input[type=file]");e.addEventListener(TC.Consts.event.CLICK,function(t){const e=document.createElement("form"),n=this.parentElement;n.insertBefore(e,this);e.appendChild(this);e.reset();e.insertAdjacentElement("afterend",this);n.removeChild(e)});e.addEventListener("change",function(e){if(t.map){console.log("salta el change");t.map.wrap.loadFiles(e.target.files,{control:t})}})}))};t.exportState=function(){const t=this;return t.exportsState?{id:t.id,layers:t.layers.map(function(t){return{title:t.title,state:t.exportState()}})}:null};t.importState=function(t){const e=this;if(e.map){const n=[];t.layers.forEach(function(t){n.push(e.map.addLayer({id:e.getUID(),title:t.title,type:TC.Consts.layerType.VECTOR}))});Promise.all(n).then(function(n){for(var o=0,r=n.length;o<r;o++){const r=n[o];r.importState(t.layers[o].state);e.layers.push(r)}})}}}();
//# sourceMappingURL=../maps/Control/FileImport.min.js.map
