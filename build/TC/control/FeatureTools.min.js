TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.POPUP=TC.Consts.event.POPUP||"popup.tc";TC.Consts.event.POPUPHIDE=TC.Consts.event.POPUPHIDE||"popuphide.tc";TC.Consts.event.DRAWCHART=TC.Consts.event.DRAWCHART||"drawchart.tc";TC.Consts.event.DRAWTABLE=TC.Consts.event.DRAWTABLE||"drawtable.tc";TC.control.FeatureTools=function(){const t=this;TC.Control.apply(t,arguments);const e=t._classSelector="."+t.CLASS;t._selectors={ELEVATION_CHECKBOX:e+"-dialog-elev input[type=checkbox]",INTERPOLATION_RADIO:"input[type=radio][name=finfo-ip-coords]",INTERPOLATION_DISTANCE:e+"-dialog-ip-m"};t.options.displayElevation&&TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){const e="boolean"==typeof t.options.displayElevation?{}:t.options.displayElevation;t.elevation=new TC.tool.Elevation(e)});t._dialogDiv=TC.Util.getDiv(t.options.dialogDiv);window.$&&(t._$dialogDiv=$(t._dialogDiv));t.options.dialogDiv||document.body.appendChild(t._dialogDiv)};TC.inherit(TC.control.FeatureTools,TC.Control);!function(){var t=TC.control.FeatureTools.prototype;t.CLASS="tc-ctl-ftools";t.TITLE_SEPARATOR=" \u2022 ";t.FILE_TITLE_SEPARATOR="__";t.template={};t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w('<div class="tc-ctl-ftools"><button class="tc-ctl-ftools-dl-btn" title="').h("i18n",e,{},{$key:"downloadFeature"}).w('">').h("i18n",e,{},{$key:"download"}).w('</button><button class="tc-ctl-ftools-share-btn" title="').h("i18n",e,{},{$key:"shareFeature"}).w('">').h("i18n",e,{},{$key:"share"}).w('</button><button class="tc-ctl-ftools-zoom-btn" title="').h("i18n",e,{},{$key:"zoomToFeature"}).w('">').h("i18n",e,{},{$key:"zoomToFeature"}).w('</button><button class="tc-ctl-ftools-del-btn" title="').h("i18n",e,{},{$key:"deleteFeature"}).w('">').h("i18n",e,{},{$key:"deleteFeature"}).w("</button></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-ftools-dialog tc-ctl-ftools-share-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"feature"}).w(" - ").h("i18n",e,{},{$key:"share"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-ftools-share-dialog-ctl"></div></div></div></div>')}e.__dustBody=!0;return e};var e=null;t.register=function(t){const e=this;t.on(TC.Consts.event.POPUP+" "+TC.Consts.event.DRAWTABLE+" "+TC.Consts.event.DRAWCHART,function(t){e.currentDisplay=t.control;if(e.currentDisplay.caller||!e.currentDisplay.caller&&e.currentDisplay.currentFeature){e.highlightedFeature=e.currentDisplay.caller||!e.currentDisplay.currentFeature?e.currentDisplay.caller.highlightedFeature:e.currentDisplay.currentFeature;e.addUI(e.currentDisplay)}}).on(TC.Consts.event.POPUPHIDE+" "+TC.Consts.event.RESULTSPANELCLOSE,function(t){e.currentDisplay=null}).on(TC.Consts.event.FEATUREADD,function(t){const o=t.feature;e.currentDisplay&&e.currentDisplay.caller&&o===e.currentDisplay.caller.highlightedFeature&&(e.highlightedFeature=o)});return new Promise(function(o,n){Promise.all([TC.Control.prototype.register.call(e,t),e.renderPromise()]).then(function(){e.map.addControl("share",{id:e.getUID(),div:e._dialogDiv.querySelector(".tc-modal-body ."+e.CLASS+"-share-dialog-ctl"),includeControls:!1}).then(function(t){e._shareCtl=t;o(e)}).catch(function(t){n(t instanceof Error?t:Error(t))})})})};t.render=function(){const t=this;return t._set1stRenderPromise(t.getRenderedHtml(t.CLASS+"-dialog",{checkboxId:t.getUID(),elevation:t.options.displayElevation},function(o){t._dialogDiv.innerHTML=o;e||t.map.addControl("FeatureDownloadDialog").then(t=>{e=t})}))};t.addUI=function(t){const e=this,o=t.getMenuElement(),n=function(){return o&&!o.querySelector("."+e.CLASS)};n()?e.getRenderedHtml(e.CLASS,null,function(r){if(n()){const n=(new DOMParser).parseFromString(r,"text/html").body.firstChild;o.appendChild(n);e.updateUI(t);if(!e.map.options.stateful){const t=n.querySelector("."+e.CLASS+"-share-btn");t.parentElement.removeChild(t)}e._setToolButtonHandlers(n);const i=t.getContainerElement();e._decorateDisplay(i);TC.loadJS(!TC.control.Print,[TC.apiLocation+"TC/control/Print"],function(){var t="";if(!i.querySelectorAll("."+TC.control.Print.prototype.CLASS+"-btn").length&&e.highlightedFeature){t=e.highlightedFeature.id;!0===e.highlightedFeature.showsPopup&&new TC.control.Print({target:o,printableElement:i,title:t})}})}}):e.updateUI(t)};t._decorateDisplay=function(t){const e=this;if(e.highlightedFeature){const o=t.querySelector("table.tc-attr");if(o){o.addEventListener(TC.Consts.event.CLICK,function(t){e.zoomToCurrentFeature()});o.querySelectorAll("a, table label, table input").forEach(function(t){t.addEventListener(TC.Consts.event.CLICK,function(t){t.stopPropagation()})});o.classList.add(e.CLASS+"-zoom");o.setAttribute("title",e.getLocaleString("clickToCenter"))}}};t.updateUI=function(t){const e=this,o=t.getMenuElement().querySelector("."+e.CLASS);o.classList.remove(TC.Consts.classes.ACTIVE);clearTimeout(e._uiUpdateTimeout);e._uiUpdateTimeout=setTimeout(function(){const t=e.getCurrentFeature();o.classList.toggle(TC.Consts.classes.ACTIVE,!t||!t.layer.owner||t.layer.owner.filterLayer!==t.layer)},100)};t._setToolButtonHandlers=function(t){const e=this;t.querySelector("."+e.CLASS+"-dl-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.showDownloadDialog()});e.map.options.stateful&&t.querySelector("."+e.CLASS+"-share-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.showShareDialog()});t.querySelector("."+e.CLASS+"-zoom-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.zoomToCurrentFeature()});t.querySelector("."+e.CLASS+"-del-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.removeCurrentFeature()})};t.showDownloadDialog=function(){const t=this.getCurrentFeature();var o={title:this.getLocaleString("feature")+" - "+this.getLocaleString("download"),fileName:this._getFeatureFilename(t)};o=!0!==this.options.displayElevation?Object.assign({},o,{elevation:Object.assign({},this.map.elevation&&this.map.elevation.options,this.options.displayElevation)}):Object.assign({},o,{elevation:this.map.elevation&&this.map.elevation.options});(TC.feature.MultiPolygon&&t instanceof TC.feature.MultiPolygon||TC.feature.Polygon&&t instanceof TC.feature.Polygon)&&(o=Object.assign({},o,{excludedFormats:["GPX"]}));e.open(t,o)};t.showShareDialog=function(){const t=this;TC.Util.showModal(t._dialogDiv.querySelector("."+t.CLASS+"-share-dialog"),{openCallback:function(){t.onShowShareDialog()},closeCallback:function(){t._shareCtl.featureToShare=null}})};t.getCurrentFeature=function(){return this.currentDisplay&&(this.currentDisplay.caller&&this.currentDisplay.caller.highlightedFeature||this.currentDisplay.currentFeature)};t.zoomToCurrentFeature=function(){const t=this;t.map&&t.map.zoomToFeatures([t.getCurrentFeature()],{animate:!0})};t.removeCurrentFeature=function(){const t=this,e=t.getCurrentFeature(),o=function(){t.highlightedFeature=null;e&&e.layer&&e.layer.removeFeature(e)},n=function(){t.currentDisplay&&(t.currentDisplay.close?t.currentDisplay.close():t.currentDisplay.hide())};if(e&&e.layer.owner&&e.layer===e.layer.owner.resultsLayer){o();n()}else TC.confirm(t.getLocaleString("deleteFeature.confirm"),function(){o();n()})};t.onShowShareDialog=function(){const t=this._shareCtl;t.extraParams=null;(function(t,e){e=e||{};return new Promise(function(o,n){const r=t.getCurrentFeature();if(r){const l=r.clone();l.setId(r.id);l.layer=r.layer;if(e.elevation){var i=!0;!e.elevation.resolution&&l.getGeometryStride()>2&&(i=!1);if(i){const r={crs:t.map.crs,features:[l],maxCoordQuantity:t.options.displayElevation&&t.options.displayElevation.maxCoordQuantity,resolution:e.elevation.resolution,sampleNumber:0};t.elevation.setGeometry(r).then(function(t){o(t[0])},function(t){n(t instanceof Error?t:Error(t))})}else o(l)}else{const t=l.getCoordsArray(),e=t[0];if(e&&e.length>2){t.forEach(function(t){t.length=2});l.setCoords(l.geometry)}o(l)}}else o(null)})})(this).then(function(e){t.featureToShare=e;const o=t.div,n=t.generateLink();o.querySelector(".tc-url input[type=text]").value=n;o.querySelector(".tc-iframe input[type=text]").value=t.generateIframe(n)})};t.getFeatureTitle=function(t){var e="";t&&(e=t.id);return e};t._getFeatureFilename=function(t){return(this.getFeatureTitle(t).toString().replace(new RegExp(this.TITLE_SEPARATOR,"g"),this.FILE_TITLE_SEPARATOR)||this.getLocaleString("feature")).toLowerCase().replace(/\s/gi,"_")+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)}}();
//# sourceMappingURL=../maps/control/FeatureTools.min.js.map