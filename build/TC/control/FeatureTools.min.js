TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.POPUP=TC.Consts.event.POPUP||"popup.tc";TC.Consts.event.POPUPHIDE=TC.Consts.event.POPUPHIDE||"popuphide.tc";TC.Consts.event.DRAWCHART=TC.Consts.event.DRAWCHART||"drawchart.tc";TC.Consts.event.DRAWTABLE=TC.Consts.event.DRAWTABLE||"drawtable.tc";TC.control.FeatureTools=function(){const t=this;TC.Control.apply(t,arguments);t.layer=null;t.exportsState=!0;const e=t._classSelector="."+t.CLASS;t._selectors={ELEVATION_CHECKBOX:e+"-dialog-elev input[type=checkbox]",INTERPOLATION_RADIO:"input[type=radio][name=finfo-ip-coords]",INTERPOLATION_DISTANCE:e+"-dialog-ip-m"};t.options.displayElevation&&TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){const e="boolean"==typeof t.options.displayElevation?{}:t.options.displayElevation;t.elevation=new TC.tool.Elevation(e)});t._dialogDiv=TC.Util.getDiv(t.options.dialogDiv);t._$dialogDiv=$(t._dialogDiv);t.options.dialogDiv||document.body.appendChild(t._dialogDiv)};TC.inherit(TC.control.FeatureTools,TC.Control);!function(){var t=TC.control.FeatureTools.prototype;t.CLASS="tc-ctl-ftools";t.TITLE_SEPARATOR=" \u2022 ";t.FILE_TITLE_SEPARATOR="__";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/FeatureTools.html";t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/FeatureToolsDialog.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w('<div class="tc-ctl-ftools"><button class="tc-ctl-ftools-dl-btn" title="').h("i18n",e,{},{$key:"download"}).w('">').h("i18n",e,{},{$key:"download"}).w('</button><button class="tc-ctl-ftools-share-btn" title="').h("i18n",e,{},{$key:"share"}).w('">').h("i18n",e,{},{$key:"share"}).w('</button><button class="tc-ctl-ftools-zoom-btn" title="').h("i18n",e,{},{$key:"zoomToFeature"}).w('">').h("i18n",e,{},{$key:"zoomToFeature"}).w('</button><button class="tc-ctl-ftools-del-btn" title="').h("i18n",e,{},{$key:"deleteFeature"}).w('">').h("i18n",e,{},{$key:"deleteFeature"}).w("</button></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-ftools-dialog tc-ctl-ftools-dl-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"feature"}).w(" - ").h("i18n",e,{},{$key:"download"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body">').s(e.get(["elevation"],!1),e,{block:o},{}).w('<div class="tc-ctl-ftools-dialog-dl"><div><button class="tc-button tc-btn-dl tc-ctl-ftools-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-btn-dl tc-ctl-ftools-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-btn-dl tc-ctl-ftools-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-btn-dl tc-ctl-ftools-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button><button class="tc-button tc-btn-dl tc-ctl-ftools-dl-btn-gpx" data-format="GPX" title="GPX">GPX</button></div></div></div></div></div><div class="tc-ctl-ftools-dialog tc-ctl-ftools-share-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"feature"}).w(" - ").h("i18n",e,{},{$key:"share"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-ftools-share-dialog-ctl"></div></div></div></div>')}e.__dustBody=!0;function o(t,e){return t.w('<div class="tc-ctl-ftools-dialog-elev"><input id="').f(e.get(["checkboxId"],!1),e,"h").w('" type="checkbox"><label for="').f(e.get(["checkboxId"],!1),e,"h").w('" class="tc-ctl-ftools-dialog-elev-label">').h("i18n",e,{},{$key:"includeElevations"}).w("</label></div>").x(e.get(["resolution"],!1),e,{block:n},{})}o.__dustBody=!0;function n(t,e){return t.w('<div class="tc-ctl-ftools-dialog-ip tc-hidden"><h4>').h("i18n",e,{},{$key:"interpolateCoordsFromElevProfile"}).w('</h4><label><input type="radio" name="finfo-ip-coords" value="0" checked /><span>').h("i18n",e,{},{$key:"no"}).w('</span></label><label><input type="radio" name="finfo-ip-coords" value="1"/><span>').h("i18n",e,{},{$key:"yes"}).w('</span></label><div class="tc-ctl-ftools-dialog-ip-m tc-hidden">').h("i18n",e,{},{$key:"interpolateEveryXMeters.1"}).w('<input type="number" min="1" step="1" class="tc-textbox" value="').f(e.get(["resolution"],!1),e,"h").w('" />').h("i18n",e,{},{$key:"interpolateEveryXMeters.2"}).w("</div></div>")}n.__dustBody=!0;return e}}t.register=function(t){const e=this;t.on(TC.Consts.event.POPUP+" "+TC.Consts.event.DRAWTABLE+" "+TC.Consts.event.DRAWCHART,function(t){e.currentDisplay=t.control;if(e.currentDisplay.caller||!e.currentDisplay.caller&&e.currentDisplay.currentFeature){e.highlightedFeature=e.currentDisplay.caller||!e.currentDisplay.currentFeature?e.currentDisplay.caller.highlightedFeature:e.currentDisplay.currentFeature;e.highlightedFeature&&(e.highlightedFeature.showsPopup=!0);e.addUI(e.currentDisplay)}}).on(TC.Consts.event.POPUPHIDE+" "+TC.Consts.event.RESULTSPANELCLOSE,function(t){e.currentDisplay=null}).on(TC.Consts.event.FEATUREADD,function(t){const o=t.feature;if(e.currentDisplay&&e.currentDisplay.caller&&o===e.currentDisplay.caller.highlightedFeature){e.highlightedFeature=o;e.highlightedFeature.showsPopup=!0}}).on(TC.Consts.event.FEATUREREMOVE,function(o){const n=o.feature;if(n===e.highlightedFeature){const o=n.clone();o.showsPopup=!0;t.getControlsByClass("TC.control.Popup").concat(t.getControlsByClass("TC.control.ResultsPanel")).forEach(function(t){t.currentFeature===e.highlightedFeature&&(t.currentFeature=o)});e.getHighlightLayer().then(function(t){t.addFeature(o)})}});return new Promise(function(o,n){Promise.all([TC.Control.prototype.register.call(e,t),e.renderPromise()]).then(function(){e.map.addControl("share",{id:e.getUID(),div:e._dialogDiv.querySelector(".tc-modal-body ."+e.CLASS+"-share-dialog-ctl"),includeControls:!1}).then(function(t){e._shareCtl=t;o(e)}).catch(function(t){n(t instanceof Error?t:Error(t))})})})};t.render=function(t){const o=this;return o._set1stRenderPromise(o.getRenderedHtml(o.CLASS+"-dialog",{checkboxId:o.getUID(),elevation:o.options.displayElevation},function(n){o._dialogDiv.innerHTML=n;o._dialogDiv.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector("button[data-format]",function(t){TC.Util.closeModal();const n=o.map.getLoadingIndicator(),l=n&&n.addWait(),i={};if(o._dialogDiv.querySelector(o._selectors.ELEVATION_CHECKBOX)&&o._dialogDiv.querySelector(o._selectors.ELEVATION_CHECKBOX).checked){const t="1"===o._dialogDiv.querySelector(o._selectors.INTERPOLATION_RADIO+":checked").value;i.elevation={resolution:t?parseFloat(o._dialogDiv.querySelector(o._selectors.INTERPOLATION_DISTANCE+" input[type=number]").value)||o.options.displayElevation.resolution:0}}e(o,i).then(function(e){o.map.exportFeatures([e],{fileName:o._getFeatureFilename(e),format:t.target.dataset.format})},function(t){t!==TC.tool.Elevation.errors.MAX_COORD_QUANTITY_EXCEEDED?TC.error(o.getLocaleString("elevation.error")):TC.alert(o.getLocaleString("tooManyCoordinatesForElevation.warning"))}).finally(function(){n&&n.removeWait(l)})}));o._dialogDiv.addEventListener("change",TC.EventTarget.listenerBySelector(o._selectors.ELEVATION_CHECKBOX,function(t){o.showDownloadDialog()}));o._dialogDiv.addEventListener("change",TC.EventTarget.listenerBySelector(o._selectors.INTERPOLATION_RADIO,function(t){const e=o._dialogDiv.querySelector(o._selectors.INTERPOLATION_DISTANCE);"0"===t.target.value?e.classList.add(TC.Consts.classes.HIDDEN):e.classList.remove(TC.Consts.classes.HIDDEN)}));o.trigger(TC.Consts.event.CONTROLRENDER);$.isFunction(t)&&t()}))};t.addUI=function(t){const e=this,o=t.getMenuElement(),n=function(){return o&&!o.querySelector("."+e.CLASS)};n()?e.getRenderedHtml(e.CLASS,null,function(l){if(n()){const n=(new DOMParser).parseFromString(l,"text/html").body.firstChild;o.appendChild(n);e.updateUI(t);if(!e.map.options.stateful){const t=n.querySelector("."+e.CLASS+"-share-btn");t.parentElement.removeChild(t)}e._setToolButtonHandlers(n);e._decorateDisplay(t.getContainerElement())}}):e.updateUI(t)};t._decorateDisplay=function(t){const e=this;if(e.highlightedFeature){if(t.querySelector("table.tc-attr")){t.querySelector("table.tc-attr").addEventListener(TC.Consts.event.CLICK,function(t){e.zoomToCurrentFeature()});t.querySelector("table.tc-attr").classList.add(e.CLASS+"-zoom");t.querySelector("table.tc-attr").setAttribute("title",e.getLocaleString("clickToCenter"))}TC.loadJS(!TC.control.Print,[TC.apiLocation+"TC/control/Print"],function(){var o="";if(e.highlightedFeature){o=e.highlightedFeature.id;!0===e.highlightedFeature.showsPopup&&new TC.control.Print({target:t,title:o})}})}};t.updateUI=function(t){const e=this,o=t.getMenuElement().querySelector("."+e.CLASS);o.classList.remove(TC.Consts.classes.ACTIVE);clearTimeout(e._uiUpdateTimeout);e._uiUpdateTimeout=setTimeout(function(){const t=e.getCurrentFeature();t&&t.showsPopup?o.classList.add(TC.Consts.classes.ACTIVE):o.classList.remove(TC.Consts.classes.ACTIVE)},100)};t._setToolButtonHandlers=function(t){const e=this;t.querySelector("."+e.CLASS+"-dl-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.showDownloadDialog()});e.map.options.stateful&&t.querySelector("."+e.CLASS+"-share-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.showShareDialog()});t.querySelector("."+e.CLASS+"-zoom-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.zoomToCurrentFeature()});t.querySelector("."+e.CLASS+"-del-btn").addEventListener(TC.Consts.event.CLICK,function(t){e.removeCurrentFeature()})};t.getHighlightLayer=function(){const t=this;return new Promise(function(e,o){t.layer?e(t.layer):t.map.addLayer({id:t.getUID(),title:t.CLASS+": Highlighted features layer",type:TC.Consts.layerType.VECTOR,stealth:!0}).then(function(o){t.layer||(t.layer=o);e(t.layer)})})};t.showDownloadDialog=function(){const t=this,e=t._dialogDiv.querySelector("."+t.CLASS+"-dialog"),o=t.getCurrentFeature(),n=(TC.feature.Point&&o instanceof TC.feature.Point||TC.feature.MultiPoint&&TC.feature.MultiPoint,TC.feature.Polyline&&o instanceof TC.feature.Polyline||TC.feature.MultiPolyline&&o instanceof TC.feature.MultiPolyline),l=TC.feature.Polygon&&o instanceof TC.feature.Polygon||TC.feature.MultiPolygon&&o instanceof TC.feature.MultiPolygon,i=e.querySelector("."+t.CLASS+"-dialog-ip");i&&(t._dialogDiv.querySelector(t._selectors.ELEVATION_CHECKBOX)&&!t._dialogDiv.querySelector(t._selectors.ELEVATION_CHECKBOX).checked||!n&&!l?i.classList.add(TC.Consts.classes.HIDDEN):i.classList.remove(TC.Consts.classes.HIDDEN));const a=e.querySelector("button[data-format=GPX]");l?a.classList.add(TC.Consts.classes.HIDDEN):a.classList.remove(TC.Consts.classes.HIDDEN);TC.Util.showModal(t._dialogDiv.querySelector("."+t.CLASS+"-dl-dialog"))};t.showShareDialog=function(){const t=this;TC.Util.showModal(t._dialogDiv.querySelector("."+t.CLASS+"-share-dialog"),{openCallback:function(){t.onShowShareDialog()},closeCallback:function(){t._shareCtl.featureToShare=null}})};t.getCurrentFeature=function(){return this.currentDisplay&&(this.currentDisplay.caller&&this.currentDisplay.caller.highlightedFeature||this.currentDisplay.currentFeature)};t.zoomToCurrentFeature=function(){const t=this;t.map&&t.map.zoomToFeatures([t.getCurrentFeature()],{animate:!0})};t.removeCurrentFeature=function(){const t=this,e=t.getCurrentFeature(),o=function(){t.highlightedFeature=null;e&&e.layer&&e.layer.removeFeature(e)},n=function(){t.currentDisplay&&(t.currentDisplay.close?t.currentDisplay.close():t.currentDisplay.hide())};if(t.currentDisplay&&t.currentDisplay.caller&&t.currentDisplay.caller.highlightedFeature===e||e.layer===t.layer){o();n()}else TC.confirm(t.getLocaleString("deleteFeature.confirm"),function(){o();n()})};const e=function(t,e){e=e||{};return new Promise(function(o,n){const l=t.getCurrentFeature();if(l){const a=l.clone();a.setId(l.id);a.layer=l.layer;if(e.elevation){var i=!0;!e.elevation.resolution&&a.getGeometryStride()>2&&(i=!1);if(i){const l={crs:t.map.crs,features:[a],maxCoordQuantity:t.options.displayElevation&&t.options.displayElevation.maxCoordQuantity,resolution:e.elevation.resolution,sampleNumber:0};t.elevation.setGeometry(l).then(function(t){o(t[0])},function(t){n(Error(t))})}else o(a)}else{const t=a.getCoordsArray(),e=t[0];if(e&&e.length>2){t.forEach(function(t){t.length=2});a.setCoords(a.geometry)}o(a)}}else o(null)})};t.onShowShareDialog=function(){const t=this._shareCtl;t.extraParams=null;e(this).then(function(e){t.featureToShare=e;const o=t.div,n=t.generateLink();o.querySelector(".tc-url input[type=text]").value=n;o.querySelector(".tc-iframe input[type=text]").value=t.generateIframe(n)})};t.getFeatureTitle=function(t){var e="";t&&(e=t.id);return e};t._getFeatureFilename=function(t){return(this.getFeatureTitle(t).toString().replace(new RegExp(this.TITLE_SEPARATOR,"g"),this.FILE_TITLE_SEPARATOR)||this.getLocaleString("feature")).toLowerCase().replace(/\s/gi,"_")+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)};t.exportState=function(){const t=this;return t.exportsState&&t.layer?{id:t.id,layer:t.layer.exportState()}:null};t.importState=function(t){const e=this;t.layer&&e.getHighlightLayer().then(function(e){e.importState(t.layer)})}}();
//# sourceMappingURL=../maps/Control/FeatureTools.min.js.map
