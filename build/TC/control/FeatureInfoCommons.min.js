TC.control=TC.control||{};TC.control.Click||TC.syncLoadJS(TC.apiLocation+"TC/control/Click");TC.Consts.event.POPUP=TC.Consts.event.POPUP||"popup.tc";TC.Consts.event.POPUPHIDE=TC.Consts.event.POPUPHIDE||"popuphide.tc";TC.Consts.event.DRAWCHART=TC.Consts.event.DRAWCHART||"drawchart.tc";TC.Consts.event.DRAWTABLE=TC.Consts.event.DRAWTABLE||"drawtable.tc";TC.Consts.event.RESULTSPANELCLOSE=TC.Consts.event.RESULTSPANELCLOSE||"resultspanelclose.tc";TC.control.FeatureInfoCommons=function(){TC.control.Click.apply(this,arguments);const t=this._classSelector="."+this.CLASS;this._selectors={LIST_ITEM:"ul"+t+"-features li"};this.resultsLayer=null;this.filterLayer=null;this._layersPromise=null;this.filterFeature=null;this.info=null;this._infoHistory={};this.popup=null;this.resultsPanel=null;this.lastFeatureCount=null;this.exportsState=!0};TC.control.FeatureInfoCommons.displayMode={POPUP:"popup",RESULTS_PANEL:"resultsPanel"};!function(){TC.inherit(TC.control.FeatureInfoCommons,TC.control.Click);var t=TC.control.FeatureInfoCommons.prototype;t.CLASS="tc-ctl-finfo";t.TITLE_SEPARATOR=" \u2022 ";t.DEFAULT_STROKE_COLOR="#0000ff";t.template={};t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w('<div class="tc-ctl-finfo-coords"><span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-crs">CRS: <span class="tc-ctl-finfo-coords-val">').f(e.get(["crs"],!1),e,"h").w("</span></span>").x(e.get(["isGeo"],!1),e,{else:n,block:s},{}).x(e.get(["displayElevation"],!1),e,{block:o},{}).w('</div><ul class="tc-ctl-finfo-services">').s(e.get(["services"],!1),e,{else:r,block:i},{}).w("</ul>").x(e.get(["featureCount"],!1),e,{block:R},{})}e.__dustBody=!0;function n(t,e){return t.w('<span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x">x: <span class="tc-ctl-finfo-coords-val">').f(e.getPath(!1,["coords","0"]),e,"h").w('</span></span><span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x">y: <span class="tc-ctl-finfo-coords-val">').f(e.getPath(!1,["coords","1"]),e,"h").w("</span></span>")}n.__dustBody=!0;function s(t,e){return t.w('<span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lat">').h("i18n",e,{},{$key:"lat"}).w(': <span class="tc-ctl-finfo-coords-val">').f(e.getPath(!1,["coords","1"]),e,"h").w('</span></span><span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lon">').h("i18n",e,{},{$key:"lon"}).w(': <span class="tc-ctl-finfo-coords-val">').f(e.getPath(!1,["coords","0"]),e,"h").w("</span></span>")}s.__dustBody=!0;function o(t,e){return t.w('<span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-elev">').h("i18n",e,{},{$key:"ele"}).w(': <span class="tc-ctl-finfo-coords-val"></span></span>')}o.__dustBody=!0;function r(t,e){return t.nx(e.get(["loading"],!1),e,{block:l},{})}r.__dustBody=!0;function l(t,e){return t.nx(e.get(["displayElevation"],!1),e,{block:a},{})}l.__dustBody=!0;function a(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noData"}).w("</li>")}a.__dustBody=!0;function i(t,e){return t.w("<li><h3>").x(e.get(["title"],!1),e,{else:c,block:d},{}).w('</h3><div class="tc-ctl-finfo-service-content">').s(e.get(["hasLimits"],!1),e,{else:h,block:k},{}).w("</div></li>")}i.__dustBody=!0;function c(t,e){return t.x(e.getPath(!1,["layers","0","title"]),e,{else:u,block:f},{})}c.__dustBody=!0;function u(t,e){return t.f(e.getPath(!1,["layer","name"]),e,"h")}u.__dustBody=!0;function f(t,e){return t.f(e.getPath(!1,["layers","0","title"]),e,"h")}f.__dustBody=!0;function d(t,e){return t.f(e.get(["title"],!1),e,"h")}d.__dustBody=!0;function h(t,e){return t.w('<ul class="tc-ctl-finfo-layers">').s(e.get(["layers"],!1),e,{else:p,block:C},{}).w("</ul>")}h.__dustBody=!0;function p(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataAtThisService"}).w("</li>")}p.__dustBody=!0;function C(t,e){return t.w('<li><h4><span class="tc-ctl-finfo-layer-n">').f(e.getPath(!1,["features","length"]),e,"h").w("</span> ").s(e.get(["path"],!1),e,{block:y},{}).w('</h4>                                            <div class="tc-ctl-finfo-layer-content"><ul class="tc-ctl-finfo-features">').s(e.get(["features"],!1),e,{else:T,block:L},{}).w("</ul></div></li>")}C.__dustBody=!0;function y(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:g},{})}y.__dustBody=!0;function g(t,e){return t.w(" &bull; ")}g.__dustBody=!0;function T(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataInThisLayer"}).w("</li>")}T.__dustBody=!0;function L(t,e){return t.w("<li>").x(e.get(["rawContent"],!1),e,{else:_,block:m},{}).w("</li>")}L.__dustBody=!0;function _(t,e){return t.x(e.get(["error"],!1),e,{else:E,block:w},{})}_.__dustBody=!0;function E(t,e){return t.w("<h5>").f(e.get(["id"],!1),e,"h").w("</h5><table").x(e.get(["geometry"],!1),e,{block:S},{}).w("><tbody>").s(e.get(["attributes"],!1),e,{block:v},{}).w("</tbody></table>")}E.__dustBody=!0;function S(t,e){return t.w(' title="').h("i18n",e,{},{$key:"clickToShowOnMap"}).w('"')}S.__dustBody=!0;function v(t,e){return t.w('<tr><th class="tc-ctl-finfo-attr">').f(e.get(["name"],!1),e,"h").w('</th><td class="tc-ctl-finfo-val">').p("tc-ctl-finfo-object",e,e.rebase(e.get(["value"],!1)),{}).w("</td></tr>")}v.__dustBody=!0;function w(t,e){return t.w('<span class="tc-ctl-finfo-errors">').h("i18n",e,{},{$key:"fi.error"}).w('<span class="tc-ctl-finfo-error-text">').f(e.get(["error"],!1),e,"h").w("</span></span>")}w.__dustBody=!0;function m(t,e){return t.w("<h5>").h("i18n",e,{},{$key:"feature"}).w("</h5>").h("eq",e,{else:P,block:F},{key:e.get(["rawFormat"],!1),value:"text/html"})}m.__dustBody=!0;function P(t,e){return t.w("<pre>").f(e.get(["rawContent"],!1),e,"h").w("</pre>")}P.__dustBody=!0;function F(t,e){return t.w("                                ").x(e.get(["expandUrl"],!1),e,{block:b},{})}F.__dustBody=!0;function b(t,e){return t.h("ne",e,{else:A,block:I},{key:e.get(["expandUrl"],!1),value:""})}b.__dustBody=!0;function A(t,e){return t.w('<iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('"></iframe>')}A.__dustBody=!0;function I(t,e){return t.w('<div class="tc-ctl-finfo-features-iframe-cnt"><iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('"></iframe><a class="tc-ctl-finfo-open" onclick="window.open(\'').f(e.get(["expandUrl"],!1),e,"h").w("', '_blank')\" title=\"").h("i18n",e,{},{$key:"expand"}).w('"></a></div>')}I.__dustBody=!0;function k(t,e){return t.w('<span class="tc-ctl-finfo-errors">').f(e.get(["hasLimits"],!1),e,"h").w("</span>")}k.__dustBody=!0;function R(t,e){return t.h("gt",e,{block:x},{key:e.get(["featureCount"],!1),value:"1",type:"number"})}R.__dustBody=!0;function x(t,e){return t.w('<a class="tc-ctl-btn tc-ctl-finfo-btn-prev">').h("i18n",e,{},{$key:"previous"}).w('</a><div class="tc-ctl-finfo-counter"><span class="tc-ctl-finfo-counter-current"></span>/').f(e.get(["featureCount"],!1),e,"h").w('</div><a class="tc-ctl-btn tc-ctl-finfo-btn-next">').h("i18n",e,{},{$key:"next"}).w("</a>")}x.__dustBody=!0;return e};t.template[t.CLASS+"-object"]=function(){dust.register(t.CLASS+"-object",e);function e(t,e){return t.h("isObject",e,{array:n,else:o,block:r},{object:e.getPath(!0,[])})}e.__dustBody=!0;function n(t,e){return t.w('<div class="complexAttr"><input type="checkbox" id="complexAttr_').f(e.getPath(!0,[]),e,"h",["objectId"]).w('"><div><label for="complexAttr_').f(e.getPath(!0,[]),e,"h",["objectId"]).w('" class="plus" title=""></label><label for="complexAttr_').f(e.getPath(!0,[]),e,"h",["objectId"]).w('" class="title" title="">').h("size",e,{},{key:e.getPath(!0,[])}).w(" ").h("i18n",e,{},{$key:"featureInfo.complexData.array"}).w('</label><br /><table class="complexAttr"><tbody>').h("iterate",e,{block:s},{on:e.getPath(!0,[])}).w("</tbody></table></div></div>")}n.__dustBody=!0;function s(t,e){return t.w("<tr><td>").p("tc-ctl-finfo-object",e,e.rebase(e.get(["value"],!1)),{}).w("</td></tr>")}s.__dustBody=!0;function o(t,e){return t.f(e.getPath(!0,[]),e,"h",["s"])}o.__dustBody=!0;function r(t,e){return t.w('<table class="complexAttr"><tbody>').h("iterate",e,{block:l},{on:e.getPath(!0,[])}).w("</tbody></table>")}r.__dustBody=!0;function l(t,e){return t.h("isKeyKalue",e,{else:a,block:f},{on:e.getPath(!0,[])})}l.__dustBody=!0;function a(t,e){return t.w('<tr><th style="display:none">').f(e.get(["key"],!1),e,"h").w("</th><td>").h("isObject",e,{array:i,else:c,block:u},{object:e.get(["value"],!1)}).p("tc-ctl-finfo-object",e,e.rebase(e.get(["value"],!1)),{}).w("</div></td></tr>")}a.__dustBody=!0;function i(t,e){return t.w('\x3c!--array--\x3e<div><label for="complexAttr_').f(e.getPath(!0,[]),e,"h",["objectId"]).w('" class="title" title="">').f(e.get(["key"],!1),e,"h").w("</label><br />")}i.__dustBody=!0;function c(t,e){return t.w("<div>\x3c!--native--\x3e")}c.__dustBody=!0;function u(t,e){return t.w('\x3c!--object--\x3e<input type="checkbox" id="complexAttr_').f(e.getPath(!0,[]),e,"h",["objectId"]).w('"><div><label for="complexAttr_').f(e.getPath(!0,[]),e,"h",["objectId"]).w('" class="plus" title=""></label><label for="complexAttr_').f(e.getPath(!0,[]),e,"h",["objectId"]).w('" class="title" title="">').f(e.get(["key"],!1),e,"h").w("</label><br />")}u.__dustBody=!0;function f(t,e){return t.w('<tr class="keyValue"><th class="key">').f(e.get(["key"],!1),e,"h").w('</th><td class="value tc-ctl-finfo-val">').p("tc-ctl-finfo-object",e,e.rebase(e.get(["value"],!1)),{}).w("</td></tr>")}f.__dustBody=!0;return e};t.register=function(t){const e=this,n=TC.control.Click.prototype.register.call(e,t);e._createLayers();t.loaded(function(){const n=t.getControlsByClass("TC.control.Share")[0];n&&e.loadSharedFeature(n.loadParamFeature())});e.displayMode=e.options.displayMode||TC.control.FeatureInfoCommons.displayMode.POPUP;e.setDisplayMode(e.displayMode);t.on(TC.Consts.event.POPUPHIDE+" "+TC.Consts.event.RESULTSPANELCLOSE,function(t){if(t.control===e.getDisplayControl()&&e.resultsLayer){if(e.highlightedFeature&&!e.options.persistentHighlights){e.downplayFeature(e.highlightedFeature);e.highlightedFeature=null}!e.querying&&t.feature&&e.filterLayer.removeFeature(t.feature)}}).on(TC.Consts.event.RESULTSPANELCLOSE,function(t){e.highlightedFeature=null}).on(TC.Consts.event.POPUP+" "+TC.Consts.event.DRAWTABLE+" "+TC.Consts.event.DRAWCHART,function(t){const n=t.control;n.currentFeature!==e.filterFeature&&(e.highlightedFeature=n.currentFeature);t.control.caller==e&&e._decorateDisplay(n)}).on(TC.Consts.event.DRAWCHART,function(t){setTimeout(function(){e.highlightedFeature=t.control.currentFeature},50)}).on(TC.Consts.event.LAYERREMOVE,function(){if(Object.keys(e._infoHistory).length){const t={};e.map.workLayers.filter(function(t){return t.type===TC.Consts.layerType.WMS}).forEach(function(e){const n=t[e.url]||[];t[e.url]=n.concat(e.getDisgregatedLayerNames())});let n=!1;for(let s in e._infoHistory){const o=e._infoHistory[s];if(t.hasOwnProperty(s)){const r=t[s];for(let t in o){const s=o[t];if(r.indexOf(t)<0){s.slice().forEach(t=>e.downplayFeature(t));s.length=0;n=!0}}}else{for(let t in o){o[t].slice().forEach(t=>e.downplayFeature(t));n=!0}delete e._infoHistory[s]}}n&&e.closeResults()}}).on(TC.Consts.event.VIEWCHANGE,function(t){e.closeResults()});return n};t.render=function(){this.div.classList.add(TC.Consts.classes.HIDDEN);return this._set1stRenderPromise(Promise.resolve())};t.responseCallback=function(t){const e=this;e.querying=!1;e.filterFeature&&(e.info={services:t.services});if(t.featureCount){e._addSourceAttributes();e.lastFeatureCount=t.featureCount;e.map.trigger(TC.Consts.event.FEATUREINFO,TC.Util.extend({control:e},t))}else{e.lastFeatureCount=0;e.map.trigger(TC.Consts.event.NOFEATUREINFO,{control:e})}};t.responseError=function(t){const e=this;404===t.status&&e.map.toast(e.getLocaleString("featureInfo.tooManyLayers"),{type:TC.Consts.msgType.ERROR});e.responseCallback({})};t.markerStyle={cssClass:TC.Consts.classes.POINT,anchor:[.5,.5],width:15,height:15,noPrint:!0};t.setDisplayMode=function(t){var e=this;e.displayMode=t;var n=e.map;switch(t){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:e.resultsPanel||n.addControl("resultsPanel").then(function(t){e.resultsPanel=t;t.caller=e});break;default:e.displayMode=TC.control.FeatureInfoCommons.displayMode.POPUP;e.popup||n.addControl("popup",{closeButton:!0,draggable:e.options.draggable}).then(function(t){e.popup=t;t.caller=e;n.on(TC.Consts.event.POPUP,function(t){e.onShowPopup(t)});n.on(TC.Consts.event.POPUPHIDE,function(n){n.control===t&&e._resetSize()})})}};t.getDisplayControl=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel;default:return this.popup}};t.getDisplayTarget=function(t){if((t=t||{}).control)switch(!0){case TC.control.Popup&&t.control instanceof TC.control.Popup:return t.control.getContainerElement();case TC.control.ResultsPanel&&t.control instanceof TC.control.ResultsPanel:return t.control.getInfoContainer();default:return null}switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel.getInfoContainer();default:return this.popup.getContainerElement()}};t.getMenuTarget=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel.getMenuElement();default:return this.popup.getMenuElement()}};t.displayResults=function(){var t=this;const e=t.div.cloneNode(!0);e.classList.remove(TC.Consts.classes.HIDDEN);t.filterFeature.data=e.outerHTML;switch(t.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:if(t.resultsPanel){0===t.map.getControlsByClass(TC.control.ControlContainer).length&&t.map.getControlsByClass(TC.control.ResultsPanel).forEach(function(t){t.isVisible()&&t.close()});t.map.getControlsByClass("TC.control.ResultsPanel").forEach(function(e){e!==t.resultsPanel&&e.currentFeature&&!e.chart&&e.close()});t.resultsPanel.currentFeature=t.filterFeature;t.resultsPanel.open(t.filterFeature.data,t.resultsPanel.getInfoContainer());TC.loadJS(!TC.control.Print,[TC.apiLocation+"TC/control/Print"],function(){const e=t.getMenuTarget().querySelectorAll("."+TC.control.Print.prototype.CLASS+"-btn");e.length>0&&e[0].remove();t.displayResultsCallback()})}break;default:t.popup&&t.filterFeature.showPopup(t.popup)}};const e=function(t){return Array.from(t.parentElement.children).indexOf(t)},n=function(t,e){var n=t;do{n=n.parentElement}while(n&&n.tagName!==e);return n};t.getFeatureElement=function(t){const s=this;var o;s.getDisplayTarget().querySelectorAll(s._selectors.LIST_ITEM).forEach(function(r){const l=r,a=n(r,"LI"),i=n(a,"LI");s.getFeature(e(i),e(a),e(l))===t&&(o=l)});return o};t.getNextFeatureElement=function(t){const e=this.getDisplayTarget().querySelectorAll("ul."+this.CLASS+"-features > li"),n=e.length;for(var s=0;s<n;s++)if(e[s].matches("."+TC.Consts.classes.CHECKED))return e[(s+t+n)%n];return null};t.getFeaturePath=function(t){const e=this;if(e.info&&e.info.services)for(var n=0,s=e.info.services.length;n<s;n++){const s=e.info.services[n];for(var o=0,r=s.layers.length;o<r;o++){const e=s.layers[o];for(var l=0,a=e.features.length;l<a;l++)if(e.features[l]===t)return{service:s.title||s.mapLayers.reduce(function(t,e){return t||e.title},""),layer:e.path}}}return null};t.closeResults=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:this.resultsPanel&&this.resultsPanel.isVisible()&&this.resultsPanel.close();break;default:this.popup&&this.popup.isVisible()&&this.popup.hide()}};t.displayResultsCallback=function(){var t=this;const e=t.getDisplayTarget().querySelector("."+t.CLASS);var s,o,r="click";e.addEventListener(r,TC.EventTarget.listenerBySelector(t._selectors.LIST_ITEM,function(e){t.highlightFeature(e.target)}));r=TC.Consts.event.CLICK;s="."+t.CLASS+"-btn-next";e.addEventListener(r,TC.EventTarget.listenerBySelector(s,function(e){t.highlightFeature(t.getNextFeatureElement(1),1);return!1}));s="."+t.CLASS+"-btn-prev";e.addEventListener(r,TC.EventTarget.listenerBySelector(s,function(e){t.highlightFeature(t.getNextFeatureElement(-1),-1);return!1}));s="ul."+t.CLASS+"-layers h4";e.addEventListener(r,TC.EventTarget.listenerBySelector(s,function(s){const o=n(s.target,"LI");if(o.classList.contains(TC.Consts.classes.CHECKED)){const n=e.querySelector(".tc-ctl-finfo-layers li:not(.tc-checked)");n&&"none"!==getComputedStyle(n).display&&t.downplayFeatures()}else{t.highlightFeature(o.querySelector(t._selectors.LIST_ITEM));t.displayMode===TC.control.FeatureInfoCommons.displayMode.POPUP&&t.popup.fitToView(!0)}}));s="."+t.CLASS+"-del-btn";e.addEventListener(r,TC.EventTarget.listenerBySelector(s,function(e){t.downplayFeatures();t.closeResults()}));if(t.info)if(t.info.defaultFeature&&t.getFeatureElement(t.info.defaultFeature)){t.getFeatureElement(t.info.defaultFeature).classList.add(TC.Consts.classes.DEFAULT);t.highlightFeature(t.info.defaultFeature)}else e.querySelector(t._selectors.LIST_ITEM)&&t.highlightFeature(e.querySelector(t._selectors.LIST_ITEM));e.querySelectorAll("table:not(.complexAttr)").forEach(function(e){e.addEventListener(TC.Consts.event.CLICK,function(e){const n=this.parentElement;if(!n.classList.contains(TC.Consts.classes.DISABLED)){if(n.classList.contains(TC.Consts.classes.CHECKED)){if(t.resultsLayer.features[0]&&window.getSelection()&&0===window.getSelection().toString().trim().length){t.map.on(TC.Consts.event.ZOOM,function e(){t._zooming=!1;t.map.off(TC.Consts.event.ZOOM,e)});t._zooming=!0;t.map.zoomToFeatures([t.resultsLayer.features[0]],{animate:!0})}}else t.highlightFeature(n);e.stopPropagation()}})});e.querySelectorAll("table a, table label, table input").forEach(function(t){t.addEventListener(TC.Consts.event.CLICK,function(t){t.stopPropagation()})});if(TC.browserFeatures.touch()&&t.displayMode===TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL){const n=e.querySelector("."+t.CLASS+"-btn-prev");if(!n||"none"!==n.style.display){t.resultsPanel&&TC.Util.swipe(t.resultsPanel.div,"disable");((o=t).info&&o.info.services?o.info.services.reduce(function(t,e){return t+e.layers.reduce(function(t,e){return t+1},0)},0):0)>1&&TC.Util.swipe(e,{left:function(){t.highlightFeature(t.getNextFeatureElement(1),1)},right:function(){t.highlightFeature(t.getNextFeatureElement(-1),-1)}})}}};t.onShowPopup=function(t){const e=this;if(t.control===e.popup){e.displayResultsCallback();e._fitSize()}};t.loadSharedFeature=function(t){};t.insertLinks=function(){const t=this.getLocaleString("open"),e=this.getLocaleString("linkInNewWindow");this.div.querySelectorAll("td."+this.CLASS+"-val").forEach(function(n){const s=n.textContent;TC.Util.isURL(s)&&(n.innerHTML='<a href="'+s+'" target="_blank" title="'+e+'">'+t+"</a>")})};t.highlightFeature=function(t,s){const o=this;var r;if(!o._zooming){var l;if(t instanceof TC.Feature){r=t;l=o.getFeatureElement(r)}else{l=t;for(;l&&"LI"!==l.tagName;)l=l.parentElement}const c=n(l,"LI"),u=n(c,"LI"),f=e(u),d=e(c),h=e(l);r=r||o.getFeature(f,d,h);o.downplayFeatures({exception:r});const p=o.info.services[f];o._infoHistory.hasOwnProperty(p.url)||(o._infoHistory[p.url]={});const C=o._infoHistory[p.url],y=p.layers[d],g=C[y.name]||[];C[y.name]=g.concat(r);l.classList.add(TC.Consts.classes.CHECKED);c.classList.add(TC.Consts.classes.CHECKED);u.classList.add(TC.Consts.classes.CHECKED);if(s>0){l.classList.add(TC.Consts.classes.FROMLEFT);c.classList.add(TC.Consts.classes.FROMLEFT);u.classList.add(TC.Consts.classes.FROMLEFT)}else if(s<0){l.classList.add(TC.Consts.classes.FROMRIGHT);c.classList.add(TC.Consts.classes.FROMRIGHT);u.classList.add(TC.Consts.classes.FROMRIGHT)}l.querySelector("table")&&l.querySelector("table").setAttribute("title",o.getLocaleString("clickToCenter"));o.highlightedFeature=r;o.getDisplayTarget().querySelector("."+o.CLASS+"-counter-current")&&(o.getDisplayTarget().querySelector("."+o.CLASS+"-counter-current").innerHTML=o.getFeatureIndex(f,d,h)+1);var a=o.resultsLayer.features.slice(),i=a.filter(function(t){return r&&r.id===t.id});if(i.length>0){o.highlightedFeature=i[0];return}o.options.persistentHighlights||a.forEach(t=>{t!==o.filterFeature&&o.downplayFeature(t)});if(r&&r.geometry){r.showsPopup=o.options.persistentHighlights;o.resultsLayer.addFeature(r)}else l.classList.add(TC.Consts.classes.DISABLED)}};t.downplayFeature=function(t){const e=this;e.resultsLayer.removeFeature(t);for(url in e._infoHistory){const n=e._infoHistory[url];for(name in n){const e=n[name],s=e.indexOf(t);if(s>=0){e.splice(s,1);e.length||delete n[name]}}}};t.downplayFeatures=function(t){const e=this;t=t||{};if(e.highlightedFeature&&e.highlightedFeature!==t.exception){e.downplayFeature(e.highlightedFeature);e.highlightedFeature=null}const s=t.exception?e.getFeatureElement(t.exception):void 0;var o,r;if(s){o=n(s,"LI");r=n(o,"LI")}const l=e.getDisplayTarget();Array.from(l.querySelectorAll("ul."+e.CLASS+"-services li")).filter(function(t){return t!==s&&t!==o&&t!==r}).forEach(function(t){t.classList.remove(TC.Consts.classes.CHECKED,TC.Consts.classes.DISABLED,TC.Consts.classes.FROMLEFT,TC.Consts.classes.FROMRIGHT)});l.querySelectorAll("."+e.CLASS+"-features table:not(.complexAttr)").forEach(function(t){t.setAttribute("title",e.getLocaleString("clickToShowOnMap"))})};t._fitSize=function(){const t=this.getDisplayTarget();var e=0;t.querySelectorAll("input").forEach(function(t){t.checked=!0});t.querySelectorAll(".tc-ctl-finfo-features li").forEach(function(t){e=Math.max(e,t.offsetLeft+t.offsetWidth)});e&&(t.style.width=e+50+"px");t.querySelectorAll("input").forEach(function(t){t.checked=!1})};t._resetSize=function(){this.getDisplayTarget().style.removeProperty("width")};t.getFeature=function(t,e,n){var s;const o=this.info;o&&o.services&&(s=o.services[t])&&(s=s.layers[e])&&(s=s.features[n]);return s};t.getFeatureIndex=function(t,e,n){var s=-1;const o=this.info;if(o)for(var r=0;r<=t;r++)for(var l=o.services[r],a=r===t?e:l.layers.length-1,i=0;i<=a;i++)for(var c=l.layers[i],u=i===e?n:c.features.length-1,f=0;f<=u;f++)s+=1;return s};t.beforeRequest=function(t){var e=this;e.querying=!0;e.map.trigger(TC.Consts.event.BEFOREFEATUREINFO,{xy:t.xy,control:e});e.closeResults();if(e.map&&e.resultsLayer){e.lastFeatureCount=null;e.options.persistentHighlights||e.resultsLayer.features.slice().forEach(t=>e.downplayFeature(t));e.info=null}};t.activate=function(){this.wrap&&this.wrap.activate();TC.Control.prototype.activate.call(this)};t.deactivate=function(t){var e=this;e.popup&&e.popup.isVisible()&&e.popup.hide();if(!e.options.persistentHighlights){e.resultsLayer.features.slice().forEach(t=>e.downplayFeature(t));e.info=null;e._infoHistory={}}e.filterLayer&&e.filterLayer.clearFeatures();e.filterFeature=null;e.wrap&&e.wrap.deactivate();TC.Control.prototype.deactivate.call(e,t)};t.exportState=function(){const t=this;return t.exportsState&&t.resultsLayer?{id:t.id,layer:t.resultsLayer.exportState()}:null};t.importState=function(t){const e=this;e._layersPromise.then(function(){e.resultsLayer.importState(t.layer)})};t._createLayers=function(){const t=this;var e,n;e=t.options.resultsLayer?t.options.resultsLayer:{id:t.getUID(),title:t.CLASS+": Results layer",type:TC.Consts.layerType.VECTOR,owner:t,stealth:!0};if(t.options.filterLayer)n=t.options.filterLayer;else{const e={};t.geometryType===TC.Consts.geom.POLYLINE&&(e.line=t.style);t.geometryType===TC.Consts.geom.POLYGON&&(e.polygon=t.style);n={id:t.getUID(),title:t.CLASS+": Filter layer",owner:t,stealth:!0,type:TC.Consts.layerType.VECTOR,styles:e}}const s=t.map;t._layersPromise=new Promise(function(o,r){s.loaded(function(){Promise.all([s.addLayer(e),s.addLayer(n)]).then(function(e){t.resultsLayer=e[0];t.filterLayer=e[1];o()})})});return t._layersPromise};t._decorateDisplay=function(t){const e=this,n=e.getMenuTarget({control:t});TC.loadJS(!TC.control.Print,[TC.apiLocation+"TC/control/Print"],function(){if(!n.querySelectorAll("."+TC.control.Print.prototype.CLASS+"-btn").length){var s=e.getLocaleString("feature");if(t===e.getDisplayControl())if(TC.feature.Point&&e.filterFeature instanceof TC.feature.Point){const t=e.filterFeature.geometry;s=e.getLocaleString("featuresAt",{crs:e.map.crs,x:TC.Util.formatCoord(t[0],e.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),y:TC.Util.formatCoord(t[1],e.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)})}else s=e.getLocaleString("spatialQueryResults");else t.currentFeature&&(s=t.currentFeature.id);(e.lastFeatureCount||t.currentFeature&&!0===t.currentFeature.showsPopup)&&new TC.control.Print({target:n,printableElement:e.getDisplayTarget({control:t}),title:s})}})};t._addSourceAttributes=function(){const t=this,e="h3_"+t.getLocaleString("service"),n="h4_"+t.getLocaleString("layer");t.info&&t.info.services&&t.info.services.forEach(function(s){s.layers.forEach(function(s){s.features.forEach(function(s){if(s instanceof TC.Feature){const o=t.getFeaturePath(s);if(o){const r={};r[e]=o.service;o.layer&&(r[n]=o.layer.join(t.TITLE_SEPARATOR));const l=TC.Util.extend(r,s.getData());s.clearData();s.setData(l)}}})})})}}();
//# sourceMappingURL=../maps/control/FeatureInfoCommons.min.js.map