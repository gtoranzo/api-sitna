TC.control=TC.control||{};TC.control.Click||TC.syncLoadJS(TC.apiLocation+"TC/control/Click");TC.Consts.event.POPUP=TC.Consts.event.POPUP||"popup.tc";TC.Consts.event.POPUPHIDE=TC.Consts.event.POPUPHIDE||"popuphide.tc";TC.Consts.event.DRAWCHART=TC.Consts.event.DRAWCHART||"drawchart.tc";TC.Consts.event.DRAWTABLE=TC.Consts.event.DRAWTABLE||"drawtable.tc";TC.Consts.event.RESULTSPANELCLOSE=TC.Consts.event.RESULTSPANELCLOSE||"resultspanelclose.tc";TC.control.FeatureInfoCommons=function(){TC.control.Click.apply(this,arguments);const e=this._classSelector="."+this.CLASS;this._selectors={LIST_ITEM:"ul"+e+"-features li"};this.resultsLayer=null;this.filterLayer=null;this._layersPromise=null;this.filterFeature=null;this.info=null;this.popup=null;this.resultsPanel=null;this.lastFeatureCount=null;this.exportsState=!0};TC.control.FeatureInfoCommons.displayMode={POPUP:"popup",RESULTS_PANEL:"resultsPanel"};!function(){Array.from||(Array.from=(e=Object.prototype.toString,t=function(t){return"function"==typeof t||"[object Function]"===e.call(t)},n=Math.pow(2,53)-1,s=function(e){var t=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t}(e);return Math.min(Math.max(t,0),n)},function(e){var n=Object(e);if(null==e)throw new TypeError("Array.from requiere un objeto array-like - not null or undefined");var r,o=arguments.length>1?arguments[1]:void 0;if(void 0!==o){if(!t(o))throw new TypeError("Array.from: si hay mapFn, el segundo argumento debe ser una funci\xf3n");arguments.length>2&&(r=arguments[2])}for(var l,a=s(n.length),i=t(this)?Object(new this(a)):new Array(a),c=0;c<a;){l=n[c];i[c]=o?void 0===r?o(l,c):o.call(r,l,c):l;c+=1}i.length=a;return i}));var e,t,n,s,r=function(e){return e.info.services?e.info.services.reduce(function(e,t){return e+t.layers.reduce(function(e,t){return e+1},0)},0):0};TC.inherit(TC.control.FeatureInfoCommons,TC.control.Click);var o=TC.control.FeatureInfoCommons.prototype;o.CLASS="tc-ctl-finfo";o.TITLE_SEPARATOR=" \u2022 ";TC.isDebug?o.template=TC.apiLocation+"TC/templates/FeatureInfo.html":o.template=function(){dust.register(o.CLASS,e);function e(e,n){return e.x(n.get(["elevation"],!1),n,{block:t},{}).w('<ul class="tc-ctl-finfo-services">').s(n.get(["services"],!1),n,{else:r,block:a},{}).w("</ul>").x(n.get(["featureCount"],!1),n,{block:k},{})}e.__dustBody=!0;function t(e,t){return e.w('<div class="tc-ctl-finfo-coords"><span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-crs">CRS: <span class="tc-ctl-finfo-coords-val">').f(t.get(["crs"],!1),t,"h").w("</span></span> ").x(t.get(["isGeo"],!1),t,{else:n,block:s},{}).w(' <span class="tc-ctl-finfo-coords-pair">').h("i18n",t,{},{$key:"ele"}).w(': <span class="tc-ctl-finfo-coords-val">').f(t.get(["elevation"],!1),t,"h").w(" m</span></span></div>")}t.__dustBody=!0;function n(e,t){return e.w('<span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x">x: <span class="tc-ctl-finfo-coords-val">').f(t.getPath(!1,["coords","0"]),t,"h").w('</span></span> <span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x">y: <span class="tc-ctl-finfo-coords-val">').f(t.getPath(!1,["coords","1"]),t,"h").w("</span></span> ")}n.__dustBody=!0;function s(e,t){return e.w('<span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lat">').h("i18n",t,{},{$key:"lat"}).w(': <span class="tc-ctl-finfo-coords-val">').f(t.getPath(!1,["coords","1"]),t,"h").w('</span></span> <span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lon">').h("i18n",t,{},{$key:"lon"}).w(': <span class="tc-ctl-finfo-coords-val">').f(t.getPath(!1,["coords","0"]),t,"h").w("</span></span> ")}s.__dustBody=!0;function r(e,t){return e.nx(t.get(["elevation"],!1),t,{block:l},{})}r.__dustBody=!0;function l(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noData"}).w("</li>")}l.__dustBody=!0;function a(e,t){return e.w("<li><h3>").x(t.get(["title"],!1),t,{else:i,block:f},{}).w('</h3><div class="tc-ctl-finfo-service-content">').s(t.get(["hasLimits"],!1),t,{else:d,block:R},{}).w("</div></li>")}a.__dustBody=!0;function i(e,t){return e.x(t.getPath(!1,["layers","0","title"]),t,{else:c,block:u},{})}i.__dustBody=!0;function c(e,t){return e.f(t.getPath(!1,["layer","name"]),t,"h")}c.__dustBody=!0;function u(e,t){return e.f(t.getPath(!1,["layers","0","title"]),t,"h")}u.__dustBody=!0;function f(e,t){return e.f(t.get(["title"],!1),t,"h")}f.__dustBody=!0;function d(e,t){return e.w('<ul class="tc-ctl-finfo-layers">').s(t.get(["layers"],!1),t,{else:C,block:h},{}).w("</ul>")}d.__dustBody=!0;function C(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noDataAtThisService"}).w("</li>")}C.__dustBody=!0;function h(e,t){return e.w('<li><h4><span class="tc-ctl-finfo-layer-n">').f(t.getPath(!1,["features","length"]),t,"h").w("</span> ").s(t.get(["path"],!1),t,{block:p},{}).w('</h4> <div class="tc-ctl-finfo-layer-content"><ul class="tc-ctl-finfo-features">').s(t.get(["features"],!1),t,{else:g,block:T},{}).w("</ul></div></li>")}h.__dustBody=!0;function p(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:y},{})}p.__dustBody=!0;function y(e,t){return e.w(" &bull; ")}y.__dustBody=!0;function g(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noDataInThisLayer"}).w("</li>")}g.__dustBody=!0;function T(e,t){return e.w("<li>").x(t.get(["rawContent"],!1),t,{else:L,block:F},{}).w("</li>")}T.__dustBody=!0;function L(e,t){return e.x(t.get(["error"],!1),t,{else:v,block:E},{})}L.__dustBody=!0;function v(e,t){return e.w("<h5>").f(t.get(["id"],!1),t,"h").w("</h5><table").x(t.get(["geometry"],!1),t,{block:S},{}).w("><tbody>").s(t.get(["attributes"],!1),t,{block:m},{}).w("</tbody></table>")}v.__dustBody=!0;function S(e,t){return e.w(' title="').h("i18n",t,{},{$key:"clickToShowOnMap"}).w('"')}S.__dustBody=!0;function m(e,t){return e.w('<tr><th class="tc-ctl-finfo-attr">').f(t.get(["name"],!1),t,"h").w('</th><td class="tc-ctl-finfo-val">').f(t.get(["value"],!1),t,"h").w("</td></tr>")}m.__dustBody=!0;function E(e,t){return e.w('<span class="tc-ctl-finfo-errors">').h("i18n",t,{},{$key:"fi.error"}).w('<span class="tc-ctl-finfo-error-text">').f(t.get(["error"],!1),t,"h").w("</span></span>")}E.__dustBody=!0;function F(e,t){return e.w("<h5>").h("i18n",t,{},{$key:"feature"}).w("</h5>").h("eq",t,{else:w,block:P},{key:t.get(["rawFormat"],!1),value:"text/html"})}F.__dustBody=!0;function w(e,t){return e.w("<pre>").f(t.get(["rawContent"],!1),t,"h").w("</pre>")}w.__dustBody=!0;function P(e,t){return e.w(" ").x(t.get(["expandUrl"],!1),t,{block:_},{})}P.__dustBody=!0;function _(e,t){return e.h("ne",t,{else:A,block:b},{key:t.get(["expandUrl"],!1),value:""})}_.__dustBody=!0;function A(e,t){return e.w('<iframe src="').f(t.get(["rawUrl"],!1),t,"h").w('"></iframe>')}A.__dustBody=!0;function b(e,t){return e.w('<div class="tc-ctl-finfo-features-iframe-cnt"><iframe src="').f(t.get(["rawUrl"],!1),t,"h").w('"></iframe><a class="tc-ctl-finfo-open" onclick="window.open(\'').f(t.get(["expandUrl"],!1),t,"h").w("', '_blank')\" title=\"").h("i18n",t,{},{$key:"expand"}).w('"></a></div>')}b.__dustBody=!0;function R(e,t){return e.w('<span class="tc-ctl-finfo-errors">').f(t.get(["hasLimits"],!1),t,"h").w("</span>")}R.__dustBody=!0;function k(e,t){return e.h("gt",t,{block:I},{key:t.get(["featureCount"],!1),value:"1",type:"number"})}k.__dustBody=!0;function I(e,t){return e.w('<a class="tc-ctl-btn tc-ctl-finfo-btn-prev">').h("i18n",t,{},{$key:"previous"}).w('</a><div class="tc-ctl-finfo-counter"><span class="tc-ctl-finfo-counter-current"></span>/').f(t.get(["featureCount"],!1),t,"h").w('</div><a class="tc-ctl-btn tc-ctl-finfo-btn-next">').h("i18n",t,{},{$key:"next"}).w("</a>")}I.__dustBody=!0;return e};o.register=function(e){const t=this,n=TC.control.Click.prototype.register.call(t,e);t._createLayers();e.loaded(function(){const n=e.getControlsByClass("TC.control.Share")[0];n&&t.loadSharedFeature(n.loadParamFeature())});t.displayMode=t.options.displayMode||TC.control.FeatureInfoCommons.displayMode.POPUP;t.setDisplayMode(t.displayMode);e.on(TC.Consts.event.POPUPHIDE+" "+TC.Consts.event.RESULTSPANELCLOSE,function(e){if(e.control===t.getDisplayControl()&&t.resultsLayer){if(t.highlightedFeature){t.resultsLayer.removeFeature(t.highlightedFeature);t.highlightedFeature=null}t.querying||t.filterLayer.clearFeatures()}}).on(TC.Consts.event.RESULTSPANELCLOSE,function(e){t.highlightedFeature=null}).on(TC.Consts.event.POPUP+" "+TC.Consts.event.DRAWTABLE+" "+TC.Consts.event.DRAWCHART,function(e){const n=e.control;n.currentFeature!==t.filterFeature&&(t.highlightedFeature=n.currentFeature);e.control.currentFeature&&e.control.currentFeature.layer&&[t.filterLayer.id,t.resultsLayer.id].indexOf(e.control.currentFeature.layer.id)>-1&&t._decorateDisplay(n)}).on(TC.Consts.event.DRAWCHART,function(e){setTimeout(function(){t.highlightedFeature=e.control.currentFeature},50)}).on(TC.Consts.event.LAYERREMOVE,function(){if(t.info&&t.info.services){const s={};t.map.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WMS}).forEach(function(e){const t=s[e.url]||[];s[e.url]=t.concat(e.getDisgregatedLayerNames())});for(var e=0,n=t.info.services.length;e<n;e++){const n=t.info.services[e],r=s[n.mapLayers[0].url]||[];if(!n.layers.reduce(function(e,t){return e.concat(t.name)},[]).every(function(e){return r.indexOf(e)>=0})){t.downplayFeatures();t.info=null;t.closeResults();break}}}}).on(TC.Consts.event.VIEWCHANGE,function(e){t.closeResults()});return n};o.render=function(){this.div.classList.add(TC.Consts.classes.HIDDEN);return this._set1stRenderPromise(Promise.resolve())};o.responseCallback=function(e){const t=this;t.querying=!1;t.filterFeature&&(t.info={services:e.services});if(e.featureCount){t._addSourceAttributes();t.lastFeatureCount=e.featureCount;t.map.trigger(TC.Consts.event.FEATUREINFO,$.extend({control:t},e))}else{t.lastFeatureCount=0;t.map.trigger(TC.Consts.event.NOFEATUREINFO,{control:t});t.closeResults()}};o.responseError=function(e){const t=this;404===e.status&&t.map.toast(t.getLocaleString("featureInfo.tooManyLayers"),{type:TC.Consts.msgType.ERROR});t.responseCallback({})};o.markerStyle={cssClass:TC.Consts.classes.POINT,anchor:[.5,.5],width:15,height:15,noPrint:!0};o.setDisplayMode=function(e){var t=this;t.displayMode=e;var n=t.map;switch(e){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:if(!t.resultsPanel){var s=n.getControlsByClass("TC.control.ResultsPanel").filter(function(e){return"table"===e.options.content})[0];if(s){t.resultsPanel=s;s.caller=t}else{n.on(TC.Consts.event.CONTROLADD,function e(s){const r=s.control;if(TC.control.ResultsPanel&&r instanceof TC.control.ResultsPanel){t.resultsPanel=r;r.caller=t;n.off(TC.Consts.event.CONTROLADD,e)}})}}break;default:t.displayMode=TC.control.FeatureInfoCommons.displayMode.POPUP;t.popup||n.addControl("popup",{closeButton:!0,draggable:t.options.draggable}).then(function(e){t.popup=e;e.caller=t;n.on(TC.Consts.event.POPUP,function(e){t.onShowPopup(e)});n.on(TC.Consts.event.POPUPHIDE,function(n){n.control===e&&t._resetSize()})})}};o.getDisplayControl=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel;default:return this.popup}};o.getDisplayTarget=function(e){if((e=e||{}).control)switch(!0){case TC.control.Popup&&e.control instanceof TC.control.Popup:return e.control.getContainerElement();case TC.control.ResultsPanel&&e.control instanceof TC.control.ResultsPanel:return e.control.getTableContainer();default:return null}switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel.getTableContainer();default:return this.popup.getContainerElement()}};o.getMenuTarget=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel.getMenuElement();default:return this.popup.getMenuElement()}};o.displayResults=function(){var e=this;const t=e.div.cloneNode(!0);t.classList.remove(TC.Consts.classes.HIDDEN);e.filterFeature.data=t.outerHTML;switch(e.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:if(e.resultsPanel){if(0===e.map.getControlsByClass(TC.control.ControlContainer).length)e.map.getControlsByClass(TC.control.ResultsPanel).forEach(function(e){e.isVisible()&&e.close()});else{e.map.getControlsByClass("TC.control.ResultsPanel").forEach(function(t){t!==e.resultsPanel&&t.currentFeature&&t.close()})}e.resultsPanel.currentFeature=e.filterFeature;e.resultsPanel.open(e.filterFeature.data,e.resultsPanel.getInfoContainer());e.displayResultsCallback()}break;default:e.popup&&e.filterFeature.showPopup(e.popup)}};const l=function(e){return Array.from(e.parentElement.childNodes).indexOf(e)},a=function(e,t){var n=e;do{n=n.parentElement}while(n&&n.tagName!==t);return n};o.getFeatureElement=function(e){const t=this;var n;t.getDisplayTarget().querySelectorAll(t._selectors.LIST_ITEM).forEach(function(s){const r=s,o=a(s,"LI"),i=a(o,"LI");t.getFeature(l(i),l(o),l(r))===e&&(n=r)});return n};o.getNextFeatureElement=function(e){const t=this.getDisplayTarget().querySelectorAll("ul."+this.CLASS+"-features > li"),n=t.length;for(var s=0;s<n;s++)if(t[s].matches("."+TC.Consts.classes.CHECKED))return t[(s+e+n)%n];return null};o.getFeaturePath=function(e){const t=this;if(t.info&&t.info.services)for(var n=0,s=t.info.services.length;n<s;n++){const s=t.info.services[n];for(var r=0,o=s.layers.length;r<o;r++){const t=s.layers[r];for(var l=0,a=t.features.length;l<a;l++)if(t.features[l]===e)return{service:s.title||s.mapLayers.reduce(function(e,t){return e||t.title},""),layer:t.path}}}return null};o.closeResults=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:this.resultsPanel&&this.resultsPanel.isVisible()&&this.resultsPanel.close();break;default:this.popup&&this.popup.isVisible()&&this.popup.hide()}};o.displayResultsCallback=function(){var e=this;const t=e.getDisplayTarget().querySelector("."+e.CLASS);var n,s="click";t.addEventListener(s,TC.EventTarget.listenerBySelector(e._selectors.LIST_ITEM,function(t){e.highlightFeature(t.target)}));s=TC.Consts.event.CLICK;n="."+e.CLASS+"-btn-next";t.addEventListener(s,TC.EventTarget.listenerBySelector(n,function(t){e.highlightFeature(e.getNextFeatureElement(1),1);return!1}));n="."+e.CLASS+"-btn-prev";t.addEventListener(s,TC.EventTarget.listenerBySelector(n,function(t){e.highlightFeature(e.getNextFeatureElement(-1),-1);return!1}));n="ul."+e.CLASS+"-layers h4";t.addEventListener(s,TC.EventTarget.listenerBySelector(n,function(n){const s=a(n.target,"LI");if(s.classList.contains(TC.Consts.classes.CHECKED))t.querySelector(".tc-ctl-finfo-btn-next")&&"none"===t.querySelector(".tc-ctl-finfo-btn-next").style.display&&r(e)>1&&e.downplayFeatures();else{e.highlightFeature(s.querySelector(e._selectors.LIST_ITEM));e.displayMode===TC.control.FeatureInfoCommons.displayMode.POPUP&&e.popup.fitToView(!0)}}));n="."+e.CLASS+"-del-btn";t.addEventListener(s,TC.EventTarget.listenerBySelector(n,function(t){e.downplayFeatures();e.closeResults()}));if(e.info)if(e.info.defaultFeature&&e.getFeatureElement(e.info.defaultFeature)){e.getFeatureElement(e.info.defaultFeature).classList.add(TC.Consts.classes.DEFAULT);e.highlightFeature(e.info.defaultFeature)}else t.querySelector(e._selectors.LIST_ITEM)&&e.highlightFeature(t.querySelector(e._selectors.LIST_ITEM));t.querySelectorAll("table").forEach(function(t){t.addEventListener(TC.Consts.event.CLICK,function(t){const n=this.parentElement;if(!n.classList.contains(TC.Consts.classes.DISABLED)){if(n.classList.contains(TC.Consts.classes.CHECKED)){if(e.resultsLayer.features[0]&&window.getSelection()&&0===window.getSelection().toString().trim().length){e.map.on(TC.Consts.event.ZOOM,function t(){e._zooming=!1;e.map.off(TC.Consts.event.ZOOM,t)});e._zooming=!0;e.map.zoomToFeatures([e.resultsLayer.features[0]],{animate:!0})}}else e.highlightFeature(n);t.stopPropagation()}})});t.querySelectorAll("table a").forEach(function(e){e.addEventListener("click",function(e){e.stopPropagation()})});if(Modernizr.touch&&e.displayMode===TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL&&t.querySelector("."+e.CLASS+"-btn-prev")&&"none"!==t.querySelector("."+e.CLASS+"-btn-prev").style.display){e.resultsPanel&&TC.Util.swipe(e.resultsPanel.div,"disable");r(e)>1&&TC.Util.swipe(t,{left:function(){e.highlightFeature(e.getNextFeatureElement(1),1)},right:function(){e.highlightFeature(e.getNextFeatureElement(-1),-1)}})}};o.onShowPopup=function(e){this.map;if(e.control===this.popup){this.displayResultsCallback();this._fitSize()}};o.loadSharedFeature=function(e){};o.insertLinks=function(){const e=this.getLocaleString("open"),t=this.getLocaleString("linkInNewWindow");this.div.querySelectorAll("td."+this.CLASS+"-val").forEach(function(n){const s=n.textContent;TC.Util.isURL(s)&&(n.innerHTML='<a href="'+s+'" target="_blank" title="'+t+'">'+e+"</a>")})};o.highlightFeature=function(e,t){const n=this;var s;if(!n._zooming){var r;if(e instanceof TC.Feature){s=e;r=n.getFeatureElement(s)}else{r=e;for(;r&&"LI"!==r.tagName;)r=r.parentElement}const u=a(r,"LI"),f=a(u,"LI"),d=l(f),C=l(u),h=l(r);s=s||n.getFeature(d,C,h);n.downplayFeatures({exception:s});r.classList.add(TC.Consts.classes.CHECKED);u.classList.add(TC.Consts.classes.CHECKED);f.classList.add(TC.Consts.classes.CHECKED);if(t>0){r.classList.add(TC.Consts.classes.FROMLEFT);u.classList.add(TC.Consts.classes.FROMLEFT);f.classList.add(TC.Consts.classes.FROMLEFT)}else if(t<0){r.classList.add(TC.Consts.classes.FROMRIGHT);u.classList.add(TC.Consts.classes.FROMRIGHT);f.classList.add(TC.Consts.classes.FROMRIGHT)}r.querySelector("table")&&r.querySelector("table").setAttribute("title",n.getLocaleString("clickToCenter"));n.highlightedFeature=s;n.getDisplayTarget().querySelector("."+n.CLASS+"-counter-current")&&(n.getDisplayTarget().querySelector("."+n.CLASS+"-counter-current").innerHTML=n.getFeatureIndex(d,C,h)+1);var o=n.resultsLayer.features.slice();if(o.filter(function(e){return s&&s.id===e.id}).length>0)return;for(var i=0;i<o.length;i++){var c=o[i];c!==n.filterFeature&&n.resultsLayer.removeFeature(c)}s&&s.geometry?n.resultsLayer.addFeature(s):r.classList.add(TC.Consts.classes.DISABLED)}};o.downplayFeatures=function(e){const t=this;e=e||{};t.highlightedFeature!==e.exception&&(t.highlightedFeature=null);const n=e.exception?t.getFeatureElement(e.exception):void 0;var s,r;if(n){s=a(n,"LI");r=a(s,"LI")}t.resultsLayer.clearFeatures();const o=t.getDisplayTarget();Array.from(o.querySelectorAll("ul."+t.CLASS+"-services li")).filter(function(e){return e!==n&&e!==s&&e!==r}).forEach(function(e){e.classList.remove(TC.Consts.classes.CHECKED);e.classList.remove(TC.Consts.classes.DISABLED);e.classList.remove(TC.Consts.classes.FROMLEFT);e.classList.remove(TC.Consts.classes.FROMRIGHT)});o.querySelectorAll("."+t.CLASS+"-features table").forEach(function(e){e.setAttribute("title",t.getLocaleString("clickToShowOnMap"))})};o._fitSize=function(){const e=this.getDisplayTarget();var t=0;e.querySelectorAll(".tc-ctl-finfo-features li").forEach(function(e){t=Math.max(t,e.offsetLeft+e.offsetWidth)});t&&(e.style.width=t+50+"px")};o._resetSize=function(){this.getDisplayTarget().style.removeProperty("width")};o.getFeature=function(e,t,n){var s;const r=this.info;r&&r.services&&(s=r.services[e])&&(s=s.layers[t])&&(s=s.features[n]);return s};o.getFeatureIndex=function(e,t,n){var s=-1;const r=this.info;if(r)for(var o=0;o<=e;o++)for(var l=r.services[o],a=o===e?t:l.layers.length-1,i=0;i<=a;i++)for(var c=l.layers[i],u=i===t?n:c.features.length-1,f=0;f<=u;f++)s+=1;return s};o.beforeRequest=function(e){var t=this;t.querying=!0;t.map.trigger(TC.Consts.event.BEFOREFEATUREINFO,{xy:e.xy,control:t});t.closeResults();if(t.map&&t.resultsLayer){t.lastFeatureCount=null;t.resultsLayer.features.forEach(function(e){t.resultsLayer.removeFeature(e)});t.info=null}};o.activate=function(){this.wrap&&this.wrap.activate();TC.Control.prototype.activate.call(this)};o.deactivate=function(e){this.popup&&this.popup.hide();this.resultsLayer.clearFeatures();this.filterLayer.clearFeatures();this.wrap&&this.wrap.deactivate();TC.Control.prototype.deactivate.call(this,e)};o.exportState=function(){const e=this;return e.exportsState&&e.resultsLayer?{id:e.id,layer:e.resultsLayer.exportState()}:null};o.importState=function(e){const t=this;t._layersPromise.then(function(){t.resultsLayer.importState(e.layer)})};o._createLayers=function(){const e=this;var t,n;t=e.options.resultsLayer?e.options.resultsLayer:{id:e.getUID(),title:e.CLASS+": Results layer",type:TC.Consts.layerType.VECTOR,stealth:!0};n=e.options.filterLayer?e.options.filterLayer:{id:e.getUID(),title:e.CLASS+": Filter layer",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{line:{strokeColor:e.lineColor,strokeWidth:2},polygon:{strokeColor:e.lineColor,strokeWidth:2,fillColor:"#000",fillOpacity:.3}}};const s=e.map;e._layersPromise=new Promise(function(r,o){s.loaded(function(){Promise.all([s.addLayer(t),s.addLayer(n)]).then(function(t){e.resultsLayer=t[0];e.filterLayer=t[1];r()})})});return e._layersPromise};o._decorateDisplay=function(e){const t=this,n=t.getDisplayTarget({control:e});TC.loadJS(!TC.control.Print,[TC.apiLocation+"TC/control/Print"],function(){if(!n.querySelectorAll("."+TC.control.Print.prototype.CLASS+"-btn").length){var s=t.getLocaleString("feature");if(e===t.getDisplayControl())if(TC.feature.Point&&t.filterFeature instanceof TC.feature.Point){const e=t.filterFeature.geometry;s=t.getLocaleString("featuresAt",{crs:t.map.crs,x:TC.Util.formatNumber(e[0],t.map.locale),y:TC.Util.formatNumber(e[1],t.map.locale)})}else s=t.getLocaleString("spatialQueryResults");else e.currentFeature&&(s=e.currentFeature.id);(t.lastFeatureCount||e.currentFeature&&!0===e.currentFeature.showsPopup)&&new TC.control.Print({target:n,title:s})}})};o._addSourceAttributes=function(){const e=this,t="h3_"+e.getLocaleString("service"),n="h4_"+e.getLocaleString("layer");e.info&&e.info.services&&e.info.services.forEach(function(s){s.layers.forEach(function(s){s.features.forEach(function(s){if(s instanceof TC.Feature){const r=e.getFeaturePath(s);if(r){const o={};o[t]=r.service;r.layer&&(o[n]=r.layer.join(e.TITLE_SEPARATOR));const l=$.extend(o,s.getData());s.clearData();s.setData(l)}}})})})}}();
//# sourceMappingURL=../maps/control/FeatureInfoCommons.min.js.map
