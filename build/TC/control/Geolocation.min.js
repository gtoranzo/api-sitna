Math.hypot=Math.hypot||function(){for(var t=0,e=arguments.length,a=0;a<e;a++){if(arguments[a]===1/0||arguments[a]===-1/0)return 1/0;t+=arguments[a]*arguments[a]}return Math.sqrt(t)};!function(){for(var t=0,e=["ms","moz","webkit","o"],a=!(!window.performance||!window.performance.now),n=0,o=e.length;n<o&&!window.requestAnimationFrame;n+=1){window.requestAnimationFrame=window[e[n]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[e[n]+"CancelAnimationFrame"]||window[e[n]+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(e,a){var n=(new Date).getTime(),o=Math.max(0,16-(n-t)),i=window.setTimeout(function(){e(n+o)},o);t=n+o;return i});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});if(!a){var i=window.requestAnimationFrame,r=+new Date;window.requestAnimationFrame=function(t,e){i(function(e){return t(e<1e12?e:e-r)},e)}}}();!function(){if(window.performance){if(window.performance&&!window.performance.now){window.performance.offset=Date.now();window.performance.now=function(){return Date.now()-window.performance.offset}}}else window.performance={offset:Date.now(),now:function(){return Date.now()-this.offset}}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Geolocation=function(t){this._classSelector="."+this.CLASS;this._layerPromises={};this.Const={Classes:{ACTIVE:"tc-ctl-geolocation-active",CLOSED:"closed",SELECTEDTRACK:"selectedTrack",DRAWACTIVATED:"draw-activated",SIMULATIONACTIVATED:"simulation-activated"},Selector:{SIMULATE:".tc-btn-simulate",DRAW:".tc-draw",EDIT:".tc-btn-edit",DELETE:".tc-btn-delete",SAVE:".tc-btn-save",CANCEL:".tc-btn-cancel",EXPORT:".tc-btn-export",STOP:".tc-btn-stop",PAUSE:".tc-btn-pause",BACKWARD:".tc-btn-backward",FORWARD:".tc-btn-forward",SPEED:".tc-spn-speed"},LocalStorageKey:{TRACKING:"trk",TRACKINGTEMP:"trktemp",TRACKINGSHOWADVERTISEMENT:"trkAdvertisement",GPSSHOWADVERTISEMENT:"gpsAdvertisement",TEST:"test"},Message:{VALIDATENAME:""},Event:{POSITIONCHANGE:"positionchange.tc.geolocation",GPSPOSITIONCHANGE:"gpspositionchange.tc.geolocation",GPSPOSITIONERROR:"positionerror.tc.geolocation",STATEUPDATED:"stateupdated.tc.geolocation",GPSADD:"gpsadd.tc.geolocation",TRACKSNAPPING:"tracksnapping.tc.geolocation",DRAWTRACK:"drawtrack.tc.geolocation",CLEARTRACK:"cleartrack.tc.geolocation",IMPORTEDTRACK:"importedtrack.tc.geolocation"},MimeMap:{KML:"application/vnd.google-earth.kml+xml",GPX:"application/gpx+xml"},SupportedFileExtensions:[".kml",".gpx"],Tabs:{GPS:"gps"},Layers:{GPS:"gps",TRACK:"track",TRACKING:"tracking"}};TC.Control.apply(this,arguments);var e=t||{};this._dialogDiv=TC.Util.getDiv(e.dialogDiv);window.$&&(this._$dialogDiv=$(this._dialogDiv));e.dialogDiv||document.body.appendChild(this._dialogDiv);this.delta=500;this.walkingSpeed=5e3;this.gapHill=this.options.gapHill||20;this.snappingTolerance=this.options.snappingTolerance||50;this.exportsState=!0;this.storageCRS="EPSG:4326"};TC.inherit(TC.control.Geolocation,TC.Control);!function(){var t=TC.control.Geolocation.prototype;t.CLASS="tc-ctl-geolocation";t.CHART_SIZE={MIN_HEIGHT:75,MAX_HEIGHT:128,MIN_WIDTH:300,MEDIUM_WIDTH:310,MAX_WIDTH:445};t.featuresToShare=[];TC.Consts.event.TOOLSCLOSE=TC.Consts.event.TOOLSCLOSE||"toolsclose.tc";TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc";t.template={};t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"geo"}).w('</h2><div class="tc-ctl-geolocation-content">    <div class="tc-ctl-geolocation-track"><div class="tc-ctl-geolocation-track-snap-info"></div>        \x3c!-- img se insertan en el div del mapa--\x3e        <div id="tc-ctl-geolocation-track-elevation-marker" class="tc-ctl-geolocation-trackMarker elevation" style="display: none;"></div><div class="tc-ctl-geolocation-track-panel-block" ><input id="tc-ctl-geolocation-track-panel-opened-').f(e.get(["controlId"],!1),e,"h").w('" type="checkbox" checked/><label for="tc-ctl-geolocation-track-panel-opened-').f(e.get(["controlId"],!1),e,"h").w('" title="').h("i18n",e,{},{$key:"geo.trk.panel.help.1"}).w('">').h("i18n",e,{},{$key:"geo.trk.panel.help.2"}).w('</label><i class="tc-ctl-geolocation-track-panel-help icon-question-sign" title="').h("i18n",e,{},{$key:"geo.trk.panel.help.3"}).w('"></i></div><div class="tc-ctl-geolocation-track-mng"><div class="tc-ctl-geolocation-select"><form>                    <label class="tc-ctl-geolocation-btn-track" title="').h("i18n",e,{},{$key:"geo.track.title"}).w('"><input type="radio" name="mode" checked value="tracks" /><span>').h("i18n",e,{},{$key:"geo.gps"}).w('</span></label><label  class="tc-ctl-geolocation-btn-tracks" title="').h("i18n",e,{},{$key:"geo.tracks.title"}).w('"><input type="radio" name="mode" value="track-available" /><span>').h("i18n",e,{},{$key:"geo.tracks"}).w('</span></label>                    </form></div>                        <div  class="tc-ctl-geolocation-track-available tc-ctl-geolocation-track-cnt tc-ctl-geolocation-panel tc-hidden"><i class="tc-ctl-geolocation-track-search-icon"></i><input id="tc-ctl-geolocation-track-available-srch" type="search" list="tc-ctl-geolocation-track-available-lst" class="tc-ctl-geolocation-track-available-srch tc-textbox" placeholder="').h("i18n",e,{},{$key:"geo.filter.plhr"}).w('" maxlength="200" />                <ol id="tc-ctl-geolocation-track-available-lst" class="tc-ctl-geolocation-track-available-lst"><li class="tc-ctl-geolocation-track-available-empty"><span>').h("i18n",e,{},{$key:"geo.noTracks"}).w('</span></li><li class="tc-ctl-geolocation-track-not" hidden><span>').h("i18n",e,{},{$key:"noMatches"}).w('</span></li></ol><div class="tc-ctl-geolocation-track-cnt"><input name="uploaded-file" id="uploaded-file-').f(e.get(["controlId"],!1),e,"h").w('" type="file" class="tc-ctl-geolocation-track-import tc-button" accept=".gpx,.kml" disabled /><label class="tc-button tc-icon-button" for="uploaded-file-').f(e.get(["controlId"],!1),e,"h").w('" title="').h("i18n",e,{},{$key:"geo.trk.import.upload"}).w('">').h("i18n",e,{},{$key:"geo.trk.import.lbl"}).w('</label></div></div><div class="tc-ctl-geolocation-tracks tc-ctl-geolocation-panel">    <div class="tc-alert alert-warning tc-hidden" ><p id="panel-msg">').h("i18n",e,{},{$key:"geo.trk.panel.1"}).w("                    <ul><li>").h("i18n",e,{},{$key:"geo.trk.panel.2"}).w("</li><li>").h("i18n",e,{},{$key:"geo.trk.panel.3"}).w("</li><li>").h("i18n",e,{},{$key:"geo.trk.panel.4"}).w("</li><li>").h("i18n",e,{},{$key:"geo.trk.panel.5"}).w('</li></ul></p></div>            <div class="tc-ctl-geolocation-track-ui">   <div  class="tc-ctl-geolocation-track-render"><input id="tc-ctl-geolocation-track-render-').f(e.get(["controlId"],!1),e,"h").w('" type="checkbox" hidden checked /><label for="tc-ctl-geolocation-track-render-').f(e.get(["controlId"],!1),e,"h").w('" class="tc-ctl-geolocation-track-render" title="').h("i18n",e,{},{$key:"geo.trk.render"}).w('">').h("i18n",e,{},{$key:"geo.trk.render"}).w('</label></div><button class="tc-button tc-icon-button tc-ctl-geolocation-track-ui-activate" title="').h("i18n",e,{},{$key:"geo.track.activate.title"}).w('">').h("i18n",e,{},{$key:"geo.track.activate"}).w('</button><button class="tc-button tc-icon-button tc-ctl-geolocation-track-ui-deactivate tc-hidden" title="').h("i18n",e,{},{$key:"geo.track.deactivate.title"}).w('">').h("i18n",e,{},{$key:"geo.track.deactivate"}).w('</button></div><div  class="tc-ctl-geolocation-track-current tc-ctl-geolocation-track-cnt"><input type="text" class="tc-ctl-geolocation-track-title tc-textbox" disabled placeholder="').h("i18n",e,{},{$key:"geo.trk.name.plhr"}).w('" maxlength="200" /><button class="tc-button tc-icon-button tc-ctl-geolocation-track-save" disabled title="').h("i18n",e,{},{$key:"geo.trk.name.save"}).w('"></button><input type="text" class="tc-ctl-geolocation-track-waypoint tc-textbox" disabled placeholder="').h("i18n",e,{},{$key:"geo.trk.wyp.plhr"}).w('" maxlength="200" /><button class="tc-button tc-icon-button tc-ctl-geolocation-track-add-wpt" disabled title="').h("i18n",e,{},{$key:"geo.trk.wyp.save"}).w('"></button></div></div></div></div></div><div class="tc-ctl-geolocation-track-center tc-hidden"><button title="').h("i18n",e,{},{$key:"geo.trk.center"}).w('"></button></div>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-track-node"]=function(){dust.register(t.CLASS+"-track-node",e);function e(t,e){return t.w('<li data-id="').f(e.get(["id"],!1),e,"h").w('" data-uid="').f(e.get(["uid"],!1),e,"h").w('"><span class="tc-draw tc-selectable" title="').f(e.get(["name"],!1),e,"h").w('">').f(e.get(["name"],!1),e,"h").w('</span><input class="tc-textbox tc-hidden" type="text" value="').f(e.get(["name"],!1),e,"h").w('" />    <button class="tc-btn-simulate" title="').h("i18n",e,{},{$key:"tr.lst.simulate"}).w('"></button><button hidden class="tc-btn-stop" title="').h("i18n",e,{},{$key:"tr.lst.stop"}).w('"></button><button class="tc-btn-edit" title="').h("i18n",e,{},{$key:"tr.lst.edit"}).w('"></button><button hidden class="tc-btn-pause" title="').h("i18n",e,{},{$key:"tr.lst.pause"}).w('"></button>    <button hidden class="tc-btn-backward" title="').h("i18n",e,{},{$key:"tr.lst.backward"}).w('"></button><label hidden class="tc-spn-speed" title="').h("i18n",e,{},{$key:"tr.lst.velocity"}).w('"></label><button hidden class="tc-btn-forward" title="').h("i18n",e,{},{$key:"tr.lst.forward"}).w('"></button>        <button class="tc-btn-save tc-hidden" title="').h("i18n",e,{},{$key:"save"}).w('"></button><button class="tc-btn-cancel tc-hidden" title="').h("i18n",e,{},{$key:"tr.lst.cancel"}).w('"></button><button class="tc-btn-delete" title="').h("i18n",e,{},{$key:"tr.lst.delete"}).w('"></button><button class="tc-btn-export" title="').h("i18n",e,{},{$key:"download"}).w('"></button>    </li>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-track-snapping-node"]=function(){dust.register(t.CLASS+"-track-snapping-node",e);function e(t,e){return t.w("<ul>").x(e.get(["n"],!1),e,{block:a},{}).w("<li> <span>").x(e.get(["isGeo"],!1),e,{else:n,block:o},{}).w(":</span> ").f(e.get(["x"],!1),e,"h").w("</li><li> <span>").x(e.get(["isGeo"],!1),e,{else:i,block:r},{}).w(":</span> ").f(e.get(["y"],!1),e,"h").w(" </li>").x(e.get(["z"],!1),e,{block:s},{}).x(e.get(["m"],!1),e,{block:l},{}).w("</ul>")}e.__dustBody=!0;function a(t,e){return t.w("<li><span>").h("i18n",e,{},{$key:"geo.trk.snapping.name"}).w(":</span> ").f(e.get(["n"],!1),e,"h").w("</li>")}a.__dustBody=!0;function n(t,e){return t.w("X")}n.__dustBody=!0;function o(t,e){return t.h("i18n",e,{},{$key:"lon"})}o.__dustBody=!0;function i(t,e){return t.w("Y")}i.__dustBody=!0;function r(t,e){return t.h("i18n",e,{},{$key:"lat"})}r.__dustBody=!0;function s(t,e){return t.h("ne",e,{block:c},{key:e.get(["z"],!1),value:0})}s.__dustBody=!0;function c(t,e){return t.w("<li> <span>Z:</span> ").f(e.get(["z"],!1),e,"h").w(" </li>")}c.__dustBody=!0;function l(t,e){return t.w("<li> ").f(e.get(["m"],!1),e,"h").w(" </li>")}l.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-geolocation-continue-track-dialog tc-modal" ><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"geo.gps"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"><button class="tc-button tc-ctl-geolocation-track-continue"> ').h("i18n",e,{},{$key:"geo.trk.dialog.cnt"}).w(' </button><button class="tc-button tc-ctl-geolocation-track-new"> ').h("i18n",e,{},{$key:"geo.trk.dialog.new"}).w(' </button>            <button class="tc-button tc-modal-close"> ').h("i18n",e,{},{$key:"geo.trk.dialog.cancel"}).w(' </button></div></div></div><div class="tc-ctl-geolocation-track-advert-dialog tc-modal" ><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"geo.track.activate.title"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"><p id="pageBlurMsg">').h("i18n",e,{},{$key:"geo.trk.page.blur"}).w('</p><p class="tc-ctl-geolocation-track-advertisement p">                <label> <input type="checkbox" name="checkbox" id="advertisement"> ').h("i18n",e,{},{$key:"geo.trk.dialog.advertisement"}).w(' </label>        </p></div><div class="tc-modal-footer"><button class="tc-button tc-ctl-geolocation-track-advert-ok"> ').h("i18n",e,{},{$key:"ok"}).w(" </button></div></div></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-tracking-toast"]=function(){dust.register(t.CLASS+"-tracking-toast",e);function e(t,e){return t.w('<table class="tc-ctl-geolocation-info-tracking"><tr><th>').x(e.get(["isGeo"],!1),e,{else:a,block:n},{}).w(":</th><td> ").f(e.get(["x"],!1),e,"h").w(" </td>").x(e.get(["accuracy"],!1),e,{block:o},{}).w("</tr><tr><th>").x(e.get(["isGeo"],!1),e,{else:i,block:r},{}).w(":</th><td> ").f(e.get(["y"],!1),e,"h").w(" </td>").x(e.get(["speed"],!1),e,{block:s},{}).w("</tr><tr>").x(e.get(["z"],!1),e,{block:c},{}).x(e.get(["mdt"],!1),e,{block:u},{}).w("</tr>    </table>")}e.__dustBody=!0;function a(t,e){return t.w("X")}a.__dustBody=!0;function n(t,e){return t.h("i18n",e,{},{$key:"lon"})}n.__dustBody=!0;function o(t,e){return t.w("<th>").h("i18n",e,{},{$key:"geo.trk.accuracy"}).w(":</th><td> ").f(e.get(["accuracy"],!1),e,"h").w(" m </td>")}o.__dustBody=!0;function i(t,e){return t.w("Y")}i.__dustBody=!0;function r(t,e){return t.h("i18n",e,{},{$key:"lat"})}r.__dustBody=!0;function s(t,e){return t.w("<th>").h("i18n",e,{},{$key:"geo.trk.speed"}).w(":</th><td>").f(e.get(["speed"],!1),e,"h").w(" km/h</td>")}s.__dustBody=!0;function c(t,e){return t.w("<th>").x(e.get(["isGeo"],!1),e,{else:l,block:d},{}).w(":</th><td> ").f(e.get(["z"],!1),e,"h").w(" m </td>")}c.__dustBody=!0;function l(t,e){return t.w("Z")}l.__dustBody=!0;function d(t,e){return t.h("i18n",e,{},{$key:"ele"})}d.__dustBody=!0;function u(t,e){return t.w('<th title="').h("i18n",e,{},{$key:" mdt.title"}).w('">').h("i18n",e,{},{$key:"ele"}).w(" (").h("i18n",e,{},{$key:"mdt"}).w("):</th><td>").f(e.get(["mdt"],!1),e,"h").w(" m </td>")}u.__dustBody=!0;return e};var e=function(t){const e=this;t.layer;t.layer===e.layerTrack&&e.clearSelection()};t.register=function(t){const e=this,a=TC.Control.prototype.register.call(e,t);e.wrap=new TC.wrap.control.Geolocation(e);e.wrap.register(t);t.addLayer({id:e.getUID(),type:TC.Consts.layerType.VECTOR,owner:e,stealth:!0,title:"Posicionar.GPS"}).then(function(t){e.layerGPS=t});t.addLayer({id:e.getUID(),type:TC.Consts.layerType.VECTOR,owner:e,stealth:!0,title:"Posicionar.Tracking",styles:{point:{radius:3,fillColor:"#00ced1",fillOpacity:function(){return this.track.renderTrack.checked?1:0}.bind(e),strokeColor:"#ffffff",fontColor:"#00ced1",labelOutlineColor:"#ffffff",labelOutlineWidth:1,label:function(t){var e=t.getData().name;return e=e&&(e+"").trim().length>0?(e+"").trim().toLowerCase():""}},line:{strokeOpacity:function(){return this.track.renderTrack.checked?1:0}.bind(e),strokeWidth:2,strokeColor:"#00ced1",lineDash:[.1,6]}}}).then(function(t){e.layerTracking=t});t.addLayer({id:e.getUID(),type:TC.Consts.layerType.VECTOR,owner:e,stealth:!0,title:"Posicionar.Track",styles:{line:{strokeWidth:2,strokeColor:"#C52737"},point:{radius:function(t){var e=t.getData().name;return e&&(e+"").trim().length>0?3:6},fillColor:"#C52737",strokeColor:"#ffffff",fontColor:"#C52737",fontSize:10,labelOutlineColor:"#ffffff",labelOutlineWidth:2,label:function(t){var e=t.getData().name;return e=e&&(e+"").trim().length>0?(e+"").trim().toLowerCase():""}}}}).then(function(t){e.layerTrack=t});t.on(TC.Consts.event.FEATURESIMPORT,function(t){const e=this,a=t.fileName,n=t.dropTarget;var o="."+TC.Consts.format.KML.toLowerCase(),i="."+TC.Consts.format.GPX.toLowerCase();if(a.toLowerCase().indexOf(i)===a.length-i.length||a.toLowerCase().indexOf(o)===a.length-o.length&&n===e){e.clear(e.Const.Layers.TRACK);e.importTrack(t);/.kml$/g.test(a.toLowerCase())&&e.layerTrack&&e.layerTrack.styles&&e.layerTrack.features.forEach(function(t){t instanceof TC.feature.Point&&e.layerTrack.styles.point?t.setStyle(e.layerTrack.styles.point):t instanceof TC.feature.Polyline&&e.layerTrack.styles.line&&t.setStyle(e.layerTrack.styles.line)})}}.bind(e));t.on(TC.Consts.event.PROJECTIONCHANGE,function(t){e.elevationChartData&&(e.elevationChartData.coords=TC.Util.reproject(e.elevationChartData.coords,t.oldCrs,t.newCrs))});return a};t.render=function(t){const e=this;return e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._dialogDiv.innerHTML=t}).then(function(){return e.renderData({controlId:e.id},t)})};t.importTrack=function(t){var a=this;a.map.off(TC.Consts.event.FEATUREREMOVE,e);if(a.isDisabled)/.gpx$/g.test(t.fileName.toLowerCase())&&a.map.toast(a.getLocaleString("geo.trk.import.disabled"),{type:TC.Consts.msgType.WARNING});else if(t.fileName&&t.features&&t.features.length>0){var n=a.getLoadingIndicator().addWait();a.importedFileName=t.fileName;const e=[];for(var o=0,i=t.features.length;o<i;o++)e.push(a.layerTrack.addFeature(t.features[o]));Promise.all(e).then(function(){a.wrap.processImportedFeatures({wait:n,notReproject:t.notReproject});if(a.layerTrack){a.map&&a.map.layout&&a.map.layout.accordion&&a.div.classList.contains(TC.Consts.classes.COLLAPSED)&&a.map.controls.filter(function(t){return t!==a&&!t.containerControl}).forEach(function(t){t.div.classList.add(TC.Consts.classes.COLLAPSED)});a.div.classList.remove(TC.Consts.classes.COLLAPSED);a.div.querySelector("."+a.CLASS+"-btn-tracks > span").click();t.isShared||a.map.trigger(TC.Consts.event.TOOLSOPEN)}})}};t.prepareFeaturesToShare=function(t){const e=this;return new Promise(function(a,n){if(t){var o=e.availableTracks.filter(function(e){return e.uid.toString()===t.toString()})[0].data,i=Math.pow(10,TC.Consts.DEGREE_PRECISION+1),r=(new ol.format.GeoJSON).readFeatures(o);const n=new Array(r.length);r.forEach(function(t,e){n[e]=TC.wrap.Feature.createFeature(t)});Promise.all(n).then(function(t){e.featuresToShare=t.map(function(t){const e={};switch(!0){case TC.feature.Marker&&t instanceof TC.feature.Marker:e.type=TC.Consts.geom.MARKER;break;case TC.feature.Point&&t instanceof TC.feature.Point:e.type=TC.Consts.geom.POINT;break;case TC.feature.Polyline&&t instanceof TC.feature.Polyline:e.type=TC.Consts.geom.POLYLINE;break;case TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline:e.type=TC.Consts.geom.MULTIPOLYLINE}e.id=t.id;e.geom=TC.Util.compactGeometry(t.geometry,i);e.data=t.getData();return e});a()})}else a()})};var a=!0;t.renderData=function(r,s){const c=this;var l=c.Const.Selector;return TC.Control.prototype.renderData.call(c,r,function(){const r=c.div.querySelectorAll(c._classSelector+"-panel");c.div.querySelectorAll("."+c.CLASS+"-select span").forEach(function(t){t.addEventListener(TC.Consts.event.CLICK,function(t){for(var e=t.target;e&&"LABEL"!==e.tagName;)e=e.parentElement;const a=e.querySelector("input[type=radio][name=mode]").value;r.forEach(function(t){t.classList.toggle(TC.Consts.classes.HIDDEN,!t.matches("."+c.CLASS+"-"+a))})})});c.track={activateButton:c.div.querySelector(c._classSelector+"-track-ui-activate"),deactivateButton:c.div.querySelector(c._classSelector+"-track-ui-deactivate"),trackSearch:c.div.querySelector(c._classSelector+"-track-available-srch"),trackImportFile:c.div.querySelector(c._classSelector+"-track-import"),trackSave:c.div.querySelector(c._classSelector+"-track-save"),trackAdd:c.div.querySelector(c._classSelector+"-track-add-wpt"),trackContinue:c._dialogDiv.querySelector(".tc-ctl-geolocation-track-continue"),trackRenew:c._dialogDiv.querySelector(".tc-ctl-geolocation-track-new"),trackClose:c._dialogDiv.querySelector(".tc-ctl-geolocation-continue-track-dialog button.tc-modal-close"),trackAdvertisementOK:c._dialogDiv.querySelector(".tc-ctl-geolocation-track-advert-ok")};c.track.trackList=c.div.querySelector(c._classSelector+"-track-available-lst");c.track.trackToolPanelOpened=c.div.querySelector("#tc-ctl-geolocation-track-panel-opened-"+c.id);c.div.querySelector("."+t.CLASS+"-track-panel-help").addEventListener("click",function(){i.call(c)});c.track.trackName=c.div.querySelector(c._classSelector+"-track-title");c.track.trackWPT=c.div.querySelector(c._classSelector+"-track-waypoint");TC.Util.detectMobile()&&matchMedia("screen and (max-height: 50em) and (max-width: 50em)").matches&&(c.track.trackToolPanelOpened.checked=!1);if(window.File&&window.FileReader&&window.FileList&&window.Blob){c.track.trackImportFile.disabled=!1;c.track.trackImportFile.addEventListener(TC.Consts.event.CLICK,function(t){const e=document.createElement("form"),a=this.parentElement;a.insertBefore(e,this);e.appendChild(this);e.reset();e.insertAdjacentElement("afterend",this);a.removeChild(e)});const t=function(){c.map.off(TC.Consts.event.LAYERERROR,t);c.clearFileInput(c.track.trackImportFile);TC.alert(c.getLocaleString("geo.trk.upload.error3"))};c.track.trackImportFile.addEventListener("change",function(e){if(!c._cleaning){c.clear(c.Const.Layers.TRACK);if(c.map){c.map.on(TC.Consts.event.LAYERERROR,t);c.map.wrap.loadFiles(e.target.files,{control:c})}}})}else console.log("no es posible la importaci\xf3n");c.track.activateButton.addEventListener("click",function(){c.activateTracking();n.call(c)});c.track.deactivateButton.addEventListener("click",function(){c.deactivateTracking();o.call(c)});const u=function(){!function(t){t=t.toLowerCase();const e=Array.from(c.track.trackList.querySelectorAll("li"));e.forEach(function(t){t.style.display="none"});const a=e.filter(function(t){return t.matches("li:not([class]),li."+c.Const.Classes.SELECTEDTRACK)}),n=c.div.querySelector(c._classSelector+"-track-search-icon");if(0===t.length){a.forEach(function(t){t.style.display=""});n.style.visibility="visible"}else{n.style.visibility="hidden";var o=new RegExp(t,"i");a.forEach(function(t){t.style.display=o.test(t.querySelector("span").textContent)?"":"none"});a.some(function(t){return""===t.style.display})||e.forEach(function(t){t.matches('[class^="tc-ctl-geolocation-track-not"]')&&(t.style.display="")})}}(this.value.toLowerCase().trim())};c.track.trackSearch.addEventListener("keyup",u);c.track.trackSearch.addEventListener("search",u);c.track.trackSave.addEventListener("click",c.saveTrack.bind(c));c.track.trackAdd.addEventListener("click",c.addWaypoint.bind(c));const A=c.div.querySelector(c._classSelector+"-track-available-lst");var g=function(t,e){"LI"!==e.tagName&&(e=e.parentElement);const a=e.querySelector("input"),n=e.querySelector("span");if(t){a.classList.remove(TC.Consts.classes.HIDDEN);a.focus();a.value=n.textContent;n.classList.add(TC.Consts.classes.HIDDEN);e.querySelector(l.SIMULATE).classList.add(TC.Consts.classes.HIDDEN);e.querySelector(l.EDIT).classList.add(TC.Consts.classes.HIDDEN);e.querySelector(l.DELETE).classList.add(TC.Consts.classes.HIDDEN);e.querySelector(l.DRAW).classList.add(TC.Consts.classes.HIDDEN);e.querySelector(l.EXPORT).classList.add(TC.Consts.classes.HIDDEN);e.querySelector(l.SAVE).classList.remove(TC.Consts.classes.HIDDEN);e.querySelector(l.CANCEL).classList.remove(TC.Consts.classes.HIDDEN)}else{a.classList.add(TC.Consts.classes.HIDDEN);n.classList.remove(TC.Consts.classes.HIDDEN);e.querySelector(l.SIMULATE).classList.remove(TC.Consts.classes.HIDDEN);e.querySelector(l.EDIT).classList.remove(TC.Consts.classes.HIDDEN);e.querySelector(l.DELETE).classList.remove(TC.Consts.classes.HIDDEN);e.querySelector(l.DRAW).classList.remove(TC.Consts.classes.HIDDEN);e.querySelector(l.EXPORT).classList.remove(TC.Consts.classes.HIDDEN);e.querySelector(l.SAVE).classList.add(TC.Consts.classes.HIDDEN);e.querySelector(l.CANCEL).classList.add(TC.Consts.classes.HIDDEN)}};c.uiSimulate=function(t,e){if(e){var a=[l.SIMULATE,l.EDIT,l.DELETE,l.EXPORT],n=[l.STOP,l.PAUSE,l.BACKWARD,l.FORWARD,l.SPEED],o="LI"===e.tagName?e:e.parentNode;a.forEach(function(e){o.querySelector(e).hidden=t});n.forEach(function(e){o.querySelector(e).hidden=!t})}};A.addEventListener("click",TC.EventTarget.listenerBySelector(l.SIMULATE,function(t){var e=c.getLoadingIndicator().addWait();t.target.parentElement.querySelector(l.SPEED).textContent="x 1";p(c,t.target).then(function(){c.getLoadingIndicator().removeWait(e)})}));A.addEventListener("click",TC.EventTarget.listenerBySelector(l.DRAW,function(t){var e=c.getLoadingIndicator().addWait();f(c,t.target).then(function(){c.getLoadingIndicator().removeWait(e)})}));c.on(c.Const.Event.IMPORTEDTRACK,function(t){if(c.isDisabled)c.map.toast(c.getLocaleString("geo.trk.import.disabled"),{type:TC.Consts.msgType.WARNING});else{const e=c.track.trackList.querySelector('li[data-id="'+t.index+'"]');f(c,e.querySelector(l.DRAW));setTimeout(function(){c.track.trackList.scrollTop=t.index*e.offsetHeight},100)}});const h=function(t,e){t.track.trackList.querySelectorAll("li[data-id]").forEach(function(a){if(a.dataset.id!==e){const e=a.querySelector(l.SIMULATE),n=a.querySelector(l.PAUSE);e.classList.remove(t.Const.Classes.SIMULATIONACTIVATED);e.setAttribute("title",t.getLocaleString("tr.lst.simulate"));n.classList.remove("play");n.setAttribute("title",t.getLocaleString("tr.lst.pause"));t.uiSimulate(!1,a);g(!1,a)}});t.clear(t.Const.Layers.TRACK)};var f=function(t,a){return new Promise(function(n,o){const i=a.parentElement;setTimeout(function(){if(i.classList.contains(t.Const.Classes.SELECTEDTRACK)){t.uiSimulate(!1,a);t.clear(t.Const.Layers.TRACK);t.map.off(TC.Consts.event.FEATUREREMOVE,e);a.setAttribute("title",a.textContent)}else if(t.getSelectedTrack()){h(t,i.dataset.id);t.drawTrack(i)}else t.drawTrack(i);i.classList.contains(t.Const.Classes.SELECTEDTRACK)?t.prepareFeaturesToShare(i.dataset.uid).then(function(){n()}):n()},0)})},p=function(t,e){return new Promise(function(a,n){setTimeout(function(){const n=e.parentElement;h(t,n.dataset.id);t.uiSimulate(!1,t.getSelectedTrack());t.uiSimulate(!0,e);t.simulate_paused=!1;t.simulateTrack(n);a()},0)})};A.addEventListener("click",TC.EventTarget.listenerBySelector(c._classSelector+" "+l.EDIT,function(t){g(!0,t.target)}));A.addEventListener("click",TC.EventTarget.listenerBySelector(c._classSelector+" "+l.DELETE,function(t){c.removeTrack(t.target.parentElement)}));A.addEventListener("click",TC.EventTarget.listenerBySelector(c._classSelector+" "+l.SAVE,function(t){if(0===t.target.parentElement.querySelector("input").value.trim().length)TC.alert(c.getLocaleString("geo.trk.edit.alert"));else{c.editTrackName(t.target.parentElement.dataset.id,t.target.parentElement.querySelector("input").value);g(!1,t.target)}}));A.addEventListener("click",TC.EventTarget.listenerBySelector(c._classSelector+" "+l.CANCEL,function(t){g(!1,t.target)}));A.addEventListener("click",TC.EventTarget.listenerBySelector(c._classSelector+" "+l.EXPORT,function(t){const e=t.target.parentElement;t.target.setAttribute("disabled","");c.export(e).then(a=>{c.getDownloadDialog().then(function(n){var o=e.querySelector("span").textContent,i=new RegExp(c.Const.SupportedFileExtensions.join("|"),"gi"),r=o.replace(i,"");const s={title:c.getLocaleString("download"),fileName:r,elevation:{resolution:20,sampleNumber:200}};n.open(a,s);t.target.removeAttribute("disabled")})})}));A.addEventListener("click",TC.EventTarget.listenerBySelector(c._classSelector+" "+l.STOP,function(t){c.uiSimulate(!1,t.target);c.wrap.simulateTrackEnd();const e=t.target.parentElement.querySelector(l.PAUSE);e.classList.remove("play");e.setAttribute("title",c.getLocaleString("tr.lst.pause"));t.target.parentElement.querySelector(l.SPEED).textContent="x 1";c.simulate_speed=1}));A.addEventListener("click",TC.EventTarget.listenerBySelector(c._classSelector+" "+l.PAUSE,function(t){c.simulate_paused=!t.target.classList.contains("play");c.simulate_paused&&(c.simulate_pausedElapse=-1);t.target.setAttribute("title",c.getLocaleString(c.simulate_paused?"tr.lst.play":"tr.lst.pause"));t.target.classList.toggle("play",!!c.simulate_paused)}));A.addEventListener("click",TC.EventTarget.listenerBySelector(c._classSelector+" "+l.BACKWARD,function(t){1==c.simulate_speed?c.simulate_speed=.5:c.simulate_speed=c.simulate_speed/2;t.target.parentElement.querySelector(c._classSelector+" "+l.FORWARD).disabled=!1;t.target.parentElement.querySelector(l.SPEED).textContent=c.simulate_speed<1?"/ "+1/c.simulate_speed:"x "+c.simulate_speed;.000244140625==c.simulate_speed&&(t.target.disabled=!0)}));A.addEventListener("click",TC.EventTarget.listenerBySelector(c._classSelector+" "+l.FORWARD,function(t){c.simulate_speed=c.simulate_speed/.5;t.target.parentElement.querySelector(l.SPEED).textContent=c.simulate_speed<1?"/ "+1/c.simulate_speed:"x "+c.simulate_speed;t.target.parentElement.querySelector(c._classSelector+" "+l.BACKWARD).disabled=!1;4096==c.simulate_speed&&(t.target.disabled=!0)}));c.track.trackContinue.addEventListener("click",function(){TC.Util.closeModal();d.call(c)});c.track.trackRenew.addEventListener("click",function(){delete c.sessionTracking;TC.Util.storage.setSessionLocalValue(c.Const.LocalStorageKey.TRACKINGTEMP,void 0);localforage.removeItem(c.Const.LocalStorageKey.TRACKINGTEMP);TC.Util.closeModal();d.call(c)});c.track.trackClose.addEventListener("click",function(){o.call(c)});c.track.trackAdvertisementOK.addEventListener("click",function(){const t=document.body.querySelectorAll('input[name*="Advertisement"]:checked');if(t.length>0){new Promise(function(t,e){window.localforage?t():TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){t()})}).then(function(){localforage.setItem(t[0].getAttribute("name"),!1)})}TC.Util.closeModal()});c.track.renderTrack=document.querySelector("#tc-ctl-geolocation-track-render-"+c.id);c.track.renderTrack.addEventListener("change",function(){c.track.activateButton.classList.contains(TC.Consts.classes.HIDDEN)&&c.layerTracking.setVisibility(this.checked);a=this.checked});window.localforage?c.bindTracks():TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){c.bindTracks()});TC.Util.isFunction(s)&&s()})};t.activate=function(){};t.deactivate=function(){TC.Util.closeModal();this.clearSelection();this.deactivateTracking()};var n=function(){this.track.activateButton.classList.add(TC.Consts.classes.HIDDEN);this.track.deactivateButton.classList.remove(TC.Consts.classes.HIDDEN)},o=function(){this.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);this.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN)},i=function(){this.map.toast(this.div.querySelector(".alert-warning").innerHTML,{duration:1e4})};t.markerStyle={radius:7,fillColor:[255,0,0,100],strokeColor:[255,255,255,255],strokeWidth:2};t.lineStyle={strokeWidth:2,strokeColor:[0,206,209,255]};t.setFormatInfoNewPosition=function(t){var e={},a=TC.Util.getMapLocale(this.map);if(this.map.on3DView){var n=this.map.crs!==this.map.view3D.crs?TC.Util.reproject(t.position,this.map.crs,this.map.view3D.crs):t.position;e.x=n[0].toLocaleString(a);e.y=n[1].toLocaleString(a);e.mdt=Math.round(this.map.view3D.getHeightFromMDT(n)).toLocaleString(a);e.isGeo=!0}else{e.x=Math.round(t.position[0]).toLocaleString(a);e.y=Math.round(t.position[1]).toLocaleString(a)}e.z=Math.round(t.altitude).toLocaleString(a);e.accuracy=Math.round(t.accuracy).toLocaleString(a);e.speed=t.speed.toLocaleString(a,{minimumFractionDigits:1,maximumFractionDigits:1});return e};t.renderInfoNewPosition=function(t){var e=this;e.getRenderedHtml(e.CLASS+"-tracking-toast",e.setFormatInfoNewPosition(t.pd),function(t){if(e.track.infoPanel)"boolean"==typeof e.track.infoPanel||e.track.infoPanel.isMinimized()||e.track.infoPanel.renderPromise().then(function(){e.track.infoPanel.getTableContainer().innerHTML=t;e.track.infoPanel.isVisible()||e.track.infoPanel.doVisible()});else{e.track.infoPanel=!0;var a,n={content:"table",titles:{main:e.getLocaleString("geo.mylocation"),max:e.getLocaleString("geo.mylocation.show")},classes:{collapsed:"tracking"}};const i=function(t){n.position=t.POSITION.RIGHT;a=t.addControl("resultsPanel",n)};if(e.options.displayOn){var o=e.map.getControlsByClass("TC.control."+e.options.displayOn[0].toUpperCase()+e.options.displayOn.substring(1))[0];o?i(o):e.map.addControl(e.options.displayOn).then(i)}else{n.div=document.createElement("div");e.map.div.appendChild(n.div);a=e.map.addControl("resultsPanel",n)}a.then(function(a){e.map.getControlsByClass("TC.control.ResultsPanel").filter(function(t){return"table"===t.content&&t!==a}).forEach(function(t){t.close()});e.track.infoPanel=a;a.renderPromise().then(function(){a.open(t)})})}})};var r,s,c,l=function(){this.track.trackToolPanelOpened.checked||this.map.trigger(TC.Consts.event.TOOLSCLOSE)},d=function(){var t=this;t.activate();n.call(t);l.call(t);t.on(t.Const.Event.POSITIONCHANGE,function(e){t.currentPoint=e.pd;t.renderInfoNewPosition(e);t.track.trackName.disabled=!1;t.track.trackSave.disabled=!1;t.track.trackWPT.disabled=!1;t.track.trackAdd.disabled=!1;TC.Util.storage.setSessionLocalValue(t.Const.LocalStorageKey.TRACKINGTEMP,t.wrap.formattedToStorage(t.layerTracking).features)});t.on(t.Const.Event.STATEUPDATED,function(t){});t.clear(t.Const.Layers.TRACKING);p.call(t,t.Const.LocalStorageKey.TRACKINGSHOWADVERTISEMENT);t.wrap.setTracking(!0)},u=function(){this.videoScreenOn.paused&&this.videoScreenOn.play();f.apply(this)},A=function(){var t=function(){var t=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var e=0;e<t.length;e++)if(t[e]+"Hidden"in document)return t[e]+"Hidden";return null}();document[t]||u.apply(this);console.log("video is: "+this.videoScreenOn.paused)},g=function(){c||(c=A.bind(this));r||(r=function(){h.apply(this)}.bind(this));s||(s=u.bind(this));window.addEventListener("visibilitychange",c,!1);if(TC.Util.detectSafari()&&TC.browserFeatures.touch()&&!navigator.userAgent.match(/Android/i)&&!navigator.userAgent.match(/CriOS/i)){window.addEventListener("pagehide",r,!1);window.addEventListener("pageshow",s,!1)}else{window.addEventListener("blur",r,!1);window.addEventListener("focus",s,!1)}},h=function(){var t=TC.Util.storage.getSessionLocalValue(this.Const.LocalStorageKey.TRACKINGTEMP);t&&t.length>0&&localforage.setItem(this.Const.LocalStorageKey.TRACKINGTEMP,"string"==typeof t?t:JSON.stringify(t))},f=function(){var t=this;localforage.getItem(t.Const.LocalStorageKey.TRACKINGTEMP).then(function(e){null!==e&&"null"!==e&&e.length>0&&TC.Util.storage.setSessionLocalValue(t.Const.LocalStorageKey.TRACKINGTEMP,e)})},p=function(t){var e=this;new Promise(function(t,e){window.localforage?t():TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){t()})}).then(function(){localforage.getItem(t).then(function(a){if(null==a){const a=e._dialogDiv.querySelector(".tc-ctl-geolocation-track-advert-dialog"),n=a.querySelector('input[type="checkbox"]');n.setAttribute("name",t);n.checked=!1;document.querySelector("#pageBlurMsg").textContent=TC.Util.detectMobile()?e.getLocaleString("geo.trk.page.blur"):e.getLocaleString("geo.trk.page.blur.desktop");a.querySelector("h3").textContent=t==e.Const.LocalStorageKey.GPSSHOWADVERTISEMENT?e.getLocaleString("geo.track.activate")+" "+e.getLocaleString("geo.gps"):e.getLocaleString("geo.track.activate.title");TC.Util.showModal(e._dialogDiv.querySelector(".tc-ctl-geolocation-track-advert-dialog"))}})});e.map.toast(TC.Util.detectMobile()?e.getLocaleString("geo.trk.page.blur"):e.getLocaleString("geo.trk.page.blur.desktop"),{type:TC.Consts.msgType.WARNING})};t._askTracking=function(t){TC.Util.showModal(this._dialogDiv.querySelector(".tc-ctl-geolocation-continue-track-dialog"),{closeCallback:function(){TC.Util.isFunction(t)&&t()}});return!0};t.activateTracking=function(){var t=this,e=!0;t.isActive||t.activate();t.clear(t.Const.Layers.TRACKING);try{TC.Util.storage.setSessionLocalValue(t.Const.LocalStorageKey.TEST,t.Const.LocalStorageKey.TEST)}catch(a){a.code===DOMException.QUOTA_EXCEEDED_ERR?TC.alert(t.getLocaleString("geo.error.trackinglocalstorage")):TC.error(a);e=!1}if(e){(function(){if(!this.videoScreenOn){var t={WebM:"data:video/webm;base64,GkXfo0AgQoaBAUL3gQFC8oEEQvOBCEKCQAR3ZWJtQoeBAkKFgQIYU4BnQI0VSalmQCgq17FAAw9CQE2AQAZ3aGFtbXlXQUAGd2hhbW15RIlACECPQAAAAAAAFlSua0AxrkAu14EBY8WBAZyBACK1nEADdW5khkAFVl9WUDglhohAA1ZQOIOBAeBABrCBCLqBCB9DtnVAIueBAKNAHIEAAIAwAQCdASoIAAgAAUAmJaQAA3AA/vz0AAA=",MP4:"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAB8JbCAfCWwgAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAD3wlsIB8JbCAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAIAAAACAAAAAABsW1kaWEAAAAgbWRoZAAAAAB8JbCAfCWwgAAAA+gAAAAAVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW9IYW5kbGVyAAAAAVxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEcc3RibAAAALhzdHNkAAAAAAAAAAEAAACobXA0dgAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAIAAgASAAAAEgAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABj//wAAAFJlc2RzAAAAAANEAAEABDwgEQAAAAADDUAAAAAABS0AAAGwAQAAAbWJEwAAAQAAAAEgAMSNiB9FAEQBFGMAAAGyTGF2YzUyLjg3LjQGAQIAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAK2lsc3QAAAAjqXRvbwAAABtkYXRhAAAAAQAAAABMYXZmNTIuNzguMw=="};this.videoScreenOn=document.createElement("video");this.videoScreenOn.setAttribute("loop","");this.videoScreenOn.setAttribute("muted","");this.videoScreenOn.setAttribute("webkit-playsinline","");this.videoScreenOn.setAttribute("playsinline","");this.videoScreenOn.setAttribute("style","transform: translateZ(0px);");var e=document.createElement("source");e.src=t.WebM;e.type="video/webm";this.videoScreenOn.appendChild(e);var a=document.createElement("source");a.src=t.MP4;a.type="video/mp4";this.videoScreenOn.appendChild(a)}this.videoScreenOn.play()}).apply(t);g.apply(t);t.sessionTracking=TC.Util.storage.getSessionLocalValue(t.Const.LocalStorageKey.TRACKINGTEMP);if(t.sessionTracking){t._askTracking(function(){o.call(t)})||t.track.trackRenew.click()}else d.call(t)}else o.call(t)};t.deactivateTracking=function(){var t=this,e=function(){t.track.infoPanel.close();h.apply(t);t.wrap.setTracking(!1);delete t.geopositionTracking;a||t.div.querySelector(t._classSelector+"-track-render").querySelector("label").click();(function(){this.videoScreenOn&&this.videoScreenOn.pause()}).apply(t);(function(){window.removeEventListener("visibilitychange",c,!1);if(TC.Util.detectSafari()&&TC.browserFeatures.touch()&&!navigator.userAgent.match(/Android/i)&&!navigator.userAgent.match(/CriOS/i)){window.removeEventListener("pagehide",r,!1);window.removeEventListener("pageshow",s,!1)}else{window.removeEventListener("blur",r,!1);window.removeEventListener("focus",s,!1)}}).apply(t);t.off(t.Const.Event.POSITIONCHANGE);t.off(t.Const.Event.STATEUPDATED);o.call(t);t.track.trackName.value="";t.track.trackName.disabled=!0;t.track.trackSave.disabled=!0;t.track.trackWPT.value="";t.track.trackWPT.disabled=!0;t.track.trackAdd.disabled=!0;t.clear(t.Const.Layers.TRACKING);t.clear(t.Const.Layers.GPS);return!0};if(t.wrap.hasCoordinates()){t.map.toast(t.getLocaleString("geo.trk.deactivate.alert"),{duration:1e4});return e()}return e()};t.getStoredTracks=function(){const t=this;return new Promise(function(e,a){var n=[];localforage.keys().then(function(a){if(0==(a=a.filter(function(e){return 0!==e.indexOf(t.Const.LocalStorageKey.TRACKINGTEMP)&&0===e.indexOf(t.Const.LocalStorageKey.TRACKING)&&/trk#\d/i.exec(e)})).length){t.availableTracks=n;e(n)}const o=new Array(a.length);a.forEach(function(t,e){o[e]=new Promise(function(e,a){localforage.getItem(t,function(t,a){e(a)})})});Promise.all(o).then(function(a){if(a&&a.length){a.forEach(function(t){(t=JSON.parse(t))instanceof Array?n=n.concat(t):n.push(t)});var o=n.length>1?m(n):n;t.availableTracks=o;e(o)}})})})};var m=function(t){var e=[];for(var a in t)if(t[a]&&"object"==typeof t[a]){e.push(t[a]);e.sort(function(t,e){return"string"==typeof t.name&&TC.Util.isFunction(t.name.localeCompare)?t.name.localeCompare(e.name):0})}return e};t.setStoredTracks=function(t){const e=this;return new Promise(function(a,n){const o=[];t.forEach(function(t){o.push(new Promise(function(a,n){localforage.setItem(e.Const.LocalStorageKey.TRACKING+"#"+t.uid,JSON.stringify(t),function(t,e){a(e)})}))});Promise.all(o).then(function(){e.getStoredTracks().then(function(){e.bindTracks();a()})})})};t.getAvailableTracks=function(){const t=this;return new Promise(function(e,a){t.availableTracks?e(t.availableTracks):t.getStoredTracks().then(function(t){e(t)})})};t.bindTracks=function(){var t=this;t.track.trackList.querySelectorAll("li").forEach(function(t){t.style.display="none"});t.getAvailableTracks().then(function(e){if(k(e)){t.track.trackList.querySelectorAll('li[class^="tc-ctl-geolocation-track-available-empty"]').forEach(function(t){t.style.display=""});t.track.trackSearch.disabled=!0}else{const i=t.getSelectedTrack();var a;i&&(a=i.dataset.uid);t.track.trackList.querySelectorAll("li[data-id]").forEach(function(e){t.track.trackList.removeChild(e)});for(var n=0;n<e.length;n++){var o=e[n];"object"==typeof o&&t.getRenderedHtml(t.CLASS+"-track-node",{id:n,uid:o.uid,name:o.name?o.name.trim():""},function(e){const a=(new DOMParser).parseFromString(e,"text/html").body.firstChild;t.track.trackList.appendChild(a)})}a&&t.setSelectedTrack(t.track.trackList.querySelector('li[data-uid="'+a+'"]'));t.track.trackSearch.disabled=!1}})};t.chartProgressInit=function(){window.d3||TC.syncLoadJS(TC.Consts.url.D3C3);const t=d3.select(".c3-event-rects,.c3-event-rects-single").node().getBoundingClientRect();this.miDiv=document.createElement("div");this.miDiv.classList.add("miDiv");this.miDiv.style.width=t.width+"px";this.miDiv.style.height=t.height+"px";this.miProgressDiv=document.createElement("div");this.miProgressDiv.classList.add("miProgressDiv",this.CLASS+"-track-elevation-chart-progress",TC.Consts.classes.HIDDEN);this.miProgressDiv.style.width="0%";this.miProgressDiv.style.height=t.height+"px";this.miProgressTextDiv=document.createElement("div");this.miProgressTextDiv.classList.add("miProgressTextDiv","tc-ctl-geolocation-track-elevation-chart-progress","text");this.miProgressTextDiv.style.width=t.width+"px";this.miProgressTextDiv.style.height=t.height+"px";this.miDiv.style.top=t.top+"px";this.miDiv.style.left=t.left+"px";this.miDiv.style.bottom=t.bottom+"px";this.miDiv.style.right=t.right+"px";this.miDiv.style.position="absolute";this.miDiv.style.zIndex=10008;this.miDiv.style.display="none";this.miProgressDiv.appendChild(this.miProgressTextDiv);this.miDiv.appendChild(this.miProgressDiv);document.body.appendChild(this.miDiv)};t.chartProgressClear=function(){const t=this;if(t.miDiv){t.miDiv.parentElement.removeChild(t.miDiv);t.miDiv=null;t.miProgressDiv=null;t.miProgressTextDiv=null}};t.chartSetProgress=function(t,e,a,n){this.miDiv&&"none"===this.miDiv.style.display&&(this.miDiv.style.display="");this.miProgressDiv.classList.remove(TC.Consts.classes.HIDDEN);var o=t.d,i=(o+Math.hypot(t.p[0]-e[0],t.p[1]-e[1]))/a*100;this.miProgressDiv.style.width=i+"%";var r,s,c=this.map.options.locale&&this.map.options.locale.replace("_","-")||void 0,l=parseInt(e[2].toFixed(0)).toLocaleString(c);if(o/1e3<1){r=Math.round(o/1e3*1e3);s=" m"}else{r=Math.round(o/1e3*100)/100;s=" km"}r=r.toLocaleString(c);this.miProgressTextDiv.innerHTML="<div><span>"+l+" m</span><br><span>"+r+s+"</span></div>"+(n?"<br><span>"+n.toString+"</span>":"")};t._getTime=function(t,e){var a=e-t,n={},o=Math.floor(a/1e3/60/60/24);a-=1e3*o*60*60*24;var i=Math.floor(a/1e3/60/60);a-=1e3*i*60*60;n.h=i+24*o;var r=Math.floor(a/1e3/60);a-=1e3*r*60;n.m=r;n.s=Math.floor(a/1e3);return TC.Util.extend({},n,{toString:("00000"+n.h).slice(-2)+":"+("00000"+n.m).slice(-2)+":"+("00000"+n.s).slice(-2)})};t.simulateTrack=function(t){var e=this;e.simulate_speed=1;e.drawTrack(t,!1).then(function(){e.wrap.simulateTrack()})};t.drawTrack=function(t,e){var a=this;l.call(a);return new Promise(function(e,n){a.setSelectedTrack(t);a.drawTrackingData(t).then(function(){a.elevationTrack(t).then(()=>{a.activate();e()})})})};t.elevationTrack=function(a,n){var o=this;return new Promise((i,r)=>{const s=function(){o.resultsPanelChart&&(o.resultsPanelChart.currentFeature=o.layerTrack.features.filter(t=>!(TC.feature.Marker&&t instanceof TC.feature.Marker||TC.feature.Point&&t instanceof TC.feature.Point))[0])};if(n){o.wrap.simulateTrackEnd();o.uiSimulate(!1,a);return}if(!o.onResize){o.onResize=o.elevationTrack.bind(o,a,!0);window.addEventListener("resize",o.onResize,!1)}let c=[];o.track.elevationChart&&(o.track.elevationChart=o.track.elevationChart.destroy());(function(t){return new Promise(function(e,a){TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){o.getTrackingData(t).then(function(t){var a=t.data;if(a){var n,i;n=[];i=[];var r,s,l,d=!0,u={},A={},g=(new ol.format.GeoJSON).readFeatures(a),h=function(){if(l.getLayout()==ol.geom.GeometryLayout.XYZ||l.getLayout()==ol.geom.GeometryLayout.XYZM){var t=0;if(o.map.crs!==o.map.options.utmCrs){line=new ol.geom.LineString(TC.Util.reproject(l.getCoordinates(),o.map.crs,o.map.options.utmCrs));t=line.getLength()}else t=l.getLength();return parseFloat((t/1e3).toFixed(2))}return null},f=function(){if(l.getLayout()==ol.geom.GeometryLayout.XYZM||l.getLayout()==ol.geom.GeometryLayout.XYM){var t=l.getLastCoordinate()[3]-l.getFirstCoordinate()[3];return{s:Math.floor(t/1e3%60),m:Math.floor(t/6e4%60),h:Math.floor(t/36e5%24)}}return null},p=function(t){if(c.length>0){var e=0;c.forEach(function(a,n,i){var r=0===n?a:i[n-1];if(o.map.crs!==o.map.options.utmCrs){a=TC.Util.reproject(a,o.map.crs,o.map.options.utmCrs);r=TC.Util.reproject(r,o.map.crs,o.map.options.utmCrs)}const s=a[0]-r[0],c=a[1]-r[1];e+=Math.sqrt(s*s+c*c);t.push(parseFloat(e.toFixed(2)))})}},m=function(t){for(var a=0;a<c.length;a++){if(!(c[a].length>2)){e(null);return}var n=Math.round(10*c[a][2])/10;d&&n>0&&(d=!1);t.push(n);0==a&&(r=s=n);r=Math.min(r,n);s=Math.max(s,n)}};g.filter(function(t){return"linestring"===t.getGeometry().getType().toLowerCase()||"multilinestring"===t.getGeometry().getType().toLowerCase()}).forEach(function(e){switch((l=e.getGeometry()).getType().toLowerCase()){case"linestring":if(t.layout===ol.geom.GeometryLayout.XYZM||t.layout===ol.geom.GeometryLayout.XYZ){A=f();h();u=TC.tool.Elevation.getElevationGain({coords:l.getCoordinates(),hillDeltaThreshold:o.gapHill});c=c.concat(l.getCoordinates());p(n);m(i)}break;case"multilinestring":if(t.layout===ol.geom.GeometryLayout.XYZM||t.layout===ol.geom.GeometryLayout.XYZ)for(var a,r=l.getLineStrings(),s=0;s<r.length;s++){h(r[s]);r[s].getLayout()==ol.geom.GeometryLayout.XYZM&&(a+=r[s].getLastCoordinate()[3]-r[s].getFirstCoordinate()[3]);c=c.concat(r[s].getCoordinates());a&&(A=f());p(n);m(i)}break;default:return null}});i instanceof Array&&0==i.length&&(d=!0);o.elevationChartData=d?null:TC.Util.extend({},{time:A,ele:i,x:n,miny:r,maxy:s},u);e(o.elevationChartData)}else e(null)})})})})(a).then(function(a){if(null!=a){a.time&&(a.time=("00000"+a.time.h).slice(-2)+":"+("00000"+a.time.m).slice(-2)+":"+("00000"+a.time.s).slice(-2));a.coords=c;o.hasElevation=!0}else{o.hasElevation=!1;a={msg:o.getLocaleString("geo.trk.chart.chpe.empty")}}a.minHeight=o.CHART_SIZE.MIN_HEIGHT;a.maxHeight=o.CHART_SIZE.MAX_HEIGHT;a.minWidth=o.CHART_SIZE.MIN_WIDTH;a.mediumWidth=o.CHART_SIZE.MEDIUM_WIDTH;a.maxWidth=o.CHART_SIZE.MAX_WIDTH;o.map.one(TC.Consts.event.DRAWCHART,function(t){o.chartProgressInit();i()});if(o.resultsPanelChart){s();o.resultsPanelChart.open();o.map.trigger(o.Const.Event.DRAWTRACK,{data:a})}else{window.c3||TC.syncLoadJS(TC.Consts.url.D3C3||TC.apiLocation+"lib/d3c3/d3c3.min.js");var n,r={content:"chart",titles:{main:o.getLocaleString("geo.trk.chart.chpe"),max:o.getLocaleString("geo.trk.chart.chpe")},openOn:o.Const.Event.DRAWTRACK,closeOn:o.Const.Event.CLEARTRACK,chart:{ctx:o,onmouseout:t.removeElevationTooltip,tooltip:t.getElevationTooltip}};const e=function(t){r.position=t.POSITION.RIGHT;n=t.addControl("resultsPanel",r)};if(o.options.displayOn){var l=o.map.getControlsByClass("TC.control."+o.options.displayOn[0].toUpperCase()+o.options.displayOn.substring(1))[0];l?e(l):o.map.addControl(o.options.displayOn).then(e)}else{r.div=document.createElement("div");o.map.div.appendChild(r.div);n=o.map.addControl("resultsPanel",r)}n.then(function(t){t.caller=o;o.resultsPanelChart=t;s();t.renderPromise().then(function(){t.activateSnapping=function(t){o.layerTrack&&!o.layerTrack.getVisibility()&&0==o.layerTrack.getOpacity()&&o.wrap.deactivateSnapping.call(o.wrap)};t.deactivateSnapping=function(t){o.layerTrack&&o.layerTrack.getVisibility()&&o.layerTrack.getOpacity()>0&&o.wrap.activateSnapping.call(o.wrap)};t.div.addEventListener("mouseover",t.deactivateSnapping);t.div.addEventListener("mouseout",t.activateSnapping);o.map.on(TC.Consts.event.RESULTSPANELMIN,function(){o.miDiv&&(o.miDiv.style.display="none")}).on(TC.Consts.event.RESULTSPANELMAX,function(){o.miDiv&&(o.miDiv.style.display="")}).on(TC.Consts.event.RESULTSPANELCLOSE,function(){o.miDiv&&(o.miDiv.style.display="none")});o.map.trigger(o.Const.Event.DRAWTRACK,{data:a})})})}e=e.bind(o);o.map.on(TC.Consts.event.FEATUREREMOVE,e)})})};t.clear=function(t){var e=this;if(e.onResize){window.removeEventListener("resize",e.onResize,!1);e.onResize=void 0}if(t==e.Const.Layers.TRACK){e.layerTrack.clearFeatures();e.resultsPanelChart&&e.resultsPanelChart.close();delete e.elevationChartData;e.wrap.simulateTrackEnd();e.wrap.clear();e.track.trackList.querySelectorAll("li").forEach(function(t){t.classList.remove(e.Const.Classes.SELECTEDTRACK)});e.map.trigger(e.Const.Event.CLEARTRACK);e.featuresToShare=[]}else{e.layerTracking.clearFeatures();e.layerGPS.clearFeatures()}};t.saveTrack=function(t){const e=this;return new Promise(function(a,n){var o=t.message||e.getLocaleString("geo.trk.save.alert"),i=function(i){var r;r=e.getLoadingIndicator().addWait();var s=t.importedFileName||e.track.trackName.value.trim(),c=e.availableTracks;c||(c=[]);var d=e.wrap.formattedToStorage(i,!0,t.notReproject),u=function(t){e.track.trackName.value="";e.track.trackName.disabled=!0;e.track.trackSave.disabled=!0;e.track.trackWPT.value="";e.track.trackWPT.disabled=!0;e.track.trackAdd.disabled=!0;e.getLoadingIndicator().removeWait(t);l.call(e)},A={name:s,data:d.features,layout:d.layout,crs:e.storageCRS};TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){var t=hex_md5(JSON.stringify(A)),i=c.map(function(e){var a=JSON.parse(JSON.stringify(e));delete a.uid;if(t===hex_md5(JSON.stringify(a)))return e.uid;{const i=new ol.format.GeoJSON;var n=i.readFeatures(a.data),o=Math.pow(10,TC.Consts.DEGREE_PRECISION+1);n.forEach(function(t){var e=TC.Util.explodeGeometry(TC.Util.compactGeometry(t.getGeometry().getCoordinates(),o));t.getGeometry().setCoordinates(e)});a.data=i.writeFeatures(n);return t===hex_md5(JSON.stringify(a))?e.uid:null}}).filter(function(t){return null!==t});const s=function(t){return e.getStoredTracks().then(function(){e.bindTracks();for(var a,n=0;n<e.availableTracks.length;n++)if(e.availableTracks[n].uid===t){a=n;break}return a})};if(0===i.length){A.uid=Date.now()+Math.random();c.push(A);c=m(c);try{e.setStoredTracks(c).then(function(){e.map.toast(o,{duration:3e3});u(r);s(A.uid).then(function(t){a(t)})})}catch(t){TC.alert(e.getLocaleString("geo.error.savelocalstorage")+": "+t.message);u(r);n(t)}}else{console.log("Ya existe un track con ese mismo hash");u(r);s(i[0]).then(function(t){a(t)})}})};if(e.importedFileName)i(e.layerTrack);else if(0==e.track.trackName.value.trim().length){e.track.trackName.value=(new Date).toLocaleString();i(e.layerTracking)}else i(e.layerTracking)})};t.addWaypoint=function(){var t=this.track.trackWPT.value.trim();t||(t=(new Date).toLocaleString());var e=this.getLoadingIndicator().addWait();l.call(this);this.wrap.addWaypoint(this.currentPoint.position,{name:t,ele:this.currentPoint.heading,time:(new Date).getTime()});this.track.trackWPT.value="";this.track.trackWPT.disabled=!0;this.track.trackAdd.disabled=!0;TC.Util.storage.setSessionLocalValue(this.Const.LocalStorageKey.TRACKINGTEMP,this.wrap.formattedToStorage(this.layerTracking).features);this.getLoadingIndicator().removeWait(e)};t.editTrackName=function(t,e){var a=this;a.getAvailableTracks().then(function(n){if(n&&n[t]){n[t].name=e;a.setStoredTracks(n)}})};t.removeTrack=function(t){var e=this;e.getAvailableTracks().then(function(a){if(a){var n=t.dataset.id;if(a[n]){var o=a[n].uid;TC.confirm(e.getLocaleString("geo.trk.delete.alert"),function(){const t=e.getSelectedTrack();t&&t.dataset.id===n&&e.clear(e.Const.Layers.TRACK);localforage.removeItem(e.Const.LocalStorageKey.TRACKING+"#"+o).then(function(){e.getStoredTracks().then(function(){e.bindTracks()})}).catch(function(t){console.log(t)})},function(){})}}})};t.setSelectedTrack=function(t){var e=this;e.isActive||e.activate();e.track.trackList.querySelectorAll("li[data-id] > span").forEach(function(t){t.setAttribute("title",t.textContent)});e.track.trackList.querySelectorAll("li").forEach(function(t){t.classList.remove(e.Const.Classes.SELECTEDTRACK)});t.classList.add(e.Const.Classes.SELECTEDTRACK);t.setAttribute("title",e.getLocaleString("tr.lst.clear")+" "+t.querySelector("span").textContent);t.querySelector(e.Const.Selector.DRAW).setAttribute("title",t.getAttribute("title"))};t.getSelectedTrack=function(){return this.track.trackList.querySelector("li."+this.Const.Classes.SELECTEDTRACK)};t.clearSelectedTrack=function(){const t=this,e=t.getSelectedTrack();if(e){if(t.onResize){window.removeEventListener("resize",t.onResize,!1);t.onResize=void 0}e.classList.remove(t.Const.Classes.SELECTEDTRACK);e.setAttribute("title",e.textContent);e.querySelector(t.Const.Selector.DRAW).setAttribute("title",e.getAttribute("title"))}};t.clearSelection=function(){this.wrap.deactivateSnapping();this.getSelectedTrack()&&this.clearSelectedTrack();if(this.resultsPanelChart){this.resultsPanelChart.div.removeEventListener("mouseover",this.resultsPanelChart.deactivateSnapping);this.resultsPanelChart.div.removeEventListener("mouseout",this.resultsPanelChart.activateSnapping);this.resultsPanelChart.close()}this.clear(this.Const.Layers.TRACK)};t.drawTrackingData=function(t){const e=this;return new Promise(function(a,n){e.wrap.clear();e.getTrackingData(t).then(function(t){t.data;t.data&&e.wrap.drawTrackingData(t).then(function(){var t=e.layerTrack.features;if(t&&t.length>0){var n=t.filter(function(t){t.showsPopup=!1;return!!(TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline)||t instanceof TC.feature.Polyline}).map(function(t){return TC.feature.MultiPolyline&&t instanceof TC.feature.MultiPolyline?t.geometry[0]:t instanceof TC.feature.Polyline?t.geometry:void 0})[0];if(n){var o=n[0],i=n[n.length-1];o&&o!==i&&e.layerTrack.addMarker(o.slice().splice(0,2),{showsPopup:!1,cssClass:e.CLASS+"-track-marker-icon-end",anchor:[.5,1],notExport:!0});i&&e.layerTrack.addMarker(i.slice().splice(0,2),{showsPopup:!1,cssClass:e.CLASS+"-track-marker-icon",anchor:[.5,1],notExport:!0})}}e.layerTrack.setVisibility(!0);a()})})})};t.getTrackingData=function(t){const e=this;return new Promise(function(a,n){e.getAvailableTracks().then(function(n){if(n){const i=t.dataset.id;if(n[i]){var o=n[i].data;o=e.wrap.formattedFromStorage(o);a({data:o,layout:n[i].layout})}}else a()})})};t.export=function(t){return this.wrap.export(t)};t.getElevationTooltip=function(t){this.wrap.showElevationMarker(t);return this.resultsPanelChart.getElevationChartTooltip(t)};t.removeElevationTooltip=function(){this.wrap.hideElevationMarker()};t.clearFileInput=function(t){const e=document.createElement("form"),a=t.parentElement;a.insertBefore(e,t);e.appendChild(t);e.reset();e.insertAdjacentElement("afterend",t);a.removeChild(e)};t.getLoadingIndicator=function(){if(!this.loading){this.loading=this.map.getControlsByClass(TC.control.LoadingIndicator);this.loading&&this.loading.length>0&&(this.loading=this.loading[0])}return this.loading};t.onGeolocateError=function(t){var e;if(navigator.geolocation){this.currentPosition&&navigator.geolocation.clearWatch(this.currentPosition);if(this.currentPositionTrk){this.currentPositionTrk=this.currentPositionTrk instanceof Array?this.currentPositionTrk:[this.currentPositionTrk];this.currentPositionTrk.forEach(function(t){navigator.geolocation.clearWatch(t)});this.currentPositionTrk=[]}}this.currentPositionWaiting&&this.getLoadingIndicator().removeWait(this.currentPositionWaiting);switch(t.code){case t.PERMISSION_DENIED:e=this.getLocaleString("geo.error.permission_denied");break;case t.POSITION_UNAVAILABLE:e=this.getLocaleString("geo.error.position_unavailable");break;case t.TIMEOUT:e=this.getLocaleString("geo.error.timeout");break;default:e=this.getLocaleString("geo.error.default")}this.map.toast(e,{type:TC.Consts.msgType.WARNING});if(!this.geopositionTracking&&this.track){this.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);this.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN)}};var k=function(t){return!t||0===t.length};t.exportState=function(){const t=this;if(t.exportsState){const a={};if(t.layerTrack){var e=t.layerTrack.features;if(e.length>0&&t.featuresToShare&&t.featuresToShare.length>0)a.features=t.featuresToShare;else{const n=t.layerTrack.exportState({features:e});a.features=n.features}a.id=t.id;const n=t.getSelectedTrack();n&&(a.trackName=n.querySelector("span").innerHTML);return a}}return null};t.importState=function(t){const e=this;if(e.map&&t.features&&t.features.length){e.enable();if(t.features.length>0){const a=new Array(t.features.length);t.features.forEach(function(t,e){const n={data:t.data,id:t.id,showsPopup:t.showsPopup};var o=TC.Util.explodeGeometry(t.geom);switch(t.type){case TC.Consts.geom.POLYLINE:a[e]=new TC.feature.Polyline(o,n);break;case TC.Consts.geom.MULTIPOLYLINE:a[e]=new TC.feature.MultiPolyline(o,n);break;case TC.Consts.geom.MARKER:a[e]=new TC.feature.Marker(o,n);break;case TC.Consts.geom.POINT:a[e]=new TC.feature.Point(o,n)}});Promise.all(a).then(function(a){var n={features:a,fileName:t.trackName,notReproject:!0,isShared:!0};e.availableTracks?e.importTrack(n):e.getStoredTracks().then(function(){e.importTrack(n)})})}}};t.getDownloadDialog=function(){const t=this;return t._downloadDialog?Promise.resolve(t._downloadDialog):new Promise(function(e,a){t.map.addControl("FeatureDownloadDialog").then(a=>{t._downloadDialog=a;e(a)})})}}();
//# sourceMappingURL=../maps/control/Geolocation.min.js.map