TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Feature&&TC.feature.Point||TC.syncLoadJS(TC.apiLocation+"TC/feature/Point");TC.Feature&&TC.feature.Polyline||TC.syncLoadJS(TC.apiLocation+"TC/feature/Polyline");TC.Feature&&TC.feature.Polygon||TC.syncLoadJS(TC.apiLocation+"TC/feature/Polygon");TC.Consts.event.DRAWSTART="drawstart.tc";TC.Consts.event.DRAWEND="drawend.tc";TC.Consts.event.DRAWCANCEL="drawcancel.tc";TC.Consts.event.DRAWUNDO="drawundo.tc";TC.Consts.event.DRAWREDO="drawredo.tc";TC.Consts.event.MEASURE="measure.tc";TC.Consts.event.MEASUREPARTIAL="measurepartial.tc";TC.Consts.event.STYLECHANGE="stylechange.tc";TC.Consts.event.CHANGE="change";!function(){const t=function(t){const e=t.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);return e&&e.length?"#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]:t};TC.control.Draw=function(){var t=this;TC.Control.apply(t,arguments);if(!TC.browserFeatures.inputTypeColor()&&!window.CP){TC.loadCSS(TC.apiLocation+"lib/color-picker/color-picker.min.css");TC.syncLoadJS(TC.apiLocation+"lib/color-picker/color-picker.min.js")}t._classSelector="."+t.CLASS;t._pointClass=t.CLASS+"-point";t._lineClass=t.CLASS+"-line";t._polygonClass=t.CLASS+"-polygon";t.history=[];t.historyIndex=0;t.exportsState=!0;t.on(TC.Consts.event.DRAWSTART,function(e){t.resetValues()}).on(TC.Consts.event.POINT,function(e){t.layer&&!t.persistent&&t.layer.features&&t.layer.features.length>0&&t.layer.clearFeatures();t.history.length=t.historyIndex;t.history[t.historyIndex++]=e.point;s(t)}).on(TC.Consts.event.DRAWEND,function(e){o(t);e.feature.setId(TC.getUID(t.getLocaleString("sketch")+"."));t.callBack&&t.callBack(e.feature)});t._layerPromise=null};TC.inherit(TC.control.Draw,TC.Control);var e=TC.control.Draw.prototype;e.CLASS="tc-ctl-draw";var s=function(t){t._endBtn.disabled=0===t.historyIndex||t.mode===TC.Consts.geom.POLYGON&&t.historyIndex<3||t.mode===TC.Consts.geom.POLYLINE&&t.historyIndex<2;t._redoBtn.disabled=t.history.length===t.historyIndex;t._undoBtn.disabled=0===t.historyIndex},o=function(t){t.resetValues();t._endBtn.disabled=!0;t._cancelBtn.disabled=!1};TC.isDebug?e.template=TC.apiLocation+"TC/templates/Draw.html":e.template=function(){dust.register(e.CLASS,t);function t(t,e){return t.w('<div class="tc-ctl-draw-tools"><button class="tc-ctl-btn tc-ctl-draw-btn-new" title="').f(e.get(["tooltip"],!1),e,"h").w('">').h("i18n",e,{},{$key:"new"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-undo" disabled title="').h("i18n",e,{},{$key:"undo"}).w('">').h("i18n",e,{},{$key:"undo"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-redo" disabled title="').h("i18n",e,{},{$key:"redo"}).w('">').h("i18n",e,{},{$key:"redo"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-end" disabled title="').h("i18n",e,{},{$key:"end"}).w('">').h("i18n",e,{},{$key:"end"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-cancel" title="').h("i18n",e,{},{$key:"cancel"}).w('">').h("i18n",e,{},{$key:"cancel"}).w("</button></div>").x(e.get(["styleTools"],!1),e,{block:s},{})}t.__dustBody=!0;function s(t,e){return t.w('<div class="tc-ctl-draw-style">').h("i18n",e,{},{$key:"strokeColor"}).w('<input type="color" class="tc-ctl-col tc-ctl-draw-str-c" value="').f(e.get(["strokeColor"],!1),e,"h").w('" title="').h("i18n",e,{},{$key:"selectColor"}).w('" />').h("i18n",e,{},{$key:"strokeWidth"}).w('<div class="tc-ctl-draw-str-w-watch" style="border-bottom-width:').f(e.get(["strokeWidth"],!1),e,"h").w('px;"> </div><input type="number" class="tc-ctl-draw-str-w tc-textbox" value="').f(e.get(["strokeWidth"],!1),e,"h").w('" min="1" max="15" /></div>')}s.__dustBody=!0;return t};e.render=function(e){var s,o,n,i=this;switch(i.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:s=i.getLocaleString("drawLine");i.div.classList.add(i._lineClass);o=TC.Cfg.styles.line.strokeColor;n=TC.Cfg.styles.line.strokeWidth;break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:s=i.getLocaleString("drawPolygon");i.div.classList.add(i._polygonClass);o=TC.Cfg.styles.polygon.strokeColor;n=TC.Cfg.styles.polygon.strokeWidth;break;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:s=i.getLocaleString("drawPoint");i.div.classList.add(i._pointClass);o=TC.Cfg.styles.point.strokeColor;n=TC.Cfg.styles.point.strokeWidth;break;default:s=i.getLocaleString("draw");o=TC.Cfg.styles.line.strokeColor;n=TC.Cfg.styles.line.strokeWidth}const r={tooltip:s,strokeColor:t(o),strokeWidth:n,styleTools:i.options.styleTools};return i._set1stRenderPromise(i.renderData(r,function(){if(!TC.browserFeatures.inputTypeColor()){const t=i.div.querySelector("input[type=color]");if(t){t.style.backgroundColor=t.value;t.style.color="transparent";const e=new CP(t,"click",document.body);t.onclick=function(t){t.preventDefault()};t.onfocus=function(t){this.blur()};t.onchange=function(t){this.style.backgroundColor=this.value};i.map.loaded(function(){e.on("change",function(t){i.setStrokeColor("#"+t)})})}}i.reset=!0;i.callBack=null;i.measure=!1;i._cancelClick=!1;i.mode=i.options.mode||TC.Consts.geom.POLYLINE;i.options.measure&&(i.measure=i.options.measure);TC.Util.isFunction(i.options.callback)&&(i.callBack=i.options.callback);void 0===i.options.persistent?i.persistent=!0:i.persistent=i.options.persistent;i.wrap=new TC.wrap.control.Draw(i);i._newBtn=i.div.querySelector(i._classSelector+"-btn-new");i._newBtn.addEventListener(TC.Consts.event.CLICK,function(){i.new()});i._cancelBtn=i.div.querySelector(i._classSelector+"-btn-cancel");i._cancelBtn.addEventListener(TC.Consts.event.CLICK,function(){i.cancel()});i._endBtn=i.div.querySelector(i._classSelector+"-btn-end");i._endBtn.addEventListener(TC.Consts.event.CLICK,function(){i.end()});i._undoBtn=i.div.querySelector(i._classSelector+"-btn-undo");i._undoBtn.addEventListener(TC.Consts.event.CLICK,function(){i.undo()});i._redoBtn=i.div.querySelector(i._classSelector+"-btn-redo");i._redoBtn.addEventListener(TC.Consts.event.CLICK,function(){i.redo()});if(i.options.styleTools){i._strokeColorPicker=i.div.querySelector(i._classSelector+"-str-c");i._strokeColorPicker.addEventListener(TC.Consts.event.CHANGE,function(t){i.setStrokeColor(t.target.value)});i._strokeWidthSelector=i.div.querySelector(i._classSelector+"-str-w");i._strokeWidthSelector.addEventListener(TC.Consts.event.CHANGE,function(t){i.setStrokeWidth(t.target.value)});i._strokeWidthWatch=i.div.querySelector(i._classSelector+"-str-w-watch")}TC.Util.isFunction(e)&&e()}))};e.register=function(t){const e=this,s=TC.Control.prototype.register.call(e,t);e.map.on(TC.Consts.event.VIEWCHANGE,function(){e.map.view===TC.Consts.view.PRINTING&&e.end()});const o=function(){e.styles={};TC.Util.extend(!0,e.styles,e.options.styles||e.layer.options.styles)};e._layerPromise=new Promise(function(s,n){t.loaded(function(){if(e.options.layer){e.setLayer(e.options.layer);s(e.layer);o()}else if(!1===e.options.layer){e.setLayer(null);s(null)}else t.addLayer({id:e.getUID(),title:"DrawControl",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{point:t.options.styles.point,line:t.options.styles.line,polygon:t.options.styles.polygon}}).then(function(n){t.putLayerOnTop(n);e.setLayer(n);s(e.layer);o()})})});return s};e.new=function(){this.layer&&!this.persistent&&this.layer.clearFeatures();this._cancelBtn.disabled=!1;this.setMode(this.mode,!0);return this};e.undo=function(){var t=this.wrap.undo();if(t){this.historyIndex--;s(this);this.historyIndex<=0&&this.resetValues();this.trigger(TC.Consts.event.DRAWUNDO)}return t};e.redo=function(){var t=this.wrap.redo();if(t){this.historyIndex++;s(this);this.trigger(TC.Consts.event.DRAWREDO)}return t};e.cancel=function(){this._cancelClick=!0;this.setMode(null,!1);this.resetValues();o(this);this._cancelBtn.disabled=!0;this.trigger(TC.Consts.event.DRAWCANCEL,{ctrl:this});return this};e.activate=function(){this._newBtn.classList.add(TC.Consts.classes.ACTIVE);this._cancelBtn.disabled=!1;TC.Control.prototype.activate.call(this);this.wrap.activate(this.mode);this.div.classList.remove(this._pointClass,this._lineClass,this._polygonClass);switch(this.mode){case TC.Consts.geom.POINT:this.div.classList.add(this._pointClass);break;case TC.Consts.geom.POLYLINE:this.div.classList.add(this._lineClass);break;case TC.Consts.geom.POLYGON:this.div.classList.add(this._polygonClass)}};e.deactivate=function(){this._newBtn&&this._newBtn.classList.remove(TC.Consts.classes.ACTIVE);this._cancelBtn&&(this._cancelBtn.disabled=!0);TC.Control.prototype.deactivate.call(this,!this._cancelClick);this.wrap&&this.wrap.deactivate();this.resetValues();this._cancelClick=!1};e.clear=function(){const t=this;t.layer&&t.layer.clearFatures();t.resetValues();return t};e.isExclusive=function(){return!0};e.end=function(){this.wrap.end();this.resetValues();return this};e.setMode=function(t,e){const s=this;t&&(s.mode=t);if(e&&t){s.layer&&s.layer.map.putLayerOnTop(s.layer);s.activate()}else s.deactivate();return s};e.setStyle=function(t){const e=this;if(t)TC.Util.extend(e.style,t);else switch(e.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:t={line:e.styles.line};break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:t={polygon:e.styles.polygon};break;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:t={point:e.styles.point};break;default:t={}}e.isActive&&e.wrap.setStyle(t)};e.getModeStyle=function(t){const e=this;switch(t=t||e.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:return e.styles.line;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:return e.styles.polygon;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:return e.styles.point;default:return null}};e.setStrokeColorWatch=function(t){const e=this;if(e.options.styleTools){void 0===t&&(t=e.getModeStyle().strokeColor);const s=t.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);s&&s.length&&(t="#"+s[1]+s[1]+s[2]+s[2]+s[3]+s[3]);e._strokeColorPicker.value=t;if(!TC.browserFeatures.inputTypeColor()){const s=e._strokeColorPicker;s.style.backgroundColor=t;s.blur()}}return e};e.setStrokeColor=function(t){const e=this,s=e.getModeStyle();s&&(s.strokeColor=t);e.isActive&&e.setStyle();e.setStrokeColorWatch(t);e.trigger(TC.Consts.event.STYLECHANGE,{property:"strokeColor",value:t});return e};e.setStrokeWidthWatch=function(t){const e=this;if(e.options.styleTools){void 0===t&&(t=e.getModeStyle().strokeWidth);if((t=parseInt(t,10))!==Number.NaN){e._strokeWidthSelector.value=t;e._strokeWidthWatch.style.borderBottomWidth=t+"px"}}return e};e.setStrokeWidth=function(t){const e=this;if((t=parseInt(t,10))!==Number.NaN){const s=e.getModeStyle();s&&(s.strokeWidth=t);e.isActive&&e.setStyle();e.setStrokeWidthWatch(t);e.trigger(TC.Consts.event.STYLECHANGE,{property:"strokeWidth",value:t})}return e};e.getLayer=function(){return this._layerPromise};e.setLayer=function(t){this.map&&(this.layer="string"==typeof t?this.map.getLayer(t):t)};e.resetValues=function(){this.history.length=0;this.historyIndex=0;s(this);return this};e.exportState=function(){const t=this;return t.exportsState?{id:t.id,layer:t.layer.exportState()}:null};e.importState=function(t){this.getLayer().then(function(e){e.importState(t.layer)})}}();
//# sourceMappingURL=../maps/control/Draw.min.js.map