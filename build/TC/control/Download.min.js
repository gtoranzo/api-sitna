TC.control=TC.control||{};TC.control.MapInfo||TC.syncLoadJS(TC.apiLocation+"TC/control/MapInfo");TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");TC.control.Download=function(t){this._classSelector="."+this.CLASS;TC.Control.apply(this,arguments);this._hiddenElms=[];var e=t||{};this._dialogDiv=TC.Util.getDiv(e.dialogDiv);this._$dialogDiv=$(this._dialogDiv);e.dialogDiv||document.body.appendChild(this._dialogDiv)};TC.inherit(TC.control.Download,TC.control.MapInfo);!function(){var t=TC.control.Download.prototype;t.CLASS="tc-ctl-download";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/Download.html";t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/DownloadDialog.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"download"}).w(' </h2><div class="tc-ctl-tctr tc-ctl-tctr-select"><form><label class="tc-ctl-tctr-tab tc-ctl-download-image" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="image" /><span>').h("i18n",e,{},{$key:"dl.export.map"}).w('</span></label><label class="tc-ctl-tctr-tab tc-ctl-download-data" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="data" /><span>').h("i18n",e,{},{$key:"dl.export.vector"}).w('</span></label></form></div><div class="tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-image tc-group tc-ctl-download-cnt tc-ctl-download-image tc-collapsed"><div><label>').h("i18n",e,{},{$key:"format"}).w(':</label><select id="download-format-image" class="tc-combo"><option value="image/png">PNG</option><option value="image/jpeg">JPEG</option></select><div class="tc-ctl-download-div"><input id="tc-ctl-download-image-qr" class="tc-hidden" type="checkbox" checked style="display:none;" /><label for="tc-ctl-download-image-qr" class="tc-ctl-download-image-qr-label" title="').h("i18n",e,{},{$key:"createQrCodeToImage"}).w('">').h("i18n",e,{},{$key:"appendQRCode"}).w('</label></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"downloadImageFromCurrentMap"}).w('" name="descargar">').h("i18n",e,{},{$key:"download"}).w('</button></div><div class="tc-ctl-download-alert tc-alert alert-warning tc-hidden"><p>').h("i18n",e,{},{$key:"qrAdvice|s"}).w('</p></div></div></div><div class="tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-data tc-group tc-ctl-download-cnt tc-collapsed"><div><label>').h("i18n",e,{},{$key:"format"}).w(':</label><select id="download-format" class="tc-combo"><option value="GML32">GML</option><option value="application/json">GeoJSON</option><option value="application/vnd.google-earth.kml+xml">KML (Google Earth)</option><option value="shape-zip">Shape (ESRI)</option></select><div class="tc-ctl-download-div"><i class="tc-ctl-download-help icon-question-sign" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"showDownloadHelp"}).w('"></i></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"downloadLayersFromCurrentExtent"}).w('" name="descargar">').h("i18n",e,{},{$key:"download"}).w('</button></div><div class="tc-alert alert-warning tc-hidden"><p id="zoom-msg"><strong>').h("i18n",e,{},{$key:"tooManyFeatures"}).w(": </strong>").h("i18n",e,{},{$key:"tooManyFeatures.instructions"}).w('</p><p id="layers-msg"><strong>').h("i18n",e,{},{$key:"noLayersLoaded"}).w(": </strong>").h("i18n",e,{},{$key:"noLayersLoaded.instructions"}).w('</p><p id="url-msg"><strong>').h("i18n",e,{},{$key:"tooManySelectedLayers"}).w(": </strong>").h("i18n",e,{},{$key:"tooManySelectedLayers.instructions"}).w('</p><p id="noFeatures-msg"><strong>').h("i18n",e,{},{$key:"noData"}).w(": </strong>").h("i18n",e,{},{$key:"noData.instructions"}).w('</p><p id="novalid-msg"><strong>').h("i18n",e,{},{$key:"noValidService"}).w(": </strong>").h("i18n",e,{},{$key:"noValidService.instructions"}).w("</p></div></div></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-download-help-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"downloadData"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",e,{},{$key:"dl.instructions.1|s"}).w("</p><ul><li>").h("i18n",e,{},{$key:"dl.instructions.2|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.3|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.4|s"}).w("<ul><li>").h("i18n",e,{},{$key:"dl.instructions.5|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.6|s"}).w('</li></ul></li></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}e.__dustBody=!0;return e}}t.render=function(t){const e=this;return e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._dialogDiv.innerHTML=t}).then(function(){return TC.Control.prototype.render.call(e,function(){const o=".tc-ctl-tctr";e._selectors={TAB:o+"-tab",RADIOBUTTON:"input[type=radio][name=sctnr-sel]",ELEMENT:o+"-elm"};const a=function(t){for(var o=this;o&&!o.matches(e._selectors.TAB);)o=o.parentElement;if(o){const t=o.querySelector(e._selectors.RADIOBUTTON),a=t.value,n=e.div.querySelectorAll(e._selectors.ELEMENT);if(e._oldValue===a&&e.options.deselectable){setTimeout(function(){t.checked=!1},0);e._oldValue=null;e._activeElm=null;n.forEach(function(t){e._hiddenElms.push(t)})}else{n.forEach(function(t){t.matches(e._selectors.ELEMENT+"-"+a)?e._activeElm=t:e._hiddenElms.push(t)});e._oldValue=a}e._hiddenElms.forEach(function(t){t.classList.add(TC.Consts.classes.COLLAPSED)});e._activeElm&&e._activeElm.classList.remove(TC.Consts.classes.COLLAPSED);t.checked=!0}};e.div.querySelectorAll("span").forEach(function(t){t.addEventListener(TC.Consts.event.CLICK,a)});t&&t()})})};t.register=function(t){var e=this;const o=TC.control.MapInfo.prototype.register.call(e,t);e.map.mustBeExportable=!0;var a=function(t,o){const a=e.div.querySelector(".alert-warning:not(."+e.CLASS+"-alert)");var n;switch(t.key){case TC.Consts.WFSErrors.NumMaxFeatures:n=a.querySelector("#zoom-msg").innerHTML.format({serviceName:t.params.serviceTitle});break;case TC.Consts.WFSErrors.NoLayers:n=e.getLocaleString("noLayersLoaded");break;case TC.Consts.WFSErrors.GetCapabilities:n=a.querySelector("#novalid-msg").innerHTML.format({serviceName:t.params.serviceTitle});break;case TC.Consts.WFSErrors.NoFeatures:n=a.querySelector("#noFeatures-msg").innerHTML;break;case TC.Consts.WFSErrors.Indeterminate:n=e.getLocaleString("wfs.IndeterminateError");e.map.toast(n,{type:TC.Consts.msgType.ERROR});TC.error("Error:{error} \r\n Descripcion:{descripcion} \r\n Servicio:{serviceName}".format({error:t.params.err,descripcion:t.params.errorThrown,serviceName:t.params.serviceTitle}),TC.Consts.msgErrorMode.CONSOLE);e.map.getLoadingIndicator().removeWait(o);return;default:n=e.getLocaleString("wfs."+t.key,t.params)}e.map.toast(n,{type:TC.Consts.msgType.WARNING});e.map.getLoadingIndicator().removeWait(o)};e.div.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(".tc-ctl-download-btn",function(){var t=e.map.getLoadingIndicator().addWait(),o="";e._activeElm&&(o=e._activeElm.querySelector("select").value);if(o.indexOf("image")>-1)new Promise(function(o,a){var n=e.map.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0],l=TC.Util.cloneCanvas(n);e.map.getControlsByClass(TC.control.ScaleBar)&&e.drawScaleBarIntoCanvas({canvas:l,fill:!0});if(e._activeElm.querySelector("#"+e.CLASS+"-image-qr:checked")){const a="qrcode";var i=document.getElementById(a);if(i)i.innerHTML="";else{(i=document.createElement("div")).setAttribute("id",a);document.body.appendChild(i)}i.style.top="-200px";i.style.left="-200px";i.style.position="absolute";e.makeQRCode(i,87,87).then(function(a){if(a){var n=l.getContext("2d");n.fillStyle="#ffffff";n.fillRect(l.width-91,l.height-91,91,91);TC.Util.addToCanvas(l,a,{x:l.width-88,y:l.height-88}).then(function(t){o(t)})}else{TC.error(e.getLocaleString("dl.export.map.error")+": QR");e.map.getLoadingIndicator().removeWait(t)}})}else o(l)}).then(function(a){try{const t=a.toDataURL(o);TC.Util.downloadDataURI(window.location.hostname+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)+"."+o.split("/")[1],o,t)}catch(t){TC.error(e.getLocaleString("dl.export.map.error")+": "+t.message)}e.map.getLoadingIndicator().removeWait(t)});else{var n=e.map.getExtent(),l=TC.Util.reproject(n.slice(0,2),e.map.crs,TC.Defaults.crs),i=TC.Util.reproject(n.slice(2),e.map.crs,TC.Defaults.crs),r=TC.WFSGetFeatureBuilder(e.map,new TC.filter.bbox([l[0],l[1],i[0],i[1]]),o,!0);Promise.all(r).then(function(o){var n=$.grep(o,function(t){return null!=t});if(0!==n.length){for(var l=[],i=0;i<n.length;i++)if(n[i].errors&&n[i].errors.length)for(var r=0;r<n[i].errors.length;r++){var s=n[i].errors[r];a(s,t)}else{var c=n[i].data,d=n[i].url;c&&d&&l.push({url:d+"?download=zip",data:c})}TC.Util.downloadFileForm(l);e.map.getLoadingIndicator().removeWait(t)}else a({key:TC.Consts.WFSErrors.NoLayers},t)})}}));e.div.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(".tc-ctl-download-help",function(t){t.stopPropagation();TC.Util.showModal(e._dialogDiv.querySelector(e._classSelector+"-help-dialog"))}));e.div.addEventListener("change",TC.EventTarget.listenerBySelector("#"+e.CLASS+"-image-qr",function(t){t.target.checked?e.generateLink():e.div.querySelector("."+e.CLASS+"-alert").classList.add(TC.Consts.classes.HIDDEN)}));e.div.addEventListener("click",TC.EventTarget.listenerBySelector("h2",function(t){e.generateLink();e.registerListeners()}));return o};t.manageMaxLengthExceed=function(t){const e=this.div.querySelector("."+this.CLASS+"-alert");document.getElementById(this.CLASS+"-image-qr").checked?t.qr?e.classList.remove(TC.Consts.classes.HIDDEN):t.qr||e.classList.add(TC.Consts.classes.HIDDEN):e.classList.add(TC.Consts.classes.HIDDEN)}}();
//# sourceMappingURL=../maps/control/Download.min.js.map
