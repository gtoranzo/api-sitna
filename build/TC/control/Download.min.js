TC.control=TC.control||{};TC.control.MapInfo||TC.syncLoadJS(TC.apiLocation+"TC/control/MapInfo");TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");TC.Consts.DownloadError={MIMETYPE_NOT_SUPORTED:"MimeTypeNotSupported"};TC.control.Download=function(t){this._classSelector="."+this.CLASS;TC.Control.apply(this,arguments);this._hiddenElms=[];var e=t||{};this._dialogDiv=TC.Util.getDiv(e.dialogDiv);window.$&&(this._$dialogDiv=$(this._dialogDiv));e.dialogDiv||document.body.appendChild(this._dialogDiv)};TC.inherit(TC.control.Download,TC.control.MapInfo);!function(){var t=TC.control.Download.prototype;t.CLASS="tc-ctl-download";t.template={};t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"download"}).w(' </h2><div class="tc-ctl-tctr tc-ctl-tctr-select"><form><label class="tc-ctl-tctr-tab tc-ctl-download-image" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="image" /><span>').h("i18n",e,{},{$key:"dl.export.map"}).w('</span></label><label class="tc-ctl-tctr-tab tc-ctl-download-data" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="data" /><span>').h("i18n",e,{},{$key:"dl.export.vector"}).w('</span></label></form></div><div class="tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-image tc-group tc-ctl-download-cnt tc-ctl-download-image tc-collapsed"><div><label>').h("i18n",e,{},{$key:"format"}).w(':</label><select class="tc-combo"><option value="image/png">PNG</option><option value="image/jpeg">JPEG</option></select><div class="tc-ctl-download-div"><input id="tc-ctl-download-image-qr-').f(e.get(["controlId"],!1),e,"h").w('" class="tc-hidden" type="checkbox" checked style="display:none;" /><label for="tc-ctl-download-image-qr-').f(e.get(["controlId"],!1),e,"h").w('" class="tc-ctl-download-image-qr-label" title="').h("i18n",e,{},{$key:"createQrCodeToImage"}).w('">').h("i18n",e,{},{$key:"appendQRCode"}).w('</label></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"downloadImageFromCurrentMap"}).w('" name="descargar">').h("i18n",e,{},{$key:"download"}).w('</button></div><div class="tc-ctl-download-alert tc-alert alert-warning tc-hidden"><p>').h("i18n",e,{},{$key:"qrAdvice|s"}).w('</p></div></div></div><div class="tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-data tc-group tc-ctl-download-cnt tc-collapsed"><div><label>').h("i18n",e,{},{$key:"format"}).w(':</label><select class="tc-combo"><option value="GML32">GML</option><option value="application/json">GeoJSON</option><option value="application/vnd.google-earth.kml+xml">KML (Google Earth)</option><option value="shape-zip">Shape (ESRI)</option></select><div class="tc-ctl-download-div"><i class="tc-ctl-download-help icon-question-sign" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"showDownloadHelp"}).w('"></i></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"downloadLayersFromCurrentExtent"}).w('" name="descargar">').h("i18n",e,{},{$key:"download"}).w('</button></div><div class="tc-alert alert-warning tc-hidden"><p id="zoom-msg-').f(e.get(["controlId"],!1),e,"h").w('"><strong>').h("i18n",e,{},{$key:"tooManyFeatures"}).w(": </strong>").h("i18n",e,{},{$key:"tooManyFeatures.instructions"}).w('</p><p id="layers-msg-').f(e.get(["controlId"],!1),e,"h").w('"><strong>').h("i18n",e,{},{$key:"noLayersLoaded"}).w(": </strong>").h("i18n",e,{},{$key:"noLayersLoaded.instructions"}).w('</p><p id="url-msg-').f(e.get(["controlId"],!1),e,"h").w('"><strong>').h("i18n",e,{},{$key:"tooManySelectedLayers"}).w(": </strong>").h("i18n",e,{},{$key:"tooManySelectedLayers.instructions"}).w('</p><p id="noFeatures-msg-').f(e.get(["controlId"],!1),e,"h").w('"><strong>').h("i18n",e,{},{$key:"noData"}).w(": </strong>").h("i18n",e,{},{$key:"noData.instructions"}).w('</p><p id="novalid-msg-').f(e.get(["controlId"],!1),e,"h").w('"><strong>').h("i18n",e,{},{$key:"noValidService"}).w(": </strong>").h("i18n",e,{},{$key:"noValidService.instructions"}).w("</p></div></div></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-download-help-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"downloadData"}).w('</h3><div class="tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",e,{},{$key:"dl.instructions.1|s"}).w("</p><ul><li>").h("i18n",e,{},{$key:"dl.instructions.2|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.3|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.4|s"}).w("<ul><li>").h("i18n",e,{},{$key:"dl.instructions.5|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.6|s"}).w('</li></ul></li></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}e.__dustBody=!0;return e};t.render=function(t){const e=this;return e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._dialogDiv.innerHTML=t}).then(function(){return TC.Control.prototype.renderData.call(e,{controlId:e.id},function(){const o=".tc-ctl-tctr";e._selectors={TAB:o+"-tab",RADIOBUTTON:"input[type=radio][name=sctnr-sel]",ELEMENT:o+"-elm"};const n=function(t){for(var o=this;o&&!o.matches(e._selectors.TAB);)o=o.parentElement;if(o){const t=o.querySelector(e._selectors.RADIOBUTTON),n=t.value,a=e.div.querySelectorAll(e._selectors.ELEMENT);if(e._oldValue===n&&e.options.deselectable){setTimeout(function(){t.checked=!1},0);e._oldValue=null;e._activeElm=null;a.forEach(function(t){e._hiddenElms.push(t)})}else{a.forEach(function(t){t.matches(e._selectors.ELEMENT+"-"+n)?e._activeElm=t:e._hiddenElms.push(t)});e._oldValue=n}e._hiddenElms.forEach(function(t){t.classList.add(TC.Consts.classes.COLLAPSED)});e._activeElm&&e._activeElm.classList.remove(TC.Consts.classes.COLLAPSED);t.checked=!0}};e.div.querySelectorAll("span").forEach(function(t){t.addEventListener(TC.Consts.event.CLICK,n)});t&&t()})})};t.register=function(t){var e=this;const o=TC.control.MapInfo.prototype.register.call(e,t);e.map.mustBeExportable=!0;var n=function(t,o){const n=e.div.querySelector(".alert-warning:not(."+e.CLASS+"-alert)");var a;switch(t.key){case TC.Consts.WFSErrors.MAX_NUM_FEATURES:a=n.querySelector("#zoom-msg-"+e.id).innerHTML.format({serviceName:t.params.serviceTitle});break;case TC.Consts.WFSErrors.NO_LAYERS:a=e.getLocaleString("noLayersLoaded");break;case TC.Consts.WFSErrors.GETCAPABILITIES:a=n.querySelector("#novalid-msg-"+e.id).innerHTML.format({serviceName:t.params.serviceTitle});break;case TC.Consts.WFSErrors.NO_FEATURES:a=n.querySelector("#noFeatures-msg-"+e.id).innerHTML;break;case TC.Consts.WFSErrors.INDETERMINATE:a=e.getLocaleString("wfs.IndeterminateError");e.map.toast(a,{type:TC.Consts.msgType.ERROR});TC.error("Error:{error} \r\n Descripcion:{descripcion} \r\n Servicio:{serviceName}".format({error:t.params.err,descripcion:t.params.errorThrown,serviceName:t.params.serviceTitle}),TC.Consts.msgErrorMode.CONSOLE);e.map.getLoadingIndicator().removeWait(o);return;default:a=e.getLocaleString("wfs."+t.key,t.params)}e.map.toast(a,{type:TC.Consts.msgType.WARNING});e.map.getLoadingIndicator().removeWait(o)};e.div.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(".tc-ctl-download-btn",function(){var t=e.map.getLoadingIndicator().addWait(),o="";e._activeElm&&(o=e._activeElm.querySelector("select").value);if(o.indexOf("image")>-1)new Promise(function(o,n){var a=e.map.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0],l=TC.Util.cloneCanvas(a);e.map.getControlsByClass(TC.control.ScaleBar)&&e.drawScaleBarIntoCanvas({canvas:l,fill:!0});if(e._activeElm.querySelector(`#${e.CLASS}-image-qr-${e.id}:checked`)){const n="qrcode";var r=document.getElementById(n);if(r)r.innerHTML="";else{(r=document.createElement("div")).setAttribute("id",n);document.body.appendChild(r)}r.style.top="-200px";r.style.left="-200px";r.style.position="absolute";e.makeQRCode(r,87,87).then(function(n){if(n){var a=l.getContext("2d");a.fillStyle="#ffffff";a.fillRect(l.width-91,l.height-91,91,91);TC.Util.addToCanvas(l,n,{x:l.width-88,y:l.height-88}).then(function(t){o(t)})}else{TC.error(e.getLocaleString("dl.export.map.error")+": QR");e.map.getLoadingIndicator().removeWait(t)}})}else o(l)}).then(function(n){try{const t=n.toDataURL(o);TC.Util.downloadDataURI(window.location.hostname+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)+"."+o.split("/")[1],o,t)}catch(t){TC.error(e.getLocaleString("dl.export.map.error")+": "+t.message)}e.map.getLoadingIndicator().removeWait(t)});else{var a=e.map.getExtent(),l=TC.WFSGetFeatureBuilder(e.map,TC.filter.bbox(a,e.map.getCRS()),o,!0);Promise.all(l).then(async function(a){var l=a.filter(function(t){return null!=t});if(0!==l.length){for(var r=[],i=0;i<l.length;i++)if(l[i].errors&&l[i].errors.length)for(var c=0;c<l[i].errors.length;c++){var s=l[i].errors[c];n(s,t)}else{var d=l[i].data,p=l[i].url;d&&p&&r.push({url:p+"?download=zip",data:d})}try{await TC.Util.downloadFileForm(r)}catch(t){if(t.key===TC.Consts.DownloadError.MIMETYPE_NOT_SUPORTED){const n=a.find(function(e){return e.data===t.data}).service,l={plural:n.layers.length>1?e.getLocaleString("dl.format.notSupported.plural"):"",layerNames:n.layers.reduce(function(t,o,n,a){return(t instanceof Array?t:[t]).concat([o.title]).join(n<a.length-1?", ":" "+e.getLocaleString("dl.format.notSupported.conjunction")+" ")},[]),serviceTitle:n.mapLayers[0].title,format:o};e.map.toast(e.getLocaleString("dl.format.notSupported").format(l),{type:TC.Consts.msgType.ERROR})}}e.map.getLoadingIndicator().removeWait(t)}else n({key:TC.Consts.WFSErrors.NO_LAYERS},t)})}}));e.div.addEventListener(TC.Consts.event.CLICK,TC.EventTarget.listenerBySelector(".tc-ctl-download-help",function(t){t.stopPropagation();TC.Util.showModal(e._dialogDiv.querySelector(e._classSelector+"-help-dialog"))}));e.div.addEventListener("change",TC.EventTarget.listenerBySelector(`#${e.CLASS}-image-qr-${e.id}`,function(t){t.target.checked?e.generateLink():e.div.querySelector("."+e.CLASS+"-alert").classList.add(TC.Consts.classes.HIDDEN)}));e.div.addEventListener("click",TC.EventTarget.listenerBySelector("h2",function(t){e.generateLink();e.registerListeners()}));return o};t.manageMaxLengthExceed=function(t){const e=this.div.querySelector("."+this.CLASS+"-alert");document.getElementById(`${this.CLASS}-image-qr-${this.id}`).checked?e.classList.toggle(TC.Consts.classes.HIDDEN,!t.qr):e.classList.add(TC.Consts.classes.HIDDEN)}}();
//# sourceMappingURL=../maps/control/Download.min.js.map