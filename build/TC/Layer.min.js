TC.Layer=function(t){this.options=t||{};TC.Util.extend(this,this.options);this.PROTOCOL_REGEX=/^(f|ht)tp?:\/\//i;this.id=this.options.id||TC.getUID();this.map=this.options.map;this.type=this.options.type||TC.Consts.layerType.WMS;this.customLegend=this.options.customLegend;var e=this.options.isBase?TC.Consts.mimeType.JPEG:TC.Consts.mimeType.PNG;this.options.format=this.options.format||e;this.options.owner&&(this.owner=this.options.owner);void 0===this.options.hideTree&&(this.options.hideTree=!0);void 0===this.options.hideTitle&&(this.options.hideTitle=!1);this._cache={visibilityStates:{}};this.tree=null;this.wrap=null};TC.Layer.state={IDLE:"idle",LOADING:"loading"};TC.Layer.prototype.setVisibility=function(t){this.wrap.setVisibility(t)};TC.Layer.prototype.getVisibility=function(){var t=!1;this.map&&(this.isBase&&this.map.getBaseLayer()!==this||(t=this.wrap.getVisibility()));return t};TC.Layer.prototype.getOpacity=function(){var t=!1;this.map&&(this.isBase&&this.map.getBaseLayer()!==this||(t=this.wrap.layer.getOpacity()));return t};TC.Layer.prototype.setOpacity=function(t,e){var i=this;this.wrap.getLayer().then(function(r){r.setOpacity(t);i.opacity=t;i.map&&!e&&i.map.trigger(TC.Consts.event.LAYEROPACITY,{layer:i,opacity:t})})};TC.Layer.prototype.isCompatible=function(t){return!0};TC.Layer.prototype.isValidFromNames=function(){return!0};TC.Layer.prototype.isRaster=function(){var t=!0;switch(this.type){case TC.Consts.layerType.VECTOR:case TC.Consts.layerType.KML:case TC.Consts.layerType.WFS:case TC.Consts.layerType.GROUP:t=!1}return t};TC.Layer.prototype.isVisibleByScale=function(t){return!0};TC.Layer.prototype.isVisibleByName=function(t){return!0};TC.Layer.prototype.getTree=function(){return{name:this.name,title:this.title}};TC.Layer.prototype.findNode=function t(e,i){var r=null;if(i.uid==e)r=i;else for(var o=0;o<i.children.length;o++){var n=t(e,i.children[o]);if(n){r=n;break}}return r};TC.Layer.prototype.setNodeVisibility=function(t,e){this.setVisibility(e)};TC.Layer.prototype.getNodeVisibility=function(t){return TC.Consts.visibility.VISIBLE};TC.Layer.prototype.getResolutions=function(){return this.wrap.getResolutions?this.wrap.getResolutions():[]};TC.Layer.prototype.setProjection=function(){};TC.Layer.prototype.getBySSL_=function(t){return t.replace(this.PROTOCOL_REGEX,"https://")};!function(){const t=window.hasOwnProperty("Worker"),e=new Promise(function(e,i){if(t){var r=TC.apiLocation+"TC/workers/tc-caps-web-worker.js";TC.Util.isSameOrigin(TC.apiLocation)?e(r):TC.ajax({url:r,method:"GET",responseType:"text"}).then(function(t){const i=t.data;var r=new Blob([i],{type:"text/javascript"}),o=window.URL.createObjectURL(r);e(o)},function(t){i(Error(t))})}}),i=function(t,e){return"No se pudo obtener el documento de capacidades del servicio "+t.url+": ["+e+"]"},r=function(t,e){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var i=t.CAPABILITIES_STORE_KEY_PREFIX+t.options.url,r=function(){e.hasOwnProperty("error")||t.getCapabilitiesPromise().then(function(){localforage.setItem(i,e).catch(t=>console.log(t))})};t.map?t.map.loaded(r):r()})};TC.Layer.prototype.getGetMapUrl=function(){return function(t){var e=t;if(t){var i=t.match(/\??SERVICE=\w+&/i);i&&(e=e.replace(i[0],""))}return e}(this.wrap.getGetMapUrl())};TC.Layer.prototype.getCapabilitiesOnline=function(){var o=this;return new Promise(function(n,a){const s=o.getGetCapabilitiesUrl();o.toolProxification.fetch(s,{retryAttempts:2}).then(function(s){(function(i,o){var n;if(o.documentElement){const t=o.getElementsByTagName("ServiceException")[0];if(t)n={error:t.textContent};else{var a=i.type===TC.Consts.layerType.WMTS?new i.wrap.WmtsParser:new i.wrap.WmsParser;n=a.read(o);if(i.type===TC.Consts.layerType.WMTS&&n.Contents&&n.Contents.Layer){const t=o.getElementsByTagName("Layer");for(var s=0,p=t.length;s<p;s++){const e=t[s];var l=TC.Util.getElementByNodeName(e,"ows:Identifier")[0].firstChild.data,c=n.Contents.Layer.filter(function(t){return t.Identifier==l});if(c.length){c=c[0];for(var y=0;y<c.TileMatrixSetLink.length;y++){var T,C=c.TileMatrixSetLink[y];matrixId=C.TileMatrixSet;const t=e.getElementsByTagName("TileMatrixSetLink");for(var u=0,h=t.length;u<h;u++){const e=t[u];if(e.querySelector("TileMatrixSet:first").textContent==matrixId){T=e;break}}if(T){C.TileMatrixSetLimits=[];const t=T.getElementsByTagName("TileMatrixLimits");for(u=0,h=t.length;u<h;u++){const e=t[u];C.TileMatrixSetLimits.push({TileMatrix:e.getElementsByTagName("TileMatrix")[0].textContent,MinTileRow:parseInt(e.getElementsByTagName("MinTileRow")[0].textContent),MinTileCol:parseInt(e.getElementsByTagName("MinTileCol")[0].textContent),MaxTileRow:parseInt(e.getElementsByTagName("MaxTileRow")[0].textContent),MaxTileCol:parseInt(e.getElementsByTagName("MaxTileCol")[0].textContent)})}}}}}}}r(i,n);return Promise.resolve(n)}return new Promise(function(a,s){t&&"string"==typeof o?e.then(function(t){var e=new Worker(t);e.onmessage=function(t){if("success"===t.data.state){n=t.data.capabilities;r(i,n)}else s((n={error:"Web worker error"}).error);a(n);e.terminate()};e.postMessage({type:i.type,text:o,url:TC.apiLocation.indexOf("http")>=0?TC.apiLocation:document.location.protocol+TC.apiLocation})}):a(n=o)})})(o,s.responseText).then(function(t){t.error?a(Error(i(o,t.error))):n(t)}).catch(function(t){a(Error(t))})}).catch(function(t){a(Error(i(o,t)))})})};TC.Layer.prototype.getCapabilitiesFromStorage=function(){var t=this;return new Promise(function(e,i){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(t.CAPABILITIES_STORE_KEY_PREFIX+t.url).then(function(r){r?e(r):i(Error("Capabilities not in storage: "+t.url))}).catch(function(){i(Error("Undefined storage error"))})})})}}();
//# sourceMappingURL=maps/Layer.min.js.map